<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockServed - Official Legal Notice Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #ecf0f1;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        /* Professional Header */
        .header-section {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: var(--primary-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .logo-text h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            color: var(--primary-color);
        }

        .logo-text p {
            font-size: 12px;
            color: var(--text-light);
            margin: 0;
        }

        /* Wallet Connection */
        .wallet-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .wallet-status {
            padding: 8px 16px;
            background: var(--light-bg);
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .logo-text h1 {
                font-size: 20px;
            }
            
            .wallet-section {
                width: 100%;
                justify-content: center;
            }
            
            .connect-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .main-container {
                padding: 0 15px;
                margin: 20px auto;
            }
            
            .info-banner {
                padding: 20px;
                border-radius: 12px;
            }
            
            .info-banner h1 {
                font-size: 24px !important;
            }
            
            .info-banner p {
                font-size: 16px !important;
            }
            
            .steps-container {
                grid-template-columns: 1fr;
            }
            
            .notice-card {
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 15px;
            }
            
            .notice-card:hover {
                transform: none;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .notice-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .notice-title h4 {
                font-size: 16px;
            }
            
            .notice-details {
                flex-direction: column;
                gap: 8px;
            }
            
            .detail-item {
                font-size: 14px;
            }
            
            .status-badge {
                font-size: 11px;
                padding: 3px 8px;
            }
            
            .document-modal {
                margin: 0;
                max-height: 100vh;
                height: 100vh;
                border-radius: 0;
            }
            
            .modal-header, .modal-body, .modal-footer {
                padding: 15px;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            table {
                font-size: 14px;
            }
            
            /* Mobile-specific button styles */
            .btn {
                padding: 12px 20px;
                font-size: 16px;
                touch-action: manipulation;
            }
            
            /* Prevent zoom on input focus */
            input, select, textarea {
                font-size: 16px !important;
            }
        }
        
        @media (max-width: 480px) {
            .info-banner h1 {
                font-size: 20px !important;
            }
            
            .logo-icon {
                width: 35px;
                height: 35px;
                font-size: 18px;
            }
            
            .notice-card h3 {
                font-size: 18px;
            }
        }
        
        /* Mobile Wallet Connection Modal */
        .mobile-wallet-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .mobile-wallet-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mobile-wallet-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .mobile-wallet-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .mobile-wallet-header h2 {
            color: var(--primary-color);
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .wallet-option {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .wallet-option:hover {
            border-color: var(--secondary-color);
            background: #f8f9fa;
        }
        
        .wallet-option h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .wallet-option p {
            color: var(--text-light);
            font-size: 14px;
            margin: 0;
        }
        
        .mobile-instructions {
            background: #fff4e5;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .mobile-instructions h5 {
            color: #ff9800;
            margin-bottom: 10px;
        }
        
        .mobile-instructions ol {
            margin: 0;
            padding-left: 20px;
        }
        
        .mobile-instructions li {
            margin: 8px 0;
            line-height: 1.5;
        }

        .wallet-status.connected {
            background: #d4f1e4;
            color: var(--success-color);
        }

        .connect-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connect-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        /* Main Content */
        .main-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* Information Banner */
        .info-banner {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .info-banner h2 {
            color: var(--primary-color);
            font-size: 28px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .info-banner p {
            color: var(--text-light);
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .steps-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .step-card {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            align-items: start;
            gap: 15px;
        }

        .step-number {
            width: 35px;
            height: 35px;
            background: var(--secondary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content h4 {
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .step-content p {
            font-size: 14px;
            color: var(--text-light);
            margin: 0;
        }

        /* Notices Section */
        .notices-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
        }

        .section-header h3 {
            font-size: 22px;
            color: var(--primary-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notice-count {
            background: var(--secondary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        /* Notice Cards */
        .notice-card {
            background: white;
            border: 2px solid #e8ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .notice-card:hover {
            border-color: var(--secondary-color);
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.15);
        }

        .notice-card.urgent {
            border-left: 4px solid var(--danger-color);
        }

        .notice-card.important {
            border-left: 4px solid var(--warning-color);
        }

        .notice-card.standard {
            border-left: 4px solid var(--secondary-color);
        }

        .notice-card.highlighted {
            border: 3px solid var(--secondary-color);
            box-shadow: 0 4px 20px rgba(52, 152, 219, 0.3);
            animation: highlightPulse 2s ease-in-out;
        }

        @keyframes highlightPulse {
            0%, 100% { box-shadow: 0 4px 20px rgba(52, 152, 219, 0.3); }
            50% { box-shadow: 0 4px 30px rgba(52, 152, 219, 0.5); }
        }

        .notice-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .notice-title {
            flex: 1;
        }

        .notice-title h4 {
            font-size: 18px;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .notice-title p {
            font-size: 14px;
            color: var(--text-light);
            margin: 0;
        }

        .notice-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-served {
            background: #fff8e1;
            color: #f57c00;
        }

        .status-viewed {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-signed {
            background: #e8f5e9;
            color: #388e3c;
        }

        .notice-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--light-bg);
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .detail-item i {
            color: var(--secondary-color);
            font-size: 16px;
        }

        .detail-item strong {
            color: var(--text-dark);
            margin-right: 5px;
        }

        .detail-item span {
            color: var(--text-light);
        }

        .notice-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .btn-view {
            flex: 1;
            padding: 12px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-view:hover {
            background: #2980b9;
        }

        .btn-sign {
            flex: 1;
            padding: 12px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-sign:hover {
            background: #229954;
        }

        .btn-sign:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state i {
            font-size: 64px;
            color: #bdc3c7;
            margin-bottom: 20px;
        }

        .empty-state h4 {
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .empty-state p {
            color: var(--text-light);
            max-width: 400px;
            margin: 0 auto;
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light-bg);
            border-top-color: var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Document Viewer Modal */
        .document-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            padding: 20px;
        }

        .document-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--light-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--light-bg);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .steps-container {
                grid-template-columns: 1fr;
            }

            .notice-header {
                flex-direction: column;
                gap: 10px;
            }

            .notice-actions {
                flex-direction: column;
            }
        }

        /* Alert Messages */
        .alert-message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #e3f2fd;
            color: #0d47a1;
            border-left: 4px solid #1976d2;
        }

        .alert-success {
            background: #e8f5e9;
            color: #1b5e20;
            border-left: 4px solid #4caf50;
        }

        .alert-error {
            background: #ffebee;
            color: #b71c1c;
            border-left: 4px solid #f44336;
        }
    </style>
</head>
<body>
    <!-- Professional Header -->
    <header class="header-section">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">
                    <i class="bi bi-shield-check"></i>
                </div>
                <div class="logo-text">
                    <h1>BlockServed</h1>
                    <p>Official Legal Notice Portal</p>
                </div>
            </div>
            <div class="wallet-section">
                <div id="walletStatus" class="wallet-status">
                    <i class="bi bi-wallet2"></i>
                    <span>Not Connected</span>
                </div>
                <button id="connectWallet" class="connect-btn">
                    Connect Wallet
                </button>
                <button id="disconnectWallet" class="connect-btn" style="display: none; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                    <i class="bi bi-box-arrow-right"></i> Switch Wallet
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Wallet Connection Modal -->
    <div id="mobileWalletModal" class="mobile-wallet-modal">
        <div class="mobile-wallet-content">
            <div class="mobile-wallet-header">
                <i class="bi bi-phone" style="font-size: 48px; color: var(--secondary-color); margin-bottom: 15px;"></i>
                <h2>Mobile Wallet Connection</h2>
                <p style="color: var(--text-light);">To view your legal documents on mobile, you need to access this site from within your wallet app</p>
            </div>
            
            <div class="mobile-instructions">
                <h5><i class="bi bi-exclamation-triangle-fill"></i> Important for Mobile Users</h5>
                <p style="margin-bottom: 10px;">Mobile browsers cannot connect directly to wallet apps for security reasons. You must:</p>
                <ol>
                    <li>Open your <strong>TronLink</strong> wallet app</li>
                    <li>Navigate to the built-in browser (DApp Browser)</li>
                    <li>Enter this URL: <strong>blockserved.com</strong></li>
                    <li>Your wallet will automatically connect</li>
                </ol>
            </div>
            
            <div class="wallet-option" onclick="openInTronLink()">
                <h4><i class="bi bi-wallet2"></i> Open in TronLink</h4>
                <p>If you have TronLink installed, click here to open this site in the TronLink browser</p>
            </div>
            
            <div class="wallet-option" onclick="copyUrlToClipboard()">
                <h4><i class="bi bi-clipboard"></i> Copy URL</h4>
                <p>Copy the URL to paste into your wallet's browser</p>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <h5 style="color: var(--primary-color); margin-bottom: 10px;">Don't have TronLink?</h5>
                <p style="font-size: 14px; margin-bottom: 10px;">Download the official TronLink wallet app:</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <a href="https://apps.apple.com/app/tronlink/id1453530188" target="_blank" class="btn btn-primary" style="font-size: 14px;">
                        <i class="bi bi-apple"></i> App Store
                    </a>
                    <a href="https://play.google.com/store/apps/details?id=com.tronlinkpro.wallet" target="_blank" class="btn btn-primary" style="font-size: 14px;">
                        <i class="bi bi-google-play"></i> Google Play
                    </a>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeMobileWalletModal()" class="btn btn-secondary">
                    Try Desktop Instead
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Information Banner -->
        <div class="info-banner" id="mainBanner">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 25px; border-radius: 50px; display: inline-block; margin-bottom: 20px;">
                    <i class="bi bi-exclamation-triangle-fill" style="font-size: 20px; margin-right: 10px;"></i>
                    <span style="font-weight: 600; font-size: 18px;">IMPORTANT LEGAL NOTICE</span>
                </div>
                <h1 style="font-size: 36px; font-weight: 700; color: var(--primary-color); margin-bottom: 15px;">
                    You Have Received Official Legal Documents
                </h1>
                <p style="font-size: 20px; color: var(--text-dark); max-width: 800px; margin: 0 auto;">
                    Legal documents have been served to your wallet address through blockchain-verified delivery
                </p>
            </div>
            
            <div class="alert-message" style="background: #fff4e5; border-left: 4px solid #ff9800; margin: 30px 0;">
                <i class="bi bi-shield-lock-fill" style="color: #ff9800; font-size: 24px;"></i>
                <div>
                    <strong style="font-size: 18px; color: var(--primary-color);">Your Privacy is Protected</strong><br>
                    <p style="margin: 10px 0; line-height: 1.6;">
                        Your documents are <strong>completely private</strong> and can only be accessed by connecting the wallet that received the notice. 
                        Your wallet address is your unique identifier - no personal information is stored or displayed publicly.
                    </p>
                </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin: 25px 0;">
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">Why This is Important</h3>
                <div style="display: grid; gap: 15px;">
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <i class="bi bi-check-circle-fill" style="color: var(--success-color); font-size: 20px; flex-shrink: 0;"></i>
                        <p style="margin: 0;"><strong>Legal Requirement:</strong> These documents may require your response within a specific timeframe as mandated by law.</p>
                    </div>
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <i class="bi bi-check-circle-fill" style="color: var(--success-color); font-size: 20px; flex-shrink: 0;"></i>
                        <p style="margin: 0;"><strong>Permanent Record:</strong> Service of these documents has been permanently recorded on the blockchain, creating an immutable proof of delivery.</p>
                    </div>
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <i class="bi bi-check-circle-fill" style="color: var(--success-color); font-size: 20px; flex-shrink: 0;"></i>
                        <p style="margin: 0;"><strong>Time-Sensitive:</strong> Failure to respond may result in default judgments or other legal consequences.</p>
                    </div>
                </div>
            </div>

            <div style="background: #e8f5e9; padding: 25px; border-radius: 12px; margin: 25px 0;">
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">How to Access Your Documents</h3>
                <div class="steps-container">
                    <div class="step-card" style="background: white;">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>Connect Your Wallet</h4>
                            <p>Connect the TRON wallet that received the legal notice. This is your secure identity - only you can access your documents.</p>
                        </div>
                    </div>
                    <div class="step-card" style="background: white;">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>View Your Documents</h4>
                            <p>Once connected, all legal notices served to your wallet will automatically appear. Documents are retrieved from our secure database.</p>
                        </div>
                    </div>
                    <div class="step-card" style="background: white;">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4>Accept or Decline Service</h4>
                            <p>You can accept service by signing with your wallet, which will provide you with decryption keys for permanent IPFS access.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; margin: 25px 0; color: white;">
                <h3 style="margin-bottom: 20px;"><i class="bi bi-lock-fill"></i> Document Storage & Privacy</h3>
                <div style="display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                    <div>
                        <h5 style="margin-bottom: 10px;"><i class="bi bi-cloud-arrow-up"></i> Permanent IPFS Storage</h5>
                        <p style="font-size: 14px; opacity: 0.95;">Your documents are permanently stored on IPFS (InterPlanetary File System), ensuring they can never be deleted or altered.</p>
                    </div>
                    <div>
                        <h5 style="margin-bottom: 10px;"><i class="bi bi-shield-check"></i> Encrypted for Privacy</h5>
                        <p style="font-size: 14px; opacity: 0.95;">All documents are encrypted. Only recipients who accept service receive the decryption key, ensuring complete privacy.</p>
                    </div>
                    <div>
                        <h5 style="margin-bottom: 10px;"><i class="bi bi-key"></i> Your Keys, Your Access</h5>
                        <p style="font-size: 14px; opacity: 0.95;">Once you accept service and receive your decryption key, you can access your documents anytime, anywhere, without using this site.</p>
                    </div>
                </div>
            </div>
            
            <div class="alert-message alert-warning" style="margin: 25px 0;">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <div>
                    <strong>Legal Notice:</strong> If you choose to decline service, you can still view your documents through this portal. 
                    However, accepting service provides you with permanent, independent access via IPFS decryption keys. 
                    Please note that declining service does not prevent legal proceedings from continuing.
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button id="connectWalletMain" class="connect-btn" style="font-size: 18px; padding: 15px 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="bi bi-wallet2"></i> Connect Wallet to View Your Legal Documents
                </button>
                <p style="margin-top: 15px; color: var(--text-light); font-size: 14px;">
                    <i class="bi bi-lock"></i> Secure connection via TronLink â€¢ No personal data required â€¢ Only your wallet address is used
                </p>
            </div>
        </div>

        <!-- Notices Section -->
        <div class="notices-section">
            <div class="section-header">
                <h3>
                    <i class="bi bi-envelope-open"></i>
                    Your Legal Notices
                    <span id="noticeCount" class="notice-count">0</span>
                </h3>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading-state" style="display: none;">
                <div class="spinner"></div>
                <h4>Loading your notices...</h4>
                <p>Please wait while we retrieve your legal documents</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state">
                <i class="bi bi-inbox"></i>
                <h4>No Notices Found</h4>
                <p>Connect your wallet to view any legal notices that have been served to your address</p>
            </div>

            <!-- Notices Container -->
            <div id="noticesContainer">
                <!-- Notices will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div id="documentModal" class="document-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Legal Document</h3>
                <button class="close-modal" onclick="closeDocumentModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Document content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn-view" onclick="downloadDocument()">
                    <i class="bi bi-download"></i> Download
                </button>
                <button class="btn-sign" id="signButton" onclick="signDocument()">
                    <i class="bi bi-pen"></i> Sign & Acknowledge
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/tronweb@5.3.0/dist/TronWeb.min.js"></script>
    <script>
        // Configuration
        const BACKEND_URL = 'https://nftserviceapp.onrender.com';

        // Get user's timezone
        function getUserTimezone() {
            try {
                return Intl.DateTimeFormat().resolvedOptions().timeZone;
            } catch (e) {
                return null;
            }
        }

        // Cookie utility functions for forensic tracking
        function setCookie(name, value, days = 365) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/; SameSite=Lax`;
        }

        function getCookie(name) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [key, val] = cookie.trim().split('=');
                if (key === name) return decodeURIComponent(val);
            }
            return null;
        }

        // ============================================
        // BROWSER FINGERPRINTING MODULE
        // Creates a persistent device identifier
        // ============================================

        // Simple hash function (murmurhash3-like)
        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        // Canvas fingerprint - renders text/graphics and hashes result
        function getCanvasFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 200;
                canvas.height = 50;

                // Draw background
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Draw text with specific font
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillStyle = '#000';
                ctx.fillText('BlockServed Forensic ðŸ”’', 2, 2);

                // Draw colored shapes
                ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                ctx.beginPath();
                ctx.arc(50, 30, 15, 0, Math.PI * 2);
                ctx.fill();

                // Add gradient
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
                gradient.addColorStop(0, 'red');
                gradient.addColorStop(0.5, 'green');
                gradient.addColorStop(1, 'blue');
                ctx.fillStyle = gradient;
                ctx.fillRect(100, 10, 80, 30);

                // Get data URL and hash it
                const dataUrl = canvas.toDataURL();
                return hashString(dataUrl);
            } catch (e) {
                return 'canvas_error';
            }
        }

        // WebGL fingerprint - GPU and renderer info
        function getWebGLFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) return { hash: 'no_webgl', vendor: null, renderer: null };

                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                let vendor = 'unknown';
                let renderer = 'unknown';

                if (debugInfo) {
                    vendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) || 'unknown';
                    renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) || 'unknown';
                }

                // Get WebGL parameters
                const params = [
                    gl.getParameter(gl.VERSION),
                    gl.getParameter(gl.SHADING_LANGUAGE_VERSION),
                    gl.getParameter(gl.MAX_TEXTURE_SIZE),
                    gl.getParameter(gl.MAX_VERTEX_ATTRIBS),
                    gl.getParameter(gl.MAX_VERTEX_UNIFORM_VECTORS),
                    gl.getParameter(gl.MAX_FRAGMENT_UNIFORM_VECTORS),
                    gl.getParameter(gl.MAX_RENDERBUFFER_SIZE),
                    vendor,
                    renderer
                ].join('|');

                return {
                    hash: hashString(params),
                    vendor: vendor,
                    renderer: renderer,
                    version: gl.getParameter(gl.VERSION)
                };
            } catch (e) {
                return { hash: 'webgl_error', vendor: null, renderer: null };
            }
        }

        // Audio fingerprint - analyzes audio processing characteristics
        function getAudioFingerprint() {
            return new Promise((resolve) => {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContext) {
                        resolve('no_audio_context');
                        return;
                    }

                    const context = new AudioContext();
                    const oscillator = context.createOscillator();
                    const analyser = context.createAnalyser();
                    const gain = context.createGain();
                    const processor = context.createScriptProcessor(4096, 1, 1);

                    oscillator.type = 'triangle';
                    oscillator.frequency.value = 10000;
                    gain.gain.value = 0;

                    oscillator.connect(analyser);
                    analyser.connect(processor);
                    processor.connect(gain);
                    gain.connect(context.destination);

                    oscillator.start(0);

                    let fingerprint = '';
                    processor.onaudioprocess = function(event) {
                        const data = event.inputBuffer.getChannelData(0);
                        // Sample a few values
                        for (let i = 0; i < 10; i++) {
                            fingerprint += Math.abs(data[i * 100] || 0).toString().slice(0, 8);
                        }
                        oscillator.stop();
                        processor.disconnect();
                        context.close();
                        resolve(hashString(fingerprint || 'audio_processed'));
                    };

                    // Timeout fallback
                    setTimeout(() => {
                        try { oscillator.stop(); } catch(e) {}
                        try { context.close(); } catch(e) {}
                        resolve('audio_timeout');
                    }, 500);
                } catch (e) {
                    resolve('audio_error');
                }
            });
        }

        // Font detection - checks for installed fonts
        function getFontFingerprint() {
            const testFonts = [
                'Arial', 'Arial Black', 'Comic Sans MS', 'Courier New', 'Georgia',
                'Impact', 'Times New Roman', 'Trebuchet MS', 'Verdana', 'Webdings',
                'Palatino', 'Lucida Console', 'Lucida Sans Unicode', 'Tahoma',
                'Monaco', 'Helvetica', 'Helvetica Neue', 'Segoe UI', 'Roboto',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Open Sans',
                'Calibri', 'Cambria', 'Century Gothic', 'Franklin Gothic Medium',
                'Consolas', 'Menlo', 'DejaVu Sans', 'Liberation Sans'
            ];

            const baseFonts = ['monospace', 'sans-serif', 'serif'];
            const testString = 'mmmmmmmmmmlli';
            const testSize = '72px';

            const span = document.createElement('span');
            span.style.position = 'absolute';
            span.style.left = '-9999px';
            span.style.fontSize = testSize;
            span.innerText = testString;
            document.body.appendChild(span);

            const baseSizes = {};
            for (const baseFont of baseFonts) {
                span.style.fontFamily = baseFont;
                baseSizes[baseFont] = { width: span.offsetWidth, height: span.offsetHeight };
            }

            const detectedFonts = [];
            for (const font of testFonts) {
                for (const baseFont of baseFonts) {
                    span.style.fontFamily = `"${font}", ${baseFont}`;
                    if (span.offsetWidth !== baseSizes[baseFont].width ||
                        span.offsetHeight !== baseSizes[baseFont].height) {
                        detectedFonts.push(font);
                        break;
                    }
                }
            }

            document.body.removeChild(span);
            return {
                hash: hashString(detectedFonts.join(',')),
                count: detectedFonts.length,
                fonts: detectedFonts
            };
        }

        // Hardware and browser characteristics
        function getHardwareFingerprint() {
            const data = {
                // Screen
                screenWidth: screen.width,
                screenHeight: screen.height,
                screenDepth: screen.colorDepth,
                screenPixelDepth: screen.pixelDepth,
                availWidth: screen.availWidth,
                availHeight: screen.availHeight,
                devicePixelRatio: window.devicePixelRatio || 1,

                // Hardware
                hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                deviceMemory: navigator.deviceMemory || 'unknown',
                maxTouchPoints: navigator.maxTouchPoints || 0,
                platform: navigator.platform,

                // Browser
                language: navigator.language,
                languages: (navigator.languages || []).join(','),
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                timezoneOffset: new Date().getTimezoneOffset(),

                // Features
                cookieEnabled: navigator.cookieEnabled,
                doNotTrack: navigator.doNotTrack,
                plugins: Array.from(navigator.plugins || []).map(p => p.name).join(','),

                // Media
                webdriver: navigator.webdriver || false
            };

            const str = Object.values(data).join('|');
            return {
                hash: hashString(str),
                details: data
            };
        }

        // Get browser plugins list
        function getPluginsFingerprint() {
            try {
                const plugins = Array.from(navigator.plugins || []);
                const pluginData = plugins.map(p => ({
                    name: p.name,
                    description: p.description,
                    filename: p.filename
                }));
                return {
                    hash: hashString(JSON.stringify(pluginData)),
                    count: plugins.length,
                    list: pluginData.map(p => p.name)
                };
            } catch (e) {
                return { hash: 'plugins_error', count: 0, list: [] };
            }
        }

        // Detect automation/bot indicators
        function getAutomationIndicators() {
            return {
                webdriver: navigator.webdriver || false,
                phantom: !!window._phantom || !!window.callPhantom,
                nightmare: !!window.__nightmare,
                selenium: !!window.document.__selenium_unwrapped || !!window.document.__webdriver_evaluate,
                domAutomation: !!window.domAutomation || !!window.domAutomationController,
                headless: /HeadlessChrome/.test(navigator.userAgent),
                hasLanguages: navigator.languages && navigator.languages.length > 0,
                hasPlugins: navigator.plugins && navigator.plugins.length > 0
            };
        }

        // Generate complete browser fingerprint
        async function generateBrowserFingerprint() {
            const canvas = getCanvasFingerprint();
            const webgl = getWebGLFingerprint();
            const fonts = getFontFingerprint();
            const hardware = getHardwareFingerprint();
            const plugins = getPluginsFingerprint();
            const automation = getAutomationIndicators();

            // Audio fingerprint is async
            const audio = await getAudioFingerprint();

            // Combine all fingerprints into master hash
            const components = [
                canvas,
                webgl.hash,
                audio,
                fonts.hash,
                hardware.hash,
                plugins.hash
            ].join('-');

            const masterHash = 'fp_' + hashString(components);

            return {
                fingerprint: masterHash,
                components: {
                    canvas: canvas,
                    webgl: webgl,
                    audio: audio,
                    fonts: fonts,
                    hardware: hardware,
                    plugins: plugins,
                    automation: automation
                },
                confidence: calculateConfidence(webgl, fonts, plugins),
                generatedAt: new Date().toISOString()
            };
        }

        // Calculate fingerprint confidence score
        function calculateConfidence(webgl, fonts, plugins) {
            let score = 50; // Base score

            // WebGL adds confidence
            if (webgl.vendor && webgl.vendor !== 'unknown') score += 15;
            if (webgl.renderer && webgl.renderer !== 'unknown') score += 15;

            // Fonts add confidence
            if (fonts.count > 10) score += 10;
            if (fonts.count > 20) score += 5;

            // Plugins add confidence
            if (plugins.count > 0) score += 5;

            return Math.min(score, 100);
        }

        // Store fingerprint in memory (generated async on page load)
        let browserFingerprint = null;
        generateBrowserFingerprint().then(fp => {
            browserFingerprint = fp;
            console.log('Browser fingerprint generated:', fp.fingerprint, `(${fp.confidence}% confidence)`);
        });

        // ============================================
        // END BROWSER FINGERPRINTING MODULE
        // ============================================

        // Get or create visitor ID for tracking return visits
        function getVisitorId() {
            let visitorId = getCookie('bs_visitor_id');
            if (!visitorId) {
                visitorId = 'v_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                setCookie('bs_visitor_id', visitorId, 365);
            }
            return visitorId;
        }

        // Track first visit timestamp
        function getFirstVisitTimestamp() {
            let firstVisit = getCookie('bs_first_visit');
            if (!firstVisit) {
                firstVisit = new Date().toISOString();
                setCookie('bs_first_visit', firstVisit, 365);
            }
            return firstVisit;
        }

        // Get visit count
        function incrementVisitCount() {
            let count = parseInt(getCookie('bs_visit_count') || '0', 10);
            count++;
            setCookie('bs_visit_count', count.toString(), 365);
            return count;
        }

        // Get all forensic cookie data
        function getForensicCookieData() {
            return {
                visitorId: getVisitorId(),
                firstVisit: getFirstVisitTimestamp(),
                visitCount: incrementVisitCount(),
                lastVisit: getCookie('bs_last_visit') || null,
                hasSeenNotice: getCookie('bs_seen_notice') || null,
                cookiesEnabled: navigator.cookieEnabled
            };
        }

        // Update last visit timestamp
        function updateLastVisit() {
            setCookie('bs_last_visit', new Date().toISOString(), 365);
        }

        // Mark that user has seen a specific notice
        function markNoticeSeen(caseNumber) {
            const seen = JSON.parse(getCookie('bs_seen_notices') || '[]');
            if (!seen.includes(caseNumber)) {
                seen.push(caseNumber);
                setCookie('bs_seen_notices', JSON.stringify(seen.slice(-50)), 365); // Keep last 50
            }
        }

        // Get referrer information
        function getReferrerInfo() {
            return {
                referrer: document.referrer || null,
                referrerDomain: document.referrer ? new URL(document.referrer).hostname : null,
                isDirectVisit: !document.referrer,
                entryUrl: window.location.href,
                entryPath: window.location.pathname,
                queryParams: Object.fromEntries(new URLSearchParams(window.location.search))
            };
        }

        // Get comprehensive language preferences
        function getLanguagePreferences() {
            return {
                primaryLanguage: navigator.language,
                allLanguages: navigator.languages ? [...navigator.languages] : [navigator.language],
                browserLocale: Intl.DateTimeFormat().resolvedOptions().locale,
                numberFormat: Intl.NumberFormat().resolvedOptions().locale,
                dateFormat: Intl.DateTimeFormat().resolvedOptions()
            };
        }

        // Initialize forensic tracking on page load
        const forensicData = {
            cookies: getForensicCookieData(),
            referrer: getReferrerInfo(),
            languages: getLanguagePreferences(),
            pageLoadTime: new Date().toISOString(),
            // Fingerprint is added async after generation
            getFingerprint: () => browserFingerprint
        };
        updateLastVisit();

        // Helper for API calls with common headers (includes timezone and fingerprint)
        function getApiHeaders(additionalHeaders = {}) {
            const fp = browserFingerprint;
            return {
                'Content-Type': 'application/json',
                'X-Timezone': getUserTimezone() || '',
                'X-Visitor-Id': forensicData.cookies.visitorId || '',
                'X-Fingerprint': fp ? fp.fingerprint : '',
                'X-Fingerprint-Confidence': fp ? fp.confidence.toString() : '0',
                ...additionalHeaders
            };
        }

        // State
        let tronWeb = null;
        let currentWallet = null;
        let currentNotice = null;
        let viewStartTime = null;
        let requestedCaseNumber = null; // Case number from URL query param

        // Generate session ID for tracking
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            // Check for case query parameter (e.g., ?case=Test%2011)
            const urlParams = new URLSearchParams(window.location.search);
            requestedCaseNumber = urlParams.get('case');
            if (requestedCaseNumber) {
                console.log('BlockServed: Requested case from URL:', requestedCaseNumber);
            }

            checkTronLink();
            setupEventListeners();
            
            // Check if mobile user on first load
            const deviceInfo = detectDeviceType();
            if (deviceInfo.isMobile && !deviceInfo.isWalletBrowser) {
                // Add mobile indicator to the page
                const mobileNotice = document.createElement('div');
                mobileNotice.className = 'alert-message alert-info';
                mobileNotice.style.cssText = 'margin: 15px; text-align: center;';
                mobileNotice.innerHTML = `
                    <i class="bi bi-phone" style="font-size: 20px;"></i>
                    <p style="margin: 10px 0 5px 0; font-weight: 600;">Mobile Device Detected</p>
                    <p style="font-size: 14px; margin: 5px 0;">For the best experience, open this site in your TronLink wallet browser</p>
                `;
                
                // Insert after header
                const mainContainer = document.querySelector('.main-container');
                if (mainContainer && !deviceInfo.isWalletBrowser) {
                    mainContainer.insertBefore(mobileNotice, mainContainer.firstChild);
                }
            }
        });

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('disconnectWallet').addEventListener('click', disconnectWallet);

            // Add listener for main connect button if it exists
            const mainConnectBtn = document.getElementById('connectWalletMain');
            if (mainConnectBtn) {
                mainConnectBtn.addEventListener('click', connectWallet);
            }
        }

        // Disconnect wallet and allow switching
        function disconnectWallet() {
            currentWallet = null;

            // Reset UI
            const walletStatus = document.getElementById('walletStatus');
            walletStatus.classList.remove('connected');
            walletStatus.innerHTML = `
                <i class="bi bi-wallet2"></i>
                <span>Not Connected</span>
            `;

            document.getElementById('connectWallet').style.display = 'inline-block';
            document.getElementById('disconnectWallet').style.display = 'none';

            // Show main banner again
            const mainBanner = document.getElementById('mainBanner');
            if (mainBanner) {
                mainBanner.style.display = 'block';
            }

            // Clear notices
            document.getElementById('noticesContainer').innerHTML = '';
            document.getElementById('noticeCount').textContent = '0';
            document.getElementById('emptyState').style.display = 'none';

            showAlert('Wallet disconnected. Connect a different wallet to continue.', 'info');
        }

        // Check if TronLink is available
        function checkTronLink() {
            const deviceInfo = detectDeviceType();
            
            if (window.tronWeb && window.tronWeb.ready) {
                tronWeb = window.tronWeb;
                handleWalletConnected();
                
                // Show success message for mobile users
                if (deviceInfo.isMobile) {
                    showAlert('Wallet connected successfully from mobile!', 'success');
                }
            } else {
                // On mobile, show helpful message after a few attempts
                if (deviceInfo.isMobile && !window.tronWeb) {
                    setTimeout(() => {
                        if (!window.tronWeb && !currentWallet) {
                            console.log('Mobile detected without wallet connection');
                            // Don't auto-show modal, let user click connect button
                        }
                    }, 3000);
                } else {
                    setTimeout(checkTronLink, 500);
                }
            }
        }

        // Check if mobile and show appropriate guidance
        function checkMobileWallet() {
            const deviceType = detectDeviceType();
            
            // Check if we're in a wallet browser (TronLink or similar)
            const isInWalletBrowser = window.tronWeb && window.tronWeb.ready;
            
            if (deviceType.isMobile && !isInWalletBrowser) {
                // Show mobile wallet connection modal
                document.getElementById('mobileWalletModal').classList.add('active');
                return false;
            }
            
            return true;
        }
        
        // Open in TronLink browser
        function openInTronLink() {
            const currentUrl = window.location.href;
            const tronLinkUrl = `tronlink://open?url=${encodeURIComponent(currentUrl)}`;
            
            // Try to open in TronLink
            window.location.href = tronLinkUrl;
            
            // Fallback message after a delay
            setTimeout(() => {
                showAlert('If TronLink did not open, please open it manually and navigate to blockserved.com', 'info');
            }, 2000);
        }
        
        // Copy URL to clipboard
        function copyUrlToClipboard() {
            const url = 'https://blockserved.com';
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    showAlert('URL copied! Now open your wallet app and paste it in the browser', 'success');
                }).catch(() => {
                    fallbackCopyToClipboard(url);
                });
            } else {
                fallbackCopyToClipboard(url);
            }
        }
        
        // Fallback copy method for older browsers
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                showAlert('URL copied! Now open your wallet app and paste it in the browser', 'success');
            } catch (err) {
                showAlert('Please manually copy: blockserved.com', 'info');
            }
            
            document.body.removeChild(textArea);
        }
        
        // Close mobile wallet modal
        function closeMobileWalletModal() {
            document.getElementById('mobileWalletModal').classList.remove('active');
        }
        
        // Connect wallet
        async function connectWallet() {
            // Check if mobile and needs guidance
            if (!checkMobileWallet()) {
                return;
            }
            
            try {
                if (!window.tronWeb) {
                    showAlert('Please install TronLink wallet extension', 'error');
                    return;
                }

                // Request account access
                const accounts = await window.tronLink.request({ method: 'tron_requestAccounts' });
                
                if (accounts && accounts.length > 0) {
                    handleWalletConnected();
                }
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showAlert('Failed to connect wallet. Please try again.', 'error');
            }
        }

        // Handle wallet connection
        async function handleWalletConnected() {
            if (!window.tronWeb || !window.tronWeb.ready) return;
            
            currentWallet = window.tronWeb.defaultAddress.base58;
            
            // Log wallet connection to backend
            await logWalletConnection(currentWallet);
            
            // Update UI
            const walletStatus = document.getElementById('walletStatus');
            walletStatus.classList.add('connected');
            walletStatus.innerHTML = `
                <i class="bi bi-check-circle-fill"></i>
                <span>${currentWallet.substring(0, 6)}...${currentWallet.substring(currentWallet.length - 4)}</span>
            `;

            document.getElementById('connectWallet').style.display = 'none';
            document.getElementById('disconnectWallet').style.display = 'inline-block';
            
            // Hide main info banner and main connect button
            const mainBanner = document.getElementById('mainBanner');
            if (mainBanner) {
                mainBanner.style.display = 'none';
            }
            
            // Load notices
            loadNotices();
        }
        
        // Detect device type
        function detectDeviceType() {
            const ua = navigator.userAgent.toLowerCase();
            const isMobile = /mobile|android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(ua);
            const isTablet = /tablet|ipad/i.test(ua) || (isMobile && screen.width >= 768);
            const isDesktop = !isMobile && !isTablet;
            
            // Detect OS
            let os = 'Unknown';
            if (/windows/i.test(ua)) os = 'Windows';
            else if (/mac/i.test(ua)) os = 'MacOS';
            else if (/android/i.test(ua)) os = 'Android';
            else if (/ios|iphone|ipad/i.test(ua)) os = 'iOS';
            else if (/linux/i.test(ua)) os = 'Linux';
            
            // Check if in wallet browser
            const isWalletBrowser = window.tronWeb && window.tronWeb.ready;
            
            return {
                type: isDesktop ? 'Desktop' : (isTablet ? 'Tablet' : 'Mobile'),
                os: os,
                isMobile: isMobile,
                isTablet: isTablet,
                isDesktop: isDesktop,
                isWalletBrowser: isWalletBrowser,
                screenWidth: window.innerWidth,
                screenHeight: window.innerHeight
            };
        }
        
        // Detect wallet provider
        function detectWalletProvider() {
            if (window.tronLink) {
                return {
                    provider: 'TronLink',
                    version: window.tronLink.version || 'Unknown',
                    type: 'Browser Extension',
                    ready: window.tronLink.ready
                };
            } else if (window.tronWeb) {
                // Could be injected by other wallets
                return {
                    provider: 'TronWeb Compatible',
                    version: 'Unknown',
                    type: 'Unknown',
                    ready: window.tronWeb.ready
                };
            }
            return {
                provider: 'None',
                version: null,
                type: null,
                ready: false
            };
        }
        
        // Log wallet connection to backend
        async function logWalletConnection(walletAddress) {
            try {
                // Detect device and wallet info
                const deviceType = detectDeviceType();
                const walletInfo = detectWalletProvider();
                
                // Comprehensive device and browser information
                const browserInfo = {
                    // Browser details
                    userAgent: navigator.userAgent,
                    appName: navigator.appName,
                    appVersion: navigator.appVersion,
                    vendor: navigator.vendor,
                    language: navigator.language,
                    languages: navigator.languages ? [...navigator.languages] : [navigator.language],
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine,
                    doNotTrack: navigator.doNotTrack,

                    // Device type detection
                    deviceType: deviceType.type,
                    operatingSystem: deviceType.os,
                    isMobile: deviceType.isMobile,
                    isTablet: deviceType.isTablet,
                    isDesktop: deviceType.isDesktop,

                    // Wallet information
                    walletProvider: walletInfo.provider,
                    walletVersion: walletInfo.version,
                    walletType: walletInfo.type,

                    // Device details
                    platform: navigator.platform,
                    hardwareConcurrency: navigator.hardwareConcurrency,
                    deviceMemory: navigator.deviceMemory,
                    maxTouchPoints: navigator.maxTouchPoints,

                    // Screen details
                    screenResolution: `${screen.width}x${screen.height}`,
                    screenColorDepth: screen.colorDepth,
                    screenPixelDepth: screen.pixelDepth,
                    availableScreenSize: `${screen.availWidth}x${screen.availHeight}`,

                    // Window details
                    windowSize: `${window.innerWidth}x${window.innerHeight}`,
                    devicePixelRatio: window.devicePixelRatio,

                    // Timezone and locale
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    timezoneOffset: new Date().getTimezoneOffset(),
                    locale: Intl.DateTimeFormat().resolvedOptions().locale,

                    // Connection info
                    connection: navigator.connection ? {
                        effectiveType: navigator.connection.effectiveType,
                        downlink: navigator.connection.downlink,
                        rtt: navigator.connection.rtt,
                        saveData: navigator.connection.saveData
                    } : null,

                    // Forensic tracking data
                    forensics: {
                        visitorId: forensicData.cookies.visitorId,
                        firstVisit: forensicData.cookies.firstVisit,
                        visitCount: forensicData.cookies.visitCount,
                        lastVisit: forensicData.cookies.lastVisit,
                        isReturnVisitor: forensicData.cookies.visitCount > 1,
                        referrer: forensicData.referrer.referrer,
                        referrerDomain: forensicData.referrer.referrerDomain,
                        isDirectVisit: forensicData.referrer.isDirectVisit,
                        entryUrl: forensicData.referrer.entryUrl,
                        queryParams: forensicData.referrer.queryParams,
                        pageLoadTime: forensicData.pageLoadTime
                    },

                    // Browser fingerprint (persistent device identifier)
                    fingerprint: browserFingerprint ? {
                        hash: browserFingerprint.fingerprint,
                        confidence: browserFingerprint.confidence,
                        canvas: browserFingerprint.components.canvas,
                        webgl: browserFingerprint.components.webgl,
                        audio: browserFingerprint.components.audio,
                        fonts: browserFingerprint.components.fonts,
                        hardware: browserFingerprint.components.hardware,
                        plugins: browserFingerprint.components.plugins,
                        automation: browserFingerprint.components.automation,
                        generatedAt: browserFingerprint.generatedAt
                    } : null,

                    // Comprehensive language preferences
                    languagePreferences: forensicData.languages
                };

                await fetch(`${BACKEND_URL}/api/recipient-logs/connection`, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        wallet_address: walletAddress,
                        session_id: sessionId,
                        visitor_id: forensicData.cookies.visitorId,
                        fingerprint: browserFingerprint ? browserFingerprint.fingerprint : null,
                        fingerprint_confidence: browserFingerprint ? browserFingerprint.confidence : 0,
                        browser_info: browserInfo,
                        timezone: getUserTimezone()
                    })
                });
                console.log('Wallet connection logged');
            } catch (error) {
                console.error('Failed to log connection:', error);
            }
        }

        // Load notices for the connected wallet
        async function loadNotices() {
            if (!currentWallet) return;
            
            // Show loading state
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('noticesContainer').innerHTML = '';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/recipient-cases/wallet/${currentWallet}`);
                const data = await response.json();
                
                document.getElementById('loadingState').style.display = 'none';
                
                if (data.success && data.notices && data.notices.length > 0) {
                    console.log('BlockServed: Notices received:', data.notices);
                    const firstNotice = data.notices[0];
                    console.log('BlockServed: First notice details:', {
                        case_number: firstNotice.case_number,
                        alert_token_id: firstNotice.alert_token_id,
                        document_token_id: firstNotice.document_token_id,
                        ipfs_hash: firstNotice.ipfs_hash,
                        encryption_key: firstNotice.encryption_key,
                        images: firstNotice.images
                    });
                    
                    // Temporary debug alert
                    if (!firstNotice.document_token_id) {
                        console.warn('BlockServed WARNING: Document Token ID is missing!');
                        console.warn('Full notice object:', firstNotice);
                    }
                    
                    displayNotices(data.notices);
                    document.getElementById('noticeCount').textContent = data.notices.length;

                    // If a specific case was requested via URL, scroll to it and show an alert
                    if (requestedCaseNumber) {
                        const requestedNotice = data.notices.find(n =>
                            n.case_number === requestedCaseNumber ||
                            n.case_number?.toString() === requestedCaseNumber
                        );
                        if (requestedNotice) {
                            showAlert(`Case #${requestedCaseNumber} found and highlighted`, 'success');
                            // Scroll to the highlighted notice after a short delay
                            setTimeout(() => {
                                const highlightedCard = document.querySelector('.notice-card.highlighted');
                                if (highlightedCard) {
                                    highlightedCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }, 500);
                        } else {
                            showAlert(`Case #${requestedCaseNumber} not found for this wallet`, 'warning');
                        }
                    }
                } else {
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('noticeCount').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading notices:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                showAlert('Failed to load notices. Please try again.', 'error');
            }
        }

        // Display notices
        function displayNotices(notices) {
            const container = document.getElementById('noticesContainer');
            container.innerHTML = '';

            // If a case was requested via URL, move it to the front
            if (requestedCaseNumber) {
                notices.sort((a, b) => {
                    const aMatches = a.case_number === requestedCaseNumber ||
                                   a.case_number?.toString() === requestedCaseNumber;
                    const bMatches = b.case_number === requestedCaseNumber ||
                                   b.case_number?.toString() === requestedCaseNumber;
                    if (aMatches && !bMatches) return -1;
                    if (bMatches && !aMatches) return 1;
                    return 0;
                });
            }

            notices.forEach(notice => {
                const urgencyClass = notice.notice_type?.includes('Urgent') ? 'urgent' :
                                   notice.notice_type?.includes('Important') ? 'important' : 'standard';

                // Check if this is the requested case
                const isRequestedCase = requestedCaseNumber &&
                    (notice.case_number === requestedCaseNumber ||
                     notice.case_number?.toString() === requestedCaseNumber);

                const noticeCard = document.createElement('div');
                noticeCard.className = `notice-card ${urgencyClass}${isRequestedCase ? ' highlighted' : ''}`;
                noticeCard.innerHTML = `
                    <div class="notice-header">
                        <div class="notice-title">
                            <h4>Case #${notice.case_number}</h4>
                            <p>${notice.notice_type || 'Legal Notice'} - ${notice.issuing_agency || 'via Blockserved.com'}</p>
                        </div>
                        <div class="notice-status">
                            <span class="status-badge status-served">Served</span>
                            ${notice.status === 'viewed' || notice.status === 'signed' ? '<span class="status-badge status-viewed">Viewed</span>' : ''}
                            ${notice.status === 'signed' ? '<span class="status-badge status-signed">Signed</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="notice-details">
                        <div class="detail-item">
                            <i class="bi bi-calendar3"></i>
                            <strong>Served:</strong>
                            <span>${new Date(notice.served_at || notice.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-envelope-check"></i>
                            <strong>Alert NFT:</strong>
                            <span>#${notice.alert_token_id} (In Your Wallet)</span>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-file-earmark-text"></i>
                            <strong>Document NFT:</strong>
                            <span>#${notice.document_token_id || 'Pending'} (Permanent Record)</span>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-file-text"></i>
                            <strong>Pages:</strong>
                            <span>${notice.page_count || 1}</span>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-link-45deg"></i>
                            <strong>Blockchain:</strong>
                            <span>TRON</span>
                        </div>
                    </div>
                    
                    <div class="notice-actions">
                        <button class="btn-view" onclick='viewDocument(${JSON.stringify(notice)})'>
                            <i class="bi bi-eye"></i> View Legal Notices
                        </button>
                        ${!notice.accepted ? `
                            <button class="btn-sign" onclick='viewAndSign(${JSON.stringify(notice)})'>
                                <i class="bi bi-pen"></i> Sign Document
                            </button>
                        ` : `
                            <button class="btn-sign" disabled>
                                <i class="bi bi-check"></i> Document Signed
                            </button>
                        `}
                    </div>
                `;
                
                container.appendChild(noticeCard);
            });
        }

        // View document (shows both Alert and Document NFTs)
        async function viewDocument(notice, signMode = false) {
            currentNotice = notice;
            viewStartTime = Date.now();
            
            // Log notice view
            await logNoticeView(notice.case_number, 'detail_view');
            
            // Show modal
            document.getElementById('documentModal').classList.add('active');
            document.getElementById('modalTitle').textContent = `Legal Notices - Case #${notice.case_number}`;
            
            // Hide sign button by default, will show only for Document NFT in sign mode
            const signButton = document.getElementById('signButton');
            if (signButton) {
                signButton.style.display = signMode && !notice.accepted ? 'inline-block' : 'none';
            }
            
            // Load document
            document.getElementById('modalBody').innerHTML = `
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading legal notices...</p>
                </div>
            `;
            
            try {
                // Fetch document details - pass recipientAddress to trigger 'viewed' status update
                const response = await fetch(`${BACKEND_URL}/api/recipient-cases/${notice.case_number}/document?recipientAddress=${currentWallet}`);
                const data = await response.json();

                if (data.success && data.notice) {
                    displayDocumentContent(data.notice, signMode);
                    // Log document open
                    await logNoticeView(notice.case_number, 'document_open');
                    // Reload notices to update status badges
                    loadNotices();
                }
            } catch (error) {
                console.error('Error loading document:', error);
                document.getElementById('modalBody').innerHTML = `
                    <div class="alert-message alert-error">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        Failed to load notices. Please try again.
                    </div>
                `;
            }
        }
        
        // View and Sign - opens modal in sign mode for Document NFT
        async function viewAndSign(notice) {
            await viewDocument(notice, true);
        }
        
        // Log notice view to backend
        async function logNoticeView(caseNumber, actionType) {
            try {
                let viewDuration = null;
                if (viewStartTime && actionType === 'document_close') {
                    viewDuration = Math.floor((Date.now() - viewStartTime) / 1000);
                }
                
                await fetch(`${BACKEND_URL}/api/recipient-logs/notice-view`, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        case_number: caseNumber,
                        wallet_address: currentWallet,
                        action_type: actionType,
                        session_id: sessionId,
                        view_duration_seconds: viewDuration,
                        timezone: getUserTimezone()
                    })
                });
                console.log(`Notice view logged: ${caseNumber} - ${actionType}`);
            } catch (error) {
                console.error('Failed to log notice view:', error);
            }
        }

        // Display document content
        function displayDocumentContent(notice, signMode = false) {
            const modalBody = document.getElementById('modalBody');
            const deviceInfo = detectDeviceType();
            
            // Build the NFT pairing info header
            let headerInfo = `
                <div class="nft-pairing-info" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h5 style="margin: 0 0 10px 0; color: var(--primary-color);"><i class="bi bi-link-45deg"></i> Legal Notice Package</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <div style="padding: 10px; background: white; border-radius: 5px; border-left: 3px solid var(--success-color);">
                            <strong><i class="bi bi-envelope-check"></i> Alert NFT #${notice.alert_token_id}</strong><br>
                            <span style="color: var(--text-light);">Proof of Service (In Your Wallet)</span>
                        </div>
                        <div style="padding: 10px; background: white; border-radius: 5px; border-left: 3px solid var(--secondary-color);">
                            <strong><i class="bi bi-file-earmark-text"></i> Document NFT #${notice.document_token_id || 'Pending'}</strong><br>
                            <span style="color: var(--text-light);">Legal Document (Permanent Record)</span>
                        </div>
                    </div>
                    <p style="margin: 10px 0 0 0; font-size: 13px; color: var(--text-light);">
                        <i class="bi bi-info-circle"></i> Both NFTs constitute your complete legal notice. The Alert NFT proves delivery, while the Document NFT contains the full legal content.
                    </p>
                </div>
            `;
            
            // Check if images are available
            if (notice.images) {
                let imageContent = '';
                
                // Show alert image if available
                if (notice.images.alert_image || notice.images.alert_thumbnail) {
                    const alertImage = notice.images.alert_image || notice.images.alert_thumbnail;
                    imageContent += `
                        <div class="document-section">
                            <h4><i class="bi bi-bell-fill"></i> Service Alert</h4>
                            <div class="image-container" style="margin: 15px 0;">
                                <img src="${alertImage}" 
                                     alt="Service Alert" 
                                     style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                     onclick="window.open('${alertImage}', '_blank')">
                            </div>
                        </div>
                    `;
                }
                
                // Show document image if available
                if (notice.images.document_image || notice.images.document_thumbnail) {
                    const docImage = notice.images.document_image || notice.images.document_thumbnail;
                    imageContent += `
                        <div class="document-section" style="margin-top: 20px;">
                            <h4><i class="bi bi-file-earmark-text"></i> Document NFT - Legal Content</h4>
                            <div class="image-container" style="margin: 15px 0;">
                                <img src="${docImage}" 
                                     alt="Document NFT - Legal Content" 
                                     style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;"
                                     onclick="window.open('${docImage}', '_blank')"
                                     title="Click to view full size">
                            </div>
                            ${signMode && !notice.accepted ? `
                                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; padding: 10px; margin: 10px 0;">
                                    <i class="bi bi-exclamation-triangle"></i> <strong>Signature Required</strong><br>
                                    <span style="font-size: 13px;">This document requires your signature for acknowledgment.</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                if (imageContent) {
                    modalBody.innerHTML = `
                        ${headerInfo}
                        <div class="document-info">
                            <p><strong>Case Number:</strong> ${notice.case_number}</p>
                            <p><strong>Served:</strong> ${new Date(notice.served_at).toLocaleString()}</p>
                            <p><strong>Issuing Agency:</strong> ${notice.issuing_agency || 'via Blockserved.com'}</p>
                            <p><strong>Page Count:</strong> ${notice.page_count || 1} pages</p>
                        </div>
                        ${deviceInfo.isMobile ? '<p style="text-align: center; color: var(--text-light); font-size: 12px; margin: 10px 0;"><i class="bi bi-hand-index"></i> Pinch to zoom â€¢ Swipe to scroll</p>' : ''}
                        ${imageContent}
                        <div class="action-buttons" style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                            <button onclick="printDocumentImages('${notice.case_number}')" class="btn btn-secondary" style="${deviceInfo.isMobile ? 'flex: 1; min-width: 120px;' : ''}">
                                <i class="bi bi-printer"></i> Print
                            </button>
                            <button onclick="downloadDocumentImages('${notice.case_number}')" class="btn btn-secondary" style="${deviceInfo.isMobile ? 'flex: 1; min-width: 120px;' : ''}">
                                <i class="bi bi-image"></i> Images
                            </button>
                            <button onclick="downloadOriginalPDF(currentNotice)" class="btn btn-primary" style="${deviceInfo.isMobile ? 'flex: 1; min-width: 120px;' : ''}">
                                <i class="bi bi-file-pdf"></i> Download PDF
                            </button>
                            ${signMode && !notice.accepted ? `
                                <button onclick="signDocument()" class="btn btn-primary" style="${deviceInfo.isMobile ? 'flex: 1; min-width: 120px;' : ''}">
                                    <i class="bi bi-pen"></i> Sign Document
                                </button>
                            ` : ''}
                        </div>
                    `;
                    
                    // Enable pinch-to-zoom on mobile for images
                    if (deviceInfo.isMobile) {
                        setTimeout(() => {
                            const images = modalBody.querySelectorAll('img');
                            images.forEach(img => {
                                img.style.touchAction = 'pinch-zoom';
                                img.style.userSelect = 'none';
                            });
                        }, 100);
                    }
                    
                    return;
                }
            }
            
            // Fallback to IPFS info if no images
            if (notice.ipfs_hash) {
                modalBody.innerHTML = `
                    ${headerInfo}
                    <div class="alert-message alert-info">
                        <i class="bi bi-lock-fill"></i>
                        <div>
                            <strong>Encrypted Document Available</strong><br>
                            This document is stored securely on IPFS.
                        </div>
                    </div>
                    
                    <div class="document-info">
                        <h4>Document Information</h4>
                        <p><strong>Case Number:</strong> ${notice.case_number}</p>
                        <p><strong>IPFS Hash:</strong> <code>${notice.ipfs_hash}</code></p>
                        <p><strong>Page Count:</strong> ${notice.page_count || 1} pages</p>
                        <p><strong>Served:</strong> ${new Date(notice.served_at).toLocaleString()}</p>
                    </div>
                    ${signMode && !notice.accepted ? `
                        <div class="action-buttons" style="margin-top: 20px; text-align: center;">
                            <button onclick="signDocument()" class="btn btn-primary">
                                <i class="bi bi-pen"></i> Sign Document
                            </button>
                        </div>
                    ` : ''}
                `;
            } else {
                // No preview images, but PDF may still be available on backend
                modalBody.innerHTML = `
                    ${headerInfo}
                    <div class="document-info" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>Case Number:</strong> ${notice.case_number}</p>
                        <p><strong>Alert NFT:</strong> #${notice.alert_token_id}</p>
                        <p><strong>Document NFT:</strong> #${notice.document_token_id || 'Pending'}</p>
                        <p><strong>Served:</strong> ${new Date(notice.served_at).toLocaleString()}</p>
                        <p><strong>Status:</strong> ${notice.status || 'Served'}</p>
                    </div>
                    <div style="text-align: center; margin: 20px 0;">
                        <button onclick="downloadCasePDF('${notice.case_number}')" class="btn btn-primary" style="margin: 5px;">
                            <i class="bi bi-file-earmark-pdf"></i> View/Download Legal Document
                        </button>
                    </div>
                    ${signMode && !notice.accepted ? `
                        <div class="action-buttons" style="margin-top: 20px; text-align: center;">
                            <button onclick="signDocument()" class="btn btn-success">
                                <i class="bi bi-pen"></i> Sign Document
                            </button>
                        </div>
                    ` : ''}
                `;
            }
            
            // Update sign button state
            const signButton = document.getElementById('signButton');
            if (notice.alreadySigned) {
                signButton.disabled = true;
                signButton.innerHTML = '<i class="bi bi-check"></i> Already Signed';
            }
        }

        // Log signature event to backend for audit trail
        async function logSignatureEvent(caseNumber, eventType, details = {}) {
            try {
                const timezone = getUserTimezone();
                await fetch(`${BACKEND_URL}/api/recipient-logs/signature-event`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Timezone': timezone || ''
                    },
                    body: JSON.stringify({
                        case_number: caseNumber,
                        wallet_address: currentWallet,
                        event_type: eventType,
                        session_id: sessionId,
                        timestamp: new Date().toISOString(),
                        details: {
                            ...details,
                            userAgent: navigator.userAgent,
                            language: navigator.language,
                            timezone: timezone,
                            screenSize: `${screen.width}x${screen.height}`
                        }
                    })
                });
                console.log(`Signature event logged: ${caseNumber} - ${eventType}`);
            } catch (error) {
                console.error('Failed to log signature event:', error);
            }
        }

        // Sign document (only for Document NFT)
        async function signDocument() {
            const notice = currentNotice;
            if (!notice) {
                showAlert('No document selected', 'error');
                return;
            }

            if (!currentWallet) {
                showAlert('Please connect your wallet first', 'error');
                return;
            }

            // Ensure this is for Document NFT, not Alert NFT
            if (!notice.document_token_id) {
                showAlert('Document NFT not available for signing', 'error');
                return;
            }

            if (notice.accepted) {
                showAlert('Document already signed', 'info');
                return;
            }

            // Log signature initiated - user clicked sign button
            await logSignatureEvent(notice.case_number, 'signature_initiated', {
                alert_token_id: notice.alert_token_id,
                document_token_id: notice.document_token_id
            });

            try {
                // Create signature message specifically for Document NFT
                const message = `I acknowledge and accept the legal document (Document NFT #${notice.document_token_id}) for Case #${notice.case_number} served on ${new Date(notice.served_at).toISOString()}`;

                // Sign with TronLink - user may decline at this point
                const signature = await tronWeb.trx.sign(tronWeb.toHex(message));
                
                // Detect device and wallet for legal record
                const deviceType = detectDeviceType();
                const walletInfo = detectWalletProvider();
                
                // Get comprehensive device info for legal record
                const deviceInfo = {
                    // Device identification
                    platform: navigator.platform,
                    userAgent: navigator.userAgent,
                    vendor: navigator.vendor,
                    
                    // Device type
                    deviceType: deviceType.type,
                    operatingSystem: deviceType.os,
                    isMobile: deviceType.isMobile,
                    isDesktop: deviceType.isDesktop,
                    
                    // Language and locale
                    language: navigator.language,
                    languages: navigator.languages,
                    locale: Intl.DateTimeFormat().resolvedOptions().locale,
                    
                    // Time information
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    timezoneOffset: new Date().getTimezoneOffset(),
                    timestamp: new Date().toISOString(),
                    
                    // Screen info for forensics
                    screenResolution: `${screen.width}x${screen.height}`,
                    windowSize: `${window.innerWidth}x${window.innerHeight}`,
                    colorDepth: screen.colorDepth,
                    
                    // Device capabilities
                    touchPoints: navigator.maxTouchPoints,
                    deviceMemory: navigator.deviceMemory,
                    hardwareConcurrency: navigator.hardwareConcurrency,
                    
                    // Browser state
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine,
                    referrer: document.referrer,
                    
                    // Wallet and signature metadata
                    walletProvider: walletInfo.provider,
                    walletVersion: walletInfo.version,
                    walletType: walletInfo.type,
                    signatureMethod: walletInfo.provider || 'TronLink',
                    
                    // Browser identification
                    browserName: (function() {
                        const ua = navigator.userAgent;
                        if (ua.indexOf('Firefox') > -1) return 'Firefox';
                        if (ua.indexOf('Chrome') > -1) return 'Chrome';
                        if (ua.indexOf('Safari') > -1) return 'Safari';
                        if (ua.indexOf('Edge') > -1) return 'Edge';
                        if (ua.indexOf('Opera') > -1) return 'Opera';
                        return 'Unknown';
                    })()
                };
                
                // Try to get geolocation (optional)
                let geolocation = null;
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                    });
                    geolocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                } catch (e) {
                    // Geolocation not available or denied
                }
                
                // Send enhanced acknowledgment to logging endpoint
                const logResponse = await fetch(`${BACKEND_URL}/api/recipient-logs/acknowledgment`, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        case_number: notice.case_number,
                        wallet_address: currentWallet,
                        signature: signature,
                        geolocation: geolocation,
                        device_info: deviceInfo,
                        timezone: getUserTimezone()
                    })
                });

                // Also send to original endpoint for backward compatibility
                const response = await fetch(`${BACKEND_URL}/api/recipient-cases/${notice.case_number}/acknowledge`, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        signature: signature,
                        wallet: currentWallet,
                        timestamp: new Date().toISOString(),
                        timezone: getUserTimezone()
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Document NFT signed and legally acknowledged!', 'success');
                    // Update the current notice object
                    notice.accepted = true;
                    notice.accepted_at = new Date().toISOString();
                    notice.signature = signature;
                    // Log document action specifically for Document NFT
                    await logDocumentAction(notice.case_number, 'document_nft_signed');
                    
                    // Show receipt options
                    showSignatureReceipt(notice);
                    
                    // Reload notices to update status
                    loadNotices();
                } else {
                    showAlert('Failed to sign Document NFT. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error signing document:', error);

                // Determine the type of failure and log appropriately
                const errorMessage = error.message || error.toString();
                let eventType = 'signature_failed';
                let userMessage = 'Failed to sign document. Please try again.';

                if (errorMessage.includes('declined') || errorMessage.includes('reject') || errorMessage.includes('cancel') || errorMessage.includes('denied')) {
                    eventType = 'signature_declined';
                    userMessage = 'Signature cancelled. You can try again when ready.';
                } else if (errorMessage.includes('insufficient') || errorMessage.includes('balance') || errorMessage.includes('energy') || errorMessage.includes('bandwidth')) {
                    eventType = 'signature_failed_no_funds';
                    userMessage = 'Insufficient TRX/Energy for transaction. Please add funds to your wallet.';
                }

                // Log the failure/decline event
                await logSignatureEvent(notice.case_number, eventType, {
                    alert_token_id: notice.alert_token_id,
                    document_token_id: notice.document_token_id,
                    error_message: errorMessage,
                    error_type: error.name || 'Unknown'
                });

                showAlert(userMessage, 'error');
            }
        }

        // Close document modal
        async function closeDocumentModal() {
            // Log view duration if viewing a document
            if (currentNotice && viewStartTime) {
                await logNoticeView(currentNotice.case_number, 'document_close');
            }
            
            document.getElementById('documentModal').classList.remove('active');
            currentNotice = null;
            viewStartTime = null;
        }
        
        // Show signature receipt with permanent access instructions
        function showSignatureReceipt(notice) {
            const receiptHTML = generateReceipt(notice);
            
            // Update modal to show receipt
            document.getElementById('modalTitle').textContent = 'Legal Notice Receipt - Save for Your Records';
            document.getElementById('modalBody').innerHTML = `
                <div class="receipt-container" id="receiptContent">
                    ${receiptHTML}
                </div>
                <div class="receipt-actions" style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="printReceipt()" class="btn btn-primary">
                        <i class="bi bi-printer"></i> Print Receipt
                    </button>
                    <button onclick="downloadReceiptHTML()" class="btn btn-secondary">
                        <i class="bi bi-download"></i> Download as HTML
                    </button>
                    <button onclick="copyIPFSInfo()" class="btn btn-secondary">
                        <i class="bi bi-clipboard"></i> Copy IPFS Info
                    </button>
                    <button onclick="closeDocumentModal()" class="btn btn-secondary">
                        <i class="bi bi-x-lg"></i> Close
                    </button>
                </div>
            `;
        }
        
        // Generate receipt HTML
        function generateReceipt(notice) {
            const signatureDate = new Date(notice.accepted_at || new Date());
            const ipfsGateways = [
                'https://ipfs.io/ipfs/',
                'https://gateway.pinata.cloud/ipfs/',
                'https://cloudflare-ipfs.com/ipfs/',
                'https://gateway.ipfs.io/ipfs/'
            ];
            
            return `
                <div style="font-family: 'Arial', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; border: 2px solid #2c3e50; border-radius: 10px; background: white;">
                    <div style="text-align: center; border-bottom: 2px solid #2c3e50; padding-bottom: 20px; margin-bottom: 20px;">
                        <h2 style="color: #2c3e50; margin: 0;">LEGAL NOTICE RECEIPT</h2>
                        <p style="color: #666; margin: 10px 0 0 0;">BlockServed - Blockchain Verified Legal Service</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin: 0 0 10px 0;">Notice Information</h3>
                        <table style="width: 100%; font-size: 14px;">
                            <tr><td style="padding: 5px 0;"><strong>Case Number:</strong></td><td>${notice.case_number}</td></tr>
                            <tr><td style="padding: 5px 0;"><strong>Issuing Agency:</strong></td><td>${notice.issuing_agency || 'via Blockserved.com'}</td></tr>
                            <tr><td style="padding: 5px 0;"><strong>Served Date:</strong></td><td>${new Date(notice.served_at).toLocaleString()}</td></tr>
                            <tr><td style="padding: 5px 0;"><strong>Signed Date:</strong></td><td>${signatureDate.toLocaleString()}</td></tr>
                            <tr><td style="padding: 5px 0;"><strong>Alert NFT ID:</strong></td><td>#${notice.alert_token_id}</td></tr>
                            <tr><td style="padding: 5px 0;"><strong>Document NFT ID:</strong></td><td>#${notice.document_token_id}</td></tr>
                            <tr><td style="padding: 5px 0;"><strong>Recipient Wallet:</strong></td><td style="word-break: break-all;">${currentWallet}</td></tr>
                        </table>
                    </div>
                    
                    ${notice.ipfs_hash ? `
                    <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #3498db;">
                        <h3 style="color: #2c3e50; margin: 0 0 10px 0;"><i class="bi bi-key-fill"></i> Permanent Document Access</h3>
                        <p style="margin: 5px 0; font-size: 14px;"><strong>IPFS Hash:</strong></p>
                        <div style="background: white; padding: 10px; border-radius: 5px; word-break: break-all; font-family: monospace; font-size: 12px; margin-bottom: 10px;">
                            ${notice.ipfs_hash}
                        </div>
                        
                        ${notice.encryption_key ? `
                        <p style="margin: 10px 0 5px 0; font-size: 14px;"><strong>Decryption Key:</strong></p>
                        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; word-break: break-all; font-family: monospace; font-size: 12px; border: 1px solid #ffc107;">
                            ${notice.encryption_key}
                        </div>
                        <p style="margin: 10px 0 0 0; font-size: 12px; color: #856404;">
                            <i class="bi bi-exclamation-triangle-fill"></i> <strong>Important:</strong> Keep this decryption key safe. You'll need it to decrypt your document.
                        </p>
                        ` : ''}
                    </div>
                    
                    <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin: 0 0 10px 0;"><i class="bi bi-globe"></i> How to Access Your Document on IPFS</h3>
                        <ol style="margin: 10px 0; padding-left: 20px; font-size: 14px;">
                            <li style="margin: 5px 0;">Use any IPFS gateway by combining the gateway URL with your IPFS hash:</li>
                        </ol>
                        <div style="background: white; padding: 10px; border-radius: 5px; margin: 10px 0;">
                            ${ipfsGateways.map(gateway => `
                                <div style="margin: 5px 0; font-size: 12px;">
                                    <code style="background: #f5f5f5; padding: 5px; border-radius: 3px; display: block; overflow-x: auto;">
                                        ${gateway}${notice.ipfs_hash}
                                    </code>
                                </div>
                            `).join('')}
                        </div>
                        <ol start="2" style="margin: 10px 0; padding-left: 20px; font-size: 14px;">
                            <li style="margin: 5px 0;">Download the encrypted file from any gateway above</li>
                            ${notice.encryption_key ? '<li style="margin: 5px 0;">Use the decryption key above to decrypt the document</li>' : ''}
                            <li style="margin: 5px 0;">Your document is permanently stored and will always be accessible</li>
                        </ol>
                    </div>
                    ` : ''}
                    
                    <div style="background: #fff9e6; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffc107;">
                        <h3 style="color: #2c3e50; margin: 0 0 10px 0;"><i class="bi bi-shield-check"></i> Blockchain Verification</h3>
                        <p style="margin: 5px 0; font-size: 14px;">Your legal notice is permanently recorded on the TRON blockchain:</p>
                        <ul style="margin: 10px 0; padding-left: 20px; font-size: 13px;">
                            <li>Transaction Hash: <code>${notice.transaction_hash || 'Pending confirmation'}</code></li>
                            <li>Contract Address: <code>TXYZMnBGkXe2V9AyqufvPCqBsaUvLWYhsb</code></li>
                            <li>Network: TRON Mainnet</li>
                        </ul>
                        <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">
                            View on TronScan: <a href="https://tronscan.org/#/token721/TXYZMnBGkXe2V9AyqufvPCqBsaUvLWYhsb" target="_blank" style="color: #3498db;">Contract Explorer</a>
                        </p>
                    </div>
                    
                    <div style="border-top: 2px solid #2c3e50; padding-top: 20px; margin-top: 20px; text-align: center;">
                        <p style="margin: 5px 0; font-size: 12px; color: #666;">
                            <strong>Digital Signature:</strong> ${notice.signature ? notice.signature.substring(0, 20) + '...' : 'Not available'}
                        </p>
                        <p style="margin: 10px 0 0 0; font-size: 11px; color: #999;">
                            Generated on ${new Date().toLocaleString()} â€¢ Keep this receipt for your records
                        </p>
                        <p style="margin: 5px 0 0 0; font-size: 11px; color: #999;">
                            This receipt confirms your legal acknowledgment of the served documents.
                        </p>
                    </div>
                </div>
            `;
        }
        
        // Print receipt
        function printReceipt() {
            const printWindow = window.open('', '_blank');
            const receiptContent = document.getElementById('receiptContent').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Legal Notice Receipt - Case #${currentNotice.case_number}</title>
                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
                    <style>
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body onload="window.print(); window.close();">
                    ${receiptContent}
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // Download receipt as HTML
        function downloadReceiptHTML() {
            const receiptContent = document.getElementById('receiptContent').innerHTML;
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Legal Notice Receipt - Case #${currentNotice.case_number}</title>
                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
                </head>
                <body>
                    ${receiptContent}
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `BlockServed_Receipt_${currentNotice.case_number}_${Date.now()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Copy IPFS information to clipboard
        async function copyIPFSInfo() {
            if (!currentNotice || !currentNotice.ipfs_hash) {
                showAlert('No IPFS information available', 'error');
                return;
            }
            
            const ipfsInfo = `IPFS Hash: ${currentNotice.ipfs_hash}\n` +
                           `${currentNotice.encryption_key ? 'Decryption Key: ' + currentNotice.encryption_key + '\n' : ''}` +
                           `Access URL: https://ipfs.io/ipfs/${currentNotice.ipfs_hash}`;
            
            try {
                await navigator.clipboard.writeText(ipfsInfo);
                showAlert('IPFS information copied to clipboard!', 'success');
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = ipfsInfo;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showAlert('IPFS information copied to clipboard!', 'success');
            }
        }
        
        // Log document action to backend
        async function logDocumentAction(caseNumber, actionType) {
            try {
                await fetch(`${BACKEND_URL}/api/recipient-logs/document-action`, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        case_number: caseNumber,
                        wallet_address: currentWallet,
                        action_type: actionType,
                        timezone: getUserTimezone(),
                        metadata: {
                            session_id: sessionId,
                            timestamp: new Date().toISOString(),
                            timezone: getUserTimezone()
                        }
                    })
                });
                console.log(`Document action logged: ${caseNumber} - ${actionType}`);
            } catch (error) {
                console.error('Failed to log document action:', error);
            }
        }

        // Download document
        function downloadDocument() {
            if (!currentNotice) return;
            
            // Create a text file with document information
            const content = `
Legal Notice - Case #${currentNotice.case_number}
========================================
Notice Type: ${currentNotice.notice_type}
Issuing Agency: ${currentNotice.issuing_agency}
Served Date: ${new Date(currentNotice.served_at).toLocaleDateString()}
Alert NFT ID: #${currentNotice.alert_token_id}
Document NFT ID: #${currentNotice.document_token_id || 'N/A'}

IPFS Document Hash: ${currentNotice.ipfs_document || 'N/A'}
Encryption Key: ${currentNotice.encryption_key || 'N/A'}

To view the full document, use the IPFS hash and encryption key provided above.

This notice was served via blockchain technology and is legally binding.
Transaction Hash: ${currentNotice.transaction_hash}
            `;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `legal_notice_${currentNotice.case_number}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Print document images
        async function printDocumentImages(caseNumber) {
            try {
                // Log document action
                await logDocumentAction(caseNumber, 'print');
                
                // Create a new window for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Legal Notice - Case #${caseNumber}</title>
                        <style>
                            @media print {
                                body { margin: 0; }
                                img { max-width: 100%; page-break-inside: avoid; }
                                .page-break { page-break-after: always; }
                            }
                            body { font-family: Arial, sans-serif; }
                            h1 { text-align: center; }
                            .document-section { margin: 20px 0; }
                        </style>
                    </head>
                    <body>
                        <h1>Legal Notice - Case #${caseNumber}</h1>
                        <p>Printed: ${new Date().toLocaleString()}</p>
                `);
                
                // Get the images from the current modal
                const images = document.querySelectorAll('#modalBody img');
                images.forEach((img, index) => {
                    if (index > 0) {
                        printWindow.document.write('<div class="page-break"></div>');
                    }
                    printWindow.document.write(`
                        <div class="document-section">
                            <img src="${img.src}" alt="${img.alt}" style="width: 100%;">
                        </div>
                    `);
                });
                
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                
                setTimeout(() => {
                    printWindow.print();
                }, 500);
                
            } catch (error) {
                console.error('Error printing document:', error);
                showAlert('Failed to print document', 'error');
            }
        }
        
        // Download document images
        async function downloadDocumentImages(caseNumber) {
            try {
                // Log document action
                await logDocumentAction(caseNumber, 'download');
                
                // Get images from the modal
                const images = document.querySelectorAll('#modalBody img');
                
                images.forEach((img, index) => {
                    const link = document.createElement('a');
                    link.href = img.src;
                    link.download = `legal-notice-${caseNumber}-${index + 1}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
                
                showAlert('Documents downloaded successfully', 'success');
                
            } catch (error) {
                console.error('Error downloading document:', error);
                showAlert('Failed to download document', 'error');
            }
        }
        
        // Log document action (duplicate definition - uses getApiHeaders for consistency)
        async function logDocumentAction(caseNumber, actionType) {
            try {
                await fetch(`${BACKEND_URL}/api/recipient-logs/document-action`, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        case_number: caseNumber,
                        wallet_address: currentWallet,
                        action_type: actionType,
                        timezone: getUserTimezone(),
                        metadata: {
                            timestamp: new Date().toISOString(),
                            sessionId: sessionId,
                            timezone: getUserTimezone()
                        }
                    })
                });
                console.log(`Document action logged: ${caseNumber} - ${actionType}`);
            } catch (error) {
                console.error('Failed to log document action:', error);
            }
        }

        // Download PDF by case number (wrapper for when images aren't available)
        async function downloadCasePDF(caseNumber) {
            try {
                showAlert('Downloading document...', 'info');

                // Log the download attempt
                await logDocumentAction(caseNumber, 'download');

                const response = await fetch(
                    `${BACKEND_URL}/api/recipient-cases/${encodeURIComponent(caseNumber)}/download-pdf?recipientAddress=${currentWallet}`
                );

                if (response.ok) {
                    const contentType = response.headers.get('content-type');

                    if (contentType && contentType.includes('application/pdf')) {
                        const blob = await response.blob();
                        const downloadUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = `legal_document_case_${caseNumber}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(downloadUrl);
                        showAlert('Document downloaded successfully', 'success');
                        return;
                    }
                }

                // If download failed, try opening in new tab
                const pdfUrl = `${BACKEND_URL}/api/recipient-cases/${encodeURIComponent(caseNumber)}/download-pdf?recipientAddress=${currentWallet}`;
                window.open(pdfUrl, '_blank');

            } catch (error) {
                console.error('Error downloading PDF:', error);
                showAlert('Failed to download document. Please try again.', 'error');
            }
        }

        // Load CryptoJS for document decryption
        async function loadCryptoJS() {
            return new Promise((resolve) => {
                if (window.CryptoJS) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js';
                script.onload = resolve;
                script.onerror = () => {
                    console.error('Failed to load CryptoJS');
                    resolve();
                };
                document.head.appendChild(script);
            });
        }

        // Download the actual PDF from backend (decrypted)
        async function downloadOriginalPDF(notice) {
            try {
                showAlert('Downloading document...', 'info');

                // First try to download from backend (preferred method)
                const response = await fetch(
                    `${BACKEND_URL}/api/recipient-cases/${notice.case_number}/download-pdf?recipientAddress=${currentWallet}`
                );

                if (response.ok) {
                    const contentType = response.headers.get('content-type');

                    if (contentType && contentType.includes('application/pdf')) {
                        // Direct PDF download from backend
                        const blob = await response.blob();
                        const downloadUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = `legal_document_case_${notice.case_number}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(downloadUrl);
                        showAlert('Document downloaded successfully', 'success');
                        return;
                    }

                    // Backend returned IPFS info for client-side decryption
                    const data = await response.json();
                    if (data.success && data.method === 'ipfs') {
                        await downloadFromIPFS(data.ipfsHash, data.encryptionKey, notice.case_number);
                        return;
                    }
                }

                // Fallback to IPFS if notice has hash and key
                if (notice.ipfs_hash && notice.encryption_key) {
                    await downloadFromIPFS(notice.ipfs_hash, notice.encryption_key, notice.case_number);
                    return;
                }

                throw new Error('Document not available for download');

            } catch (error) {
                console.error('Error downloading PDF:', error);
                showAlert('Failed to download document: ' + error.message, 'error');
            }
        }

        // Download and decrypt from IPFS (fallback method)
        async function downloadFromIPFS(ipfsHash, encryptionKey, caseNumber) {
            // Log the download action
            await logDocumentAction(caseNumber, 'download_pdf_ipfs');

            // Load CryptoJS if needed
            await loadCryptoJS();

            if (!window.CryptoJS) {
                throw new Error('Failed to load decryption library');
            }

            // Fetch encrypted document from IPFS
            const ipfsGateway = 'https://gateway.pinata.cloud/ipfs/';
            const response = await fetch(`${ipfsGateway}${ipfsHash}`);

            if (!response.ok) {
                throw new Error('Failed to fetch document from IPFS');
            }

            const encryptedData = await response.arrayBuffer();
            console.log('Downloaded encrypted data, size:', encryptedData.byteLength);

            // Convert to string for CryptoJS
            const uint8Array = new Uint8Array(encryptedData);
            let encryptedString = '';
            for (let i = 0; i < uint8Array.length; i++) {
                encryptedString += String.fromCharCode(uint8Array[i]);
            }

            // Decrypt using CryptoJS AES
            const decrypted = CryptoJS.AES.decrypt(encryptedString, encryptionKey);

            if (!decrypted || decrypted.sigBytes <= 0) {
                throw new Error('Decryption failed - invalid encryption key');
            }

            // Convert WordArray to Uint8Array
            const decryptedWords = decrypted.words;
            const sigBytes = decrypted.sigBytes;
            const decryptedArray = new Uint8Array(sigBytes);

            for (let i = 0; i < sigBytes; i++) {
                decryptedArray[i] = (decryptedWords[i >>> 2] >>> (24 - (i % 4) * 8)) & 0xff;
            }

            // Verify it's a PDF
            const pdfHeader = new TextDecoder().decode(decryptedArray.slice(0, 5));
            if (pdfHeader !== '%PDF-') {
                console.warn('Decrypted content may not be a valid PDF, header:', pdfHeader);
            }

            // Create blob and download
            const blob = new Blob([decryptedArray], { type: 'application/pdf' });
            const downloadUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = `legal_document_case_${caseNumber}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(downloadUrl);

            showAlert('Document downloaded successfully', 'success');
        }

        // Show alert message
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-message alert-${type}`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '80px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '10000';
            alertDiv.style.maxWidth = '400px';
            
            const icon = type === 'success' ? 'check-circle-fill' : 
                        type === 'error' ? 'exclamation-triangle-fill' : 'info-circle-fill';
            
            alertDiv.innerHTML = `
                <i class="bi bi-${icon}"></i>
                <div>${message}</div>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>