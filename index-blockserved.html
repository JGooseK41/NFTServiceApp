<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockServed - Official Legal Notice Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #ecf0f1;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        /* Professional Header */
        .header-section {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: var(--primary-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .logo-text h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            color: var(--primary-color);
        }

        .logo-text p {
            font-size: 12px;
            color: var(--text-light);
            margin: 0;
        }

        /* Wallet Connection */
        .wallet-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .wallet-status {
            padding: 8px 16px;
            background: var(--light-bg);
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wallet-status.connected {
            background: #d4f1e4;
            color: var(--success-color);
        }

        .connect-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connect-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        /* Main Content */
        .main-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* Information Banner */
        .info-banner {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .info-banner h2 {
            color: var(--primary-color);
            font-size: 28px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .info-banner p {
            color: var(--text-light);
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .steps-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .step-card {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            align-items: start;
            gap: 15px;
        }

        .step-number {
            width: 35px;
            height: 35px;
            background: var(--secondary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content h4 {
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .step-content p {
            font-size: 14px;
            color: var(--text-light);
            margin: 0;
        }

        /* Notices Section */
        .notices-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
        }

        .section-header h3 {
            font-size: 22px;
            color: var(--primary-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notice-count {
            background: var(--secondary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        /* Notice Cards */
        .notice-card {
            background: white;
            border: 2px solid #e8ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .notice-card:hover {
            border-color: var(--secondary-color);
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.15);
        }

        .notice-card.urgent {
            border-left: 4px solid var(--danger-color);
        }

        .notice-card.important {
            border-left: 4px solid var(--warning-color);
        }

        .notice-card.standard {
            border-left: 4px solid var(--secondary-color);
        }

        .notice-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .notice-title {
            flex: 1;
        }

        .notice-title h4 {
            font-size: 18px;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .notice-title p {
            font-size: 14px;
            color: var(--text-light);
            margin: 0;
        }

        .notice-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-delivered {
            background: #fff8e1;
            color: #f57c00;
        }

        .status-viewed {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-signed {
            background: #e8f5e9;
            color: #388e3c;
        }

        .notice-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--light-bg);
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .detail-item i {
            color: var(--secondary-color);
            font-size: 16px;
        }

        .detail-item strong {
            color: var(--text-dark);
            margin-right: 5px;
        }

        .detail-item span {
            color: var(--text-light);
        }

        .notice-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .btn-view {
            flex: 1;
            padding: 12px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-view:hover {
            background: #2980b9;
        }

        .btn-sign {
            flex: 1;
            padding: 12px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-sign:hover {
            background: #229954;
        }

        .btn-sign:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state i {
            font-size: 64px;
            color: #bdc3c7;
            margin-bottom: 20px;
        }

        .empty-state h4 {
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .empty-state p {
            color: var(--text-light);
            max-width: 400px;
            margin: 0 auto;
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light-bg);
            border-top-color: var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Document Viewer Modal */
        .document-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            padding: 20px;
        }

        .document-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--light-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--light-bg);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .steps-container {
                grid-template-columns: 1fr;
            }

            .notice-header {
                flex-direction: column;
                gap: 10px;
            }

            .notice-actions {
                flex-direction: column;
            }
        }

        /* Alert Messages */
        .alert-message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #e3f2fd;
            color: #0d47a1;
            border-left: 4px solid #1976d2;
        }

        .alert-success {
            background: #e8f5e9;
            color: #1b5e20;
            border-left: 4px solid #4caf50;
        }

        .alert-error {
            background: #ffebee;
            color: #b71c1c;
            border-left: 4px solid #f44336;
        }
    </style>
</head>
<body>
    <!-- Professional Header -->
    <header class="header-section">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">
                    <i class="bi bi-shield-check"></i>
                </div>
                <div class="logo-text">
                    <h1>BlockServed</h1>
                    <p>Official Legal Notice Portal</p>
                </div>
            </div>
            <div class="wallet-section">
                <div id="walletStatus" class="wallet-status">
                    <i class="bi bi-wallet2"></i>
                    <span>Not Connected</span>
                </div>
                <button id="connectWallet" class="connect-btn">
                    Connect Wallet
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Information Banner -->
        <div class="info-banner">
            <h2>You Have Been Served Legal Documents</h2>
            <p>
                This portal allows you to securely view and acknowledge legal notices that have been served to you via blockchain technology. 
                These notices are legally binding and have been recorded on the TRON blockchain for permanent verification.
            </p>
            
            <div class="alert-message alert-info">
                <i class="bi bi-info-circle-fill"></i>
                <div>
                    <strong>Important:</strong> These are official legal documents. Please review them carefully and take appropriate action as required by law.
                </div>
            </div>

            <div class="steps-container">
                <div class="step-card">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Connect Your Wallet</h4>
                        <p>Use the wallet that received the notice NFT</p>
                    </div>
                </div>
                <div class="step-card">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>View Your Notices</h4>
                        <p>All served documents will appear automatically</p>
                    </div>
                </div>
                <div class="step-card">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h4>Read Documents</h4>
                        <p>Click to view the full legal documents</p>
                    </div>
                </div>
                <div class="step-card">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h4>Acknowledge Receipt</h4>
                        <p>Sign to confirm you've received the notice</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notices Section -->
        <div class="notices-section">
            <div class="section-header">
                <h3>
                    <i class="bi bi-envelope-open"></i>
                    Your Legal Notices
                    <span id="noticeCount" class="notice-count">0</span>
                </h3>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading-state" style="display: none;">
                <div class="spinner"></div>
                <h4>Loading your notices...</h4>
                <p>Please wait while we retrieve your legal documents</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state">
                <i class="bi bi-inbox"></i>
                <h4>No Notices Found</h4>
                <p>Connect your wallet to view any legal notices that have been served to your address</p>
            </div>

            <!-- Notices Container -->
            <div id="noticesContainer">
                <!-- Notices will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div id="documentModal" class="document-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Legal Document</h3>
                <button class="close-modal" onclick="closeDocumentModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Document content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn-view" onclick="downloadDocument()">
                    <i class="bi bi-download"></i> Download
                </button>
                <button class="btn-sign" id="signButton" onclick="signDocument()">
                    <i class="bi bi-pen"></i> Sign & Acknowledge
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/tronweb@5.3.0/dist/TronWeb.min.js"></script>
    <script>
        // Configuration
        const BACKEND_URL = 'https://nftserviceapp.onrender.com';
        
        // State
        let tronWeb = null;
        let currentWallet = null;
        let currentNotice = null;
        let viewStartTime = null;
        
        // Generate session ID for tracking
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            checkTronLink();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
        }

        // Check if TronLink is available
        function checkTronLink() {
            if (window.tronWeb && window.tronWeb.ready) {
                tronWeb = window.tronWeb;
                handleWalletConnected();
            } else {
                setTimeout(checkTronLink, 500);
            }
        }

        // Connect wallet
        async function connectWallet() {
            try {
                if (!window.tronWeb) {
                    showAlert('Please install TronLink wallet extension', 'error');
                    return;
                }

                // Request account access
                const accounts = await window.tronLink.request({ method: 'tron_requestAccounts' });
                
                if (accounts && accounts.length > 0) {
                    handleWalletConnected();
                }
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showAlert('Failed to connect wallet. Please try again.', 'error');
            }
        }

        // Handle wallet connection
        async function handleWalletConnected() {
            if (!window.tronWeb || !window.tronWeb.ready) return;
            
            currentWallet = window.tronWeb.defaultAddress.base58;
            
            // Log wallet connection to backend
            await logWalletConnection(currentWallet);
            
            // Update UI
            const walletStatus = document.getElementById('walletStatus');
            walletStatus.classList.add('connected');
            walletStatus.innerHTML = `
                <i class="bi bi-check-circle-fill"></i>
                <span>${currentWallet.substring(0, 6)}...${currentWallet.substring(currentWallet.length - 4)}</span>
            `;
            
            document.getElementById('connectWallet').style.display = 'none';
            
            // Load notices
            loadNotices();
        }
        
        // Detect device type
        function detectDeviceType() {
            const ua = navigator.userAgent.toLowerCase();
            const isMobile = /mobile|android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(ua);
            const isTablet = /tablet|ipad/i.test(ua) || (isMobile && screen.width >= 768);
            const isDesktop = !isMobile && !isTablet;
            
            // Detect OS
            let os = 'Unknown';
            if (/windows/i.test(ua)) os = 'Windows';
            else if (/mac/i.test(ua)) os = 'MacOS';
            else if (/android/i.test(ua)) os = 'Android';
            else if (/ios|iphone|ipad/i.test(ua)) os = 'iOS';
            else if (/linux/i.test(ua)) os = 'Linux';
            
            return {
                type: isDesktop ? 'Desktop' : (isTablet ? 'Tablet' : 'Mobile'),
                os: os,
                isMobile: isMobile,
                isTablet: isTablet,
                isDesktop: isDesktop
            };
        }
        
        // Detect wallet provider
        function detectWalletProvider() {
            if (window.tronLink) {
                return {
                    provider: 'TronLink',
                    version: window.tronLink.version || 'Unknown',
                    type: 'Browser Extension',
                    ready: window.tronLink.ready
                };
            } else if (window.tronWeb) {
                // Could be injected by other wallets
                return {
                    provider: 'TronWeb Compatible',
                    version: 'Unknown',
                    type: 'Unknown',
                    ready: window.tronWeb.ready
                };
            }
            return {
                provider: 'None',
                version: null,
                type: null,
                ready: false
            };
        }
        
        // Log wallet connection to backend
        async function logWalletConnection(walletAddress) {
            try {
                // Detect device and wallet info
                const deviceType = detectDeviceType();
                const walletInfo = detectWalletProvider();
                
                // Comprehensive device and browser information
                const browserInfo = {
                    // Browser details
                    userAgent: navigator.userAgent,
                    appName: navigator.appName,
                    appVersion: navigator.appVersion,
                    vendor: navigator.vendor,
                    language: navigator.language,
                    languages: navigator.languages,
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine,
                    doNotTrack: navigator.doNotTrack,
                    
                    // Device type detection
                    deviceType: deviceType.type,
                    operatingSystem: deviceType.os,
                    isMobile: deviceType.isMobile,
                    isTablet: deviceType.isTablet,
                    isDesktop: deviceType.isDesktop,
                    
                    // Wallet information
                    walletProvider: walletInfo.provider,
                    walletVersion: walletInfo.version,
                    walletType: walletInfo.type,
                    
                    // Device details
                    platform: navigator.platform,
                    hardwareConcurrency: navigator.hardwareConcurrency,
                    deviceMemory: navigator.deviceMemory,
                    maxTouchPoints: navigator.maxTouchPoints,
                    
                    // Screen details
                    screenResolution: `${screen.width}x${screen.height}`,
                    screenColorDepth: screen.colorDepth,
                    screenPixelDepth: screen.pixelDepth,
                    availableScreenSize: `${screen.availWidth}x${screen.availHeight}`,
                    
                    // Window details
                    windowSize: `${window.innerWidth}x${window.innerHeight}`,
                    devicePixelRatio: window.devicePixelRatio,
                    
                    // Timezone and locale
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    timezoneOffset: new Date().getTimezoneOffset(),
                    locale: Intl.DateTimeFormat().resolvedOptions().locale,
                    
                    // Connection info
                    connection: navigator.connection ? {
                        effectiveType: navigator.connection.effectiveType,
                        downlink: navigator.connection.downlink,
                        rtt: navigator.connection.rtt,
                        saveData: navigator.connection.saveData
                    } : null
                };
                
                await fetch(`${BACKEND_URL}/api/recipient-logs/connection`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wallet_address: walletAddress,
                        session_id: sessionId,
                        browser_info: browserInfo
                    })
                });
                console.log('Wallet connection logged');
            } catch (error) {
                console.error('Failed to log connection:', error);
            }
        }

        // Load notices for the connected wallet
        async function loadNotices() {
            if (!currentWallet) return;
            
            // Show loading state
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('noticesContainer').innerHTML = '';
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/recipient-cases/wallet/${currentWallet}`);
                const data = await response.json();
                
                document.getElementById('loadingState').style.display = 'none';
                
                if (data.success && data.notices && data.notices.length > 0) {
                    displayNotices(data.notices);
                    document.getElementById('noticeCount').textContent = data.notices.length;
                } else {
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('noticeCount').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading notices:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                showAlert('Failed to load notices. Please try again.', 'error');
            }
        }

        // Display notices
        function displayNotices(notices) {
            const container = document.getElementById('noticesContainer');
            container.innerHTML = '';
            
            notices.forEach(notice => {
                const urgencyClass = notice.notice_type?.includes('Urgent') ? 'urgent' : 
                                   notice.notice_type?.includes('Important') ? 'important' : 'standard';
                
                const noticeCard = document.createElement('div');
                noticeCard.className = `notice-card ${urgencyClass}`;
                noticeCard.innerHTML = `
                    <div class="notice-header">
                        <div class="notice-title">
                            <h4>Case #${notice.case_number}</h4>
                            <p>${notice.notice_type || 'Legal Notice'} - ${notice.issuing_agency || 'Legal Services'}</p>
                        </div>
                        <div class="notice-status">
                            <span class="status-badge status-delivered">Delivered</span>
                            ${notice.accepted ? '<span class="status-badge status-signed">Signed</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="notice-details">
                        <div class="detail-item">
                            <i class="bi bi-calendar3"></i>
                            <strong>Served:</strong>
                            <span>${new Date(notice.served_at || notice.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-hash"></i>
                            <strong>Alert NFT:</strong>
                            <span>#${notice.alert_token_id}</span>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-file-text"></i>
                            <strong>Pages:</strong>
                            <span>${notice.page_count || 1}</span>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-link-45deg"></i>
                            <strong>Blockchain:</strong>
                            <span>TRON</span>
                        </div>
                    </div>
                    
                    <div class="notice-actions">
                        <button class="btn-view" onclick='viewDocument(${JSON.stringify(notice)})'>
                            <i class="bi bi-eye"></i> View Document
                        </button>
                        ${!notice.accepted ? `
                            <button class="btn-sign" onclick='signNotice(${JSON.stringify(notice)})'>
                                <i class="bi bi-pen"></i> Sign & Acknowledge
                            </button>
                        ` : `
                            <button class="btn-sign" disabled>
                                <i class="bi bi-check"></i> Already Signed
                            </button>
                        `}
                    </div>
                `;
                
                container.appendChild(noticeCard);
            });
        }

        // View document
        async function viewDocument(notice) {
            currentNotice = notice;
            viewStartTime = Date.now();
            
            // Log notice view
            await logNoticeView(notice.case_number, 'detail_view');
            
            // Show modal
            document.getElementById('documentModal').classList.add('active');
            document.getElementById('modalTitle').textContent = `Legal Document - Case #${notice.case_number}`;
            
            // Load document
            document.getElementById('modalBody').innerHTML = `
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading document...</p>
                </div>
            `;
            
            try {
                // Fetch document details
                const response = await fetch(`${BACKEND_URL}/api/recipient-cases/${notice.case_number}/document`);
                const data = await response.json();
                
                if (data.success && data.notice) {
                    displayDocumentContent(data.notice);
                    // Log document open
                    await logNoticeView(notice.case_number, 'document_open');
                }
            } catch (error) {
                console.error('Error loading document:', error);
                document.getElementById('modalBody').innerHTML = `
                    <div class="alert-message alert-error">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        Failed to load document. Please try again.
                    </div>
                `;
            }
        }
        
        // Log notice view to backend
        async function logNoticeView(caseNumber, actionType) {
            try {
                let viewDuration = null;
                if (viewStartTime && actionType === 'document_close') {
                    viewDuration = Math.floor((Date.now() - viewStartTime) / 1000);
                }
                
                await fetch(`${BACKEND_URL}/api/recipient-logs/notice-view`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        case_number: caseNumber,
                        wallet_address: currentWallet,
                        action_type: actionType,
                        session_id: sessionId,
                        view_duration_seconds: viewDuration
                    })
                });
                console.log(`Notice view logged: ${caseNumber} - ${actionType}`);
            } catch (error) {
                console.error('Failed to log notice view:', error);
            }
        }

        // Display document content
        function displayDocumentContent(notice) {
            const modalBody = document.getElementById('modalBody');
            
            // If there's an IPFS hash and encryption key, show encrypted document notice
            if (notice.ipfsHash && notice.encryptionKey) {
                modalBody.innerHTML = `
                    <div class="alert-message alert-info">
                        <i class="bi bi-lock-fill"></i>
                        <div>
                            <strong>Encrypted Document Available</strong><br>
                            This document is stored securely on IPFS. Use the decryption key provided to view the full document.
                        </div>
                    </div>
                    
                    <div class="document-info">
                        <h4>Document Information</h4>
                        <p><strong>IPFS Hash:</strong> <code>${notice.ipfsHash}</code></p>
                        <p><strong>Encryption Key:</strong> <code>${notice.encryptionKey}</code></p>
                        <p><strong>Page Count:</strong> ${notice.pageCount} pages</p>
                    </div>
                    
                    ${notice.documentPreview ? `
                        <div class="document-preview">
                            <h4>Document Preview</h4>
                            <img src="${notice.documentPreview}" style="max-width: 100%; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                    ` : ''}
                `;
            } else {
                modalBody.innerHTML = `
                    <div class="alert-message alert-info">
                        <i class="bi bi-info-circle"></i>
                        Document details are being prepared. Please check back later.
                    </div>
                `;
            }
            
            // Update sign button state
            const signButton = document.getElementById('signButton');
            if (notice.alreadySigned) {
                signButton.disabled = true;
                signButton.innerHTML = '<i class="bi bi-check"></i> Already Signed';
            }
        }

        // Sign notice
        async function signNotice(notice) {
            if (!currentWallet) {
                showAlert('Please connect your wallet first', 'error');
                return;
            }
            
            try {
                // Create signature message
                const message = `I acknowledge receipt of legal notice for Case #${notice.case_number} served on ${new Date(notice.served_at).toISOString()}`;
                
                // Sign with TronLink
                const signature = await tronWeb.trx.sign(tronWeb.toHex(message));
                
                // Detect device and wallet for legal record
                const deviceType = detectDeviceType();
                const walletInfo = detectWalletProvider();
                
                // Get comprehensive device info for legal record
                const deviceInfo = {
                    // Device identification
                    platform: navigator.platform,
                    userAgent: navigator.userAgent,
                    vendor: navigator.vendor,
                    
                    // Device type
                    deviceType: deviceType.type,
                    operatingSystem: deviceType.os,
                    isMobile: deviceType.isMobile,
                    isDesktop: deviceType.isDesktop,
                    
                    // Language and locale
                    language: navigator.language,
                    languages: navigator.languages,
                    locale: Intl.DateTimeFormat().resolvedOptions().locale,
                    
                    // Time information
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    timezoneOffset: new Date().getTimezoneOffset(),
                    timestamp: new Date().toISOString(),
                    
                    // Screen info for forensics
                    screenResolution: `${screen.width}x${screen.height}`,
                    windowSize: `${window.innerWidth}x${window.innerHeight}`,
                    colorDepth: screen.colorDepth,
                    
                    // Device capabilities
                    touchPoints: navigator.maxTouchPoints,
                    deviceMemory: navigator.deviceMemory,
                    hardwareConcurrency: navigator.hardwareConcurrency,
                    
                    // Browser state
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine,
                    referrer: document.referrer,
                    
                    // Wallet and signature metadata
                    walletProvider: walletInfo.provider,
                    walletVersion: walletInfo.version,
                    walletType: walletInfo.type,
                    signatureMethod: walletInfo.provider || 'TronLink',
                    
                    // Browser identification
                    browserName: (function() {
                        const ua = navigator.userAgent;
                        if (ua.indexOf('Firefox') > -1) return 'Firefox';
                        if (ua.indexOf('Chrome') > -1) return 'Chrome';
                        if (ua.indexOf('Safari') > -1) return 'Safari';
                        if (ua.indexOf('Edge') > -1) return 'Edge';
                        if (ua.indexOf('Opera') > -1) return 'Opera';
                        return 'Unknown';
                    })()
                };
                
                // Try to get geolocation (optional)
                let geolocation = null;
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                    });
                    geolocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                } catch (e) {
                    // Geolocation not available or denied
                }
                
                // Send enhanced acknowledgment to logging endpoint
                const logResponse = await fetch(`${BACKEND_URL}/api/recipient-logs/acknowledgment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        case_number: notice.case_number,
                        wallet_address: currentWallet,
                        signature: signature,
                        geolocation: geolocation,
                        device_info: deviceInfo
                    })
                });
                
                // Also send to original endpoint for backward compatibility
                const response = await fetch(`${BACKEND_URL}/api/recipient-cases/${notice.case_number}/acknowledge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        signature: signature,
                        wallet: currentWallet,
                        timestamp: new Date().toISOString()
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Document signed and legally acknowledged!', 'success');
                    // Log document action
                    await logDocumentAction(notice.case_number, 'signed');
                    // Reload notices to update status
                    loadNotices();
                    closeDocumentModal();
                } else {
                    showAlert('Failed to sign document. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error signing document:', error);
                showAlert('Failed to sign document. Please try again.', 'error');
            }
        }

        // Close document modal
        async function closeDocumentModal() {
            // Log view duration if viewing a document
            if (currentNotice && viewStartTime) {
                await logNoticeView(currentNotice.case_number, 'document_close');
            }
            
            document.getElementById('documentModal').classList.remove('active');
            currentNotice = null;
            viewStartTime = null;
        }
        
        // Log document action to backend
        async function logDocumentAction(caseNumber, actionType) {
            try {
                await fetch(`${BACKEND_URL}/api/recipient-logs/document-action`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        case_number: caseNumber,
                        wallet_address: currentWallet,
                        action_type: actionType,
                        metadata: {
                            session_id: sessionId,
                            timestamp: new Date().toISOString()
                        }
                    })
                });
                console.log(`Document action logged: ${caseNumber} - ${actionType}`);
            } catch (error) {
                console.error('Failed to log document action:', error);
            }
        }

        // Download document
        function downloadDocument() {
            if (!currentNotice) return;
            
            // Create a text file with document information
            const content = `
Legal Notice - Case #${currentNotice.case_number}
========================================
Notice Type: ${currentNotice.notice_type}
Issuing Agency: ${currentNotice.issuing_agency}
Served Date: ${new Date(currentNotice.served_at).toLocaleDateString()}
Alert NFT ID: #${currentNotice.alert_token_id}
Document NFT ID: #${currentNotice.document_token_id || 'N/A'}

IPFS Document Hash: ${currentNotice.ipfs_document || 'N/A'}
Encryption Key: ${currentNotice.encryption_key || 'N/A'}

To view the full document, use the IPFS hash and encryption key provided above.

This notice was served via blockchain technology and is legally binding.
Transaction Hash: ${currentNotice.transaction_hash}
            `;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `legal_notice_${currentNotice.case_number}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Show alert message
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-message alert-${type}`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '80px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '10000';
            alertDiv.style.maxWidth = '400px';
            
            const icon = type === 'success' ? 'check-circle-fill' : 
                        type === 'error' ? 'exclamation-triangle-fill' : 'info-circle-fill';
            
            alertDiv.innerHTML = `
                <i class="bi bi-${icon}"></i>
                <div>${message}</div>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>