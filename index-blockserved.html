<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockServed - Official Legal Notice Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #ecf0f1;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        /* Professional Header */
        .header-section {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: var(--primary-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .logo-text h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            color: var(--primary-color);
        }

        .logo-text p {
            font-size: 12px;
            color: var(--text-light);
            margin: 0;
        }

        /* Wallet Connection */
        .wallet-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .wallet-status {
            padding: 8px 16px;
            background: var(--light-bg);
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wallet-status.connected {
            background: #d4f1e4;
            color: var(--success-color);
        }

        .connect-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connect-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        /* Main Content */
        .main-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* Information Banner */
        .info-banner {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .info-banner h2 {
            color: var(--primary-color);
            font-size: 28px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .info-banner p {
            color: var(--text-light);
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .steps-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .step-card {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            align-items: start;
            gap: 15px;
        }

        .step-number {
            width: 35px;
            height: 35px;
            background: var(--secondary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content h4 {
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .step-content p {
            font-size: 14px;
            color: var(--text-light);
            margin: 0;
        }

        /* Notices Section */
        .notices-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
        }

        .section-header h3 {
            font-size: 22px;
            color: var(--primary-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notice-count {
            background: var(--secondary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        /* Notice Cards */
        .notice-card {
            background: white;
            border: 2px solid #e8ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .notice-card:hover {
            border-color: var(--secondary-color);
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.15);
        }

        .notice-card.urgent {
            border-left: 4px solid var(--danger-color);
        }

        .notice-card.important {
            border-left: 4px solid var(--warning-color);
        }

        .notice-card.standard {
            border-left: 4px solid var(--secondary-color);
        }

        .notice-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .notice-title {
            flex: 1;
        }

        .notice-title h4 {
            font-size: 18px;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .notice-title p {
            font-size: 14px;
            color: var(--text-light);
            margin: 0;
        }

        .notice-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-delivered {
            background: #fff8e1;
            color: #f57c00;
        }

        .status-viewed {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-signed {
            background: #e8f5e9;
            color: #388e3c;
        }

        .notice-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--light-bg);
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .detail-item i {
            color: var(--secondary-color);
            font-size: 16px;
        }

        .detail-item strong {
            color: var(--text-dark);
            margin-right: 5px;
        }

        .detail-item span {
            color: var(--text-light);
        }

        .notice-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .btn-view {
            flex: 1;
            padding: 12px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-view:hover {
            background: #2980b9;
        }

        .btn-sign {
            flex: 1;
            padding: 12px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-sign:hover {
            background: #229954;
        }

        .btn-sign:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state i {
            font-size: 64px;
            color: #bdc3c7;
            margin-bottom: 20px;
        }

        .empty-state h4 {
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .empty-state p {
            color: var(--text-light);
            max-width: 400px;
            margin: 0 auto;
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light-bg);
            border-top-color: var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Document Viewer Modal */
        .document-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            padding: 20px;
        }

        .document-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--light-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--light-bg);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .steps-container {
                grid-template-columns: 1fr;
            }

            .notice-header {
                flex-direction: column;
                gap: 10px;
            }

            .notice-actions {
                flex-direction: column;
            }
        }

        /* Alert Messages */
        .alert-message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #e3f2fd;
            color: #0d47a1;
            border-left: 4px solid #1976d2;
        }

        .alert-success {
            background: #e8f5e9;
            color: #1b5e20;
            border-left: 4px solid #4caf50;
        }

        .alert-error {
            background: #ffebee;
            color: #b71c1c;
            border-left: 4px solid #f44336;
        }
    </style>
</head>
<body>
    <!-- Professional Header -->
    <header class="header-section">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">
                    <i class="bi bi-shield-check"></i>
                </div>
                <div class="logo-text">
                    <h1>BlockServed</h1>
                    <p>Official Legal Notice Portal</p>
                </div>
            </div>
            <div class="wallet-section">
                <div id="walletStatus" class="wallet-status">
                    <i class="bi bi-wallet2"></i>
                    <span>Not Connected</span>
                </div>
                <button id="connectWallet" class="connect-btn">
                    Connect Wallet
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Information Banner -->
        <div class="info-banner">
            <h2>You Have Been Served Legal Documents</h2>
            <p>
                This portal allows you to securely view and acknowledge legal notices that have been served to you via blockchain technology. 
                These notices are legally binding and have been recorded on the TRON blockchain for permanent verification.
            </p>
            
            <div class="alert-message alert-info">
                <i class="bi bi-info-circle-fill"></i>
                <div>
                    <strong>Important:</strong> These are official legal documents. Please review them carefully and take appropriate action as required by law.
                </div>
            </div>

            <div class="steps-container">
                <div class="step-card">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Connect Your Wallet</h4>
                        <p>Use the wallet that received the notice NFT</p>
                    </div>
                </div>
                <div class="step-card">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>View Your Notices</h4>
                        <p>All served documents will appear automatically</p>
                    </div>
                </div>
                <div class="step-card">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h4>Read Documents</h4>
                        <p>Click to view the full legal documents</p>
                    </div>
                </div>
                <div class="step-card">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h4>Acknowledge Receipt</h4>
                        <p>Sign to confirm you've received the notice</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notices Section -->
        <div class="notices-section">
            <div class="section-header">
                <h3>
                    <i class="bi bi-envelope-open"></i>
                    Your Legal Notices
                    <span id="noticeCount" class="notice-count">0</span>
                </h3>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading-state" style="display: none;">
                <div class="spinner"></div>
                <h4>Loading your notices...</h4>
                <p>Please wait while we retrieve your legal documents</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state">
                <i class="bi bi-inbox"></i>
                <h4>No Notices Found</h4>
                <p>Connect your wallet to view any legal notices that have been served to your address</p>
            </div>

            <!-- Notices Container -->
            <div id="noticesContainer">
                <!-- Notices will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div id="documentModal" class="document-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Legal Document</h3>
                <button class="close-modal" onclick="closeDocumentModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Document content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn-view" onclick="downloadCasePDF(currentNotice?.case_number)">
                    <i class="bi bi-download"></i> Download PDF
                </button>
                <button class="btn-sign" id="signButton" onclick="signNotice(currentNotice)">
                    <i class="bi bi-pen"></i> Sign & Acknowledge
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/tronweb@5.3.0/dist/TronWeb.min.js"></script>
    <script>
        // Configuration
        const BACKEND_URL = 'https://nftserviceapp.onrender.com';
        
        // State
        let tronWeb = null;
        let currentWallet = null;
        let currentNotice = null;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('BlockServed: DOM loaded, initializing...');
            checkTronLink();
            setupEventListeners();
            console.log('BlockServed: Ready for wallet connection');
        });

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
        }

        // Check if TronLink is available
        function checkTronLink() {
            console.log('BlockServed: Checking for TronLink...');
            if (window.tronWeb && window.tronWeb.ready) {
                console.log('BlockServed: TronLink found and ready');
                tronWeb = window.tronWeb;
                handleWalletConnected();
            } else {
                console.log('BlockServed: TronLink not ready, retrying in 500ms...');
                setTimeout(checkTronLink, 500);
            }
        }

        // Connect wallet
        async function connectWallet() {
            try {
                if (!window.tronWeb) {
                    showAlert('Please install TronLink wallet extension', 'error');
                    return;
                }

                // Request account access
                const accounts = await window.tronLink.request({ method: 'tron_requestAccounts' });
                
                if (accounts && accounts.length > 0) {
                    handleWalletConnected();
                }
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showAlert('Failed to connect wallet. Please try again.', 'error');
            }
        }

        // Handle wallet connection
        async function handleWalletConnected() {
            console.log('BlockServed: Handling wallet connection...');
            if (!window.tronWeb || !window.tronWeb.ready) {
                console.log('BlockServed: TronWeb not ready in handleWalletConnected');
                return;
            }
            
            currentWallet = window.tronWeb.defaultAddress.base58;
            console.log('BlockServed: Connected wallet:', currentWallet);
            
            // Update UI
            const walletStatus = document.getElementById('walletStatus');
            walletStatus.classList.add('connected');
            walletStatus.innerHTML = `
                <i class="bi bi-check-circle-fill"></i>
                <span>${currentWallet.substring(0, 6)}...${currentWallet.substring(currentWallet.length - 4)}</span>
            `;
            
            document.getElementById('connectWallet').style.display = 'none';
            
            // Load notices
            console.log('BlockServed: Loading notices for wallet...');
            loadNotices();
        }

        // Get user's timezone for forensic tracking
        function getUserTimezone() {
            try {
                return Intl.DateTimeFormat().resolvedOptions().timeZone;
            } catch (e) {
                return null;
            }
        }

        // Load notices for the connected wallet
        async function loadNotices() {
            console.log('BlockServed: loadNotices called, wallet:', currentWallet);
            if (!currentWallet) {
                console.log('BlockServed: No wallet connected, skipping load');
                return;
            }

            // Show loading state
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('noticesContainer').innerHTML = '';

            try {
                const timezone = getUserTimezone();
                const url = `${BACKEND_URL}/api/recipient-cases/wallet/${currentWallet}`;
                console.log('BlockServed: Fetching from:', url);
                const response = await fetch(url, {
                    headers: {
                        'X-Timezone': timezone || ''
                    }
                });
                console.log('BlockServed: Response status:', response.status);
                
                if (!response.ok) {
                    console.error('BlockServed: Response not OK:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('BlockServed: Error response:', errorText);
                }
                
                const data = await response.json();
                console.log('BlockServed: Response data:', data);
                
                document.getElementById('loadingState').style.display = 'none';
                
                if (data.success && data.notices && data.notices.length > 0) {
                    console.log('BlockServed: Found', data.notices.length, 'notices');
                    displayNotices(data.notices);
                    document.getElementById('noticeCount').textContent = data.notices.length;
                } else {
                    console.log('BlockServed: No notices found for wallet');
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('noticeCount').textContent = '0';
                }
            } catch (error) {
                console.error('BlockServed: Error loading notices:', error);
                console.error('BlockServed: Error details:', error.message);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                showAlert('Failed to load notices. Please try again.', 'error');
            }
        }

        // Display notices
        function displayNotices(notices) {
            const container = document.getElementById('noticesContainer');
            container.innerHTML = '';
            
            notices.forEach(notice => {
                const urgencyClass = notice.notice_type?.includes('Urgent') ? 'urgent' : 
                                   notice.notice_type?.includes('Important') ? 'important' : 'standard';
                
                const noticeCard = document.createElement('div');
                noticeCard.className = `notice-card ${urgencyClass}`;
                noticeCard.innerHTML = `
                    <div class="notice-header">
                        <div class="notice-title">
                            <h4>Case #${notice.case_number}</h4>
                            <p>${notice.notice_type || 'Legal Notice'} - ${notice.issuing_agency || 'Legal Services'}</p>
                        </div>
                        <div class="notice-status">
                            <span class="status-badge status-delivered">Delivered</span>
                            ${notice.accepted ? '<span class="status-badge status-signed">Signed</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="notice-details">
                        <div class="detail-item">
                            <i class="bi bi-calendar3"></i>
                            <strong>Served:</strong>
                            <span>${new Date(notice.served_at || notice.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-hash"></i>
                            <strong>Alert NFT:</strong>
                            <span>#${notice.alert_token_id}</span>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-file-text"></i>
                            <strong>Pages:</strong>
                            <span>${notice.page_count || 1}</span>
                        </div>
                        <div class="detail-item">
                            <i class="bi bi-link-45deg"></i>
                            <strong>Blockchain:</strong>
                            <span>TRON</span>
                        </div>
                    </div>
                    
                    <div class="notice-actions">
                        <button class="btn-view" onclick='viewDocument(${JSON.stringify(notice)})'>
                            <i class="bi bi-eye"></i> View Document
                        </button>
                        ${!notice.accepted ? `
                            <button class="btn-sign" onclick='signNotice(${JSON.stringify(notice)})'>
                                <i class="bi bi-pen"></i> Sign & Acknowledge
                            </button>
                        ` : `
                            <button class="btn-sign" disabled>
                                <i class="bi bi-check"></i> Already Signed
                            </button>
                        `}
                    </div>
                `;
                
                container.appendChild(noticeCard);
            });
        }

        // View document
        async function viewDocument(notice) {
            currentNotice = notice;
            
            // Show modal
            document.getElementById('documentModal').classList.add('active');
            document.getElementById('modalTitle').textContent = `Legal Document - Case #${notice.case_number}`;
            
            // Load document
            document.getElementById('modalBody').innerHTML = `
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading document...</p>
                </div>
            `;
            
            try {
                // Fetch document details with timezone for forensic tracking
                const timezone = getUserTimezone();
                const response = await fetch(
                    `${BACKEND_URL}/api/recipient-cases/${notice.case_number}/document?recipientAddress=${currentWallet}`,
                    {
                        headers: {
                            'X-Timezone': timezone || ''
                        }
                    }
                );
                const data = await response.json();

                if (data.success && data.notice) {
                    displayDocumentContent(data.notice);
                }
            } catch (error) {
                console.error('Error loading document:', error);
                document.getElementById('modalBody').innerHTML = `
                    <div class="alert-message alert-error">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        Failed to load document. Please try again.
                    </div>
                `;
            }
        }

        // Display document content
        function displayDocumentContent(notice) {
            const modalBody = document.getElementById('modalBody');
            
            // If there's an IPFS hash and encryption key, show encrypted document notice
            if (notice.ipfsHash && notice.encryptionKey) {
                modalBody.innerHTML = `
                    <div class="alert-message alert-info">
                        <i class="bi bi-lock-fill"></i>
                        <div>
                            <strong>Encrypted Document Available</strong><br>
                            This document is stored securely on IPFS. Use the decryption key provided to view the full document.
                        </div>
                    </div>
                    
                    <div class="document-info">
                        <h4>Document Information</h4>
                        <p><strong>IPFS Hash:</strong> <code>${notice.ipfsHash}</code></p>
                        <p><strong>Encryption Key:</strong> <code>${notice.encryptionKey}</code></p>
                        <p><strong>Page Count:</strong> ${notice.pageCount} pages</p>
                    </div>
                    
                    ${notice.documentPreview ? `
                        <div class="document-preview">
                            <h4>Document Preview</h4>
                            <img src="${notice.documentPreview}" style="max-width: 100%; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                    ` : ''}
                `;
            } else {
                // No IPFS data, but PDF may be available on backend
                modalBody.innerHTML = `
                    <div class="document-info" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4>Legal Notice - Case #${notice.case_number}</h4>
                        <p><strong>Alert NFT:</strong> #${notice.alert_token_id || 'N/A'}</p>
                        <p><strong>Document NFT:</strong> #${notice.document_token_id || 'Pending'}</p>
                        <p><strong>Served:</strong> ${new Date(notice.served_at).toLocaleString()}</p>
                        <p><strong>Status:</strong> ${notice.status || 'Served'}</p>
                    </div>
                    <div style="text-align: center; margin: 20px 0;">
                        <button onclick="downloadCasePDF('${notice.case_number}')" class="btn btn-primary" style="padding: 12px 24px;">
                            <i class="bi bi-file-earmark-pdf"></i> View/Download Legal Document
                        </button>
                    </div>
                `;
            }
            
            // Update sign button state
            const signButton = document.getElementById('signButton');
            if (notice.alreadySigned) {
                signButton.disabled = true;
                signButton.innerHTML = '<i class="bi bi-check"></i> Already Signed';
            }
        }

        // Sign notice
        async function signNotice(notice) {
            if (!currentWallet) {
                showAlert('Please connect your wallet first', 'error');
                return;
            }
            
            try {
                // Create signature message
                const message = `I acknowledge receipt of legal notice for Case #${notice.case_number} served on ${new Date(notice.served_at).toISOString()}`;
                
                // Sign with TronLink
                const signature = await tronWeb.trx.sign(tronWeb.toHex(message));
                
                // Send to backend
                const timezone = getUserTimezone();
                const response = await fetch(`${BACKEND_URL}/api/recipient-cases/${notice.case_number}/acknowledge`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Timezone': timezone || ''
                    },
                    body: JSON.stringify({
                        wallet: currentWallet,
                        signature: signature,
                        timestamp: new Date().toISOString()
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Document signed successfully!', 'success');
                    // Reload notices to update status
                    loadNotices();
                    closeDocumentModal();
                } else {
                    showAlert('Failed to sign document. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error signing document:', error);
                showAlert('Failed to sign document. Please try again.', 'error');
            }
        }

        // Close document modal
        function closeDocumentModal() {
            document.getElementById('documentModal').classList.remove('active');
            currentNotice = null;
        }

        // Download document
        function downloadDocument() {
            if (!currentNotice) return;
            
            // Create a text file with document information
            const content = `
Legal Notice - Case #${currentNotice.case_number}
========================================
Notice Type: ${currentNotice.notice_type}
Issuing Agency: ${currentNotice.issuing_agency}
Served Date: ${new Date(currentNotice.served_at).toLocaleDateString()}
Alert NFT ID: #${currentNotice.alert_token_id}
Document NFT ID: #${currentNotice.document_token_id || 'N/A'}

IPFS Document Hash: ${currentNotice.ipfs_document || 'N/A'}
Encryption Key: ${currentNotice.encryption_key || 'N/A'}

To view the full document, use the IPFS hash and encryption key provided above.

This notice was served via blockchain technology and is legally binding.
Transaction Hash: ${currentNotice.transaction_hash}
            `;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `legal_notice_${currentNotice.case_number}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Show alert message
        // Download PDF by case number from backend
        async function downloadCasePDF(caseNumber) {
            try {
                showAlert('Downloading document...', 'info');

                const timezone = getUserTimezone();
                const response = await fetch(
                    `${BACKEND_URL}/api/recipient-cases/${encodeURIComponent(caseNumber)}/download-pdf?recipientAddress=${currentWallet}`,
                    {
                        headers: {
                            'X-Timezone': timezone || ''
                        }
                    }
                );

                if (response.ok) {
                    const contentType = response.headers.get('content-type');

                    if (contentType && contentType.includes('application/pdf')) {
                        const blob = await response.blob();
                        const downloadUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = `legal_document_case_${caseNumber}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(downloadUrl);
                        showAlert('Document downloaded successfully', 'success');
                        return;
                    }
                }

                // If download failed, try opening in new tab
                const pdfUrl = `${BACKEND_URL}/api/recipient-cases/${encodeURIComponent(caseNumber)}/download-pdf?recipientAddress=${currentWallet}`;
                window.open(pdfUrl, '_blank');

            } catch (error) {
                console.error('Error downloading PDF:', error);
                showAlert('Failed to download document. Please try again.', 'error');
            }
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-message alert-${type}`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '80px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '10000';
            alertDiv.style.maxWidth = '400px';
            
            const icon = type === 'success' ? 'check-circle-fill' : 
                        type === 'error' ? 'exclamation-triangle-fill' : 'info-circle-fill';
            
            alertDiv.innerHTML = `
                <i class="bi bi-${icon}"></i>
                <div>${message}</div>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>