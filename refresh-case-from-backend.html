<!DOCTYPE html>
<html>
<head>
    <title>Refresh Case from Backend</title>
    <script>
        async function refreshCaseFromBackend() {
            const caseNumber = '4343902';
            const backendUrl = 'https://nftserviceapp.onrender.com';
            
            try {
                console.log('Fetching case from backend...');
                
                // Get case from backend
                const response = await fetch(`${backendUrl}/api/cases/${caseNumber}`, {
                    headers: {
                        'X-Server-Address': 'TGdD34RR3rZfUozoQLze9d4tzFbigL4JAY'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Backend response:', data);
                    
                    if (data.case) {
                        // Update local storage with backend data
                        const cases = JSON.parse(localStorage.getItem('legalnotice_cases') || '[]');
                        const caseIndex = cases.findIndex(c => 
                            c.caseNumber === caseNumber || 
                            c.caseNumber === '34-4343902' ||
                            c.case_number === caseNumber
                        );
                        
                        if (caseIndex >= 0) {
                            // Check if backend has transaction hash
                            const txHash = data.case.transaction_hash || data.case.transactionHash || data.case.tx_hash;
                            
                            if (!txHash) {
                                // If no tx hash in backend, ask user
                                const userTx = prompt('Backend has no transaction hash. Enter it manually (or cancel to skip):');
                                if (userTx && userTx.length === 64) {
                                    data.case.transactionHash = userTx;
                                }
                            }
                            
                            // Merge backend data with local - ensure all required fields for receipts
                            cases[caseIndex] = {
                                ...cases[caseIndex],
                                ...data.case,
                                pageCount: data.case.page_count || 46,
                                status: 'served', // Force to served so buttons appear
                                alertImage: data.case.alert_preview,
                                alertPreview: data.case.alert_preview, // Both names for compatibility
                                documentPreview: data.case.document_preview,
                                transactionHash: txHash || data.case.transactionHash || prompt('Enter transaction hash for receipts:'),
                                alertTokenId: data.case.alert_token_id || prompt('Enter Alert NFT Token ID (e.g., 31):'),
                                documentTokenId: data.case.document_token_id || prompt('Enter Document NFT Token ID (e.g., 32):'),
                                // Add receipt-required fields
                                servedAt: data.case.served_at || new Date().toISOString(),
                                serverAddress: data.case.server_address || 'TGdD34RR3rZfUozoQLze9d4tzFbigL4JAY',
                                recipients: data.case.recipients || [
                                    'TD1F37V4cAFH1YQCYVLtcFyFXkZUs7mBDE',
                                    'TAr8S97Xw3xhrGkZSghXQ85SFuP5XDU4cF', 
                                    'TBrjqKepMQKeZWjebMip2bH5872fiD3F6Q',
                                    'TFfagVe1aZpSfYaruY6xJfVPYZBuMj57FH'
                                ],
                                agency: data.case.agency || 'The Block Audit',
                                noticeType: data.case.notice_type || 'Legal Notice',
                                ipfsDocument: data.case.ipfs_hash || 'QmQg8cAaMxBfj1dFaKLWnEdPix6qButoBWwhYfPygxy7y2',
                                metadata: {
                                    ...cases[caseIndex].metadata,
                                    issuingAgency: data.case.agency || 'The Block Audit',
                                    noticeType: data.case.notice_type || 'Legal Notice',
                                    ipfsHash: data.case.ipfs_hash || 'QmQg8cAaMxBfj1dFaKLWnEdPix6qButoBWwhYfPygxy7y2'
                                }
                            };
                            
                            localStorage.setItem('legalnotice_cases', JSON.stringify(cases));
                            alert('Case refreshed from backend! Reload the Cases page to see updates.');
                            
                            document.getElementById('output').innerHTML = `
                                <h3>Updated Case Data:</h3>
                                <pre>${JSON.stringify(cases[caseIndex], null, 2)}</pre>
                            `;
                        } else {
                            alert('Case not found in local storage');
                        }
                    }
                } else {
                    alert('Backend returned: ' + response.status);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to fetch from backend: ' + error.message);
            }
        }
    </script>
</head>
<body>
    <h1>Refresh Case from Backend</h1>
    <button onclick="refreshCaseFromBackend()">Fetch Case 4343902 from Backend</button>
    <div id="output"></div>
</body>
</html>