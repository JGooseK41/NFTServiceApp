<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Notice Service - BlockServed</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            max-width: 900px;
            width: 90%;
            padding: 0;
            overflow: hidden;
        }
        
        .header-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header-banner h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .header-banner p {
            font-size: 1.1rem;
            opacity: 0.95;
        }
        
        .content-section {
            padding: 40px;
        }
        
        .notice-alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .notice-alert h3 {
            color: #856404;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .notice-alert p {
            color: #856404;
            margin-bottom: 0;
        }
        
        .step-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }
        
        .step-card.active {
            background: #e7f3ff;
            border-color: #0066cc;
        }
        
        .step-card.completed {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .step-number {
            display: inline-block;
            width: 35px;
            height: 35px;
            background: #6c757d;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 35px;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .step-card.active .step-number {
            background: #0066cc;
        }
        
        .step-card.completed .step-number {
            background: #28a745;
        }
        
        .wallet-info {
            background: #e7f3ff;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }
        
        .wallet-info.show {
            display: block;
        }
        
        .document-viewer {
            display: none;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .document-viewer.show {
            display: block;
        }
        
        .document-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .pdf-container {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            height: 600px;
            overflow: auto;
        }
        
        .receipt-section {
            display: none;
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .receipt-section.show {
            display: block;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading-spinner.show {
            display: block;
        }
        
        .audit-info {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .error-message {
            display: none;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .error-message.show {
            display: block;
        }
        
        @media print {
            body {
                background: white;
            }
            .main-container {
                box-shadow: none;
                max-width: 100%;
            }
            .header-banner, .document-controls, .step-card {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header-banner">
            <h1><i class="bi bi-shield-check"></i> BlockServed</h1>
            <p>Legal Notice Delivery Service</p>
        </div>
        
        <!-- Content -->
        <div class="content-section">
            <!-- Notice Alert -->
            <div class="notice-alert">
                <h3><i class="bi bi-exclamation-triangle-fill"></i> You Have Received a Legal Notice</h3>
                <p>
                    You have been served with an official legal notice via blockchain technology. 
                    To view and download your notice, please follow the steps below. 
                    This process creates a verifiable record of service.
                </p>
            </div>
            
            <!-- Error Message -->
            <div id="errorMessage" class="error-message"></div>
            
            <!-- Step 1: Connect Wallet -->
            <div id="step1" class="step-card active">
                <h4>
                    <span class="step-number">1</span>
                    Connect Your Wallet
                </h4>
                <p>Connect the TRON wallet that received the notice to proceed.</p>
                <button id="connectWalletBtn" class="btn btn-primary" onclick="recipientApp.connectWallet()">
                    <i class="bi bi-wallet2"></i> Connect TronLink Wallet
                </button>
                <div id="walletInfo" class="wallet-info">
                    <strong>Connected:</strong> <span id="walletAddress"></span>
                </div>
            </div>
            
            <!-- Step 2: Verify Notice -->
            <div id="step2" class="step-card">
                <h4>
                    <span class="step-number">2</span>
                    Verify Your Notice
                </h4>
                <p>We'll check for legal notices sent to your wallet address.</p>
                <button id="verifyBtn" class="btn btn-primary" disabled onclick="recipientApp.verifyNotice()">
                    <i class="bi bi-search"></i> Check for Notices
                </button>
                <div id="noticesList" style="display:none; margin-top: 15px;">
                    <!-- Notices will be listed here -->
                </div>
            </div>
            
            <!-- Step 3: Sign for Receipt -->
            <div id="step3" class="step-card">
                <h4>
                    <span class="step-number">3</span>
                    Sign for Receipt
                </h4>
                <p>Sign a transaction to acknowledge receipt and receive your decryption key.</p>
                <button id="signBtn" class="btn btn-primary" disabled onclick="recipientApp.signForNotice()">
                    <i class="bi bi-pen"></i> Sign for Notice
                </button>
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <p class="mt-2">Processing your signature...</p>
                </div>
            </div>
            
            <!-- Document Viewer -->
            <div id="documentViewer" class="document-viewer">
                <h4><i class="bi bi-file-text"></i> Your Legal Notice</h4>
                <div class="document-controls">
                    <button class="btn btn-primary" onclick="recipientApp.printDocument()">
                        <i class="bi bi-printer"></i> Print
                    </button>
                    <button class="btn btn-success" onclick="recipientApp.downloadDocument()">
                        <i class="bi bi-download"></i> Download PDF
                    </button>
                    <button class="btn btn-info" onclick="recipientApp.downloadReceipt()">
                        <i class="bi bi-receipt"></i> Download Receipt
                    </button>
                </div>
                <div id="pdfContainer" class="pdf-container">
                    <!-- PDF will be displayed here -->
                </div>
            </div>
            
            <!-- Service Receipt -->
            <div id="receiptSection" class="receipt-section">
                <h4><i class="bi bi-check-circle-fill"></i> Service Receipt</h4>
                <div id="receiptContent">
                    <!-- Receipt details will be populated here -->
                </div>
                <div class="audit-info">
                    <strong>Audit Trail:</strong><br>
                    <span id="auditDetails"></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // PDF.js configuration
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Mobile detection and redirect
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // Check if mobile and redirect
        if (isMobile() && !sessionStorage.getItem('stayOnDesktop')) {
            window.location.href = '/recipient-mobile.html' + window.location.search;
        }
        
        // Recipient App
        const recipientApp = {
            wallet: null,
            notices: [],
            currentNotice: null,
            decryptionKey: null,
            auditData: {},
            
            async init() {
                console.log('Initializing recipient app...');
                
                // Collect audit data
                await this.collectAuditData();
                
                // Check URL parameters for direct notice links
                const params = new URLSearchParams(window.location.search);
                const noticeId = params.get('notice');
                const caseNumber = params.get('case');
                
                if (noticeId || caseNumber) {
                    this.currentNotice = { noticeId, caseNumber };
                    console.log('Direct notice link detected:', this.currentNotice);
                }
                
                // Auto-connect wallet if available
                if (window.tronLink && window.tronLink.ready) {
                    setTimeout(() => this.connectWallet(), 1000);
                }
            },
            
            async collectAuditData() {
                try {
                    // Get IP and location data
                    const response = await fetch('https://ipapi.co/json/');
                    const geoData = await response.json();
                    
                    this.auditData = {
                        ip: geoData.ip || 'Unknown',
                        city: geoData.city || 'Unknown',
                        region: geoData.region || 'Unknown',
                        country: geoData.country_name || 'Unknown',
                        countryCode: geoData.country || 'Unknown',
                        postal: geoData.postal || 'Unknown',
                        latitude: geoData.latitude || 0,
                        longitude: geoData.longitude || 0,
                        timezone: geoData.timezone || 'Unknown',
                        isp: geoData.org || 'Unknown',
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        language: navigator.language,
                        platform: navigator.platform,
                        screenResolution: `${screen.width}x${screen.height}`,
                        referrer: document.referrer || 'Direct'
                    };
                    
                    console.log('Audit data collected:', this.auditData);
                    
                } catch (error) {
                    console.error('Failed to collect geo data:', error);
                    this.auditData = {
                        ip: 'Unknown',
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        error: 'Failed to collect location data'
                    };
                }
            },
            
            async connectWallet() {
                try {
                    if (!window.tronLink) {
                        throw new Error('TronLink wallet not found. Please install TronLink extension.');
                    }
                    
                    if (!window.tronLink.ready) {
                        const result = await window.tronLink.request({ method: 'tron_requestAccounts' });
                        if (result.code === 200) {
                            console.log('Wallet connected');
                        }
                    }
                    
                    // Wait for tronWeb to be injected
                    let attempts = 0;
                    while (!window.tronWeb && attempts < 10) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                    
                    if (!window.tronWeb || !window.tronWeb.defaultAddress.base58) {
                        throw new Error('Please unlock your TronLink wallet');
                    }
                    
                    this.wallet = window.tronWeb.defaultAddress.base58;
                    
                    // Update UI
                    document.getElementById('walletAddress').textContent = 
                        this.wallet.substring(0, 6) + '...' + this.wallet.substring(this.wallet.length - 4);
                    document.getElementById('walletInfo').classList.add('show');
                    document.getElementById('step1').classList.remove('active');
                    document.getElementById('step1').classList.add('completed');
                    document.getElementById('step2').classList.add('active');
                    document.getElementById('verifyBtn').disabled = false;
                    
                    // Auto-proceed to verification
                    setTimeout(() => this.verifyNotice(), 500);
                    
                } catch (error) {
                    this.showError(error.message);
                }
            },
            
            async verifyNotice() {
                try {
                    document.getElementById('verifyBtn').disabled = true;
                    document.getElementById('verifyBtn').innerHTML = '<span class="spinner-border spinner-border-sm"></span> Checking...';
                    
                    // Call backend to get notices for this recipient
                    const backendUrl = 'https://nftserviceapp.onrender.com';
                    const response = await fetch(`${backendUrl}/api/notices/recipient/${this.wallet}`, {
                        headers: {
                            'X-Recipient-Address': this.wallet
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to fetch notices');
                    }
                    
                    const data = await response.json();
                    this.notices = data.notices || [];
                    
                    if (this.notices.length === 0) {
                        throw new Error('No legal notices found for your wallet address');
                    }
                    
                    // Display notices
                    const noticesList = document.getElementById('noticesList');
                    noticesList.innerHTML = `
                        <div class="alert alert-info">
                            <strong>Found ${this.notices.length} notice(s):</strong>
                        </div>
                        ${this.notices.map((notice, idx) => `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h6>Case #${notice.case_number || 'Unknown'}</h6>
                                    <p class="mb-1"><small>Type: ${notice.notice_type || 'Legal Notice'}</small></p>
                                    <p class="mb-1"><small>From: ${notice.issuing_agency || 'Legal Services'}</small></p>
                                    <p class="mb-1"><small>Date: ${new Date(notice.created_at).toLocaleDateString()}</small></p>
                                    ${this.notices.length > 1 ? `
                                        <button class="btn btn-sm btn-primary mt-2" onclick="recipientApp.selectNotice(${idx})">
                                            Select This Notice
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    `;
                    noticesList.style.display = 'block';
                    
                    // If only one notice, auto-select it
                    if (this.notices.length === 1) {
                        this.selectNotice(0);
                    }
                    
                    // Update UI
                    document.getElementById('step2').classList.remove('active');
                    document.getElementById('step2').classList.add('completed');
                    document.getElementById('verifyBtn').innerHTML = '<i class="bi bi-check"></i> Notices Found';
                    
                } catch (error) {
                    this.showError(error.message);
                    document.getElementById('verifyBtn').disabled = false;
                    document.getElementById('verifyBtn').innerHTML = '<i class="bi bi-search"></i> Check for Notices';
                }
            },
            
            selectNotice(index) {
                this.currentNotice = this.notices[index];
                console.log('Selected notice:', this.currentNotice);
                
                // Update UI
                document.getElementById('step3').classList.add('active');
                document.getElementById('signBtn').disabled = false;
                
                // Auto-proceed to signing
                setTimeout(() => this.signForNotice(), 500);
            },
            
            async signForNotice() {
                try {
                    if (!this.currentNotice) {
                        throw new Error('No notice selected');
                    }
                    
                    // Show loading
                    document.getElementById('signBtn').style.display = 'none';
                    document.querySelector('.loading-spinner').classList.add('show');
                    
                    // Prepare signature data including audit trail
                    const signatureData = {
                        noticeId: this.currentNotice.notice_id,
                        documentId: this.currentNotice.document_id,
                        caseNumber: this.currentNotice.case_number,
                        recipient: this.wallet,
                        timestamp: Date.now(),
                        auditTrail: this.auditData
                    };
                    
                    // Call smart contract to sign for the document
                    const contractAddress = 'TLhYHQatauDtZ4iNCePU26WbVjsXtMPdoN'; // V5 contract
                    const contract = await window.tronWeb.contract().at(contractAddress);
                    
                    // Sign the document NFT
                    const tx = await contract.signDocument(
                        this.currentNotice.document_id || this.currentNotice.notice_id
                    ).send({
                        feeLimit: 100000000,
                        callValue: 0
                    });
                    
                    console.log('Signature transaction:', tx);
                    
                    // Send audit trail to backend
                    const backendUrl = 'https://nftserviceapp.onrender.com';
                    const auditResponse = await fetch(`${backendUrl}/api/notices/audit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Recipient-Address': this.wallet
                        },
                        body: JSON.stringify({
                            ...signatureData,
                            txId: tx,
                            signedAt: new Date().toISOString()
                        })
                    });
                    
                    const auditResult = await auditResponse.json();
                    
                    // Get decryption key from backend
                    const keyResponse = await fetch(`${backendUrl}/api/notices/${this.currentNotice.notice_id}/decrypt`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Recipient-Address': this.wallet
                        },
                        body: JSON.stringify({
                            txId: tx,
                            signature: signatureData
                        })
                    });
                    
                    const keyData = await keyResponse.json();
                    this.decryptionKey = keyData.decryptionKey;
                    
                    // Load and display document
                    await this.loadDocument();
                    
                    // Generate receipt
                    this.generateReceipt(tx, auditResult);
                    
                    // Update UI
                    document.querySelector('.loading-spinner').classList.remove('show');
                    document.getElementById('step3').classList.remove('active');
                    document.getElementById('step3').classList.add('completed');
                    document.getElementById('signBtn').innerHTML = '<i class="bi bi-check"></i> Signed Successfully';
                    
                } catch (error) {
                    this.showError('Failed to sign for notice: ' + error.message);
                    document.querySelector('.loading-spinner').classList.remove('show');
                    document.getElementById('signBtn').style.display = 'block';
                }
            },
            
            async loadDocument() {
                try {
                    const backendUrl = 'https://nftserviceapp.onrender.com';
                    
                    // Fetch the document
                    const response = await fetch(`${backendUrl}/api/notices/${this.currentNotice.notice_id}/document`, {
                        headers: {
                            'X-Recipient-Address': this.wallet,
                            'X-Decryption-Key': this.decryptionKey
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to load document');
                    }
                    
                    const pdfBlob = await response.blob();
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    
                    // Display PDF
                    const container = document.getElementById('pdfContainer');
                    container.innerHTML = `<iframe src="${pdfUrl}" width="100%" height="100%" frameborder="0"></iframe>`;
                    
                    // Store for download
                    this.documentBlob = pdfBlob;
                    this.documentUrl = pdfUrl;
                    
                    // Show document viewer
                    document.getElementById('documentViewer').classList.add('show');
                    
                } catch (error) {
                    this.showError('Failed to load document: ' + error.message);
                }
            },
            
            generateReceipt(txId, auditResult) {
                const receipt = {
                    receiptId: `RCPT-${Date.now()}`,
                    caseNumber: this.currentNotice.case_number,
                    recipientAddress: this.wallet,
                    signedAt: new Date().toISOString(),
                    txId: txId,
                    decryptionKey: this.decryptionKey,
                    auditTrail: this.auditData,
                    serverAcknowledgment: auditResult.acknowledgment || 'Confirmed'
                };
                
                // Display receipt
                document.getElementById('receiptContent').innerHTML = `
                    <div class="mb-3">
                        <strong>Receipt ID:</strong> ${receipt.receiptId}<br>
                        <strong>Case Number:</strong> ${receipt.caseNumber}<br>
                        <strong>Recipient:</strong> ${receipt.recipientAddress}<br>
                        <strong>Signed At:</strong> ${new Date(receipt.signedAt).toLocaleString()}<br>
                        <strong>Transaction ID:</strong> <small>${receipt.txId}</small><br>
                        <strong>Decryption Key:</strong> <code>${receipt.decryptionKey}</code>
                    </div>
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle-fill"></i> 
                        You have successfully signed for and received this legal notice.
                        This receipt serves as proof of service.
                    </div>
                `;
                
                // Display audit trail
                document.getElementById('auditDetails').innerHTML = `
                    IP Address: ${this.auditData.ip}<br>
                    Location: ${this.auditData.city}, ${this.auditData.region}, ${this.auditData.country}<br>
                    Timestamp: ${this.auditData.timestamp}<br>
                    Platform: ${this.auditData.platform}
                `;
                
                // Show receipt section
                document.getElementById('receiptSection').classList.add('show');
                
                // Store receipt
                this.receipt = receipt;
            },
            
            printDocument() {
                window.print();
            },
            
            downloadDocument() {
                if (!this.documentBlob) return;
                
                const link = document.createElement('a');
                link.href = this.documentUrl;
                link.download = `Legal_Notice_${this.currentNotice.case_number}.pdf`;
                link.click();
            },
            
            downloadReceipt() {
                if (!this.receipt) return;
                
                const receiptText = JSON.stringify(this.receipt, null, 2);
                const blob = new Blob([receiptText], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `Receipt_${this.receipt.receiptId}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
            },
            
            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.classList.add('show');
                
                setTimeout(() => {
                    errorDiv.classList.remove('show');
                }, 5000);
            }
        };
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            recipientApp.init();
        });
    </script>
</body>
</html>