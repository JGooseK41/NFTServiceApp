<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Case Management System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #e74c3c;
            padding-bottom: 10px;
        }
        .button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #c0392b;
        }
        .button.secondary {
            background: #3498db;
        }
        .button.secondary:hover {
            background: #2980b9;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .case-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        .case-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .case-item:hover {
            background: #f9f9f9;
        }
        .case-item:last-child {
            border-bottom: none;
        }
        .preview-container {
            max-width: 100%;
            margin: 20px 0;
            text-align: center;
        }
        .preview-container img {
            max-width: 100%;
            border: 2px solid #e74c3c;
            border-radius: 8px;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-card h3 {
            margin: 0;
            color: #e74c3c;
            font-size: 24px;
        }
        .stat-card p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>🧪 Case Management System Test</h1>

    <div class="container">
        <h2>Connection Status</h2>
        <button class="button secondary" onclick="testConnection()">Test Backend Connection</button>
        <div id="connectionStatus"></div>
    </div>

    <div class="container">
        <h2>1. Create New Case</h2>
        <p>Upload multiple PDFs to create a combined case document:</p>
        <input type="file" id="caseFiles" multiple accept=".pdf" />
        <br>
        <input type="text" id="caseDescription" placeholder="Case description..." style="width: 300px; padding: 8px; margin: 10px 0;">
        <br>
        <button class="button" onclick="createCase()">Create Case</button>
        <div id="createStatus"></div>
        <div id="alertPreview" class="preview-container"></div>
    </div>

    <div class="container">
        <h2>2. List Cases</h2>
        <button class="button secondary" onclick="listCases()">Refresh Case List</button>
        <div id="caseList" class="case-list">
            <p style="color: #999;">No cases loaded yet...</p>
        </div>
    </div>

    <div class="container">
        <h2>3. Storage Statistics</h2>
        <button class="button secondary" onclick="getStorageStats()">Get Storage Stats</button>
        <div id="storageStats" class="stats"></div>
    </div>

    <div class="container">
        <h2>4. Test Case Operations</h2>
        <p>Current Case ID: <span id="currentCaseId" style="font-weight: bold;">None</span></p>
        <button class="button" onclick="viewCurrentPDF()">View PDF</button>
        <button class="button secondary" onclick="prepareForServing()">Prepare for Serving</button>
        <button class="button" onclick="serveToTestAddress()">Serve to Test Address</button>
        <div id="operationStatus"></div>
    </div>

    <script src="js/case-management-client.js"></script>
    <script>
        let currentCaseId = null;
        // Use your Render backend URL
        const BACKEND_API_URL = 'https://nftserviceapp.onrender.com';

        // Initialize
        async function init() {
            console.log('Initializing test page...');
            
            // Set backend URL
            window.BACKEND_API_URL = BACKEND_API_URL;
            
            // Initialize case manager
            if (!window.caseManager) {
                window.caseManager = new CaseManagementClient();
            }
            
            // Set a test server address if TronWeb isn't available
            if (!window.tronWeb || !window.tronWeb.defaultAddress) {
                window.caseManager.serverAddress = 'TEST-SERVER-' + Date.now();
            }
            
            await window.caseManager.init();
            
            showStatus('createStatus', 'info', 'Case Management System initialized');
            
            // Load initial case list
            await listCases();
        }

        // Show status message
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `status ${type}`;
                element.textContent = message;
                
                // Auto-hide success messages
                if (type === 'success') {
                    setTimeout(() => {
                        element.style.display = 'none';
                    }, 5000);
                } else {
                    element.style.display = 'block';
                }
            }
        }

        // Create case
        async function createCase() {
            const fileInput = document.getElementById('caseFiles');
            const description = document.getElementById('caseDescription').value;
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showStatus('createStatus', 'error', 'Please select at least one PDF file');
                return;
            }
            
            showStatus('createStatus', 'info', `Creating case with ${fileInput.files.length} files...`);
            
            try {
                const result = await window.caseManager.createCase(
                    Array.from(fileInput.files),
                    {
                        description: description || 'Test case created ' + new Date().toLocaleString(),
                        caseType: 'test',
                        urgency: 'normal'
                    }
                );
                
                if (result.success) {
                    currentCaseId = result.caseId;
                    document.getElementById('currentCaseId').textContent = currentCaseId;
                    
                    showStatus('createStatus', 'success', 
                        `✅ Case created successfully! ID: ${currentCaseId}`);
                    
                    // Show alert preview if available
                    if (result.alertPreview) {
                        const preview = document.getElementById('alertPreview');
                        preview.innerHTML = `
                            <h3>Alert Preview (First Page with Overlay)</h3>
                            <img src="${result.alertPreview}" alt="Alert Preview">
                        `;
                    }
                    
                    // Clear inputs
                    fileInput.value = '';
                    document.getElementById('caseDescription').value = '';
                    
                    // Refresh case list
                    await listCases();
                } else {
                    showStatus('createStatus', 'error', `Failed: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Create case error:', error);
                showStatus('createStatus', 'error', `Error: ${error.message}`);
            }
        }

        // List cases
        async function listCases() {
            try {
                const cases = await window.caseManager.listCases();
                const listElement = document.getElementById('caseList');
                
                if (!cases || cases.length === 0) {
                    listElement.innerHTML = '<p style="color: #999;">No cases found</p>';
                    return;
                }
                
                listElement.innerHTML = cases.map(c => `
                    <div class="case-item" onclick="selectCase('${c.caseId}')">
                        <strong>${c.caseId}</strong><br>
                        <small>Status: ${c.status} | Created: ${new Date(c.createdAt).toLocaleString()}</small><br>
                        <small>${c.description || 'No description'}</small>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('List cases error:', error);
                document.getElementById('caseList').innerHTML = 
                    '<p style="color: red;">Error loading cases</p>';
            }
        }

        // Select case
        function selectCase(caseId) {
            currentCaseId = caseId;
            document.getElementById('currentCaseId').textContent = caseId;
            showStatus('operationStatus', 'info', `Selected case: ${caseId}`);
        }

        // View current PDF
        function viewCurrentPDF() {
            if (!currentCaseId) {
                showStatus('operationStatus', 'error', 'No case selected');
                return;
            }
            
            window.caseManager.viewCasePDF(currentCaseId);
        }

        // Prepare for serving
        async function prepareForServing() {
            if (!currentCaseId) {
                showStatus('operationStatus', 'error', 'No case selected');
                return;
            }
            
            showStatus('operationStatus', 'info', 'Preparing case for serving...');
            
            try {
                const result = await window.caseManager.prepareCaseForServing(
                    currentCaseId,
                    'TTestRecipientAddress123'
                );
                
                if (result.success) {
                    showStatus('operationStatus', 'success', 
                        `✅ Case prepared! IPFS: ${result.ipfsHash}`);
                } else {
                    showStatus('operationStatus', 'error', `Failed: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Prepare error:', error);
                showStatus('operationStatus', 'error', `Error: ${error.message}`);
            }
        }

        // Serve to test address
        async function serveToTestAddress() {
            if (!currentCaseId) {
                showStatus('operationStatus', 'error', 'No case selected');
                return;
            }
            
            showStatus('operationStatus', 'info', 'This would serve the notice via blockchain...');
            
            // In real usage, this would call:
            // await window.caseManager.serveNoticeWithCase(currentCaseId, recipientAddress);
            
            setTimeout(() => {
                showStatus('operationStatus', 'info', 
                    'Blockchain serving requires TronWeb connection');
            }, 1000);
        }

        // Get storage stats
        async function getStorageStats() {
            try {
                const stats = await window.caseManager.getStorageStats();
                const statsElement = document.getElementById('storageStats');
                
                if (stats) {
                    statsElement.innerHTML = `
                        <div class="stat-card">
                            <h3>${stats.totalCases || 0}</h3>
                            <p>Total Cases</p>
                        </div>
                        <div class="stat-card">
                            <h3>${stats.activeCases || 0}</h3>
                            <p>Active Cases</p>
                        </div>
                        <div class="stat-card">
                            <h3>${stats.archivedCases || 0}</h3>
                            <p>Archived Cases</p>
                        </div>
                        <div class="stat-card">
                            <h3>${stats.diskUsage?.percentUsed || 'N/A'}</h3>
                            <p>Disk Usage</p>
                        </div>
                    `;
                } else {
                    statsElement.innerHTML = '<p style="color: #999;">No stats available</p>';
                }
                
            } catch (error) {
                console.error('Storage stats error:', error);
                document.getElementById('storageStats').innerHTML = 
                    '<p style="color: red;">Error loading stats</p>';
            }
        }

        // Test backend connection
        async function testConnection() {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = 'status info';
            statusEl.textContent = 'Testing connection to ' + BACKEND_API_URL + '...';
            
            try {
                const response = await fetch(BACKEND_API_URL + '/api/health');
                if (response.ok) {
                    const data = await response.json();
                    statusEl.className = 'status success';
                    statusEl.textContent = '✅ Backend connected! ' + (data.message || '');
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = '❌ Backend responded with status: ' + response.status;
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '❌ Cannot connect to backend: ' + error.message;
                console.error('Connection test failed:', error);
            }
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>