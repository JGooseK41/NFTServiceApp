<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LegalNotice - Blockchain Legal Document Service</title>
    <meta name="description" content="Secure multi-chain blockchain legal document service supporting TRON, Ethereum, Polygon, and BSC">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pica/9.0.1/pica.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@4.3.0/dist/web3.min.js"></script>
    <script src="config.js"></script>
    <!-- Document conversion libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="js/documentConverter.js"></script>
    <!-- Simplified Encryption (no registration needed) -->
    <script src="js/simple-encryption.js"></script>
    <script src="js/simplified-integration.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-dark: #0a0a0a;
            --primary-navy: #111111;
            --secondary-navy: #1a1a1a;
            --accent-blue: #0ea5e9;
            --accent-light: #38bdf8;
            --text-primary: #ffffff;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --border-color: #262626;
            --card-bg: #141414;
            --hover-bg: #1f1f1f;
            --alert-color: #0ea5e9;
            --gray-800: #1f2937;
            --gray-700: #374151;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--primary-dark);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* Loader */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-navy) 0%, var(--secondary-navy) 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .logo:hover {
            transform: translateY(-1px);
        }

        .logo i {
            font-size: 2rem;
            color: var(--accent-blue);
            animation: pulse 2s infinite;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .contract-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.75rem;
            position: relative;
            overflow: hidden;
        }
        
        .contract-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(14, 165, 233, 0.2), transparent);
            animation: shimmer 3s infinite;
        }
        
        .contract-indicator span:first-child {
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .contract-indicator span:nth-child(2) {
            color: var(--accent-light);
            font-family: monospace;
        }
        
        .btn-icon {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
        }
        
        .btn-icon:hover {
            color: var(--accent-blue);
            background: rgba(14, 165, 233, 0.1);
        }
        
        .btn-icon-small {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.125rem 0.25rem;
            font-size: 0.875rem;
            transition: color 0.3s ease;
            margin-left: 0.25rem;
        }
        
        .btn-icon-small:hover {
            color: var(--accent-blue);
        }
        
        .address-display {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .address-text {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }

        .chain-selector {
            margin-right: 1rem;
        }

        .chain-dropdown {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chain-dropdown:hover {
            border-color: var(--accent-blue);
        }

        .chain-dropdown:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .chain-dropdown optgroup {
            background: var(--primary-navy);
            color: var(--text-secondary);
            font-weight: 600;
        }

        .chain-dropdown option {
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 0.5rem;
        }

        .network-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            color: var(--accent-light);
            font-size: 0.75rem;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .network-indicator.connected {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .network-indicator.connected i {
            color: var(--success);
        }

        .wallet-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .wallet-address {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .main-container {
            margin-top: 80px;
            padding: 2rem;
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
            animation: fadeIn 0.5s ease;
        }

        /* Welcome Section */
        .welcome-section {
            text-align: center;
            padding: 3rem 0;
            margin-bottom: 2rem;
            animation: slideIn 0.5s ease;
        }

        .welcome-section h2 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-section p {
            font-size: 1.125rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Stats Section */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stats-header:hover {
            background: rgba(255, 255, 255, 0.05) !important;
        }
        
        #walletStatusHeader:hover,
        #contractHeader:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        /* Make entire header clickable */
        #walletStatusHeader,
        #contractHeader,
        .stats-header {
            user-select: none;
            -webkit-user-select: none;
            position: relative;
        }
        
        /* Add active state for better feedback */
        #walletStatusHeader:active,
        #contractHeader:active,
        .stats-header:active {
            background: rgba(255, 255, 255, 0.08) !important;
        }
        
        #walletStatusHeader h2,
        #contractHeader h2,
        .stats-header h3 {
            pointer-events: none;
        }
        
        #walletToggleIcon,
        #contractToggleIcon,
        #statsToggleIcon {
            pointer-events: none;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-light));
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .stat-card:hover::before {
            transform: translateX(0);
        }

        .stat-card i {
            font-size: 2rem;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .tab-navigation {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            font-size: 0.938rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-button:hover {
            color: var(--text-primary);
        }

        .tab-button.active {
            color: var(--accent-blue);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-blue);
            animation: slideIn 0.3s ease;
        }

        .tab-button .badge {
            background: var(--accent-blue);
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            margin-left: 0.5rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(14, 165, 233, 0.1), transparent);
            transition: all 0.5s ease;
            transform: translate(-50%, -50%);
        }

        .card:hover::before {
            width: 100%;
            height: 100%;
        }

        .card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(14, 165, 233, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-header i {
            font-size: 1.25rem;
            color: var(--accent-blue);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1.5rem;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .action-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(14, 165, 233, 0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
            transform: rotate(45deg);
        }

        .action-card:hover::before {
            opacity: 1;
        }

        .action-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-blue);
            box-shadow: 0 12px 32px rgba(59, 130, 246, 0.2);
        }

        .action-card.primary {
            border-color: var(--accent-blue);
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(59, 130, 246, 0.1) 100%);
        }

        .action-card i {
            font-size: 3rem;
            color: var(--accent-blue);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .action-card:hover i {
            transform: scale(1.1);
        }

        .action-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .action-card p {
            color: var(--text-secondary);
            font-size: 0.938rem;
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-navy);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--hover-bg);
            border-color: var(--accent-blue);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--primary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.2s ease;
	    pointer-events: auto !important;
            user-select: text !important;
            -webkit-user-select: text !important;
        }
/* Specifically target admin panel inputs */
#adminTab .form-input {
    pointer-events: auto !important;
    user-select: text !important;
    -webkit-user-select: text !important;
    cursor: text !important;
}

/* Ensure inputs are not disabled by parent elements */
#adminContent * {
    pointer-events: auto !important;
}

/* Fix for any potential z-index issues */
#adminTab .card {
    position: relative;
    z-index: 1;
}

#adminTab .form-input {
    position: relative;
    z-index: 2;
}
        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            color: var(--text-primary);
        }

        /* Custom checkbox */
        input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background: var(--primary-dark);
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        input[type="checkbox"]:checked {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        input[type="checkbox"]:checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .status-complete {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }
        
        .status-badge.success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }
        
        .status-badge.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }
        
        .status-badge.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .token-list {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .token-item {
            padding: 1rem;
            background: var(--primary-dark);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .token-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
            animation: scan 3s infinite;
        }

        .token-item:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .token-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .token-details {
            display: grid;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .token-detail {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
        }

        .token-preview {
            margin-top: 1rem;
            text-align: center;
        }

        .token-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }

        .token-preview img:hover {
            transform: scale(1.05);
        }

        .notification-banner {
            background: rgba(14, 165, 233, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideIn 0.5s ease;
        }

        .notification-banner i {
            color: var(--accent-blue);
            font-size: 1.25rem;
            animation: pulse 2s infinite;
        }

        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .processing-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem 3rem;
            text-align: center;
            border: 1px solid var(--accent-blue);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        .processing-card i {
            font-size: 3rem;
            color: var(--accent-blue);
            margin-bottom: 1rem;
        }

        .processing-card h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .processing-card p {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: relative;
            max-width: 800px;
            margin: 5% auto;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            animation: slideIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            padding: 0.25rem;
            border-radius: 4px;
        }

        .modal-close:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .alert {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--error);
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: var(--accent-light);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--warning);
        }

        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            background: var(--primary-dark);
        }

        .upload-area:hover {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
        }

        .upload-area.active {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .upload-area.drag-over {
            border-color: var(--accent-blue);
            background: rgba(14, 165, 233, 0.05);
            transform: scale(1.02);
        }

        .upload-area.processing {
            pointer-events: none;
            opacity: 0.8;
        }

        .upload-area.error {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--accent-blue);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .upload-area:hover .upload-icon {
            transform: translateY(-5px);
        }

        .upload-area.drag-over .upload-icon {
            animation: bounce 1s infinite;
        }

        .upload-area input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .preview-container {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
        }

        .preview-image {
            flex: 0 0 200px;
            text-align: center;
        }

        .preview-image img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .preview-details {
            flex: 1;
        }

        .tx-details {
            background: var(--primary-dark);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid var(--border-color);
        }

        .tx-hash {
            font-family: 'Inter', monospace;
            font-size: 0.875rem;
            word-break: break-all;
            color: var(--accent-light);
            margin: 0.5rem 0;
            background: var(--hover-bg);
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }
        
        /* Enhanced transaction modal styles */
        #txModal .modal-content {
            max-width: 700px;
        }
        
        #txModal .token-details {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        #txModal .btn {
            min-width: 140px;
            justify-content: center;
        }
        
        #txModal img {
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        #txModal img:hover {
            transform: scale(1.02);
        }

        .server-id-display {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--primary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-weight: 600;
            color: var(--accent-blue);
            animation: slideIn 0.5s ease;
        }

        /* Enhanced form validation styles */
        .form-input.invalid {
            border-color: var(--error);
            animation: shake 0.3s ease;
        }

        .form-input.valid {
            border-color: var(--success);
        }

        .validation-message {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            animation: slideIn 0.3s ease;
        }

        .validation-message.error {
            color: var(--error);
        }

        .validation-message.warning {
            color: var(--warning);
        }

        .validation-message.success {
            color: var(--success);
        }

        /* Upload metadata */
        .upload-metadata {
            background: var(--primary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .upload-metadata h5 {
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
            font-size: 0.938rem;
        }

        .upload-metadata .metadata-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .upload-metadata .metadata-item strong {
            color: var(--text-primary);
        }

        /* Compression status */
        .compression-status {
            background: var(--primary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .compression-status.active {
            border-color: var(--accent-blue);
        }

        .compression-progress {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-blue);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.5);
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            min-width: 50px;
            text-align: right;
        }

        /* Notification system */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            min-width: 300px;
            max-width: 500px;
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 9999;
            transition: all 0.3s ease;
            transform: translateX(400px);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
        }

        .notification-enter {
            transform: translateX(400px);
        }

        .notification-active {
            transform: translateX(0);
        }

        .notification-exit {
            transform: translateX(400px);
            opacity: 0;
        }

        .notification-success {
            background: rgba(16, 185, 129, 0.9);
            color: white;
            border: 1px solid rgba(16, 185, 129, 1);
        }

        .notification-error {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: 1px solid rgba(239, 68, 68, 1);
        }

        .notification-warning {
            background: rgba(245, 158, 11, 0.9);
            color: white;
            border: 1px solid rgba(245, 158, 11, 1);
        }

        .notification-info {
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border: 1px solid rgba(59, 130, 246, 1);
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.25rem;
            margin-left: auto;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .notification-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Empty states */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.125rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        /* Delivery Options Styles */
        .delivery-options {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .delivery-option {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            background: var(--card-bg);
        }
        
        .delivery-option:hover {
            border-color: var(--accent-blue);
            background: var(--hover-bg);
        }
        
        .delivery-option.selected {
            border-color: var(--accent-blue);
            background: rgba(14, 165, 233, 0.1);
        }
        
        .delivery-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }
        
        .delivery-option-title {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .delivery-option-cost {
            color: var(--success);
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .delivery-option-desc {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        
        .text-notice-input {
            display: none;
            margin-top: 15px;
        }
        
        .text-notice-input.active {
            display: block;
        }
        
        .text-notice-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .text-notice-input input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 0.938rem;
            transition: all 0.2s ease;
        }

        .text-notice-input input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        .text-notice-input .char-count {
            text-align: right;
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .text-notice-input .char-count.warning {
            color: var(--warning);
        }

        .text-notice-input .char-count.error {
            color: var(--error);
        }

        /* Delivery Status Styles */
        .delivery-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .delivery-status.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .delivery-status.delivered {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .delivery-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .delivery-item:hover {
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }
        
        .delivery-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .delivery-item-id {
            font-family: monospace;
            color: var(--accent-blue);
            font-size: 0.875rem;
        }
        
        .delivery-item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            font-size: 0.875rem;
        }
        
        .delivery-detail {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .delivery-detail-label {
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        
        .delivery-detail-value {
            color: var(--text-primary);
        }
        
        .delivery-timeline {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .timeline-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }
        
        .timeline-icon.sent {
            background: var(--accent-blue);
            color: white;
        }
        
        .timeline-icon.delivered {
            background: var(--success);
            color: white;
        }
        
        .timeline-icon.pending {
            background: var(--gray-700);
            color: var(--text-muted);
        }
        
        /* FAQ Styles */
        .process-steps {
            margin: 20px 0;
        }
        
        .step {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .step-number {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            background: var(--accent-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-content strong {
            display: block;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-size: 1.1em;
        }
        
        .example-notice {
            background: var(--card-bg);
            border: 2px solid var(--accent-blue);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        .recipient-journey h5 {
            color: var(--accent-blue);
            margin: 20px 0 10px 0;
        }
        
        .fee-table {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .fee-table table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .fee-table th {
            background: var(--primary-navy);
            color: var(--text-primary);
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .fee-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .fee-table tr:last-child td {
            border-bottom: none;
        }
        
        .fee-table tr:hover {
            background: var(--hover-bg);
        }
        
        .workflow-guide h5 {
            color: var(--accent-blue);
            margin: 25px 0 15px 0;
        }
        
        .workflow-guide ol {
            padding-left: 20px;
        }
        
        .workflow-guide ol li {
            margin-bottom: 10px;
        }
        
        .best-practices h5 {
            color: var(--accent-blue);
            margin: 20px 0 15px 0;
        }
        
        .technical-info h5 {
            color: var(--accent-blue);
            margin: 20px 0 15px 0;
        }
        
        .warning-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: start;
        }
        
        .warning-box i {
            color: var(--error);
            font-size: 1.2em;
            flex-shrink: 0;
        }

        /* Animations */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes shimmer {
            to { left: 100%; }
        }

        @keyframes scan {
            to { left: 100%; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .admin-controls {
                grid-template-columns: 1fr;
            }

            .stats-section {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .preview-container {
                flex-direction: column;
            }
            
            .preview-image {
                flex: unset;
            }

            .modal-content {
                margin: 2% 1rem;
                padding: 1.5rem;
            }

            .welcome-section h2 {
                font-size: 2rem;
            }

            .stats-section {
                grid-template-columns: 1fr;
            }

            .tab-navigation {
                justify-content: start;
            }

            .notification {
                right: 0.5rem;
                left: 0.5rem;
                min-width: auto;
            }
        }

        /* Print styles */
        @media print {
            .header,
            .tab-navigation,
            .btn,
            .modal {
                display: none !important;
            }

            body {
                background: white;
                color: black;
            }

            .card {
                border: 1px solid #ccc;
                page-break-inside: avoid;
            }
        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Focus styles */
        *:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            :root {
                --primary-dark: #000000;
                --text-primary: #ffffff;
                --accent-blue: #00a8ff;
            }
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Wallet Info Grid */
        .wallet-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .info-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .info-value {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 600;
            word-break: break-all;
        }

        /* Badge styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-primary {
            background-color: var(--accent-blue);
            color: white;
        }

        .badge-secondary {
            background-color: var(--gray-700);
            color: var(--text-secondary);
        }

        .badge-success {
            background-color: var(--success);
            color: white;
        }

        .badge-warning {
            background-color: var(--warning);
            color: white;
        }

        .badge-admin {
            background-color: #9333ea;
            color: white;
        }

        .badge-server {
            background-color: #3b82f6;
            color: white;
        }

        /* Fee Summary */
        .fee-summary {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        .fee-summary p {
            margin: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fee-summary span {
            font-weight: 600;
            color: var(--accent-blue);
        }

        /* FAQ Styles */
        .faq-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .faq-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .faq-header {
            width: 100%;
            padding: 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .faq-header:hover {
            background: var(--hover-bg);
        }

        .faq-header i {
            transition: transform 0.3s ease;
            color: var(--accent-blue);
        }

        .faq-header.active i {
            transform: rotate(180deg);
        }

        .faq-content {
            padding: 0 1.5rem 1.5rem;
            display: none;
        }

        .fee-explanation {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .fee-item {
            background: var(--hover-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 3px solid var(--accent-blue);
        }

        .fee-item strong {
            color: var(--accent-blue);
            display: block;
            margin-bottom: 0.5rem;
        }

        .info-box {
            background: rgba(14, 165, 233, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .info-box.warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning);
        }

        .info-box i {
            color: var(--accent-blue);
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .info-box.warning i {
            color: var(--warning);
        }

        .delivery-option {
            background: var(--hover-bg);
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .delivery-option h5 {
            color: var(--accent-blue);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .delivery-option ul {
            list-style: none;
            padding: 0;
        }

        .delivery-option li {
            margin-bottom: 0.5rem;
            padding-left: 1.5rem;
            position: relative;
        }

        .delivery-option li::before {
            content: "";
            position: absolute;
            left: 0;
            color: var(--accent-blue);
        }

        .scenario {
            background: var(--hover-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .scenario h5 {
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .scenario ul {
            list-style: none;
            padding: 0;
        }

        .scenario li {
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .scenario li::before {
            content: "";
            position: absolute;
            left: 0;
            color: var(--success);
        }

        .cost-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .cost-table th,
        .cost-table td {
            padding: 0.75rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .cost-table th {
            background: var(--hover-bg);
            font-weight: 600;
            color: var(--accent-blue);
        }

        .cost-table tr:nth-child(even) {
            background: var(--hover-bg);
        }

        .breakdown-row td {
            background: var(--card-bg);
            font-style: italic;
            text-align: left !important;
            padding-left: 1.5rem;
        }

        .cost-note {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--hover-bg);
            border-radius: 0.5rem;
        }

        .benefit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .benefit-card {
            background: var(--hover-bg);
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .benefit-card:hover {
            transform: translateY(-2px);
        }

        .benefit-card i {
            font-size: 2.5rem;
            color: var(--accent-blue);
            margin-bottom: 1rem;
        }

        .benefit-card h5 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .step-list {
            list-style: none;
            padding: 0;
            margin-top: 1rem;
        }

        .step-list li {
            padding: 0.75rem 0 0.75rem 2.5rem;
            position: relative;
            border-bottom: 1px solid var(--border-color);
        }

        .step-list li:last-child {
            border-bottom: none;
        }

        .step-list li::before {
            content: counter(step-counter);
            counter-increment: step-counter;
            position: absolute;
            left: 0;
            width: 1.75rem;
            height: 1.75rem;
            background: var(--accent-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .step-list {
            counter-reset: step-counter;
        }
    
        /* Enhanced checkbox styling */
        #lawEnforcementExempt {
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(59, 130, 246, 0.5);
            border-radius: 4px;
            display: inline-block;
            position: relative;
            transition: all 0.2s ease;
        }
        
        #lawEnforcementExempt:checked {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        
        #lawEnforcementExempt:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        #lawEnforcementExempt:hover {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div class="loader-container" id="loader">
        <div class="loader"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo" onclick="location.reload()">
                <i class="fas fa-shield-alt"></i>
                <h1>LegalNotice</h1>
            </div>
            <div class="header-controls">
                <div id="contractsStatus" style="display: none;">
                    <div class="contract-indicator">
                        <span>Contract:</span>
                        <span id="legalContractShort">-</span>
                        <button class="btn-icon" onclick="viewContractOnTronscan('legal')" title="View on TronScan">
                            <i class="fas fa-external-link-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="chain-selector">
                    <select id="chainSelector" class="chain-dropdown" onchange="handleChainChange()">
                        <optgroup label="TRON">
                            <option value="tron-mainnet">TRON Mainnet</option>
                            <option value="tron-nile" selected>TRON Nile Testnet</option>
                            <option value="tron-shasta">TRON Shasta Testnet</option>
                        </optgroup>
                        <optgroup label="Ethereum">
                            <option value="evm-ethereum">Ethereum Mainnet</option>
                            <option value="evm-sepolia">Ethereum Sepolia</option>
                        </optgroup>
                        <optgroup label="Polygon">
                            <option value="evm-polygon">Polygon Mainnet</option>
                            <option value="evm-mumbai">Polygon Mumbai</option>
                        </optgroup>
                        <optgroup label="BNB Chain">
                            <option value="evm-bsc">BNB Smart Chain</option>
                            <option value="evm-bscTestnet">BSC Testnet</option>
                        </optgroup>
                    </select>
                </div>
                <div class="network-indicator" id="networkIndicator">
                    <i class="fas fa-circle"></i>
                    <span id="networkName">Disconnected</span>
                </div>
                <div class="wallet-status">
                    <div class="wallet-address" id="walletAddress" style="display: none;">
                        <span id="walletAddressText">Not Connected</span>
                        <button class="btn-icon" onclick="copyWalletAddress()" title="Copy address">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <span id="walletStatus" style="display: block;">Not Connected</span>
                    <button class="btn btn-primary btn-small" onclick="connectWallet()" id="connectBtn">
                        <i class="fas fa-link"></i>
                        Connect
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Welcome Section -->
        <div class="welcome-section" id="welcomeSection">
            <h2>Blockchain Legal Document Service</h2>
            <p>Secure, verifiable, and immutable legal document serving on the TRON network</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('user')">
                <i class="fas fa-user"></i> Process Server
                <span class="badge" id="userBadge" style="display: none;">0</span>
            </button>
            <button class="tab-button" onclick="switchTab('delivery')">
                <i class="fas fa-truck"></i> Delivery Status
                <span class="badge" id="deliveryBadge" style="display: none;">0</span>
            </button>
            <button class="tab-button" onclick="switchTab('admin')" id="adminTabButton" style="display: none;">
                <i class="fas fa-user-shield"></i> Admin Panel
            </button>
            <button class="tab-button" onclick="switchTab('help')">
                <i class="fas fa-question-circle"></i> Help
            </button>
        </div>

        <!-- Stats Section -->
        <div id="statsContainer" style="display: none;">
            <div class="stats-header" id="statsHeader" style="cursor: pointer; padding: 1rem; background: var(--secondary-navy); border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between;">
                <h3 style="margin: 0; font-size: 1.1rem; color: var(--text-primary);">
                    <i class="fas fa-chart-bar" style="margin-right: 0.5rem;"></i>
                    Dashboard Statistics
                </h3>
                <i id="statsToggleIcon" class="fas fa-chevron-up"></i>
            </div>
            <div class="stats-section" id="statsSection" style="display: grid;">
                <div class="stat-card">
                    <i class="fas fa-file-alt"></i>
                    <div class="stat-value" id="totalNotices">0</div>
                    <div class="stat-label">Total Notices</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-check-circle"></i>
                    <div class="stat-value" id="acceptedNotices">0</div>
                    <div class="stat-label">Accepted</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-clock"></i>
                    <div class="stat-value" id="pendingNotices">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-users"></i>
                    <div class="stat-value" id="activeServers">0</div>
                    <div class="stat-label">Process Servers</div>
                </div>
            </div>
        </div>

        <!-- User Tab -->
        <div id="userTab" class="tab-content active">
            <!-- Contract Management Card -->
            <div class="card" id="contractManagementCard">
                <div class="card-header" id="contractHeader" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 1.25rem;">
                    <h2 style="margin: 0;"><i class="fas fa-file-contract"></i> Contract Connection</h2>
                    <i id="contractToggleIcon" class="fas fa-chevron-up"></i>
                </div>
                <div id="contractContent">
                <div class="form-group">
                    <label class="form-label">Legal Notice Contract Address <span class="badge badge-info">Nile Testnet</span></label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" class="form-input" id="contractAddress" 
                               placeholder="Enter contract address (e.g., TXxxx...)"
                               value="TEZxBmj16pKdsJh3aDE9Y4RLSuXuBuUSp8" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="copyAddress(document.getElementById('contractAddress').value)" title="Copy address">
                            <i class="fas fa-copy"></i>
                        </button>
                        <a href="https://nile.tronscan.org/#/contract/TEZxBmj16pKdsJh3aDE9Y4RLSuXuBuUSp8" target="_blank" class="btn btn-secondary" title="View on Nile TronScan">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                    <p class="form-help"> Make sure your TronLink wallet is connected to <strong>Nile Testnet</strong>, not mainnet!</p>
                </div>
                <button class="btn btn-primary" onclick="connectContracts()" id="connectContractBtn">
                    <i class="fas fa-plug"></i>
                    Connect Contract
                </button>
                <div id="contractStatus"></div>
                </div>
            </div>

            <!-- Wallet Status Card -->
            <div class="card" id="walletStatusCard" style="display: none;">
                <div class="card-header" id="walletStatusHeader" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 1.25rem;">
                    <h2 style="margin: 0;"><i class="fas fa-wallet"></i> Wallet Status</h2>
                    <i id="walletToggleIcon" class="fas fa-chevron-down"></i>
                </div>
                <div id="walletStatusContent" style="display: none;">
                <div class="wallet-info-grid">
                    <div class="info-item">
                        <span class="info-label">Address:</span>
                        <span class="info-value" id="statusWalletAddress">Not Connected</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Role:</span>
                        <span class="info-value" id="walletRole">
                            <span class="badge badge-secondary">None</span>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Fee Status:</span>
                        <span class="info-value" id="feeExemptStatus">
                            <span class="badge badge-warning">Not Exempt</span>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Balance:</span>
                        <span class="info-value" id="walletBalance">0 TRX</span>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="refreshWalletStatus()" style="margin-top: 1rem;">
                    <i class="fas fa-sync-alt"></i>
                    Refresh Status
                </button>
                <button class="btn btn-primary" onclick="debugCheckRoles()" style="margin-top: 1rem; margin-left: 0.5rem;">
                    <i class="fas fa-bug"></i>
                    Debug Check
                </button>
                <button class="btn btn-success" onclick="fixMyFeeExemption()" style="margin-top: 1rem; margin-left: 0.5rem; display: none;" id="fixExemptionBtn">
                    <i class="fas fa-wrench"></i>
                    Fix Exemption
                </button>
                
                <!-- Detailed Role Check -->
                <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <h4 style="margin-bottom: 0.5rem;">Detailed Role Check</h4>
                    <div id="roleCheckDetails" style="font-size: 0.875rem; color: var(--text-secondary);">
                        Click refresh to check all roles...
                    </div>
                </div>
                
                <!-- Debug Output (separate div to prevent overwriting) -->
                <div id="debugOutput" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--accent-blue);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <h4 style="margin: 0;">Debug Information</h4>
                        <button class="btn btn-sm btn-secondary" onclick="copyDebugInfo()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div id="debugContent" style="font-size: 0.875rem; color: var(--text-secondary);">
                    </div>
                </div>
                </div>
            </div>

            <!-- New User Registration Notice -->
            <div id="registrationNotice" class="notification-banner">
                <i class="fas fa-info-circle"></i>
                <div style="flex: 1;">
                    <strong>New User?</strong>
                    Please register as a Process Server to get your unique identifier.
                    <button class="btn btn-primary btn-small" style="margin-left: 1rem;" onclick="openRegistrationModal()">
                        <i class="fas fa-user-plus"></i> Register Now
                    </button>
                </div>
                <button class="btn-icon" onclick="dismissRegistrationNotice()" title="Dismiss">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Server ID Display -->
            <div id="serverIdDisplay" style="display: none; margin-bottom: 1.5rem;">
                <div class="server-id-display">
                    <i class="fas fa-id-badge"></i>
                    Your Server ID: <span id="userServerId">00</span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid-3" style="margin-bottom: 2rem;">
                <div class="action-card primary" onclick="openMintModal()">
                    <i class="fas fa-file-upload"></i>
                    <h3>Create Legal Notice</h3>
                    <p>Upload document and create NFT with automatic alert</p>
                </div>
                
                <div class="action-card" onclick="openAuditModal()">
                    <i class="fas fa-clipboard-check"></i>
                    <h3>Audit Issued Notices</h3>
                    <p>View all notices, delivery status, and transaction details</p>
                </div>
                
                <div class="action-card" onclick="openRegistrationForUser()">
                    <i class="fas fa-user-tie"></i>
                    <h3>Become a Process Server</h3>
                    <p>Register to serve legal documents professionally</p>
                </div>
            </div>

            <!-- My Alerts -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-bell"></i> My Legal Notice Alerts</h2>
                    <button class="btn btn-secondary btn-small" onclick="refreshMyAlerts()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="debugAlerts()">
                        <i class="fas fa-bug"></i> Debug
                    </button>
                </div>
                
                <!-- New user-friendly explanation banner -->
                <div class="alert alert-info" style="margin: 1rem; display: none; background: #f0f9ff; border: 2px solid #3b82f6;" id="alertExplainer">
                    <div style="display: flex; align-items: start; gap: 1rem;">
                        <i class="fas fa-envelope-open-text" style="color: #3b82f6; font-size: 1.5rem; margin-top: 0.25rem;"></i>
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; color: #1e40af;">You Have Received Official Legal Documents</h4>
                            <p style="margin: 0 0 0.5rem 0; color: #1e3a8a;">
                                These are verified legal notices delivered electronically through blockchain technology. 
                                Just like certified mail, these documents require your signature to confirm receipt.
                            </p>
                            <div style="background: #dbeafe; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem;">
                                <p style="margin: 0; font-weight: 600; color: #1e40af;">
                                    <i class="fas fa-shield-alt" style="margin-right: 0.5rem;"></i>
                                    Your signature only confirms you received the document - it does NOT mean you agree with it or admit any wrongdoing.
                                </p>
                            </div>
                            <p style="margin: 0.75rem 0 0 0; color: #1e3a8a; font-size: 0.875rem;">
                                <strong>What to do:</strong> Review each notice below and click "Sign Receipt" to confirm delivery. 
                                Consider seeking legal advice if you have questions about the content.
                            </p>
                            <div style="background: #fef3c7; padding: 0.75rem; border-radius: 6px; margin-top: 0.75rem; border: 1px solid #f59e0b;">
                                <p style="margin: 0; color: #92400e; font-weight: 600;">
                                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem; color: #d97706;"></i>
                                    Warning: Failing to respond to legal notices by their deadlines may result in default judgment against you. 
                                    The court may rule in favor of the other party if you do not respond in time.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="myAlertsContent">
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>No alerts yet</h3>
                        <p>Click refresh to check for new legal notices</p>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-history"></i> Recent Activity</h2>
                </div>
                <div id="recentActivityContent">
                    <div class="empty-state">
                        <i class="fas fa-clipboard"></i>
                        <h3>No recent activity</h3>
                        <p>Your recent transactions will appear here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delivery Status Tab -->
        <div id="deliveryTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-truck"></i> Delivery Tracking Dashboard</h2>
                    <button class="btn btn-icon" onclick="refreshDeliveryStatus()" title="Refresh">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
                
                <!-- Delivery Stats Overview -->
                <div class="stats-section" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <i class="fas fa-paper-plane"></i>
                        <div class="stat-value" id="totalSentNotices">0</div>
                        <div class="stat-label">Notices Sent</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-double"></i>
                        <div class="stat-value" id="deliveredNotices">0</div>
                        <div class="stat-label">Delivered</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-hourglass-half"></i>
                        <div class="stat-value" id="pendingDelivery">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-percentage"></i>
                        <div class="stat-value" id="deliveryRate">0%</div>
                        <div class="stat-label">Delivery Rate</div>
                    </div>
                </div>
                
                <!-- Filter Options -->
                <div class="form-group">
                    <label class="form-label">Filter by Status</label>
                    <select id="deliveryStatusFilter" onchange="filterDeliveryResults()" class="form-select">
                        <option value="all">All Notices</option>
                        <option value="pending">Pending Delivery</option>
                        <option value="delivered">Delivered (Accepted)</option>
                        <option value="recent">Last 7 Days</option>
                    </select>
                </div>
                
                <!-- Delivery Results -->
                <div id="deliveryResults">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No notices to track</h3>
                        <p>Your sent notices will appear here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="adminTab" class="tab-content">
            <!-- Admin Access Check -->
            <div id="adminAccessDenied" class="alert alert-error" style="display: none;">
                <i class="fas fa-lock"></i>
                <div>
                    <strong>Access Denied</strong>
                    <p>You need admin role to access this section.</p>
                </div>
            </div>

            <div id="adminContent" style="display: none;">
                <!-- Pending Registrations -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-user-clock"></i> Pending Process Server Registrations</h2>
                        <button class="btn btn-secondary btn-small" onclick="refreshPendingRegistrations()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div id="pendingRegistrations">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No pending registrations</h3>
                            <p>New registration requests will appear here</p>
                        </div>
                    </div>
                </div>

                <!-- All Registrations Viewer -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-database"></i> All Process Server Registrations</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-small" onclick="fetchAllRegistrations()">
                                <i class="fas fa-sync"></i> Load All
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="exportRegistrations()" style="display: none;" id="exportBtn">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                        </div>
                    </div>
                    <div id="allRegistrationsContent">
                        <div class="empty-state">
                            <i class="fas fa-cloud-download-alt"></i>
                            <h3>Click "Load All" to fetch registrations</h3>
                            <p>This will download and decrypt all registration files from GitHub</p>
                        </div>
                    </div>
                </div>

                <!-- Admin Controls -->
                <div class="admin-controls">
                    <!-- Fee Structure Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-coins"></i> Fee Structure Management</h2>
                        </div>
                        
                        <!-- Service Fee (Profit) -->
                        <div class="form-group">
                            <label class="form-label">Service Fee (Profit) - TRX</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number" class="form-input" id="serviceFee" 
                                       step="0.01" min="0" placeholder="20" style="flex: 1;">
                                <span class="form-help" id="currentServiceFee">Current: 20 TRX</span>
                            </div>
                            <p class="form-help">Revenue fee - can be waived for law enforcement</p>
                        </div>
                        
                        <!-- Creation Fee (Operations) -->
                        <div class="form-group">
                            <label class="form-label">Creation Fee (Operations) - TRX</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number" class="form-input" id="creationFee" 
                                       step="0.01" min="0" placeholder="10" style="flex: 1;">
                                <span class="form-help" id="currentCreationFee">Current: 10 TRX</span>
                            </div>
                            <p class="form-help">Operational costs - not waivable</p>
                        </div>
                        
                        <!-- Sponsorship Fee -->
                        <div class="form-group">
                            <label class="form-label">Sponsorship Fee (Recipient Support) - TRX</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number" class="form-input" id="sponsorshipFee" 
                                       step="0.01" min="0" placeholder="2" style="flex: 1;">
                                <span class="form-help" id="currentSponsorshipFee">Current: 2 TRX</span>
                            </div>
                            <p class="form-help">Funds recipient acceptance - not waivable</p>
                        </div>
                        
                        <div class="fee-summary">
                            <p><strong>Total Regular User Cost:</strong> <span id="totalRegularCost">32 TRX</span></p>
                            <p><strong>Total Law Enforcement Cost:</strong> <span id="totalLECost">12 TRX</span></p>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="updateServiceFee()" id="updateServiceFeeBtn">
                                <i class="fas fa-save"></i> Update Service Fee
                            </button>
                            <button class="btn btn-primary" onclick="updateCreationFee()" id="updateCreationFeeBtn">
                                <i class="fas fa-save"></i> Update Creation Fee
                            </button>
                            <button class="btn btn-primary" onclick="updateSponsorshipFee()" id="updateSponsorshipFeeBtn">
                                <i class="fas fa-save"></i> Update Sponsorship Fee
                            </button>
                        </div>
                        <div id="feeUpdateResult"></div>
                    </div>

                    <!-- IPFS Configuration -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-cloud-upload-alt"></i> IPFS Configuration (Pinata)</h2>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pinata API Key</label>
                            <input type="text" class="form-input" id="pinataApiKey" 
                                   placeholder="Enter your Pinata API key">
                            <p class="form-help">Get your API key from <a href="https://app.pinata.cloud/keys" target="_blank">Pinata Dashboard</a></p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pinata Secret API Key</label>
                            <input type="password" class="form-input" id="pinataSecretKey" 
                                   placeholder="Enter your Pinata Secret API key">
                            <p class="form-help">Keep this secret - it will be stored locally in your browser</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="savePinataKeys()">
                                <i class="fas fa-save"></i> Save Keys
                            </button>
                            <button class="btn btn-secondary" onclick="testPinataConnection()">
                                <i class="fas fa-check-circle"></i> Test Connection
                            </button>
                        </div>
                        <div id="pinataConfigResult"></div>
                    </div>

                    <!-- Role Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-users-cog"></i> Role & Exemption Management</h2>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Select Role</label>
                            <select class="form-input" id="roleSelect" onchange="toggleRegistrationForm()">
                                <option value="PROCESS_SERVER_ROLE">Process Server</option>
                                <option value="ADMIN_ROLE">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
    <label class="form-label">Wallet Address</label>
    <div style="display: flex; gap: 0.5rem;">
        <input type="text" class="form-input" id="roleAddress" 
               placeholder="Enter TRON wallet address" style="flex: 1;">
        <button class="btn btn-secondary btn-small" onclick="useConnectedAddress()" title="Use my address">
            <i class="fas fa-user"></i>
        </button>
    </div>
    <p class="form-help">Enter address or click button to use your connected wallet</p>
</div>
                        <!-- Process Server Registration Form -->
                        <div id="serverRegistrationForm" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Agency Name</label>
                                <input type="text" class="form-input" id="agencyName" placeholder="e.g., Smith & Associates Process Service">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agency Email</label>
                                <input type="email" class="form-input" id="agencyEmail" placeholder="agency@example.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Server Name</label>
                                <input type="text" class="form-input" id="serverName" placeholder="Full name of process server">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-input" id="serverPhone" placeholder="(555) 123-4567">
                            </div>
                        </div>
                        <!-- Action Buttons -->
                        <div style="margin-top: 1.5rem;">
                            <div style="display: flex; gap: 0.5rem; justify-content: flex-start;">
                                <button class="btn btn-primary btn-small" onclick="grantRole()" id="grantRoleBtn" style="padding: 0.5rem 1rem;">
                                    <i class="fas fa-user-plus"></i>
                                    Grant Role
                                </button>
                                <button class="btn btn-secondary btn-small" onclick="checkRole()" id="checkRoleBtn" style="padding: 0.5rem 1rem;">
                                    <i class="fas fa-user-check"></i>
                                    Check Role
                                </button>
                            </div>
                        </div>
                        <div id="roleResult"></div>
                    </div>

                    <!-- Fee Exemption Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-shield-alt"></i> Fee Exemption Management</h2>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Address to Manage Exemptions</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" class="form-input" id="exemptionAddress" 
                                       placeholder="Enter TRON wallet address" style="flex: 1;">
                                <button class="btn btn-secondary btn-small" onclick="useConnectedAddressForExemption()" title="Use my address">
                                    <i class="fas fa-user"></i> Use My Address
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Agency Name (for Law Enforcement)</label>
                            <input type="text" class="form-input" id="exemptionAgencyName" 
                                   placeholder="e.g., FBI, DEA, Local Police Department">
                            <p class="form-help">Required only for law enforcement exemptions</p>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="setLawEnforcementExemption()">
                                <i class="fas fa-badge-check"></i> Grant Law Enforcement Exemption
                            </button>
                            <button class="btn btn-warning" onclick="removeLawEnforcementExemption()">
                                <i class="fas fa-ban"></i> Remove Law Enforcement Exemption
                            </button>
                            <button class="btn btn-secondary" onclick="checkExemptionStatus()">
                                <i class="fas fa-info-circle"></i> Check Status
                            </button>
                        </div>
                        <div id="exemptionResult"></div>
                    </div>

                    <!-- Fee Collector Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-wallet"></i> Update Fee Collector</h2>
                        </div>
                        <div class="form-group">
    <label class="form-label">Fee Collector Address</label>
    <div style="display: flex; gap: 0.5rem;">
        <input type="text" class="form-input" id="feeCollectorAddress" 
               placeholder="Enter wallet address" style="flex: 1;">
        <button class="btn btn-secondary btn-small" onclick="useConnectedAddressForFeeCollector()" title="Use my address">
            <i class="fas fa-user"></i>
        </button>
    </div>
    <p class="form-help">Address that receives all contract fees</p>
</div>
                        <button class="btn btn-primary" onclick="updateFeeCollector()" id="updateFeeCollectorBtn">
                            <i class="fas fa-save"></i>
                            Update Fee Collector
                        </button>
                        <div id="feeCollectorResult"></div>
                    </div>

                    <!-- Transaction Verification -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-search-dollar"></i> Transaction Verification</h2>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Transaction Hash</label>
                            <input type="text" class="form-input" id="verifyTxHash" 
                                   placeholder="Enter transaction hash to verify NFT transfers">
                        </div>
                        <button class="btn btn-primary" onclick="verifyTransaction()">
                            <i class="fas fa-check-circle"></i>
                            Verify Transaction
                        </button>
                        <div id="txVerificationResult" style="margin-top: 1rem;"></div>
                    </div>

                    <!-- Contract Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-cog"></i> Contract Management</h2>
                        </div>
                        <!-- Resource Sponsorship removed - not in simplified contract -->
                        <!--
                        <div class="form-group">
                            <label class="form-label">Resource Sponsorship</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="resourceSponsorshipCheck" checked>
                                <label for="resourceSponsorshipCheck">Enable resource sponsorship</label>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="updateResourceSponsorship()">
                            <i class="fas fa-save"></i>
                            Update Settings
                        </button>
                        <div id="contractManagementResult"></div>
                        -->
                        
                        <!-- Energy Delegation Section -->
                        <div class="form-group" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                            <h3 style="margin-bottom: 1rem;">
                                <i class="fas fa-bolt"></i> Energy Delegation
                            </h3>
                            <p class="form-help" style="margin-bottom: 1rem;">
                                Stake TRX to delegate energy to the contract. This allows the contract to pay for user transaction energy costs.
                                <br>Each notice requires ~500,000 energy. 20,000 TRX staked = ~504,000 energy/day
                            </p>
                            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                <button class="btn btn-secondary" onclick="checkContractResources()">
                                    <i class="fas fa-battery-half"></i> Check Resources
                                </button>
                                <button class="btn btn-primary" onclick="showDelegateEnergyModal()">
                                    <i class="fas fa-bolt"></i> Delegate Energy
                                </button>
                            </div>
                            <div id="contractResourceStatus" style="font-size: 0.875rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; display: none;">
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                            <label class="form-label">Withdraw TRX from Contract</label>
                            <input type="number" class="form-input" id="withdrawAmount" placeholder="Amount in TRX" step="0.1">
                            <p class="form-help">Withdraw TRX from contract balance (admin only)</p>
                            <button class="btn btn-warning" onclick="withdrawFromContract()">
                                <i class="fas fa-coins"></i>
                                Withdraw TRX
                            </button>
                        </div>
                    </div>

                    <!-- GitHub Storage Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-lock"></i> Encrypted Storage Settings</h2>
                        </div>
                        
                        <!-- GitHub Token -->
                        <div class="form-group">
                            <label class="form-label">GitHub Personal Access Token</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="password" class="form-input" id="githubToken" 
                                       placeholder="ghp_..." style="flex: 1;">
                                <button class="btn btn-secondary btn-small" onclick="toggleTokenVisibility()" title="Show/Hide">
                                    <i class="fas fa-eye" id="tokenVisibilityIcon"></i>
                                </button>
                            </div>
                            <p class="form-help">Token for saving encrypted registrations to GitHub</p>
                        </div>
                        
                        <!-- Encryption Key Display -->
                        <div class="form-group">
                            <label class="form-label">Encryption Key (Auto-generated)</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="text" class="form-input" id="encryptionKey" 
                                       readonly style="flex: 1; background: var(--secondary-navy); cursor: not-allowed;">
                                <button class="btn btn-secondary btn-small" onclick="copyEncryptionKey()" title="Copy key">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <p class="form-help">Save this key securely - needed to decrypt registration files</p>
                        </div>
                        
                        <!-- Test Connection -->
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="saveGitHubSettings()">
                                <i class="fas fa-save"></i>
                                Save Settings
                            </button>
                            <button class="btn btn-secondary" onclick="testGitHubConnection()">
                                <i class="fas fa-check-circle"></i>
                                Test Connection
                            </button>
                        </div>
                        <div id="githubSettingsResult"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Tab -->
        <div id="helpTab" class="tab-content">
            <!-- FAQ Accordion -->
            <div class="faq-container">
                <h2 style="margin-bottom: 2rem;"><i class="fas fa-question-circle"></i> Frequently Asked Questions</h2>
                
                <!-- Understanding the Two Delivery Methods -->
                <div class="faq-section">
                    <button class="faq-header active" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-down"></i>
                        <span>Understanding the Two Delivery Methods</span>
                    </button>
                    <div class="faq-content" style="display: block;">
                        <h4>We offer two distinct methods for delivering legal notices via blockchain:</h4>
                        
                        <div class="delivery-option">
                            <h5><i class="fas fa-file-shield"></i> Document Images (Secure & Verifiable)</h5>
                            <p><strong>Purpose:</strong> For serving official legal documents that require proof of delivery and signature confirmation.</p>
                            
                            <div class="info-box">
                                <i class="fas fa-lock"></i>
                                <div>
                                    <strong>How it works:</strong>
                                    <ol style="margin: 0.5rem 0 0 0;">
                                        <li>Legal document is encrypted using the recipient's wallet address</li>
                                        <li>Document stored securely on IPFS (decentralized storage)</li>
                                        <li>Recipient receives NFT with public notice text</li>
                                        <li>To view document, recipient must "accept" (sign transaction)</li>
                                        <li>Acceptance creates immutable proof of delivery with timestamp</li>
                                        <li>Decryption key revealed only after acceptance</li>
                                    </ol>
                                </div>
                            </div>
                            
                            <p><strong>Security Features:</strong></p>
                            <ul>
                                <li> Document remains private until accepted</li>
                                <li> Only intended recipient can decrypt</li>
                                <li> Blockchain proof of service date/time</li>
                                <li> Cannot be altered after creation</li>
                                <li> Permanent verifiable record</li>
                            </ul>
                            
                            <p><strong>Best for:</strong> Court orders, seizure notices, subpoenas, summons, eviction notices, and any document requiring certified delivery.</p>
                        </div>
                        
                        <div class="delivery-option">
                            <h5><i class="fas fa-comment-alt"></i> Text Only (Simple & Direct)</h5>
                            <p><strong>Purpose:</strong> For public notices, reminders, or communications that don't require signature confirmation.</p>
                            
                            <div class="info-box warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>
                                    <strong>How it works:</strong>
                                    <ol style="margin: 0.5rem 0 0 0;">
                                        <li>Text message is sent directly to recipient's wallet</li>
                                        <li>Appears immediately as NFT - no acceptance required</li>
                                        <li>All content is publicly visible on blockchain</li>
                                        <li>No encryption or privacy protection</li>
                                        <li>No proof of recipient viewing/acknowledging</li>
                                    </ol>
                                </div>
                            </div>
                            
                            <p><strong>Limitations:</strong></p>
                            <ul>
                                <li> No privacy - anyone can read the message</li>
                                <li> No proof recipient saw the notice</li>
                                <li> Cannot attach documents</li>
                                <li> Limited to 100 characters</li>
                            </ul>
                            
                            <p><strong>Best for:</strong> Payment reminders, public announcements, preliminary notices, meeting notifications.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Recipient Experience & Security -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Recipient Experience & Security</span>
                    </button>
                    <div class="faq-content">
                        <h4>What Recipients Experience</h4>
                        
                        <div class="recipient-journey">
                            <h5>For Document Images Notices:</h5>
                            <div class="process-steps">
                                <div class="step">
                                    <div class="step-number">1</div>
                                    <div class="step-content">
                                        <strong>NFT Appears in Wallet</strong>
                                        <p>Recipients see a new NFT titled with the notice type (e.g., "PS#1-Legal Notice"). The description includes:</p>
                                        <ul>
                                            <li>Issuing agency name</li>
                                            <li>Case reference number</li>
                                            <li>Brief description of the matter</li>
                                            <li>Clear message: "Legal document attached. Accept to view."</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="step">
                                    <div class="step-number">2</div>
                                    <div class="step-content">
                                        <strong>One-Click Acceptance</strong>
                                        <p>To view the document:</p>
                                        <ul>
                                            <li>Click "Accept Notice" button</li>
                                            <li>Approve transaction in wallet (FREE if sponsored)</li>
                                            <li>Wait ~3 seconds for confirmation</li>
                                            <li>Document automatically decrypts and displays</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="step">
                                    <div class="step-number">3</div>
                                    <div class="step-content">
                                        <strong>Permanent Access</strong>
                                        <p>After acceptance:</p>
                                        <ul>
                                            <li>Full document is viewable anytime</li>
                                            <li>Can download/print for records</li>
                                            <li>Blockchain timestamp proves when you received it</li>
                                            <li>Cannot be altered or deleted</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <h5>For Text Only Notices:</h5>
                            <ul>
                                <li>Message appears immediately in wallet</li>
                                <li>No action required - it's already visible</li>
                                <li>No fees or signatures needed</li>
                                <li>Simple informational delivery</li>
                            </ul>
                            
                            <h5>Security for Recipients:</h5>
                            <div class="info-box">
                                <i class="fas fa-shield-alt"></i>
                                <div>
                                    <strong>Your wallet = Your control</strong>
                                    <ul style="margin: 0.5rem 0 0 0;">
                                        <li>Documents encrypted with YOUR wallet address</li>
                                        <li>Only YOU can decrypt and view</li>
                                        <li>Process servers cannot see if/when you view</li>
                                        <li>No personal information exposed publicly</li>
                                        <li>Acceptance is voluntary - you control timing</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Complete Fee Structure & Energy Costs -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Complete Fee Structure & Energy Costs</span>
                    </button>
                    <div class="faq-content">
                        <h4>Understanding All Costs</h4>
                        
                        <div class="fee-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>User Type</th>
                                        <th>Document Images</th>
                                        <th>Text Only</th>
                                        <th>Energy Cost</th>
                                        <th>Total Estimate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Regular User</strong></td>
                                        <td>150 TRX + 2 TRX</td>
                                        <td>15 TRX + 2 TRX</td>
                                        <td>~90 TRX / ~36 TRX</td>
                                        <td>~242 TRX / ~53 TRX</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Process Server</strong></td>
                                        <td>75 TRX + 2 TRX</td>
                                        <td>15 TRX + 2 TRX</td>
                                        <td>~90 TRX / ~36 TRX</td>
                                        <td>~167 TRX / ~53 TRX</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Law Enforcement</strong></td>
                                        <td>0 TRX + 2 TRX</td>
                                        <td>0 TRX + 2 TRX</td>
                                        <td>~90 TRX / ~36 TRX</td>
                                        <td>~92 TRX / ~38 TRX</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <h5>Fee Components Explained:</h5>
                        
                        <div class="fee-explanation">
                            <div class="fee-item">
                                <strong>Service Fee (150 TRX for Documents, 15 TRX for Text)</strong>
                                <p>Covers platform operations, IPFS storage, encryption services, and profit margin. This is the primary revenue source.</p>
                            </div>
                            
                            <div class="fee-item">
                                <strong>Creation Fee (75 TRX for Process Servers)</strong>
                                <p>Reduced fee for verified process servers who serve high volumes. Covers operational costs with minimal profit.</p>
                            </div>
                            
                            <div class="fee-item">
                                <strong>Sponsorship Fee (2 TRX - ALWAYS INCLUDED)</strong>
                                <p>Ensures recipients can accept notices without needing TRX. This fee is mandatory and cannot be waived. It removes all friction for recipients.</p>
                            </div>
                            
                            <div class="fee-item">
                                <strong>Energy Costs (~90 TRX for Documents, ~36 TRX for Text)</strong>
                                <p>TRON blockchain requires "energy" to process transactions. Without staked TRX, this energy must be "burned" from your balance. This is NOT kept by us - it goes to the TRON network.</p>
                            </div>
                        </div>
                        
                        <h5>Law Enforcement Special Pricing:</h5>
                        <div class="info-box">
                            <i class="fas fa-balance-scale"></i>
                            <div>
                                <strong>Cost-Only Pricing for Law Enforcement</strong>
                                <p style="margin: 0.5rem 0 0 0;">Verified law enforcement agencies pay ONLY actual costs:</p>
                                <ul style="margin: 0.5rem 0 0 0;">
                                    <li>2 TRX sponsorship (for recipient)</li>
                                    <li>Energy costs (paid by their wallet)</li>
                                    <li>NO service fees or profit margins</li>
                                    <li>Must be verified with agency name</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Workflow Guide -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Step-by-Step Workflow Guide</span>
                    </button>
                    <div class="faq-content">
                        <h4>Complete Process for Serving Legal Notices</h4>
                        
                        <div class="workflow-guide">
                            <h5>Before You Start:</h5>
                            <ul>
                                <li>Ensure you have the recipient's wallet address</li>
                                <li>Have your legal document ready (PDF, DOC, or images)</li>
                                <li>Prepare case information (agency, case number, etc.)</li>
                                <li>Have sufficient TRX in your wallet (22 TRX recommended)</li>
                            </ul>
                            
                            <h5>Step 1: Connect Your Wallet</h5>
                            <ol>
                                <li>Click "Connect Wallet" in the top right</li>
                                <li>Select TRON network</li>
                                <li>Approve connection in your wallet</li>
                            </ol>
                            
                            <h5>Step 2: Create Legal Notice</h5>
                            <ol>
                                <li>Click "Create Legal Notice" button</li>
                                <li>Upload your legal document</li>
                                <li>Enter recipient's wallet address</li>
                                <li>Select "Document Images" as delivery method</li>
                                <li>Fill in notice details:
                                    <ul>
                                        <li>Select or enter notice type</li>
                                        <li>Enter issuing agency name</li>
                                        <li>Provide case number</li>
                                        <li>Add specific details (amounts, property, etc.)</li>
                                        <li>Review legal rights statement</li>
                                    </ul>
                                </li>
                                <li>Check "Pay Recipient's Acceptance Fees" (recommended)</li>
                                <li>Review total cost (typically 22 TRX)</li>
                                <li>Click "Create Notice" and confirm transaction</li>
                            </ol>
                            
                            <h5>Step 3: Track Delivery</h5>
                            <ol>
                                <li>Go to "Delivery Status" tab</li>
                                <li>Find your notice in the list</li>
                                <li>Monitor status (Pending  Delivered)</li>
                                <li>View acceptance timestamp when complete</li>
                            </ol>
                            
                            <h5>Step 4: Obtain Proof</h5>
                            <ul>
                                <li>Transaction hash serves as proof of service</li>
                                <li>Acceptance transaction provides proof of delivery</li>
                                <li>All records are permanently stored on blockchain</li>
                                <li>Export delivery certificate for court filing</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Best Practices -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Best Practices & Tips</span>
                    </button>
                    <div class="faq-content">
                        <h4>Maximizing Success with Blockchain Service</h4>
                        
                        <div class="best-practices">
                            <h5>For Process Servers:</h5>
                            <ul>
                                <li><strong>Always sponsor acceptance fees</strong> - This ensures recipients can accept without barriers</li>
                                <li><strong>Use descriptive case details</strong> - Help recipients understand the notice importance</li>
                                <li><strong>Include clear legal rights</strong> - Inform recipients of their options</li>
                                <li><strong>Verify wallet addresses</strong> - Double-check before sending (transactions are irreversible)</li>
                                <li><strong>Document everything</strong> - Keep records of wallet ownership verification</li>
                            </ul>
                            
                            <h5>For Law Enforcement:</h5>
                            <ul>
                                <li><strong>Request fee exemption</strong> - Contact admin for service fee waiver</li>
                                <li><strong>Use official agency names</strong> - Ensure proper identification</li>
                                <li><strong>Include badge/case numbers</strong> - Provide verifiable references</li>
                                <li><strong>Consider bulk operations</strong> - Plan multiple notices together</li>
                            </ul>
                            
                            <h5>Common Mistakes to Avoid:</h5>
                            <ul>
                                <li> Sending to wrong wallet address</li>
                                <li> Forgetting to sponsor acceptance fees</li>
                                <li> Using vague descriptions</li>
                                <li> Not including case numbers</li>
                                <li> Uploading unencrypted sensitive documents</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Technical Details -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Technical Information</span>
                    </button>
                    <div class="faq-content">
                        <h4>How It Works Under the Hood</h4>
                        
                        <div class="technical-info">
                            <h5>Blockchain Technology:</h5>
                            <ul>
                                <li>Built on TRON blockchain for low fees and fast transactions</li>
                                <li>Uses TRC-721 NFT standard for maximum wallet compatibility</li>
                                <li>Documents stored on IPFS (InterPlanetary File System)</li>
                                <li>Smart contracts ensure tamper-proof records</li>
                            </ul>
                            
                            <h5>Security Features:</h5>
                            <ul>
                                <li>Documents encrypted before upload</li>
                                <li>Decryption keys revealed only after acceptance</li>
                                <li>Cryptographic proof of delivery</li>
                                <li>Immutable audit trail</li>
                                <li>No central point of failure</li>
                            </ul>
                            
                            <h5>Legal Validity:</h5>
                            <ul>
                                <li>Blockchain records are increasingly recognized in courts</li>
                                <li>Provides stronger proof than traditional methods</li>
                                <li>Timestamp accuracy to the second</li>
                                <li>Cannot be altered or deleted</li>
                                <li>Global accessibility</li>
                            </ul>
                        </div>
                    </div>
                </div>
                    <div class="faq-content">
                        <h4>What are the different delivery options?</h4>
                        
                        <div class="delivery-option">
                            <h5><i class="fas fa-file-alt"></i> Notice Only (Cheapest Option)</h5>
                            <ul>
                                <li><strong>What:</strong> Sends only the IPFS document link as an NFT</li>
                                <li><strong>Cost:</strong> ~7 TRX for law enforcement, ~27 TRX for others</li>
                                <li><strong>Best for:</strong> High-volume serving where cost is critical</li>
                                <li><strong>Limitation:</strong> No visual preview in wallet</li>
                            </ul>
                        </div>
                        
                        <div class="delivery-option">
                            <h5><i class="fas fa-image"></i> Alert Only (Visual Impact)</h5>
                            <ul>
                                <li><strong>What:</strong> Sends only the preview thumbnail as an NFT</li>
                                <li><strong>Cost:</strong> ~12 TRX for law enforcement, ~32 TRX for others</li>
                                <li><strong>Best for:</strong> Urgent notifications requiring immediate attention</li>
                                <li><strong>Limitation:</strong> No access to full document</li>
                            </ul>
                        </div>
                        
                        <div class="delivery-option">
                            <h5><i class="fas fa-folder-open"></i> Full Package (Complete Service)</h5>
                            <ul>
                                <li><strong>What:</strong> Sends both alert thumbnail AND document NFT</li>
                                <li><strong>Cost:</strong> ~17 TRX for law enforcement, ~37 TRX for others</li>
                                <li><strong>Best for:</strong> Critical legal notices requiring full documentation</li>
                                <li><strong>Benefit:</strong> Complete proof of service with visual confirmation</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- When to Use Each Option -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Choosing the Right Delivery Option</span>
                    </button>
                    <div class="faq-content">
                        <h4>How do I choose the best option?</h4>
                        
                        <div class="scenario">
                            <h5>Choose "Notice Only" when:</h5>
                            <ul>
                                <li>Serving high volumes of routine notices</li>
                                <li>Recipients are expecting the documents</li>
                                <li>Cost efficiency is paramount</li>
                                <li>Visual impact is not necessary</li>
                            </ul>
                        </div>
                        
                        <div class="scenario">
                            <h5>Choose "Alert Only" when:</h5>
                            <ul>
                                <li>Immediate visual notification is critical</li>
                                <li>Document details can be communicated separately</li>
                                <li>You need attention-grabbing wallet notifications</li>
                                <li>Full document access isn't required</li>
                            </ul>
                        </div>
                        
                        <div class="scenario">
                            <h5>Choose "Full Package" when:</h5>
                            <ul>
                                <li>Serving critical legal documents</li>
                                <li>Complete chain of custody is required</li>
                                <li>Recipients need both notification and documentation</li>
                                <li>Maximum legal compliance is necessary</li>
                            </ul>
                        </div>
                        
                        <div class="info-box warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p><strong>Important:</strong> The alert image is what drives most of the cost because storing images on-blockchain is expensive. Each character in the base64 image costs gas fees.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Cost Breakdown Section -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Detailed Cost Breakdown</span>
                    </button>
                    <div class="faq-content">
                        <h4>What exactly am I paying for?</h4>
                        
                        <table class="cost-table">
                            <thead>
                                <tr>
                                    <th>User Type</th>
                                    <th>Notice Only</th>
                                    <th>Alert Only</th>
                                    <th>Full Package</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Regular User</strong></td>
                                    <td>27 TRX</td>
                                    <td>32 TRX</td>
                                    <td>37 TRX</td>
                                </tr>
                                <tr>
                                    <td><strong>Law Enforcement</strong></td>
                                    <td>7 TRX</td>
                                    <td>12 TRX</td>
                                    <td>17 TRX</td>
                                </tr>
                                <tr class="breakdown-row">
                                    <td colspan="4"><em>Fee Breakdown:</em></td>
                                </tr>
                                <tr>
                                    <td>Service Fee</td>
                                    <td>20 / 0</td>
                                    <td>20 / 0</td>
                                    <td>20 / 0</td>
                                </tr>
                                <tr>
                                    <td>Creation Fee</td>
                                    <td>5</td>
                                    <td>0</td>
                                    <td>5</td>
                                </tr>
                                <tr>
                                    <td>Alert Fee</td>
                                    <td>0</td>
                                    <td>10</td>
                                    <td>10</td>
                                </tr>
                                <tr>
                                    <td>Sponsorship</td>
                                    <td>2</td>
                                    <td>2</td>
                                    <td>2</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="cost-note">
                            <p><strong>Note:</strong> Prices shown are in TRX. Current exchange rates apply. Law enforcement agencies receive service fee exemptions to support public service.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Benefits of Blockchain -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Why Use Blockchain for Legal Notices?</span>
                    </button>
                    <div class="faq-content">
                        <h4>What makes blockchain superior for legal service?</h4>
                        
                        <div class="benefit-grid">
                            <div class="benefit-card">
                                <i class="fas fa-shield-alt"></i>
                                <h5>Immutable Proof</h5>
                                <p>Once served, the record cannot be altered, deleted, or disputed. Perfect for court proceedings.</p>
                            </div>
                            
                            <div class="benefit-card">
                                <i class="fas fa-clock"></i>
                                <h5>Timestamped</h5>
                                <p>Automatic, cryptographic timestamps prove exact service time without relying on third parties.</p>
                            </div>
                            
                            <div class="benefit-card">
                                <i class="fas fa-globe"></i>
                                <h5>Global Access</h5>
                                <p>Serve notices to any wallet address worldwide, instantly, without geographical limitations.</p>
                            </div>
                            
                            <div class="benefit-card">
                                <i class="fas fa-check-double"></i>
                                <h5>Verifiable</h5>
                                <p>Anyone can independently verify service on the blockchain without accessing private systems.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Getting Started -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Getting Started Guide</span>
                    </button>
                    <div class="faq-content">
                        <h4>For Process Servers</h4>
                        <ol class="step-list">
                            <li>Install TronLink wallet and fund with TRX</li>
                            <li>Connect wallet to the application</li>
                            <li>Register as a Process Server (one-time setup)</li>
                            <li>Choose delivery option based on your needs</li>
                            <li>Upload document and enter recipient details</li>
                            <li>Review costs and confirm transaction</li>
                        </ol>
                        
                        <h4>For Recipients</h4>
                        <ol class="step-list">
                            <li>Check your wallet for new NFT notifications</li>
                            <li>Alert NFTs show preview in most wallets</li>
                            <li>Notice NFTs contain IPFS link to full document</li>
                            <li>Accept notice to confirm receipt (FREE - sponsored)</li>
                            <li>NFT serves as permanent proof of service</li>
                        </ol>
                        
                        <h4>For Law Enforcement</h4>
                        <p>Contact administration to register your agency wallet for service fee exemption. Provide official documentation for verification.</p>
                    </div>
                </div>
                
                <!-- Technical Details -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Technical Information</span>
                    </button>
                    <div class="faq-content">
                        <h4>Smart Contract Details</h4>
                        <ul>
                            <li><strong>Network:</strong> TRON (TRC-721 Standard)</li>
                            <li><strong>Multi-chain Support:</strong> Ethereum, Polygon, BSC (coming soon)</li>
                            <li><strong>Storage:</strong> IPFS for documents, on-chain for previews</li>
                            <li><strong>Verification:</strong> All transactions viewable on TronScan</li>
                        </ul>
                        
                        <h4>Security Features</h4>
                        <ul>
                            <li>Role-based access control (Admin, Server, User)</li>
                            <li>Cryptographic signatures for all transactions</li>
                            <li>Decentralized storage prevents single point of failure</li>
                            <li>Open source contract for transparency</li>
                        </ul>
                        
                        <div class="help-links" style="margin-top: 2rem;">
                            <a href="https://github.com/JGooseK41/NFTServiceApp" target="_blank" class="btn btn-secondary">
                                <i class="fas fa-code"></i> View Source Code
                            </a>
                            <a href="#" onclick="viewContractOnTronscan('legal')" class="btn btn-secondary">
                                <i class="fas fa-search"></i> View on TronScan
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Process Server FAQ -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Becoming a Process Server</span>
                    </button>
                    <div class="faq-content">
                        <h4>How to Register as a Process Server</h4>
                        
                        <div class="process-server-info">
                            <h5>Requirements:</h5>
                            <ul>
                                <li>Valid professional credentials (license number, certification, etc.)</li>
                                <li>Active TronLink wallet with TRX for transaction fees</li>
                                <li>Contact information for verification purposes</li>
                            </ul>
                            
                            <h5>Registration Process:</h5>
                            <ol class="step-list">
                                <li>Click "Become a Process Server" on the main dashboard</li>
                                <li>Fill out the registration form with your professional details</li>
                                <li>Provide your license/certification number</li>
                                <li>Submit contact information for verification</li>
                                <li>Wait for admin approval (typically 24-48 hours)</li>
                            </ol>
                            
                            <h5>Benefits of Registration:</h5>
                            <ul>
                                <li><strong>Professional Dashboard:</strong> Access to advanced serving features</li>
                                <li><strong>Batch Processing:</strong> Serve multiple notices efficiently</li>
                                <li><strong>Fee Discounts:</strong> Reduced service fees for verified servers</li>
                                <li><strong>Priority Support:</strong> Direct access to technical assistance</li>
                                <li><strong>Analytics:</strong> Track your service history and success rates</li>
                            </ul>
                            
                            <h5>Responsibilities:</h5>
                            <ul>
                                <li>Maintain accurate and up-to-date credentials</li>
                                <li>Follow all applicable laws and regulations</li>
                                <li>Ensure proper service of legal documents</li>
                                <li>Sponsor recipient fees when appropriate</li>
                            </ul>
                            
                            <div class="info-box" style="margin-top: 20px;">
                                <i class="fas fa-info-circle"></i>
                                <p>Need to register? <a href="#" onclick="openRegistrationForUser(); return false;">Click here to start the registration process</a></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTINUE TO PART 2 FOR MODALS -->
<!-- PART 2: ALL MODALS -->
    
    <!-- Processing Overlay -->
    <div id="processingOverlay" class="processing-overlay" style="display: none;">
        <div class="processing-card">
            <i class="fas fa-spinner loading-spinner" style="font-size: 3rem;"></i>
            <h3>Processing Transaction</h3>
            <p id="processingMessage">Please confirm the transaction in your wallet...</p>
            <div id="processingStatus"></div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-user-plus"></i>
                    Process Server Registration
                </h3>
                <button class="modal-close" onclick="closeRegistrationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Important:</strong> Registration requires admin approval. You'll be notified once approved.
                        <br><small style="margin-top: 0.5rem; display: block;">
                            <a href="#" onclick="closeRegistrationModal(); showTab('help'); setTimeout(() => { document.querySelector('.faq-header').parentElement.querySelectorAll('.faq-header')[document.querySelector('.faq-header').parentElement.querySelectorAll('.faq-header').length - 2].click(); }, 100); return false;">
                                Learn more about becoming a Process Server <i class="fas fa-external-link-alt"></i>
                            </a>
                        </small>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Agency/Company Name</label>
                    <input type="text" class="form-input" id="regAgency" 
                           placeholder="Enter your agency or company name">
                </div>
                <div class="form-group">
                    <label class="form-label">License/Certification Number</label>
                    <input type="text" class="form-input" id="regLicense" 
                           placeholder="Enter your professional license or certification number">
                    <p class="form-help">Required for verification of process server credentials</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Purpose/Use Case</label>
                    <textarea class="form-input" id="regPurpose" rows="3"
                             placeholder="Describe how you'll use the system"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Contact Email</label>
                    <input type="email" class="form-input" id="regEmail" 
                           placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-input" id="regPhone" 
                           placeholder="(555) 123-4567">
                    <p class="form-help">For verification purposes only</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Wallet Address</label>
                    <input type="text" class="form-input" id="regWallet" readonly>
                    <p class="form-help">This is your connected wallet address</p>
                </div>
                <button class="btn btn-primary" onclick="submitRegistration()">
                    <i class="fas fa-paper-plane"></i>
                    Submit Registration
                </button>
                <button class="btn btn-secondary" onclick="closeRegistrationModal()" style="margin-left: 0.5rem;">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <div id="registrationResult" style="margin-top: 1rem;"></div>
            </div>
        </div>
    </div>

    <!-- Registration Success Modal -->
    <div id="registrationSuccessModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    Registration Submitted
                </h3>
                <button class="modal-close" onclick="closeRegistrationSuccessModal()">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <i class="fas fa-user-check" style="font-size: 4rem; color: var(--success); margin-bottom: 1rem;"></i>
                <h4 style="margin-bottom: 1rem;">Your registration has been submitted successfully!</h4>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    An administrator will review your application and assign you a Server ID. 
                    You'll be notified once your registration is approved.
                </p>
                <button class="btn btn-primary" onclick="closeRegistrationSuccessModal()">
                    <i class="fas fa-check"></i>
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Mint Modal -->
    <div id="mintModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-upload"></i>
                    Create Legal Notice
                </h3>
                <button class="modal-close" onclick="closeMintModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Upload -->
                <div id="mintStep1">
                    <h4 style="margin-bottom: 1rem;">Step 1: Upload Document Image</h4>
                    <div class="alert alert-info" style="margin-bottom: 1rem;">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Document Requirements:</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                <li>Format: JPEG or PNG only</li>
                                <li>Recommended: 8.511" documents</li>
                                <li>Max file size: 400KB after compression</li>
                                <li>Documents will be automatically optimized for blockchain storage</li>
                                <li>High-resolution documents will be compressed to ensure transaction success</li>
                            </ul>
                        </div>
                    </div>
                    <div class="upload-area" id="uploadArea" onclick="event.target.id !== 'documentUpload' && document.getElementById('documentUpload').click()">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <h4>Click to upload legal document</h4>
                        <p style="color: var(--text-secondary);">Supports PDF, Word, JPEG and PNG</p>
                        <p style="color: var(--text-muted); font-size: 0.875rem;">Drag and drop also supported</p>
                        <input type="file" id="documentUpload" accept=".pdf,.doc,.docx,image/jpeg,image/jpg,image/png,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" onchange="handleDocumentUpload(event)" onclick="event.stopPropagation()">
                    </div>
                    <div id="compressionStatus" class="compression-status" style="display: none;">
                        <h5 style="color: var(--accent-blue); margin-bottom: 0.5rem;">
                            <i class="fas fa-compress"></i> Processing Document
                        </h5>
                        <div class="compression-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="compressionProgress" style="width: 0%;"></div>
                            </div>
                            <div class="progress-text" id="compressionText">0%</div>
                        </div>
                        <div id="compressionDetails" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);"></div>
                    </div>
                </div>

                <!-- Step 2: Details -->
                <div id="mintStep2" style="display: none;">
                    <h4 style="margin-bottom: 1rem;">Step 2: Legal Notice Details</h4>
                    
                    <div class="preview-container">
                        <div class="preview-image">
                            <img id="documentPreview" src="" alt="Document preview">
                            <button class="btn btn-secondary btn-small" style="margin-top: 0.5rem;" onclick="changeDocument()">
                                <i class="fas fa-exchange-alt"></i>
                                Change
                            </button>
                            <div id="uploadMetadata" class="upload-metadata" style="display: none;">
                                <h5>Document Info</h5>
                                <div class="metadata-item">
                                    <span>Original Size:</span>
                                    <strong id="originalSize">-</strong>
                                </div>
                                <div class="metadata-item">
                                    <span>Final Size:</span>
                                    <strong id="finalSize">-</strong>
                                </div>
                                <div class="metadata-item">
                                    <span>Compression:</span>
                                    <strong id="compressionRatio">-</strong>
                                </div>
                                <div class="metadata-item">
                                    <span>Format:</span>
                                    <strong id="fileFormat">-</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div class="preview-details">
                            <div class="form-group">
                                <label class="form-label">Recipient Address</label>
                                <input type="text" class="form-input" id="mintRecipient" 
                                       placeholder="Enter recipient's TRON address">
                                <div class="validation-message" id="recipientValidation" style="display: none;"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Token Name</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span id="tokenPrefix" style="background: #374151; padding: 0.75rem; border-radius: 0.375rem 0 0 0.375rem; border: 1px solid #4b5563; border-right: none; color: #9ca3af; font-family: monospace;">PS#?-</span>
                                    <input type="text" class="form-input" id="mintTokenName" 
                                           placeholder="Legal Notice" 
                                           style="border-radius: 0 0.375rem 0.375rem 0; flex: 1;">
                                </div>
                                <p class="form-help">Token name (will be prepended with your server ID, e.g., PS#1-Legal Notice)</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Case Number</label>
                                <input type="text" class="form-input" id="mintCaseNumber" 
                                       placeholder="e.g., CV-2024-001234">
                                <p class="form-help">Use your standard case numbering format</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Jurisdiction</label>
                                <select class="form-input" id="mintJurisdiction">
                                    <option value="0">Federal</option>
                                    <option value="1">State</option>
                                    <option value="2">County</option>
                                    <option value="3">Municipal</option>
                                    <option value="4">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Document Type</label>
                                <select class="form-input" id="mintDocumentType">
                                    <option value="0">Summons</option>
                                    <option value="1">Complaint</option>
                                    <option value="2">Subpoena</option>
                                    <option value="3">Notice of Hearing</option>
                                    <option value="4">Notice of Seizure</option>
                                    <option value="5">Other</option>
                                </select>
                            </div>
                            
                            <!-- Delivery Method Selection -->
                            <div class="form-group">
                                <label class="form-label">Delivery Method</label>
                                <div class="delivery-options">
                                    <label class="delivery-option selected">
                                        <input type="radio" name="deliveryMethod" value="document" checked>
                                        <div class="delivery-option-title">
                                            <i class="fas fa-file-shield"></i> Document Images
                                        </div>
                                        <div class="delivery-option-cost">~150 TRX</div>
                                        <div class="delivery-option-desc">
                                            <strong>Secure Legal Service:</strong> Encrypted document + public text notice
                                            <br><small> Document encrypted with recipient's wallet</small>
                                            <br><small> Requires signature for proof of service</small>
                                            <br><small> Text notice will be publicly visible</small>
                                        </div>
                                    </label>
                                    
                                    <label class="delivery-option">
                                        <input type="radio" name="deliveryMethod" value="text">
                                        <div class="delivery-option-title">
                                            <i class="fas fa-comment-alt"></i> Text Only
                                        </div>
                                        <div class="delivery-option-cost">~15 TRX</div>
                                        <div class="delivery-option-desc">
                                            <strong>Public Notice:</strong> Text message only, no documents
                                            <br><small> For reminders, preliminary notices</small>
                                            <br><small> No signature required (view only)</small>
                                            <br><small> All content will be publicly visible</small>
                                        </div>
                                    </label>
                                    
                                </div>
                            </div>
                            
                            <!-- Document Images Notice Details -->
                            <div class="view-gated-details" id="viewGatedDetails" style="display: block;">
                                <div class="alert alert-info" style="margin-bottom: 1rem; background: #fef3c7; border-color: #f59e0b; color: #92400e;">
                                    <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                                    <strong>Important Privacy Notice:</strong>
                                    <br> The document image will be encrypted and only viewable by the recipient
                                    <br> The text fields below will be <strong>publicly visible on the blockchain</strong>
                                    <br> Only include non-sensitive information in these text fields
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Notice Type</label>
                                    <select id="noticeType" class="form-select" onchange="updateNoticeTemplate()">
                                        <option value="Notice of Seizure">Notice of Seizure</option>
                                        <option value="Summons">Summons</option>
                                        <option value="Subpoena">Subpoena</option>
                                        <option value="Restraining Order">Restraining Order</option>
                                        <option value="Eviction Notice">Eviction Notice</option>
                                        <option value="Legal Hold">Legal Hold</option>
                                        <option value="Asset Freeze">Asset Freeze</option>
                                        <option value="Custom" selected>Custom Notice</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" id="customNoticeTypeGroup" style="display: block;">
                                    <label class="form-label">Custom Notice Type</label>
                                    <input type="text" id="customNoticeType" class="form-input" 
                                           placeholder="e.g., Notice of Forfeiture" maxlength="50">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Issuing Agency</label>
                                    <input type="text" id="issuingAgency" class="form-input" 
                                           placeholder="e.g., U.S. Department of Justice, IRS, SEC" 
                                           maxlength="100" required>
                                    <p class="form-help">Government agency or court issuing this notice</p>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Case Number</label>
                                    <input type="text" id="caseNumber" class="form-input" 
                                           placeholder="e.g., CV-2024-001234 or 24-CR-5678" 
                                           maxlength="50" required>
                                    <p class="form-help">Official case or docket number</p>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Specific Details / Amount</label>
                                    <input type="text" id="caseDetails" class="form-input" 
                                           placeholder="e.g., 245,000 USDT or Property at 123 Main St" 
                                           maxlength="100">
                                    <p class="form-help">Amount seized, property address, or other specifics</p>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Legal Rights Statement</label>
                                    <input type="text" id="legalRights" class="form-input" 
                                           placeholder="e.g., You have a right to contest this seizure" 
                                           maxlength="100"
                                           value="You have the right to contest this action">
                                    <p class="form-help">Inform recipient of their legal rights</p>
                                </div>
                                
                                <div class="form-group" style="background: #1e293b; padding: 1rem; border-radius: 0.5rem; border: 1px solid #334155;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <i class="fas fa-gift" style="color: #10b981;"></i>
                                        <span style="font-weight: 600;">Recipient Sponsorship Included</span>
                                    </div>
                                    <p class="form-help" style="margin: 0;">All notices include a 2 TRX sponsorship fee that covers the recipient's acceptance costs. This ensures recipients can always view their legal documents without needing TRX.</p>
                                </div>
                            </div>
                            
                            <!-- Text Notice Input -->
                            <div class="text-notice-input active" id="textNoticeGroup" style="display: block;">
                                <div class="form-group" style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem; border: 2px solid #f59e0b;">
                                    <label for="noticeText" id="noticeTextLabel">
                                        <i class="fas fa-globe" style="color: #f59e0b;"></i> Public Notice Text
                                    </label>
                                    <input type="text" class="form-input" id="noticeText" 
                                           placeholder="e.g., Legal Notice: Summons for Case #CV-2024-001234"
                                           maxlength="100"
                                           style="border: 2px solid #f59e0b;">
                                    <div class="char-count"><span id="charCount">0</span> / 100 characters</div>
                                    <p class="form-help" id="noticeTextHelp" style="color: #92400e; font-weight: 500;">
                                        <i class="fas fa-exclamation-circle"></i> This text will be publicly visible on the blockchain
                                    </p>
                                </div>
                            </div>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-coins"></i>
                                <div>
                                    <strong>Estimated Fee:</strong> <span id="creationFeeDisplay">150 TRX</span>
                                    <br><small id="feeDescription">Encrypted document with public text notice</small>
                                </div>
                            </div>
                            
                            <!-- Delivery Confirmation Options -->
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="requireDeliveryConfirmation" style="margin-right: 8px;">
                                    Require Delivery Confirmation
                                </label>
                                <p class="form-help">When enabled, you'll receive on-chain proof when the recipient accepts the notice</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fee Summary Display -->
                    <div id="feeSummaryBox" class="fee-summary-box" style="background: #1e293b; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid #334155; margin-top: 1.5rem;">
                        <h5 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-calculator" style="color: #3b82f6;"></i>
                            Total Cost Estimate
                        </h5>
                        <div class="fee-breakdown">
                            <div class="fee-item" style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #334155;">
                                <span id="feeTypeLabel">Document Notice Fee:</span>
                                <span id="baseFeeAmount" style="font-weight: 600;">150 TRX</span>
                            </div>
                            <div class="fee-item" style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #334155;">
                                <span>Recipient Sponsorship:</span>
                                <span style="font-weight: 600;">2 TRX</span>
                            </div>
                            <div class="fee-item" id="energyFeeItem" style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #334155;">
                                <span>Estimated Energy Cost:</span>
                                <span id="energyCostAmount" style="font-weight: 600; color: #f59e0b;">~90 TRX</span>
                            </div>
                            <div class="fee-total" style="display: flex; justify-content: space-between; padding: 0.75rem 0 0 0; font-size: 1.125rem;">
                                <span style="font-weight: 600;">Total Estimated Cost:</span>
                                <span id="totalCostAmount" style="font-weight: 700; color: #10b981;">~242 TRX</span>
                            </div>
                        </div>
                        <div class="fee-notes" style="margin-top: 1rem; font-size: 0.875rem; color: #94a3b8;">
                            <p id="energyNote" style="margin: 0.5rem 0;">
                                <i class="fas fa-info-circle"></i> Energy costs apply if you don't have staked TRX. 
                                <a href="https://tronscan.org/#/sr/representatives" target="_blank" style="color: #3b82f6;">Stake TRX</a> to avoid energy fees.
                            </p>
                            <p id="feeExemptionNote" style="margin: 0.5rem 0; display: none; color: #10b981;">
                                <i class="fas fa-check-circle"></i> <span id="exemptionText">Fee exemption applied</span>
                            </p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button class="btn btn-secondary" onclick="showMintStep(1)">
                            <i class="fas fa-arrow-left"></i>
                            Back
                        </button>
                        <button class="btn btn-primary" onclick="createLegalNotice()" id="createNoticeBtn">
                            <i class="fas fa-rocket"></i>
                            Create Legal Notice
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Result Modal -->
    <div id="transactionResultModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title" id="txResultTitle">
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    Transaction Complete
                </h3>
                <button class="modal-close" onclick="closeTransactionResultModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="txResultContent" style="padding: 1rem;">
                    <!-- Content will be dynamically populated -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeTransactionResultModal()">
                    <i class="fas fa-check"></i> Done
                </button>
            </div>
        </div>
    </div>

    <!-- Audit Modal -->
    <div id="auditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-clipboard-check"></i>
                    Notice Audit & Delivery Status
                </h3>
                <button class="modal-close" onclick="closeAuditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Search Options</label>
                    <select class="form-input" id="auditSearchType" onchange="updateAuditSearch()">
                        <option value="noticeId">By Notice ID</option>
                        <option value="myNotices">My Issued Notices</option>
                        <option value="myAlerts">My Alert Notices</option>
                    </select>
                </div>
                
                <div id="auditSearchInput" class="form-group">
                    <label class="form-label">Notice ID</label>
                    <input type="text" class="form-input" id="auditNoticeId" 
                           placeholder="Enter notice ID (e.g., 0, 1, 2...)">
                </div>
                
                <button class="btn btn-primary" onclick="performAudit()" id="performAuditBtn">
                    <i class="fas fa-search"></i>
                    Search
                </button>
                
                <div id="auditResults" style="margin-top: 2rem;"></div>
            </div>
        </div>
    </div>

    <!-- Accept Notice Modal -->
    <div id="acceptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-signature" style="color: #3b82f6;"></i>
                    Electronic Signature Required - Legal Notice Receipt
                </h3>
                <button class="modal-close" onclick="closeAcceptModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom: 1rem; background: #e0f2fe; border-color: #3b82f6;">
                    <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                    <div>
                        <strong>Electronic Signature Request</strong>
                        <p style="margin: 0.25rem 0 0 0;">By clicking "Sign Receipt" below, you are electronically signing that you have received this legal document. This is similar to signing for certified mail or a courier delivery.</p>
                        <p style="margin: 0.25rem 0 0 0; font-weight: 600;">Important: This signature only confirms receipt. It does NOT mean you agree with the contents, admit any wrongdoing, or waive any of your legal rights.</p>
                        <p style="margin: 0.5rem 0 0 0; color: #dc2626; font-weight: 600;">
                            <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                            Warning: Failing to respond to this legal notice by the deadline may result in default judgment against you.
                        </p>
                    </div>
                </div>
                
                <div id="acceptDetails" style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">Document Information</h4>
                    <div class="token-item">
                        <div class="token-details">
                            <div class="token-detail">
                                <span>Notice ID:</span>
                                <span id="acceptNoticeId">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Document Type:</span>
                                <span id="acceptDocumentType">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Jurisdiction:</span>
                                <span id="acceptJurisdiction">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Case Number Hash:</span>
                                <span id="acceptCaseNumber">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Server:</span>
                                <span id="acceptServer">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Timestamp:</span>
                                <span id="acceptTimestamp">-</span>
                            </div>
                        </div>
                        <div id="acceptPreview" class="token-preview" style="display: none;">
                            <img id="acceptPreviewImage" src="" alt="Document preview">
                        </div>
                    </div>
                </div>

                <div class="alert alert-warning" style="background: #fef3c7; border-color: #f59e0b;">
                    <i class="fas fa-file-signature" style="color: #d97706;"></i>
                    <div>
                        <strong>Legal Effect of Your Signature:</strong> Your electronic signature will be permanently recorded on the blockchain as proof that this document was delivered to you. This is legally equivalent to signing for certified mail and creates an immutable record of service.
                    </div>
                </div>

                <div style="margin-top: 1.5rem; display: flex; justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="closeAcceptModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="acceptNotice()" id="acceptNoticeBtn" style="background: #3b82f6; border-color: #3b82f6; padding: 0.75rem 1.5rem;">
                        <i class="fas fa-signature"></i>
                        Sign Receipt & Confirm Delivery
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Process Server Registration Modal -->
    <div id="registrationModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2><i class="fas fa-user-tie"></i> Process Server Registration</h2>
                <span class="close-btn" onclick="closeRegistrationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <i class="fas fa-info-circle"></i>
                    <strong>Note:</strong> The hybrid contract auto-assigns server IDs when roles are granted. 
                    Process servers cannot update their name/agency details after registration. 
                    Please ensure all information is correct before submitting.
                </div>
                <p style="margin-bottom: 1.5rem;">Please provide your professional information to complete process server registration. 
                <a href="#" onclick="closeRegistrationModal(); switchTab('help'); document.getElementById('faq-process-server').scrollIntoView();" style="color: var(--accent-blue);">
                    Learn more about being a process server 
                </a></p>
                
                <div class="form-group">
                    <label class="form-label">Agency Name *</label>
                    <input type="text" class="form-input" id="modalAgencyName" placeholder="e.g., Smith & Associates Process Service">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Agency Email *</label>
                    <input type="email" class="form-input" id="modalAgencyEmail" placeholder="agency@example.com">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Server Name *</label>
                    <input type="text" class="form-input" id="modalServerName" placeholder="Full name of process server">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" class="form-input" id="modalServerPhone" placeholder="(555) 123-4567">
                </div>
                
                <div class="form-group">
                    <label class="form-label">License Number</label>
                    <input type="text" class="form-input" id="modalLicenseNumber" placeholder="Optional: Professional license number">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Service Areas</label>
                    <textarea class="form-input" id="modalServiceAreas" rows="3" placeholder="List jurisdictions where you serve legal documents"></textarea>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Note:</strong> This information will be stored locally and associated with your wallet address for verification purposes.
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; display: flex; justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="closeRegistrationModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="submitAdminRegistration()">
                        <i class="fas fa-check"></i>
                        Complete Registration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Success Modal -->
    <div id="txModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    Transaction Successful
                </h3>
                <button class="modal-close" onclick="closeTxModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="txMessage" style="color: var(--text-primary); margin-bottom: 1rem;">
                    Your transaction has been successfully confirmed!
                </p>
                <div id="txDetails" style="margin-bottom: 1rem;"></div>
                <div class="tx-details">
                    <strong>Transaction Hash:</strong>
                    <div class="tx-hash" id="txHash"></div>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap;">
                <a id="txLink" href="#" target="_blank" class="btn btn-primary" style="text-decoration: none;">
                    <i class="fas fa-external-link-alt"></i>
                    View on Tronscan
                </a>
                <button class="btn btn-secondary" onclick="copyTxHash()">
                    <i class="fas fa-copy"></i>
                    Copy Hash
                </button>
                <button class="btn btn-secondary" onclick="exportReceipt()">
                    <i class="fas fa-print"></i>
                    Export Receipt
                </button>
                <button class="btn btn-secondary" onclick="closeTxModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- BEGIN JAVASCRIPT IN PART 3 -->
<!-- PART 3: JAVASCRIPT -->
    <script>
        // Configuration - Set your API keys here for production
        // Better approach: Use environment variables or server-side proxy
        
        // Pinata IPFS Configuration
        window.PINATA_CONFIG = {
            // Replace these with your actual Pinata API keys
            // Or leave empty to use localStorage configuration
            apiKey: '',
            secretKey: ''
        };
        
        // GitHub Storage Configuration
        window.GITHUB_STORAGE_CONFIG = {
            // Replace with your GitHub personal access token
            // Or leave empty to use localStorage configuration
            token: '',
            // IMPORTANT: Change this encryption key for security
            encryptionKey: 'NFTServiceApp-ProcessServer-SecureKey-2024'
        };
        
        // Global variables
        let tronWeb = null;
        let legalContract = null;
        let currentUserServerId = null;
        let isAdmin = false;
        let isProcessServer = false;
        
        // Server registration management
        let serverRegistrations = {};
        try {
            serverRegistrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
        } catch (e) {
            serverRegistrations = {};
        }
        let recentActivity = [];
        
        // Fee configuration
        let currentCreationFee = 0.1; // Default value in TRX
        
        // Document upload vars
        let uploadedImage = null;
        let uploadedFileInfo = null;
        let currentNoticeId = null;
        
        // Contract ABI - Complete ABI with all functions
        const CONTRACT_ABI = [
    {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "owner",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "approved",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "Approval",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "owner",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "operator",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "bool",
                "name": "approved",
                "type": "bool"
            }
        ],
        "name": "ApprovalForAll",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "_fromTokenId",
                "type": "uint256"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "_toTokenId",
                "type": "uint256"
            }
        ],
        "name": "BatchMetadataUpdate",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "_tokenId",
                "type": "uint256"
            }
        ],
        "name": "MetadataUpdate",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "uint256",
                "name": "noticeId",
                "type": "uint256"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "recipient",
                "type": "address"
            }
        ],
        "name": "NoticeAccepted",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "uint256",
                "name": "noticeId",
                "type": "uint256"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "recipient",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "sender",
                "type": "address"
            }
        ],
        "name": "NoticeCreated",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "bytes32",
                "name": "role",
                "type": "bytes32"
            },
            {
                "indexed": true,
                "internalType": "bytes32",
                "name": "previousAdminRole",
                "type": "bytes32"
            },
            {
                "indexed": true,
                "internalType": "bytes32",
                "name": "newAdminRole",
                "type": "bytes32"
            }
        ],
        "name": "RoleAdminChanged",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "bytes32",
                "name": "role",
                "type": "bytes32"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "account",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "sender",
                "type": "address"
            }
        ],
        "name": "RoleGranted",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "bytes32",
                "name": "role",
                "type": "bytes32"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "account",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "sender",
                "type": "address"
            }
        ],
        "name": "RoleRevoked",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "from",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "Transfer",
        "type": "event"
    },
    {
        "inputs": [],
        "name": "ADMIN_ROLE",
        "outputs": [
            {
                "internalType": "bytes32",
                "name": "",
                "type": "bytes32"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "DEFAULT_ADMIN_ROLE",
        "outputs": [
            {
                "internalType": "bytes32",
                "name": "",
                "type": "bytes32"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "PROCESS_SERVER_ROLE",
        "outputs": [
            {
                "internalType": "bytes32",
                "name": "",
                "type": "bytes32"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "noticeId",
                "type": "uint256"
            }
        ],
        "name": "acceptNotice",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "approve",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "owner",
                "type": "address"
            }
        ],
        "name": "balanceOf",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "components": [
                    {
                        "internalType": "address[]",
                        "name": "recipients",
                        "type": "address[]"
                    },
                    {
                        "internalType": "string",
                        "name": "publicText",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "metadata",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "documentData",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "tokenNamePrefix",
                        "type": "string"
                    },
                    {
                        "internalType": "bool",
                        "name": "hasDocument",
                        "type": "bool"
                    },
                    {
                        "internalType": "bool",
                        "name": "sponsorFees",
                        "type": "bool"
                    }
                ],
                "internalType": "struct LegalNoticeNFT_Optimized.BatchRequest",
                "name": "req",
                "type": "tuple"
            }
        ],
        "name": "createBatchNotices",
        "outputs": [
            {
                "internalType": "uint256[]",
                "name": "",
                "type": "uint256[]"
            }
        ],
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "components": [
                    {
                        "internalType": "address",
                        "name": "recipient",
                        "type": "address"
                    },
                    {
                        "internalType": "string",
                        "name": "publicText",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "noticeType",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "caseNumber",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "issuingAgency",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "baseTokenName",
                        "type": "string"
                    },
                    {
                        "internalType": "bool",
                        "name": "hasDocument",
                        "type": "bool"
                    },
                    {
                        "internalType": "string",
                        "name": "encryptedIPFS",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "encryptionKey",
                        "type": "string"
                    }
                ],
                "internalType": "struct LegalNoticeNFT_Optimized.NoticeRequest",
                "name": "req",
                "type": "tuple"
            }
        ],
        "name": "createNotice",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "creationFee",
        "outputs": [
            {
                "internalType": "uint128",
                "name": "",
                "type": "uint128"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "feeCollector",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "getApproved",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "noticeId",
                "type": "uint256"
            }
        ],
        "name": "getNotice",
        "outputs": [
            {
                "components": [
                    {
                        "internalType": "address",
                        "name": "recipient",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "sender",
                        "type": "address"
                    },
                    {
                        "internalType": "string",
                        "name": "documentData",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "publicText",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "metadata",
                        "type": "string"
                    },
                    {
                        "internalType": "uint256",
                        "name": "packedData",
                        "type": "uint256"
                    },
                    {
                        "internalType": "string",
                        "name": "tokenName",
                        "type": "string"
                    }
                ],
                "internalType": "struct LegalNoticeNFT_Optimized.Notice",
                "name": "",
                "type": "tuple"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "bytes32",
                "name": "role",
                "type": "bytes32"
            }
        ],
        "name": "getRoleAdmin",
        "outputs": [
            {
                "internalType": "bytes32",
                "name": "",
                "type": "bytes32"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "bytes32",
                "name": "role",
                "type": "bytes32"
            },
            {
                "internalType": "address",
                "name": "account",
                "type": "address"
            }
        ],
        "name": "grantRole",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "bytes32",
                "name": "role",
                "type": "bytes32"
            },
            {
                "internalType": "address",
                "name": "account",
                "type": "address"
            }
        ],
        "name": "hasRole",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "owner",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "operator",
                "type": "address"
            }
        ],
        "name": "isApprovedForAll",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "lawEnforcementAgencies",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "lawEnforcementExemptions",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "name",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "notices",
        "outputs": [
            {
                "internalType": "address",
                "name": "recipient",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "sender",
                "type": "address"
            },
            {
                "internalType": "string",
                "name": "documentData",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "publicText",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "metadata",
                "type": "string"
            },
            {
                "internalType": "uint256",
                "name": "packedData",
                "type": "uint256"
            },
            {
                "internalType": "string",
                "name": "tokenName",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "ownerOf",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "paused",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "processServers",
        "outputs": [
            {
                "internalType": "uint128",
                "name": "serverId",
                "type": "uint128"
            },
            {
                "internalType": "uint128",
                "name": "noticesServed",
                "type": "uint128"
            },
            {
                "internalType": "uint256",
                "name": "registeredDate",
                "type": "uint256"
            },
            {
                "internalType": "string",
                "name": "name",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "agency",
                "type": "string"
            },
            {
                "internalType": "bool",
                "name": "active",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "recipientNotices",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "bytes32",
                "name": "role",
                "type": "bytes32"
            },
            {
                "internalType": "address",
                "name": "account",
                "type": "address"
            }
        ],
        "name": "renounceRole",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "bytes32",
                "name": "role",
                "type": "bytes32"
            },
            {
                "internalType": "address",
                "name": "account",
                "type": "address"
            }
        ],
        "name": "revokeRole",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "from",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "safeTransferFrom",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "from",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            },
            {
                "internalType": "bytes",
                "name": "data",
                "type": "bytes"
            }
        ],
        "name": "safeTransferFrom",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "senderNotices",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "serverIdToAddress",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "serviceFee",
        "outputs": [
            {
                "internalType": "uint128",
                "name": "",
                "type": "uint128"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "operator",
                "type": "address"
            },
            {
                "internalType": "bool",
                "name": "approved",
                "type": "bool"
            }
        ],
        "name": "setApprovalForAll",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "user",
                "type": "address"
            },
            {
                "internalType": "string",
                "name": "agencyName",
                "type": "string"
            }
        ],
        "name": "setLawEnforcementExemption",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "sponsorshipFee",
        "outputs": [
            {
                "internalType": "uint128",
                "name": "",
                "type": "uint128"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "bytes4",
                "name": "interfaceId",
                "type": "bytes4"
            }
        ],
        "name": "supportsInterface",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "symbol",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "textOnlyFee",
        "outputs": [
            {
                "internalType": "uint128",
                "name": "",
                "type": "uint128"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "index",
                "type": "uint256"
            }
        ],
        "name": "tokenByIndex",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "owner",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "index",
                "type": "uint256"
            }
        ],
        "name": "tokenOfOwnerByIndex",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "tokenURI",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "totalSupply",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "from",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "transferFrom",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    }
];


async function getRecipientNoticeIds(recipient) {
    try {
        // The optimized contract may not have this function
        // We need to use events or enumerate through NFTs
        const balance = await legalContract.balanceOf(recipient).call();
        const noticeIds = [];
        
        for (let i = 0; i < balance; i++) {
            try {
                const tokenId = await legalContract.tokenOfOwnerByIndex(recipient, i).call();
                noticeIds.push(tokenId);
            } catch (e) {
                console.log('Error getting token at index', i, e);
            }
        }
        
        return noticeIds;
    } catch (error) {
        console.error('Error getting recipient notices:', error);
        return [];
    }
}


async function calculateFeeFromConstants(userAddress) {
    try {
        // Check if user is law enforcement exempt
        const isExempt = await legalContract.lawEnforcementExemptions(userAddress).call();
        
        // Get fee constants
        const serviceFee = await legalContract.serviceFee().call();
        const creationFee = await legalContract.creationFee().call();
        const sponsorshipFee = await legalContract.sponsorshipFee().call();
        
        if (isExempt) {
            // Law enforcement only pays creation + sponsorship
            return parseInt(creationFee) + parseInt(sponsorshipFee);
        } else {
            // Regular users pay all fees
            return parseInt(serviceFee) + parseInt(creationFee) + parseInt(sponsorshipFee);
        }
    } catch (error) {
        console.error('Error calculating fee:', error);
        // Default fee if calculation fails
        return 32000000; // 32 TRX default
    }
}

// Helper functions for parsing optimized contract data
function parseMetadata(metadata) {
    const parts = metadata.split('|');
    return {
        noticeType: parts[0] || '',
        caseNumber: parts[1] || '',
        issuingAgency: parts[2] || ''
    };
}

function parseDocumentData(documentData) {
    const parts = documentData.split('|');
    return {
        encryptedIPFS: parts[0] || '',
        encryptionKey: parts[1] || ''
    };
}

function parsePackedData(packedData) {
    const data = BigInt(packedData);
    return {
        timestamp: Number(data >> 192n),
        serverId: Number((data >> 64n) & 0xFFFFFFFFFFFFFFFFn),
        hasDocument: (data & 1n) === 1n,
        accepted: ((data >> 1n) & 1n) === 1n
    };
}


        
        // Get total notices from contract
        async function getTotalNotices() {
            if (!legalContract) return 0;
            
            try {
                const total = await legalContract.totalSupply().call();
                return parseInt(total);
            } catch (error) {
                console.log('Could not fetch total notices:', error);
                return 0;
            }
        }

        // Multi-chain configuration
        const CHAIN_CONFIG = {
            tron: {
                mainnet: {
                    name: 'TRON Mainnet',
                    contractAddress: window.APP_CONFIG?.contracts.tron.mainnet || 'TYour_Mainnet_Contract_Address',
                    explorerUrl: 'https://tronscan.org',
                    nativeToken: 'TRX',
                    chainId: null
                },
                nile: {
                    name: 'TRON Nile Testnet',
                    contractAddress: window.APP_CONFIG?.contracts.tron.nile || 'TEZxBmj16pKdsJh3aDE9Y4RLSuXuBuUSp8',
                    explorerUrl: 'https://nile.tronscan.org',
                    nativeToken: 'TRX',
                    chainId: null
                },
                shasta: {
                    name: 'TRON Shasta Testnet',
                    contractAddress: window.APP_CONFIG?.contracts.tron.shasta || 'TYour_Shasta_Contract_Address',
                    explorerUrl: 'https://shasta.tronscan.org',
                    nativeToken: 'TRX',
                    chainId: null
                }
            },
            evm: {
                ethereum: {
                    name: 'Ethereum Mainnet',
                    contractAddress: '0xYour_Ethereum_Contract_Address',
                    explorerUrl: 'https://etherscan.io',
                    nativeToken: 'ETH',
                    chainId: 1,
                    rpcUrl: 'https://eth-mainnet.g.alchemy.com/v2/YOUR_ALCHEMY_KEY'
                },
                sepolia: {
                    name: 'Ethereum Sepolia',
                    contractAddress: '0xYour_Sepolia_Contract_Address',
                    explorerUrl: 'https://sepolia.etherscan.io',
                    nativeToken: 'ETH',
                    chainId: 11155111,
                    rpcUrl: 'https://eth-sepolia.g.alchemy.com/v2/YOUR_ALCHEMY_KEY'
                },
                polygon: {
                    name: 'Polygon Mainnet',
                    contractAddress: '0xYour_Polygon_Contract_Address',
                    explorerUrl: 'https://polygonscan.com',
                    nativeToken: 'MATIC',
                    chainId: 137,
                    rpcUrl: 'https://polygon-rpc.com'
                },
                mumbai: {
                    name: 'Polygon Mumbai',
                    contractAddress: '0xYour_Mumbai_Contract_Address',
                    explorerUrl: 'https://mumbai.polygonscan.com',
                    nativeToken: 'MATIC',
                    chainId: 80001,
                    rpcUrl: 'https://rpc-mumbai.maticvigil.com'
                },
                bsc: {
                    name: 'BNB Smart Chain',
                    contractAddress: '0xYour_BSC_Contract_Address',
                    explorerUrl: 'https://bscscan.com',
                    nativeToken: 'BNB',
                    chainId: 56,
                    rpcUrl: 'https://bsc-dataseed.binance.org'
                },
                bscTestnet: {
                    name: 'BSC Testnet',
                    contractAddress: '0xYour_BSC_Testnet_Contract_Address',
                    explorerUrl: 'https://testnet.bscscan.com',
                    nativeToken: 'BNB',
                    chainId: 97,
                    rpcUrl: 'https://data-seed-prebsc-1-s1.binance.org:8545'
                }
            }
        };

        // Current chain state
        let currentChainType = 'tron'; // 'tron' or 'evm'
        let currentNetwork = 'nile'; // Default to Nile testnet where contract is deployed
        let web3Instance = null;
        let evmContract = null;

        // Enhanced UI Manager
        class UIManager {
            constructor() {
                this.notifications = [];
            }

            showNotification(type, message, duration = 5000) {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type} notification-enter`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                    <button class="notification-close" onclick="uiManager.removeNotification(this)"></button>
                `;
                
                document.body.appendChild(notification);
                this.notifications.push(notification);
                
                // Trigger animation
                setTimeout(() => {
                    notification.classList.remove('notification-enter');
                    notification.classList.add('notification-active');
                }, 10);
                
                // Auto-remove after duration
                setTimeout(() => {
                    this.removeNotification(notification);
                }, duration);
            }

            removeNotification(notification) {
                // If passed a button, get the parent notification
                if (notification.tagName === 'BUTTON') {
                    notification = notification.parentElement;
                }
                
                notification.classList.remove('notification-active');
                notification.classList.add('notification-exit');
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                    const index = this.notifications.indexOf(notification);
                    if (index > -1) {
                        this.notifications.splice(index, 1);
                    }
                }, 300);
            }

            updateStats(stats) {
                document.getElementById('totalNotices').textContent = stats.total || '0';
                document.getElementById('acceptedNotices').textContent = stats.accepted || '0';
                document.getElementById('pendingNotices').textContent = stats.pending || '0';
                document.getElementById('activeServers').textContent = stats.servers || '0';
                
                // Show stats container if hidden (but keep collapsed state)
                const statsContainer = document.getElementById('statsContainer');
                if (statsContainer.style.display === 'none') {
                    statsContainer.style.display = 'block';
                }
            }

            updateBadge(tab, count) {
                const badge = document.getElementById(`${tab}Badge`);
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }

            showLoader() {
                document.getElementById('loader').style.display = 'flex';
            }

            hideLoader() {
                const loader = document.getElementById('loader');
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                    loader.style.opacity = '1';
                }, 500);
            }
        }

        const uiManager = new UIManager();
// Use connected wallet address function
function useConnectedAddress() {
    if (tronWeb && tronWeb.defaultAddress) {
        document.getElementById('roleAddress').value = tronWeb.defaultAddress.base58;
        
        // Trigger validation if exists
        const event = new Event('input', { bubbles: true });
        document.getElementById('roleAddress').dispatchEvent(event);
        
        uiManager.showNotification('success', 'Connected wallet address inserted');
    } else {
        uiManager.showNotification('error', 'No wallet connected');
    }
}

// Use connected wallet address for fee collector
function useConnectedAddressForFeeCollector() {
    if (tronWeb && tronWeb.defaultAddress) {
        document.getElementById('feeCollectorAddress').value = tronWeb.defaultAddress.base58;
        
        // Trigger validation if exists
        const event = new Event('input', { bubbles: true });
        document.getElementById('feeCollectorAddress').dispatchEvent(event);
        
        uiManager.showNotification('success', 'Connected wallet address inserted');
    } else {
        uiManager.showNotification('error', 'No wallet connected');
    }
}
        // Handle chain change
        async function handleChainChange() {
            const chainSelector = document.getElementById('chainSelector');
            const selectedValue = chainSelector.value;
            const [chainType, network] = selectedValue.split('-');
            
            currentChainType = chainType;
            currentNetwork = network;
            
            // Update contract address field
            const config = CHAIN_CONFIG[chainType][network];
            const contractAddressField = document.getElementById('contractAddress');
            if (contractAddressField) {
                contractAddressField.value = config.contractAddress;
            }
            
            // Disconnect current wallet if connected
            if (window.tronWeb && window.tronWeb.ready && chainType === 'evm') {
                // Switching from TRON to EVM
                disconnectWallet();
            } else if (web3Instance && chainType === 'tron') {
                // Switching from EVM to TRON
                disconnectWallet();
            }
            
            uiManager.showNotification('info', `Switched to ${config.name}. Please connect your wallet.`);
        }

        // Connect Wallet function
        async function connectWallet() {
            const connectBtn = document.getElementById('connectBtn');
            
            if (currentChainType === 'tron') {
                await connectTronWallet();
            } else {
                await connectEVMWallet();
            }
        }

        // Connect TRON wallet
        async function connectTronWallet() {
            const connectBtn = document.getElementById('connectBtn');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const networkIndicator = document.getElementById('networkIndicator');
            const networkName = document.getElementById('networkName');

            try {
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<span class="loading-spinner"></span> Connecting...';

                // Check if TronWeb is available
                if (typeof window.tronWeb === 'undefined') {
                    throw new Error('TronLink not detected. Please install TronLink extension');
                }

                // Use recommended TronLink account request method
                try {
                    await window.tronLink.request({method: 'tron_requestAccounts'});
                } catch (error) {
                    throw new Error('Please unlock your TronLink wallet and grant permission');
                }

                // Wait for TronWeb to be ready
                let tries = 0;
                while (!window.tronWeb.ready && tries < 10) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    tries++;
                }

                if (!window.tronWeb.ready) {
                    throw new Error('Please unlock your TronLink wallet');
                }

                tronWeb = window.tronWeb;
                const address = tronWeb.defaultAddress.base58;

                // Update UI
                walletStatus.style.display = 'none';
                walletAddress.style.display = 'flex';
                
                const shortAddress = address.substring(0, 6) + '...' + address.substring(address.length - 4);
                document.getElementById('walletAddressText').textContent = shortAddress;
                
                // Get network name
                const fullNode = tronWeb.fullNode.host;
                let network = 'Unknown Network';
                
                if (fullNode.includes('trongrid.io') && !fullNode.includes('shasta') && !fullNode.includes('nile')) {
                    network = 'Mainnet';
                } else if (fullNode.includes('nile')) {
                    network = 'Nile Testnet';
                } else if (fullNode.includes('shasta')) {
                    network = 'Shasta Testnet';
                }
                
                networkName.textContent = network;
                networkIndicator.classList.add('connected');

                connectBtn.innerHTML = '<i class="fas fa-check"></i> Connected';
                connectBtn.classList.remove('btn-primary');
                connectBtn.classList.add('btn-success');

                // If registration modal is open, update wallet field
                const regWalletField = document.getElementById('regWallet');
                if (regWalletField) {
                    regWalletField.value = address;
                }

                // Hide welcome section
                document.getElementById('welcomeSection').style.display = 'none';

                uiManager.showNotification('success', `Connected to ${network}`);

                // Check if contract is already in the address field
                const contractAddressField = document.getElementById('contractAddress');
                if (contractAddressField && contractAddressField.value) {
                    // Automatically connect to contract after a short delay to ensure TronWeb is ready
                    setTimeout(async () => {
                        await connectContracts();
                    }, 1000); // 1 second delay
                }

            } catch (error) {
                console.error('Connection error:', error);
                
                connectBtn.innerHTML = '<i class="fas fa-link"></i> Connect';
                connectBtn.disabled = false;
                
                uiManager.showNotification('error', error.message || 'Failed to connect wallet');
            }
        }

        // Connect EVM wallet
        async function connectEVMWallet() {
            const connectBtn = document.getElementById('connectBtn');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const networkIndicator = document.getElementById('networkIndicator');
            const networkName = document.getElementById('networkName');

            try {
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<span class="loading-spinner"></span> Connecting...';

                // Check if MetaMask is available
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask not detected. Please install MetaMask extension');
                }

                // Create Web3 instance
                web3Instance = new Web3(window.ethereum);

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts found. Please unlock MetaMask');
                }

                const address = accounts[0];
                const chainId = await web3Instance.eth.getChainId();
                const config = CHAIN_CONFIG.evm[currentNetwork];

                // Check if on correct network
                if (Number(chainId) !== config.chainId) {
                    uiManager.showNotification('warning', `Please switch to ${config.name} in MetaMask`);
                    
                    // Try to switch network
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: web3Instance.utils.toHex(config.chainId) }],
                        });
                    } catch (switchError) {
                        // This error code indicates that the chain has not been added to MetaMask
                        if (switchError.code === 4902) {
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: web3Instance.utils.toHex(config.chainId),
                                        chainName: config.name,
                                        rpcUrls: [config.rpcUrl],
                                        blockExplorerUrls: [config.explorerUrl],
                                        nativeCurrency: {
                                            name: config.nativeToken,
                                            symbol: config.nativeToken,
                                            decimals: 18
                                        }
                                    }],
                                });
                            } catch (addError) {
                                throw new Error('Failed to add network to MetaMask');
                            }
                        } else {
                            throw switchError;
                        }
                    }
                }

                // Update UI
                walletStatus.style.display = 'none';
                walletAddress.style.display = 'flex';
                
                const shortAddress = address.substring(0, 6) + '...' + address.substring(address.length - 4);
                document.getElementById('walletAddressText').textContent = shortAddress;
                
                networkName.textContent = config.name;
                networkIndicator.classList.add('connected');

                connectBtn.innerHTML = '<i class="fas fa-check"></i> Connected';
                connectBtn.classList.remove('btn-primary');
                connectBtn.classList.add('btn-success');

                // Hide welcome section
                document.getElementById('welcomeSection').style.display = 'none';

                uiManager.showNotification('success', `Connected to ${config.name}`);

                // Connect to contract
                const contractAddressField = document.getElementById('contractAddress');
                if (contractAddressField && contractAddressField.value) {
                    await connectContracts();
                }

                // Listen for account changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        disconnectWallet();
                    } else {
                        window.location.reload();
                    }
                });

                // Listen for chain changes
                window.ethereum.on('chainChanged', () => {
                    window.location.reload();
                });

            } catch (error) {
                console.error('Connection error:', error);
                
                connectBtn.innerHTML = '<i class="fas fa-link"></i> Connect';
                connectBtn.disabled = false;
                
                uiManager.showNotification('error', error.message || 'Failed to connect wallet');
            }
        }

        // Disconnect wallet
        function disconnectWallet() {
            // Reset UI
            const connectBtn = document.getElementById('connectBtn');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const networkIndicator = document.getElementById('networkIndicator');
            const networkName = document.getElementById('networkName');
            
            walletStatus.style.display = 'block';
            walletStatus.textContent = 'Not Connected';
            walletAddress.style.display = 'none';
            networkName.textContent = 'Disconnected';
            networkIndicator.classList.remove('connected');
            
            connectBtn.innerHTML = '<i class="fas fa-link"></i> Connect';
            connectBtn.classList.remove('btn-success');
            connectBtn.classList.add('btn-primary');
            connectBtn.disabled = false;
            
            // Show welcome section
            document.getElementById('welcomeSection').style.display = 'block';
            
            // Reset contract connection
            legalContract = null;
            evmContract = null;
            web3Instance = null;
            tronWeb = null;
            
            // Hide contract status
            document.getElementById('contractsStatus').style.display = 'none';
            document.getElementById('contractAddress').disabled = false;
            
            // Reset contract connect button
            const contractConnectBtn = document.getElementById('connectContractBtn');
            if (contractConnectBtn) {
                contractConnectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect to Contract';
                contractConnectBtn.classList.remove('btn-success');
                contractConnectBtn.classList.add('btn-primary');
                contractConnectBtn.disabled = false;
            }
            
            uiManager.showNotification('info', 'Wallet disconnected');
        }

        // Tab switching function
        function switchTab(tabName) {
            // Check admin access before allowing admin tab
            if (tabName === 'admin' && !isAdmin) {
                uiManager.showNotification('error', 'Admin access required');
                return;
            }
            
            const tabs = ['user', 'delivery', 'admin', 'help'];
            
            tabs.forEach(tab => {
                const tabButton = document.querySelector(`[onclick="switchTab('${tab}')"]`);
                const tabContent = document.getElementById(`${tab}Tab`);
                
                if (tab === tabName) {
                    tabButton.classList.add('active');
                    tabContent.classList.add('active');
                } else {
                    tabButton.classList.remove('active');
                    tabContent.classList.remove('active');
                }
            });

            // Check admin access when switching to admin tab
            if (tabName === 'admin') {
                checkAdminAccess();
                refreshPendingRegistrations();
                updateStatsFromLocalStorage();
            }
            
            // Load delivery status when switching to delivery tab
            if (tabName === 'delivery') {
                refreshDeliveryStatus();
            }
        }

        // Toggle FAQ accordion sections
        function toggleFAQ(button) {
            const section = button.parentElement;
            const content = section.querySelector('.faq-content');
            const icon = button.querySelector('i');
            
            // Toggle active state
            button.classList.toggle('active');
            
            // Toggle content visibility
            if (content.style.display === 'block') {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-right';
            } else {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-down';
            }
        }

        // Check admin access
        async function checkAdminAccess() {
            const adminAccessDenied = document.getElementById('adminAccessDenied');
            const adminContent = document.getElementById('adminContent');
            
            if (!legalContract || !tronWeb.defaultAddress) {
                adminAccessDenied.style.display = 'block';
                adminContent.style.display = 'none';
                return;
            }
            
            if (isAdmin) {
                adminAccessDenied.style.display = 'none';
                adminContent.style.display = 'block';
                refreshPendingRegistrations();
                loadGitHubSettings();
            } else {
                adminAccessDenied.style.display = 'block';
                adminContent.style.display = 'none';
            }
        }

        // Modal functions
        function openRegistrationModal() {
            const modal = document.getElementById('registrationModal');
            modal.style.display = 'block';
            
            // Auto-fill wallet address if connected
            if (tronWeb && tronWeb.defaultAddress) {
                document.getElementById('regWallet').value = tronWeb.defaultAddress.base58;
            }
        }

        function closeRegistrationModal() {
            document.getElementById('registrationModal').style.display = 'none';
            clearRegistrationForm();
        }

        function clearRegistrationForm() {
            document.getElementById('regAgency').value = '';
            document.getElementById('regPurpose').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('registrationResult').innerHTML = '';
        }

        function closeRegistrationSuccessModal() {
            document.getElementById('registrationSuccessModal').style.display = 'none';
        }

        function dismissRegistrationNotice() {
            document.getElementById('registrationNotice').style.display = 'none';
        }

        async function openMintModal() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Please connect to contract first');
                return;
            }
            
            if (!isProcessServer && !isAdmin) {
                uiManager.showNotification('error', 'You need Process Server role to create notices');
                return;
            }
            
            const modal = document.getElementById('mintModal');
            modal.style.display = 'block';
            resetMintForm();
            
            // Update token prefix based on user role
            await updateTokenPrefix();
            
            // Update fee display based on actual contract calculation
            try {
                const userAddress = tronWeb.defaultAddress.base58;
                const fee = await calculateFeeFromConstants(userAddress);
                const feeInTrx = tronWeb.fromSun(fee);
                
                // Get specific fees for different notice types
                let documentFee, textFee;
                try {
                    const docFeeRaw = await legalContract.serviceFee().call();
                    const textFeeRaw = await legalContract.textOnlyFee().call();
                    documentFee = tronWeb.fromSun(docFeeRaw);
                    textFee = tronWeb.fromSun(textFeeRaw);
                } catch (e) {
                    // Fallback to single fee if new fee structure not available
                    documentFee = feeInTrx;
                    textFee = feeInTrx;
                }
                
                // Display fee based on current selection
                const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked')?.value || 'document';
                const baseFee = deliveryMethod === 'document' ? documentFee : textFee;
                const totalWithSponsorship = parseFloat(baseFee) + 2; // Add mandatory sponsorship
                
                document.getElementById('creationFeeDisplay').textContent = `${totalWithSponsorship} TRX (${deliveryMethod === 'document' ? 'Document' : 'Text Only'})`;
                
                // Check if user has fee exemptions
                const isLawEnforcement = await legalContract.lawEnforcementExemptions(userAddress).call();
                const agencyName = await legalContract.lawEnforcementAgencies(userAddress).call();
                
                if (isLawEnforcement) {
                    document.getElementById('feeDescription').textContent = `Law Enforcement (${agencyName}) - Cost only: Sponsorship (2 TRX)`;
                    document.getElementById('creationFeeDisplay').textContent = '2 TRX';
                } else if (hasRole(PROCESS_SERVER_ROLE, userAddress)) {
                    document.getElementById('feeDescription').textContent = 'Process Server: Creation fee + Sponsorship (2)';
                } else {
                    document.getElementById('feeDescription').textContent = 'Service fee + Sponsorship (2)';
                }
            } catch (error) {
                console.error('Error calculating fee:', error);
                document.getElementById('creationFeeDisplay').textContent = `${currentCreationFee} TRX`;
            }
        }

        function closeMintModal(force = false) {
            // Check if there's unsaved data
            const hasData = checkMintFormHasData();
            
            if (!force && hasData) {
                const confirmClose = confirm(
                    'You have unsaved data in this form. Are you sure you want to close and lose your progress?'
                );
                if (!confirmClose) {
                    return;
                }
            }
            
            document.getElementById('mintModal').style.display = 'none';
            resetMintForm();
        }
        
        // Check if mint form has data
        function checkMintFormHasData() {
            try {
                // Check if any form fields have data (with null checks)
                const recipientEl = document.getElementById('mintRecipient');
                const caseNumberEl = document.getElementById('mintCaseNumber');
                const jurisdictionEl = document.getElementById('mintJurisdiction');
                const documentTypeEl = document.getElementById('mintDocumentType');
                const issuingAgencyEl = document.getElementById('issuingAgency');
                const caseDetailsEl = document.getElementById('caseDetails');
                const noticeTextEl = document.getElementById('noticeTextInput');
                
                const recipient = recipientEl ? recipientEl.value.trim() : '';
                const caseNumber = caseNumberEl ? caseNumberEl.value.trim() : '';
                const jurisdiction = jurisdictionEl ? jurisdictionEl.value : '0';
                const documentType = documentTypeEl ? documentTypeEl.value : '0';
                const issuingAgency = issuingAgencyEl ? issuingAgencyEl.value.trim() : '';
                const caseDetails = caseDetailsEl ? caseDetailsEl.value.trim() : '';
                const noticeText = noticeTextEl ? noticeTextEl.value.trim() : '';
                
                // Check if image was uploaded
                const hasImage = uploadedImage !== null;
                
                // Return true if any field has data
                return recipient || caseNumber || (jurisdiction !== '0') || (documentType !== '0') || 
                       issuingAgency || caseDetails || noticeText || hasImage;
            } catch (error) {
                console.error('Error checking form data:', error);
                return false; // If error, assume no data
            }
        }

        function openAuditModal() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Please connect to contract first');
                return;
            }
            
            document.getElementById('auditModal').style.display = 'block';
        }

        function closeAuditModal() {
            document.getElementById('auditModal').style.display = 'none';
        }

        function closeTransactionResultModal() {
            document.getElementById('transactionResultModal').style.display = 'none';
        }

        function showTransactionResult(success, txData) {
            const modal = document.getElementById('transactionResultModal');
            const titleElement = document.getElementById('txResultTitle');
            const contentElement = document.getElementById('txResultContent');
            
            if (success) {
                titleElement.innerHTML = '<i class="fas fa-check-circle" style="color: var(--success);"></i> Transaction Successful';
                
                let content = '<div class="transaction-result-success">';
                content += '<div class="success-icon" style="text-align: center; margin-bottom: 1.5rem;">';
                content += '<i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success);"></i>';
                content += '</div>';
                
                // Transaction details
                content += '<div class="transaction-details" style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">';
                content += '<h4 style="margin-bottom: 1rem;">Transaction Details</h4>';
                
                if (txData.noticeId) {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Notice ID:</span>`;
                    content += `<strong>#${txData.noticeId}</strong>`;
                    content += `</div>`;
                }
                
                if (txData.txHash) {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Transaction Hash:</span>`;
                    content += `<a href="${getContractScanUrl()}tx/${txData.txHash}" target="_blank" style="color: var(--accent-blue);">`;
                    content += `${txData.txHash.substring(0, 10)}...${txData.txHash.substring(txData.txHash.length - 8)}`;
                    content += `</a>`;
                    content += `</div>`;
                }
                
                if (txData.recipient) {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Recipient:</span>`;
                    content += `<strong>${txData.recipient.substring(0, 10)}...${txData.recipient.substring(txData.recipient.length - 8)}</strong>`;
                    content += `</div>`;
                }
                
                content += '</div>';
                
                // Cost breakdown
                content += '<div class="cost-breakdown" style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem;">';
                content += '<h4 style="margin-bottom: 1rem;">Cost Breakdown</h4>';
                
                if (txData.feePaid !== undefined) {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Service Fee:</span>`;
                    content += `<strong>${txData.feePaid} TRX</strong>`;
                    content += `</div>`;
                }
                
                if (txData.energyUsed !== undefined) {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Energy Used:</span>`;
                    content += `<strong>${txData.energyUsed.toLocaleString()} (${(txData.energyUsed * 0.00042).toFixed(2)} TRX equivalent)</strong>`;
                    content += `</div>`;
                }
                
                if (txData.bandwidthUsed !== undefined) {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Bandwidth Used:</span>`;
                    content += `<strong>${txData.bandwidthUsed.toLocaleString()} (${(txData.bandwidthUsed * 0.001).toFixed(3)} TRX equivalent)</strong>`;
                    content += `</div>`;
                }
                
                const totalCost = (txData.feePaid || 0) + 
                                 ((txData.energyUsed || 0) * 0.00042) + 
                                 ((txData.bandwidthUsed || 0) * 0.001);
                
                content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-color); font-weight: bold;">`;
                content += `<span>Total Cost:</span>`;
                content += `<strong style="color: var(--accent-blue);">${totalCost.toFixed(3)} TRX</strong>`;
                content += `</div>`;
                
                content += '</div>';
                content += '</div>';
                
                contentElement.innerHTML = content;
            } else {
                titleElement.innerHTML = '<i class="fas fa-exclamation-circle" style="color: var(--error);"></i> Transaction Failed';
                
                let content = '<div class="transaction-result-error">';
                content += '<div class="error-icon" style="text-align: center; margin-bottom: 1.5rem;">';
                content += '<i class="fas fa-exclamation-circle" style="font-size: 4rem; color: var(--error);"></i>';
                content += '</div>';
                
                content += '<div class="error-details" style="background: #fef2f2; padding: 1rem; border-radius: 0.5rem; border: 1px solid #fecaca;">';
                content += '<p style="color: #991b1b; margin: 0;">' + (txData.error || 'Transaction failed. Please try again.') + '</p>';
                content += '</div>';
                
                content += '</div>';
                
                contentElement.innerHTML = content;
            }
            
            modal.style.display = 'block';
        }

        async function openAcceptModal(noticeId) {
            currentNoticeId = noticeId;
            
            // Fetch notice details
            try {
                const details = await getNoticeDetails(noticeId);
                if (details) {
                    document.getElementById('acceptNoticeId').textContent = noticeId;
                    document.getElementById('acceptDocumentType').textContent = getDocumentTypeString(details.documentType);
                    document.getElementById('acceptJurisdiction').textContent = getJurisdictionString(details.jurisdictionIndex);
                    document.getElementById('acceptCaseNumber').textContent = details.caseNumberHash || 'Not Available';
                    document.getElementById('acceptServer').innerHTML = createAddressDisplay(details.server);
                    document.getElementById('acceptTimestamp').textContent = new Date(parseInt(details.timestamp) * 1000).toLocaleString();
                    
                    // Preview images not implemented in simplified contract
                    document.getElementById('acceptPreview').style.display = 'none';
                    
                    // Check if this is a text-only notice (no document)
                    const isTextOnly = !details.documentId || details.documentId == 0;
                    
                    if (isTextOnly) {
                        // For text-only notices, just show the content, no signature required
                        uiManager.showNotification('info', 'This is a text-only notice. No signature required.');
                        viewTextNotice(noticeId);
                        return;
                    }
                    
                    document.getElementById('acceptModal').style.display = 'block';
                } else {
                    uiManager.showNotification('error', 'Failed to load notice details');
                }
            } catch (error) {
                console.error('Error loading notice:', error);
                uiManager.showNotification('error', 'Failed to load notice details');
            }
        }

        function closeAcceptModal() {
            document.getElementById('acceptModal').style.display = 'none';
            currentNoticeId = null;
        }
        
        // View text-only notice (no signature required)
        async function viewTextNotice(noticeId) {
            try {
                const details = await getNoticeDetails(noticeId);
                if (!details) {
                    uiManager.showNotification('error', 'Notice not found');
                    return;
                }
                
                // Show modal with text notice content
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2><i class="fas fa-comment-alt" style="color: #3b82f6;"></i> Text Notice</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info" style="background: #e0f2fe; border-color: #3b82f6;">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                                <strong>View Only Notice</strong>
                                <p style="margin: 0.25rem 0 0 0;">This is a text-only notice that does not require a signature.</p>
                            </div>
                            
                            <div class="notice-details" style="margin-top: 1rem;">
                                <div class="token-detail">
                                    <span>Notice ID:</span>
                                    <span>${noticeId}</span>
                                </div>
                                <div class="token-detail">
                                    <span>Type:</span>
                                    <span>${details.noticeType || 'Text Notice'}</span>
                                </div>
                                <div class="token-detail">
                                    <span>Sender:</span>
                                    <span>${createAddressDisplay(details.server)}</span>
                                </div>
                                <div class="token-detail">
                                    <span>Date:</span>
                                    <span>${new Date(parseInt(details.timestamp) * 1000).toLocaleString()}</span>
                                </div>
                                ${details.caseNumber ? `
                                <div class="token-detail">
                                    <span>Reference:</span>
                                    <span>${details.caseNumber}</span>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="notice-content" style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                                <h4>Notice Content:</h4>
                                <p style="margin-top: 0.5rem;">${details.caseDetails || details.noticeText || 'No content available'}</p>
                                ${details.legalRights ? `<p style="margin-top: 0.5rem; font-weight: 500;">${details.legalRights}</p>` : ''}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error viewing text notice:', error);
                uiManager.showNotification('error', 'Failed to load notice');
            }
        }

        function closeTxModal() {
            document.getElementById('txModal').style.display = 'none';
        }

        // Export printable receipt
        function exportReceipt() {
            if (!currentTransactionData) {
                uiManager.showNotification('error', 'No transaction data available');
                return;
            }
            
            const { txHash, message, timestamp, details, ipfsData, network } = currentTransactionData;
            
            // Create a new window for the printable receipt
            const receiptWindow = window.open('', '_blank', 'width=800,height=600');
            
            // Extract relevant data from details HTML
            let tokenName = '';
            let noticeId = 'N/A';
            let alertId = 'N/A';
            let recipient = '';
            let caseNumber = '';
            let jurisdiction = '';
            
            // Parse details HTML to extract values
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = details;
            const tokenDetails = tempDiv.querySelectorAll('.token-detail');
            tokenDetails.forEach(detail => {
                const spans = detail.querySelectorAll('span');
                if (spans.length >= 2) {
                    const label = spans[0].textContent;
                    const value = spans[1].textContent;
                    if (label.includes('Token Name')) tokenName = value;
                    if (label.includes('Notice ID')) noticeId = value;
                    if (label.includes('Alert ID')) alertId = value;
                    if (label.includes('Recipient')) recipient = value;
                    if (label.includes('Case Number')) caseNumber = value;
                    if (label.includes('Jurisdiction')) jurisdiction = value;
                }
            });
            
            // Generate receipt HTML
            const receiptHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Legal Notice Delivery Receipt</title>
                    <style>
                        @media print {
                            @page { margin: 0.5in; }
                            .no-print { display: none !important; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.6;
                            color: #333;
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 20px;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 2px solid #333;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        h1 {
                            margin: 0;
                            color: #1e3a8a;
                        }
                        .receipt-info {
                            background: #f5f5f5;
                            padding: 20px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        .info-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                            padding-bottom: 10px;
                            border-bottom: 1px dotted #ccc;
                        }
                        .info-row:last-child {
                            border-bottom: none;
                            margin-bottom: 0;
                        }
                        .label {
                            font-weight: bold;
                            color: #555;
                        }
                        .value {
                            color: #333;
                            word-break: break-all;
                        }
                        .verification-section {
                            background: #e8f4f8;
                            padding: 20px;
                            border-radius: 8px;
                            margin-top: 30px;
                        }
                        .verification-steps {
                            margin-top: 15px;
                            padding-left: 20px;
                        }
                        .verification-steps li {
                            margin-bottom: 10px;
                        }
                        .footer {
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 1px solid #ccc;
                            text-align: center;
                            font-size: 12px;
                            color: #666;
                        }
                        .print-button {
                            background: #1e3a8a;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 16px;
                            margin: 20px auto;
                            display: block;
                        }
                        .print-button:hover {
                            background: #1e40af;
                        }
                        .qr-placeholder {
                            width: 150px;
                            height: 150px;
                            border: 2px dashed #ccc;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 20px auto;
                            font-size: 12px;
                            color: #999;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Legal Notice Delivery Receipt</h1>
                        <p>Blockchain-Verified Service of Process</p>
                    </div>
                    
                    <div class="receipt-info">
                        <h2>Transaction Details</h2>
                        <div class="info-row">
                            <span class="label">Date & Time:</span>
                            <span class="value">${new Date(timestamp).toLocaleString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Transaction Hash:</span>
                            <span class="value" style="font-family: monospace; font-size: 12px;">${txHash}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Network:</span>
                            <span class="value">${network}</span>
                        </div>
                        ${tokenName ? `
                        <div class="info-row">
                            <span class="label">Token Name:</span>
                            <span class="value">${tokenName}</span>
                        </div>
                        ` : ''}
                        <div class="info-row">
                            <span class="label">Notice ID:</span>
                            <span class="value">${noticeId}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Alert ID:</span>
                            <span class="value">${alertId}</span>
                        </div>
                        ${recipient ? `
                        <div class="info-row">
                            <span class="label">Recipient:</span>
                            <span class="value">${recipient}</span>
                        </div>
                        ` : ''}
                        ${caseNumber ? `
                        <div class="info-row">
                            <span class="label">Case Number:</span>
                            <span class="value">${caseNumber}</span>
                        </div>
                        ` : ''}
                        ${ipfsData ? `
                        <div class="info-row">
                            <span class="label">IPFS Hash:</span>
                            <span class="value" style="font-family: monospace; font-size: 12px;">${ipfsData.ipfsHash}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${message && message.includes('Legal Notice Created') ? `
                    <div class="receipt-info" style="background: #f9fafb; border: 1px solid #e5e7eb;">
                        <h2>Service of Process Synopsis</h2>
                        ${(() => {
                            // Extract notice details from the transaction details
                            let noticeType = 'Legal Notice';
                            let issuingAgency = 'Not specified';
                            let caseNumber = '';
                            let caseDetails = window.lastTransactionCaseDetails || '';
                            let legalRights = '';
                            let recipientAddress = '';
                            let tokenName = '';
                            let noticeId = '';
                            let alertId = '';
                            
                            // Parse the details to extract information
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(details, 'text/html');
                            const detailElements = doc.querySelectorAll('.token-detail');
                            
                            detailElements.forEach(el => {
                                const spans = el.querySelectorAll('span');
                                if (spans.length >= 2) {
                                    const label = spans[0].textContent.trim();
                                    const value = spans[1].textContent.trim();
                                    
                                    if (label.includes('Token Name')) tokenName = value;
                                    if (label.includes('Recipient')) recipientAddress = value;
                                    if (label.includes('Notice ID')) noticeId = value;
                                    if (label.includes('Alert ID')) alertId = value;
                                }
                            });
                            
                            // Look for synopsis section in details
                            const synopsisSection = doc.querySelector('[style*="Service of Process Synopsis"]');
                            if (synopsisSection && synopsisSection.parentElement) {
                                const synopsisContent = synopsisSection.parentElement.textContent;
                                
                                // Extract values from synopsis
                                const noticeTypeMatch = synopsisContent.match(/Notice Type: ([^\\n]+)/);
                                if (noticeTypeMatch) noticeType = noticeTypeMatch[1].trim();
                                
                                const agencyMatch = synopsisContent.match(/Issuing Agency: ([^\\n]+)/);
                                if (agencyMatch) issuingAgency = agencyMatch[1].trim();
                                
                                const caseNumberMatch = synopsisContent.match(/Case Number: ([^\\n]+)/);
                                if (caseNumberMatch) caseNumber = caseNumberMatch[1].trim();
                                
                                const caseDetailsMatch = synopsisContent.match(/Case Details: ([^\\n]+)/);
                                if (caseDetailsMatch) caseDetails = caseDetailsMatch[1].trim();
                                
                                const rightsMatch = synopsisContent.match(/Legal Rights: ([^\\n]+)/);
                                if (rightsMatch) legalRights = rightsMatch[1].trim();
                            }
                            
                            return `
                            <div class="info-row">
                                <span class="label">Notice Type:</span>
                                <span class="value">${noticeType}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Issuing Agency:</span>
                                <span class="value">${issuingAgency}</span>
                            </div>
                            ${caseNumber && caseNumber !== 'Not specified' ? `
                            <div class="info-row">
                                <span class="label">Case Number:</span>
                                <span class="value">${caseNumber}</span>
                            </div>
                            ` : ''}
                            ${caseDetails && caseDetails !== 'See attached document' ? `
                            <div class="info-row">
                                <span class="label">Case Details:</span>
                                <span class="value">${caseDetails}</span>
                            </div>
                            ` : ''}
                            <div class="info-row">
                                <span class="label">Legal Rights:</span>
                                <span class="value">${legalRights || 'Recipient has the right to respond to this legal notice'}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Service Method:</span>
                                <span class="value">Electronic service via NFT delivery to TRON blockchain wallet</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Response Deadline:</span>
                                <span class="value">${new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString()} (30 days from service)</span>
                            </div>
                            
                            <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; padding: 15px; margin-top: 20px;">
                                <p style="margin: 0; font-size: 14px; color: #92400e;">
                                    <strong>Process Server Attestation:</strong> This receipt certifies that I have made diligent effort to notify the affected party at the blockchain address provided. The recipient has been served with notice that includes information about their legal rights and the requirement to respond within the statutory deadline to avoid default judgment or other negative effects on their property rights.
                                </p>
                            </div>
                            `;
                        })()}
                    </div>
                    ` : ''}
                    
                    <div class="verification-section">
                        <h3>Blockchain Verification Instructions</h3>
                        <p>This legal notice has been permanently recorded on the ${network.includes('Nile') ? 'TRON Nile Testnet' : 'TRON'} blockchain. To independently verify this transaction:</p>
                        
                        <ol class="verification-steps">
                            <li>Visit ${network.includes('Nile') ? 'https://nile.tronscan.org' : 'https://tronscan.org'}</li>
                            <li>In the search bar, paste this transaction hash: <br><code style="background: #f0f0f0; padding: 2px 5px; font-size: 12px;">${txHash}</code></li>
                            <li>Click "Search" or press Enter</li>
                            <li>Verify the following on the transaction page:
                                <ul>
                                    <li>Transaction status shows "Confirmed"</li>
                                    <li>The timestamp matches this receipt</li>
                                    <li>The contract interaction shows "serveNotice" method</li>
                                </ul>
                            </li>
                            ${ipfsData ? `<li>To view the original document:
                                <ul>
                                    <li>Visit https://gateway.pinata.cloud/ipfs/${ipfsData.ipfsHash}</li>
                                    <li>Or https://ipfs.io/ipfs/${ipfsData.ipfsHash}</li>
                                </ul>
                            </li>` : ''}
                        </ol>
                        
                        <p style="margin-top: 20px;"><strong>Note:</strong> The blockchain provides an immutable, tamper-proof record of this legal notice delivery. The transaction cannot be altered or deleted once confirmed.</p>
                    </div>
                    
                    <div class="no-print" style="display: flex; gap: 1rem; justify-content: center; margin: 2rem 0;">
                        <button class="print-button" onclick="window.print()">
                            <i class="fas fa-print"></i> Print Receipt
                        </button>
                        <button class="print-button" onclick="saveReceiptAsHTML()" style="background: #059669;">
                            <i class="fas fa-save"></i> Save Receipt
                        </button>
                    </div>
                    
                    <div class="footer">
                        <p>This receipt certifies that a legal notice was served via blockchain technology on ${new Date(timestamp).toLocaleDateString()}.</p>
                        <p>For questions about blockchain verification, consult with a technical expert or legal professional familiar with blockchain technology.</p>
                    </div>
                </body>
                </html>
            `;
            
            // Write the receipt HTML to the new window
            receiptWindow.document.write(receiptHTML);
            receiptWindow.document.close();
        }
        
        // Registration modal functions
        function closeRegistrationModal(force = false) {
            // Check if there's unsaved data
            const hasData = checkRegistrationFormHasData();
            
            if (!force && hasData) {
                const confirmClose = confirm(
                    'You have unsaved registration data. Are you sure you want to close and lose your progress?'
                );
                if (!confirmClose) {
                    return;
                }
            }
            
            document.getElementById('registrationModal').style.display = 'none';
            // Clear form
            document.getElementById('modalAgencyName').value = '';
            document.getElementById('modalAgencyEmail').value = '';
            document.getElementById('modalServerName').value = '';
            document.getElementById('modalServerPhone').value = '';
            document.getElementById('modalLicenseNumber').value = '';
            document.getElementById('modalServiceAreas').value = '';
        }
        
        // Check if registration form has data
        function checkRegistrationFormHasData() {
            const agency = document.getElementById('modalAgencyName').value.trim();
            const email = document.getElementById('modalAgencyEmail').value.trim();
            const name = document.getElementById('modalServerName').value.trim();
            const phone = document.getElementById('modalServerPhone').value.trim();
            const license = document.getElementById('modalLicenseNumber').value.trim();
            const areas = document.getElementById('modalServiceAreas').value.trim();
            
            return agency || email || name || phone || license || areas;
        }
        
        async function submitAdminRegistration() {
            // Get form values
            const agencyName = document.getElementById('modalAgencyName').value.trim();
            const agencyEmail = document.getElementById('modalAgencyEmail').value.trim();
            const serverName = document.getElementById('modalServerName').value.trim();
            const serverPhone = document.getElementById('modalServerPhone').value.trim();
            const licenseNumber = document.getElementById('modalLicenseNumber').value.trim();
            const serviceAreas = document.getElementById('modalServiceAreas').value.trim();
            
            // Validate required fields
            if (!agencyName || !agencyEmail || !serverName || !serverPhone) {
                uiManager.showNotification('error', 'Please fill in all required fields');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^s@]+@[^s@]+.[^s@]+$/;
            if (!emailRegex.test(agencyEmail)) {
                uiManager.showNotification('error', 'Please enter a valid email address');
                return;
            }
            
            // Save registration data
            const registrationData = {
                agencyName,
                agencyEmail,
                serverName,
                serverPhone,
                licenseNumber,
                serviceAreas,
                registeredAt: new Date().toISOString(),
                address: window.pendingProcessServerAddress,
                note: 'Hybrid contract - auto-assigned server ID upon role grant'
            };
            
            // Store in localStorage
            const serverRegistrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
            serverRegistrations[window.pendingProcessServerAddress] = registrationData;
            localStorage.setItem('serverRegistrations', JSON.stringify(serverRegistrations));
            
            // Show notification about the limitation
            uiManager.showNotification('info', 'Registration data saved locally. Server ID will be auto-assigned when role is granted. Note: Name/agency cannot be updated on-chain with the hybrid contract.');
            
            // Close modal
            closeRegistrationModal();
            
            // Continue with role granting
            await grantProcessServerRole(
                window.pendingProcessServerAddress,
                window.pendingLawEnforcementExempt,
                window.pendingAgencyName
            );
        }
        
                async function grantProcessServerRole(address, lawEnforcementExempt, agencyName) {
            try {
                showProcessing('Granting Process Server role...');
                
                const roleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                
                // Grant the role
                await legalContract.grantRole(roleBytes, address).send({
                    feeLimit: 20_000_000,
                    shouldPollResponse: true
                });
                
                // Set law enforcement exemption if requested
                if (lawEnforcementExempt && agencyName) {
                    showProcessing('Setting law enforcement exemption...');
                    await legalContract.setLawEnforcementExemption(address, agencyName).send({
                        feeLimit: 20_000_000,
                        shouldPollResponse: true
                    });
                }
                
                hideProcessing();
                
                let message = 'Process Server role granted';
                if (lawEnforcementExempt) {
                    message += ' with law enforcement exemption (' + agencyName + ')';
                }
                
                showAlert('roleResult', 'success', message);
                
                // Clear form
                document.getElementById('roleAddress').value = '';
                document.getElementById('lawEnforcementExempt').checked = false;
                document.getElementById('lawEnforcementAgencyName').value = '';
                
            } catch (error) {
                hideProcessing();
                console.error('Error:', error);
                showAlert('roleResult', 'error', 'Failed: ' + getErrorMessage(error));
            }
        }

        // Function for regular users to open registration
        function openRegistrationForUser() {
            if (!tronWeb || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect your wallet first');
                return;
            }
            
            // Check if already a process server
            checkIfProcessServer().then(isServer => {
                if (isServer) {
                    uiManager.showNotification('info', 'You are already registered as a process server');
                    return;
                }
                
                // Set the user's own address
                window.pendingProcessServerAddress = tronWeb.defaultAddress.base58;
                window.pendingServiceFeeExempt = false;
                window.pendingFullFeeExempt = false;
                
                // Show the registration modal
                document.getElementById('registrationModal').style.display = 'flex';
            });
        }
        
        async function checkIfProcessServer() {
            if (!legalContract || !tronWeb.defaultAddress) return false;
            
            try {
                const roleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                return await legalContract.hasRole(roleBytes, tronWeb.defaultAddress.base58).call();
            } catch (error) {
                console.error('Error checking process server role:', error);
                return false;
            }
        }
        
        // Update token prefix based on process server status
        async function updateTokenPrefix() {
            if (!legalContract || !tronWeb.defaultAddress) return;
            
            try {
                // Check if user is a process server
                const isProcessServer = await checkIfProcessServer();
                const prefixElement = document.getElementById('tokenPrefix');
                
                if (isProcessServer) {
                    // Get server info to find their ID
                    // Note: Hybrid contract auto-assigns server IDs but doesn't support on-chain name/agency updates
                    const serverInfo = await legalContract.processServers(tronWeb.defaultAddress.base58).call();
                    // The optimized contract returns: [serverId, noticesServed, registeredDate, name, agency, active]
                    const serverId = serverInfo[0] || serverInfo.serverId;
                    const noticesServed = serverInfo[1] || serverInfo.noticesServed;
                    const registeredDate = serverInfo[2] || serverInfo.registeredDate;
                    const name = serverInfo[3] || serverInfo.name;
                    const agency = serverInfo[4] || serverInfo.agency;
                    const active = serverInfo[5] || serverInfo.active;
                    
                    if (serverId && serverInfo.serverId.toString() !== '0') {
                    detailsHtml += `<div style="margin-top: 0.5rem;"><strong>Process Server Info:</strong></div>`;
                    detailsHtml += `<div style="margin-left: 1rem;">Server ID: <strong>${serverInfo[0] || serverInfo.serverId || '0'}</strong></div>`;
                    if (serverInfo.name) {
                        detailsHtml += `<div style="margin-left: 1rem;">Name: ${serverInfo.name}</div>`;
                    }
                    if (serverInfo.agency) {
                        detailsHtml += `<div style="margin-left: 1rem;">Agency: ${serverInfo.agency}</div>`;
                    }
                    detailsHtml += `<div style="margin-left: 1rem;">Notices Served: ${serverInfo.noticesServed || '0'}</div>`;
                    
                    // Update the server ID display at the top
                    const serverIdDisplay = document.getElementById('serverIdDisplay');
                    const userServerIdSpan = document.getElementById('userServerId');
                    if (serverIdDisplay && userServerIdSpan) {
                        serverIdDisplay.style.display = 'block';
                        userServerIdSpan.textContent = (serverInfo[0] || serverInfo.serverId || '0').toString().padStart(2, '0');
                    }
                }
            } catch (e) {
                console.error('Error getting process server info:', e);
            }
        }
        
        // Check local registration status (for pending registrations)
        const serverRegistrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
        const localReg = serverRegistrations[address];
        if (localReg && localReg.status === 'pending') {
            detailsHtml += `<div style="margin-top: 0.5rem;"><strong>Pending Registration:</strong></div>`;
            detailsHtml += `<div style="margin-left: 1rem;">Status: Awaiting approval</div>`;
        }
        
        detailsHtml += '</div>';
        roleDetails.innerHTML = detailsHtml;
        
    } catch (error) {
        console.error('Error updating wallet status:', error);
        document.getElementById('roleCheckDetails').innerHTML = '<span style="color: var(--error);">Error checking roles: ' + error.message + '</span>';
    }
}

// Refresh wallet status
async function refreshWalletStatus() {
    const refreshBtn = event.target;
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner loading-spinner"></i> Refreshing...';
    
    try {
        await updateWalletStatus();
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Status';
    } catch (error) {
        console.error('Error refreshing status:', error);
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Status';
    } finally {
        refreshBtn.disabled = false;
    }
}

// Check user roles
async function checkUserRoles() {
    if (!legalContract || !tronWeb.defaultAddress) return;
    
    try {
                // Check DEFAULT_ADMIN_ROLE (0x00) first, then ADMIN_ROLE
                const defaultAdminRole = '0x0000000000000000000000000000000000000000000000000000000000000000';
                const adminRoleBytes = tronWeb.sha3('ADMIN_ROLE');
                const processServerRoleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                
                // Check if user has DEFAULT_ADMIN_ROLE or ADMIN_ROLE
                const hasDefaultAdminRole = await legalContract.hasRole(defaultAdminRole, tronWeb.defaultAddress.base58).call();
                const hasAdminRole = await legalContract.hasRole(adminRoleBytes, tronWeb.defaultAddress.base58).call();
                isAdmin = hasDefaultAdminRole || hasAdminRole;
                
                console.log('Admin role check:', { 
                    address: tronWeb.defaultAddress.base58,
                    hasDefaultAdminRole,
                    hasAdminRole,
                    isAdmin
                });
                isProcessServer = await legalContract.hasRole(processServerRoleBytes, tronWeb.defaultAddress.base58).call();
                
                // Update admin tab visibility
                updateAdminTabVisibility();
                
                // Check fee exemption status
                const isLawEnforcement = await legalContract.lawEnforcementExemptions(tronWeb.defaultAddress.base58).call();
                const serviceFeeExempt = isLawEnforcement;
                const fullFeeExempt = isLawEnforcement;
                
                // Update fee status display
                const feeStatusElement = document.getElementById('feeExemptStatus');
                if (feeStatusElement) {
                    if (fullFeeExempt) {
                        feeStatusElement.innerHTML = '<span class="badge badge-success">Full Exempt</span>';
                    } else if (serviceFeeExempt) {
                        feeStatusElement.innerHTML = '<span class="badge badge-primary">Service Fee Exempt</span>';
                    } else {
                        feeStatusElement.innerHTML = '<span class="badge badge-warning">Not Exempt</span>';
                    }
                }
                
                // Enable admin-only buttons if user is admin
                const updateFeeBtn = document.getElementById('updateFeeBtn');
                const updateFeeCollectorBtn = document.getElementById('updateFeeCollectorBtn');
                if (updateFeeBtn) updateFeeBtn.disabled = !isAdmin;
                if (updateFeeCollectorBtn) updateFeeCollectorBtn.disabled = !isAdmin;
                
                // Update UI based on roles
                const registrationNotice = document.getElementById('registrationNotice');
                if (registrationNotice) {
                    if (!isProcessServer && !isAdmin) {
                        registrationNotice.style.display = 'flex';
                    } else {
                        registrationNotice.style.display = 'none';
                    }
                }
                
                // Show server ID if assigned
                if (isProcessServer || isAdmin) {
                    const userServerId = document.getElementById('userServerId');
                    const serverIdDisplay = document.getElementById('serverIdDisplay');
                    
                    // Get server ID from registration data
                    const serverData = serverRegistrations[tronWeb.defaultAddress.base58];
                    if (serverData && serverData.serverId) {
                        if (userServerId) userServerId.textContent = serverData.serverId.split('-').pop();
                    } else {
                        if (userServerId) userServerId.textContent = '0000';
                    }
                    
                    if (serverIdDisplay) serverIdDisplay.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error checking roles:', error);
            }
        }

        // Global variable to store current transaction data for receipt
        let currentTransactionData = null;

        // Transaction modal
        function showTxModal(txHash, message, details = '', ipfsData = null) {
            const modal = document.getElementById('txModal');
            const txHashElement = document.getElementById('txHash');
            const txMessage = document.getElementById('txMessage');
            const txLink = document.getElementById('txLink');
            const txDetails = document.getElementById('txDetails');
            
            txMessage.textContent = message || 'Your transaction has been successfully confirmed!';
            txHashElement.textContent = txHash;
            
            // Store transaction data for receipt export
            currentTransactionData = {
                txHash: txHash,
                message: message,
                timestamp: new Date().toISOString(),
                details: details,
                ipfsData: ipfsData,
                network: document.getElementById('networkName')?.textContent || 'Unknown'
            };
            
            // Build enhanced details with IPFS info if available
            let enhancedDetails = details;
            if (ipfsData && ipfsData.ipfsHash) {
                const ipfsPreview = `
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <h4 style="margin-bottom: 0.75rem; color: var(--text-primary);">NFT Document</h4>
                        ${ipfsData.imageUrl ? `
                            <div style="margin-bottom: 1rem;">
                                <img src="${ipfsData.imageUrl}" 
                                     style="max-width: 100%; max-height: 300px; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                     onclick="window.open('${ipfsData.imageUrl}', '_blank')" 
                                     title="Click to view full size" />
                            </div>
                        ` : ''}
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                            <a href="https://gateway.pinata.cloud/ipfs/${ipfsData.ipfsHash}" target="_blank" class="btn btn-secondary btn-small">
                                <i class="fas fa-image"></i> View on Pinata
                            </a>
                            <a href="https://ipfs.io/ipfs/${ipfsData.ipfsHash}" target="_blank" class="btn btn-secondary btn-small">
                                <i class="fas fa-globe"></i> View on IPFS.io
                            </a>
                        </div>
                        <div class="token-detail">
                            <span>IPFS Hash:</span>
                            <span style="font-family: monospace; font-size: 0.875rem;">${ipfsData.ipfsHash}</span>
                        </div>
                    </div>
                `;
                enhancedDetails = details + ipfsPreview;
            }
            
            // Add contract address link if available
            const contractAddressField = document.getElementById('contractAddress');
            const contractAddress = contractAddressField ? contractAddressField.value : null;
            if (contractAddress) {
                const contractLink = `
                    <div style="margin-top: 0.75rem;">
                        <div class="token-detail">
                            <span>Contract:</span>
                            <span>
                                <a href="${getContractScanUrl(contractAddress)}" target="_blank" style="color: var(--accent-blue); text-decoration: none;">
                                    ${contractAddress.substring(0, 10)}...${contractAddress.substring(contractAddress.length - 8)}
                                    <i class="fas fa-external-link-alt" style="font-size: 0.75rem; margin-left: 0.25rem;"></i>
                                </a>
                            </span>
                        </div>
                    </div>
                `;
                enhancedDetails += contractLink;
            }
            
            txDetails.innerHTML = enhancedDetails;
            
            // Get network for Tronscan link
            const network = document.getElementById('networkName').textContent;
            let tronscanUrl = 'https://tronscan.org/#/transaction/';
            
            if (network.includes('Nile')) {
                tronscanUrl = 'https://nile.tronscan.org/#/transaction/';
            } else if (network.includes('Shasta')) {
                tronscanUrl = 'https://shasta.tronscan.org/#/transaction/';
            }
            
            txLink.href = tronscanUrl + txHash;
            modal.style.display = 'block';
        }

        function copyTxHash() {
            const txHashElement = document.getElementById('txHash');
            const txHash = txHashElement.textContent;
            
            navigator.clipboard.writeText(txHash).then(() => {
                uiManager.showNotification('success', 'Transaction hash copied to clipboard');
            }).catch(err => {
                console.error('Failed to copy:', err);
                uiManager.showNotification('error', 'Failed to copy transaction hash');
            });
        }

        // Helper function to get contract explorer URL
        function getContractScanUrl(address) {
            if (!address) {
                const contractAddressField = document.getElementById('contractAddress');
                address = contractAddressField ? contractAddressField.value : null;
            }
            const network = document.getElementById('networkName')?.textContent || 'Mainnet';
            let explorerUrl = 'https://tronscan.org';
            
            if (network.includes('Nile')) {
                explorerUrl = 'https://nile.tronscan.org';
            } else if (network.includes('Shasta')) {
                explorerUrl = 'https://shasta.tronscan.org';
            }
            
            return `${explorerUrl}/#/contract/${address}`;
        }

        function viewContractOnTronscan(type) {
            let address;
            if (type === 'legal') {
                address = document.getElementById('contractAddress').value;
            }
            
            if (!address) {
                uiManager.showNotification('error', 'No contract address available');
                return;
            }
            
            const config = CHAIN_CONFIG[currentChainType][currentNetwork];
            let explorerUrl;
            
            if (currentChainType === 'tron') {
                explorerUrl = `${config.explorerUrl}/#/contract/${address}`;
            } else {
                explorerUrl = `${config.explorerUrl}/address/${address}`;
            }
            
            window.open(explorerUrl, '_blank');
        }

        function viewOnTronscan(type, id) {
            const network = document.getElementById('networkName').textContent;
            let tronscanUrl;
            
            if (type === 'notice') {
                const contractAddress = document.getElementById('contractAddress').value;
                
                if (network.includes('Nile')) {
                    tronscanUrl = `https://nile.tronscan.org/#/token721/${contractAddress}/token/${id}`;
                } else if (network.includes('Shasta')) {
                    tronscanUrl = `https://shasta.tronscan.org/#/token721/${contractAddress}/token/${id}`;
                } else {
                    tronscanUrl = `https://tronscan.org/#/token721/${contractAddress}/token/${id}`;
                }
            } else {
                if (network.includes('Nile')) {
                    tronscanUrl = `https://nile.tronscan.org/#/transaction/${id}`;
                } else if (network.includes('Shasta')) {
                    tronscanUrl = `https://shasta.tronscan.org/#/transaction/${id}`;
                } else {
                    tronscanUrl = `https://tronscan.org/#/transaction/${id}`;
                }
            }
            
            window.open(tronscanUrl, '_blank');
        }

        function viewOnIPFS(ipfsHash) {
            // Use a public IPFS gateway
            const ipfsUrl = `https://ipfs.io/ipfs/${ipfsHash}`;
            window.open(ipfsUrl, '_blank');
        }

        // Recent activity functions
        function addRecentActivity(type, description, details = {}) {
            const activity = {
                type,
                description,
                details,
                timestamp: new Date()
            };
            
            recentActivity.unshift(activity);
            
            // Keep only last 10 activities
            if (recentActivity.length > 10) {
                recentActivity = recentActivity.slice(0, 10);
            }
            
            updateRecentActivityDisplay();
        }

        function updateRecentActivityDisplay() {
            const activityDiv = document.getElementById('recentActivityContent');
            
            if (recentActivity.length === 0) {
                activityDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard"></i>
                        <h3>No recent activity</h3>
                        <p>Your recent transactions will appear here</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="token-list">';
            
            recentActivity.forEach(activity => {
                const icon = getActivityIcon(activity.type);
                const timeAgo = getTimeAgo(activity.timestamp);
                
                html += `
                    <div class="token-item" style="padding: 0.75rem 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <i class="${icon}" style="color: var(--accent-blue); font-size: 1.25rem;"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${escapeHtml(activity.description)}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${timeAgo}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            activityDiv.innerHTML = html;
        }

        function getActivityIcon(type) {
            const icons = {
                'create': 'fas fa-file-upload',
                'accept': 'fas fa-check-circle',
                'registration': 'fas fa-user-plus',
                'approval': 'fas fa-user-check',
                'role': 'fas fa-user-shield',
                'admin': 'fas fa-cog'
            };
            
            return icons[type] || 'fas fa-circle';
        }

        // Helper functions
        function formatAddress(address) {
            if (!address) return 'N/A';
            return address.substring(0, 8) + '...' + address.substring(address.length - 6);
        }
        
        // Server registration helper functions
        function generateServerId() {
            const year = new Date().getFullYear();
            const count = Object.keys(serverRegistrations).length + 1;
            return `PS-${year}-${String(count).padStart(4, '0')}`;
        }
        
        function saveServerRegistration(address, data) {
            serverRegistrations[address] = data;
            try {
                localStorage.setItem('serverRegistrations', JSON.stringify(serverRegistrations));
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }
        
        function exportRegistrations() {
            const data = Object.values(serverRegistrations);
            if (data.length === 0) {
                uiManager.showNotification('info', 'No server registrations to export');
                return;
            }
            
            // Convert to CSV
            const headers = ['Server ID', 'Address', 'Agency Name', 'Agency Email', 'Server Name', 'Phone', 'Registered At', 'Registered By', 'Fee Exempt'];
            const csvData = [
                headers.join(','),
                ...data.map(reg => [
                    reg.serverId,
                    reg.address,
                    `"${reg.agencyName}"`,
                    reg.agencyEmail,
                    `"${reg.serverName}"`,
                    reg.serverPhone,
                    reg.registeredAt,
                    reg.registeredBy,
                    reg.feeExempt ? 'Yes' : 'No'
                ].join(','))
            ].join('\n');
            
            // Download file
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `process_servers_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            uiManager.showNotification('success', `Exported ${data.length} server registration(s)`);
        }
        
        // Toggle registration form visibility
        function toggleRegistrationForm() {
            const roleSelect = document.getElementById('roleSelect');
            const registrationForm = document.getElementById('serverRegistrationForm');
            const lawEnforcementSection = document.getElementById('lawEnforcementSection');
            
            if (registrationForm) {
                registrationForm.style.display = roleSelect.value === 'PROCESS_SERVER_ROLE' ? 'block' : 'none';
            }
            
            // Always show law enforcement section for any role
            if (lawEnforcementSection) {
                lawEnforcementSection.style.display = 'block';
            }
        }
        
        // Toggle stats section
        function toggleStats() {
            console.log('Toggle stats called');
            const statsSection = document.getElementById('statsSection');
            const toggleIcon = document.getElementById('statsToggleIcon');
            
            if (!statsSection || !toggleIcon) {
                console.error('Stats elements not found:', { statsSection, toggleIcon });
                return;
            }
            
            if (statsSection.style.display === 'none' || statsSection.style.display === '') {
                statsSection.style.display = 'grid';
                toggleIcon.className = 'fas fa-chevron-up';
            } else {
                statsSection.style.display = 'none';
                toggleIcon.className = 'fas fa-chevron-down';
            }
        }
        
        // Toggle wallet status section
        function toggleWalletStatus() {
            console.log('Toggle wallet status called');
            const walletContent = document.getElementById('walletStatusContent');
            const toggleIcon = document.getElementById('walletToggleIcon');
            
            if (!walletContent || !toggleIcon) {
                console.error('Wallet elements not found:', { walletContent, toggleIcon });
                return;
            }
            
            console.log('Current display:', walletContent.style.display);
            
            if (walletContent.style.display === 'none' || walletContent.style.display === '') {
                walletContent.style.display = 'block';
                toggleIcon.className = 'fas fa-chevron-up';
                console.log('Expanded wallet status');
            } else {
                walletContent.style.display = 'none';
                toggleIcon.className = 'fas fa-chevron-down';
                console.log('Collapsed wallet status');
            }
        }
        
        // Toggle contract section
        function toggleContract() {
            console.log('Toggle contract called');
            const contractContent = document.getElementById('contractContent');
            const toggleIcon = document.getElementById('contractToggleIcon');
            
            if (!contractContent || !toggleIcon) {
                console.error('Contract elements not found:', { contractContent, toggleIcon });
                return;
            }
            
            if (contractContent.style.display === 'none' || contractContent.style.display === '') {
                contractContent.style.display = 'block';
                toggleIcon.className = 'fas fa-chevron-up';
            } else {
                contractContent.style.display = 'none';
                toggleIcon.className = 'fas fa-chevron-down';
            }
        }
        
        // Get current network based on chain type
        function getCurrentNetwork() {
            // For TRON, we're using Nile testnet by default
            // You could add logic here to detect mainnet vs testnet
            return 'nile';
        }
        
        // Create address display with copy and TronScan link
        function createAddressDisplay(address, showFull = false) {
            if (!address || address === 'N/A') return 'N/A';
            
            const displayAddress = showFull ? address : formatAddress(address);
            const network = currentChainType === 'tron' ? getCurrentNetwork() : 'mainnet';
            const explorerUrl = CHAIN_CONFIG[currentChainType][network].explorerUrl;
            
            return `
                <span class="address-display">
                    <span class="address-text">${displayAddress}</span>
                    <button class="btn-icon-small" onclick="copyAddress('${address}')" title="Copy address">
                        <i class="fas fa-copy"></i>
                    </button>
                    <a href="${explorerUrl}/#/address/${address}" target="_blank" class="btn-icon-small" title="View on explorer">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </span>
            `;
        }
        
        // Copy address to clipboard
        function copyAddress(address) {
            navigator.clipboard.writeText(address).then(() => {
                uiManager.showNotification('success', 'Address copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                uiManager.showNotification('error', 'Failed to copy address');
            });
        }

        function getDocumentTypeString(docType) {
            const documentTypes = [
                'Summons',
                'Complaint',
                'Subpoena',
                'Notice of Hearing',
                'Notice of Seizure',
                'Other'
            ];
            return documentTypes[docType] || 'Unknown';
        }

        function getJurisdictionString(jurisdictionIndex) {
            const jurisdictions = [
                'Federal',
                'State',
                'County',
                'Municipal',
                'Other'
            ];
            return jurisdictions[jurisdictionIndex] || 'Unknown';
        }
        
        function getContractScanUrl() {
            const network = document.getElementById('networkName').textContent;
            let baseUrl = 'https://tronscan.org/#/contract/';
            
            if (network.includes('Nile')) {
                baseUrl = 'https://nile.tronscan.org/#/contract/';
            } else if (network.includes('Shasta')) {
                baseUrl = 'https://shasta.tronscan.org/#/contract/';
            }
            
            return baseUrl + (legalContract ? legalContract.address : '');
        }

        function getStatusString(status) {
            const statuses = [
                'Pending',
                'Served',
                'Accepted',
                'Expired',
                'Cancelled'
            ];
            return statuses[status] || 'Unknown';
        }

        function getTimeRemaining(timestamp) {
            const created = new Date(parseInt(timestamp) * 1000);
            const expires = new Date(created.getTime() + (7 * 24 * 60 * 60 * 1000)); // 7 days
            const now = new Date();
            
            if (now > expires) {
                return '<span style="color: var(--error);">Expired</span>';
            }
            
            const diff = expires - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            if (days > 0) {
                return `${days} day${days > 1 ? 's' : ''} ${hours} hour${hours > 1 ? 's' : ''}`;
            } else if (hours > 0) {
                return `${hours} hour${hours > 1 ? 's' : ''}`;
            } else {
                return '<span style="color: var(--warning);">Less than 1 hour</span>';
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function calculateBase64Size(base64String) {
            // Calculate approximate size of base64 string
            const padding = (base64String.charAt(base64String.length - 2) === '=') ? 2 :
                           (base64String.charAt(base64String.length - 1) === '=') ? 1 : 0;
            return (base64String.length * 3) / 4 - padding;
        }

        function getErrorMessage(error) {
            if (error.message) {
                if (error.message.includes('revert')) {
                    const revertReason = error.message.split('revert')[1].trim();
                    return 'Transaction reverted: ' + revertReason;
                } else if (error.message.includes('User rejected')) {
                    return 'Transaction cancelled by user';
                } else if (error.message.includes('insufficient')) {
                    return 'Insufficient balance or energy';
                } else if (error.message.includes('Not authorized')) {
                    return 'You need Process Server role to perform this action';
                } else {
                    return error.message;
                }
            }
            return 'An unknown error occurred';
        }

        // Copy wallet address function
        function copyWalletAddress() {
            const address = tronWeb.defaultAddress.base58;
            navigator.clipboard.writeText(address).then(() => {
                uiManager.showNotification('success', 'Address copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                uiManager.showNotification('error', 'Failed to copy address');
            });
        }

        // Validation functions
        function validateRecipientAddress() {
            const input = document.getElementById('mintRecipient');
            const validationMsg = document.getElementById('recipientValidation');
            const address = input.value.trim();
            
            if (!address) {
                input.classList.remove('valid', 'invalid');
                validationMsg.style.display = 'none';
                return;
            }
            
            if (tronWeb.isAddress(address)) {
                input.classList.remove('invalid');
                input.classList.add('valid');
                validationMsg.className = 'validation-message success';
                validationMsg.innerHTML = '<i class="fas fa-check-circle"></i> Valid TRON address';
                validationMsg.style.display = 'flex';
            } else {
                input.classList.remove('valid');
                input.classList.add('invalid');
                validationMsg.className = 'validation-message error';
                validationMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Invalid TRON address';
                validationMsg.style.display = 'flex';
            }
        }

        // Update admin tab visibility based on admin status
        function updateAdminTabVisibility() {
            const adminTabButton = document.getElementById('adminTabButton');
            if (adminTabButton) {
                adminTabButton.style.display = isAdmin ? 'inline-flex' : 'none';
            }
        }

        // Debug function to check roles and registrations
        async function debugCheckRoles() {
            const debugDiv = document.getElementById('debugOutput');
            const debugContent = document.getElementById('debugContent');
            
            if (!legalContract || !tronWeb || !tronWeb.defaultAddress) {
                debugContent.innerHTML = '<span style="color: var(--error);">Contract not connected or wallet not connected</span>';
                debugDiv.style.display = 'block';
                return;
            }
            
            debugContent.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking roles and registrations...';
            debugDiv.style.display = 'block';
            
            try {
                const address = tronWeb.defaultAddress.base58;
                let debugInfo = '<div style="font-family: monospace; font-size: 0.8rem;">';
                let plainTextDebug = ''; // For copying
                
                debugInfo += `<strong>Your Address:</strong> ${address}<br><br>`;
                plainTextDebug += `Your Address: ${address}\n\n`;
                
                // Check roles
                const adminRoleBytes = tronWeb.sha3('ADMIN_ROLE');
                const processServerRoleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                
                const hasAdminRole = await legalContract.hasRole(adminRoleBytes, address).call();
                const hasProcessServerRole = await legalContract.hasRole(processServerRoleBytes, address).call();
                
                debugInfo += `<strong>Roles:</strong><br>`;
                debugInfo += `- Admin Role: ${hasAdminRole ? ' YES' : ' NO'}<br>`;
                debugInfo += `- Process Server Role: ${hasProcessServerRole ? ' YES' : ' NO'}<br><br>`;
                
                plainTextDebug += `Roles:\n`;
                plainTextDebug += `- Admin Role: ${hasAdminRole ? 'YES' : 'NO'}\n`;
                plainTextDebug += `- Process Server Role: ${hasProcessServerRole ? 'YES' : 'NO'}\n\n`;
                
                // Check fee exemptions
                const isLawEnforcement = await legalContract.lawEnforcementExemptions(address).call();
                const serviceFeeExempt = isLawEnforcement;
                const fullFeeExempt = isLawEnforcement;
                
                debugInfo += `<strong>Fee Exemptions:</strong><br>`;
                debugInfo += `- Service Fee Exempt: ${serviceFeeExempt ? ' YES' : ' NO'}<br>`;
                debugInfo += `- Full Fee Exempt: ${fullFeeExempt ? ' YES' : ' NO'}<br><br>`;
                
                plainTextDebug += `Fee Exemptions:\n`;
                plainTextDebug += `- Service Fee Exempt: ${serviceFeeExempt ? 'YES' : 'NO'}\n`;
                plainTextDebug += `- Full Fee Exempt: ${fullFeeExempt ? 'YES' : 'NO'}\n\n`;
                
                // Calculate actual fee
                const calculatedFee = await calculateFeeFromConstants(address);
                debugInfo += `<strong>Your Fee:</strong> ${tronWeb.fromSun(calculatedFee)} TRX<br><br>`;
                plainTextDebug += `Your Fee: ${tronWeb.fromSun(calculatedFee)} TRX\n\n`;
                
                // Check localStorage registrations
                const localRegs = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
                const yourReg = localRegs[address];
                
                debugInfo += `<strong>Local Registration:</strong><br>`;
                plainTextDebug += `Local Registration:\n`;
                
                if (yourReg) {
                    debugInfo += `- Status: ${yourReg.status}<br>`;
                    debugInfo += `- Server ID: ${yourReg.serverId || 'Not assigned'}<br>`;
                    debugInfo += `- Agency: ${yourReg.agencyName || yourReg.agency}<br>`;
                    
                    plainTextDebug += `- Status: ${yourReg.status}\n`;
                    plainTextDebug += `- Server ID: ${yourReg.serverId || 'Not assigned'}\n`;
                    plainTextDebug += `- Agency: ${yourReg.agencyName || yourReg.agency}\n`;
                } else {
                    debugInfo += `- No registration found for ${address}<br>`;
                    debugInfo += `- All keys in localStorage: ${Object.keys(localRegs).join(', ') || 'None'}<br>`;
                    
                    plainTextDebug += `- No registration found for ${address}\n`;
                    plainTextDebug += `- All keys in localStorage: ${Object.keys(localRegs).join(', ') || 'None'}\n`;
                }
                
                debugInfo += '</div>';
                
                debugContent.innerHTML = debugInfo;
                
                // Store plain text for copying
                window.debugInfoPlainText = plainTextDebug;
                
                // Check if we need to show the fix button
                const fixBtn = document.getElementById('fixExemptionBtn');
                if ((hasProcessServerRole && !serviceFeeExempt && !fullFeeExempt && yourReg && yourReg.status === 'approved') || 
                    (hasAdminRole && !fullFeeExempt)) {
                    // User has role but no exemptions - show fix button
                    fixBtn.style.display = 'inline-flex';
                    if (hasAdminRole && !fullFeeExempt) {
                        debugInfo += '<br><div style="color: var(--warning); font-weight: bold;"> Admin accounts should have full fee exemption! Click "Fix Exemption" to apply it.</div>';
                    } else {
                        debugInfo += '<br><div style="color: var(--warning); font-weight: bold;"> Fee exemptions not applied! Click "Fix Exemption" to apply them.</div>';
                    }
                    debugContent.innerHTML = debugInfo + '</div>';
                } else {
                    fixBtn.style.display = 'none';
                }
                
                // Also refresh the main wallet status
                await updateWalletStatus();
                
            } catch (error) {
                console.error('Debug check error:', error);
                debugContent.innerHTML = `<span style="color: var(--error);">Error: ${error.message}</span>`;
                window.debugInfoPlainText = `Error: ${error.message}`;
            }
        }
        
        // Copy debug info to clipboard
        function copyDebugInfo() {
            if (window.debugInfoPlainText) {
                navigator.clipboard.writeText(window.debugInfoPlainText).then(() => {
                    uiManager.showNotification('success', 'Debug info copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    uiManager.showNotification('error', 'Failed to copy to clipboard');
                });
            }
        }
        
        // Fix fee exemption for approved process servers
        async function fixMyFeeExemption() {
            if (!legalContract || !tronWeb || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet and contract first');
                return;
            }
            
            const fixBtn = document.getElementById('fixExemptionBtn');
            fixBtn.disabled = true;
            fixBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fixing...';
            
            try {
                const address = tronWeb.defaultAddress.base58;
                
                // Check if user has admin role
                const adminRoleBytes = tronWeb.sha3('ADMIN_ROLE');
                const isAdmin = await legalContract.hasRole(adminRoleBytes, address).call();
                
                if (!isAdmin) {
                    uiManager.showNotification('error', 'You need admin role to fix exemptions. Contact an admin.');
                    return;
                }
                
                // Check if user is admin (reuse the check from above)
                const hasAdminRole = isAdmin;
                
                // Get registration info (not required for admins)
                const localRegs = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
                const yourReg = localRegs[address];
                
                if (!hasAdminRole && !yourReg) {
                    uiManager.showNotification('error', 'No registration found for your address');
                    return;
                }
                
                // Determine exemption type based on role and registration
                let serviceFeeExempt = false;
                let fullFeeExempt = false;
                
                if (hasAdminRole) {
                    // Admins always get full fee exemption
                    serviceFeeExempt = true;
                    fullFeeExempt = true;
                    uiManager.showNotification('info', 'Applying full fee exemption for admin...');
                } else if (yourReg) {
                    // Process servers get exemptions based on registration
                    serviceFeeExempt = yourReg.serviceFeeExempt !== false;
                    fullFeeExempt = yourReg.fullFeeExempt === true;
                    uiManager.showNotification('info', 'Applying fee exemptions...');
                } else {
                    uiManager.showNotification('error', 'No registration found and not an admin');
                    return;
                }
                
                // Apply the fee exemptions
                await legalContract.setFeeExemption(address, serviceFeeExempt, fullFeeExempt).send({
                    feeLimit: 20_000_000,
                    shouldPollResponse: true
                });
                
                uiManager.showNotification('success', 'Fee exemptions applied successfully!');
                
                // Refresh debug info
                await debugCheckRoles();
                
            } catch (error) {
                console.error('Fix exemption error:', error);
                uiManager.showNotification('error', 'Failed to apply exemptions: ' + error.message);
            } finally {
                fixBtn.disabled = false;
                fixBtn.innerHTML = '<i class="fas fa-wrench"></i> Fix Exemption';
            }
        }

        // Check contract resources (energy and bandwidth)
        async function checkContractResources() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            const statusDiv = document.getElementById('contractResourceStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking contract resources...';
            
            try {
                const contractAddress = legalContract.address;
                const account = await tronWeb.trx.getAccount(contractAddress);
                const resources = await tronWeb.trx.getAccountResources(contractAddress);
                
                // Calculate energy details
                const totalEnergy = resources.EnergyLimit || 0;
                const usedEnergy = resources.EnergyUsed || 0;
                const availableEnergy = totalEnergy - usedEnergy;
                const energyPerNotice = 500000;  // Updated to match actual usage
                const noticesAvailable = Math.floor(availableEnergy / energyPerNotice);
                
                // Calculate TRX staked for energy
                const frozenForEnergy = account.account_resource?.frozen_balance_for_energy?.frozen_balance || 0;
                const stakedTRX = tronWeb.fromSun(frozenForEnergy);
                
                // Get delegated energy info
                const delegatedEnergy = resources.EnergyLimit - (resources.EnergyUsed || 0);
                
                let html = `
                    <h4>Contract Resources</h4>
                    <div style="margin-top: 0.5rem;">
                        <strong>Contract Address:</strong> ${contractAddress}
                    </div>
                    <div style="margin-top: 1rem;">
                        <strong>Energy Status:</strong>
                        <div style="margin-left: 1rem; margin-top: 0.5rem;">
                            - Total Energy: ${totalEnergy.toLocaleString()}<br>
                            - Used Energy: ${usedEnergy.toLocaleString()}<br>
                            - Available Energy: ${availableEnergy.toLocaleString()}<br>
                            - Notices Available: ${noticesAvailable} (at ~500k energy each)<br>
                            - TRX Staked for Energy: ${stakedTRX} TRX
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <strong>Recommendations:</strong>
                        <div style="margin-left: 1rem; margin-top: 0.5rem;">
                `;
                
                if (noticesAvailable < 10) {
                    html += `<div style="color: var(--warning);"> Low energy! Consider delegating more energy to support user transactions.</div>`;
                } else {
                    html += `<div style="color: var(--success);"> Sufficient energy for ${noticesAvailable} notices</div>`;
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                statusDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error checking resources:', error);
                statusDiv.innerHTML = '<div style="color: var(--error);">Error checking resources: ' + error.message + '</div>';
            }
        }
        
        // Show delegate energy modal
        function showDelegateEnergyModal() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            // For now, show instructions
            const modal = confirm(
                'Energy Delegation Instructions:\n\n' +
                '1. Visit tronscan.org\n' +
                '2. Connect your wallet\n' +
                '3. Go to "Stake 2.0" section\n' +
                '4. Select "Delegate Resource"\n' +
                '5. Enter contract address: ' + legalContract.address + '\n' +
                '6. Choose "Energy" resource type\n' +
                '7. Enter amount to delegate (10,000 TRX = ~250k energy/day)\n\n' +
                'Would you like to copy the contract address?'
            );
            
            if (modal) {
                navigator.clipboard.writeText(legalContract.address).then(() => {
                    uiManager.showNotification('success', 'Contract address copied to clipboard!');
                });
            }
        }
        
        // Energy rental configuration
        const ENERGY_RENTAL_CONFIG = {
            // TRONSave API for energy rental
            apiUrl: 'https://api.tronsave.io/v0/order/energy',
            // Energy required per notice (increased based on actual usage)
            energyPerNotice: 500000,  // Increased from 250k to 500k
            // Buffer to ensure enough energy (20% extra)
            energyBuffer: 1.2,
            // Maximum rental price in TRX per 100k energy
            maxPricePerUnit: 15,
            // Rental duration in hours
            rentalDuration: 1,
            // Minimum energy to trigger rental
            minEnergyThreshold: 50000
        };
        
        // Check if energy rental is needed
        async function checkEnergyNeeded(requiredEnergy) {
            try {
                const resources = await tronWeb.trx.getAccountResources(tronWeb.defaultAddress.base58);
                const availableEnergy = (resources.EnergyLimit || 0) - (resources.EnergyUsed || 0);
                
                console.log('Energy check:', {
                    required: requiredEnergy,
                    available: availableEnergy,
                    needsRental: availableEnergy < requiredEnergy
                });
                
                if (availableEnergy < requiredEnergy) {
                    return requiredEnergy - availableEnergy;
                }
                return 0;
            } catch (error) {
                console.error('Error checking energy:', error);
                // If check fails, assume we need full amount
                return requiredEnergy;
            }
        }
        
        // Estimate energy rental cost
        async function estimateEnergyRentalCost(energyAmount) {
            try {
                // TRONSave pricing: typically 10-15 TRX per 100k energy
                // We'll use a conservative estimate
                const unitsNeeded = Math.ceil(energyAmount / 100000);
                const pricePerUnit = 12; // TRX per 100k energy
                const rentalCost = unitsNeeded * pricePerUnit;
                
                console.log('Energy rental estimate:', {
                    energyAmount,
                    unitsNeeded,
                    pricePerUnit,
                    totalCost: rentalCost
                });
                
                return rentalCost;
            } catch (error) {
                console.error('Error estimating rental cost:', error);
                // Return conservative estimate
                return Math.ceil(energyAmount / 100000) * 15;
            }
        }
        
        // JustLend Energy Rental Service Configuration
        const JUSTLEND_CONFIG = {
            mainnet: {
                contract: 'TJSMvYJPASTsQFnDr9tw5s3YD9GQQmJcFg', // JustLend Energy Market
                api: 'https://api.justlend.org/v1/energy'
            },
            testnet: {
                // Testnet doesn't have JustLend, use manual approach
                useManual: true
            }
        };

        // Rent energy automatically
        async function rentEnergyIfNeeded(requiredEnergy) {
            try {
                const energyNeeded = await checkEnergyNeeded(requiredEnergy);
                
                if (energyNeeded <= ENERGY_RENTAL_CONFIG.minEnergyThreshold) {
                    console.log('Sufficient energy available, no rental needed');
                    return { success: true, rented: false, cost: 0 };
                }
                
                // Add buffer to energy needed
                const energyToRent = Math.ceil(energyNeeded * ENERGY_RENTAL_CONFIG.energyBuffer);
                
                console.log('Renting energy:', {
                    needed: energyNeeded,
                    renting: energyToRent,
                    network: currentNetwork
                });
                
                // Estimate rental cost
                const rentalCost = await estimateEnergyRentalCost(energyToRent);
                
                // For testnet, show warning and proceed
                if (currentNetwork === 'testnet' || currentNetwork === 'nile') {
                    const userConfirmed = confirm(
                        ` Energy Required\n\n` +
                        `This transaction requires ${energyToRent.toLocaleString()} energy.\n` +
                        `Estimated cost: ~${rentalCost} TRX\n\n` +
                        `On testnet, energy will be burned from your TRX balance.\n` +
                        `On mainnet, we'll automatically rent energy for you.\n\n` +
                        `Continue?`
                    );
                    
                    if (!userConfirmed) {
                        return { 
                            success: false, 
                            error: 'User cancelled due to energy requirement' 
                        };
                    }
                    
                    return {
                        success: true,
                        rented: false,
                        amount: energyToRent,
                        cost: rentalCost,
                        warning: 'Testnet: Energy will be burned from TRX balance'
                    };
                }
                
                // For mainnet, attempt to rent energy via JustLend
                try {
                    // Show rental notification
                    uiManager.showNotification('info', `Renting ${energyToRent.toLocaleString()} energy for ~${rentalCost} TRX...`);
                    
                    // Rent energy via JustLend smart contract
                    const rentalResult = await rentEnergyViaJustLend(energyToRent, rentalCost);
                    
                    if (rentalResult.success) {
                        uiManager.showNotification('success', `Energy rented successfully! Transaction: ${rentalResult.txId}`);
                        return {
                            success: true,
                            rented: true,
                            amount: energyToRent,
                            cost: rentalResult.actualCost,
                            txId: rentalResult.txId
                        };
                    }
                    
                    // If JustLend fails, fall back to manual approach
                    throw new Error(rentalResult.error || 'JustLend rental failed');
                    
                } catch (rentalError) {
                    console.error('Automated energy rental failed:', rentalError);
                    
                    // Show manual options
                    const manualChoice = await showEnergyOptions(energyToRent, rentalCost);
                    
                    if (manualChoice === 'proceed') {
                        // User chose to proceed and burn TRX
                        return {
                            success: true,
                            rented: false,
                            amount: energyToRent,
                            cost: rentalCost,
                            warning: 'Energy will be burned from TRX balance'
                        };
                    } else if (manualChoice === 'stake') {
                        // Open staking guide
                        window.open('https://tronscan.org/#/sr/representatives', '_blank');
                        return {
                            success: false,
                            error: 'Please stake TRX for energy and try again'
                        };
                    } else {
                        // User cancelled
                        return {
                            success: false,
                            error: 'Energy rental cancelled by user'
                        };
                    }
                }
                
            } catch (error) {
                console.error('Energy rental error:', error);
                
                // If we can't check energy, show warning but allow to proceed
                const proceed = confirm(
                    ' Unable to check energy requirements\n\n' +
                    'The transaction may fail if you don\'t have enough energy.\n' +
                    'Continue anyway?'
                );
                
                return { 
                    success: proceed, 
                    rented: false, 
                    cost: 0,
                    error: proceed ? null : 'User cancelled due to energy check failure'
                };
            }
        }
        
        // Rent energy via JustLend contract
        async function rentEnergyViaJustLend(energyAmount, maxPrice) {
            try {
                const justLendAddress = JUSTLEND_CONFIG.mainnet.contract;
                
                // Build the transaction
                const parameter = [
                    { type: 'uint256', value: energyAmount },
                    { type: 'address', value: tronWeb.defaultAddress.base58 },
                    { type: 'uint256', value: 3600 } // 1 hour rental
                ];
                
                const transaction = await tronWeb.transactionBuilder.triggerSmartContract(
                    justLendAddress,
                    'rentEnergy(uint256,address,uint256)',
                    {
                        callValue: tronWeb.toSun(maxPrice),
                        feeLimit: 10e6 // 10 TRX fee limit
                    },
                    parameter,
                    tronWeb.defaultAddress.base58
                );
                
                const signedTx = await tronWeb.trx.sign(transaction.transaction);
                const result = await tronWeb.trx.sendRawTransaction(signedTx);
                
                if (result.result) {
                    return {
                        success: true,
                        txId: result.txid,
                        actualCost: maxPrice
                    };
                }
                
                return {
                    success: false,
                    error: 'Transaction failed'
                };
                
            } catch (error) {
                console.error('JustLend rental error:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Show energy rental options to user
        async function showEnergyOptions(energyNeeded, estimatedCost) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2><i class="fas fa-bolt" style="color: #f59e0b;"></i> Energy Required</h2>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning" style="background: #fef3c7; border-color: #f59e0b;">
                                <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                                <strong>Insufficient Energy</strong>
                                <p style="margin: 0.5rem 0 0 0;">This transaction requires ${energyNeeded.toLocaleString()} energy.</p>
                            </div>
                            
                            <div class="energy-options" style="margin-top: 1.5rem;">
                                <h4>Choose how to proceed:</h4>
                                
                                <div class="option-card" style="margin: 1rem 0; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer;" 
                                     onclick="document.getElementById('energyChoice').value='proceed'; document.querySelector('.energy-continue-btn').click();">
                                    <h5><i class="fas fa-fire"></i> Burn TRX for Energy</h5>
                                    <p style="margin: 0.5rem 0 0 0; color: #6b7280;">Proceed with transaction and burn ~${estimatedCost} TRX for energy</p>
                                    <div class="cost-indicator" style="margin-top: 0.5rem; color: #ef4444;">
                                        <i class="fas fa-coins"></i> Cost: ~${estimatedCost} TRX
                                    </div>
                                </div>
                                
                                <div class="option-card" style="margin: 1rem 0; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer;"
                                     onclick="document.getElementById('energyChoice').value='stake'; document.querySelector('.energy-continue-btn').click();">
                                    <h5><i class="fas fa-lock"></i> Stake TRX for Energy</h5>
                                    <p style="margin: 0.5rem 0 0 0; color: #6b7280;">Stake TRX to get permanent energy (recommended for frequent users)</p>
                                    <div class="cost-indicator" style="margin-top: 0.5rem; color: #10b981;">
                                        <i class="fas fa-info-circle"></i> One-time stake, permanent energy
                                    </div>
                                </div>
                                
                                <div class="option-card" style="margin: 1rem 0; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer;"
                                     onclick="document.getElementById('energyChoice').value='cancel'; document.querySelector('.energy-continue-btn').click();">
                                    <h5><i class="fas fa-times"></i> Cancel Transaction</h5>
                                    <p style="margin: 0.5rem 0 0 0; color: #6b7280;">Cancel and return to form</p>
                                </div>
                            </div>
                            
                            <input type="hidden" id="energyChoice" value="">
                        </div>
                        <div class="modal-footer" style="display: none;">
                            <button class="btn btn-primary energy-continue-btn" onclick="
                                const choice = document.getElementById('energyChoice').value;
                                this.closest('.modal').remove();
                                window.energyModalResolve(choice);
                            ">
                                Continue
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Store resolve function globally for the onclick handlers
                window.energyModalResolve = resolve;
                
                // Clean up when modal is closed
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve('cancel');
                        delete window.energyModalResolve;
                    }
                });
            });
        }

        // Handle modal backdrop clicks
        function handleModalBackdropClick(event, modalId) {
            // Only close if clicking on the backdrop itself, not the content
            if (event.target.id === modalId) {
                if (modalId === 'mintModal') {
                    closeMintModal();
                } else if (modalId === 'registrationModal') {
                    closeRegistrationModal();
                } else {
                    // For other modals, just close them
                    document.getElementById(modalId).style.display = 'none';
                }
            }
        }
        
        // Set up modal protection to prevent accidental closes
        function setupModalProtection() {
            // Remove any inline onclick handlers and use event listeners
            const mintModal = document.getElementById('mintModal');
            const registrationModal = document.getElementById('registrationModal');
            
            if (mintModal) {
                // Remove inline onclick
                mintModal.onclick = null;
                
                // Add proper event listener
                mintModal.addEventListener('click', function(event) {
                    // Only trigger if clicking the modal backdrop itself
                    if (event.target === mintModal) {
                        event.preventDefault();
                        event.stopPropagation();
                        closeMintModal();
                    }
                });
            }
            
            if (registrationModal) {
                // Remove inline onclick
                registrationModal.onclick = null;
                
                // Add proper event listener
                registrationModal.addEventListener('click', function(event) {
                    // Only trigger if clicking the modal backdrop itself
                    if (event.target === registrationModal) {
                        event.preventDefault();
                        event.stopPropagation();
                        closeRegistrationModal();
                    }
                });
            }
            
            // Prevent all modal content from closing the modal
            document.querySelectorAll('.modal-content').forEach(content => {
                content.addEventListener('click', function(event) {
                    event.stopPropagation();
                });
            });
        }
        
        // Initialize when document is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            // Hide loader
            setTimeout(() => {
                uiManager.hideLoader();
            }, 500);
            
            // Set up modal protection
            setupModalProtection();
            
            // Initialize data from localStorage
            refreshPendingRegistrations();
            updateStatsFromLocalStorage();
            
            // Initialize admin tab visibility
            updateAdminTabVisibility();
            
            // Add click event listener to stats header
            const statsHeader = document.getElementById('statsHeader');
            if (statsHeader) {
                statsHeader.addEventListener('click', toggleStats);
            }
            
            // Add click event listener to wallet status header
            const walletStatusHeader = document.getElementById('walletStatusHeader');
            if (walletStatusHeader) {
                walletStatusHeader.addEventListener('click', toggleWalletStatus);
            }
            
            // Add click event listener to contract header
            const contractHeader = document.getElementById('contractHeader');
            if (contractHeader) {
                contractHeader.addEventListener('click', toggleContract);
            }
            
            // Check if TronWeb is available
            if (window.tronWeb && window.tronWeb.ready) {
                try {
                    await connectWallet();
                } catch (error) {
                    console.error('Error auto-connecting wallet:', error);
                }
            }
            
            // Load saved Pinata keys if in admin panel
            const savedApiKey = localStorage.getItem('pinataApiKey');
            const savedSecretKey = localStorage.getItem('pinataSecretKey');
            if (savedApiKey && document.getElementById('pinataApiKey')) {
                document.getElementById('pinataApiKey').value = savedApiKey;
            }
            if (savedSecretKey && document.getElementById('pinataSecretKey')) {
                document.getElementById('pinataSecretKey').value = savedSecretKey;
            }
            
          // Add input validation
const recipientInput = document.getElementById('mintRecipient');
if (recipientInput) {
    recipientInput.addEventListener('input', validateRecipientAddress);
}

// Setup delivery method selection
const deliveryOptions = document.querySelectorAll('input[name="deliveryMethod"]');
const textNoticeGroup = document.getElementById('textNoticeGroup');
const noticeTextInput = document.getElementById('noticeText');
const charCountSpan = document.getElementById('charCount');

deliveryOptions.forEach(option => {
    option.addEventListener('change', function() {
        // Update selected class
        document.querySelectorAll('.delivery-option').forEach(label => {
            label.classList.remove('selected');
        });
        this.closest('.delivery-option').classList.add('selected');
        
        // Show/hide form sections based on selection
        const viewGatedDetails = document.getElementById('viewGatedDetails');
        const noticeTextLabel = document.getElementById('noticeTextLabel');
        const noticeTextHelp = document.getElementById('noticeTextHelp');
        
        if (this.value === 'document') {
            viewGatedDetails.style.display = 'block';
            textNoticeGroup.style.display = 'block';
            textNoticeGroup.classList.add('active');
            noticeTextLabel.innerHTML = '<i class="fas fa-globe" style="color: #f59e0b;"></i> Public Notice Text';
            noticeTextHelp.innerHTML = '<i class="fas fa-exclamation-circle"></i> This text will be publicly visible on the blockchain';
        } else if (this.value === 'text') {
            viewGatedDetails.style.display = 'none';
            textNoticeGroup.style.display = 'block';
            textNoticeGroup.classList.add('active');
            noticeTextLabel.textContent = 'Notice Text';
            noticeTextHelp.textContent = 'This text will display directly in the recipient\'s wallet';
        } else {
            viewGatedDetails.style.display = 'none';
            textNoticeGroup.style.display = 'none';
            textNoticeGroup.classList.remove('active');
        }
        
        // Update fee estimate
        updateFeeEstimate();
        // Also update the detailed fee display if on step 2
        if (document.getElementById('mintStep2').style.display !== 'none') {
            updateFeeDisplay();
        }
    });
});

// Character counter for text notice
if (noticeTextInput && charCountSpan) {
    noticeTextInput.addEventListener('input', function() {
        const length = this.value.length;
        charCountSpan.textContent = length;
        
        const charCountDiv = this.nextElementSibling;
        if (length >= 90) {
            charCountDiv.classList.add('error');
            charCountDiv.classList.remove('warning');
        } else if (length >= 70) {
            charCountDiv.classList.add('warning');
            charCountDiv.classList.remove('error');
        } else {
            charCountDiv.classList.remove('warning', 'error');
        }
    });
}

// Function to update fee estimate based on delivery method
async function updateFeeEstimate() {
    const selectedMethod = document.querySelector('input[name="deliveryMethod"]:checked').value;
    const feeDisplay = document.querySelector('#creationFeeDisplay');
    const feeDescription = document.querySelector('#feeDescription');
    
    if (feeDisplay) {
        try {
            // Set base fee based on delivery method
            let baseFee = selectedMethod === 'document' ? 150 : 15;
            // Always add 2 TRX sponsorship
            let totalFee = baseFee + 2;
            
            let description = selectedMethod === 'document' 
                ? 'Document fee (150) + Sponsorship (2)' 
                : 'Text fee (15) + Sponsorship (2)';
            
            // Check if contract connection exists for exemption check
            if (legalContract && tronWeb.defaultAddress) {
                try {
                    const userAddress = tronWeb.defaultAddress.base58;
                    const isLawEnforcement = await legalContract.lawEnforcementExemptions(userAddress).call();
                    const agencyName = await legalContract.lawEnforcementAgencies(userAddress).call();
                    const serviceFeeExempt = isLawEnforcement;
                    const fullFeeExempt = isLawEnforcement;
                    
                    if (isLawEnforcement) {
                        totalFee = 2; // Only pay sponsorship fee
                        description = `Law Enforcement (${agencyName}) - Sponsorship only (2 TRX)`;
                    } else if (await checkIfProcessServer()) {
                        totalFee = 75 + 2; // Creation fee + sponsorship
                        description = 'Process Server: Creation fee (75) + Sponsorship (2)';
                    }
                } catch (err) {
                    console.log('Could not check fee exemptions');
                }
            }
            
            feeDisplay.textContent = totalFee + ' TRX';
            feeDescription.textContent = description;
            
        } catch (error) {
            console.error('Error calculating fee:', error);
            // Fallback to default fees
            const defaultFee = selectedMethod === 'document' ? '150 TRX' : '15 TRX';
            feeDisplay.textContent = defaultFee;
            feeDescription.textContent = selectedMethod === 'document' 
                ? 'Encrypted document with public text notice' 
                : 'Text only notice (no signature required)';
        }
    }
}

// Update notice template based on type selection
window.updateNoticeTemplate = function() {
    const noticeType = document.getElementById('noticeType').value;
    const customGroup = document.getElementById('customNoticeTypeGroup');
    const legalRights = document.getElementById('legalRights');
    
    // Show/hide custom notice type input
    if (noticeType === 'Custom') {
        customGroup.style.display = 'block';
    } else {
        customGroup.style.display = 'none';
    }
    
    // Update legal rights template based on notice type
    const rightsTemplates = {
        'Notice of Seizure': 'You have the right to contest this seizure',
        'Summons': 'You must respond within the time specified or judgment may be entered against you',
        'Subpoena': 'You are required to appear or produce documents as specified',
        'Restraining Order': 'Violation of this order may result in arrest and prosecution',
        'Eviction Notice': 'You have the right to contest this eviction in court',
        'Legal Hold': 'You must preserve all relevant documents and data',
        'Asset Freeze': 'You have the right to petition for release of frozen assets',
        'Custom': 'You have the right to respond to this legal notice'
    };
    
    if (rightsTemplates[noticeType]) {
        legalRights.value = rightsTemplates[noticeType];
    }
}

// Initialize admin panel inputs properly
setTimeout(() => {
    // Add role address validation
    const roleAddressInput = document.getElementById('roleAddress');
    if (roleAddressInput) {
        // Ensure input is interactive
        roleAddressInput.style.pointerEvents = 'auto';
        roleAddressInput.style.userSelect = 'text';
        roleAddressInput.disabled = false;
        roleAddressInput.readOnly = false;
        
        roleAddressInput.addEventListener('input', function(e) {
            const address = e.target.value.trim();
            if (address && tronWeb && !tronWeb.isAddress(address)) {
                e.target.classList.add('invalid');
                e.target.classList.remove('valid');
            } else if (address) {
                e.target.classList.add('valid');
                e.target.classList.remove('invalid');
            } else {
                e.target.classList.remove('valid', 'invalid');
            }
        });
    }

    // Add fee collector address validation
    const feeCollectorInput = document.getElementById('feeCollectorAddress');
    if (feeCollectorInput) {
        // Ensure input is interactive
        feeCollectorInput.style.pointerEvents = 'auto';
        feeCollectorInput.style.userSelect = 'text';
        feeCollectorInput.disabled = false;
        feeCollectorInput.readOnly = false;
        
        feeCollectorInput.addEventListener('input', function(e) {
            const address = e.target.value.trim();
            if (address && tronWeb && !tronWeb.isAddress(address)) {
                e.target.classList.add('invalid');
                e.target.classList.remove('valid');
            } else if (address) {
                e.target.classList.add('valid');
                e.target.classList.remove('invalid');
            } else {
                e.target.classList.remove('valid', 'invalid');
            }
        });
    }
    
    // Fix creation fee input
    const creationFeeInput = document.getElementById('creationFee');
    if (creationFeeInput) {
        creationFeeInput.style.pointerEvents = 'auto';
        creationFeeInput.style.userSelect = 'text';
        creationFeeInput.disabled = false;
        creationFeeInput.readOnly = false;
    }
    
    // Also ensure all form inputs in the admin panel are interactive
    const adminInputs = document.querySelectorAll('#adminTab .form-input');
    adminInputs.forEach(input => {
        input.style.pointerEvents = 'auto';
        input.style.userSelect = 'text';
        input.style.webkitUserSelect = 'text';
        input.disabled = false;
        input.readOnly = false;
    });
    
    console.log('Input fields initialized without replacement');
}, 100);
            
            // Add drag and drop support for file upload
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, () => {
                        uploadArea.classList.add('drag-over');
                    }, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, () => {
                        uploadArea.classList.remove('drag-over');
                    }, false);
                });
                
                uploadArea.addEventListener('drop', function(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    if (files.length > 0) {
                        document.getElementById('documentUpload').files = files;
                        handleDocumentUpload({ target: { files: files } });
                    }
                }, false);
            }
        });

       // Keyboard event handling for modals
document.addEventListener('keydown', function(event) {
    // Don't interfere with input fields
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
        return; // Let the input handle the event normally
    }
    
    if (event.key === 'Escape') {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            }
        });
    }
});

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // Make functions available globally
        window.connectWallet = connectWallet;
        window.switchTab = switchTab;
        window.openRegistrationModal = openRegistrationModal;
        window.closeRegistrationModal = closeRegistrationModal;
        window.closeRegistrationSuccessModal = closeRegistrationSuccessModal;
        window.dismissRegistrationNotice = dismissRegistrationNotice;
        window.submitRegistration = submitRegistration;
        window.refreshPendingRegistrations = refreshPendingRegistrations;
        window.approveRegistration = approveRegistration;
        window.openMintModal = openMintModal;
        window.closeMintModal = closeMintModal;
        window.showMintStep = showMintStep;
        window.changeDocument = changeDocument;
        window.handleDocumentUpload = handleDocumentUpload;
        window.createLegalNotice = createLegalNotice;
        window.openAuditModal = openAuditModal;
        window.closeAuditModal = closeAuditModal;
        window.openAcceptModal = openAcceptModal;
        window.closeAcceptModal = closeAcceptModal;
        window.closeTransactionResultModal = closeTransactionResultModal;
        window.acceptNotice = acceptNotice;
        window.closeTxModal = closeTxModal;
        window.exportReceipt = exportReceipt;
        window.closeRegistrationModal = closeRegistrationModal;
        window.submitRegistration = submitRegistration;
        window.openRegistrationForUser = openRegistrationForUser;
        window.updateAuditSearch = updateAuditSearch;
        window.performAudit = performAudit;
        window.refreshMyAlerts = refreshMyAlerts;
        
        // Debug alerts function
        async function debugAlerts() {
            if (!legalContract || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet and contract first');
                return;
            }
            
            try {
                console.log('=== ALERT DEBUG INFO ===');
                console.log('Your address:', tronWeb.defaultAddress.base58);
                
                // Get total notices from contract
                const totalNotices = await getTotalNotices();
                console.log('Total notices:', totalNotices);
                
                // Get recipient alerts
                const alerts = await getRecipientNoticeIds(tronWeb.defaultAddress.base58);
                console.log('Your alert IDs:', alerts.map(a => a.toString()));
                
                // Check a few recent notices to see if you're the recipient
                if (totalNotices > 0) {
                    console.log('Checking recent notices...');
                    const checkCount = Math.min(5, totalNotices);
                    for (let i = totalNotices - 1; i >= totalNotices - checkCount && i >= 0; i--) {
                        try {
                            const notice = await legalContract.notices(i).call();
                            console.log(`Notice ${i}:`, {
                                recipient: notice.recipient,
                                server: notice.server,
                                alertId: notice.alertId?.toString(),
                                isYourNotice: notice.recipient.toLowerCase() === tronWeb.defaultAddress.base58.toLowerCase()
                            });
                        } catch (e) {
                            console.log(`Could not read notice ${i}:`, e.message);
                        }
                    }
                }
                
                // Show debug info in UI
                const debugInfo = `
                    <div style="background: #f0f0f0; padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.875rem;">
                        <h4>Alert Debug Information</h4>
                        <p><strong>Your Address:</strong> ${tronWeb.defaultAddress.base58}</p>
                        <p><strong>Total Notices:</strong> ${totalNotices}</p>
                        <p><strong>Your Alert Count:</strong> ${alerts.length}</p>
                        <p><strong>Alert IDs:</strong> ${alerts.length > 0 ? alerts.join(', ') : 'None'}</p>
                        <p style="margin-top: 1rem;">Check console for detailed information.</p>
                    </div>
                `;
                
                document.getElementById('myAlertsContent').innerHTML = debugInfo;
                
            } catch (error) {
                console.error('Debug error:', error);
                uiManager.showNotification('error', 'Debug failed: ' + error.message);
            }
        }
        
        window.debugAlerts = debugAlerts;
        window.copyTxHash = copyTxHash;
        window.viewContractOnTronscan = viewContractOnTronscan;
        window.viewOnTronscan = viewOnTronscan;
        window.viewOnIPFS = viewOnIPFS;
        
        // Quick accept function for one-click signing
        async function quickAccept(noticeId) {
            if (!legalContract || !noticeId) {
                uiManager.showNotification('error', 'Notice information missing');
                return;
            }
            
            // Show confirmation dialog
            const confirmed = confirm(
                'ELECTRONIC SIGNATURE CONFIRMATION\n\n' +
                'By clicking OK, you are electronically signing that you have received this legal notice.\n\n' +
                'This signature:\n' +
                ' Confirms receipt only (like signing for certified mail)\n' +
                ' Does NOT mean you agree with the contents\n' +
                ' Does NOT admit any wrongdoing\n' +
                ' Does NOT waive any of your legal rights\n\n' +
                'Your signature will be permanently recorded on the blockchain.\n\n' +
                'Do you want to sign the receipt for this legal notice?'
            );
            
            if (!confirmed) {
                return;
            }
            
            currentNoticeId = noticeId;
            
            try {
                showProcessing('Processing electronic signature...');
                
                // Call the contract to accept the notice
                const tx = await legalContract.acceptNotice(noticeId).send({
                    feeLimit: 20_000_000,  // 20 TRX - simple state change
                    callValue: 0,
                    shouldPollResponse: true
                });
                
                hideProcessing();
                
                // Add to recent activity
                addRecentActivity('accept', 'Legal notice accepted via quick sign', {
                    noticeId: noticeId
                });
                
                // Show success notification
                uiManager.showNotification('success', 'Receipt signed successfully - Your electronic signature has been recorded');
                
                // Show transaction modal
                const txHash = typeof tx === 'string' ? tx : tx.txid || tx[0];
                showTransactionSuccess(
                    txHash,
                    'Legal Notice Receipt Signed',
                    `
                        <div class="token-detail">
                            <span>Notice ID:</span>
                            <span>${noticeId}</span>
                        </div>
                        <div class="token-detail">
                            <span>Method:</span>
                            <span>Quick Sign</span>
                        </div>
                        <div class="token-detail">
                            <span>Timestamp:</span>
                            <span>${new Date().toLocaleString()}</span>
                        </div>
                    `
                );
                
                // Refresh alerts after a short delay
                setTimeout(() => {
                    refreshMyAlerts();
                }, 2000);
                
            } catch (error) {
                console.error('Error accepting notice:', error);
                hideProcessing();
                let errorMsg = getErrorMessage(error);
                uiManager.showNotification('error', errorMsg);
            }
        }
        
        window.quickAccept = quickAccept;
        
        // Transaction verification function
        async function verifyTransaction() {
            const txHash = document.getElementById('verifyTxHash').value.trim();
            const resultDiv = document.getElementById('txVerificationResult');
            
            if (!txHash) {
                resultDiv.innerHTML = '<div class="alert alert-error">Please enter a transaction hash</div>';
                return;
            }
            
            if (!tronWeb) {
                resultDiv.innerHTML = '<div class="alert alert-error">TronWeb not initialized</div>';
                return;
            }
            
            try {
                resultDiv.innerHTML = '<p><i class="fas fa-spinner loading-spinner"></i> Verifying transaction...</p>';
                
                // Get transaction info
                const txInfo = await tronWeb.trx.getTransactionInfo(txHash);
                console.log('Transaction info:', txInfo);
                
                if (!txInfo || !txInfo.id) {
                    resultDiv.innerHTML = '<div class="alert alert-error">Transaction not found</div>';
                    return;
                }
                
                // Get transaction events
                const events = await tronWeb.getEventByTransactionID(txHash);
                console.log('Transaction events:', events);
                
                let html = '<div class="verification-results">';
                html += '<h4>Transaction Verification Results</h4>';
                
                // Basic transaction info
                html += '<div class="token-details" style="margin-bottom: 1rem;">';
                html += `<div class="token-detail"><span>Status:</span><span>${txInfo.receipt?.result === 'SUCCESS' ? ' Successful' : ' Failed'}</span></div>`;
                html += `<div class="token-detail"><span>Block Number:</span><span>${txInfo.blockNumber}</span></div>`;
                html += `<div class="token-detail"><span>Energy Used:</span><span>${txInfo.receipt?.energy_usage || 0}</span></div>`;
                html += `<div class="token-detail"><span>Net Used:</span><span>${txInfo.receipt?.net_usage || 0}</span></div>`;
                html += '</div>';
                
                // Parse events
                if (events && events.length > 0) {
                    html += '<h5>Events Found:</h5>';
                    
                    // NoticeServed event
                    const noticeEvent = events.find(e => e.name === 'NoticeServed');
                    if (noticeEvent) {
                        html += '<div class="event-details" style="background: var(--card-bg); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">';
                        html += '<h6> Notice Served Event</h6>';
                        html += '<div class="token-details">';
                        html += `<div class="token-detail"><span>Alert ID:</span><span>${noticeEvent.result.alertId}</span></div>`;
                        html += `<div class="token-detail"><span>Document ID:</span><span>${noticeEvent.result.documentId}</span></div>`;
                        html += `<div class="token-detail"><span>Recipient:</span><span>${tronWeb.address.fromHex(noticeEvent.result.recipient)}</span></div>`;
                        html += '</div></div>';
                    }
                    
                    // Transfer events
                    const transfers = events.filter(e => e.name === 'Transfer');
                    if (transfers.length > 0) {
                        html += '<h5>NFT Transfers:</h5>';
                        transfers.forEach((transfer, index) => {
                            const from = transfer.result.from === '0x0000000000000000000000000000000000000000' 
                                ? 'Contract (Minted)' 
                                : tronWeb.address.fromHex(transfer.result.from);
                            const to = tronWeb.address.fromHex(transfer.result.to);
                            const tokenId = transfer.result.tokenId;
                            
                            html += '<div class="event-details" style="background: var(--card-bg); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">';
                            html += `<h6> Transfer ${index + 1}</h6>`;
                            html += '<div class="token-details">';
                            html += `<div class="token-detail"><span>Token ID:</span><span>#${tokenId}</span></div>`;
                            html += `<div class="token-detail"><span>From:</span><span style="font-family: monospace; font-size: 0.875rem;">${from}</span></div>`;
                            html += `<div class="token-detail"><span>To:</span><span style="font-family: monospace; font-size: 0.875rem;">${to}</span></div>`;
                            
                            // Determine token type based on ID parity
                            const tokenType = parseInt(tokenId) % 2 === 1 ? 'Alert NFT' : 'Document NFT';
                            html += `<div class="token-detail"><span>Type:</span><span>${tokenType}</span></div>`;
                            html += '</div></div>';
                        });
                    }
                    
                    // Fee transfer events
                    const feeTransfers = events.filter(e => e.name === 'Transfer' && !e.topic);
                    if (feeTransfers.length > 0) {
                        html += '<h5>Fee Transfers:</h5>';
                        feeTransfers.forEach(transfer => {
                            html += '<div class="event-details" style="background: var(--card-bg); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">';
                            html += '<div class="token-details">';
                            html += `<div class="token-detail"><span>Amount:</span><span>${tronWeb.fromSun(transfer.result.value)} TRX</span></div>`;
                            html += '</div></div>';
                        });
                    }
                } else {
                    html += '<div class="alert alert-warning">No events found for this transaction</div>';
                }
                
                html += '</div>';
                
                // Add link to TronScan
                const network = document.getElementById('networkName')?.textContent || 'Mainnet';
                let scanUrl = 'https://tronscan.org';
                if (network.includes('Nile')) scanUrl = 'https://nile.tronscan.org';
                else if (network.includes('Shasta')) scanUrl = 'https://shasta.tronscan.org';
                
                html += `<div style="margin-top: 1rem;">
                    <a href="${scanUrl}/#/transaction/${txHash}" target="_blank" class="btn btn-secondary">
                        <i class="fas fa-external-link-alt"></i> View on TronScan
                    </a>
                </div>`;
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Verification error:', error);
                resultDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }
        
        window.verifyTransaction = verifyTransaction;
        window.grantRole = grantRole;
        window.checkRole = checkRole;
        window.refreshDeliveryStatus = refreshDeliveryStatus;
        window.filterDeliveryResults = filterDeliveryResults;
        window.sendDeliveryReminder = sendDeliveryReminder;
        window.updateFee = updateFee;
        window.updateFeeCollector = updateFeeCollector;
        window.exportRegistrations = exportRegistrations;
        window.toggleRegistrationForm = toggleRegistrationForm;
        
        async function withdrawFromContract() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            const amountTRX = document.getElementById('withdrawAmount').value;
            if (!amountTRX || parseFloat(amountTRX) <= 0) {
                uiManager.showNotification('error', 'Please enter a valid amount');
                return;
            }
            
            try {
                showProcessing('Withdrawing TRX from contract...');
                
                // Convert TRX to SUN
                const amountSUN = tronWeb.toSun(amountTRX);
                
                const tx = await legalContract.withdrawTRX(amountSUN).send({
                    feeLimit: 10_000_000,
                    callValue: 0,
                    shouldPollResponse: true
                });
                
                hideProcessing();
                uiManager.showNotification('success', `Successfully withdrew ${amountTRX} TRX from contract`);
                document.getElementById('withdrawAmount').value = '';
                
            } catch (error) {
                hideProcessing();
                console.error('Withdrawal error:', error);
                uiManager.showNotification('error', 'Failed to withdraw: ' + getErrorMessage(error));
            }
        }
        
        // GitHub Settings Functions
        function loadGitHubSettings() {
            // Load token if exists
            const savedToken = localStorage.getItem('githubToken');
            if (savedToken) {
                document.getElementById('githubToken').value = savedToken;
            }
            
            // Display encryption key
            document.getElementById('encryptionKey').value = GITHUB_CONFIG.encryptionKey;
        }

        function toggleTokenVisibility() {
            const tokenInput = document.getElementById('githubToken');
            const icon = document.getElementById('tokenVisibilityIcon');
            
            if (tokenInput.type === 'password') {
                tokenInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                tokenInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function copyEncryptionKey() {
            const keyInput = document.getElementById('encryptionKey');
            keyInput.select();
            document.execCommand('copy');
            uiManager.showNotification('success', 'Encryption key copied to clipboard');
        }

        function saveGitHubSettings() {
            const token = document.getElementById('githubToken').value.trim();
            
            if (!token) {
                uiManager.showNotification('error', 'Please enter a GitHub token');
                return;
            }
            
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                uiManager.showNotification('error', 'Invalid token format. Should start with ghp_ or github_pat_');
                return;
            }
            
            // Save to localStorage
            GITHUB_CONFIG.token = token;
            uiManager.showNotification('success', 'GitHub settings saved successfully');
            
            // Update UI
            showAlert('githubSettingsResult', 'success', 'Settings saved! Token will be used for future registrations.');
        }

        async function testGitHubConnection() {
            const token = document.getElementById('githubToken').value.trim() || GITHUB_CONFIG.token;
            
            if (!token) {
                uiManager.showNotification('error', 'Please enter a GitHub token first');
                return;
            }
            
            showProcessing('Testing GitHub connection...');
            
            try {
                // Test API connection
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                hideProcessing();
                
                if (response.ok) {
                    const repo = await response.json();
                    showAlert('githubSettingsResult', 'success', 
                        ` Connected to ${repo.full_name}<br>` +
                        ` Token has repository access<br>` +
                        ` Ready to save encrypted registrations`
                    );
                } else if (response.status === 401) {
                    showAlert('githubSettingsResult', 'error', 'Invalid token or token expired');
                } else if (response.status === 404) {
                    showAlert('githubSettingsResult', 'error', 'Repository not found or no access');
                } else {
                    showAlert('githubSettingsResult', 'error', `Connection failed: ${response.status}`);
                }
            } catch (error) {
                hideProcessing();
                console.error('GitHub test error:', error);
                showAlert('githubSettingsResult', 'error', 'Connection test failed: ' + error.message);
            }
        }

        // Fee exemption functions
        function useConnectedAddressForExemption() {
            if (tronWeb && tronWeb.defaultAddress) {
                document.getElementById('exemptionAddress').value = tronWeb.defaultAddress.base58;
            } else {
                showAlert('exemptionResult', 'error', 'Please connect your wallet first');
            }
        }

        async function setLawEnforcementExemption() {
            if (!legalContract) {
                showAlert('exemptionResult', 'error', 'Contract not connected');
                return;
            }

            const address = document.getElementById('exemptionAddress').value.trim();
            const agencyName = document.getElementById('exemptionAgencyName').value.trim();

            if (!address) {
                showAlert('exemptionResult', 'error', 'Please enter an address');
                return;
            }

            if (!agencyName) {
                showAlert('exemptionResult', 'error', 'Please enter an agency name for law enforcement exemption');
                return;
            }

            if (!tronWeb.isAddress(address)) {
                showAlert('exemptionResult', 'error', 'Invalid TRON address');
                return;
            }

            try {
                showProcessing('Granting law enforcement exemption...');
                
                const tx = await legalContract.setLawEnforcementExemption(address, agencyName).send({
                    feeLimit: 100_000_000, // 100 TRX
                    callValue: 0,
                    shouldPollResponse: true
                });

                hideProcessing();
                showAlert('exemptionResult', 'success', `Law enforcement exemption granted to ${address}`);
                
                // Clear inputs
                document.getElementById('exemptionAddress').value = '';
                document.getElementById('exemptionAgencyName').value = '';
            } catch (error) {
                hideProcessing();
                console.error('Error setting exemption:', error);
                showAlert('exemptionResult', 'error', 'Failed to set exemption: ' + getErrorMessage(error));
            }
        }

        async function removeLawEnforcementExemption() {
            if (!legalContract) {
                showAlert('exemptionResult', 'error', 'Contract not connected');
                return;
            }

            const address = document.getElementById('exemptionAddress').value.trim();

            if (!address) {
                showAlert('exemptionResult', 'error', 'Please enter an address');
                return;
            }

            if (!tronWeb.isAddress(address)) {
                showAlert('exemptionResult', 'error', 'Invalid TRON address');
                return;
            }

            try {
                showProcessing('Removing law enforcement exemption...');
                
                const tx = await legalContract.removeLawEnforcementExemption(address).send({
                    feeLimit: 100_000_000, // 100 TRX
                    callValue: 0,
                    shouldPollResponse: true
                });

                hideProcessing();
                showAlert('exemptionResult', 'success', `Law enforcement exemption removed from ${address}`);
                
                // Clear input
                document.getElementById('exemptionAddress').value = '';
            } catch (error) {
                hideProcessing();
                console.error('Error removing exemption:', error);
                showAlert('exemptionResult', 'error', 'Failed to remove exemption: ' + getErrorMessage(error));
            }
        }

        async function checkExemptionStatus() {
            if (!legalContract) {
                showAlert('exemptionResult', 'error', 'Contract not connected');
                return;
            }

            const address = document.getElementById('exemptionAddress').value.trim();

            if (!address) {
                showAlert('exemptionResult', 'error', 'Please enter an address');
                return;
            }

            if (!tronWeb.isAddress(address)) {
                showAlert('exemptionResult', 'error', 'Invalid TRON address');
                return;
            }

            try {
                showProcessing('Checking exemption status...');
                
                // Check law enforcement exemption
                const isLawEnforcementExempt = await legalContract.lawEnforcementExemptions(address).call();
                const agencyName = await legalContract.lawEnforcementAgencies(address).call();
                
                // Calculate actual fee
                const actualFee = await calculateFeeFromConstants(address);
                const feeInTRX = tronWeb.fromSun(actualFee);
                
                hideProcessing();
                
                let statusMessage = `<strong>Address:</strong> ${address}<br>`;
                statusMessage += `<strong>Law Enforcement Exempt:</strong> ${isLawEnforcementExempt ? 'Yes' : 'No'}<br>`;
                if (isLawEnforcementExempt && agencyName) {
                    statusMessage += `<strong>Agency:</strong> ${agencyName}<br>`;
                }
                statusMessage += `<strong>Service Fee:</strong> ${feeInTRX} TRX`;
                
                showAlert('exemptionResult', 'info', statusMessage);
            } catch (error) {
                hideProcessing();
                console.error('Error checking exemption status:', error);
                showAlert('exemptionResult', 'error', 'Failed to check status: ' + getErrorMessage(error));
            }
        }

        window.withdrawFromContract = withdrawFromContract;
        window.useConnectedAddressForExemption = useConnectedAddressForExemption;
        window.setLawEnforcementExemption = setLawEnforcementExemption;
        window.removeLawEnforcementExemption = removeLawEnforcementExemption;
        window.checkExemptionStatus = checkExemptionStatus;
        // window.updateResourceSponsorship = updateResourceSponsorship; // Function removed in simplified contract
        window.connectContracts = connectContracts;
        
        // Debug function to manually show admin tab
        window.showAdminTab = function() {
            const adminTabButton = document.getElementById('adminTabButton');
            if (adminTabButton) {
                adminTabButton.style.display = 'inline-flex';
                console.log('Admin tab manually shown');
            }
        };
        window.copyWalletAddress = copyWalletAddress;
        window.toggleTokenVisibility = toggleTokenVisibility;
        window.copyEncryptionKey = copyEncryptionKey;
        window.saveGitHubSettings = saveGitHubSettings;
        window.testGitHubConnection = testGitHubConnection;

        // Registration viewer functions
        let allRegistrations = [];
        
        // Process Server ID Generation
        async function generateProcessServerId() {
            // Get the last used ID from localStorage
            let lastId = parseInt(localStorage.getItem('lastProcessServerId') || '0');
            
            // If we have registrations loaded, check for highest ID
            if (allRegistrations.length > 0) {
                allRegistrations.forEach(reg => {
                    if (reg.serverId) {
                        const match = reg.serverId.match(/PS-(\d+)/);
                        if (match) {
                            const id = parseInt(match[1]);
                            if (id > lastId) {
                                lastId = id;
                            }
                        }
                    }
                });
            }
            
            // Increment for new ID
            lastId++;
            
            // Save to localStorage
            localStorage.setItem('lastProcessServerId', lastId.toString());
            
            // Return formatted ID
            return `PS-${String(lastId).padStart(3, '0')}`;
        }
        
        async function fetchAllRegistrations() {
            const token = GITHUB_CONFIG.token;
            const contentDiv = document.getElementById('allRegistrationsContent');
            showProcessing('Loading registrations...');
            
            // Load from localStorage first
            const localRegistrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
            const localRegs = Object.entries(localRegistrations).map(([id, reg]) => ({
                ...reg,
                id,
                _source: 'local'
            }));
            
            if (!token) {
                // No GitHub token - show only local registrations
                allRegistrations = localRegs;
                hideProcessing();
                displayAllRegistrations();
                document.getElementById('exportBtn').style.display = 'inline-flex';
                
                if (allRegistrations.length === 0) {
                    contentDiv.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No registrations found</h3><p>Registrations will appear here after approval</p></div>';
                } else {
                    uiManager.showNotification('info', 'Showing local registrations only. Configure GitHub token to sync with cloud.');
                }
                return;
            }
            
            showProcessing('Fetching registrations from GitHub...');
            
            try {
                // Fetch directory contents
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // Folder doesn't exist yet - no registrations saved to GitHub
                        console.log('Registrations folder not found on GitHub');
                        
                        // Show local registrations if any
                        if (localRegs.length > 0) {
                            allRegistrations = localRegs;
                            hideProcessing();
                            displayAllRegistrations();
                            document.getElementById('exportBtn').style.display = 'inline-flex';
                            uiManager.showNotification('info', 'No cloud registrations found. Showing local registrations only.');
                        } else {
                            contentDiv.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No registrations found</h3><p>Registrations will appear here after approval</p></div>';
                            hideProcessing();
                        }
                        return;
                    }
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const files = await response.json();
                const encFiles = files.filter(f => f.name.endsWith('.enc'));
                
                if (encFiles.length === 0) {
                    contentDiv.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No registrations found</h3></div>';
                    hideProcessing();
                    return;
                }
                
                // Fetch and decrypt each file
                allRegistrations = [];
                let processed = 0;
                
                for (const file of encFiles) {
                    try {
                        const fileResponse = await fetch(file.download_url);
                        const encryptedData = await fileResponse.text();
                        
                        // Decrypt
                        const decrypted = CryptoJS.AES.decrypt(encryptedData, GITHUB_CONFIG.encryptionKey);
                        const decryptedData = decrypted.toString(CryptoJS.enc.Utf8);
                        
                        if (decryptedData) {
                            const registration = JSON.parse(decryptedData);
                            registration._filename = file.name;
                            registration._sha = file.sha;
                            allRegistrations.push(registration);
                        }
                    } catch (e) {
                        console.error('Error decrypting file:', file.name, e);
                    }
                    
                    processed++;
                    showProcessing(`Processing registrations... ${processed}/${encFiles.length}`);
                }
                
                // Merge with local registrations (prefer GitHub version if duplicate)
                const githubAddresses = new Set(allRegistrations.map(r => r.address || r.wallet));
                const uniqueLocalRegs = localRegs.filter(r => !githubAddresses.has(r.address || r.wallet));
                allRegistrations = [...allRegistrations, ...uniqueLocalRegs];
                
                hideProcessing();
                displayAllRegistrations();
                document.getElementById('exportBtn').style.display = 'inline-flex';
                
            } catch (error) {
                hideProcessing();
                console.error('Error fetching registrations:', error);
                
                // Fall back to local registrations
                if (localRegs.length > 0) {
                    allRegistrations = localRegs;
                    displayAllRegistrations();
                    document.getElementById('exportBtn').style.display = 'inline-flex';
                    uiManager.showNotification('warning', 'GitHub sync failed. Showing local registrations only.');
                } else {
                    contentDiv.innerHTML = `<div class="error-state"><i class="fas fa-exclamation-triangle"></i><h3>Error loading registrations</h3><p>${error.message}</p></div>`;
                }
            }
        }
        
        function displayAllRegistrations() {
            const contentDiv = document.getElementById('allRegistrationsContent');
            
            if (allRegistrations.length === 0) {
                contentDiv.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No registrations found</h3></div>';
                return;
            }
            
            let html = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--secondary-navy); border-bottom: 1px solid var(--border);">
                                <th style="padding: 1rem; text-align: left;">Server ID</th>
                                <th style="padding: 1rem; text-align: left;">Agency</th>
                                <th style="padding: 1rem; text-align: left;">License</th>
                                <th style="padding: 1rem; text-align: left;">Email</th>
                                <th style="padding: 1rem; text-align: left;">Phone</th>
                                <th style="padding: 1rem; text-align: left;">Address</th>
                                <th style="padding: 1rem; text-align: left;">Status</th>
                                <th style="padding: 1rem; text-align: left;">Date</th>
                                <th style="padding: 1rem; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            allRegistrations.forEach((reg, index) => {
                const statusClass = reg.status === 'approved' ? 'success' : reg.status === 'rejected' ? 'error' : 'warning';
                const statusIcon = reg.status === 'approved' ? 'check-circle' : reg.status === 'rejected' ? 'times-circle' : 'clock';
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 1rem; font-weight: 600; color: var(--accent-blue);">
                            ${reg.serverId || '<span style="color: var(--text-muted);">Pending</span>'}
                        </td>
                        <td style="padding: 1rem;">${escapeHtml(reg.agencyName || reg.agency || 'N/A')}</td>
                        <td style="padding: 1rem;">${escapeHtml(reg.licenseNumber || reg.license || 'N/A')}</td>
                        <td style="padding: 1rem;">${escapeHtml(reg.agencyEmail || reg.email || 'N/A')}</td>
                        <td style="padding: 1rem;">${escapeHtml(reg.serverPhone || reg.phone || 'N/A')}</td>
                        <td style="padding: 1rem;" title="${escapeHtml(reg.address || reg.wallet || 'N/A')}">
                            ${shortAddress(reg.address || reg.wallet || 'N/A')}
                        </td>
                        <td style="padding: 1rem;">
                            <span class="status-badge ${statusClass}">
                                <i class="fas fa-${statusIcon}"></i> ${reg.status || 'pending'}
                            </span>
                            ${reg._source === 'local' ? '<span style="font-size: 0.75rem; color: var(--text-muted); margin-left: 0.5rem;" title="Stored locally only"><i class="fas fa-database"></i></span>' : ''}
                        </td>
                        <td style="padding: 1rem;">${new Date(reg.registeredAt || reg.timestamp).toLocaleDateString()}</td>
                        <td style="padding: 1rem;">
                            <button class="btn btn-small" onclick="editRegistration(${index})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteRegistration(${index})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 1rem; color: var(--text-muted);">
                    Total: ${allRegistrations.length} registrations
                </p>
            `;
            
            contentDiv.innerHTML = html;
        }
        
        function editRegistration(index) {
            const reg = allRegistrations[index];
            
            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2>Edit Registration</h2>
                        <button class="btn-close" onclick="this.closest('.modal').remove()"></button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Server ID</label>
                        <input type="text" class="form-input" id="editServerId" value="${escapeHtml(reg.serverId || '')}" placeholder="PS-001" ${reg.status === 'approved' ? '' : 'readonly'}>
                        <small class="form-help">${reg.status === 'approved' ? 'Process Server ID' : 'ID will be assigned upon approval'}</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Agency Name</label>
                        <input type="text" class="form-input" id="editAgency" value="${escapeHtml(reg.agencyName || reg.agency || '')}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">License Number</label>
                        <input type="text" class="form-input" id="editLicense" value="${escapeHtml(reg.licenseNumber || reg.license || '')}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="editEmail" value="${escapeHtml(reg.agencyEmail || reg.email || '')}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="editPhone" value="${escapeHtml(reg.serverPhone || reg.phone || '')}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-input" id="editStatus">
                            <option value="pending" ${reg.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="approved" ${reg.status === 'approved' ? 'selected' : ''}>Approved</option>
                            <option value="rejected" ${reg.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="saveRegistrationEdit(${index})">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function saveRegistrationEdit(index) {
            const reg = allRegistrations[index];
            
            // Get edited values
            reg.serverId = document.getElementById('editServerId').value;
            reg.agencyName = reg.agency = document.getElementById('editAgency').value;
            reg.licenseNumber = reg.license = document.getElementById('editLicense').value;
            reg.agencyEmail = reg.email = document.getElementById('editEmail').value;
            reg.serverPhone = reg.phone = document.getElementById('editPhone').value;
            reg.status = document.getElementById('editStatus').value;
            reg.lastModified = new Date().toISOString();
            
            // If status changed to approved and no server ID, generate one
            if (reg.status === 'approved' && !reg.serverId) {
                reg.serverId = await generateProcessServerId();
            }
            
            try {
                showProcessing('Saving changes...');
                
                // Encrypt updated data
                const dataStr = JSON.stringify(reg, null, 2);
                const encrypted = CryptoJS.AES.encrypt(dataStr, GITHUB_CONFIG.encryptionKey).toString();
                const content = btoa(encrypted);
                
                // Update file on GitHub
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}/${reg._filename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update registration for ${reg.agencyName}`,
                        content: content,
                        sha: reg._sha,
                        branch: GITHUB_CONFIG.branch
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                hideProcessing();
                document.querySelector('.modal').remove();
                uiManager.showNotification('success', 'Registration updated successfully');
                
                // Refresh display
                displayAllRegistrations();
                
            } catch (error) {
                hideProcessing();
                console.error('Error saving registration:', error);
                uiManager.showNotification('error', 'Failed to save: ' + error.message);
            }
        }
        
        async function deleteRegistration(index) {
            const reg = allRegistrations[index];
            
            if (!confirm(`Delete registration for ${reg.agencyName || reg.agency}?`)) {
                return;
            }
            
            try {
                showProcessing('Deleting registration...');
                
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}/${reg._filename}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Delete registration for ${reg.agencyName}`,
                        sha: reg._sha,
                        branch: GITHUB_CONFIG.branch
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                hideProcessing();
                uiManager.showNotification('success', 'Registration deleted');
                
                // Remove from array and refresh
                allRegistrations.splice(index, 1);
                displayAllRegistrations();
                
            } catch (error) {
                hideProcessing();
                console.error('Error deleting registration:', error);
                uiManager.showNotification('error', 'Failed to delete: ' + error.message);
            }
        }
        
        function exportRegistrations() {
            if (allRegistrations.length === 0) return;
            
            // Create CSV
            const headers = ['Server ID', 'Agency', 'License', 'Email', 'Phone', 'Address', 'Status', 'Date', 'Purpose'];
            const rows = allRegistrations.map(reg => [
                reg.serverId || '',
                reg.agencyName || reg.agency || '',
                reg.licenseNumber || reg.license || '',
                reg.agencyEmail || reg.email || '',
                reg.serverPhone || reg.phone || '',
                reg.address || reg.wallet || '',
                reg.status || 'pending',
                new Date(reg.registeredAt || reg.timestamp).toLocaleDateString(),
                reg.purpose || ''
            ]);
            
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',') + '\n';
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `registrations_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        window.fetchAllRegistrations = fetchAllRegistrations;
        window.editRegistration = editRegistration;
        window.saveRegistrationEdit = saveRegistrationEdit;
        window.deleteRegistration = deleteRegistration;
        window.exportRegistrations = exportRegistrations;
	window.copyAddress = copyAddress;
	window.useConnectedAddress = useConnectedAddress;
	window.useConnectedAddressForFeeCollector = useConnectedAddressForFeeCollector;
	window.uiManager = uiManager;
	window.handleChainChange = handleChainChange;
	window.toggleStats = toggleStats;
	window.toggleWalletStatus = toggleWalletStatus;
	window.toggleContract = toggleContract;
	
	// Simplified system - no encryption setup needed
    </script>
</body>
</html>