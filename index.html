<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LegalNotice - Blockchain Legal Document Service</title>
    <meta name="description" content="Secure multi-chain blockchain legal document service supporting TRON, Ethereum, Polygon, and BSC">
    <!-- Security Headers (X-Frame-Options must be set server-side) -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAABbElEQVQ4jZ2TvUoDQRSFv5nZzW5iYqKxUBQLC1EQBMHCRrAQfABfwNrGVnyEgI2NhY2FIAiChYWFIAiCYCEKFqKxUBQVf5JNdjOzY7K7iYkRPDAw98w5585czgX/jKqqGmNMEJgAhoE+oAN4AW6Ac+BYKXWnlLL/BYQBzBizsbe3t3J0dCSbzaZsNBqy0WjIZrMpj4+P5fb2tpyamjJABJj7NWBxcXFldnZWFgoFaYyRxhhZKBRkLBaTi4uLEoj5AdFQKLQcj8dlNpuVzWZTtpLNZmU8HpehUEgCUV8gEolEZCqVkrZty1+0bVumUikZiUQkEPEFVlZWZL1el+1Qr9fl6uqqBJZbAdN1XTudzjoJTLQCbHBwcPj29jbpRLAsSweDQemIVoDXdL3v5eUl6UTweDzSdF3XOoHpdDq9VCo9OQmKxaJMp9M6MKPU41nO5XLZ8/PzLw2FYrFYOj09zeVyuQqw+ek7PntzgCwQBKr+0l/wDvc6kKScHd8bAAAAAElFTkSuQmCC">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pica/9.0.1/pica.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@4.3.0/dist/web3.min.js"></script>
    <script src="config.js"></script>
    <!-- Document conversion libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/documentConverter.js"></script>
    <!-- Simplified Encryption (no registration needed) -->
    <script src="js/simple-encryption.js?v=2"></script>
    <script src="js/simplified-integration.js"></script>
    <script src="js/thumbnail-generator-v5.js?v=2"></script>
    <script src="js/energy-rental.js?v=4"></script>
    <script src="js/energy-rental-enhanced.js?v=1"></script>
    <script src="js/pending-transactions.js?v=1"></script>
    <script src="js/translations.js?v=1"></script>
    <script src="js/audit-logger.js?v=1"></script>
    <script>
        // Pinata IPFS Configuration - shared across all users
        window.PINATA_CONFIG = {
            // Encoded keys for all users (can be overridden in admin panel)
            encodedKey: '=ETN1U2MzEDNkZzNmJjN4MmMkJmZ',
            encodedSecret: '==wM4MWY4kjNyIWN0gDZjFWMmFzNyETZ2YWNmBzM3MDNjFDM5EjYihTNmJWZ5UzMwMTOwQjNyUWNjNzNkdjZjRWY'
        };
        
        // Contract addresses for different networks
        window.CONTRACT_ADDRESSES = {
            mainnet: 'TLhYHQatauDtZ4iNCePU26WbVjsXtMPdoN', // Mainnet contract - Deployed Aug 3, 2025
            nile: '', // Testnet contract removed - wallet was compromised
            shasta: '' // Not deployed
        };
        
        // Set default CONTRACT_ADDRESS for easier access
        window.CONTRACT_ADDRESS = window.CONTRACT_ADDRESSES.mainnet;
    </script>
    <script src="v4/js/ipfs-integration.js"></script>
    <script src="js/session-cache.js"></script>
    <script src="js/rate-limiter.js?v=1"></script>
    <script src="js/hybrid-data-service.js?v=3"></script>
    <script src="js/grouped-activities.js"></script>
    <script src="js/grouped-activities-hybrid.js"></script>
    <!-- New unified workflow system -->
    <script src="js/notice-workflow.js"></script>
    <script src="js/server-dashboard.js"></script>
    <script src="js/clear-test-data.js"></script>
    <!-- Complete overhaul unified system -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <!-- Device Tracking for Comprehensive Audit Logs -->
    <script src="js/device-tracker.js?v=1"></script>
    <!-- Court Report Generator -->
    <script src="js/court-report-generator.js?v=1"></script>
    <!-- Upload Notice Documents -->
    <script src="js/upload-notice-documents.js?v=1"></script>
    <!-- Sync Server Registration -->
    <script src="js/sync-server-registration.js?v=1"></script>
    <!-- Cleanup Test Cases -->
    <script src="js/cleanup-test-cases.js?v=1"></script>
    <!-- Multi-document upload handler -->
    <script src="js/multi-document-handler.js?v=1"></script>
    <script src="js/multi-document-mode-toggle.js?v=1"></script>
    <script src="js/unified-notice-system.js?v=5"></script>
    <link href="css/unified-system.css" rel="stylesheet">
    <!-- Print Styles for Court Reports -->
    <link href="css/print-audit.css" rel="stylesheet">
    <!-- Mobile Wallet Connector -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="js/mobile-wallet-connector.js?v=2"></script>
    <script src="js/tronlink-mobile-fix.js?v=1"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-dark: #0a0a0a;
            --primary-navy: #111111;
            --secondary-navy: #1a1a1a;
            --accent-blue: #0ea5e9;
            --accent-light: #38bdf8;
            --text-primary: #ffffff;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --border-color: #262626;
            --card-bg: #141414;
            --hover-bg: #1f1f1f;
            --alert-color: #0ea5e9;
            --gray-800: #1f2937;
            --gray-700: #374151;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--primary-dark);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* Loader */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-navy) 0%, var(--secondary-navy) 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .logo:hover {
            transform: translateY(-1px);
        }

        .logo i {
            font-size: 2rem;
            color: var(--accent-blue);
            animation: pulse 2s infinite;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .contract-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.75rem;
            position: relative;
            overflow: hidden;
        }
        
        .contract-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(14, 165, 233, 0.2), transparent);
            animation: shimmer 3s infinite;
        }
        
        .contract-indicator span:first-child {
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .contract-indicator span:nth-child(2) {
            color: var(--accent-light);
            font-family: monospace;
        }
        
        .btn-icon {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
        }
        
        .btn-icon:hover {
            color: var(--accent-blue);
            background: rgba(14, 165, 233, 0.1);
        }
        
        .btn-icon-small {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.125rem 0.25rem;
            font-size: 0.875rem;
            transition: color 0.3s ease;
            margin-left: 0.25rem;
        }
        
        .btn-icon-small:hover {
            color: var(--accent-blue);
        }
        
        .address-display {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .address-text {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }

        .chain-selector {
            margin-right: 1rem;
        }

        .chain-dropdown {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chain-dropdown:hover {
            border-color: var(--accent-blue);
        }

        .chain-dropdown:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .chain-dropdown optgroup {
            background: var(--primary-navy);
            color: var(--text-secondary);
            font-weight: 600;
        }

        .chain-dropdown option {
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 0.5rem;
        }

        .network-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            color: var(--accent-light);
            font-size: 0.75rem;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .network-indicator.connected {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .network-indicator.connected i {
            color: var(--success);
        }

        .wallet-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .wallet-address {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .main-container {
            margin-top: 80px;
            padding: 2rem;
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
            animation: fadeIn 0.5s ease;
        }

        /* Welcome Section */
        .welcome-section {
            text-align: center;
            padding: 3rem 0;
            margin-bottom: 2rem;
            animation: slideIn 0.5s ease;
        }

        .welcome-section h2 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-section p {
            font-size: 1.125rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Stats Section */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stats-header:hover {
            background: rgba(255, 255, 255, 0.05) !important;
        }
        
        #walletStatusHeader:hover,
        #contractHeader:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        /* Make entire header clickable */
        #walletStatusHeader,
        #contractHeader,
        .stats-header {
            user-select: none;
            -webkit-user-select: none;
            position: relative;
        }
        
        /* Add active state for better feedback */
        #walletStatusHeader:active,
        #contractHeader:active,
        .stats-header:active {
            background: rgba(255, 255, 255, 0.08) !important;
        }
        
        #walletStatusHeader h2,
        #contractHeader h2,
        .stats-header h3 {
            pointer-events: none;
        }
        
        #walletToggleIcon,
        #contractToggleIcon,
        #statsToggleIcon {
            pointer-events: none;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-light));
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .stat-card:hover::before {
            transform: translateX(0);
        }

        .stat-card i {
            font-size: 2rem;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .tab-navigation {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            font-size: 0.938rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-button:hover {
            color: var(--text-primary);
        }

        .tab-button.active {
            color: var(--accent-blue);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-blue);
            animation: slideIn 0.3s ease;
        }

        .tab-button .badge {
            background: var(--accent-blue);
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            margin-left: 0.5rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(14, 165, 233, 0.1), transparent);
            transition: all 0.5s ease;
            transform: translate(-50%, -50%);
        }

        .card:hover::before {
            width: 100%;
            height: 100%;
        }

        .card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(14, 165, 233, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-header i {
            font-size: 1.25rem;
            color: var(--accent-blue);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1.5rem;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .action-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(14, 165, 233, 0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
            transform: rotate(45deg);
        }

        .action-card:hover::before {
            opacity: 1;
        }

        .action-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-blue);
            box-shadow: 0 12px 32px rgba(59, 130, 246, 0.2);
        }

        .action-card.primary {
            border-color: var(--accent-blue);
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(59, 130, 246, 0.1) 100%);
        }

        .action-card i {
            font-size: 3rem;
            color: var(--accent-blue);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .action-card:hover i {
            transform: scale(1.1);
        }

        .action-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .action-card p {
            color: var(--text-secondary);
            font-size: 0.938rem;
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-navy);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--hover-bg);
            border-color: var(--accent-blue);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.2s ease;
	    pointer-events: auto !important;
            user-select: text !important;
            -webkit-user-select: text !important;
        }
        
        .form-input:hover {
            border-color: var(--accent-blue);
            background: rgba(255, 255, 255, 0.08);
        }
/* Specifically target admin panel inputs */
#adminTab .form-input {
    pointer-events: auto !important;
    user-select: text !important;
    -webkit-user-select: text !important;
    cursor: text !important;
}

/* Ensure inputs are not disabled by parent elements */
#adminContent * {
    pointer-events: auto !important;
}

/* Fix for any potential z-index issues */
#adminTab .card {
    position: relative;
    z-index: 1;
}

#adminTab .form-input {
    position: relative;
    z-index: 2;
}
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Highlight empty required fields */
        .form-input:placeholder-shown {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Normal styling for filled fields */
        .form-input:not(:placeholder-shown) {
            background: var(--primary-dark);
            border-color: var(--border-color);
        }
        
        /* Required field indicator for empty fields */
        .form-input:required:placeholder-shown {
            background: rgba(245, 158, 11, 0.05);
            border-color: rgba(245, 158, 11, 0.3);
        }
        
        /* Success indicator for filled required fields */
        .form-input:required:not(:placeholder-shown):valid {
            border-color: rgba(16, 185, 129, 0.3);
        }
        
        /* Make textarea follow same pattern */
        textarea.form-input:placeholder-shown {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        textarea.form-input:not(:placeholder-shown) {
            background: var(--primary-dark);
            border-color: var(--border-color);
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            color: var(--text-primary);
        }

        /* Custom checkbox */
        input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background: var(--primary-dark);
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        input[type="checkbox"]:checked {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        input[type="checkbox"]:checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .status-complete {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }
        
        .status-badge.success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }
        
        .status-badge.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }
        
        .status-badge.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .token-list {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .token-item {
            padding: 1rem;
            background: var(--primary-dark);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .token-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
            animation: scan 3s infinite;
        }

        .token-item:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .token-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .token-details {
            display: grid;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .token-detail {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
        }

        .token-preview {
            margin-top: 1rem;
            text-align: center;
        }

        .token-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }

        .token-preview img:hover {
            transform: scale(1.05);
        }

        .notification-banner {
            background: rgba(14, 165, 233, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideIn 0.5s ease;
        }

        .notification-banner i {
            color: var(--accent-blue);
            font-size: 1.25rem;
            animation: pulse 2s infinite;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 0;
                margin: 0;
            }
            
            .container {
                padding: 0.5rem;
                margin: 0;
                max-width: 100%;
            }
            
            .header {
                padding: 1rem 0.5rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .header-content {
                flex-direction: column;
                align-items: center;
                gap: 1rem;
                width: 100%;
            }
            
            .header-controls {
                width: 100%;
                justify-content: center;
            }
            
            .chain-selector {
                width: 100%;
            }
            
            .chain-dropdown {
                width: 100%;
                font-size: 0.9rem;
            }
            
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0 0.5rem;
            }
            
            .tab-buttons {
                min-width: max-content;
                gap: 0.25rem;
            }
            
            .tab-button {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
                white-space: nowrap;
            }
            
            .card {
                margin: 0.5rem 0;
                border-radius: 12px;
            }
            
            .card-header {
                padding: 1rem;
                font-size: 1.1rem;
            }
            
            .card-header h2 {
                font-size: 1.1rem;
            }
            
            .form-group {
                margin-bottom: 1rem;
            }
            
            .form-label {
                font-size: 0.875rem;
            }
            
            .form-input, .form-select, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 0.75rem;
            }
            
            .btn {
                padding: 0.75rem 1.5rem;
                font-size: 0.875rem;
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .btn-small {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
            
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 1rem;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            .info-grid, .wallet-info-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .stats-card {
                min-width: 100%;
            }
            
            .notification {
                right: 0.5rem;
                left: 0.5rem;
                max-width: none;
            }
            
            .document-upload-area {
                padding: 2rem 1rem;
            }
            
            .address-input-group {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .address-input-group input {
                width: 100%;
            }
            
            .address-input-group button {
                width: 100%;
            }
            
            .token-detail {
                flex-direction: column;
                gap: 0.25rem;
                font-size: 0.875rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }
            
            .stat-item {
                padding: 0.75rem;
            }
            
            /* Mobile-specific utility classes */
            .mobile-only {
                display: block !important;
            }
            
            .desktop-only {
                display: none !important;
            }
        }

        
        
        /* Analytics Dashboard Styles */
        .analytics-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            background: var(--accent-blue);
            color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        .analytics-charts {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .chart-container {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
        }
        
        .chart-container h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .recent-activity {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
        }
        
        .recent-activity h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .activity-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-info {
            flex: 1;
        }
        
        .activity-type {
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .activity-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        .activity-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        @media (max-width: 768px) {
            .analytics-charts {
                grid-template-columns: 1fr;
            }
        }

        /* Notification System Styles */
        .notification-bell {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }
        
        .notification-bell-btn {
            position: relative;
            width: 56px;
            height: 56px;
            background: var(--accent-blue);
            color: white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }
        
        .notification-bell-btn:hover {
            transform: scale(1.1);
        }
        
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--error);
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        
        .notification-panel {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 320px;
            max-height: 400px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 999;
            display: flex;
            flex-direction: column;
        }
        
        .notification-panel-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-panel-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .notification-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .notification-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .notification-item:hover {
            background: var(--bg-hover);
        }
        
        .notification-item.unread {
            border-left: 3px solid var(--accent-blue);
        }
        
        .notification-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }
        
        .notification-item-title {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .notification-item-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .notification-item-body {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .notification-panel-footer {
            padding: 0.75rem;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .notification-bell {
                bottom: 1rem;
                right: 1rem;
            }
            
            .notification-panel {
                right: 1rem;
                left: 1rem;
                width: auto;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .processing-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem 3rem;
            text-align: center;
            border: 1px solid var(--accent-blue);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        .processing-card i {
            font-size: 3rem;
            color: var(--accent-blue);
            margin-bottom: 1rem;
        }

        .processing-card h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .processing-card p {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: relative;
            max-width: 800px;
            margin: 5% auto;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            animation: slideIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            padding: 0.25rem;
            border-radius: 4px;
        }

        .modal-close:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .alert {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--error);
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: var(--accent-light);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--warning);
        }

        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            background: var(--primary-dark);
        }

        .upload-area:hover {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
        }

        .upload-area.active {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .upload-area.drag-over {
            border-color: var(--accent-blue);
            background: rgba(14, 165, 233, 0.05);
            transform: scale(1.02);
        }

        .upload-area.processing {
            pointer-events: none;
            opacity: 0.8;
        }

        .upload-area.error {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--accent-blue);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .upload-area:hover .upload-icon {
            transform: translateY(-5px);
        }

        .upload-area.drag-over .upload-icon {
            animation: bounce 1s infinite;
        }

        .upload-area input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.01; /* Changed from 0 to 0.01 for better browser support */
            cursor: pointer;
            z-index: 10; /* Ensure it's on top */
        }

        .preview-container {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
        }

        .preview-image {
            flex: 0 0 200px;
            text-align: center;
        }

        .preview-image img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .preview-details {
            flex: 1;
        }

        .tx-details {
            background: var(--primary-dark);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid var(--border-color);
        }

        .tx-hash {
            font-family: 'Inter', monospace;
            font-size: 0.875rem;
            word-break: break-all;
            color: var(--accent-light);
            margin: 0.5rem 0;
            background: var(--hover-bg);
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }
        
        /* Enhanced transaction modal styles */
        #txModal .modal-content {
            max-width: 700px;
        }
        
        #txModal .token-details {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        #txModal .btn {
            min-width: 140px;
            justify-content: center;
        }
        
        #txModal img {
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        #txModal img:hover {
            transform: scale(1.02);
        }

        .server-id-display {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--primary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-weight: 600;
            color: var(--accent-blue);
            animation: slideIn 0.5s ease;
        }

        /* Enhanced form validation styles */
        .form-input.invalid {
            border-color: var(--error);
            animation: shake 0.3s ease;
        }

        .form-input.valid {
            border-color: var(--success);
        }

        .validation-message {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            animation: slideIn 0.3s ease;
        }

        .validation-message.error {
            color: var(--error);
        }

        .validation-message.warning {
            color: var(--warning);
        }

        .validation-message.success {
            color: var(--success);
        }

        /* Upload metadata */
        .upload-metadata {
            background: var(--primary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .upload-metadata h5 {
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
            font-size: 0.938rem;
        }

        .upload-metadata .metadata-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .upload-metadata .metadata-item strong {
            color: var(--text-primary);
        }

        /* Compression status */
        .compression-status {
            background: var(--primary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .compression-status.active {
            border-color: var(--accent-blue);
        }

        .compression-progress {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-blue);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.5);
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            min-width: 50px;
            text-align: right;
        }

        /* Notification system */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            min-width: 300px;
            max-width: 500px;
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 9999;
            transition: all 0.3s ease;
            transform: translateX(400px);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
        }

        .notification-enter {
            transform: translateX(400px);
        }

        .notification-active {
            transform: translateX(0);
        }

        .notification-exit {
            transform: translateX(400px);
            opacity: 0;
        }

        .notification-success {
            background: rgba(16, 185, 129, 0.9);
            color: white;
            border: 1px solid rgba(16, 185, 129, 1);
        }

        .notification-error {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: 1px solid rgba(239, 68, 68, 1);
        }

        .notification-warning {
            background: rgba(245, 158, 11, 0.9);
            color: white;
            border: 1px solid rgba(245, 158, 11, 1);
        }

        .notification-info {
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border: 1px solid rgba(59, 130, 246, 1);
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.25rem;
            margin-left: auto;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .notification-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Empty states */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.125rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        /* Delivery Options Styles */
        .delivery-options {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .delivery-option {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            background: var(--card-bg);
        }
        
        .delivery-option:hover {
            border-color: var(--accent-blue);
            background: var(--hover-bg);
        }
        
        .delivery-option.selected {
            border-color: var(--accent-blue);
            background: rgba(14, 165, 233, 0.1);
        }
        
        .delivery-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }
        
        .delivery-option-title {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .delivery-option-cost {
            color: var(--success);
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .delivery-option-desc {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        
        .text-notice-input {
            display: none;
            margin-top: 15px;
        }
        
        .text-notice-input.active {
            display: block;
        }
        
        .text-notice-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .text-notice-input input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 0.938rem;
            transition: all 0.2s ease;
        }

        .text-notice-input input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        .text-notice-input .char-count {
            text-align: right;
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .text-notice-input .char-count.warning {
            color: var(--warning);
        }

        .text-notice-input .char-count.error {
            color: var(--error);
        }

        /* Delivery Status Styles */
        .delivery-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .delivery-status.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .delivery-status.delivered {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .delivery-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .delivery-item:hover {
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }
        
        .delivery-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .delivery-item-id {
            font-family: monospace;
            color: var(--accent-blue);
            font-size: 0.875rem;
        }
        
        .delivery-item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            font-size: 0.875rem;
        }
        
        .delivery-detail {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .delivery-detail-label {
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        
        .delivery-detail-value {
            color: var(--text-primary);
        }
        
        .delivery-timeline {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .timeline-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }
        
        .timeline-icon.sent {
            background: var(--accent-blue);
            color: white;
        }
        
        .timeline-icon.delivered {
            background: var(--success);
            color: white;
        }
        
        .timeline-icon.pending {
            background: var(--gray-700);
            color: var(--text-muted);
        }
        
        /* FAQ Styles */
        .process-steps {
            margin: 20px 0;
        }
        
        .step {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .step-number {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            background: var(--accent-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-content strong {
            display: block;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-size: 1.1em;
        }
        
        .example-notice {
            background: var(--card-bg);
            border: 2px solid var(--accent-blue);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        .recipient-journey h5 {
            color: var(--accent-blue);
            margin: 20px 0 10px 0;
        }
        
        .fee-table {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .fee-table table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .fee-table th {
            background: var(--primary-navy);
            color: var(--text-primary);
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .fee-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .fee-table tr:last-child td {
            border-bottom: none;
        }
        
        .fee-table tr:hover {
            background: var(--hover-bg);
        }
        
        .workflow-guide h5 {
            color: var(--accent-blue);
            margin: 25px 0 15px 0;
        }
        
        .workflow-guide ol {
            padding-left: 20px;
        }
        
        .workflow-guide ol li {
            margin-bottom: 10px;
        }
        
        .best-practices h5 {
            color: var(--accent-blue);
            margin: 20px 0 15px 0;
        }
        
        .technical-info h5 {
            color: var(--accent-blue);
            margin: 20px 0 15px 0;
        }
        
        .warning-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: start;
        }
        
        .warning-box i {
            color: var(--error);
            font-size: 1.2em;
            flex-shrink: 0;
        }

        /* Animations */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes shimmer {
            to { left: 100%; }
        }

        @keyframes scan {
            to { left: 100%; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .admin-controls {
                grid-template-columns: 1fr;
            }

            .stats-section {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .preview-container {
                flex-direction: column;
            }
            
            .preview-image {
                flex: unset;
            }

            .modal-content {
                margin: 2% 1rem;
                padding: 1.5rem;
            }

            .welcome-section h2 {
                font-size: 2rem;
            }

            .stats-section {
                grid-template-columns: 1fr;
            }

            .tab-navigation {
                justify-content: start;
            }

            .notification {
                right: 0.5rem;
                left: 0.5rem;
                min-width: auto;
            }
        }

        /* Print styles */
        @media print {
            .header,
            .tab-navigation,
            .btn,
            .modal {
                display: none !important;
            }

            body {
                background: white;
                color: black;
            }

            .card {
                border: 1px solid #ccc;
                page-break-inside: avoid;
            }
        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Focus styles */
        *:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            :root {
                --primary-dark: #000000;
                --text-primary: #ffffff;
                --accent-blue: #00a8ff;
            }
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Wallet Info Grid */
        .wallet-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .info-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .info-value {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 600;
            word-break: break-all;
        }

        /* Badge styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-primary {
            background-color: var(--accent-blue);
            color: white;
        }

        .badge-secondary {
            background-color: var(--gray-700);
            color: var(--text-secondary);
        }

        .badge-success {
            background-color: var(--success);
            color: white;
        }

        .badge-warning {
            background-color: var(--warning);
            color: white;
        }

        .badge-admin {
            background-color: #9333ea;
            color: white;
        }

        .badge-server {
            background-color: #3b82f6;
            color: white;
        }

        /* Fee Summary */
        .fee-summary {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        .fee-summary p {
            margin: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fee-summary span {
            font-weight: 600;
            color: var(--accent-blue);
        }

        /* FAQ Styles */
        .faq-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .faq-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .faq-header {
            width: 100%;
            padding: 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .faq-header:hover {
            background: var(--hover-bg);
        }

        .faq-header i {
            transition: transform 0.3s ease;
            color: var(--accent-blue);
        }

        .faq-header.active i {
            transform: rotate(180deg);
        }

        .faq-content {
            padding: 0 1.5rem 1.5rem;
            display: none;
        }

        /* Server Dashboard Styles */
        .server-dashboard {
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
        }

        .dashboard-header {
            margin-bottom: 2rem;
        }

        .dashboard-header h2 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            display: block;
            font-size: 2rem;
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .dashboard-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
        }

        .filter-controls {
            display: flex;
            gap: 0.5rem;
        }

        .filter-controls select {
            padding: 0.75rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
        }

        .btn-refresh {
            padding: 0.75rem 1.5rem;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cases-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .case-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .case-header {
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .case-header:hover {
            background: var(--hover-bg);
        }

        .case-info h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .case-type, .case-agency {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--hover-bg);
            border-radius: 4px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-right: 0.5rem;
        }

        .case-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .status-delivered {
            background: rgba(14, 165, 233, 0.2);
            color: var(--accent-blue);
            border: 1px solid var(--accent-blue);
        }

        .status-awaiting_signature {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .status-completed {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .case-details {
            padding: 0 1.5rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .case-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            padding: 1rem 0;
        }

        .meta-item label {
            color: var(--text-muted);
            margin-right: 0.5rem;
        }

        .notice-list {
            margin: 1rem 0;
        }

        .notice-list h4 {
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .notice-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--hover-bg);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .notice-type-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card-bg);
            border-radius: 50%;
            color: var(--accent-blue);
        }

        .notice-info {
            flex: 1;
        }

        .notice-label {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
        }

        .notice-id {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .tx-link {
            color: var(--accent-blue);
            text-decoration: none;
            font-size: 0.85rem;
        }

        .case-actions {
            display: flex;
            gap: 0.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .audit-table {
            width: 100%;
            border-collapse: collapse;
        }

        .audit-table th {
            background: var(--hover-bg);
            padding: 0.75rem;
            text-align: left;
            color: var(--text-primary);
            font-weight: 500;
        }

        .audit-table td {
            padding: 0.75rem;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .event-type {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .event-created {
            background: rgba(14, 165, 233, 0.2);
            color: var(--accent-blue);
        }

        .event-view {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .event-accepted {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .no-cases {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .fee-explanation {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .fee-item {
            background: var(--hover-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 3px solid var(--accent-blue);
        }

        .fee-item strong {
            color: var(--accent-blue);
            display: block;
            margin-bottom: 0.5rem;
        }

        .info-box {
            background: rgba(14, 165, 233, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .info-box.warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning);
        }

        .info-box i {
            color: var(--accent-blue);
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .info-box.warning i {
            color: var(--warning);
        }

        .delivery-option {
            background: var(--hover-bg);
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .delivery-option h5 {
            color: var(--accent-blue);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .delivery-option ul {
            list-style: none;
            padding: 0;
        }

        .delivery-option li {
            margin-bottom: 0.5rem;
            padding-left: 1.5rem;
            position: relative;
        }

        .delivery-option li::before {
            content: "";
            position: absolute;
            left: 0;
            color: var(--accent-blue);
        }

        .scenario {
            background: var(--hover-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .scenario h5 {
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .scenario ul {
            list-style: none;
            padding: 0;
        }

        .scenario li {
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .scenario li::before {
            content: "";
            position: absolute;
            left: 0;
            color: var(--success);
        }

        .cost-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .cost-table th,
        .cost-table td {
            padding: 0.75rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .cost-table th {
            background: var(--hover-bg);
            font-weight: 600;
            color: var(--accent-blue);
        }

        .cost-table tr:nth-child(even) {
            background: var(--hover-bg);
        }

        .breakdown-row td {
            background: var(--card-bg);
            font-style: italic;
            text-align: left !important;
            padding-left: 1.5rem;
        }

        .cost-note {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--hover-bg);
            border-radius: 0.5rem;
        }

        .benefit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .benefit-card {
            background: var(--hover-bg);
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .benefit-card:hover {
            transform: translateY(-2px);
        }

        .benefit-card i {
            font-size: 2.5rem;
            color: var(--accent-blue);
            margin-bottom: 1rem;
        }

        .benefit-card h5 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .step-list {
            list-style: none;
            padding: 0;
            margin-top: 1rem;
        }

        .step-list li {
            padding: 0.75rem 0 0.75rem 2.5rem;
            position: relative;
            border-bottom: 1px solid var(--border-color);
        }

        .step-list li:last-child {
            border-bottom: none;
        }

        .step-list li::before {
            content: counter(step-counter);
            counter-increment: step-counter;
            position: absolute;
            left: 0;
            width: 1.75rem;
            height: 1.75rem;
            background: var(--accent-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .step-list {
            counter-reset: step-counter;
        }
    
        /* Enhanced checkbox styling */
        #lawEnforcementExempt {
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(59, 130, 246, 0.5);
            border-radius: 4px;
            display: inline-block;
            position: relative;
            transition: all 0.2s ease;
        }
        
        #lawEnforcementExempt:checked {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        
        #lawEnforcementExempt:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        #lawEnforcementExempt:hover {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Case header interactive styles for expansion */
        .case-header {
            cursor: pointer !important;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .case-header:hover {
            background-color: #f0f0f0 !important;
            transform: translateX(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .case-header:active {
            transform: translateX(0);
        }
        
        .case-details {
            transition: all 0.3s ease;
            transform-origin: top;
        }
        
        .case-details.expanded {
            animation: slideDown 0.3s ease;
        }
        
        .case-details.collapsed {
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }
        
        /* Chevron rotation animation */
        .case-header .fa-chevron-down,
        .case-header .fa-chevron-up {
            transition: transform 0.3s ease;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Loader -->
    <div class="loader-container" id="loader">
        <div class="loader"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo" onclick="location.reload()">
                <i class="fas fa-shield-alt"></i>
                <h1 class="brand-name">NFT Legal Service</h1>
            </div>
            <div class="header-controls">
                <div id="contractsStatus" style="display: none;">
                    <div class="contract-indicator">
                        <span>Contract:</span>
                        <span id="legalContractShort">-</span>
                        <button class="btn-icon" onclick="viewContractOnTronscan('legal')" title="View on TronScan">
                            <i class="fas fa-external-link-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="chain-selector">
                    <select id="chainSelector" class="chain-dropdown" onchange="handleChainChange()">
                        <optgroup label="TRON">
                            <option value="tron-mainnet">TRON Mainnet</option>
                            <option value="tron-nile" selected>TRON Nile Testnet</option>
                            <option value="tron-shasta">TRON Shasta Testnet</option>
                        </optgroup>
                        <optgroup label="Ethereum">
                            <option value="evm-ethereum">Ethereum Mainnet</option>
                            <option value="evm-sepolia">Ethereum Sepolia</option>
                        </optgroup>
                        <optgroup label="Polygon">
                            <option value="evm-polygon">Polygon Mainnet</option>
                            <option value="evm-mumbai">Polygon Mumbai</option>
                        </optgroup>
                        <optgroup label="BNB Chain">
                            <option value="evm-bsc">BNB Smart Chain</option>
                            <option value="evm-bscTestnet">BSC Testnet</option>
                        </optgroup>
                    </select>
                </div>
                <div class="network-indicator" id="networkIndicator">
                    <i class="fas fa-circle"></i>
                    <span id="networkName">Disconnected</span>
                </div>
                <!-- Pending Transactions Button -->
                <button id="pendingBtn" class="btn btn-secondary btn-small" onclick="PendingTransactions.showPendingPanel()" style="position: relative; margin-right: 0.5rem;">
                    <i class="fas fa-clock"></i>
                    <span>Pending</span>
                    <span id="pendingBadge" style="position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; min-width: 18px; height: 18px; display: none; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; padding: 0 4px;">0</span>
                </button>
                <div class="wallet-status">
                    <div class="wallet-address" id="walletAddress" style="display: none;">
                        <span id="walletAddressText">Not Connected</span>
                        <button class="btn-icon" onclick="copyWalletAddress()" title="Copy address">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <span id="walletStatus" style="display: block;">Not Connected</span>
                    <button class="btn btn-primary btn-small" onclick="connectWallet()" id="connectBtn">
                        <i class="fas fa-link"></i>
                        Connect
                    </button>
                </div>
            </div>
        </div>
    </header>

    
    <!-- Notification Bell for Recipients -->
    <div id="notificationBell" class="notification-bell" style="display: none;">
        <button class="btn-icon notification-bell-btn" onclick="toggleNotificationPanel()">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
        </button>
    </div>
    
    <!-- Notification Panel -->
    <div id="notificationPanel" class="notification-panel" style="display: none;">
        <div class="notification-panel-header">
            <h3>Legal Notices</h3>
            <button class="btn-icon" onclick="toggleNotificationPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="notificationList" class="notification-list">
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No new notices</p>
            </div>
        </div>
        <div class="notification-panel-footer">
            <button class="btn btn-secondary btn-small" onclick="markAllAsRead()">
                Mark all as read
            </button>
        </div>
    </div>


    <!-- Main Container -->
    <div class="main-container">
        <!-- Welcome Section -->
        <div class="welcome-section" id="welcomeSection">
            <h2>Blockchain Legal Notice Delivery System</h2>
            <p>Serve legal documents directly to cryptocurrency wallets - solving the unknown owner problem</p>
            <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--accent-blue);">
                <p style="margin: 0; font-size: 0.95rem; color: var(--text-secondary);">
                    <strong> Law Enforcement Asset Recovery:</strong> When cryptocurrency wallets contain proceeds of crime but owners are unknown, this system enables constitutional due process by serving seizure notices directly to the wallet address. The NFT travels with the assets, ensuring notice reaches whoever controls them.
                    <a href="#" onclick="switchTab('info'); setTimeout(() => document.querySelector('.faq-header').click(), 100); return false;" style="color: var(--accent-blue); text-decoration: underline;">See how it works </a>
                </p>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active server-only" onclick="switchTab('user')">
                <i class="fas fa-user"></i> Process Server
                <span class="badge" id="userBadge" style="display: none;">0</span>
            </button>
            <button class="tab-button" onclick="switchTab('delivery')">
                <i class="fas fa-truck"></i> Delivery Status
                <span class="badge" id="deliveryBadge" style="display: none;">0</span>
            </button>
            <button class="tab-button server-only" onclick="switchTab('admin')" id="adminTabButton" style="display: none;">
                <i class="fas fa-user-shield"></i> Admin Panel
            </button>
            <button class="tab-button" onclick="switchTab('info')">
                <i class="fas fa-info-circle"></i> Info
            </button>
        </div>

        <!-- Stats Section -->
        <div id="statsContainer" style="display: none;">
            <div class="stats-header" id="statsHeader" style="cursor: pointer; padding: 1rem; background: var(--secondary-navy); border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between;">
                <h3 style="margin: 0; font-size: 1.1rem; color: var(--text-primary);">
                    <i class="fas fa-chart-bar" style="margin-right: 0.5rem;"></i>
                    Dashboard Statistics
                </h3>
                <i id="statsToggleIcon" class="fas fa-chevron-up"></i>
            </div>
            <div class="stats-section" id="statsSection" style="display: grid;">
                <div class="stat-card">
                    <i class="fas fa-file-alt"></i>
                    <div class="stat-value" id="totalNotices">0</div>
                    <div class="stat-label">Total Notices</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-check-circle"></i>
                    <div class="stat-value" id="acceptedNotices">0</div>
                    <div class="stat-label">Accepted</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-clock"></i>
                    <div class="stat-value" id="pendingNotices">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-users"></i>
                    <div class="stat-value" id="activeServers">0</div>
                    <div class="stat-label">Process Servers</div>
                </div>
            </div>
        </div>

        <!-- User Tab -->
        <div id="userTab" class="tab-content active">
            <!-- Contract Management Card -->
            <div class="card" id="contractManagementCard">
                <div class="card-header" id="contractHeader" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 1.25rem;">
                    <h2 style="margin: 0;"><i class="fas fa-file-contract"></i> Contract Connection</h2>
                    <i id="contractToggleIcon" class="fas fa-chevron-up"></i>
                </div>
                <div id="contractContent">
                <div class="form-group">
                    <label class="form-label">Legal Notice Contract Address <span class="badge badge-info" id="contractNetworkBadge">Detecting...</span></label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" class="form-input" id="contractAddress" 
                               placeholder="Enter contract address (e.g., TXxxx...)"
                               value="" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="copyAddress(document.getElementById('contractAddress').value)" title="Copy address">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn btn-secondary" onclick="detectNetworkAndSetContract()" title="Refresh network detection">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <a href="#" id="contractTronscanLink" target="_blank" class="btn btn-secondary" title="View on TronScan">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                    <p class="form-help" id="networkWarning"> Detecting network... <a href="#" onclick="detectNetworkAndSetContract(); return false;" style="color: var(--accent-blue);">Refresh</a></p>
                </div>
                <button class="btn btn-primary" onclick="connectContracts()" id="connectContractBtn">
                    <i class="fas fa-plug"></i>
                    Connect Contract
                </button>
                <div id="contractStatus"></div>
                </div>
            </div>

            <!-- Wallet Status Card -->
            <div class="card" id="walletStatusCard" style="display: none;">
                <div class="card-header" id="walletStatusHeader" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 1.25rem;">
                    <h2 style="margin: 0;"><i class="fas fa-wallet"></i> Wallet Status</h2>
                    <i id="walletToggleIcon" class="fas fa-chevron-down"></i>
                </div>
                <div id="walletStatusContent" style="display: none;">
                <div class="wallet-info-grid">
                    <div class="info-item">
                        <span class="info-label">Address:</span>
                        <span class="info-value" id="statusWalletAddress">Not Connected</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Role:</span>
                        <span class="info-value" id="walletRole">
                            <span class="badge badge-secondary">None</span>
                        </span>
                    </div>
                    <div class="info-item" id="serverIdItem" style="display: none;">
                        <span class="info-label">Server ID:</span>
                        <span class="info-value" id="serverId">
                            <span class="badge badge-info">#0000</span>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Fee Status:</span>
                        <span class="info-value" id="feeExemptStatus">
                            <span class="badge badge-warning">Not Exempt</span>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Balance:</span>
                        <span class="info-value" id="walletBalance">0 TRX</span>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="refreshWalletStatus()" style="margin-top: 1rem;">
                    <i class="fas fa-sync-alt"></i>
                    Refresh Status
                </button>
                <button class="btn btn-primary" onclick="debugCheckRoles()" style="margin-top: 1rem; margin-left: 0.5rem;">
                    <i class="fas fa-bug"></i>
                    Debug Check
                </button>
                <button class="btn btn-success" onclick="fixMyFeeExemption()" style="margin-top: 1rem; margin-left: 0.5rem; display: none;" id="fixExemptionBtn">
                    <i class="fas fa-wrench"></i>
                    Fix Exemption
                </button>
                
                <!-- Detailed Role Check -->
                <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <h4 style="margin-bottom: 0.5rem;">Detailed Role Check</h4>
                    <div id="roleCheckDetails" style="font-size: 0.875rem; color: var(--text-secondary);">
                        Click refresh to check all roles...
                    </div>
                </div>
                
                <!-- Debug Output (separate div to prevent overwriting) -->
                <div id="debugOutput" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--accent-blue);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <h4 style="margin: 0;">Debug Information</h4>
                        <button class="btn btn-sm btn-secondary" onclick="copyDebugInfo()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div id="debugContent" style="font-size: 0.875rem; color: var(--text-secondary);">
                    </div>
                </div>
                </div>
            </div>

            <!-- New User Registration Notice -->
            <div id="registrationNotice" class="notification-banner">
                <i class="fas fa-info-circle"></i>
                <div style="flex: 1;">
                    <strong>New User?</strong>
                    Please register as a Process Server to get your unique identifier.
                    <button class="btn btn-primary btn-small" style="margin-left: 1rem;" onclick="openRegistrationModal()">
                        <i class="fas fa-user-plus"></i> Register Now
                    </button>
                </div>
                <button class="btn-icon" onclick="dismissRegistrationNotice()" title="Dismiss">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Server ID Display -->
            <div id="serverIdDisplay" style="display: none; margin-bottom: 1.5rem;">
                <div class="server-id-display">
                    <i class="fas fa-id-badge"></i>
                    Your Server ID: <span id="userServerId">00</span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid-3" id="quickActions" style="margin-bottom: 2rem;">
                <div class="action-card primary server-only" onclick="openMintModal()">
                    <i class="fas fa-file-upload"></i>
                    <h3>Create Legal Notice</h3>
                    <p>Serve legal documents to any wallet address - perfect for unknown owners</p>
                </div>
                
                <div class="action-card" onclick="openAuditModal()">
                    <i class="fas fa-clipboard-check"></i>
                    <h3>Audit Issued Notices</h3>
                    <p>View all notices, delivery status, and transaction details</p>
                </div>
                
                <div class="action-card server-only" onclick="openRegistrationForUser()">
                    <i class="fas fa-user-tie"></i>
                    <h3>Become a Process Server</h3>
                    <p>Register to serve legal documents professionally</p>
                </div>
            </div>

            <!-- My Alerts -->
            <div class="card" id="myAlertsCard">
                <div class="card-header">
                    <h2><i class="fas fa-bell"></i> <span class="alerts-title" data-translate="blockserved.myNotices">My Legal Notice Alerts</span></h2>
                    <button class="btn btn-secondary btn-small" onclick="refreshMyAlerts()">
                        <i class="fas fa-sync"></i> <span data-translate="blockserved.refresh">Refresh</span>
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="debugRefreshNotices()" title="Force initialize contract and refresh">
                        <i class="fas fa-plug"></i> <span data-translate="blockserved.connectRefresh">Connect & Refresh</span>
                    </button>
                    <button class="btn btn-secondary btn-small debug-button" onclick="debugAlerts()">
                        <i class="fas fa-bug"></i> Debug
                    </button>
                </div>
                
                <!-- Wallet Search Section -->
                <div id="walletSearchSection" style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #e5e7eb;">
                    <div style="max-width: 600px; margin: 0 auto;">
                        <h3 style="margin-bottom: 1rem; color: #1e40af;">
                            <i class="fas fa-search"></i> <span data-translate="blockserved.searchTitle">Search for Notices by Wallet Address</span>
                        </h3>
                        <p style="margin-bottom: 1rem; color: #64748b;" data-translate="blockserved.searchDescription">
                            Don't want to connect your wallet? Enter any wallet address to view their public notices.
                        </p>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" 
                                   id="walletSearchInput" 
                                   placeholder="Enter TRON wallet address (e.g., TFfagVe1aZp...)" 
                                   data-translate="blockserved.searchPlaceholder"
                                   class="form-input" 
                                   style="flex: 1;"
                                   onkeypress="if(event.key === 'Enter') searchWalletNotices()">
                            <button class="btn btn-primary" onclick="searchWalletNotices()">
                                <i class="fas fa-search"></i> <span data-translate="blockserved.searchButton">Search</span>
                            </button>
                        </div>
                        <div id="walletSearchError" style="color: #dc2626; margin-top: 0.5rem; display: none;"></div>
                    </div>
                </div>
                
                <!-- New user-friendly explanation banner -->
                <div class="alert alert-info" style="margin: 1rem; display: none; background: #f0f9ff; border: 2px solid #3b82f6;" id="alertExplainer">
                    <div style="display: flex; align-items: start; gap: 1rem;">
                        <i class="fas fa-envelope-open-text" style="color: #3b82f6; font-size: 1.5rem; margin-top: 0.25rem;"></i>
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; color: #1e40af;">You Have Received Official Legal Documents</h4>
                            <p style="margin: 0 0 0.5rem 0; color: #1e3a8a;">
                                These are verified legal notices delivered electronically through blockchain technology. 
                                Just like certified mail, these documents require your signature to confirm receipt.
                            </p>
                            <div style="background: #dbeafe; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem;">
                                <p style="margin: 0; font-weight: 600; color: #1e40af;">
                                    <i class="fas fa-shield-alt" style="margin-right: 0.5rem;"></i>
                                    Your signature only confirms you received the document - it does NOT mean you agree with it or admit any wrongdoing.
                                </p>
                            </div>
                            <p style="margin: 0.75rem 0 0 0; color: #1e3a8a; font-size: 0.875rem;">
                                <strong>What to do:</strong> Review each notice below and click "Sign Receipt" to confirm delivery. 
                                Consider seeking legal advice if you have questions about the content.
                            </p>
                            <div style="background: #fef3c7; padding: 0.75rem; border-radius: 6px; margin-top: 0.75rem; border: 1px solid #f59e0b;">
                                <p style="margin: 0; color: #92400e; font-weight: 600;">
                                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem; color: #d97706;"></i>
                                    Warning: Failing to respond to legal notices by their deadlines may result in default judgment against you. 
                                    The court may rule in favor of the other party if you do not respond in time.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="myAlertsContent">
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>No alerts yet</h3>
                        <p>Click refresh to check for new legal notices</p>
                    </div>
                </div>
            </div>

            <!-- Process Server Stats -->
            <div class="card" id="serverStatsCard">
                <div class="card-header">
                    <h2><i class="fas fa-chart-bar"></i> My Service Statistics</h2>
                </div>
                <div id="serverStatsContent">
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="stat-card" style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
                            <i class="fas fa-file-contract" style="font-size: 2rem; color: var(--accent-blue); margin-bottom: 0.5rem;"></i>
                            <div class="stat-value" id="totalServedStat" style="font-size: 1.5rem; font-weight: bold;">0</div>
                            <div class="stat-label" style="color: var(--text-muted); font-size: 0.875rem;">Total Served</div>
                        </div>
                        <div class="stat-card" style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
                            <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success-green); margin-bottom: 0.5rem;"></i>
                            <div class="stat-value" id="acceptedStat" style="font-size: 1.5rem; font-weight: bold;">0</div>
                            <div class="stat-label" style="color: var(--text-muted); font-size: 0.875rem;">Accepted</div>
                        </div>
                        <div class="stat-card" style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
                            <i class="fas fa-clock" style="font-size: 2rem; color: var(--warning-yellow); margin-bottom: 0.5rem;"></i>
                            <div class="stat-value" id="pendingStat" style="font-size: 1.5rem; font-weight: bold;">0</div>
                            <div class="stat-label" style="color: var(--text-muted); font-size: 0.875rem;">Pending</div>
                        </div>
                        <div class="stat-card" style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; text-align: center;">
                            <i class="fas fa-percentage" style="font-size: 2rem; color: var(--accent-purple); margin-bottom: 0.5rem;"></i>
                            <div class="stat-value" id="successRateStat" style="font-size: 1.5rem; font-weight: bold;">0%</div>
                            <div class="stat-label" style="color: var(--text-muted); font-size: 0.875rem;">Success Rate</div>
                        </div>
                    </div>
                    <div style="border-top: 1px solid var(--border-color); padding-top: 1rem;">
                        <h4 style="margin-bottom: 0.5rem; font-size: 1rem;">Quick Actions</h4>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-small btn-secondary" onclick="showTab('user')">
                                <i class="fas fa-plus"></i> New Notice
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="showTab('delivery')">
                                <i class="fas fa-truck"></i> Track Deliveries
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="openAuditModal()">
                                <i class="fas fa-search"></i> Audit Notices
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="card server-only" id="recentActivitiesCard">
                <div class="card-header">
                    <h2><i class="fas fa-history"></i> Recent Served Notices</h2>
                    <button class="btn btn-primary btn-small" onclick="unifiedSystem.syncAndRefresh()">
                        <i class="fas fa-cloud-download-alt"></i> Sync Blockchain
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="unifiedSystem.refreshData()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="hideTestCases()" title="Hide test cases">
                        <i class="fas fa-eye-slash"></i> Hide Test Cases
                    </button>
                </div>
                <div id="unifiedCasesContainer">
                    <!-- Unified system will render cases here -->
                    <div class="empty-state">
                        <i class="fas fa-clipboard"></i>
                        <h3>Loading cases...</h3>
                        <p>Your served notices will appear here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delivery Status Tab -->
        <div id="deliveryTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-truck"></i> Delivery Tracking Dashboard</h2>
                    <button class="btn btn-icon" onclick="refreshDeliveryStatus()" title="Refresh">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
                
                <!-- Delivery Stats Overview -->
                <div class="stats-section" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <i class="fas fa-paper-plane"></i>
                        <div class="stat-value" id="totalSentNotices">0</div>
                        <div class="stat-label">Notices Sent</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-double"></i>
                        <div class="stat-value" id="deliveredNotices">0</div>
                        <div class="stat-label">Delivered</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-hourglass-half"></i>
                        <div class="stat-value" id="pendingDelivery">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-percentage"></i>
                        <div class="stat-value" id="deliveryRate">0%</div>
                        <div class="stat-label">Delivery Rate</div>
                    </div>
                </div>
                
                <!-- Search and Filter Options -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-search"></i> Search Notices</label>
                        <input type="text" 
                               id="deliverySearchInput" 
                               class="form-control" 
                               placeholder="Search by Notice ID, Case Number, or Recipient Address..." 
                               onkeyup="filterDeliveryResults()"
                               style="padding: 0.75rem; font-size: 1rem;">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-filter"></i> Filter by Status</label>
                        <select id="deliveryStatusFilter" onchange="filterDeliveryResults()" class="form-select">
                            <option value="all">All Notices</option>
                            <option value="pending">Pending Delivery</option>
                            <option value="delivered">Delivered (Accepted)</option>
                            <option value="recent">Last 7 Days</option>
                        </select>
                    </div>
                </div>
                
                <!-- Delivery Results -->
                <div id="deliveryResults">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No notices to track</h3>
                        <p>Your sent notices will appear here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="adminTab" class="tab-content">
            <!-- Admin Access Check -->
            <div id="adminAccessDenied" class="alert alert-error" style="display: none;">
                <i class="fas fa-lock"></i>
                <div>
                    <strong>Access Denied</strong>
                    <p>You need admin role to access this section.</p>
                </div>
            </div>

            <div id="adminContent" style="display: none;">
                <!-- Admin Stats -->
                <div id="adminStats" style="margin-bottom: 2rem;">
                    <!-- Stats will be populated by updateStatsFromLocalStorage() -->
                </div>
                
                <!-- Pending Registrations -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-user-clock"></i> Pending Process Server Registrations</h2>
                        <button class="btn btn-secondary btn-small" onclick="refreshPendingRegistrations()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div id="pendingRegistrations">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No pending registrations</h3>
                            <p>New registration requests will appear here</p>
                        </div>
                    </div>
                </div>

                <!-- All Registrations Viewer -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-database"></i> All Process Server Registrations</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-small" onclick="fetchAllRegistrations()">
                                <i class="fas fa-sync"></i> Load All
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="exportRegistrations()" style="display: none;" id="exportBtn">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                        </div>
                    </div>
                    <div id="allRegistrationsContent">
                        <div class="empty-state">
                            <i class="fas fa-cloud-download-alt"></i>
                            <h3>Click "Load All" to fetch registrations</h3>
                            <p>This will download and decrypt all registration files from GitHub</p>
                        </div>
                    </div>
                </div>

                <!-- Admin Controls -->
                <div class="admin-controls">
                    <!-- Fee Structure Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-coins"></i> Fee Structure Management</h2>
                        </div>
                        
                        <!-- Service Fee (Profit) -->
                        <div class="form-group">
                            <label class="form-label">Service Fee (Profit) - TRX</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number" class="form-input" id="serviceFee" 
                                       step="0.01" min="0" placeholder="20" style="flex: 1;">
                                <span class="form-help" id="currentServiceFee">Current: 20 TRX</span>
                            </div>
                            <p class="form-help">Revenue fee - can be waived for law enforcement</p>
                        </div>
                        
                        <!-- Creation Fee (Operations) -->
                        <div class="form-group">
                            <label class="form-label">Creation Fee (Operations) - TRX</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number" class="form-input" id="creationFee" 
                                       step="0.01" min="0" placeholder="10" style="flex: 1;">
                                <span class="form-help" id="currentCreationFee">Current: 10 TRX</span>
                            </div>
                            <p class="form-help">Operational costs - not waivable</p>
                        </div>
                        
                        <!-- Sponsorship Fee -->
                        <div class="form-group">
                            <label class="form-label">Sponsorship Fee (Recipient Support) - TRX</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number" class="form-input" id="sponsorshipFee" 
                                       step="0.01" min="0" placeholder="2" style="flex: 1;">
                                <span class="form-help" id="currentSponsorshipFee">Current: 2 TRX</span>
                            </div>
                            <p class="form-help">Funds recipient acceptance - not waivable</p>
                        </div>
                        
                        <div class="fee-summary">
                            <p><strong>Total Regular User Cost:</strong> <span id="totalRegularCost">32 TRX</span></p>
                            <p><strong>Total Law Enforcement Cost:</strong> <span id="totalLECost">12 TRX</span></p>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="updateServiceFee()" id="updateServiceFeeBtn">
                                <i class="fas fa-save"></i> Update Service Fee
                            </button>
                            <button class="btn btn-primary" onclick="updateCreationFee()" id="updateCreationFeeBtn">
                                <i class="fas fa-save"></i> Update Creation Fee
                            </button>
                            <button class="btn btn-primary" onclick="updateSponsorshipFee()" id="updateSponsorshipFeeBtn">
                                <i class="fas fa-save"></i> Update Sponsorship Fee
                            </button>
                        </div>
                        <div id="feeUpdateResult"></div>
                    </div>

                    <!-- IPFS Configuration -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-cloud-upload-alt"></i> IPFS Configuration (Pinata)</h2>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pinata API Key</label>
                            <input type="text" class="form-input" id="pinataApiKey" 
                                   placeholder="Enter your Pinata API key">
                            <p class="form-help">Get your API key from <a href="https://app.pinata.cloud/keys" target="_blank">Pinata Dashboard</a></p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pinata Secret API Key</label>
                            <input type="password" class="form-input" id="pinataSecretKey" 
                                   placeholder="Enter your Pinata Secret API key">
                            <p class="form-help">Keep this secret - it will be stored locally in your browser</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="savePinataKeys()">
                                <i class="fas fa-save"></i> Save Keys
                            </button>
                            <button class="btn btn-secondary" onclick="testPinataConnection()">
                                <i class="fas fa-check-circle"></i> Test Connection
                            </button>
                        </div>
                        <div id="pinataConfigResult"></div>
                    </div>

                    <!-- Role Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-users-cog"></i> Role & Exemption Management</h2>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Select Role</label>
                            <select class="form-input" id="roleSelect" onchange="toggleRegistrationForm()">
                                <option value="PROCESS_SERVER_ROLE">Process Server</option>
                                <option value="ADMIN_ROLE">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
    <label class="form-label">Wallet Address</label>
    <div style="display: flex; gap: 0.5rem;">
        <input type="text" class="form-input" id="roleAddress" 
               placeholder="Enter TRON wallet address" style="flex: 1;">
        <button class="btn btn-secondary btn-small" onclick="useConnectedAddress()" title="Use my address">
            <i class="fas fa-user"></i>
        </button>
    </div>
    <p class="form-help">Enter address or click button to use your connected wallet</p>
</div>
                        <!-- Process Server Registration Form -->
                        <div id="serverRegistrationForm" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Agency Name</label>
                                <input type="text" class="form-input" id="agencyName" placeholder="e.g., Smith & Associates Process Service">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agency Email</label>
                                <input type="email" class="form-input" id="agencyEmail" placeholder="agency@example.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Server Name</label>
                                <input type="text" class="form-input" id="serverName" placeholder="Full name of process server">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-input" id="serverPhone" placeholder="(555) 123-4567">
                            </div>
                        </div>
                        <!-- Action Buttons -->
                        <div style="margin-top: 1.5rem;">
                            <div style="display: flex; gap: 0.5rem; justify-content: flex-start;">
                                <button class="btn btn-primary btn-small" onclick="grantRole()" id="grantRoleBtn" style="padding: 0.5rem 1rem;">
                                    <i class="fas fa-user-plus"></i>
                                    Grant Role
                                </button>
                                <button class="btn btn-secondary btn-small" onclick="checkRole()" id="checkRoleBtn" style="padding: 0.5rem 1rem;">
                                    <i class="fas fa-user-check"></i>
                                    Check Role
                                </button>
                            </div>
                        </div>
                        <div id="roleResult"></div>
                    </div>

                    <!-- Fee Exemption Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-shield-alt"></i> Fee Exemption Management</h2>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Address to Manage Exemptions</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" class="form-input" id="exemptionAddress" 
                                       placeholder="Enter TRON wallet address" style="flex: 1;">
                                <button class="btn btn-secondary btn-small" onclick="useConnectedAddressForExemption()" title="Use my address">
                                    <i class="fas fa-user"></i> Use My Address
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Agency Name (for Law Enforcement)</label>
                            <input type="text" class="form-input" id="exemptionAgencyName" 
                                   placeholder="e.g., FBI, DEA, Local Police Department">
                            <p class="form-help">Required only for law enforcement exemptions</p>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="setLawEnforcementExemption()">
                                <i class="fas fa-badge-check"></i> Grant Law Enforcement Exemption
                            </button>
                            <button class="btn btn-warning" onclick="removeLawEnforcementExemption()">
                                <i class="fas fa-ban"></i> Remove Law Enforcement Exemption
                            </button>
                            <button class="btn btn-secondary" onclick="checkExemptionStatus()">
                                <i class="fas fa-info-circle"></i> Check Status
                            </button>
                        </div>
                        <div id="exemptionResult"></div>
                    </div>

                    <!-- Fee Collector Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-wallet"></i> Update Fee Collector</h2>
                        </div>
                        <div class="form-group">
    <label class="form-label">Fee Collector Address</label>
    <div style="display: flex; gap: 0.5rem;">
        <input type="text" class="form-input" id="feeCollectorAddress" 
               placeholder="Enter wallet address" style="flex: 1;">
        <button class="btn btn-secondary btn-small" onclick="useConnectedAddressForFeeCollector()" title="Use my address">
            <i class="fas fa-user"></i>
        </button>
    </div>
    <p class="form-help">Address that receives all contract fees</p>
</div>
                        <button class="btn btn-primary" onclick="updateFeeCollector()" id="updateFeeCollectorBtn">
                            <i class="fas fa-save"></i>
                            Update Fee Collector
                        </button>
                        <div id="feeCollectorResult"></div>
                    </div>

                    <!-- Transaction Verification -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-search-dollar"></i> Transaction Verification</h2>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Transaction Hash</label>
                            <input type="text" class="form-input" id="verifyTxHash" 
                                   placeholder="Enter transaction hash to verify NFT transfers">
                        </div>
                        <button class="btn btn-primary" onclick="verifyTransaction()">
                            <i class="fas fa-check-circle"></i>
                            Verify Transaction
                        </button>
                        <div id="txVerificationResult" style="margin-top: 1rem;"></div>
                    </div>

                    <!-- Audit Log Viewer -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-history"></i> Audit Logs</h2>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary btn-small" onclick="refreshAuditLogs()">
                                    <i class="fas fa-sync"></i> Refresh
                                </button>
                                <button class="btn btn-secondary btn-small" onclick="exportAuditLogs()">
                                    <i class="fas fa-download"></i> Export CSV
                                </button>
                            </div>
                        </div>
                        
                        <!-- Audit Filters -->
                        <div style="padding: 1rem; border-bottom: 1px solid var(--border-color);">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Status</label>
                                    <select class="form-input" id="auditStatusFilter" onchange="refreshAuditLogs()">
                                        <option value="">All</option>
                                        <option value="success">Success</option>
                                        <option value="failed">Failed</option>
                                        <option value="validation_error">Validation Errors</option>
                                        <option value="energy_error">Energy Errors</option>
                                        <option value="ipfs_error">IPFS Errors</option>
                                        <option value="blockchain_error">Blockchain Errors</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Date Range</label>
                                    <input type="date" class="form-input" id="auditStartDate" onchange="refreshAuditLogs()">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">To</label>
                                    <input type="date" class="form-input" id="auditEndDate" onchange="refreshAuditLogs()">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label">Sender Address</label>
                                    <input type="text" class="form-input" id="auditSenderFilter" placeholder="Filter by sender" onkeyup="debounceAuditRefresh()">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Audit Statistics -->
                        <div id="auditStatistics" style="padding: 1rem; background: var(--bg-secondary); display: none;">
                            <h4 style="margin-bottom: 1rem;">Statistics</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div class="stat-card">
                                    <div class="stat-value" id="totalAttempts">0</div>
                                    <div class="stat-label">Total Attempts</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" style="color: var(--success);" id="successCount">0</div>
                                    <div class="stat-label">Successful</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" style="color: var(--error);" id="failedCount">0</div>
                                    <div class="stat-label">Failed</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="uniqueSenders">0</div>
                                    <div class="stat-label">Unique Senders</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Audit Logs Table -->
                        <div id="auditLogsContent" style="max-height: 600px; overflow-y: auto;">
                            <div class="empty-state">
                                <i class="fas fa-history"></i>
                                <h3>Click Refresh to load audit logs</h3>
                                <p>View all notice service attempts and failures</p>
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="auditPagination" style="padding: 1rem; border-top: 1px solid var(--border-color); display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    Showing <span id="auditShowingStart">0</span> - <span id="auditShowingEnd">0</span> of <span id="auditTotal">0</span>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-secondary btn-small" onclick="previousAuditPage()" id="auditPrevBtn" disabled>
                                        <i class="fas fa-chevron-left"></i> Previous
                                    </button>
                                    <button class="btn btn-secondary btn-small" onclick="nextAuditPage()" id="auditNextBtn">
                                        Next <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contract Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-cog"></i> Contract Management</h2>
                        </div>
                        <!-- Resource Sponsorship removed - not in simplified contract -->
                        <!--
                        <div class="form-group">
                            <label class="form-label">Resource Sponsorship</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="resourceSponsorshipCheck" checked>
                                <label for="resourceSponsorshipCheck">Enable resource sponsorship</label>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="updateResourceSponsorship()">
                            <i class="fas fa-save"></i>
                            Update Settings
                        </button>
                        <div id="contractManagementResult"></div>
                        -->
                        
                        <!-- Energy Delegation Section -->
                        <div class="form-group" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                            <h3 style="margin-bottom: 1rem;">
                                <i class="fas fa-bolt"></i> Energy Delegation
                            </h3>
                            <p class="form-help" style="margin-bottom: 1rem;">
                                Stake TRX to delegate energy to the contract. This allows the contract to pay for user transaction energy costs.
                                <br>Each notice requires ~500,000 energy. 20,000 TRX staked = ~504,000 energy/day
                            </p>
                            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                <button class="btn btn-secondary" onclick="checkContractResources()">
                                    <i class="fas fa-battery-half"></i> Check Resources
                                </button>
                                <button class="btn btn-primary" onclick="showDelegateEnergyModal()">
                                    <i class="fas fa-bolt"></i> Delegate Energy
                                </button>
                            </div>
                            <div id="contractResourceStatus" style="font-size: 0.875rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; display: none;">
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                            <label class="form-label">Withdraw TRX from Contract</label>
                            <input type="number" class="form-input" id="withdrawAmount" placeholder="Amount in TRX" step="0.1">
                            <p class="form-help">Withdraw TRX from contract balance (admin only)</p>
                            <button class="btn btn-warning" onclick="withdrawFromContract()">
                                <i class="fas fa-coins"></i>
                                Withdraw TRX
                            </button>
                        </div>
                    </div>

                    <!-- GitHub Storage Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-lock"></i> Encrypted Storage Settings</h2>
                        </div>
                        
                        <!-- GitHub Token -->
                        <div class="form-group">
                            <label class="form-label">GitHub Personal Access Token</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="password" class="form-input" id="githubToken" 
                                       placeholder="ghp_..." style="flex: 1;">
                                <button class="btn btn-secondary btn-small" onclick="toggleTokenVisibility()" title="Show/Hide">
                                    <i class="fas fa-eye" id="tokenVisibilityIcon"></i>
                                </button>
                            </div>
                            <p class="form-help">Token for saving encrypted registrations to GitHub</p>
                        </div>
                        
                        <!-- Encryption Key Display -->
                        <div class="form-group">
                            <label class="form-label">Encryption Key (Auto-generated)</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="text" class="form-input" id="encryptionKey" 
                                       readonly style="flex: 1; background: var(--secondary-navy); cursor: not-allowed;">
                                <button class="btn btn-secondary btn-small" onclick="copyEncryptionKey()" title="Copy key">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <p class="form-help">Save this key securely - needed to decrypt registration files</p>
                        </div>
                        
                        <!-- Test Connection -->
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="saveGitHubSettings()">
                                <i class="fas fa-save"></i>
                                Save Settings
                            </button>
                            <button class="btn btn-secondary" onclick="testGitHubConnection()">
                                <i class="fas fa-check-circle"></i>
                                Test Connection
                            </button>
                        </div>
                        <div id="githubSettingsResult"></div>
                    </div>
                </div>
            </div>
        </div>

        
        <!-- Analytics Tab -->
        <div class="tab-content" id="analytics" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-line"></i> Performance Analytics</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="analyticsTimeRange" class="form-select" style="width: auto;" onchange="updateAnalytics()">
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="all">All time</option>
                        </select>
                        <button class="btn btn-secondary btn-small" onclick="exportAnalytics()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="analytics-summary">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalNoticesServed">0</div>
                            <div class="stat-label">Total Notices</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="acceptanceRate">0%</div>
                            <div class="stat-label">Acceptance Rate</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="avgResponseTime">-</div>
                            <div class="stat-label">Avg Response Time</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-coins"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalRevenue">0 TRX</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Section -->
                <div class="analytics-charts">
                    <div class="chart-container">
                        <h3>Notices Over Time</h3>
                        <canvas id="noticesChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Notice Types Distribution</h3>
                        <canvas id="typesChart" width="200" height="200"></canvas>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="recent-activity">
                    <h3>Recent Activity</h3>
                    <div id="recentActivityList">
                        <div class="empty-state">
                            <i class="fas fa-chart-line"></i>
                            <p>No activity data available</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Tab -->
        <div id="infoTab" class="tab-content">
            <!-- FAQ Accordion -->
            <div class="faq-container" id="faqContainer">
                <h2 style="margin-bottom: 2rem;"><i class="fas fa-question-circle"></i> Frequently Asked Questions</h2>
                
                <!-- FAQ content will be dynamically populated based on domain -->
            </div>
        </div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-user-plus"></i>
                    Process Server Registration
                </h3>
                <button class="modal-close" onclick="closeRegistrationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Important:</strong> Registration requires admin approval. You'll be notified once approved.
                        <br><small style="margin-top: 0.5rem; display: block;">
                            <a href="#" onclick="closeRegistrationModal(); switchTab('info'); setTimeout(() => { document.querySelector('.faq-header').parentElement.querySelectorAll('.faq-header')[document.querySelector('.faq-header').parentElement.querySelectorAll('.faq-header').length - 2].click(); }, 100); return false;">
                                Learn more about becoming a Process Server <i class="fas fa-external-link-alt"></i>
                            </a>
                        </small>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Agency/Company Name</label>
                    <input type="text" class="form-input" id="regAgency" 
                           placeholder="Enter your agency or company name">
                </div>
                <div class="form-group">
                    <label class="form-label">License/Certification Number</label>
                    <input type="text" class="form-input" id="regLicense" 
                           placeholder="Enter your professional license or certification number">
                    <p class="form-help">Required for verification of process server credentials</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Purpose/Use Case</label>
                    <textarea class="form-input" id="regPurpose" rows="3"
                             placeholder="Describe how you'll use the system"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Contact Email</label>
                    <input type="email" class="form-input" id="regEmail" 
                           placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-input" id="regPhone" 
                           placeholder="(555) 123-4567">
                    <p class="form-help">For verification purposes only</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Wallet Address</label>
                    <input type="text" class="form-input" id="regWallet" readonly>
                    <p class="form-help">This is your connected wallet address</p>
                </div>
                <button class="btn btn-primary" onclick="submitRegistration()">
                    <i class="fas fa-paper-plane"></i>
                    Submit Registration
                </button>
                <button class="btn btn-secondary" onclick="closeRegistrationModal()" style="margin-left: 0.5rem;">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <div id="registrationResult" style="margin-top: 1rem;"></div>
            </div>
        </div>
    </div>

    <!-- Registration Success Modal -->
    <div id="registrationSuccessModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    Registration Submitted
                </h3>
                <button class="modal-close" onclick="closeRegistrationSuccessModal()">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <i class="fas fa-user-check" style="font-size: 4rem; color: var(--success); margin-bottom: 1rem;"></i>
                <h4 style="margin-bottom: 1rem;">Your registration has been submitted successfully!</h4>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    An administrator will review your application and assign you a Server ID. 
                    You'll be notified once your registration is approved.
                </p>
                <button class="btn btn-primary" onclick="closeRegistrationSuccessModal()">
                    <i class="fas fa-check"></i>
                    OK
                </button>
            </div>
        </div>
    </div>
    
    <!-- Acceptance Receipt Modal -->
    <div id="acceptanceReceiptModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-certificate"></i>
                    Acceptance Receipt
                </h3>
                <button class="modal-close" onclick="closeAcceptanceReceiptModal()">&times;</button>
            </div>
            <div class="modal-body" id="acceptanceReceiptContent">
                <!-- Receipt content will be dynamically generated -->
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1rem; border-top: 1px solid var(--border-color);">
                <button class="btn btn-secondary" onclick="printAcceptanceReceipt()">
                    <i class="fas fa-print"></i> Print
                </button>
                <button class="btn btn-primary" onclick="exportAcceptanceReceipt()">
                    <i class="fas fa-download"></i> Export HTML
                </button>
                <button class="btn btn-success" onclick="closeAcceptanceReceiptModal()">
                    <i class="fas fa-check"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Mint Modal -->
    <div id="mintModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-upload"></i>
                    Create Legal Notice
                </h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-secondary" onclick="clearAllFormData()" style="font-size: 0.9rem;" title="Clear all form data">
                        <i class="fas fa-eraser"></i>
                        Clear All
                    </button>
                    <button class="btn btn-secondary" onclick="openBatchMode()" style="font-size: 0.9rem;">
                        <i class="fas fa-layer-group"></i>
                        Batch Mode
                    </button>
                    <button class="modal-close" onclick="closeMintModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <!-- Step 1: Upload -->
                <div id="mintStep1">
                    <h4 style="margin-bottom: 1rem;">Step 1: Upload Document Image</h4>
                    <div class="alert alert-info" style="margin-bottom: 1rem;">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Document Requirements:</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                <li>Format: JPEG or PNG only</li>
                                <li>Recommended: 8.511" documents</li>
                                <li>Max file size: 400KB after compression</li>
                                <li>Documents will be automatically optimized for blockchain storage</li>
                                <li>High-resolution documents will be compressed to ensure transaction success</li>
                            </ul>
                        </div>
                    </div>
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary);"></i>
                        <p>Drag & drop your document here or click to browse</p>
                        <p style="font-size: 0.85rem; color: #666;">Supported formats: JPEG, PNG</p>
                        <input type="file" id="documentUpload" accept="image/jpeg,image/jpg,image/png,application/pdf,.pdf" multiple onchange="handleDocumentUpload(event)">
                        <!-- Backup button in case click handler fails -->
                        <button type="button" class="btn btn-primary" style="margin-top: 10px;" onclick="document.getElementById('documentUpload').click()">
                            <i class="fas fa-folder-open"></i> Select File
                        </button>
                    </div>
                    <div id="compressionStatus" class="compression-status" style="display: none;">
                        <h5 style="color: var(--accent-blue); margin-bottom: 0.5rem;">
                            <i class="fas fa-compress"></i> Processing Document
                        </h5>
                        <div id="compressionStatusText" style="margin-bottom: 0.5rem; color: var(--text-secondary);">Preparing...</div>
                        <div class="compression-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="compressionProgress" style="width: 0%;"></div>
                            </div>
                            <div class="progress-text" id="compressionText">0%</div>
                        </div>
                        <div id="compressionDetails" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);"></div>
                    </div>
                    
                    <!-- Next button to proceed to step 2 -->
                    <div id="proceedToStep2" style="display: none; margin-top: 30px; text-align: center;">
                        <button class="btn btn-primary btn-lg" onclick="showMintStep2()" style="padding: 1rem 2rem; font-size: 1.1rem;">
                            <i class="fas fa-arrow-right"></i>
                            Next: Enter Notice Details
                        </button>
                    </div>
                </div>

                <!-- Step 2: Details -->
                <div id="mintStep2" style="display: none;">
                    <h4 style="margin-bottom: 1rem;">Step 2: Legal Notice Details</h4>
                    
                    <div class="preview-container">
                        <div class="preview-image">
                            <img id="documentPreview" src="" alt="Document preview">
                            <button class="btn btn-secondary btn-small" style="margin-top: 0.5rem;" onclick="changeDocument()">
                                <i class="fas fa-exchange-alt"></i>
                                Change
                            </button>
                            <div id="uploadMetadata" class="upload-metadata" style="display: none;">
                                <h5>Document Info</h5>
                                <div class="metadata-item">
                                    <span>Original Size:</span>
                                    <strong id="originalSize">-</strong>
                                </div>
                                <div class="metadata-item">
                                    <span>Final Size:</span>
                                    <strong id="finalSize">-</strong>
                                </div>
                                <div class="metadata-item">
                                    <span>Compression:</span>
                                    <strong id="compressionRatio">-</strong>
                                </div>
                                <div class="metadata-item">
                                    <span>Format:</span>
                                    <strong id="fileFormat">-</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div class="preview-details">
                            <div class="form-group">
                                <label class="form-label">Recipient Address <span style="color: var(--error);">*</span></label>
                                <input type="text" class="form-input" id="mintRecipient" 
                                       placeholder="Enter recipient's TRON address" required>
                                <div class="validation-message" id="recipientValidation" style="display: none;"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Token Name</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span id="tokenPrefix" style="background: #374151; padding: 0.75rem; border-radius: 0.375rem 0 0 0.375rem; border: 1px solid #4b5563; border-right: none; color: #9ca3af; font-family: monospace;">PS#?-</span>
                                    <input type="text" class="form-input" id="mintTokenName" 
                                           placeholder="Legal Notice" 
                                           style="border-radius: 0 0.375rem 0.375rem 0; flex: 1;">
                                </div>
                                <p class="form-help">Token name (will be prepended with your server ID, e.g., PS#1-Legal Notice)</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Case Number</label>
                                <input type="text" class="form-input" id="mintCaseNumber" 
                                       placeholder="e.g., CV-2024-001234">
                                <p class="form-help">Use your standard case numbering format</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Jurisdiction</label>
                                <select class="form-input" id="mintJurisdiction">
                                    <option value="0">Federal</option>
                                    <option value="1">State</option>
                                    <option value="2">County</option>
                                    <option value="3">Municipal</option>
                                    <option value="4">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Document Type</label>
                                <select class="form-input" id="mintDocumentType">
                                    <option value="0">Summons</option>
                                    <option value="1">Complaint</option>
                                    <option value="2">Subpoena</option>
                                    <option value="3">Notice of Hearing</option>
                                    <option value="4">Notice of Seizure</option>
                                    <option value="5">Other</option>
                                </select>
                            </div>
                            
                            <!-- Delivery Method Selection -->
                            <div class="form-group">
                                <label class="form-label">Delivery Method</label>
                                <div class="delivery-options">
                                    <label class="delivery-option selected">
                                        <input type="radio" name="deliveryMethod" value="document" checked>
                                        <div class="delivery-option-title">
                                            <i class="fas fa-file-shield"></i> Document Images
                                        </div>
                                        <div class="delivery-option-cost">~150 TRX</div>
                                        <div class="delivery-option-desc">
                                            <strong>Secure Legal Service:</strong> Encrypted document + public text notice
                                            <br><small> Document encrypted with recipient's wallet</small>
                                            <br><small> Requires signature for proof of service</small>
                                            <br><small> Text notice will be publicly visible</small>
                                        </div>
                                    </label>
                                    
                                    <label class="delivery-option">
                                        <input type="radio" name="deliveryMethod" value="text">
                                        <div class="delivery-option-title">
                                            <i class="fas fa-comment-alt"></i> Text Only
                                        </div>
                                        <div class="delivery-option-cost">~15 TRX</div>
                                        <div class="delivery-option-desc">
                                            <strong>Public Notice:</strong> Text message only, no documents
                                            <br><small> For reminders, preliminary notices</small>
                                            <br><small> No signature required (view only)</small>
                                            <br><small> All content will be publicly visible</small>
                                        </div>
                                    </label>
                                    
                                </div>
                            </div>
                            
                            <!-- Document Images Notice Details -->
                            <div class="view-gated-details" id="viewGatedDetails" style="display: block;">
                                <div class="alert alert-info" style="margin-bottom: 1rem; background: #fef3c7; border-color: #f59e0b; color: #92400e;">
                                    <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                                    <strong>Important Privacy Notice:</strong>
                                    <br> The document image will be encrypted and only viewable by the recipient
                                    <br> The text fields below will be <strong>publicly visible on the blockchain</strong>
                                    <br> Only include non-sensitive information in these text fields
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Notice Type</label>
                                    <select id="noticeType" class="form-select" onchange="updateNoticeTemplate()">
                                        <option value="Notice of Seizure">Notice of Seizure</option>
                                        <option value="Summons">Summons</option>
                                        <option value="Subpoena">Subpoena</option>
                                        <option value="Restraining Order">Restraining Order</option>
                                        <option value="Eviction Notice">Eviction Notice</option>
                                        <option value="Legal Hold">Legal Hold</option>
                                        <option value="Asset Freeze">Asset Freeze</option>
                                        <option value="Custom" selected>Custom Notice</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" id="customNoticeTypeGroup" style="display: block;">
                                    <label class="form-label">Custom Notice Type</label>
                                    <input type="text" id="customNoticeType" class="form-input" 
                                           placeholder="e.g., Notice of Forfeiture" maxlength="50">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Issuing Agency</label>
                                    <input type="text" id="issuingAgency" class="form-input" 
                                           placeholder="e.g., U.S. Department of Justice, IRS, SEC" 
                                           maxlength="100" required>
                                    <p class="form-help">Government agency or court issuing this notice</p>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Specific Details / Amount</label>
                                    <input type="text" id="caseDetails" class="form-input" 
                                           placeholder="e.g., 245,000 USDT or Property at 123 Main St" 
                                           maxlength="100">
                                    <p class="form-help">Amount seized, property address, or other specifics</p>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Legal Rights / Access Information (Auto-generated)</label>
                                    <input type="text" id="legalRights" class="form-input" 
                                           placeholder="Access information will be generated automatically" 
                                           maxlength="200"
                                           value=""
                                           readonly
                                           style="background-color: #f8f9fa; cursor: not-allowed;">
                                    <p class="form-help">This will inform recipients how to access the full document and their rights</p>
                                </div>
                                
                                <div class="form-group" style="background: #1e293b; padding: 1rem; border-radius: 0.5rem; border: 1px solid #334155;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <i class="fas fa-gift" style="color: #10b981;"></i>
                                        <span style="font-weight: 600;">Recipient Sponsorship Included</span>
                                    </div>
                                    <p class="form-help" style="margin: 0;">All notices include a 2 TRX sponsorship fee that covers the recipient's acceptance costs. This ensures recipients can always view their legal documents without needing TRX.</p>
                                </div>
                            </div>
                            
                            <!-- Text Notice Input -->
                            <div class="text-notice-input active" id="textNoticeGroup" style="display: block;">
                                <div class="form-group" style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem; border: 2px solid #f59e0b;">
                                    <label for="noticeText" id="noticeTextLabel" style="color: #92400e; font-weight: 600;">
                                        <i class="fas fa-globe" style="color: #f59e0b;"></i> Public Notice Text
                                    </label>
                                    <input type="text" class="form-input" id="noticeText" 
                                           placeholder="e.g., Legal Notice: Summons for Case #CV-2024-001234"
                                           maxlength="100"
                                           style="border: 2px solid #f59e0b; background: white; color: #1e293b; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <div class="char-count"><span id="charCount">0</span> / 100 characters</div>
                                    <p class="form-help" id="noticeTextHelp" style="color: #92400e; font-weight: 500;">
                                        <i class="fas fa-exclamation-circle"></i> This text will be publicly visible on the blockchain
                                    </p>
                                </div>
                            </div>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-coins"></i>
                                <div>
                                    <strong>Estimated Fee:</strong> <span id="creationFeeDisplay">150 TRX</span>
                                    <br><small id="feeDescription">Encrypted document with public text notice</small>
                                </div>
                            </div>
                            
                            <!-- Note: Delivery confirmation is automatically tracked on-chain for all notices -->
                        </div>
                    </div>
                    
                    <!-- Fee Summary Display -->
                    <div id="feeSummaryBox" class="fee-summary-box" style="background: #1e293b; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid #334155; margin-top: 1.5rem;">
                        <h5 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-calculator" style="color: #3b82f6;"></i>
                            Total Cost Estimate
                        </h5>
                        <div class="fee-breakdown">
                            <div class="fee-item" style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #334155;">
                                <span id="feeTypeLabel">Document Notice Fee:</span>
                                <span id="baseFeeAmount" style="font-weight: 600;">150 TRX</span>
                            </div>
                            <div class="fee-item" style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #334155;">
                                <span>Recipient Sponsorship:</span>
                                <span style="font-weight: 600;">2 TRX</span>
                            </div>
                            <div class="fee-item" id="energyCostRow" style="display: none; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #334155;">
                                <span>Estimated Energy Cost:</span>
                                <span id="energyCostDisplay" style="font-weight: 600; color: #f59e0b;">0 TRX</span>
                            </div>
                            <div class="fee-total" style="display: flex; justify-content: space-between; padding: 0.75rem 0 0 0; font-size: 1.125rem;">
                                <span style="font-weight: 600;">Total Estimated Cost:</span>
                                <span id="totalCostAmount" style="font-weight: 700; color: #10b981;">~152 TRX</span>
                            </div>
                        </div>
                        <div class="fee-notes" style="margin-top: 1rem; font-size: 0.875rem; color: #94a3b8;">
                            <p id="energyNote" style="margin: 0.5rem 0;">
                                <i class="fas fa-info-circle"></i> Energy will be automatically rented for this transaction.
                            </p>
                            <p id="feeExemptionNote" style="margin: 0.5rem 0; display: none; color: #10b981;">
                                <i class="fas fa-check-circle"></i> <span id="exemptionText">Fee exemption applied</span>
                            </p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button class="btn btn-secondary" onclick="showMintStep(1)">
                            <i class="fas fa-arrow-left"></i>
                            Back
                        </button>
                        <button class="btn btn-secondary" onclick="previewNFT()">
                            <i class="fas fa-eye"></i>
                            Preview NFT
                        </button>
                        <button class="btn btn-primary" onclick="createLegalNotice()" id="createNoticeBtn">
                            <i class="fas fa-rocket"></i>
                            Create Legal Notice
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Result Modal -->
    <div id="transactionResultModal" class="modal" style="display: none;" onclick="event.stopPropagation();">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title" id="txResultTitle">
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    Transaction Complete
                </h3>
                <!-- No close button - user must acknowledge -->
            </div>
            <div class="modal-body">
                <div id="txResultContent" style="padding: 1rem;">
                    <!-- Content will be dynamically populated -->
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: center;">
                <button class="btn btn-primary" onclick="closeTransactionResultModal()" style="padding: 0.75rem 2rem;">
                    <i class="fas fa-check"></i> I Understand - Close
                </button>
            </div>
        </div>
    </div>

    <!-- Batch Mode Modal -->
    <div id="batchModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-layer-group"></i>
                    Batch Legal Notice Creation
                </h3>
                <button class="modal-close" onclick="closeBatchModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="batchStep1">
                    <h4>Upload Recipients CSV</h4>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>CSV Format Requirements:</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem;">
                                <li>Columns: wallet_address, notice_type, public_text (optional)</li>
                                <li>Maximum 100 recipients per batch</li>
                                <li>Example: TXa1b2c3..., Cease and Desist, Public notice text</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="upload-area" style="margin: 20px 0;" onclick="document.getElementById('csvUpload').click()">
                        <input type="file" id="csvUpload" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
                        <i class="fas fa-file-csv" style="font-size: 3rem; color: var(--primary);"></i>
                        <p>Click to upload CSV file</p>
                    </div>
                    
                    <h4 style="margin-top: 30px;">Upload Document (Optional)</h4>
                    <div class="upload-area" onclick="document.getElementById('batchDocumentUpload').click()">
                        <input type="file" id="batchDocumentUpload" accept="image/*,.pdf" style="display: none;" onchange="handleBatchDocumentUpload(event)">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary);"></i>
                        <p>Click to upload document</p>
                        <p style="font-size: 0.85rem; color: #666;">Same document will be encrypted individually for each recipient</p>
                    </div>
                </div>
                
                <div id="batchStep2" style="display: none;">
                    <h4>Review Batch Recipients</h4>
                    <div id="batchValidationResults"></div>
                    
                    <div style="margin: 20px 0;">
                        <label>Notice Details</label>
                        <input type="text" id="batchAgencyName" placeholder="Issuing Agency" class="form-control" style="margin-bottom: 10px;">
                        <input type="text" id="batchCaseNumber" placeholder="Case Number" class="form-control" style="margin-bottom: 10px;">
                        <textarea id="batchRightsStatement" placeholder="Access information will be auto-generated for each notice" class="form-control" rows="3" readonly style="background-color: #f8f9fa;"></textarea>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="batchManager.goBack()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <button class="btn btn-primary" onclick="batchManager.startBatch()">
                            <i class="fas fa-play"></i> Start Batch Processing
                        </button>
                    </div>
                </div>
                
                <div id="batchStep3" style="display: none;">
                    <h4>Processing Batch</h4>
                    <div class="batch-progress">
                        <div class="progress-bar">
                            <div id="batchProgressBar" class="progress-fill" style="width: 0%"></div>
                        </div>
                        <p id="batchProgressText" style="text-align: center; margin-top: 10px;">0 / 0 completed</p>
                    </div>
                    
                    <div id="batchResults" style="margin-top: 20px; max-height: 300px; overflow-y: auto;"></div>
                    
                    <div class="btn-group" style="margin-top: 20px;">
                        <button id="pauseBatchBtn" class="btn btn-secondary" onclick="batchManager.pauseBatch()">
                            <i class="fas fa-pause"></i> Pause
                        </button>
                        <button id="resumeBatchBtn" class="btn btn-secondary" onclick="batchManager.resumeBatch()" style="display: none;">
                            <i class="fas fa-play"></i> Resume
                        </button>
                        <button class="btn btn-primary" onclick="batchManager.exportResults()">
                            <i class="fas fa-download"></i> Export Results
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Service Attempt Modal -->
    <div id="serviceAttemptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-clipboard-list"></i>
                    Record Service Attempt
                </h3>
                <button class="modal-close" onclick="closeServiceAttemptModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="attemptNoticeId" value="">
                <div class="form-group">
                    <label class="form-label">Attempt Note</label>
                    <textarea class="form-input" id="attemptNote" rows="4" 
                              placeholder="E.g., No one at residence - 2nd attempt, Left with building manager, etc."></textarea>
                    <p class="form-help">Describe the service attempt details for legal record</p>
                </div>
                <button class="btn btn-primary" onclick="recordServiceAttempt()">
                    <i class="fas fa-save"></i>
                    Record Attempt
                </button>
                <button class="btn btn-secondary" onclick="closeServiceAttemptModal()" style="margin-left: 0.5rem;">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Audit Modal -->
    <div id="auditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-clipboard-check"></i>
                    Notice Audit & Delivery Status
                </h3>
                <button class="modal-close" onclick="closeAuditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Search Options</label>
                    <select class="form-input" id="auditSearchType" onchange="updateAuditSearch()">
                        <option value="noticeId">By Notice ID</option>
                        <option value="myNotices">My Issued Notices</option>
                        <option value="myAlerts">My Alert Notices</option>
                    </select>
                </div>
                
                <div id="auditSearchInput" class="form-group">
                    <label class="form-label">Notice ID</label>
                    <input type="text" class="form-input" id="auditNoticeId" 
                           placeholder="Enter notice ID (e.g., 0, 1, 2...)">
                </div>
                
                <button class="btn btn-primary" onclick="performAudit()" id="performAuditBtn">
                    <i class="fas fa-search"></i>
                    Search
                </button>
                
                <div id="auditResults" style="margin-top: 2rem;"></div>
            </div>
        </div>
    </div>

    <!-- Accept Notice Modal -->
    <div id="acceptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-signature" style="color: #3b82f6;"></i>
                    Electronic Signature Required - Legal Notice Receipt
                </h3>
                <button class="modal-close" onclick="closeAcceptModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom: 1rem; background: #e0f2fe; border-color: #3b82f6;">
                    <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                    <div>
                        <strong>Electronic Signature Request - Receipt of Legal Document</strong>
                        <p style="margin: 0.25rem 0 0 0;">By clicking "Sign Receipt" below, you are electronically signing that you have received this legal document. This is similar to signing for certified mail or a courier delivery.</p>
                        <p style="margin: 0.25rem 0 0 0; font-weight: 600;">Important: This signature only confirms receipt. It does NOT mean you agree with the contents, admit any wrongdoing, or waive any of your legal rights.</p>
                        <p style="margin: 0.5rem 0 0 0; color: #059669; font-weight: 600;">
                            <i class="fas fa-unlock" style="margin-right: 0.5rem;"></i>
                            After signing, you will gain access to view and download the complete legal document.
                        </p>
                        <p style="margin: 0.5rem 0 0 0; color: #dc2626; font-weight: 600;">
                            <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                            Warning: Failing to respond to this legal notice by the deadline may result in default judgment against you.
                        </p>
                    </div>
                </div>
                
                <div id="acceptDetails" style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">Document Information</h4>
                    <div class="token-item">
                        <div class="token-details">
                            <div class="token-detail">
                                <span>Notice ID:</span>
                                <span id="acceptNoticeId">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Document Type:</span>
                                <span id="acceptDocumentType">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Jurisdiction:</span>
                                <span id="acceptJurisdiction">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Case Number Hash:</span>
                                <span id="acceptCaseNumber">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Server:</span>
                                <span id="acceptServer">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Timestamp:</span>
                                <span id="acceptTimestamp">-</span>
                            </div>
                        </div>
                        <div id="acceptPreview" class="token-preview" style="display: none;">
                            <img id="acceptPreviewImage" src="" alt="Document preview">
                        </div>
                    </div>
                </div>

                <div class="alert alert-success" style="background: #d1fae5; border-color: #10b981; margin-bottom: 1rem;">
                    <i class="fas fa-download" style="color: #059669;"></i>
                    <div>
                        <strong>After Signing:</strong> You will be able to view and download the full legal document. The document is encrypted and only you can decrypt it with your wallet.
                    </div>
                </div>

                <div class="alert alert-warning" style="background: #fef3c7; border-color: #f59e0b;">
                    <i class="fas fa-file-signature" style="color: #d97706;"></i>
                    <div>
                        <strong>Legal Effect of Your Signature:</strong> Your electronic signature will be permanently recorded on the blockchain as proof that this document was delivered to you. This is legally equivalent to signing for certified mail and creates an immutable record of service.
                    </div>
                </div>

                <div style="margin-top: 1.5rem; display: flex; justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="closeAcceptModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="acceptNotice()" id="acceptNoticeBtn" style="background: #3b82f6; border-color: #3b82f6; padding: 0.75rem 1.5rem;">
                        <i class="fas fa-signature"></i>
                        Sign Receipt & Confirm Delivery
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Process Server Registration Modal -->
    <div id="registrationModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2><i class="fas fa-user-tie"></i> Process Server Registration</h2>
                <span class="close-btn" onclick="closeRegistrationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <i class="fas fa-info-circle"></i>
                    <strong>Note:</strong> The hybrid contract auto-assigns server IDs when roles are granted. 
                    Process servers cannot update their name/agency details after registration. 
                    Please ensure all information is correct before submitting.
                </div>
                <p style="margin-bottom: 1.5rem;">Please provide your professional information to complete process server registration. 
                <a href="#" onclick="closeRegistrationModal(); switchTab('info'); document.getElementById('faq-process-server').scrollIntoView();" style="color: var(--accent-blue);">
                    Learn more about being a process server 
                </a></p>
                
                <div class="form-group">
                    <label class="form-label">Agency Name *</label>
                    <input type="text" class="form-input" id="modalAgencyName" placeholder="e.g., Smith & Associates Process Service">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Agency Email *</label>
                    <input type="email" class="form-input" id="modalAgencyEmail" placeholder="agency@example.com">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Server Name *</label>
                    <input type="text" class="form-input" id="modalServerName" placeholder="Full name of process server">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" class="form-input" id="modalServerPhone" placeholder="(555) 123-4567">
                </div>
                
                <div class="form-group">
                    <label class="form-label">License Number</label>
                    <input type="text" class="form-input" id="modalLicenseNumber" placeholder="Optional: Professional license number">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Service Areas</label>
                    <textarea class="form-input" id="modalServiceAreas" rows="3" placeholder="List jurisdictions where you serve legal documents"></textarea>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Note:</strong> This information will be stored locally and associated with your wallet address for verification purposes.
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; display: flex; justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="closeRegistrationModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="submitAdminRegistration()">
                        <i class="fas fa-check"></i>
                        Complete Registration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Success Modal -->
    <div id="txModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    Transaction Successful
                </h3>
                <button class="modal-close" onclick="closeTxModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="txMessage" style="color: var(--text-primary); margin-bottom: 1rem;">
                    Your transaction has been successfully confirmed!
                </p>
                <div id="txDetails" style="margin-bottom: 1rem;"></div>
                <div class="tx-details">
                    <strong>Transaction Hash:</strong>
                    <div class="tx-hash" id="txHash"></div>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap;">
                <a id="txLink" href="#" target="_blank" class="btn btn-primary" style="text-decoration: none;">
                    <i class="fas fa-external-link-alt"></i>
                    View on Tronscan
                </a>
                <button class="btn btn-secondary" onclick="copyTxHash()">
                    <i class="fas fa-copy"></i>
                    Copy Hash
                </button>
                <button class="btn btn-secondary" onclick="exportReceipt()">
                    <i class="fas fa-print"></i>
                    Export Receipt
                </button>
                <button class="btn btn-secondary" onclick="closeTxModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- BEGIN JAVASCRIPT IN PART 3 -->
<!-- PART 3: JAVASCRIPT -->
    <script>
        // Configuration - Set your API keys here for production
        // Better approach: Use environment variables or server-side proxy
        
        // Backend API Configuration
        window.BACKEND_API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3001' 
            : 'https://nftserviceapp.onrender.com'; // Your Render backend URL
        
        // GitHub Storage Configuration
        window.GITHUB_STORAGE_CONFIG = {
            // Replace with your GitHub personal access token
            // Or leave empty to use localStorage configuration
            token: '',
            // IMPORTANT: Change this encryption key for security
            encryptionKey: 'NFTServiceApp-ProcessServer-SecureKey-2024'
        };
        
        // Global variables
        let tronWeb = null;
        let legalContract = null;
        window.legalContract = null; // Make globally accessible
        let currentUserServerId = null;
        let isAdmin = false;
        let isProcessServer = false;
        
        // Server registration management
        let serverRegistrations = {};
        try {
            serverRegistrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
        } catch (e) {
            serverRegistrations = {};
        }
        let recentActivity = [];
        
        // Get current user's agency information
        function getCurrentUserAgency() {
            if (!tronWeb || !tronWeb.defaultAddress) return null;
            const userAddress = tronWeb.defaultAddress.base58;
            const registration = serverRegistrations[userAddress];
            return registration ? registration.agencyName : null;
        }
        
        // Fee configuration
        let currentCreationFee = 0.1; // Default value in TRX
        
        // Document upload vars
        let uploadedImage = null;
        let uploadedFileInfo = null;
        let currentNoticeId = null;
        
        // Contract ABI - Complete ABI with all functions
        const CONTRACT_ABI = [
  {
    "inputs": [],
    "stateMutability": "nonpayable",
    "type": "constructor"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "address",
        "name": "owner",
        "type": "address"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "approved",
        "type": "address"
      },
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "tokenId",
        "type": "uint256"
      }
    ],
    "name": "Approval",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "address",
        "name": "owner",
        "type": "address"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "operator",
        "type": "address"
      },
      {
        "indexed": false,
        "internalType": "bool",
        "name": "approved",
        "type": "bool"
      }
    ],
    "name": "ApprovalForAll",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": false,
        "internalType": "address",
        "name": "oldCollector",
        "type": "address"
      },
      {
        "indexed": false,
        "internalType": "address",
        "name": "newCollector",
        "type": "address"
      }
    ],
    "name": "FeeCollectorUpdated",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "address",
        "name": "user",
        "type": "address"
      },
      {
        "indexed": false,
        "internalType": "bool",
        "name": "serviceFeeExempt",
        "type": "bool"
      },
      {
        "indexed": false,
        "internalType": "bool",
        "name": "fullFeeExempt",
        "type": "bool"
      }
    ],
    "name": "FeeExemptionSet",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": false,
        "internalType": "string",
        "name": "feeType",
        "type": "string"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "oldFee",
        "type": "uint256"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "newFee",
        "type": "uint256"
      }
    ],
    "name": "FeeUpdated",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "noticeId",
        "type": "uint256"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "server",
        "type": "address"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "recipient",
        "type": "address"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "timestamp",
        "type": "uint256"
      }
    ],
    "name": "LegalNoticeCreated",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "alertId",
        "type": "uint256"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "recipient",
        "type": "address"
      }
    ],
    "name": "NoticeAcknowledged",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "alertId",
        "type": "uint256"
      },
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "documentId",
        "type": "uint256"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "recipient",
        "type": "address"
      }
    ],
    "name": "NoticeServed",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": false,
        "internalType": "address",
        "name": "account",
        "type": "address"
      }
    ],
    "name": "Paused",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "address",
        "name": "recipient",
        "type": "address"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "energy",
        "type": "uint256"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "bandwidth",
        "type": "uint256"
      }
    ],
    "name": "ResourceSponsored",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "bytes32",
        "name": "role",
        "type": "bytes32"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "account",
        "type": "address"
      }
    ],
    "name": "RoleGranted",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "bytes32",
        "name": "role",
        "type": "bytes32"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "account",
        "type": "address"
      }
    ],
    "name": "RoleRevoked",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "address",
        "name": "server",
        "type": "address"
      },
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "serverId",
        "type": "uint256"
      }
    ],
    "name": "ServerRegistered",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "noticeId",
        "type": "uint256"
      },
      {
        "indexed": false,
        "internalType": "uint256",
        "name": "attemptNumber",
        "type": "uint256"
      },
      {
        "indexed": false,
        "internalType": "string",
        "name": "note",
        "type": "string"
      }
    ],
    "name": "ServiceAttemptRecorded",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": true,
        "internalType": "address",
        "name": "from",
        "type": "address"
      },
      {
        "indexed": true,
        "internalType": "address",
        "name": "to",
        "type": "address"
      },
      {
        "indexed": true,
        "internalType": "uint256",
        "name": "tokenId",
        "type": "uint256"
      }
    ],
    "name": "Transfer",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": false,
        "internalType": "address",
        "name": "account",
        "type": "address"
      }
    ],
    "name": "Unpaused",
    "type": "event"
  },
  {
    "inputs": [],
    "name": "ADMIN_ROLE",
    "outputs": [
      {
        "internalType": "bytes32",
        "name": "",
        "type": "bytes32"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "PROCESS_SERVER_ROLE",
    "outputs": [
      {
        "internalType": "bytes32",
        "name": "",
        "type": "bytes32"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "SERVICE_FEE",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "alertId",
        "type": "uint256"
      }
    ],
    "name": "acceptNotice",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "alertNotices",
    "outputs": [
      {
        "internalType": "address",
        "name": "recipient",
        "type": "address"
      },
      {
        "internalType": "address",
        "name": "sender",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "documentId",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "timestamp",
        "type": "uint256"
      },
      {
        "internalType": "bool",
        "name": "acknowledged",
        "type": "bool"
      },
      {
        "internalType": "string",
        "name": "issuingAgency",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "noticeType",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "caseNumber",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "caseDetails",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "legalRights",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "responseDeadline",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "previewImage",
        "type": "string"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "alertId",
        "type": "uint256"
      }
    ],
    "name": "alerts",
    "outputs": [
      {
        "internalType": "address",
        "name": "recipient",
        "type": "address"
      },
      {
        "internalType": "address",
        "name": "sender",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "documentId",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "timestamp",
        "type": "uint256"
      },
      {
        "internalType": "bool",
        "name": "acknowledged",
        "type": "bool"
      },
      {
        "internalType": "string",
        "name": "issuingAgency",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "noticeType",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "caseNumber",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "caseDetails",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "legalRights",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "responseDeadline",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "previewImage",
        "type": "string"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "to",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "tokenId",
        "type": "uint256"
      }
    ],
    "name": "approve",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "owner",
        "type": "address"
      }
    ],
    "name": "balanceOf",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "user",
        "type": "address"
      }
    ],
    "name": "calculateFee",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "creationFee",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "documentNotices",
    "outputs": [
      {
        "internalType": "string",
        "name": "encryptedIPFS",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "decryptionKey",
        "type": "string"
      },
      {
        "internalType": "address",
        "name": "authorizedViewer",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "alertId",
        "type": "uint256"
      },
      {
        "internalType": "bool",
        "name": "isRestricted",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "feeCollector",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "name": "fullFeeExemptions",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "alertId",
        "type": "uint256"
      }
    ],
    "name": "getAlertDetails",
    "outputs": [
      {
        "internalType": "address",
        "name": "recipient",
        "type": "address"
      },
      {
        "internalType": "address",
        "name": "sender",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "documentId",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "timestamp",
        "type": "uint256"
      },
      {
        "internalType": "bool",
        "name": "acknowledged",
        "type": "bool"
      },
      {
        "internalType": "string",
        "name": "issuingAgency",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "noticeType",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "caseNumber",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "caseDetails",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "legalRights",
        "type": "string"
      },
      {
        "internalType": "uint256",
        "name": "responseDeadline",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "tokenId",
        "type": "uint256"
      }
    ],
    "name": "getApproved",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "recipient",
        "type": "address"
      }
    ],
    "name": "getRecipientAlerts",
    "outputs": [
      {
        "internalType": "uint256[]",
        "name": "",
        "type": "uint256[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bytes32",
        "name": "role",
        "type": "bytes32"
      },
      {
        "internalType": "uint256",
        "name": "index",
        "type": "uint256"
      }
    ],
    "name": "getRoleMember",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bytes32",
        "name": "role",
        "type": "bytes32"
      }
    ],
    "name": "getRoleMemberCount",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "server",
        "type": "address"
      }
    ],
    "name": "getServerId",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "server",
        "type": "address"
      }
    ],
    "name": "getServerNotices",
    "outputs": [
      {
        "internalType": "uint256[]",
        "name": "",
        "type": "uint256[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "user",
        "type": "address"
      }
    ],
    "name": "getUserNotices",
    "outputs": [
      {
        "internalType": "uint256[]",
        "name": "",
        "type": "uint256[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bytes32",
        "name": "role",
        "type": "bytes32"
      },
      {
        "internalType": "address",
        "name": "account",
        "type": "address"
      }
    ],
    "name": "grantRole",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bytes32",
        "name": "role",
        "type": "bytes32"
      },
      {
        "internalType": "address",
        "name": "account",
        "type": "address"
      }
    ],
    "name": "hasRole",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "owner",
        "type": "address"
      },
      {
        "internalType": "address",
        "name": "operator",
        "type": "address"
      }
    ],
    "name": "isApprovedForAll",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "lastAttemptNote",
    "outputs": [
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "name",
    "outputs": [
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      }
    ],
    "stateMutability": "pure",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "notices",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "alertId",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "documentId",
        "type": "uint256"
      },
      {
        "internalType": "address",
        "name": "server",
        "type": "address"
      },
      {
        "internalType": "address",
        "name": "recipient",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "timestamp",
        "type": "uint256"
      },
      {
        "internalType": "bool",
        "name": "acknowledged",
        "type": "bool"
      },
      {
        "internalType": "string",
        "name": "noticeType",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "caseNumber",
        "type": "string"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "tokenId",
        "type": "uint256"
      }
    ],
    "name": "ownerOf",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "pause",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "paused",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "recipientAlerts",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "noticeId",
        "type": "uint256"
      },
      {
        "internalType": "string",
        "name": "note",
        "type": "string"
      }
    ],
    "name": "recordServiceAttempt",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "resourceSponsorshipEnabled",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bytes32",
        "name": "role",
        "type": "bytes32"
      },
      {
        "internalType": "address",
        "name": "account",
        "type": "address"
      }
    ],
    "name": "revokeRole",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "from",
        "type": "address"
      },
      {
        "internalType": "address",
        "name": "to",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "tokenId",
        "type": "uint256"
      }
    ],
    "name": "safeTransferFrom",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "from",
        "type": "address"
      },
      {
        "internalType": "address",
        "name": "to",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "tokenId",
        "type": "uint256"
      },
      {
        "internalType": "bytes",
        "name": "_data",
        "type": "bytes"
      }
    ],
    "name": "safeTransferFrom",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "recipient",
        "type": "address"
      },
      {
        "internalType": "string",
        "name": "encryptedIPFS",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "encryptionKey",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "issuingAgency",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "noticeType",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "caseNumber",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "caseDetails",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "legalRights",
        "type": "string"
      },
      {
        "internalType": "bool",
        "name": "sponsorFees",
        "type": "bool"
      },
      {
        "internalType": "string",
        "name": "metadataURI",
        "type": "string"
      }
    ],
    "name": "serveNotice",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "payable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "components": [
          {
            "internalType": "address",
            "name": "recipient",
            "type": "address"
          },
          {
            "internalType": "string",
            "name": "encryptedIPFS",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "encryptionKey",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "issuingAgency",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "noticeType",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "caseNumber",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "caseDetails",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "legalRights",
            "type": "string"
          },
          {
            "internalType": "bool",
            "name": "sponsorFees",
            "type": "bool"
          },
          {
            "internalType": "string",
            "name": "metadataURI",
            "type": "string"
          }
        ],
        "internalType": "struct LegalNoticeNFT_v5_Enumerable.BatchNotice[]",
        "name": "batchNotices",
        "type": "tuple[]"
      }
    ],
    "name": "serveNoticeBatch",
    "outputs": [
      {
        "internalType": "uint256[]",
        "name": "alertIds",
        "type": "uint256[]"
      },
      {
        "internalType": "uint256[]",
        "name": "documentIds",
        "type": "uint256[]"
      }
    ],
    "stateMutability": "payable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "serverById",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "name": "serverIds",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "serverNotices",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "serviceAttempts",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "serviceFee",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "name": "serviceFeeExemptions",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "operator",
        "type": "address"
      },
      {
        "internalType": "bool",
        "name": "approved",
        "type": "bool"
      }
    ],
    "name": "setApprovalForAll",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "user",
        "type": "address"
      },
      {
        "internalType": "bool",
        "name": "serviceFeeExempt",
        "type": "bool"
      },
      {
        "internalType": "bool",
        "name": "fullFeeExempt",
        "type": "bool"
      }
    ],
    "name": "setFeeExemption",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bool",
        "name": "enabled",
        "type": "bool"
      }
    ],
    "name": "setResourceSponsorship",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "name": "sponsoredBandwidth",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "name": "sponsoredEnergy",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "sponsorshipFee",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "bytes4",
        "name": "interfaceId",
        "type": "bytes4"
      }
    ],
    "name": "supportsInterface",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "pure",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "symbol",
    "outputs": [
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      }
    ],
    "stateMutability": "pure",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "index",
        "type": "uint256"
      }
    ],
    "name": "tokenByIndex",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "owner",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "index",
        "type": "uint256"
      }
    ],
    "name": "tokenOfOwnerByIndex",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "tokenTypes",
    "outputs": [
      {
        "internalType": "enum LegalNoticeNFT_v5_Enumerable.NoticeType",
        "name": "",
        "type": "uint8"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "tokenId",
        "type": "uint256"
      }
    ],
    "name": "tokenURI",
    "outputs": [
      {
        "internalType": "string",
        "name": "",
        "type": "string"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "owner",
        "type": "address"
      }
    ],
    "name": "tokensOfOwner",
    "outputs": [
      {
        "internalType": "uint256[]",
        "name": "",
        "type": "uint256[]"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "totalNotices",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "totalSupply",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "from",
        "type": "address"
      },
      {
        "internalType": "address",
        "name": "to",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "tokenId",
        "type": "uint256"
      }
    ],
    "name": "transferFrom",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "unpause",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "newFee",
        "type": "uint256"
      }
    ],
    "name": "updateCreationFee",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "newCollector",
        "type": "address"
      }
    ],
    "name": "updateFeeCollector",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "newFee",
        "type": "uint256"
      }
    ],
    "name": "updateServiceFee",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "newFee",
        "type": "uint256"
      }
    ],
    "name": "updateSponsorshipFee",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "documentId",
        "type": "uint256"
      }
    ],
    "name": "viewDocument",
    "outputs": [
      {
        "internalType": "string",
        "name": "encryptedIPFS",
        "type": "string"
      },
      {
        "internalType": "string",
        "name": "decryptionKey",
        "type": "string"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "withdraw",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "amount",
        "type": "uint256"
      }
    ],
    "name": "withdrawTRX",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  }
];


// Get document notices for a recipient (not alert notices)
async function getRecipientDocumentNotices(recipient) {
    try {
        console.log('Getting notices for recipient:', recipient);
        
        if (!legalContract) {
            console.error('Contract not initialized');
            return [];
        }
        
        const recipientNotices = [];
        
        // Get total notices to iterate through (using cache)
        const totalNotices = window.blockchainCache ? await window.blockchainCache.getTotalNotices() : await legalContract.totalNotices().call();
        console.log('Total notices in contract:', totalNotices.toString());
        
        // In v5 contract, notices array contains the mapping
        // Each notice has: alertId, documentId, server, recipient, timestamp, acknowledged, noticeType, caseNumber
        for (let i = 0; i < totalNotices; i++) {
            try {
                // Get the notice data (using cache)
                const noticeData = window.blockchainCache ? await window.blockchainCache.getNotice(i) : await legalContract.notices(i).call();
                console.log(`Notice ${i} data:`, noticeData);
                
                if (noticeData) {
                    let noticeRecipient;
                    
                    // The structure depends on how the data is returned
                    if (Array.isArray(noticeData)) {
                        // If it's an array, recipient is at index 3
                        noticeRecipient = noticeData[3];
                    } else if (noticeData.recipient) {
                        // If it's an object with named properties
                        noticeRecipient = noticeData.recipient;
                    }
                    
                    // Convert hex to base58 if needed
                    if (noticeRecipient && noticeRecipient.startsWith('41')) {
                        noticeRecipient = tronWeb.address.fromHex(noticeRecipient);
                    }
                    
                    // Check if this notice is for our recipient
                    if (noticeRecipient && noticeRecipient.toLowerCase() === recipient.toLowerCase()) {
                        console.log(`Found notice ${i} for recipient`);
                        
                        // Get the document ID from the notice
                        let documentId;
                        if (Array.isArray(noticeData)) {
                            documentId = noticeData[1]; // documentId is at index 1
                        } else if (noticeData.documentId) {
                            documentId = noticeData.documentId;
                        }
                        
                        // Check if there's actually a document attached
                        if (documentId) {
                            try {
                                const docNotice = window.blockchainCache ? await window.blockchainCache.getDocumentNotice(documentId) : await legalContract.documentNotices(documentId).call();
                                if (docNotice) {
                                    // v5 contract structure: encryptedIPFS, decryptionKey, authorizedViewer, alertId, isRestricted
                                    const hasIPFS = Array.isArray(docNotice) ? 
                                        (docNotice[0] && docNotice[0] !== '') : 
                                        (docNotice.encryptedIPFS && docNotice.encryptedIPFS !== '');
                                    
                                    if (hasIPFS) {
                                        console.log(`Notice ${i} has document with ID ${documentId}`);
                                        recipientNotices.push({
                                            noticeIndex: i,
                                            documentId: documentId,
                                            alertId: Array.isArray(noticeData) ? noticeData[0] : noticeData.alertId
                                        });
                                    }
                                }
                            } catch (e) {
                                console.log(`No document data for documentId ${documentId}`);
                            }
                        }
                    }
                }
            } catch (e) {
                console.error(`Error checking notice ${i}:`, e);
                continue;
            }
        }
        
        console.log('Notices with documents found:', recipientNotices);
        return recipientNotices;
        
    } catch (error) {
        console.error('Error in getRecipientDocumentNotices:', error);
        return [];
    }
}

// Legacy function for compatibility - now returns document notices instead of alerts
async function getRecipientNoticeIds(recipient) {
    return getRecipientDocumentNotices(recipient);
}

// Original alert notice function (keeping for reference but not using)
async function getRecipientAlertNotices(recipient) {
    try {
        console.log('Getting alert notices for recipient:', recipient);
        
        if (!legalContract) {
            console.error('Contract not initialized');
            return [];
        }
        
        // First, let's check what methods are available on the contract
        console.log('Available contract methods:', Object.keys(legalContract.methods || {}));
        console.log('Contract instance:', legalContract);
        console.log('Contract address being used:', legalContract._address || legalContract.address);
        
        // Try different method names that might exist
        const methodsToTry = [
            'getRecipientNotices',
            'getRecipientAlerts', 
            'recipientNotices',
            'getNoticesByRecipient',
            'balanceOf' // If using ERC721, we might need to iterate
        ];
        
        for (const method of methodsToTry) {
            if (legalContract[method]) {
                try {
                    console.log(`Trying method: ${method}`);
                    const result = await legalContract[method](recipient).call();
                    console.log(`${method} returned:`, result);
                    
                    // If balanceOf, we need to get token IDs differently
                    if (method === 'balanceOf' && result > 0) {
                        // For ERC721, we'd need to iterate through tokens
                        console.log('Token balance:', result.toString());
                        // This is a fallback - ideally we'd have a better method
                        const noticeIds = [];
                        // Try to get owned tokens (this is contract-specific)
                        return noticeIds;
                    }
                    
                    if (result && (Array.isArray(result) ? result.length > 0 : result > 0)) {
                        return Array.isArray(result) ? result : [result];
                    }
                } catch (e) {
                    console.log(`${method} failed:`, e.message);
                }
            }
        }
        
        console.log('No working method found to get recipient notices');
        return [];
    } catch (error) {
        console.error('Error getting recipient notices:', error);
        return [];
    }
}


async function calculateFeeFromConstants(userAddress) {
    try {
        // Check if user is law enforcement exempt
        const isExempt = await legalContract.serviceFeeExemptions(userAddress).call();
        
        // Get delivery method to determine base fee
        const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked')?.value || 'document';
        
        // Base fees in TRX
        const documentFee = 150; // 150 TRX for document notices
        const textOnlyFee = 15;  // 15 TRX for text-only notices
        const sponsorshipFee = 2; // 2 TRX sponsorship always required
        
        // Calculate base fee based on delivery method
        const baseFee = deliveryMethod === 'document' ? documentFee : textOnlyFee;
        
        if (isExempt) {
            // Law enforcement only pays sponsorship
            console.log('Law enforcement exempt - only paying sponsorship fee');
            return sponsorshipFee * 1000000; // Convert to sun
        } else {
            // Regular users pay base fee + sponsorship
            const totalFee = baseFee + sponsorshipFee;
            console.log(`Calculating fee: ${baseFee} TRX (${deliveryMethod}) + ${sponsorshipFee} TRX (sponsorship) = ${totalFee} TRX`);
            return totalFee * 1000000; // Convert to sun
        }
    } catch (error) {
        console.error('Error calculating fee:', error);
        // Default fee if calculation fails - document notice with sponsorship
        return 152000000; // 152 TRX default (150 + 2)
    }
}

// Helper functions for parsing optimized contract data
function parseMetadata(metadata) {
    const parts = metadata.split('|');
    return {
        noticeType: parts[0] || '',
        caseNumber: parts[1] || '',
        issuingAgency: parts[2] || ''
    };
}

function parseDocumentData(documentData) {
    const parts = documentData.split('|');
    return {
        encryptedIPFS: parts[0] || '',
        encryptionKey: parts[1] || ''
    };
}

function parsePackedData(packedData) {
    // Add error handling for undefined or invalid packed data
    if (packedData === undefined || packedData === null) {
        console.warn('parsePackedData: Received undefined or null data');
        return {
            timestamp: 0,
            serverId: 0,
            hasDocument: false,
            accepted: false
        };
    }
    
    try {
        const data = BigInt(packedData);
        return {
            timestamp: Number(data >> 192n),
            serverId: Number((data >> 64n) & 0xFFFFFFFFFFFFFFFFn),
            hasDocument: (data & 1n) === 1n,
            accepted: ((data >> 1n) & 1n) === 1n
        };
    } catch (error) {
        console.error('parsePackedData: Error parsing data:', error, 'Input:', packedData);
        return {
            timestamp: 0,
            serverId: 0,
            hasDocument: false,
            accepted: false
        };
    }
}


        
        // Get total notices from contract
        async function getTotalNotices() {
            if (!legalContract) return 0;
            
            try {
                // Complete contract doesn't have totalSupply
                // Would need to use events or other method to get total
                return 0;
            } catch (error) {
                console.log('Could not fetch total notices:', error);
                return 0;
            }
        }

        // Multi-chain configuration
        const CHAIN_CONFIG = {
            tron: {
                mainnet: {
                    name: 'TRON Mainnet',
                    contractAddress: window.APP_CONFIG?.contracts.tron.mainnet || 'TYour_Mainnet_Contract_Address',
                    explorerUrl: 'https://tronscan.org',
                    nativeToken: 'TRX',
                    chainId: null
                },
                nile: {
                    name: 'TRON Nile Testnet',
                    contractAddress: window.APP_CONFIG?.contracts.tron.nile || '',
                    explorerUrl: 'https://nile.tronscan.org',
                    nativeToken: 'TRX',
                    chainId: null
                },
                shasta: {
                    name: 'TRON Shasta Testnet',
                    contractAddress: window.APP_CONFIG?.contracts.tron.shasta || 'TYour_Shasta_Contract_Address',
                    explorerUrl: 'https://shasta.tronscan.org',
                    nativeToken: 'TRX',
                    chainId: null
                }
            },
            evm: {
                ethereum: {
                    name: 'Ethereum Mainnet',
                    contractAddress: '0xYour_Ethereum_Contract_Address',
                    explorerUrl: 'https://etherscan.io',
                    nativeToken: 'ETH',
                    chainId: 1,
                    rpcUrl: 'https://eth-mainnet.g.alchemy.com/v2/YOUR_ALCHEMY_KEY'
                },
                sepolia: {
                    name: 'Ethereum Sepolia',
                    contractAddress: '0xYour_Sepolia_Contract_Address',
                    explorerUrl: 'https://sepolia.etherscan.io',
                    nativeToken: 'ETH',
                    chainId: 11155111,
                    rpcUrl: 'https://eth-sepolia.g.alchemy.com/v2/YOUR_ALCHEMY_KEY'
                },
                polygon: {
                    name: 'Polygon Mainnet',
                    contractAddress: '0xYour_Polygon_Contract_Address',
                    explorerUrl: 'https://polygonscan.com',
                    nativeToken: 'MATIC',
                    chainId: 137,
                    rpcUrl: 'https://polygon-rpc.com'
                },
                mumbai: {
                    name: 'Polygon Mumbai',
                    contractAddress: '0xYour_Mumbai_Contract_Address',
                    explorerUrl: 'https://mumbai.polygonscan.com',
                    nativeToken: 'MATIC',
                    chainId: 80001,
                    rpcUrl: 'https://rpc-mumbai.maticvigil.com'
                },
                bsc: {
                    name: 'BNB Smart Chain',
                    contractAddress: '0xYour_BSC_Contract_Address',
                    explorerUrl: 'https://bscscan.com',
                    nativeToken: 'BNB',
                    chainId: 56,
                    rpcUrl: 'https://bsc-dataseed.binance.org'
                },
                bscTestnet: {
                    name: 'BSC Testnet',
                    contractAddress: '0xYour_BSC_Testnet_Contract_Address',
                    explorerUrl: 'https://testnet.bscscan.com',
                    nativeToken: 'BNB',
                    chainId: 97,
                    rpcUrl: 'https://data-seed-prebsc-1-s1.binance.org:8545'
                }
            }
        };

        // Current chain state
        let currentChainType = 'tron'; // 'tron' or 'evm'
        let currentNetwork = 'nile'; // Default to Nile testnet where contract is deployed
        let web3Instance = null;
        let evmContract = null;
        
        // Processing modal functions
        function showProcessing(message = 'Processing...') {
            let modal = document.getElementById('processingModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'processingModal';
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                modal.innerHTML = `
                    <div class="modal-content" style="background: var(--bg-primary); padding: 2rem; border-radius: 12px; text-align: center; max-width: 300px;">
                        <div class="loading-spinner" style="margin: 0 auto 1rem; width: 48px; height: 48px;"></div>
                        <p id="processingMessage" style="margin: 0; color: var(--text-primary);">${message}</p>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                document.getElementById('processingMessage').textContent = message;
                modal.style.display = 'flex';
            }
        }
        
        function hideProcessing() {
            const modal = document.getElementById('processingModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Show alert function
        function showAlert(elementId, type, message) {
            const element = document.getElementById(elementId);
            if (element) {
                const alertClass = type === 'success' ? 'alert-success' : 
                                 type === 'error' ? 'alert-error' : 
                                 type === 'warning' ? 'alert-warning' : 'alert-info';
                element.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
                element.style.display = 'block';
                
                // Auto-hide after 5 seconds for success messages
                if (type === 'success') {
                    setTimeout(() => {
                        element.style.display = 'none';
                    }, 5000);
                }
            }
        }
        
        // Get error message helper
        function getErrorMessage(error) {
            if (error.message) {
                if (error.message.includes('User rejected')) {
                    return 'Transaction cancelled by user';
                }
                if (error.message.includes('insufficient')) {
                    return 'Insufficient balance or energy';
                }
                return error.message;
            }
            return 'Unknown error occurred';
        }

        // Enhanced UI Manager
        class UIManager {
            constructor() {
                this.notifications = [];
            }

            showNotification(type, message, duration = 5000) {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type} notification-enter`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                    <button class="notification-close" onclick="uiManager.removeNotification(this)"></button>
                `;
                
                document.body.appendChild(notification);
                this.notifications.push(notification);
                
                // Trigger animation
                setTimeout(() => {
                    notification.classList.remove('notification-enter');
                    notification.classList.add('notification-active');
                }, 10);
                
                // Auto-remove after duration
                setTimeout(() => {
                    this.removeNotification(notification);
                }, duration);
            }

            removeNotification(notification) {
                // If passed a button, get the parent notification
                if (notification.tagName === 'BUTTON') {
                    notification = notification.parentElement;
                }
                
                notification.classList.remove('notification-active');
                notification.classList.add('notification-exit');
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                    const index = this.notifications.indexOf(notification);
                    if (index > -1) {
                        this.notifications.splice(index, 1);
                    }
                }, 300);
            }

            updateStats(stats) {
                document.getElementById('totalNotices').textContent = stats.total || '0';
                document.getElementById('acceptedNotices').textContent = stats.accepted || '0';
                document.getElementById('pendingNotices').textContent = stats.pending || '0';
                document.getElementById('activeServers').textContent = stats.servers || '0';
                
                // Show stats container if hidden (but keep collapsed state)
                const statsContainer = document.getElementById('statsContainer');
                if (statsContainer.style.display === 'none') {
                    statsContainer.style.display = 'block';
                }
            }

            updateBadge(tab, count) {
                const badge = document.getElementById(`${tab}Badge`);
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }

            showLoader() {
                document.getElementById('loader').style.display = 'flex';
            }

            hideLoader() {
                const loader = document.getElementById('loader');
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                    loader.style.opacity = '1';
                }, 500);
            }
        }

        const uiManager = new UIManager();
        
        
        
        // Analytics System
        class AnalyticsSystem {
            constructor() {
                this.data = JSON.parse(localStorage.getItem('analyticsData') || '{}');
                this.charts = {};
            }
            
            async loadAnalytics() {
                if (!legalContract || !tronWeb.defaultAddress) {
                    this.showNoData();
                    return;
                }
                
                try {
                    const address = tronWeb.defaultAddress.base58;
                    
                    // Process servers are managed via roles only in this contract
                    const serverId = 0; // Not tracked in this contract version
                    const noticesServed = myTransactions.length; // Count from local transactions
                    
                    // Load transaction history from localStorage
                    const transactions = JSON.parse(localStorage.getItem('userTransactions') || '[]');
                    const myTransactions = transactions.filter(tx => tx.sender === address);
                    
                    // Calculate stats
                    const timeRange = parseInt(document.getElementById('analyticsTimeRange').value);
                    const cutoffDate = timeRange === 0 ? 0 : Date.now() - (timeRange * 24 * 60 * 60 * 1000);
                    const filteredTx = myTransactions.filter(tx => tx.timestamp > cutoffDate);
                    
                    // Update summary stats
                    document.getElementById('totalNoticesServed').textContent = noticesServed;
                    
                    // Calculate acceptance rate (mock data for now)
                    const acceptanceRate = noticesServed > 0 ? Math.floor(70 + Math.random() * 20) : 0;
                    document.getElementById('acceptanceRate').textContent = acceptanceRate + '%';
                    
                    // Average response time (mock data)
                    const avgResponseTime = noticesServed > 0 ? (24 + Math.floor(Math.random() * 48)) + 'h' : '-';
                    document.getElementById('avgResponseTime').textContent = avgResponseTime;
                    
                    // Calculate revenue
                    const revenue = filteredTx.reduce((sum, tx) => sum + (tx.fee || 77), 0);
                    document.getElementById('totalRevenue').textContent = revenue + ' TRX';
                    
                    // Update charts
                    this.updateCharts(filteredTx);
                    
                    // Update recent activity
                    this.updateRecentActivity(filteredTx);
                    
                } catch (error) {
                    console.error('Error loading analytics:', error);
                    this.showNoData();
                }
            }
            
            updateCharts(transactions) {
                // Notices over time chart
                const ctx1 = document.getElementById('noticesChart').getContext('2d');
                
                // Group by day
                const dailyData = {};
                transactions.forEach(tx => {
                    const date = new Date(tx.timestamp).toLocaleDateString();
                    dailyData[date] = (dailyData[date] || 0) + 1;
                });
                
                const labels = Object.keys(dailyData).slice(-7);
                const data = labels.map(label => dailyData[label] || 0);
                
                if (this.charts.notices) {
                    this.charts.notices.destroy();
                }
                
                this.charts.notices = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Notices Created',
                            data: data,
                            borderColor: 'rgb(52, 152, 219)',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
                
                // Notice types chart
                const ctx2 = document.getElementById('typesChart').getContext('2d');
                
                const typeData = {};
                transactions.forEach(tx => {
                    const type = tx.noticeType || 'Other';
                    typeData[type] = (typeData[type] || 0) + 1;
                });
                
                if (this.charts.types) {
                    this.charts.types.destroy();
                }
                
                this.charts.types = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(typeData),
                        datasets: [{
                            data: Object.values(typeData),
                            backgroundColor: [
                                'rgb(52, 152, 219)',
                                'rgb(46, 204, 113)',
                                'rgb(155, 89, 182)',
                                'rgb(241, 196, 15)',
                                'rgb(231, 76, 60)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
            
            updateRecentActivity(transactions) {
                const list = document.getElementById('recentActivityList');
                
                if (transactions.length === 0) {
                    list.innerHTML = '<div class="empty-state"><i class="fas fa-chart-line"></i><p>No activity data available</p></div>';
                    return;
                }
                
                const recent = transactions.slice(0, 10);
                list.innerHTML = recent.map(tx => `
                    <div class="activity-item">
                        <div class="activity-info">
                            <div class="activity-type">${tx.noticeType || 'Legal Notice'}</div>
                            <div class="activity-details">To: ${formatAddress(tx.recipient)}</div>
                        </div>
                        <div class="activity-time">${this.formatTime(tx.timestamp)}</div>
                    </div>
                `).join('');
            }
            
            formatTime(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            }
            
            showNoData() {
                document.getElementById('totalNoticesServed').textContent = '0';
                document.getElementById('acceptanceRate').textContent = '0%';
                document.getElementById('avgResponseTime').textContent = '-';
                document.getElementById('totalRevenue').textContent = '0 TRX';
            }
            
            exportData() {
                const data = {
                    exportDate: new Date().toISOString(),
                    stats: {
                        totalNotices: document.getElementById('totalNoticesServed').textContent,
                        acceptanceRate: document.getElementById('acceptanceRate').textContent,
                        avgResponseTime: document.getElementById('avgResponseTime').textContent,
                        totalRevenue: document.getElementById('totalRevenue').textContent
                    },
                    transactions: JSON.parse(localStorage.getItem('userTransactions') || '[]')
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `analytics_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            }
        }
        
        const analyticsSystem = new AnalyticsSystem();
        
        // Analytics functions
        function updateAnalytics() {
            analyticsSystem.loadAnalytics();
        }
        
        function exportAnalytics() {
            analyticsSystem.exportData();
        }

        // Notification System
        class NotificationSystem {
            constructor() {
                this.notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                this.unreadCount = 0;
                this.checkInterval = null;
            }
            
            async init() {
                // Show bell for recipients only
                if (tronWeb && tronWeb.defaultAddress) {
                    const isRecipient = await this.checkIfRecipient();
                    if (isRecipient) {
                        document.getElementById('notificationBell').style.display = 'block';
                        this.updateNotificationUI();
                        this.startPolling();
                    }
                }
            }
            
            async checkIfRecipient() {
                try {
                    const balance = await legalContract.balanceOf(tronWeb.defaultAddress.base58).call();
                    return parseInt(balance) > 0;
                } catch (error) {
                    return false;
                }
            }
            
            async checkForNewNotices() {
                if (!legalContract || !tronWeb.defaultAddress) return;
                
                try {
                    const myAddress = tronWeb.defaultAddress.base58;
                    const noticeIds = await getRecipientNoticeIds(myAddress);
                    
                    // Check for new notices
                    const existingIds = this.notifications.map(n => n.noticeId);
                    const newNotices = [];
                    
                    for (const noticeId of noticeIds) {
                        if (!existingIds.includes(noticeId.toString())) {
                            try {
                                const notice = await legalContract.notices(noticeId).call();
                                console.log('New notice data:', notice);
                                
                                // Check if notice has packedData field
                                let packedData = notice.packedData;
                                if (!packedData && notice.timestamp) {
                                    // If packedData doesn't exist, use individual fields
                                    packedData = {
                                        timestamp: notice.timestamp || 0,
                                        serverId: notice.serverId || 0,
                                        hasDocument: notice.hasDocument || false,
                                        accepted: notice.accepted || false
                                    };
                                }
                                
                                const { timestamp, serverId, hasDocument, accepted } = 
                                    packedData.timestamp !== undefined ? packedData : parsePackedData(packedData);
                                
                                newNotices.push({
                                    noticeId: noticeId.toString(),
                                    sender: notice.sender,
                                    timestamp: timestamp,
                                    type: notice.metadata.split('|')[0] || 'Legal Notice',
                                    hasDocument: hasDocument,
                                    accepted: accepted,
                                    read: false,
                                    receivedAt: Date.now()
                                });
                            } catch (e) {
                                console.error('Error fetching notice:', e);
                            }
                        }
                    }
                    
                    if (newNotices.length > 0) {
                        this.addNotifications(newNotices);
                        this.showDesktopNotification(newNotices[0]);
                    }
                    
                } catch (error) {
                    console.error('Error checking for notices:', error);
                }
            }
            
            addNotifications(newNotices) {
                this.notifications.unshift(...newNotices);
                this.saveNotifications();
                this.updateNotificationUI();
            }
            
            showDesktopNotification(notice) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('New Legal Notice', {
                        body: `You have received a new legal notice from ${notice.sender.substring(0, 10)}...`,
                        icon: '/favicon.ico',
                        tag: notice.noticeId
                    });
                }
            }
            
            updateNotificationUI() {
                const unread = this.notifications.filter(n => !n.read);
                this.unreadCount = unread.length;
                
                // Update badge
                const badge = document.getElementById('notificationCount');
                if (badge) {
                    badge.textContent = this.unreadCount;
                    badge.style.display = this.unreadCount > 0 ? 'block' : 'none';
                }
                
                // Update list
                const list = document.getElementById('notificationList');
                if (list) {
                    if (this.notifications.length === 0) {
                        list.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No notices</p></div>';
                    } else {
                        list.innerHTML = this.notifications.map(n => `
                            <div class="notification-item ${n.read ? '' : 'unread'}" onclick="viewNoticeFromNotification('${n.noticeId}')">
                                <div class="notification-item-header">
                                    <span class="notification-item-title">${n.type}</span>
                                    <span class="notification-item-time">${this.formatTime(n.receivedAt)}</span>
                                </div>
                                <div class="notification-item-body">
                                    From: ${n.sender.substring(0, 10)}...${n.sender.substring(n.sender.length - 8)}
                                </div>
                            </div>
                        `).join('');
                    }
                }
            }
            
            formatTime(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                
                if (diff < 60000) return 'Just now';
                if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
                if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
                return new Date(timestamp).toLocaleDateString();
            }
            
            markAsRead(noticeId) {
                const notification = this.notifications.find(n => n.noticeId === noticeId);
                if (notification && !notification.read) {
                    notification.read = true;
                    this.saveNotifications();
                    this.updateNotificationUI();
                }
            }
            
            markAllAsRead() {
                this.notifications.forEach(n => n.read = true);
                this.saveNotifications();
                this.updateNotificationUI();
            }
            
            saveNotifications() {
                localStorage.setItem('notifications', JSON.stringify(this.notifications));
            }
            
            startPolling() {
                // Check every 30 seconds
                this.checkInterval = setInterval(() => {
                    this.checkForNewNotices();
                }, 30000);
                
                // Initial check
                this.checkForNewNotices();
            }
            
            stopPolling() {
                if (this.checkInterval) {
                    clearInterval(this.checkInterval);
                }
            }
        }
        
        // Initialize notification system
        const notificationSystem = new NotificationSystem();
        
        // Notification functions
        function toggleNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
        }
        
        function markAllAsRead() {
            notificationSystem.markAllAsRead();
        }
        
        function viewNoticeFromNotification(noticeId) {
            notificationSystem.markAsRead(noticeId);
            showAcceptModal(noticeId);
            toggleNotificationPanel();
        }
        
        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
        
        // Debug function to manually check specific notices
        window.debugCheckNotice = async function(noticeId) {
            if (!legalContract) {
                console.error('Contract not initialized');
                return;
            }
            
            console.log(`=== Debugging Notice #${noticeId} ===`);
            
            try {
                // Check alert notice
                console.log('Checking alertNotices...');
                const alertData = await legalContract.alertNotices(noticeId).call();
                console.log('Alert data:', alertData);
                
                if (alertData && Array.isArray(alertData) && alertData.length > 0) {
                    console.log('Alert notice fields:');
                    console.log('- recipient (0):', alertData[0]);
                    console.log('- server (1):', alertData[1]);
                    console.log('- documentId (2):', alertData[2]);
                    console.log('- timestamp (3):', alertData[3]);
                    console.log('- acknowledged (4):', alertData[4]);
                    console.log('- issuingAgency (5):', alertData[5]);
                    console.log('- noticeType (6):', alertData[6]);
                    console.log('- caseNumber (7):', alertData[7]);
                    console.log('- noticeText (8):', alertData[8]);
                    console.log('- legalRights (9):', alertData[9]);
                    console.log('- deadline (10):', alertData[10]);
                    console.log('- tokenURI (11):', alertData[11]);
                }
            } catch (e) {
                console.error('Error checking alert notice:', e);
            }
            
            try {
                // Check document notice
                console.log('\nChecking documentNotices...');
                const docData = await legalContract.documentNotices(noticeId).call();
                console.log('Document data:', docData);
                
                if (docData && Array.isArray(docData) && docData.length > 0) {
                    console.log('Document notice fields:');
                    console.log('- documentId (0):', docData[0]);
                    console.log('- server (1):', docData[1], docData[1] && docData[1].startsWith('41') ? `(${tronWeb.address.fromHex(docData[1])})` : '');
                    console.log('- recipient (2):', docData[2], docData[2] && docData[2].startsWith('41') ? `(${tronWeb.address.fromHex(docData[2])})` : '');
                    console.log('- ipfsHash (3):', docData[3]);
                    console.log('- accepted (4):', docData[4]);
                }
            } catch (e) {
                console.error('Error checking document notice:', e);
            }
            
            // Also check who owns the NFT
            try {
                console.log('\nChecking NFT ownership...');
                const owner = await legalContract.ownerOf(noticeId).call();
                console.log('NFT owner:', owner);
            } catch (e) {
                console.error('Error checking NFT owner:', e);
            }
            
            console.log('=== End Debug ===');
        };
        
        // Debug function to check all properties of contract data
        window.debugContractData = async function(noticeId) {
            if (!legalContract) {
                console.error('Contract not initialized');
                return;
            }
            
            console.log(`=== Debugging Contract Data for Notice #${noticeId} ===`);
            
            try {
                const alertData = await legalContract.alertNotices(noticeId).call();
                console.log('Raw alert data:', alertData);
                
                if (alertData) {
                    console.log('\nArray indices:');
                    for (let i = 0; i < alertData.length; i++) {
                        console.log(`[${i}]:`, alertData[i]);
                    }
                    
                    console.log('\nNamed properties:');
                    for (let key in alertData) {
                        if (isNaN(key)) { // Skip numeric indices
                            console.log(`${key}:`, alertData[key]);
                        }
                    }
                    
                    console.log('\nSpecific check for acknowledged:');
                    console.log('alertData[11]:', alertData[11]);
                    console.log('alertData.acknowledged:', alertData.acknowledged);
                    console.log('typeof alertData[11]:', typeof alertData[11]);
                    console.log('typeof alertData.acknowledged:', typeof alertData.acknowledged);
                }
            } catch (e) {
                console.error('Error:', e);
            }
        };
        
        // Manual function to find notices served by current user
        window.findMyServedNotices = async function(maxToCheck = 20) {
            if (!legalContract || !tronWeb || !tronWeb.defaultAddress) {
                console.error('Contract not initialized or wallet not connected');
                return;
            }
            
            const myAddress = tronWeb.defaultAddress.base58;
            console.log(`=== Finding notices served by ${myAddress} ===`);
            console.log(`Checking notices 0-${maxToCheck-1}...`);
            
            const myNotices = [];
            
            for (let i = 0; i < maxToCheck; i++) {
                try {
                    // Check document notice first (main type for the system)
                    const docData = await legalContract.documentNotices(i).call();
                    if (docData && Array.isArray(docData) && docData.length > 1) {
                        // Check if server field matches
                        const serverField = docData[1];
                        let isMyNotice = false;
                        
                        if (serverField) {
                            // Convert server field to address
                            let serverAddr;
                            if (typeof serverField === 'string' && serverField.startsWith('41')) {
                                serverAddr = tronWeb.address.fromHex(serverField);
                            } else if (typeof serverField === 'string' && serverField.startsWith('T')) {
                                serverAddr = serverField;
                            }
                            
                            if (serverAddr && ensureBase58Address(serverAddr).toLowerCase() === ensureBase58Address(myAddress).toLowerCase()) {
                                isMyNotice = true;
                            }
                        }
                        
                        // If server field is empty, check who owns the NFT
                        if (!serverField || serverField === '') {
                            try {
                                // Check NFT minting events or transaction history
                                console.log(`Notice ${i} has empty server field, checking other sources...`);
                                
                                // Try to get the NFT owner
                                const owner = await legalContract.ownerOf(i).call();
                                console.log(`Notice ${i} NFT owner: ${owner}`);
                                
                                // Note: This won't tell us who served it, just who owns it now
                            } catch (e) {
                                console.log(`Could not check owner of notice ${i}`);
                            }
                        }
                        
                        if (isMyNotice || !serverField) {
                            console.log(`Found notice #${i} - server: ${serverField || 'EMPTY'}, recipient: ${docData[2]}`);
                            myNotices.push({
                                noticeId: i,
                                server: serverField,
                                recipient: docData[2],
                                ipfsHash: docData[3],
                                accepted: docData[4]
                            });
                        }
                    }
                } catch (e) {
                    // Notice doesn't exist, continue
                }
                
                // Also check alert notices
                try {
                    const alertData = await legalContract.alertNotices(i).call();
                    if (alertData && Array.isArray(alertData) && alertData.length > 1) {
                        const serverField = alertData[1];
                        if (serverField) {
                            let serverAddr;
                            if (typeof serverField === 'string' && serverField.startsWith('41')) {
                                serverAddr = tronWeb.address.fromHex(serverField);
                            } else if (typeof serverField === 'string' && serverField.startsWith('T')) {
                                serverAddr = serverField;
                            }
                            
                            if (serverAddr && ensureBase58Address(serverAddr).toLowerCase() === ensureBase58Address(myAddress).toLowerCase()) {
                                console.log(`Found alert notice #${i} served by me`);
                            }
                        }
                    }
                } catch (e) {
                    // Notice doesn't exist, continue
                }
            }
            
            console.log(`\n=== Summary ===`);
            console.log(`Found ${myNotices.length} document notices that might be yours`);
            console.log('Notices:', myNotices);
            
            return myNotices;
        };
        
        // Clear notice cache for debugging
        window.clearNoticeCache = function() {
            const keys = Object.keys(localStorage);
            let cleared = 0;
            keys.forEach(key => {
                if (key.startsWith('blockchain_notices_')) {
                    localStorage.removeItem(key);
                    cleared++;
                }
            });
            console.log(`Cleared ${cleared} notice cache entries`);
        };

        // Initialize tooltips
        function initializeTooltips() {
            const tooltips = [
                { id: 'recipientAddress', text: 'The TRON wallet address of the person receiving the legal notice' },
                { id: 'caseNumber', text: 'Your internal case or reference number' },
                { id: 'noticeType', text: 'Select the type of legal notice you are serving' },
                { id: 'tokenName', text: 'A short name for this notice (e.g., "Smith Summons")' }
            ];
            
            tooltips.forEach(tooltip => {
                const element = document.getElementById(tooltip.id);
                if (element) {
                    const label = element.previousElementSibling;
                    if (label && !label.querySelector('.tooltip-icon')) {
                        label.innerHTML += ' <i class="fas fa-question-circle tooltip-icon" title="' + tooltip.text + '" style="color: var(--text-secondary); cursor: help;"></i>';
                    }
                }
            });
        }
        
        // Close modal functions
        function closeTransactionResultModal() {
            const modal = document.getElementById('transactionResultModal');
            if (modal) modal.style.display = 'none';
            
            // Also close the mint modal to return to dashboard
            const mintModal = document.getElementById('mintModal');
            if (mintModal) {
                mintModal.style.display = 'none';
            }
            
            // Clear the form for next use
            if (typeof resetMintForm === 'function') {
                resetMintForm();
            }
        }
        
        function closeTxModal() {
            closeTransactionResultModal();
        }
        
        function closeAcceptModal() {
            const modal = document.getElementById('acceptModal');
            if (modal) modal.style.display = 'none';
        }
        
        function closeMintModal() {
            const modal = document.getElementById('batchMintModal');
            if (modal) modal.style.display = 'none';
        }
        
        function closeRegistrationModal() {
            const modal = document.getElementById('registrationModal');
            if (modal) modal.style.display = 'none';
        }
        
        function closeRegistrationSuccessModal() {
            const modal = document.getElementById('registrationSuccessModal');
            if (modal) modal.style.display = 'none';
        }
        
        function closeAuditModal() {
            const modal = document.getElementById('auditModal');
            if (modal) modal.style.display = 'none';
        }
        
        // Open registration modal
        function openRegistrationModal() {
            const modal = document.getElementById('registrationModal');
            if (modal) {
                modal.style.display = 'flex';
                // Pre-fill wallet address if connected
                if (tronWeb && tronWeb.defaultAddress) {
                    document.getElementById('regWallet').value = tronWeb.defaultAddress.base58;
                }
            }
        }
        
        // Dismiss registration notice
        function dismissRegistrationNotice() {
            const notice = document.getElementById('registrationNotice');
            if (notice) {
                notice.style.display = 'none';
                localStorage.setItem('registrationNoticeDismissed', 'true');
            }
        }
        
        // Copy functions
        function copyWalletAddress() {
            if (tronWeb && tronWeb.defaultAddress) {
                navigator.clipboard.writeText(tronWeb.defaultAddress.base58).then(() => {
                    uiManager.showNotification('success', 'Address copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    uiManager.showNotification('error', 'Failed to copy address');
                });
            }
        }
        
        function copyAddress(address) {
            navigator.clipboard.writeText(address).then(() => {
                uiManager.showNotification('success', 'Address copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                uiManager.showNotification('error', 'Failed to copy address');
            });
        }
        
        // Fee management functions
        async function setLawEnforcementExemption() {
            const address = document.getElementById('exemptionAddress').value.trim();
            const agencyName = document.getElementById('exemptionAgencyName').value.trim();
            
            if (!address || !agencyName) {
                uiManager.showNotification('error', 'Please fill in all fields');
                return;
            }
            
            if (!tronWeb.isAddress(address)) {
                uiManager.showNotification('error', 'Invalid address');
                return;
            }
            
            try {
                showProcessing('Setting law enforcement exemption...');
                
                // Note: Complete contract doesn't have grantRoleWithExemption - using separate calls
                await legalContract.grantRole(
                    tronWeb.sha3('PROCESS_SERVER_ROLE'),
                    address
                ).send({
                    feeLimit: 100_000_000,
                    shouldPollResponse: true
                });
                
                hideProcessing();
                if (submitButton) setButtonLoading(submitButton, false, '<i class="fas fa-paper-plane"></i> Create Notice');
                showAlert('exemptionResult', 'success', `Exemption granted to ${address}`);
                
                // Clear form
                document.getElementById('exemptionAddress').value = '';
                document.getElementById('exemptionAgencyName').value = '';
                
            } catch (error) {
                hideProcessing();
                console.error('Error setting exemption:', error);
                showAlert('exemptionResult', 'error', 'Failed: ' + getErrorMessage(error));
            }
        }
        
        function useConnectedAddressForExemption() {
            if (tronWeb && tronWeb.defaultAddress) {
                document.getElementById('exemptionAddress').value = tronWeb.defaultAddress.base58;
            }
        }
        
        // Toggle registration form based on role
        function toggleRegistrationForm() {
            const roleSelect = document.getElementById('roleSelect');
            const serverFields = document.getElementById('processServerFields');
            
            if (roleSelect && serverFields) {
                serverFields.style.display = roleSelect.value === 'PROCESS_SERVER_ROLE' ? 'block' : 'none';
            }
        }
        
        // Change document function (for batch operations)
        function changeDocument() {
            // Reset to upload step
            document.getElementById('uploadCard').style.display = 'block';
            document.getElementById('mintCard').style.display = 'none';
            
            // Clear the uploaded image
            uploadedImage = null;
            document.getElementById('uploadedFileName').textContent = '';
            document.getElementById('uploadResult').style.display = 'none';
            
            // Reset file input
            const fileInput = document.getElementById('imageUpload');
            if (fileInput) {
                fileInput.value = '';
            }
        }
// Use connected wallet address function
function useConnectedAddress() {
    if (tronWeb && tronWeb.defaultAddress) {
        document.getElementById('roleAddress').value = tronWeb.defaultAddress.base58;
        
        // Trigger validation if exists
        const event = new Event('input', { bubbles: true });
        document.getElementById('roleAddress').dispatchEvent(event);
        
        uiManager.showNotification('success', 'Connected wallet address inserted');
    } else {
        uiManager.showNotification('error', 'No wallet connected');
    }
}

// Use connected wallet address for fee collector
function useConnectedAddressForFeeCollector() {
    if (tronWeb && tronWeb.defaultAddress) {
        document.getElementById('feeCollectorAddress').value = tronWeb.defaultAddress.base58;
        
        // Trigger validation if exists
        const event = new Event('input', { bubbles: true });
        document.getElementById('feeCollectorAddress').dispatchEvent(event);
        
        uiManager.showNotification('success', 'Connected wallet address inserted');
    } else {
        uiManager.showNotification('error', 'No wallet connected');
    }
}
        // Handle chain change
        async function handleChainChange() {
            const chainSelector = document.getElementById('chainSelector');
            const selectedValue = chainSelector.value;
            const [chainType, network] = selectedValue.split('-');
            
            // Check if user is trying to select a non-TRON network
            if (chainType !== 'tron') {
                // Get the network display name
                let networkName = '';
                if (chainType === 'evm') {
                    if (network === 'ethereum') networkName = 'Ethereum';
                    else if (network === 'sepolia') networkName = 'Ethereum Sepolia';
                    else if (network === 'polygon') networkName = 'Polygon';
                    else if (network === 'mumbai') networkName = 'Polygon Mumbai';
                    else if (network === 'bsc') networkName = 'BNB Smart Chain';
                    else if (network === 'bscTestnet') networkName = 'BSC Testnet';
                }
                
                // Show notification about unavailable network
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.style.zIndex = '10000';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 class="modal-title">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                                Network Not Available
                            </h3>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info" style="background: #dbeafe; border-color: #3b82f6;">
                                <i class="fas fa-network-wired"></i>
                                <div style="margin-left: 0.5rem;">
                                    <strong>Contract Not Yet Deployed on ${networkName}</strong>
                                    <p style="margin: 0.5rem 0 0 0;">
                                        We currently only have our smart contract deployed on the TRON network. 
                                        We haven't deployed to other networks yet as there hasn't been demand for it.
                                    </p>
                                </div>
                            </div>
                            
                            <div style="margin: 1.5rem 0;">
                                <h4 style="margin-bottom: 0.5rem;">Need Support for ${networkName}?</h4>
                                <p>
                                    We're happy to deploy our contract to other blockchain networks based on customer needs. 
                                    If you require support for ${networkName} or any other blockchain, please contact us and we'll begin the deployment process.
                                </p>
                                
                                <div style="background: #f3f4f6; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <p style="margin: 0; font-weight: 600;">
                                        <i class="fas fa-envelope"></i> Contact us at: 
                                        <a href="mailto:info@blockserved.com" style="color: #3b82f6;">info@blockserved.com</a>
                                    </p>
                                </div>
                            </div>
                            
                            <div style="margin-top: 1.5rem; text-align: center;">
                                <button class="btn btn-primary" onclick="this.closest('.modal').remove();">
                                    <i class="fas fa-check"></i> Understood
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Reset dropdown to TRON mainnet
                chainSelector.value = 'tron-mainnet';
                currentChainType = 'tron';
                currentNetwork = 'mainnet';
                
                // Update contract address to mainnet
                const contractAddressField = document.getElementById('contractAddress');
                if (contractAddressField) {
                    contractAddressField.value = window.CONTRACT_ADDRESSES.mainnet;
                }
                
                return;
            }
            
            currentChainType = chainType;
            currentNetwork = network;
            
            // Update contract address field
            const config = CHAIN_CONFIG[chainType][network];
            const contractAddressField = document.getElementById('contractAddress');
            if (contractAddressField) {
                contractAddressField.value = config.contractAddress;
            }
            
            // Disconnect current wallet if connected
            if (window.tronWeb && window.tronWeb.ready && chainType === 'evm') {
                // Switching from TRON to EVM
                disconnectWallet();
            } else if (web3Instance && chainType === 'tron') {
                // Switching from EVM to TRON
                disconnectWallet();
            }
            
            uiManager.showNotification('info', `Switched to ${config.name}. Please connect your wallet.`);
        }

        // Connect Wallet function
        async function connectWallet() {
            const connectBtn = document.getElementById('connectBtn');
            
            // Check if on mobile and no wallet extension is available
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (currentChainType === 'tron') {
                // If on mobile and no TronWeb is available, use mobile connector
                if (isMobile && (!window.tronWeb || !window.tronWeb.ready)) {
                    console.log('Mobile device detected, using mobile wallet connector');
                    if (window.mobileWalletConnector) {
                        window.mobileWalletConnector.showMobileConnectionOptions();
                    } else {
                        console.error('Mobile wallet connector not loaded');
                        await connectTronWallet(); // Fallback to regular connection
                    }
                } else {
                    await connectTronWallet();
                }
            } else {
                await connectEVMWallet();
            }
        }

        // Detect available wallets
        function detectAvailableWallets() {
            const wallets = [];
            
            // Check for TronLink
            if (window.tronLink) {
                wallets.push({
                    name: 'TronLink',
                    icon: 'https://static.tronscan.org/production/upload/logo/TJhcvM1vUm3cAPor7Dk9cGQqJG6SiQxzqC.png',
                    available: true,
                    isReady: window.tronWeb && window.tronWeb.ready,
                    type: 'tronlink'
                });
            }
            
            // Check for TokenPocket
            if (window.tokenpocket) {
                wallets.push({
                    name: 'TokenPocket',
                    icon: 'https://www.tokenpocket.pro/favicon.ico',
                    available: true,
                    isReady: window.tronWeb && window.tronWeb.ready,
                    type: 'tokenpocket'
                });
            }
            
            // Check for Trust Wallet
            if (window.trustwallet || (window.ethereum && window.ethereum.isTrust)) {
                wallets.push({
                    name: 'Trust Wallet',
                    icon: 'https://trustwallet.com/assets/images/media/assets/trust_platform.svg',
                    available: true,
                    isReady: window.tronWeb && window.tronWeb.ready,
                    type: 'trust'
                });
            }
            
            // Check for BitKeep/Bitget Wallet
            if (window.bitkeep && window.bitkeep.tron) {
                wallets.push({
                    name: 'Bitget Wallet',
                    icon: 'https://web3.bitget.com/favicon.ico',
                    available: true,
                    isReady: window.tronWeb && window.tronWeb.ready,
                    type: 'bitkeep'
                });
            }
            
            // Check for OKX Wallet
            if (window.okxwallet) {
                wallets.push({
                    name: 'OKX Wallet',
                    icon: 'https://static.okx.com/cdn/assets/imgs/216/435B9CD6B44BD56A.png',
                    available: true,
                    isReady: window.tronWeb && window.tronWeb.ready,
                    type: 'okx'
                });
            }
            
            // Check for other TRON wallets
            if (window.tronWeb && wallets.length === 0) {
                wallets.push({
                    name: 'TRON Wallet',
                    icon: '',
                    available: true,
                    isReady: window.tronWeb.ready,
                    type: 'other'
                });
            }
            
            return wallets;
        }
        
        // Show wallet selection modal
        async function showWalletSelector() {
            const wallets = detectAvailableWallets();
            
            // If only TronLink is detected, use it directly
            const tronLinkWallet = wallets.find(w => w.type === 'tronlink');
            if (wallets.length === 1 && tronLinkWallet) {
                return await connectTronWalletOriginal();
            }
            
            // If TronLink is ready but other wallets are detected, show selector
            if (wallets.length > 1) {
                // Create wallet selection modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-header">
                            <h2>Select Wallet</h2>
                            <button class="modal-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <p style="margin-bottom: 1.5rem; color: #64748b;">
                                Multiple wallets detected. Please select which wallet to connect:
                            </p>
                            <div style="display: grid; gap: 1rem;">
                                ${wallets.map(wallet => `
                                    <button class="wallet-option" onclick="selectWallet('${wallet.type}')" 
                                            style="padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; 
                                                   display: flex; align-items: center; gap: 1rem; cursor: pointer;
                                                   background: white; transition: all 0.2s; text-align: left;">
                                        ${wallet.icon ? `<img src="${wallet.icon}" style="width: 40px; height: 40px;">` : 
                                                       '<div style="width: 40px; height: 40px; background: #f3f4f6; border-radius: 8px;"></div>'}
                                        <div>
                                            <div style="font-weight: 600; color: #1e293b;">${wallet.name}</div>
                                            <div style="font-size: 0.875rem; color: ${wallet.isReady ? '#10b981' : '#f59e0b'};">
                                                ${wallet.isReady ? ' Connected' : 'Click to connect'}
                                            </div>
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                            <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 6px;">
                                <p style="margin: 0; font-size: 0.875rem; color: #64748b;">
                                    <strong>Tip:</strong> If you want to use TronLink but Trust Wallet keeps opening, 
                                    you may need to temporarily disable the Trust Wallet extension in your browser settings.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add styles for wallet options
                const style = document.createElement('style');
                style.textContent = `
                    .wallet-option:hover {
                        border-color: #3b82f6 !important;
                        background: #f0f9ff !important;
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    }
                `;
                document.head.appendChild(style);
                
                // Close on click outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                
                return new Promise((resolve) => {
                    window.selectWallet = async (type) => {
                        modal.remove();
                        if (type === 'tronlink') {
                            await connectTronWalletOriginal();
                        } else if (type === 'trust' && window.ethereum && window.ethereum.isTrust) {
                            // Trust Wallet uses ethereum provider for TRON
                            uiManager.showNotification('info', 'Connecting to Trust Wallet...');
                            await connectTronWalletOriginal();
                        } else {
                            // Generic TRON wallet connection
                            await connectTronWalletOriginal();
                        }
                        resolve();
                    };
                });
            } else {
                // No wallets detected or only non-TronLink wallet
                return await connectTronWalletOriginal();
            }
        }

        // Connect TRON wallet - now with wallet selector
        async function connectTronWallet() {
            // Show wallet selector if multiple wallets detected
            await showWalletSelector();
        }
        
        // Initialize contract for recipients (used on BlockServed)
        async function initializeContract() {
            console.log('initializeContract called');
            
            if (!tronWeb || !tronWeb.defaultAddress) {
                console.error('No wallet connected in initializeContract');
                return false;
            }
            
            try {
                // Use the default contract address
                const contractAddress = window.CONTRACT_ADDRESS || window.CONTRACT_ADDRESSES.mainnet;
                console.log('Initializing contract at:', contractAddress);
                
                // Create contract instance with ABI
                legalContract = await tronWeb.contract(CONTRACT_ABI, contractAddress);
                window.legalContract = legalContract; // Make globally accessible
                console.log('Contract initialized successfully');
                
                // Test the contract by calling a view function
                const testAddress = tronWeb.defaultAddress.base58;
                const balance = await legalContract.balanceOf(testAddress).call();
                console.log('Contract test successful, balance:', balance.toString());
                
                // Initialize cache after contract is ready
                if (window.blockchainCache) {
                    console.log('Loading blockchain cache from backend...');
                    await window.blockchainCache.loadFromBackend();
                }
                
                return true;
            } catch (error) {
                console.error('Error initializing contract:', error);
                return false;
            }
        }
        
        // Original TronLink connection logic
        async function connectTronWalletOriginal() {
            const connectBtn = document.getElementById('connectBtn');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const networkIndicator = document.getElementById('networkIndicator');
            const networkName = document.getElementById('networkName');

            try {
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<span class="loading-spinner"></span> Connecting...';

                // Check if TronWeb is available from any wallet
                if (typeof window.tronWeb === 'undefined') {
                    throw new Error('No TRON wallet detected. Please install TronLink, Trust Wallet, or another TRON-compatible wallet');
                }

                // Try TronLink-specific connection if available
                if (window.tronLink) {
                    try {
                        const response = await window.tronLink.request({method: 'tron_requestAccounts'});
                        console.log('TronLink request response:', response);
                    } catch (error) {
                        console.log('TronLink request error:', error);
                        // Check if user rejected
                        if (error.code === 4001 || error.message?.includes('rejected')) {
                            throw new Error('Connection cancelled by user');
                        }
                        // If TronLink request fails for other reasons, continue with generic flow
                        console.log('TronLink request failed, trying generic connection');
                    }
                }
                
                // For other wallets, they should already have tronWeb ready
                // or will prompt user when we try to access the account

                // Wait for TronWeb to be ready
                let tries = 0;
                while (!window.tronWeb.ready && tries < 10) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    tries++;
                }

                if (!window.tronWeb.ready) {
                    // Check if TronLink exists but user cancelled
                    if (window.tronLink) {
                        // Try to check if wallet is locked
                        try {
                            const accounts = await window.tronLink.request({method: 'tron_accounts'});
                            if (!accounts || accounts.length === 0) {
                                throw new Error('Please unlock your TronLink wallet and try again');
                            }
                        } catch (e) {
                            // User likely cancelled or wallet is locked
                            throw new Error('Wallet connection cancelled or locked');
                        }
                    }
                    throw new Error('Please unlock your TRON wallet');
                }

                tronWeb = window.tronWeb;
                const address = tronWeb.defaultAddress.base58;

                // Update UI
                walletStatus.style.display = 'none';
                walletAddress.style.display = 'flex';
                
                const shortAddress = address.substring(0, 6) + '...' + address.substring(address.length - 4);
                document.getElementById('walletAddressText').textContent = shortAddress;
                
                // Get network name
                const fullNode = tronWeb.fullNode.host;
                let network = 'Unknown Network';
                
                if (fullNode.includes('trongrid.io') && !fullNode.includes('shasta') && !fullNode.includes('nile')) {
                    network = 'Mainnet';
                } else if (fullNode.includes('nile')) {
                    network = 'Nile Testnet';
                } else if (fullNode.includes('shasta')) {
                    network = 'Shasta Testnet';
                }
                
                networkName.textContent = network;
                networkIndicator.classList.add('connected');

                connectBtn.innerHTML = '<i class="fas fa-check"></i> Connected';
                connectBtn.classList.remove('btn-primary');
                connectBtn.classList.add('btn-success');

                // Track wallet connection with IP (only for BlockServed)
                await trackWalletConnection(address, 'wallet_connected');

                // Get site configuration
                const siteConfig = getSiteConfig();
                console.log('Site config:', siteConfig);
                console.log('Current hostname:', window.location.hostname);

                // If registration modal is open, update wallet field (server mode only)
                if (siteConfig.showServerFeatures) {
                    const regWalletField = document.getElementById('regWallet');
                    if (regWalletField) {
                        regWalletField.value = address;
                    }
                }

                // Hide welcome section
                document.getElementById('welcomeSection').style.display = 'none';

                uiManager.showNotification('success', `Connected to ${network}`);

                // Detect network and set contract address
                await detectNetworkAndSetContract();

                // For recipients on blockserved.com, immediately show their notices
                if (siteConfig.mode === 'recipient' || !siteConfig.showServerFeatures) {
                    // Initialize contract automatically for recipients
                    console.log('Recipient mode detected, initializing contract...');
                    const initSuccess = await initializeContract();
                    console.log('Contract initialization result:', initSuccess);
                    
                    // Refresh alerts to show their notices
                    setTimeout(async () => {
                        console.log('Attempting to refresh alerts...');
                        
                        // Recipients stay on user tab where myAlertsContent is located
                        // Don't switch tabs
                        
                        await refreshMyAlerts();
                        
                        // Scroll to alerts section
                        const alertsCard = document.getElementById('myAlertsCard');
                        if (alertsCard) {
                            alertsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 1000);
                } else {
                    // Server mode - update stats and recent activities
                    if (siteConfig.showServerFeatures) {
                        // Update server statistics
                        updateServerStats();
                        
                        // Refresh recent activities
                        refreshRecentActivitiesHybrid();
                    }
                    
                    // Check if contract is already in the address field
                    const contractAddressField = document.getElementById('contractAddress');
                    if (contractAddressField && contractAddressField.value) {
                        // Automatically connect to contract after a short delay to ensure TronWeb is ready
                        setTimeout(async () => {
                            await connectContracts();
                        }, 1000); // 1 second delay
                    }
                }

            } catch (error) {
                console.error('Connection error:', error);
                
                connectBtn.innerHTML = '<i class="fas fa-link"></i> Connect';
                connectBtn.disabled = false;
                
                // Show user-friendly error messages
                let errorMessage = error.message || 'Failed to connect wallet';
                
                if (error.message?.includes('cancelled') || error.code === 4001 || error.message?.includes('locked')) {
                    errorMessage = 'Please unlock and connect your wallet to continue.';
                } else if (error.message?.includes('unlock')) {
                    errorMessage = 'Please unlock your wallet and try again.';
                } else if (error.message?.includes('not detected')) {
                    errorMessage = 'No TRON wallet found. Please install TronLink or another TRON wallet.';
                }
                
                uiManager.showNotification('error', errorMessage);
            }
        }

        // Connect EVM wallet
        async function connectEVMWallet() {
            const connectBtn = document.getElementById('connectBtn');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const networkIndicator = document.getElementById('networkIndicator');
            const networkName = document.getElementById('networkName');

            try {
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<span class="loading-spinner"></span> Connecting...';

                // Check if MetaMask is available
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask not detected. Please install MetaMask extension');
                }

                // Create Web3 instance
                web3Instance = new Web3(window.ethereum);

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts found. Please unlock MetaMask');
                }

                const address = accounts[0];
                const chainId = await web3Instance.eth.getChainId();
                const config = CHAIN_CONFIG.evm[currentNetwork];

                // Check if on correct network
                if (Number(chainId) !== config.chainId) {
                    uiManager.showNotification('warning', `Please switch to ${config.name} in MetaMask`);
                    
                    // Try to switch network
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: web3Instance.utils.toHex(config.chainId) }],
                        });
                    } catch (switchError) {
                        // This error code indicates that the chain has not been added to MetaMask
                        if (switchError.code === 4902) {
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: web3Instance.utils.toHex(config.chainId),
                                        chainName: config.name,
                                        rpcUrls: [config.rpcUrl],
                                        blockExplorerUrls: [config.explorerUrl],
                                        nativeCurrency: {
                                            name: config.nativeToken,
                                            symbol: config.nativeToken,
                                            decimals: 18
                                        }
                                    }],
                                });
                            } catch (addError) {
                                throw new Error('Failed to add network to MetaMask');
                            }
                        } else {
                            throw switchError;
                        }
                    }
                }

                // Update UI
                walletStatus.style.display = 'none';
                walletAddress.style.display = 'flex';
                
                const shortAddress = address.substring(0, 6) + '...' + address.substring(address.length - 4);
                document.getElementById('walletAddressText').textContent = shortAddress;
                
                networkName.textContent = config.name;
                networkIndicator.classList.add('connected');

                connectBtn.innerHTML = '<i class="fas fa-check"></i> Connected';
                connectBtn.classList.remove('btn-primary');
                connectBtn.classList.add('btn-success');

                // Track wallet connection with IP (only for BlockServed)
                await trackWalletConnection(address, 'wallet_connected');

                // Hide welcome section
                document.getElementById('welcomeSection').style.display = 'none';

                uiManager.showNotification('success', `Connected to ${config.name}`);

                // Connect to contract
                const contractAddressField = document.getElementById('contractAddress');
                if (contractAddressField && contractAddressField.value) {
                    await connectContracts();
                }

                // Listen for account changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        disconnectWallet();
                    } else {
                        window.location.reload();
                    }
                });

                // Listen for chain changes
                window.ethereum.on('chainChanged', () => {
                    window.location.reload();
                });

            } catch (error) {
                console.error('Connection error:', error);
                
                connectBtn.innerHTML = '<i class="fas fa-link"></i> Connect';
                connectBtn.disabled = false;
                
                // Show user-friendly error messages
                let errorMessage = error.message || 'Failed to connect wallet';
                
                if (error.message?.includes('cancelled') || error.code === 4001 || error.message?.includes('locked')) {
                    errorMessage = 'Please unlock and connect your wallet to continue.';
                } else if (error.message?.includes('unlock')) {
                    errorMessage = 'Please unlock your wallet and try again.';
                } else if (error.message?.includes('not detected')) {
                    errorMessage = 'No TRON wallet found. Please install TronLink or another TRON wallet.';
                }
                
                uiManager.showNotification('error', errorMessage);
            }
        }

        // Disconnect wallet
        function disconnectWallet() {
            // Reset UI
            const connectBtn = document.getElementById('connectBtn');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const networkIndicator = document.getElementById('networkIndicator');
            const networkName = document.getElementById('networkName');
            
            walletStatus.style.display = 'block';
            walletStatus.textContent = 'Not Connected';
            walletAddress.style.display = 'none';
            networkName.textContent = 'Disconnected';
            networkIndicator.classList.remove('connected');
            
            connectBtn.innerHTML = '<i class="fas fa-link"></i> Connect';
            connectBtn.classList.remove('btn-success');
            connectBtn.classList.add('btn-primary');
            connectBtn.disabled = false;
            
            // Show welcome section
            document.getElementById('welcomeSection').style.display = 'block';
            
            // Reset contract connection
            legalContract = null;
            window.legalContract = null; // Clear global reference
            evmContract = null;
            web3Instance = null;
            tronWeb = null;
            
            // Hide contract status
            document.getElementById('contractsStatus').style.display = 'none';
            document.getElementById('contractAddress').disabled = false;
            
            // Reset contract connect button
            const contractConnectBtn = document.getElementById('connectContractBtn');
            if (contractConnectBtn) {
                contractConnectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect to Contract';
                contractConnectBtn.classList.remove('btn-success');
                contractConnectBtn.classList.add('btn-primary');
                contractConnectBtn.disabled = false;
            }
            
            uiManager.showNotification('info', 'Wallet disconnected');
        }

        // Tab switching function
        function switchTab(tabName) {
            // Check admin access before allowing admin tab
            if (tabName === 'admin' && !isAdmin) {
                uiManager.showNotification('error', 'Admin access required');
                return;
            }
            
            const tabs = ['user', 'delivery', 'admin', 'help', 'info'];
            
            tabs.forEach(tab => {
                const tabButton = document.querySelector(`[onclick="switchTab('${tab}')"]`);
                const tabContent = document.getElementById(`${tab}Tab`);
                
                // Skip if elements don't exist (e.g., on BlockServed some tabs are hidden)
                if (!tabButton || !tabContent) {
                    return;
                }
                
                if (tab === tabName) {
                    tabButton.classList.add('active');
                    tabContent.classList.add('active');
                } else {
                    tabButton.classList.remove('active');
                    tabContent.classList.remove('active');
                }
            });

            // Check admin access when switching to admin tab
            if (tabName === 'analytics') {
                analyticsSystem.loadAnalytics();
            }
            
            if (tabName === 'admin') {
                checkAdminAccess();
                refreshPendingRegistrations();
                updateStatsFromLocalStorage();
            }
            
            // Load delivery status when switching to delivery tab
            if (tabName === 'delivery') {
                refreshDeliveryStatus();
            }
        }

        // Toggle FAQ accordion sections
        function toggleFAQ(button) {
            const section = button.parentElement;
            const content = section.querySelector('.faq-content');
            const icon = button.querySelector('i');
            
            // Toggle active state
            button.classList.toggle('active');
            
            // Toggle content visibility
            if (content.style.display === 'block') {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-right';
            } else {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-down';
            }
        }

        // Check admin access
        async function checkAdminAccess() {
            const adminAccessDenied = document.getElementById('adminAccessDenied');
            const adminContent = document.getElementById('adminContent');
            
            if (!legalContract || !tronWeb.defaultAddress) {
                adminAccessDenied.style.display = 'block';
                adminContent.style.display = 'none';
                return;
            }
            
            if (isAdmin) {
                adminAccessDenied.style.display = 'none';
                adminContent.style.display = 'block';
                refreshPendingRegistrations();
                loadGitHubSettings();
            } else {
                adminAccessDenied.style.display = 'block';
                adminContent.style.display = 'none';
            }
        }

        // Modal functions
        function openRegistrationModal() {
            const modal = document.getElementById('registrationModal');
            modal.style.display = 'block';
            
            // Auto-fill wallet address if connected
            if (tronWeb && tronWeb.defaultAddress) {
                document.getElementById('regWallet').value = tronWeb.defaultAddress.base58;
            }
        }

        function closeRegistrationModal() {
            document.getElementById('registrationModal').style.display = 'none';
            clearRegistrationForm();
        }

        function clearRegistrationForm() {
            document.getElementById('regAgency').value = '';
            document.getElementById('regPurpose').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('registrationResult').innerHTML = '';
        }

        function closeRegistrationSuccessModal() {
            document.getElementById('registrationSuccessModal').style.display = 'none';
        }

        function dismissRegistrationNotice() {
            document.getElementById('registrationNotice').style.display = 'none';
        }

        async function openMintModal() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Please connect to contract first');
                return;
            }
            
            if (!isProcessServer && !isAdmin) {
                uiManager.showNotification('error', 'You need Process Server role to create notices');
                return;
            }
            
            const modal = document.getElementById('mintModal');
            modal.style.display = 'block';
            resetMintForm();
            
            // Update token prefix based on user role
            await updateTokenPrefix();
            
            // Setup upload area for this modal instance - delay to ensure DOM is ready
            setTimeout(() => {
                setupUploadAreaForModal();
            }, 100);
            
            
        async function calculateFeeForDisplay(userAddress, deliveryMethod) {
            try {
                if (!legalContract) return { base: 0, total: 0, isExempt: false };
                
                // Check exemption status
                const isExempt = await legalContract.serviceFeeExemptions(userAddress).call();
                
                // Base fees
                const baseFee = deliveryMethod === 'document' ? 150 : 15;
                const sponsorshipFee = 2;
                
                // If exempt, only pay sponsorship
                const finalBaseFee = isExempt ? 0 : baseFee;
                const totalFee = finalBaseFee + sponsorshipFee;
                
                return {
                    base: finalBaseFee,
                    total: totalFee,
                    isExempt: isExempt
                };
            } catch (error) {
                console.error('Error calculating fee:', error);
                return { base: 0, total: 0, isExempt: false };
            }
        }

        // Update fee display based on actual contract calculation
            try {
                const userAddress = tronWeb.defaultAddress.base58;
                const fee = await calculateFeeFromConstants(userAddress);
                const feeInTrx = tronWeb.fromSun(fee);
                
                // Display the calculated fee
                const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked')?.value || 'document';
                document.getElementById('creationFeeDisplay').textContent = `${feeInTrx} TRX`;
                
                // Check if user has fee exemptions
                const isLawEnforcement = await legalContract.serviceFeeExemptions(userAddress).call();
                const agencyName = ''; // Complete contract doesn't track agency names
                
                if (isLawEnforcement) {
                    document.getElementById('feeDescription').textContent = `Law Enforcement - Service fee waived - Pay energy (90-200 TRX) + recipient (5.5 TRX)`;
                } else if (deliveryMethod === 'document') {
                    document.getElementById('feeDescription').textContent = 'Encrypted document with public text notice';
                } else {
                    document.getElementById('feeDescription').textContent = 'Text-only notice';
                }
            } catch (error) {
                console.error('Error calculating fee:', error);
                document.getElementById('creationFeeDisplay').textContent = `${currentCreationFee} TRX`;
            }
        }

        function closeMintModal(force = false) {
            // Check if there's unsaved data
            const hasData = checkMintFormHasData();
            
            if (!force && hasData) {
                const confirmClose = confirm(
                    'You have unsaved data in this form. Are you sure you want to close and lose your progress?'
                );
                if (!confirmClose) {
                    return;
                }
            }
            
            document.getElementById('mintModal').style.display = 'none';
            resetMintForm();
        }
        
        // Open batch mode modal
        function openBatchMode() {
            closeMintModal(true); // Force close mint modal
            document.getElementById('batchModal').style.display = 'flex';
            document.getElementById('batchStep1').style.display = 'block';
            document.getElementById('batchStep2').style.display = 'none';
            document.getElementById('batchStep3').style.display = 'none';
        }
        
        // Close batch modal
        function closeBatchModal() {
            document.getElementById('batchModal').style.display = 'none';
            // Reset batch state if needed
            if (batchManager) {
                batchManager.reset();
            }
        }
        
        // Handle CSV upload
        function handleCSVUpload(event) {
            if (batchManager) {
                batchManager.handleCSVUpload(event);
            }
        }
        
        // Handle batch document upload
        function handleBatchDocumentUpload(event) {
            if (batchManager) {
                batchManager.handleDocumentUpload(event);
            }
        }
        
        // Setup upload area when modal opens
        function setupUploadAreaForModal() {
            console.log('Setting up upload area for modal');
            
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('documentUpload');
            
            console.log('Upload area:', uploadArea);
            console.log('File input:', fileInput);
            
            if (!uploadArea || !fileInput) {
                console.error('Upload area or file input not found!');
                return;
            }
            
            // Remove any existing onclick attribute
            uploadArea.removeAttribute('onclick');
            
            // Add click handler to the upload area
            uploadArea.onclick = function(e) {
                console.log('Upload area onclick triggered');
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
                    e.preventDefault();
                    e.stopPropagation();
                    fileInput.click();
                }
            };
            
            // Make sure file input has change handler
            fileInput.onchange = handleDocumentUpload;
            
            console.log('Upload area setup complete');
        }
        
        // Batch Manager implementation
        const batchManager = {
            recipients: [],
            document: null,
            currentIndex: 0,
            isPaused: false,
            results: [],
            
            reset() {
                this.recipients = [];
                this.document = null;
                this.currentIndex = 0;
                this.isPaused = false;
                this.results = [];
            },
            
            handleCSVUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n').filter(line => line.trim());
                        const recipients = [];
                        
                        // Parse CSV (skip header if present)
                        const startIndex = lines[0].toLowerCase().includes('wallet') ? 1 : 0;
                        
                        for (let i = startIndex; i < lines.length && recipients.length < 100; i++) {
                            const parts = lines[i].split(',').map(p => p.trim());
                            if (parts[0] && tronWeb.isAddress(parts[0])) {
                                recipients.push({
                                    address: parts[0],
                                    noticeType: parts[1] || 'Legal Notice',
                                    publicText: parts[2] || ''
                                });
                            }
                        }
                        
                        this.recipients = recipients;
                        this.showValidationResults();
                        
                    } catch (error) {
                        console.error('CSV parse error:', error);
                        uiManager.showNotification('error', 'Failed to parse CSV file');
                    }
                };
                reader.readAsText(file);
            },
            
            handleDocumentUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.document = {
                        data: e.target.result,
                        name: file.name,
                        type: file.type,
                        size: file.size
                    };
                    uiManager.showNotification('success', 'Document uploaded for batch processing');
                };
                reader.readAsDataURL(file);
            },
            
            showValidationResults() {
                const validCount = this.recipients.filter(r => tronWeb.isAddress(r.address)).length;
                const invalidCount = this.recipients.length - validCount;
                
                const resultsDiv = document.getElementById('batchValidationResults');
                if (resultsDiv) {
                    resultsDiv.innerHTML = `
                        <div class="validation-summary">
                            <p><strong>Total Recipients:</strong> ${this.recipients.length}</p>
                            <p><strong>Valid Addresses:</strong> ${validCount}</p>
                            ${invalidCount > 0 ? `<p class="error"><strong>Invalid Addresses:</strong> ${invalidCount}</p>` : ''}
                        </div>
                        <div class="recipient-list" style="max-height: 200px; overflow-y: auto;">
                            ${this.recipients.map((r, i) => `
                                <div class="recipient-item">
                                    <span>${i + 1}. ${r.address.substring(0, 10)}...${r.address.substring(r.address.length - 8)}</span>
                                    <span>${r.noticeType}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Show step 2
                document.getElementById('batchStep1').style.display = 'none';
                document.getElementById('batchStep2').style.display = 'block';
            },
            
            goBack() {
                document.getElementById('batchStep1').style.display = 'block';
                document.getElementById('batchStep2').style.display = 'none';
                document.getElementById('batchStep3').style.display = 'none';
            },
            
            async startBatch() {
                if (!this.recipients.length) {
                    uiManager.showNotification('error', 'No recipients to process');
                    return;
                }
                
                if (!legalContract) {
                    uiManager.showNotification('error', 'Contract not connected');
                    return;
                }
                
                // Get additional details
                const agencyName = document.getElementById('batchAgencyName').value || '';
                const caseNumber = document.getElementById('batchCaseNumber').value || '';
                const rightsStatement = document.getElementById('batchRightsStatement').value || '';
                
                // Show step 3
                document.getElementById('batchStep2').style.display = 'none';
                document.getElementById('batchStep3').style.display = 'block';
                
                this.isPaused = false;
                this.currentIndex = 0;
                this.results = [];
                
                // Start processing
                this.processBatch(agencyName, caseNumber, rightsStatement);
            },
            
            async processBatch(agencyName, caseNumber, rightsStatement) {
                const progressBar = document.getElementById('batchProgressBar');
                const progressText = document.getElementById('batchProgressText');
                const resultsDiv = document.getElementById('batchResults');
                
                // Process in batches of up to 10 using the v4 contract batch function
                const BATCH_SIZE = 10;
                
                while (this.currentIndex < this.recipients.length && !this.isPaused) {
                    // Get next batch of recipients (up to 10)
                    const batchEnd = Math.min(this.currentIndex + BATCH_SIZE, this.recipients.length);
                    const batchRecipients = this.recipients.slice(this.currentIndex, batchEnd);
                    
                    const progress = Math.round((this.currentIndex / this.recipients.length) * 100);
                    progressBar.style.width = progress + '%';
                    progressText.textContent = `${this.currentIndex} / ${this.recipients.length} completed`;
                    
                    try {
                        // Use v4 batch function for up to 10 recipients at once
                        if (batchRecipients.length === 1) {
                            // For single recipient, use regular serveNotice
                            const result = await this.createSingleNotice(batchRecipients[0], agencyName, caseNumber, rightsStatement);
                            this.results.push({
                                address: batchRecipients[0].address,
                                status: 'success',
                                noticeId: result.noticeId,
                                txHash: result.txHash
                            });
                        } else {
                            // Use batch function for multiple recipients
                            const result = await this.createBatchNotices(batchRecipients, agencyName, caseNumber, rightsStatement);
                            
                            // Add results for each recipient in the batch
                            batchRecipients.forEach((recipient, index) => {
                                this.results.push({
                                    address: recipient.address,
                                    status: 'success',
                                    alertId: result.alertIds[index],
                                    documentId: result.documentIds[index],
                                    txHash: result.txHash
                                });
                            });
                        }
                        
                        // Update results display
                        resultsDiv.innerHTML = this.formatResults();
                        
                    } catch (error) {
                        console.error(`Batch failed:`, error);
                        // If batch fails, mark all recipients in batch as failed
                        batchRecipients.forEach(recipient => {
                            this.results.push({
                                address: recipient.address,
                                status: 'failed',
                                error: error.message
                            });
                        });
                        
                        resultsDiv.innerHTML = this.formatResults();
                    }
                    
                    this.currentIndex = batchEnd;
                    
                    // Small delay between batch transactions
                    if (this.currentIndex < this.recipients.length) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
                
                // Update final progress
                const finalProgress = Math.round((this.currentIndex / this.recipients.length) * 100);
                progressBar.style.width = finalProgress + '%';
                progressText.textContent = `${this.currentIndex} / ${this.recipients.length} completed`;
                
                if (this.currentIndex === this.recipients.length) {
                    uiManager.showNotification('success', 'Batch processing completed!');
                }
            },
            
            async createSingleNotice(recipient, agencyName, caseNumber, rightsStatement) {
                // Simplified version - in real implementation, would use full encryption logic
                const tx = await legalContract.serveNotice(
                    recipient.address,
                    this.document ? 'encrypted-ipfs-hash' : '',
                    '', // decryptionKey
                    agencyName || '',
                    recipient.noticeType || '',
                    caseNumber || '',
                    recipient.publicText || '',
                    rightsStatement || '',
                    true, // sponsorFees
                    '' // metadataURI - placeholder for batch operations
                ).send({
                        feeLimit: 100_000_000,
                        callValue: 0, // Add appropriate fee
                        shouldPollResponse: true
                    });
                
                return {
                    noticeId: tx.noticeId || Math.floor(Math.random() * 10000),
                    txHash: tx
                };
            },
            
            async createBatchNotices(recipients, agencyName, caseNumber, rightsStatement) {
                // Calculate total fee for batch
                const feePerNotice = 25e6; // 25 TRX per notice
                const totalFee = feePerNotice * recipients.length;
                
                // Build batch notice array for v4 contract
                const batchNotices = recipients.map(recipient => ({
                    recipient: recipient.address,
                    encryptedIPFS: this.document ? 'batch-encrypted-ipfs' : '',
                    encryptionKey: this.document ? 'batch-key' : '',
                    issuingAgency: agencyName || '',
                    noticeType: recipient.noticeType || 'Legal Notice',
                    caseNumber: caseNumber || '',
                    caseDetails: recipient.publicText || '',
                    legalRights: rightsStatement || '',
                    sponsorFees: true,
                    metadataURI: '' // Placeholder for batch
                }));
                
                console.log('Sending batch of', batchNotices.length, 'notices');
                
                // Estimate energy needed for batch and prepare rental
                const hasDocument = this.document ? true : false;
                let totalEstimatedEnergy;
                let energyResult;
                
                // Use enhanced energy rental if available
                if (window.EnhancedEnergyRental) {
                    totalEstimatedEnergy = EnhancedEnergyRental.estimateEnergyNeeded({
                        hasDocument: hasDocument,
                        isBatch: true,
                        batchSize: recipients.length,
                        documentSize: this.document?.length || 0,
                        ipfsUpload: true
                    });
                    
                    console.log(`Checking energy for batch of ${recipients.length} notices:`, {
                        totalEnergy: totalEstimatedEnergy,
                        perNotice: Math.round(totalEstimatedEnergy / recipients.length)
                    });
                    
                    energyResult = await EnhancedEnergyRental.handleEnergyRental({
                        energyNeeded: totalEstimatedEnergy,
                        userAddress: tronWeb.defaultAddress.base58,
                        showProgress: true,
                        autoApprove: false
                    });
                } else {
                    // Fallback to original energy rental
                    totalEstimatedEnergy = EnergyRental.estimateEnergyNeeded(hasDocument, true, recipients.length);
                    
                    console.log(`Checking energy for batch of ${recipients.length} notices:`, {
                        totalEnergy: totalEstimatedEnergy,
                        perNotice: Math.round(totalEstimatedEnergy / recipients.length)
                    });
                    
                    energyResult = await EnergyRental.prepareEnergyForTransaction(
                        totalEstimatedEnergy,
                        tronWeb.defaultAddress.base58
                    );
                }
                
                if (!energyResult.success) {
                    // Check if user cancelled or chose alternative
                    if (energyResult.userChoice === 'cancel') {
                        throw new Error('Batch processing cancelled by user');
                    } else if (energyResult.userChoice === 'manual') {
                        // User chose manual rental, wait for them to complete it
                        throw new Error('Please complete energy rental and try again');
                    } else if (energyResult.userChoice === 'proceed') {
                        // User chose to burn TRX instead
                        console.log('User chose to proceed with batch without energy rental');
                    } else if (energyResult.showAlternatives && window.EnergyRental) {
                        // Fallback to original dialog for backward compatibility
                        const result = await window.EnergyRental.showAlternativesDialog(energyResult);
                        
                        if (result.action === 'proceed') {
                            // User wants to burn TRX and proceed
                            console.log('User chose to proceed with batch without energy rental');
                        } else {
                            // User cancelled or chose external option
                            throw new Error('Batch processing cancelled by user');
                        }
                    } else {
                        // No alternatives, just fail
                        throw new Error(energyResult.message || energyResult.error || 'Energy preparation failed for batch');
                    }
                }
                
                if (energyResult.rentalNeeded && energyResult.savedTRX) {
                    console.log(`Saved ${energyResult.savedTRX.toFixed(2)} TRX by renting energy for batch of ${recipients.length} notices`);
                    uiManager.showNotification('success', `Saved ${energyResult.savedTRX.toFixed(2)} TRX on energy costs!`);
                }
                
                // Call v4 contract's serveNoticeBatch function
                const tx = await legalContract.serveNoticeBatch(batchNotices).send({
                    feeLimit: 500_000_000, // Higher limit for batch
                    callValue: totalFee,
                    shouldPollResponse: true
                });
                
                console.log('Batch transaction result:', tx);
                
                // Extract alert and document IDs from events
                let alertIds = [];
                let documentIds = [];
                
                if (tx && tx.events) {
                    // Parse NoticeServed events to get IDs
                    const noticeEvents = tx.events.filter(e => e.name === 'NoticeServed');
                    alertIds = noticeEvents.map(e => e.result.alertId);
                    documentIds = noticeEvents.map(e => e.result.documentId);
                }
                
                const finalAlertIds = alertIds.length ? alertIds : recipients.map((_, i) => this.currentIndex + i + 1);
                const finalDocumentIds = documentIds.length ? documentIds : recipients.map((_, i) => this.currentIndex + i + 1001);
                
                // Update backend for each notice in the batch
                for (let i = 0; i < recipients.length; i++) {
                    await updateBackendAfterNoticeCreation({
                        noticeId: finalAlertIds[i] || finalDocumentIds[i],
                        alertId: finalAlertIds[i],
                        documentId: this.document ? finalDocumentIds[i] : '',
                        serverAddress: tronWeb.defaultAddress.base58,
                        recipientAddress: recipients[i].address,
                        noticeType: recipients[i].noticeType || 'Legal Notice',
                        issuingAgency: agencyName || '',
                        caseNumber: caseNumber || '',
                        documentHash: '',
                        ipfsHash: this.document ? 'batch-encrypted-ipfs' : '',
                        hasDocument: !!this.document
                    });
                }
                
                return {
                    alertIds: finalAlertIds,
                    documentIds: finalDocumentIds,
                    txHash: tx.txid || tx
                };
            },
            
            pauseBatch() {
                this.isPaused = true;
                document.getElementById('pauseBatchBtn').style.display = 'none';
                document.getElementById('resumeBatchBtn').style.display = 'inline-block';
                uiManager.showNotification('info', 'Batch processing paused');
            },
            
            resumeBatch() {
                this.isPaused = false;
                document.getElementById('pauseBatchBtn').style.display = 'inline-block';
                document.getElementById('resumeBatchBtn').style.display = 'none';
                
                // Get stored details
                const agencyName = document.getElementById('batchAgencyName').value || '';
                const caseNumber = document.getElementById('batchCaseNumber').value || '';
                const rightsStatement = document.getElementById('batchRightsStatement').value || '';
                
                this.processBatch(agencyName, caseNumber, rightsStatement);
                uiManager.showNotification('info', 'Batch processing resumed');
            },
            
            formatResults() {
                return this.results.map(r => {
                    let successMsg = '';
                    if (r.status === 'success') {
                        if (r.noticeId) {
                            successMsg = ` Notice #${r.noticeId}`;
                        } else if (r.alertId) {
                            successMsg = ` Alert #${r.alertId} / Doc #${r.documentId}`;
                        } else {
                            successMsg = ' Sent';
                        }
                    }
                    
                    return `
                        <div class="batch-result-item ${r.status}">
                            <span>${r.address.substring(0, 10)}...${r.address.substring(r.address.length - 8)}</span>
                            <span>${r.status === 'success' ? successMsg : ` ${r.error}`}</span>
                        </div>
                    `;
                }).join('');
            },
            
            exportResults() {
                if (!this.results.length) {
                    uiManager.showNotification('error', 'No results to export');
                    return;
                }
                
                const csv = 'Address,Status,Notice ID,Alert ID,Document ID,Transaction Hash,Error\n' +
                    this.results.map(r => 
                        `${r.address},${r.status},${r.noticeId || ''},${r.alertId || ''},${r.documentId || ''},${r.txHash || ''},${r.error || ''}`
                    ).join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `batch-results-${Date.now()}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                uiManager.showNotification('success', 'Results exported');
            }
        };
        
        // Reset mint form to initial state
        function resetMintForm() {
            // Reset to step 1
            document.getElementById('mintStep1').style.display = 'block';
            document.getElementById('mintStep2').style.display = 'none';
            
            // Clear form fields
            const fieldsToReset = [
                'documentUpload',
                'recipientAddress',
                'noticeText',
                'noticeType',
                'agencyName',
                'caseNumber',
                'specificDetails',
                'rightsStatement'
            ];
            
            fieldsToReset.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    if (field.type === 'file') {
                        field.value = '';
                    } else if (field.tagName === 'SELECT') {
                        field.selectedIndex = 0;
                    } else {
                        field.value = '';
                    }
                }
            });
            
            // Clear document preview and restore upload area
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.innerHTML = `
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary);"></i>
                    <p>Drag & drop your document here or click to browse</p>
                    <p style="font-size: 0.85rem; color: #666;">Supported formats: JPEG, PNG</p>
                    <input type="file" id="documentUpload" accept="image/jpeg,image/jpg,image/png,application/pdf,.pdf" onchange="handleDocumentUpload(event)">
                    <!-- Backup button in case click handler fails -->
                    <button type="button" class="btn btn-primary" style="margin-top: 10px;" onclick="document.getElementById('documentUpload').click()">
                        <i class="fas fa-folder-open"></i> Select File
                    </button>
                `;
            }
            
            // Clear any stored document data
            window.uploadedDocument = null;
            
            // Reset fee display
            if (typeof updateFeeEstimate === 'function') {
                updateFeeEstimate();
            }
        }
        
        // Clear all form data function
        function clearAllFormData() {
            // Confirm with user
            if (!confirm('Are you sure you want to clear all form data? This will reset everything including uploaded documents.')) {
                return;
            }
            
            // Clear all mint form fields
            const fieldsToReset = [
                'mintRecipient',
                'mintTokenName',
                'mintCaseNumber',
                'mintJurisdiction',
                'noticeText',
                'noticeType',
                'agencyName',
                'caseNumber',
                'specificDetails',
                'rightsStatement',
                'documentUpload'
            ];
            
            fieldsToReset.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    if (field.type === 'file') {
                        field.value = '';
                    } else if (field.tagName === 'SELECT') {
                        field.selectedIndex = 0;
                    } else if (field.type === 'checkbox' || field.type === 'radio') {
                        field.checked = false;
                    } else {
                        field.value = '';
                    }
                }
            });
            
            // Reset delivery method to default (document)
            const documentRadio = document.querySelector('input[name="deliveryMethod"][value="document"]');
            if (documentRadio) {
                documentRadio.checked = true;
            }
            
            // Clear document preview and restore upload area
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.innerHTML = `
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary);"></i>
                    <p>Drag & drop your document here or click to browse</p>
                    <p style="font-size: 0.85rem; color: #666;">Supported formats: JPEG, PNG, PDF</p>
                    <input type="file" id="documentUpload" accept="image/jpeg,image/jpg,image/png,application/pdf,.pdf" onchange="handleDocumentUpload(event)">
                    <!-- Backup button in case click handler fails -->
                    <button type="button" class="btn btn-primary" style="margin-top: 10px;" onclick="document.getElementById('documentUpload').click()">
                        <i class="fas fa-folder-open"></i> Select File
                    </button>
                `;
                
                // Re-setup upload area handlers
                setupUploadAreaForModal();
            }
            
            // Clear any stored document data
            window.uploadedDocument = null;
            
            // Clear localStorage data for this form
            const storageKeys = Object.keys(localStorage);
            storageKeys.forEach(key => {
                if (key.startsWith('mintForm_') || key.startsWith('notice_')) {
                    localStorage.removeItem(key);
                }
            });
            
            // Reset character count
            const charCountSpan = document.getElementById('charCount');
            if (charCountSpan) {
                charCountSpan.textContent = '0';
                charCountSpan.style.color = 'var(--text-secondary)';
            }
            
            // Update fee estimate
            if (typeof updateFeeEstimate === 'function') {
                updateFeeEstimate();
            }
            
            // Show success notification
            uiManager.showNotification('success', 'All form data has been cleared');
        }
        
        // Update creation fee display
        function updateCreationFeeDisplay() {
            // Call the existing updateFeeEstimate function
            if (typeof updateFeeEstimate === 'function') {
                updateFeeEstimate();
            }
        }
        
        // Check if mint form has data
        function checkMintFormHasData() {
            try {
                // Check if any form fields have data (with null checks)
                const recipientEl = document.getElementById('mintRecipient');
                const caseNumberEl = document.getElementById('mintCaseNumber');
                const jurisdictionEl = document.getElementById('mintJurisdiction');
                const documentTypeEl = document.getElementById('mintDocumentType');
                const issuingAgencyEl = document.getElementById('issuingAgency');
                const caseDetailsEl = document.getElementById('caseDetails');
                const noticeTextEl = document.getElementById('noticeTextInput');
                
                const recipient = recipientEl ? recipientEl.value.trim() : '';
                const caseNumber = caseNumberEl ? caseNumberEl.value.trim() : '';
                const jurisdiction = jurisdictionEl ? jurisdictionEl.value : '0';
                const documentType = documentTypeEl ? documentTypeEl.value : '0';
                const issuingAgency = issuingAgencyEl ? issuingAgencyEl.value.trim() : '';
                const caseDetails = caseDetailsEl ? caseDetailsEl.value.trim() : '';
                const noticeText = noticeTextEl ? noticeTextEl.value.trim() : '';
                
                // Check if image was uploaded
                const hasImage = uploadedImage !== null;
                
                // Return true if any field has data
                return recipient || caseNumber || (jurisdiction !== '0') || (documentType !== '0') || 
                       issuingAgency || caseDetails || noticeText || hasImage;
            } catch (error) {
                console.error('Error checking form data:', error);
                return false; // If error, assume no data
            }
        }

        function openAuditModal() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Please connect to contract first');
                return;
            }
            
            document.getElementById('auditModal').style.display = 'block';
        }

        function closeAuditModal() {
            document.getElementById('auditModal').style.display = 'none';
        }

        function closeTransactionResultModal() {
            document.getElementById('transactionResultModal').style.display = 'none';
            // Also close the mint modal to return to dashboard
            const mintModal = document.getElementById('mintModal');
            if (mintModal) {
                mintModal.style.display = 'none';
            }
            // Clear the form for next use
            resetMintForm();
        }

        function showTransactionResult(success, txData) {
            const modal = document.getElementById('transactionResultModal');
            const titleElement = document.getElementById('txResultTitle');
            const contentElement = document.getElementById('txResultContent');
            
            if (success) {
                titleElement.innerHTML = '<i class="fas fa-check-circle" style="color: var(--success);"></i> Transaction Successful';
                
                let content = '<div class="transaction-result-success">';
                content += '<div class="success-icon" style="text-align: center; margin-bottom: 1.5rem;">';
                content += '<i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success);"></i>';
                content += '</div>';
                
                // Transaction details
                content += '<div class="transaction-details" style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">';
                content += '<h4 style="margin-bottom: 1rem;">Transaction Details</h4>';
                
                if (txData.noticeId) {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Notice ID:</span>`;
                    content += `<strong style="color: var(--success);">#${txData.noticeId}</strong>`;
                    content += `</div>`;
                }
                
                if (txData.txHash) {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Transaction Hash:</span>`;
                    content += `<a href="${getTxScanUrl()}${txData.txHash}" target="_blank" style="color: var(--accent-blue);">`;
                    content += `${txData.txHash.substring(0, 10)}...${txData.txHash.substring(txData.txHash.length - 8)}`;
                    content += `</a>`;
                    content += `</div>`;
                }
                
                if (txData.recipient) {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Recipient Wallet:</span>`;
                    content += `<strong>${formatAddress(txData.recipient)}</strong>`;
                    content += `</div>`;
                }
                
                // Add timestamp
                content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                content += `<span>Date & Time:</span>`;
                content += `<strong>${new Date().toLocaleString('en-US', { 
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZoneName: 'short'
                })}</strong>`;
                content += `</div>`;
                
                // Add network
                content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                content += `<span>Network:</span>`;
                content += `<strong>${document.getElementById('networkName')?.textContent || 'TRON'}</strong>`;
                content += `</div>`;
                
                // Add contract address
                content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                content += `<span>Contract:</span>`;
                content += `<a href="${getContractScanUrl()}" target="_blank" style="color: var(--accent-blue); font-size: 0.9rem;">`;
                content += `${legalContract.address.substring(0, 10)}...${legalContract.address.substring(legalContract.address.length - 8)}`;
                content += `</a>`;
                content += `</div>`;
                
                content += '</div>';
                
                // Cost breakdown
                content += '<div class="cost-breakdown" style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">';
                content += '<h4 style="margin-bottom: 1rem; color: var(--accent-blue);"><i class="fas fa-receipt"></i> Transaction Cost Breakdown</h4>';
                
                // Base fee amount based on what was actually paid
                const baseFee = txData.feePaid || 22;
                const isLawEnforcement = baseFee <= 2;
                const sponsorshipFee = 2; // Always 2 TRX
                let serviceFee = 0;
                
                // Calculate service fee
                if (!isLawEnforcement) {
                    serviceFee = baseFee - sponsorshipFee; // Usually 20 TRX for regular users
                }
                
                // Service fee section
                if (isLawEnforcement) {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(34,197,94,0.1); border-radius: 0.25rem;">`;
                    content += `<span><i class="fas fa-shield-alt" style="color: #22c55e;"></i> Service Fee (Law Enforcement Exempt):</span>`;
                    content += `<strong style="color: #22c55e;">0.00 TRX</strong>`;
                    content += `</div>`;
                } else {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 0.25rem;">`;
                    content += `<span><i class="fas fa-file-contract" style="color: #60a5fa;"></i> Service Fee (to Contract):</span>`;
                    content += `<strong>${serviceFee} TRX</strong>`;
                    content += `</div>`;
                }
                
                // Sponsorship fee (always paid)
                content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 0.25rem;">`;
                content += `<span><i class="fas fa-gift" style="color: #10b981;"></i> Recipient Sponsorship (to Recipient):</span>`;
                content += `<strong>${sponsorshipFee} TRX</strong>`;
                content += `</div>`;
                
                // Energy rental section
                if (txData.energyResult && txData.energyResult.success && txData.energyResult.rentalTxId) {
                    // Use prepaymentCost or rentalCost from the energy result
                    const rentalCost = txData.energyResult.prepaymentCost || txData.energyResult.rentalCost || txData.energyResult.cost || 0.30;
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 0.25rem;">`;
                    content += `<span><i class="fas fa-bolt" style="color: #f59e0b;"></i> Energy Rental Cost:</span>`;
                    content += `<strong>${rentalCost.toFixed(2)} TRX</strong>`;
                    content += `</div>`;
                    
                    if (txData.energyResult.savedTRX) {
                        content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(34,197,94,0.1); border-radius: 0.25rem;">`;
                        content += `<span><i class="fas fa-piggy-bank" style="color: #22c55e;"></i> Energy Savings (vs burning TRX):</span>`;
                        content += `<strong style="color: #22c55e;">-${txData.energyResult.savedTRX.toFixed(2)} TRX</strong>`;
                        content += `</div>`;
                    }
                } else if (txData.energyUsed && txData.energyUsed > 0) {
                    // Show energy burned if no rental
                    const energyBurnCost = (txData.energyUsed * 420) / 1_000_000; // 420 SUN per energy
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 0.25rem;">`;
                    content += `<span><i class="fas fa-fire" style="color: #dc2626;"></i> Energy Burned (${txData.energyUsed.toLocaleString()} units):</span>`;
                    content += `<strong>${energyBurnCost.toFixed(4)} TRX</strong>`;
                    content += `</div>`;
                }
                
                // Total line
                let energyCost = 0;
                if (txData.energyResult && txData.energyResult.success && txData.energyResult.rentalTxId) {
                    energyCost = txData.energyResult.prepaymentCost || txData.energyResult.rentalCost || txData.energyResult.cost || 0;
                } else if (txData.energyUsed && txData.energyUsed > 0) {
                    energyCost = (txData.energyUsed * 420) / 1_000_000; // Energy burn cost
                }
                const totalCost = baseFee + energyCost;
                content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-top: 0.75rem; padding: 0.75rem; background: rgba(59,130,246,0.1); border-radius: 0.25rem; border: 1px solid rgba(59,130,246,0.3);">`;
                content += `<span style="font-weight: 600; font-size: 1.1rem;"><i class="fas fa-calculator"></i> Total Transaction Cost:</span>`;
                content += `<strong style="font-size: 1.2rem; color: var(--accent-blue);">${totalCost.toFixed(2)} TRX</strong>`;
                content += `</div>`;
                
                // Add explanation of fees
                content += `<div style="margin-top: 1rem; padding: 0.75rem; background: rgba(0,0,0,0.1); border-radius: 0.25rem; font-size: 0.875rem;">`;
                content += `<p style="margin: 0 0 0.5rem 0; font-weight: 600;">Fee Distribution:</p>`;
                content += `<ul style="margin: 0; padding-left: 1.5rem; list-style: none;">`;
                if (serviceFee > 0) {
                    content += `<li><i class="fas fa-chevron-right" style="color: #60a5fa; margin-right: 0.5rem;"></i>Service Fee  Contract treasury for platform operations</li>`;
                }
                content += `<li><i class="fas fa-chevron-right" style="color: #10b981; margin-right: 0.5rem;"></i>Sponsorship  Sent directly to recipient's wallet</li>`;
                content += `<li><i class="fas fa-chevron-right" style="color: #f59e0b; margin-right: 0.5rem;"></i>Energy  Network fees for blockchain processing</li>`;
                content += `</ul>`;
                
                // Show warning if energy rental failed
                if (txData.energyResult && !txData.energyResult.success && txData.energyResult.rentalFailed) {
                    content += `<div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(220,38,38,0.1); border-radius: 0.25rem; border: 1px solid rgba(220,38,38,0.3);">`;
                    content += `<i class="fas fa-exclamation-triangle" style="color: #dc2626; margin-right: 0.5rem;"></i>`;
                    content += `<strong style="color: #dc2626;">Energy rental failed</strong> - Transaction used standard energy burning instead of rental savings.`;
                    content += `</div>`;
                }
                
                content += `</div>`;
                
                content += '</div>';
                
                // Add IPFS Information if available
                if (txData.ipfsData && txData.ipfsData.ipfsHash) {
                    content += '<div class="ipfs-info" style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">';
                    content += '<h4 style="margin-bottom: 1rem;"><i class="fas fa-cloud"></i> IPFS Storage</h4>';
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Document Hash:</span>`;
                    content += `<code style="font-size: 0.85rem;">${txData.ipfsData.ipfsHash}</code>`;
                    content += `</div>`;
                    content += '<div style="margin-top: 0.5rem;">';
                    content += `<a href="https://ipfs.io/ipfs/${txData.ipfsData.ipfsHash}" target="_blank" class="btn btn-sm btn-secondary" style="margin-right: 0.5rem;">`;
                    content += '<i class="fas fa-external-link-alt"></i> View on IPFS.io';
                    content += '</a>';
                    content += `<a href="https://gateway.pinata.cloud/ipfs/${txData.ipfsData.ipfsHash}" target="_blank" class="btn btn-sm btn-secondary">`;
                    content += '<i class="fas fa-external-link-alt"></i> View on Pinata';
                    content += '</a>';
                    content += '</div>';
                    content += '</div>';
                }
                
                content += '</div>';
                
                // Add action buttons
                content += '<div class="transaction-actions" style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center;">';
                content += `<button class="btn btn-primary" onclick="exportReceipt()">`;
                content += '<i class="fas fa-file-download"></i> Export Receipt';
                content += '</button>';
                content += `<button class="btn btn-secondary" onclick="window.print()">`;
                content += '<i class="fas fa-print"></i> Print';
                content += '</button>';
                if (txData.txHash && txData.txHash !== 'Transaction confirmed') {
                    const shortHash = `${txData.txHash.substring(0, 6)}...${txData.txHash.substring(txData.txHash.length - 4)}`;
                    content += `<a href="${getTxScanUrl()}${txData.txHash}" target="_blank" class="btn btn-secondary">`;
                    content += `<i class="fas fa-external-link-alt"></i> ${shortHash}`;
                    content += '</a>';
                }
                content += '</div>';
                
                // Add process server instructions with better contrast
                content += '<div class="process-server-instructions" style="margin-top: 2rem; padding: 1.5rem; background: #1e293b; border: 2px solid #3b82f6; border-radius: 0.5rem;">';
                content += '<h4 style="color: #3b82f6; margin-bottom: 1rem;"><i class="fas fa-info-circle"></i> Process Server Instructions</h4>';
                content += '<ol style="margin: 0; padding-left: 1.5rem; color: #e2e8f0;">';
                content += '<li style="margin-bottom: 0.5rem;">Save or print this receipt for your records</li>';
                content += '<li style="margin-bottom: 0.5rem;">A 3.5 TRX (~$1 USD) notification transaction was sent (memo not visible in most wallets)</li>';
                content += '<li style="margin-bottom: 0.5rem;">Once accepted, you will receive confirmation and can verify delivery on the blockchain</li>';
                content += '<li style="margin-bottom: 0.5rem;">The notice NFT and delivery proof are permanently stored on the TRON blockchain</li>';
                content += '<li style="margin-bottom: 0.5rem;">You can track delivery status in the Audit section</li>';
                content += '</ol>';
                
                if (txData.noticeId) {
                    const directLink = `https://blockserved.com`;
                    
                    content += '<div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 0.375rem;">';
                    content += '<strong style="color: #92400e;">Recipient Access:</strong><br>';
                    content += `<p style="margin: 0.5rem 0;">Recipients can view their notice by visiting <code style="user-select: all; color: #92400e;">www.blockserved.com</code> and connecting their wallet.</p>`;
                    content += `<button class="btn btn-small" style="margin-left: 0.5rem;" onclick="navigator.clipboard.writeText('www.blockserved.com')">`;
                    content += '<i class="fas fa-copy"></i> Copy';
                    content += '</button>';
                    content += '</div>';
                    
                    content += '<div style="margin-top: 1rem; padding: 1rem; background: #dbeafe; border: 1px solid #60a5fa; border-radius: 0.375rem;">';
                    content += '<strong style="color: #1d4ed8;"><i class="fas fa-info-circle"></i> Blockchain Notification Status</strong><br>';
                    content += '<div style="margin-top: 0.5rem; color: #1e40af;">';
                    content += ' NFT minted to recipient wallet (on-chain proof of service)<br>';
                    content += ' 3.5 TRX (~$1 USD) sent to ensure visibility in transaction history<br>';
                    content += ' Transaction memo contains notice link (viewable on TronScan)<br>';
                    content += ' Legal notice permanently stored on TRON blockchain<br>';
                    content += '<div style="margin-top: 0.5rem; padding: 0.5rem; background: #fef3c7; border-radius: 0.25rem; color: #92400e;">';
                    content += '<strong>Note:</strong> While wallet apps may not display NFTs or memos, the recipient has been served via blockchain. The transaction and NFT serve as proof of service attempt.';
                    content += '</div>';
                    content += '</div>';
                    content += '</div>';
                }
                
                content += '</div>';
                
                // Store transaction data for export
                window.currentTransactionData = {
                    txHash: txData.txHash,
                    noticeId: txData.noticeId,
                    recipient: txData.recipient,
                    timestamp: new Date().toISOString(),
                    network: document.getElementById('networkName')?.textContent || 'TRON',
                    details: content,
                    ipfsData: txData.ipfsHash,
                    encryptionMethod: txData.encryptionMethod
                };
                
                contentElement.innerHTML = content;
            } else {
                titleElement.innerHTML = '<i class="fas fa-exclamation-circle" style="color: var(--error);"></i> Transaction Failed';
                
                let content = '<div class="transaction-result-error">';
                content += '<div class="error-icon" style="text-align: center; margin-bottom: 1.5rem;">';
                content += '<i class="fas fa-exclamation-circle" style="font-size: 4rem; color: var(--error);"></i>';
                content += '</div>';
                
                // Error message
                content += '<div class="error-details" style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--error); margin-bottom: 1rem;">';
                content += '<h4 style="color: var(--error); margin: 0 0 0.5rem 0;">Error Details</h4>';
                content += '<p style="color: var(--text-primary); margin: 0;">' + (txData.errorMessage || txData.error || 'Transaction failed. Please try again.') + '</p>';
                content += '</div>';
                
                // Transaction attempt details
                if (txData.recipient || txData.noticeType || txData.estimatedFee) {
                    content += '<div class="attempt-details" style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">';
                    content += '<h4 style="margin-bottom: 1rem;">Attempted Transaction</h4>';
                    
                    if (txData.recipient) {
                        content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                        content += `<span>Recipient:</span>`;
                        content += `<strong>${formatAddress(txData.recipient)}</strong>`;
                        content += `</div>`;
                    }
                    
                    if (txData.noticeType) {
                        content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                        content += `<span>Notice Type:</span>`;
                        content += `<strong>${txData.noticeType}</strong>`;
                        content += `</div>`;
                    }
                    
                    if (txData.estimatedFee) {
                        content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                        content += `<span>Estimated Fee:</span>`;
                        content += `<strong>${txData.estimatedFee} TRX</strong>`;
                        content += `</div>`;
                    }
                    
                    // Add timestamp
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Time:</span>`;
                    content += `<strong>${new Date(txData.timestamp || Date.now()).toLocaleTimeString()}</strong>`;
                    content += `</div>`;
                    
                    content += '</div>';
                }
                
                // Troubleshooting tips
                content += '<div class="troubleshooting" style="background: rgba(251, 191, 36, 0.1); padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--warning);">';
                content += '<h4 style="color: var(--warning); margin: 0 0 0.5rem 0;"><i class="fas fa-lightbulb"></i> Troubleshooting Tips</h4>';
                content += '<ul style="margin: 0; padding-left: 1.5rem; color: var(--text-primary);">';
                
                // Check error type and provide specific tips
                const errorString = (txData.errorMessage || txData.error || '').toString().toLowerCase();
                
                if (errorString.includes('insufficient') || errorString.includes('balance')) {
                    content += '<li>Check your TRX balance - you need enough for fees</li>';
                    content += '<li>Ensure you have at least 250 TRX for document notices</li>';
                } else if (errorString.includes('energy')) {
                    content += '<li>Transaction requires more energy than available</li>';
                    content += '<li>Energy rental should happen automatically - try again</li>';
                } else if (errorString.includes('revert')) {
                    content += '<li>The contract rejected the transaction</li>';
                    content += '<li>Check that the recipient address is valid</li>';
                    content += '<li>Ensure all required fields are filled correctly</li>';
                } else if (errorString.includes('network')) {
                    content += '<li>Network connection issue detected</li>';
                    content += '<li>Check your internet connection</li>';
                    content += '<li>Try switching to a different network in your wallet</li>';
                } else {
                    content += '<li>Check your wallet connection and try again</li>';
                    content += '<li>Ensure you have sufficient TRX balance</li>';
                    content += '<li>Try refreshing the page if the issue persists</li>';
                }
                
                content += '<li>Contact support if the problem continues</li>';
                content += '</ul>';
                content += '</div>';
                
                content += '</div>';
                
                contentElement.innerHTML = content;
            }
            
            modal.style.display = 'block';
        }

        async function openAcceptModal(noticeId) {
            currentNoticeId = noticeId;
            
            // Fetch notice details
            try {
                const details = await getNoticeDetails(noticeId);
                if (details) {
                    document.getElementById('acceptNoticeId').textContent = noticeId;
                    document.getElementById('acceptDocumentType').textContent = getDocumentTypeString(details.documentType);
                    document.getElementById('acceptJurisdiction').textContent = getJurisdictionString(details.jurisdictionIndex);
                    document.getElementById('acceptCaseNumber').textContent = details.caseNumberHash || 'Not Available';
                    document.getElementById('acceptServer').innerHTML = createAddressDisplay(details.server);
                    document.getElementById('acceptTimestamp').textContent = new Date(parseInt(details.timestamp) * 1000).toLocaleString();
                    
                    // Preview images not implemented in simplified contract
                    document.getElementById('acceptPreview').style.display = 'none';
                    
                    // Check if this is a text-only notice (no document)
                    const isTextOnly = !details.documentId || details.documentId == 0;
                    
                    if (isTextOnly) {
                        // For text-only notices, just show the content, no signature required
                        uiManager.showNotification('info', 'This is a text-only notice. No signature required.');
                        viewTextNotice(noticeId);
                        return;
                    }
                    
                    document.getElementById('acceptModal').style.display = 'block';
                } else {
                    uiManager.showNotification('error', 'Failed to load notice details');
                }
            } catch (error) {
                console.error('Error loading notice:', error);
                uiManager.showNotification('error', 'Failed to load notice details');
            }
        }

        function closeAcceptModal() {
            document.getElementById('acceptModal').style.display = 'none';
            currentNoticeId = null;
        }
        
        // View text-only notice (no signature required)
        async function viewTextNotice(noticeId) {
            try {
                const details = await getNoticeDetails(noticeId);
                if (!details) {
                    uiManager.showNotification('error', 'Notice not found');
                    return;
                }
                
                // Show modal with text notice content
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2><i class="fas fa-comment-alt" style="color: #3b82f6;"></i> Text Notice</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info" style="background: #e0f2fe; border-color: #3b82f6;">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                                <strong>View Only Notice</strong>
                                <p style="margin: 0.25rem 0 0 0;">This is a text-only notice that does not require a signature.</p>
                            </div>
                            
                            <div class="notice-details" style="margin-top: 1rem;">
                                <div class="token-detail">
                                    <span>Notice ID:</span>
                                    <span>${noticeId}</span>
                                </div>
                                <div class="token-detail">
                                    <span>Type:</span>
                                    <span>${details.noticeType || 'Text Notice'}</span>
                                </div>
                                <div class="token-detail">
                                    <span>Sender:</span>
                                    <span>${createAddressDisplay(details.server)}</span>
                                </div>
                                <div class="token-detail">
                                    <span>Date:</span>
                                    <span>${new Date(parseInt(details.timestamp) * 1000).toLocaleString()}</span>
                                </div>
                                ${details.caseNumber ? `
                                <div class="token-detail">
                                    <span>Reference:</span>
                                    <span>${details.caseNumber}</span>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="notice-content" style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                                <h4>Notice Content:</h4>
                                <p style="margin-top: 0.5rem;">${details.caseDetails || details.noticeText || 'No content available'}</p>
                                ${details.legalRights ? `<p style="margin-top: 0.5rem; font-weight: 500;">${details.legalRights}</p>` : ''}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error viewing text notice:', error);
                uiManager.showNotification('error', 'Failed to load notice');
            }
        }

        function closeTxModal() {
            document.getElementById('txModal').style.display = 'none';
            // Also close the mint modal to return to dashboard
            const mintModal = document.getElementById('mintModal');
            if (mintModal) {
                mintModal.style.display = 'none';
            }
            // Clear the form for next use
            if (typeof resetMintForm === 'function') {
                resetMintForm();
            }
        }

        // Export printable receipt
        function exportReceipt() {
            // Check both possible locations for transaction data
            const txData = window.currentTransactionData || currentTransactionData;
            
            if (!txData) {
                uiManager.showNotification('error', 'No transaction data available');
                return;
            }
            
            const { txHash, message, timestamp, details, ipfsData, network } = txData;
            
            // Create a new window for the printable receipt
            const receiptWindow = window.open('', '_blank', 'width=800,height=600');
            
            // Extract relevant data from details HTML
            let tokenName = '';
            let noticeId = 'N/A';
            let alertId = 'N/A';
            let recipient = '';
            let caseNumber = '';
            let jurisdiction = '';
            
            // Parse details HTML to extract values
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = details;
            const tokenDetails = tempDiv.querySelectorAll('.token-detail');
            tokenDetails.forEach(detail => {
                const spans = detail.querySelectorAll('span');
                if (spans.length >= 2) {
                    const label = spans[0].textContent;
                    const value = spans[1].textContent;
                    if (label.includes('Token Name')) tokenName = value;
                    if (label.includes('Notice ID')) noticeId = value;
                    if (label.includes('Alert ID')) alertId = value;
                    if (label.includes('Recipient')) recipient = value;
                    if (label.includes('Case Number')) caseNumber = value;
                    if (label.includes('Jurisdiction')) jurisdiction = value;
                }
            });
            
            // Generate receipt HTML
            const receiptHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Legal Notice Delivery Receipt</title>
                    <style>
                        @media print {
                            @page { margin: 0.5in; }
                            .no-print { display: none !important; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.6;
                            color: #333;
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 20px;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 2px solid #333;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        h1 {
                            margin: 0;
                            color: #1e3a8a;
                        }
                        .receipt-info {
                            background: #f5f5f5;
                            padding: 20px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        .info-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                            padding-bottom: 10px;
                            border-bottom: 1px dotted #ccc;
                        }
                        .info-row:last-child {
                            border-bottom: none;
                            margin-bottom: 0;
                        }
                        .label {
                            font-weight: bold;
                            color: #555;
                        }
                        .value {
                            color: #333;
                            word-break: break-all;
                        }
                        .verification-section {
                            background: #e8f4f8;
                            padding: 20px;
                            border-radius: 8px;
                            margin-top: 30px;
                        }
                        .verification-steps {
                            margin-top: 15px;
                            padding-left: 20px;
                        }
                        .verification-steps li {
                            margin-bottom: 10px;
                        }
                        .footer {
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 1px solid #ccc;
                            text-align: center;
                            font-size: 12px;
                            color: #666;
                        }
                        .print-button {
                            background: #1e3a8a;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 16px;
                            margin: 20px auto;
                            display: block;
                        }
                        .print-button:hover {
                            background: #1e40af;
                        }
                        .qr-placeholder {
                            width: 150px;
                            height: 150px;
                            border: 2px dashed #ccc;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 20px auto;
                            font-size: 12px;
                            color: #999;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Legal Notice Delivery Receipt</h1>
                        <p>Blockchain-Verified Service of Process</p>
                    </div>
                    
                    <div class="receipt-info">
                        <h2>Transaction Details</h2>
                        <div class="info-row">
                            <span class="label">Date & Time:</span>
                            <span class="value">${new Date(timestamp).toLocaleString('en-US', { 
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                timeZoneName: 'short'
                            })}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Transaction Hash:</span>
                            <span class="value" style="font-family: monospace; font-size: 12px;">${txHash}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Network:</span>
                            <span class="value">${network}</span>
                        </div>
                        ${tokenName ? `
                        <div class="info-row">
                            <span class="label">Token Name:</span>
                            <span class="value">${tokenName}</span>
                        </div>
                        ` : ''}
                        <div class="info-row">
                            <span class="label">Notice ID:</span>
                            <span class="value">${noticeId}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Alert ID:</span>
                            <span class="value">${alertId}</span>
                        </div>
                        ${recipient ? `
                        <div class="info-row">
                            <span class="label">Recipient:</span>
                            <span class="value">${recipient}</span>
                        </div>
                        ` : ''}
                        ${caseNumber ? `
                        <div class="info-row">
                            <span class="label">Case Number:</span>
                            <span class="value">${caseNumber}</span>
                        </div>
                        ` : ''}
                        ${ipfsData ? `
                        <div class="info-row">
                            <span class="label">IPFS Hash:</span>
                            <span class="value" style="font-family: monospace; font-size: 12px;">${ipfsData.ipfsHash}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${message && message.includes('Legal Notice Created') ? `
                    <div class="receipt-info" style="background: #f9fafb; border: 1px solid #e5e7eb;">
                        <h2>Service of Process Synopsis</h2>
                        ${(() => {
                            // Extract notice details from the transaction details
                            let noticeType = 'Legal Notice';
                            let issuingAgency = 'Not specified';
                            let caseNumber = '';
                            let caseDetails = window.lastTransactionCaseDetails || '';
                            let legalRights = '';
                            let recipientAddress = '';
                            let tokenName = '';
                            let noticeId = '';
                            let alertId = '';
                            
                            // Parse the details to extract information
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(details, 'text/html');
                            const detailElements = doc.querySelectorAll('.token-detail');
                            
                            detailElements.forEach(el => {
                                const spans = el.querySelectorAll('span');
                                if (spans.length >= 2) {
                                    const label = spans[0].textContent.trim();
                                    const value = spans[1].textContent.trim();
                                    
                                    if (label.includes('Token Name')) tokenName = value;
                                    if (label.includes('Recipient')) recipientAddress = value;
                                    if (label.includes('Notice ID')) noticeId = value;
                                    if (label.includes('Alert ID')) alertId = value;
                                }
                            });
                            
                            // Look for synopsis section in details
                            const synopsisSection = doc.querySelector('[style*="Service of Process Synopsis"]');
                            if (synopsisSection && synopsisSection.parentElement) {
                                const synopsisContent = synopsisSection.parentElement.textContent;
                                
                                // Extract values from synopsis
                                const noticeTypeMatch = synopsisContent.match(/Notice Type: ([^\\n]+)/);
                                if (noticeTypeMatch) noticeType = noticeTypeMatch[1].trim();
                                
                                const agencyMatch = synopsisContent.match(/Issuing Agency: ([^\\n]+)/);
                                if (agencyMatch) issuingAgency = agencyMatch[1].trim();
                                
                                const caseNumberMatch = synopsisContent.match(/Case Number: ([^\\n]+)/);
                                if (caseNumberMatch) caseNumber = caseNumberMatch[1].trim();
                                
                                const caseDetailsMatch = synopsisContent.match(/Case Details: ([^\\n]+)/);
                                if (caseDetailsMatch) caseDetails = caseDetailsMatch[1].trim();
                                
                                const rightsMatch = synopsisContent.match(/Legal Rights: ([^\\n]+)/);
                                if (rightsMatch) legalRights = rightsMatch[1].trim();
                            }
                            
                            return `
                            <div class="info-row">
                                <span class="label">Notice Type:</span>
                                <span class="value">${noticeType}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Issuing Agency:</span>
                                <span class="value">${issuingAgency}</span>
                            </div>
                            ${caseNumber && caseNumber !== 'Not specified' ? `
                            <div class="info-row">
                                <span class="label">Case Number:</span>
                                <span class="value">${caseNumber}</span>
                            </div>
                            ` : ''}
                            ${caseDetails && caseDetails !== 'See attached document' ? `
                            <div class="info-row">
                                <span class="label">Case Details:</span>
                                <span class="value">${caseDetails}</span>
                            </div>
                            ` : ''}
                            <div class="info-row">
                                <span class="label">Legal Rights:</span>
                                <span class="value">${legalRights || 'Recipient has the right to respond to this legal notice'}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Service Method:</span>
                                <span class="value">Electronic service via NFT delivery to TRON blockchain wallet</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Response Deadline:</span>
                                <span class="value">${new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString()} (30 days from service)</span>
                            </div>
                            
                            <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; padding: 15px; margin-top: 20px;">
                                <p style="margin: 0; font-size: 14px; color: #92400e;">
                                    <strong>Process Server Attestation:</strong> This receipt certifies that I have made diligent effort to notify the affected party at the blockchain address provided. The recipient has been served with notice that includes information about their legal rights and the requirement to respond within the statutory deadline to avoid default judgment or other negative effects on their property rights.
                                </p>
                            </div>
                            `;
                        })()}
                    </div>
                    ` : ''}
                    
                    <div class="verification-section">
                        <h3>Blockchain Verification Instructions</h3>
                        <p>This legal notice has been permanently recorded on the ${network.includes('Nile') ? 'TRON Nile Testnet' : 'TRON'} blockchain. To independently verify this transaction:</p>
                        
                        <ol class="verification-steps">
                            <li>Visit ${network.includes('Nile') ? 'https://nile.tronscan.org' : 'https://tronscan.org'}</li>
                            <li>In the search bar, paste this transaction hash: <br><code style="background: #f0f0f0; padding: 2px 5px; font-size: 12px;">${txHash}</code></li>
                            <li>Click "Search" or press Enter</li>
                            <li>Verify the following on the transaction page:
                                <ul>
                                    <li>Transaction status shows "Confirmed"</li>
                                    <li>The timestamp matches this receipt</li>
                                    <li>The contract interaction shows "serveNotice" method</li>
                                </ul>
                            </li>
                            ${ipfsData ? `<li>To view the original document:
                                <ul>
                                    <li>Visit https://gateway.pinata.cloud/ipfs/${ipfsData.ipfsHash}</li>
                                    <li>Or https://ipfs.io/ipfs/${ipfsData.ipfsHash}</li>
                                </ul>
                            </li>` : ''}
                        </ol>
                        
                        <p style="margin-top: 20px;"><strong>Note:</strong> The blockchain provides an immutable, tamper-proof record of this legal notice delivery. The transaction cannot be altered or deleted once confirmed.</p>
                    </div>
                    
                    <div class="no-print" style="display: flex; gap: 1rem; justify-content: center; margin: 2rem 0;">
                        <button class="print-button" onclick="window.print()">
                            <i class="fas fa-print"></i> Print Receipt
                        </button>
                        <button class="print-button" onclick="saveReceiptAsHTML()" style="background: #059669;">
                            <i class="fas fa-save"></i> Save Receipt
                        </button>
                    </div>
                    
                    <div class="footer">
                        <p>This receipt certifies that a legal notice was served via blockchain technology on ${new Date(timestamp).toLocaleDateString()}.</p>
                        <p>For questions about blockchain verification, consult with a technical expert or legal professional familiar with blockchain technology.</p>
                    </div>
                </body>
                </html>
            `;
            
            // Write the receipt HTML to the new window
            receiptWindow.document.write(receiptHTML);
            receiptWindow.document.close();
        }
        
        // Registration modal functions
        function closeRegistrationModal(force = false) {
            // Check if there's unsaved data
            const hasData = checkRegistrationFormHasData();
            
            if (!force && hasData) {
                const confirmClose = confirm(
                    'You have unsaved registration data. Are you sure you want to close and lose your progress?'
                );
                if (!confirmClose) {
                    return;
                }
            }
            
            document.getElementById('registrationModal').style.display = 'none';
            // Clear form
            document.getElementById('modalAgencyName').value = '';
            document.getElementById('modalAgencyEmail').value = '';
            document.getElementById('modalServerName').value = '';
            document.getElementById('modalServerPhone').value = '';
            document.getElementById('modalLicenseNumber').value = '';
            document.getElementById('modalServiceAreas').value = '';
        }
        
        // Check if registration form has data
        function checkRegistrationFormHasData() {
            const agency = document.getElementById('modalAgencyName').value.trim();
            const email = document.getElementById('modalAgencyEmail').value.trim();
            const name = document.getElementById('modalServerName').value.trim();
            const phone = document.getElementById('modalServerPhone').value.trim();
            const license = document.getElementById('modalLicenseNumber').value.trim();
            const areas = document.getElementById('modalServiceAreas').value.trim();
            
            return agency || email || name || phone || license || areas;
        }
        
        async function submitAdminRegistration() {
            // Get form values
            const agencyName = document.getElementById('modalAgencyName').value.trim();
            const agencyEmail = document.getElementById('modalAgencyEmail').value.trim();
            const serverName = document.getElementById('modalServerName').value.trim();
            const serverPhone = document.getElementById('modalServerPhone').value.trim();
            const licenseNumber = document.getElementById('modalLicenseNumber').value.trim();
            const serviceAreas = document.getElementById('modalServiceAreas').value.trim();
            
            // Validate required fields
            if (!agencyName || !agencyEmail || !serverName || !serverPhone) {
                uiManager.showNotification('error', 'Please fill in all required fields');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^s@]+@[^s@]+.[^s@]+$/;
            if (!emailRegex.test(agencyEmail)) {
                uiManager.showNotification('error', 'Please enter a valid email address');
                return;
            }
            
            // Save registration data
            const registrationData = {
                agencyName,
                agencyEmail,
                serverName,
                serverPhone,
                licenseNumber,
                serviceAreas,
                registeredAt: new Date().toISOString(),
                address: window.pendingProcessServerAddress,
                note: 'Hybrid contract - auto-assigned server ID upon role grant'
            };
            
            // Store in localStorage
            const serverRegistrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
            serverRegistrations[window.pendingProcessServerAddress] = registrationData;
            localStorage.setItem('serverRegistrations', JSON.stringify(serverRegistrations));
            
            // Show notification about the limitation
            uiManager.showNotification('info', 'Registration data saved locally. Server ID will be auto-assigned when role is granted. Note: Name/agency cannot be updated on-chain with the hybrid contract.');
            
            // Close modal
            closeRegistrationModal();
            
            // Continue with role granting
            await grantProcessServerRole(
                window.pendingProcessServerAddress,
                window.pendingLawEnforcementExempt,
                window.pendingAgencyName
            );
        }
        
                async function grantProcessServerRole(address, lawEnforcementExempt, agencyName) {
            try {
                // Show confirmation modal
                const permissions = lawEnforcementExempt ? 
                    'Serve legal notices, Create NFTs, Access contract functions, Law enforcement fee exemption' :
                    'Serve legal notices, Create NFTs, Access contract functions';
                    
                const confirmed = await showTransactionConfirmation('grantRole', {
                    address: address,
                    roleName: 'Process Server' + (lawEnforcementExempt ? ' (Law Enforcement)' : ''),
                    permissions: permissions
                });
                
                if (!confirmed) {
                    return;
                }
                
                showProcessing('Granting Process Server role...');
                
                const roleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                
                // Grant the role
                await legalContract.grantRole(roleBytes, address).send({
                    feeLimit: 20_000_000,
                    shouldPollResponse: true
                });
                
                // Set law enforcement exemption if requested
                if (lawEnforcementExempt && agencyName) {
                    showProcessing('Setting law enforcement exemption...');
                    // Complete contract uses setFeeExemption instead
                    await legalContract.setFeeExemption(address, true, true).send({
                        feeLimit: 20_000_000,
                        shouldPollResponse: true
                    });
                }
                
                hideProcessing();
                
                let message = 'Process Server role granted';
                if (lawEnforcementExempt) {
                    message += ' with law enforcement exemption (' + agencyName + ')';
                }
                
                showAlert('roleResult', 'success', message);
                
                // Clear form
                document.getElementById('roleAddress').value = '';
                document.getElementById('lawEnforcementExempt').checked = false;
                document.getElementById('lawEnforcementAgencyName').value = '';
                
            } catch (error) {
                hideProcessing();
                console.error('Error:', error);
                showAlert('roleResult', 'error', 'Failed: ' + getErrorMessage(error));
            }
        }

        // Function for regular users to open registration
        function openRegistrationForUser() {
            if (!tronWeb || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect your wallet first');
                return;
            }
            
            // Check if already a process server
            checkIfProcessServer().then(isServer => {
                if (isServer) {
                    uiManager.showNotification('info', 'You are already registered as a process server');
                    return;
                }
                
                // Set the user's own address
                window.pendingProcessServerAddress = tronWeb.defaultAddress.base58;
                window.pendingServiceFeeExempt = false;
                window.pendingFullFeeExempt = false;
                
                // Show the registration modal
                document.getElementById('registrationModal').style.display = 'flex';
            });
        }
        
        async function checkIfProcessServer() {
            if (!legalContract || !tronWeb.defaultAddress) return false;
            
            try {
                const roleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                return await legalContract.hasRole(roleBytes, tronWeb.defaultAddress.base58).call();
            } catch (error) {
                console.error('Error checking process server role:', error);
                return false;
            }
        }
        
        // Update token prefix based on process server status
        async function updateTokenPrefix() {
            if (!legalContract || !tronWeb.defaultAddress) return;
            
            try {
                // Check if user is a process server
                const isProcessServer = await checkIfProcessServer();
                const prefixElement = document.getElementById('tokenPrefix');
                
                // Auto-populate agency name field
                const agencyField = document.getElementById('issuingAgency');
                if (agencyField) {
                    const userAgency = getCurrentUserAgency();
                    if (userAgency) {
                        agencyField.value = userAgency;
                    }
                }
                
                if (isProcessServer) {
                    try {
                        // Get server ID from v5 contract
                        const userAddress = tronWeb.defaultAddress.base58;
                        const serverId = await legalContract.getServerId(userAddress).call();
                        
                        if (serverId && serverId.toString() !== '0') {
                            // Update the token prefix with server ID
                            if (prefixElement) {
                                prefixElement.textContent = `PS#${serverId.toString()}-`;
                            }
                            
                            // Update the server ID display at the top
                            const serverIdDisplay = document.getElementById('serverIdDisplay');
                            const userServerIdSpan = document.getElementById('userServerId');
                            if (serverIdDisplay && userServerIdSpan) {
                                serverIdDisplay.style.display = 'block';
                                userServerIdSpan.textContent = serverId.toString();
                            }
                        } else {
                            // Process server but no ID assigned yet
                            if (prefixElement) {
                                prefixElement.textContent = 'PS#?-';
                            }
                        }
                    } catch (e) {
                        // Fallback if getServerId not available
                        console.log('Server ID not available:', e);
                        if (prefixElement) {
                            prefixElement.textContent = 'PS-';
                        }
                    }
                } else {
                    // Not a process server, use default prefix
                    if (prefixElement) {
                        prefixElement.textContent = 'NOTICE-';
                    }
                }
            } catch (e) {
                console.error('Error getting process server info:', e);
            }
        }
        
        // Update wallet status display
        async function updateWalletStatus() {
            if (!legalContract || !tronWeb.defaultAddress) return;
            
            const roleDetails = document.getElementById('roleCheckDetails');
            const walletRoleElement = document.getElementById('walletRole');
            const feeExemptElement = document.getElementById('feeExemptStatus');
            const statusAddressElement = document.getElementById('statusWalletAddress');
            const walletBalanceElement = document.getElementById('walletBalance');
            
            try {
                const address = tronWeb.defaultAddress.base58;
                let detailsHtml = '<div>';
                
                // Update address
                if (statusAddressElement) {
                    statusAddressElement.textContent = address.substring(0, 10) + '...' + address.substring(address.length - 8);
                }
                
                // Update balance
                if (walletBalanceElement) {
                    const balance = await tronWeb.trx.getBalance(address);
                    walletBalanceElement.textContent = (balance / 1e6).toFixed(2) + ' TRX';
                }
                
                // Check admin role
                const defaultAdminRole = '0x0000000000000000000000000000000000000000000000000000000000000000';
                const adminRoleBytes = tronWeb.sha3('ADMIN_ROLE');
                const hasDefaultAdminRole = await legalContract.hasRole(defaultAdminRole, address).call();
                const hasAdminRole = await legalContract.hasRole(adminRoleBytes, address).call();
                const isAdmin = hasDefaultAdminRole || hasAdminRole;
                
                // Check process server role
                const processServerRoleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                const hasProcessServerRole = await legalContract.hasRole(processServerRoleBytes, address).call();
                
                // Update role display
                if (walletRoleElement) {
                    if (isAdmin) {
                        walletRoleElement.innerHTML = '<span class="badge badge-primary">Admin</span>';
                    } else if (hasProcessServerRole) {
                        walletRoleElement.innerHTML = '<span class="badge badge-success">Process Server</span>';
                    } else {
                        walletRoleElement.innerHTML = '<span class="badge badge-secondary">None</span>';
                    }
                }
                
                // Check and display server ID if process server (v4 contract feature)
                if (hasProcessServerRole) {
                    try {
                        const serverId = await legalContract.getServerId(address).call();
                        const serverIdItem = document.getElementById('serverIdItem');
                        const serverIdElement = document.getElementById('serverId');
                        
                        if (serverIdItem && serverIdElement && serverId > 0) {
                            serverIdItem.style.display = 'block';
                            serverIdElement.innerHTML = `<span class="badge badge-info">#${serverId}</span>`;
                        }
                    } catch (e) {
                        console.log('Server ID not available (may be using older contract)');
                    }
                } else {
                    // Hide server ID if not a process server
                    const serverIdItem = document.getElementById('serverIdItem');
                    if (serverIdItem) {
                        serverIdItem.style.display = 'none';
                    }
                }
                
                // Check fee exemptions
                const isLawEnforcement = await legalContract.serviceFeeExemptions(address).call();
                const agencyName = ''; // Complete contract doesn't track agency names
                
                if (feeExemptElement) {
                    if (isLawEnforcement) {
                        feeExemptElement.innerHTML = `<span class="badge badge-success">Law Enforcement (${agencyName})</span>`;
                    } else {
                        feeExemptElement.innerHTML = '<span class="badge badge-warning">Not Exempt</span>';
                    }
                }
                
                // Build detailed role info
                detailsHtml += `<div><strong>Address:</strong> ${address}</div>`;
                
                if (isAdmin) {
                    detailsHtml += '<div style="margin-top: 0.5rem;"><strong>Admin Role:</strong>  Granted</div>';
                }
                
                if (hasProcessServerRole) {
                    detailsHtml += '<div style="margin-top: 0.5rem;"><strong>Process Server Role:</strong>  Granted</div>';
                    
                    // Check for server ID (v4 contract feature)
                    try {
                        const serverId = await legalContract.getServerId(address).call();
                        
                        if (serverId > 0) {
                            detailsHtml += `<div style="margin-left: 1rem;">Server ID: <strong>#${serverId}</strong></div>`;
                            detailsHtml += `<div style="margin-left: 1rem;">Status: <strong>Active</strong></div>`;
                        } else {
                            detailsHtml += `<div style="margin-left: 1rem;">Role: <strong>Process Server</strong></div>`;
                            detailsHtml += `<div style="margin-left: 1rem;">Status: <strong>Active</strong></div>`;
                        }
                        
                        // Update the server ID display at the top
                        const serverIdDisplay = document.getElementById('serverIdDisplay');
                        const userServerIdSpan = document.getElementById('userServerId');
                        if (serverIdDisplay && userServerIdSpan) {
                            serverIdDisplay.style.display = 'block';
                            userServerIdSpan.textContent = serverId > 0 ? `#${serverId}` : 'PS';
                        }
                    } catch (e) {
                        console.log('Server ID check failed (may be using older contract)');
                        detailsHtml += `<div style="margin-left: 1rem;">Role: <strong>Process Server</strong></div>`;
                        detailsHtml += `<div style="margin-left: 1rem;">Status: <strong>Active</strong></div>`;
                    }
                }
                
                if (isLawEnforcement) {
                    detailsHtml += `<div style="margin-top: 0.5rem;"><strong>Law Enforcement Exemption:</strong>  Active</div>`;
                    detailsHtml += `<div style="margin-left: 1rem;">Agency: ${agencyName}</div>`;
                }
                
                // Check local registration status (for pending registrations)
                const serverRegistrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
                const localReg = serverRegistrations[address];
                if (localReg && localReg.status === 'pending') {
                    detailsHtml += `<div style="margin-top: 0.5rem;"><strong>Pending Registration:</strong></div>`;
                    detailsHtml += `<div style="margin-left: 1rem;">Status: Awaiting approval</div>`;
                }
                
                detailsHtml += '</div>';
                if (roleDetails) {
                    roleDetails.innerHTML = detailsHtml;
                }
                
            } catch (error) {
                console.error('Error updating wallet status:', error);
                if (roleDetails) {
                    roleDetails.innerHTML = '<span style="color: var(--error);">Error checking roles: ' + error.message + '</span>';
                }
            }
        }
        
        // Connect to smart contracts
        async function connectContracts() {
            if (!tronWeb || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect your wallet first');
                return;
            }
            
            const connectBtn = document.getElementById('connectContractBtn');
            const contractStatus = document.getElementById('contractStatus');
            const contractAddress = document.getElementById('contractAddress').value.trim();
            
            if (!contractAddress) {
                uiManager.showNotification('error', 'Please enter the contract address');
                return;
            }
            
            try {
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<span class="loading-spinner"></span> Connecting...';
                
                // Create contract instance with ABI
                legalContract = await tronWeb.contract(CONTRACT_ABI, contractAddress);
                window.legalContract = legalContract; // Make globally accessible
                
                // Test the contract by calling a view function
                const balance = await legalContract.balanceOf(tronWeb.defaultAddress.base58).call();
                
                // Success
                contractStatus.innerHTML = `
                    <div class="alert alert-success" style="margin-top: 1rem;">
                        <i class="fas fa-check-circle"></i>
                        Contract connected successfully! Total notices: ${totalNotices}
                    </div>
                `;
                
                // Update wallet status
                await updateWalletStatus();
                
                // Check user roles
                await checkUserRoles();
                
                // Update token prefix
                await updateTokenPrefix();
                
                // Show wallet status card
                const walletStatusCard = document.getElementById('walletStatusCard');
                if (walletStatusCard) {
                    walletStatusCard.style.display = 'block';
                }
                
                // Update server stats display
                updateServerStats();
                
                // Restore button state
                connectBtn.innerHTML = '<i class="fas fa-check"></i> Connected';
                connectBtn.disabled = false;
                connectBtn.classList.remove('btn-primary');
                connectBtn.classList.add('btn-success');
                
                uiManager.showNotification('success', 'Contract connected successfully');
                
                // Update server stats and recent activities for process servers
                const siteConfig = getSiteConfig();
                if (siteConfig.showServerFeatures) {
                    updateServerStats();
                    
                    // Initialize and refresh unified system for process servers
                    if (window.unifiedSystem) {
                        console.log('Initializing Unified System for process server...');
                        // Set the server address if not already set
                        if (!window.unifiedSystem.serverAddress && tronWeb.defaultAddress) {
                            window.unifiedSystem.serverAddress = tronWeb.defaultAddress.base58;
                            console.log('Server address set to:', window.unifiedSystem.serverAddress);
                        }
                        // Initialize - rendering happens automatically in init now
                        window.unifiedSystem.init().then(() => {
                            console.log('Unified system initialized - cases auto-rendered');
                        }).catch(error => {
                            console.error('Error initializing unified system:', error);
                        });
                    }
                    
                    // Also refresh hybrid activities if available
                    if (window.refreshRecentActivitiesHybrid) {
                        refreshRecentActivitiesHybrid();
                    } else {
                        console.error('refreshRecentActivitiesHybrid not available');
                        refreshRecentActivitiesGrouped();
                    }
                }
                
            } catch (error) {
                console.error('Contract connection error:', error);
                contractStatus.innerHTML = `
                    <div class="alert alert-error" style="margin-top: 1rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to connect: ${error.message}
                    </div>
                `;
                connectBtn.disabled = false;
                connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect Contract';
                connectBtn.classList.remove('btn-success');
                connectBtn.classList.add('btn-primary');
            }
        }
        
        // Submit registration
        async function submitRegistration() {
            const name = document.getElementById('regFullName').value.trim();
            const agency = document.getElementById('regAgency').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const wallet = document.getElementById('regWallet').value.trim();
            
            if (!name || !agency || !email) {
                uiManager.showNotification('error', 'Please fill in all required fields');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                uiManager.showNotification('error', 'Please enter a valid email address');
                return;
            }
            
            const registration = {
                name,
                agency,
                email,
                wallet,
                registeredAt: new Date().toISOString(),
                status: 'pending',
                serverId: generateServerId()
            };
            
            // Save to local storage
            saveServerRegistration(wallet, registration);
            
            // Clear form
            document.getElementById('regFullName').value = '';
            document.getElementById('regAgency').value = '';
            document.getElementById('regEmail').value = '';
            
            // Close modal
            closeRegistrationModal();
            
            uiManager.showNotification('success', 'Registration submitted successfully! Awaiting admin approval.');
            
            // Show registration notice
            const registrationNotice = document.getElementById('registrationNotice');
            if (registrationNotice) {
                registrationNotice.style.display = 'none';
            }
        }
        
        // Audit log management
        let currentAuditPage = 0;
        const auditPageSize = 50;
        let auditDebounceTimer = null;
        
        async function refreshAuditLogs() {
            const statusFilter = document.getElementById('auditStatusFilter')?.value;
            const startDate = document.getElementById('auditStartDate')?.value;
            const endDate = document.getElementById('auditEndDate')?.value;
            const senderFilter = document.getElementById('auditSenderFilter')?.value;
            
            // Fetch statistics
            if (window.auditLogger) {
                const stats = await window.auditLogger.getStatistics({
                    start_date: startDate,
                    end_date: endDate
                });
                
                if (stats.success && stats.stats) {
                    document.getElementById('auditStatistics').style.display = 'block';
                    document.getElementById('totalAttempts').textContent = stats.stats.total_attempts || 0;
                    document.getElementById('successCount').textContent = stats.stats.successful || 0;
                    document.getElementById('failedCount').textContent = stats.stats.failed || 0;
                    document.getElementById('uniqueSenders').textContent = stats.stats.unique_senders || 0;
                }
            }
            
            // Fetch logs
            const filters = {
                status: statusFilter,
                start_date: startDate,
                end_date: endDate,
                sender_address: senderFilter,
                limit: auditPageSize,
                offset: currentAuditPage * auditPageSize
            };
            
            // Remove empty filters
            Object.keys(filters).forEach(key => {
                if (!filters[key]) delete filters[key];
            });
            
            if (window.auditLogger) {
                const result = await window.auditLogger.getLogs(filters);
                
                if (result.success && result.logs) {
                    displayAuditLogs(result.logs, result.total);
                }
            } else {
                document.getElementById('auditLogsContent').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Audit logger not available</h3>
                        <p>Please check your connection</p>
                    </div>
                `;
            }
        }
        
        function displayAuditLogs(logs, total) {
            const container = document.getElementById('auditLogsContent');
            const pagination = document.getElementById('auditPagination');
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <h3>No audit logs found</h3>
                        <p>Adjust your filters or check back later</p>
                    </div>
                `;
                pagination.style.display = 'none';
                return;
            }
            
            // Build table
            let html = `
                <table class="data-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Status</th>
                            <th>Sender</th>
                            <th>Recipient</th>
                            <th>Type</th>
                            <th>Case #</th>
                            <th>Error</th>
                            <th>TX Hash</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            logs.forEach(log => {
                const time = new Date(log.created_at).toLocaleString();
                const statusClass = log.status === 'success' ? 'success' : 'error';
                const statusIcon = log.status === 'success' ? '' : '';
                
                html += `
                    <tr>
                        <td style="font-size: 0.85rem;">${time}</td>
                        <td><span class="badge badge-${statusClass}">${statusIcon} ${log.status}</span></td>
                        <td style="font-size: 0.85rem;" title="${log.sender_address}">${log.sender_address.substring(0, 8)}...</td>
                        <td style="font-size: 0.85rem;" title="${log.recipient_address || 'N/A'}">${log.recipient_address ? log.recipient_address.substring(0, 8) + '...' : 'N/A'}</td>
                        <td>${log.notice_type || 'N/A'}</td>
                        <td>${log.case_number || 'N/A'}</td>
                        <td style="font-size: 0.85rem; color: var(--error);" title="${log.error_message || ''}">${log.error_message ? log.error_message.substring(0, 30) + '...' : ''}</td>
                        <td style="font-size: 0.85rem;">
                            ${log.transaction_hash ? `<a href="${getTxScanUrl()}${log.transaction_hash}" target="_blank">${log.transaction_hash.substring(0, 8)}...</a>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
            
            // Update pagination
            const start = currentAuditPage * auditPageSize + 1;
            const end = Math.min((currentAuditPage + 1) * auditPageSize, total);
            
            document.getElementById('auditShowingStart').textContent = start;
            document.getElementById('auditShowingEnd').textContent = end;
            document.getElementById('auditTotal').textContent = total;
            
            document.getElementById('auditPrevBtn').disabled = currentAuditPage === 0;
            document.getElementById('auditNextBtn').disabled = end >= total;
            
            pagination.style.display = 'block';
        }
        
        function previousAuditPage() {
            if (currentAuditPage > 0) {
                currentAuditPage--;
                refreshAuditLogs();
            }
        }
        
        function nextAuditPage() {
            currentAuditPage++;
            refreshAuditLogs();
        }
        
        function debounceAuditRefresh() {
            clearTimeout(auditDebounceTimer);
            auditDebounceTimer = setTimeout(() => {
                currentAuditPage = 0;
                refreshAuditLogs();
            }, 500);
        }
        
        async function exportAuditLogs() {
            const statusFilter = document.getElementById('auditStatusFilter')?.value;
            const startDate = document.getElementById('auditStartDate')?.value;
            const endDate = document.getElementById('auditEndDate')?.value;
            
            if (window.auditLogger) {
                const result = await window.auditLogger.exportLogs({
                    status: statusFilter,
                    start_date: startDate,
                    end_date: endDate
                });
                
                if (result.success) {
                    uiManager.showNotification('success', 'Audit logs exported successfully');
                } else {
                    uiManager.showNotification('error', 'Failed to export audit logs');
                }
            }
        }
        
        // Refresh pending registrations
        function refreshPendingRegistrations() {
            const container = document.getElementById('pendingRegistrations');
            if (!container) return;
            
            const registrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
            const pendingRegs = Object.entries(registrations)
                .filter(([_, reg]) => reg.status === 'pending')
                .map(([wallet, reg]) => ({ ...reg, wallet }));
            
            if (pendingRegs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No pending registrations</h3>
                        <p>New registrations will appear here</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="registration-list">';
            pendingRegs.forEach(reg => {
                html += `
                    <div class="registration-item">
                        <div class="reg-info">
                            <h4>${reg.name} <span class="badge badge-warning">Pending</span></h4>
                            <p>Agency: ${reg.agency}</p>
                            <p>Email: ${reg.email}</p>
                            <p>Wallet: <code>${reg.wallet}</code></p>
                            <p>Submitted: ${new Date(reg.registeredAt).toLocaleString()}</p>
                        </div>
                        <div class="reg-actions">
                            <button class="btn btn-success btn-small" onclick="approveRegistration('${reg.wallet}')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn btn-danger btn-small" onclick="rejectRegistration('${reg.wallet}')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Approve registration
        async function approveRegistration(walletAddress) {
            if (!legalContract || !isAdmin) {
                uiManager.showNotification('error', 'Not authorized');
                return;
            }
            
            const registrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
            const registration = registrations[walletAddress];
            
            if (!registration) {
                uiManager.showNotification('error', 'Registration not found');
                return;
            }
            
            try {
                showProcessing('Granting process server role...');
                
                // Grant PROCESS_SERVER_ROLE
                const processServerRole = tronWeb.sha3('PROCESS_SERVER_ROLE');
                await legalContract.grantRole(processServerRole, walletAddress).send({
                    feeLimit: 100_000_000,
                    shouldPollResponse: true
                });
                
                // Update registration status
                registration.status = 'approved';
                registration.approvedAt = new Date().toISOString();
                saveServerRegistration(walletAddress, registration);
                
                hideProcessing();
                uiManager.showNotification('success', 'Registration approved and role granted!');
                
                // Refresh the list
                refreshPendingRegistrations();
                
            } catch (error) {
                hideProcessing();
                console.error('Approval error:', error);
                uiManager.showNotification('error', 'Failed to approve: ' + error.message);
            }
        }
        
        // Reject registration
        function rejectRegistration(walletAddress) {
            const registrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
            const registration = registrations[walletAddress];
            
            if (!registration) {
                uiManager.showNotification('error', 'Registration not found');
                return;
            }
            
            registration.status = 'rejected';
            registration.rejectedAt = new Date().toISOString();
            saveServerRegistration(walletAddress, registration);
            
            uiManager.showNotification('info', 'Registration rejected');
            refreshPendingRegistrations();
        }
        
        // Update stats from localStorage
        function updateStatsFromLocalStorage() {
            const statsContainer = document.getElementById('adminStats');
            if (!statsContainer) return;
            
            const registrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
            const allRegs = Object.values(registrations);
            
            const stats = {
                total: allRegs.length,
                pending: allRegs.filter(r => r.status === 'pending').length,
                approved: allRegs.filter(r => r.status === 'approved').length,
                rejected: allRegs.filter(r => r.status === 'rejected').length
            };
            
            statsContainer.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${stats.total}</div>
                        <div class="stat-label">Total Registrations</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.pending}</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.approved}</div>
                        <div class="stat-label">Approved</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.rejected}</div>
                        <div class="stat-label">Rejected</div>
                    </div>
                </div>
            `;
        }
        
        // Grant role function
        async function grantRole() {
            const address = document.getElementById('roleAddress').value.trim();
            const roleSelect = document.getElementById('roleSelect').value;
            
            if (!address) {
                uiManager.showNotification('error', 'Please enter an address');
                return;
            }
            
            if (!tronWeb.isAddress(address)) {
                uiManager.showNotification('error', 'Invalid TRON address');
                return;
            }
            
            if (!roleSelect) {
                uiManager.showNotification('error', 'Please select a role');
                return;
            }
            
            try {
                showProcessing('Granting role...');
                
                let roleBytes;
                let roleName;
                
                switch(roleSelect) {
                    case 'ADMIN_ROLE':
                        roleBytes = tronWeb.sha3('ADMIN_ROLE');
                        roleName = 'Admin';
                        break;
                    case 'PROCESS_SERVER_ROLE':
                        roleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                        roleName = 'Process Server';
                        break;
                    default:
                        throw new Error('Invalid role selected');
                }
                
                // Grant the role
                await legalContract.grantRole(roleBytes, address).send({
                    feeLimit: 100_000_000,
                    shouldPollResponse: true
                });
                
                // If process server, save registration info
                if (roleSelect === 'process_server') {
                    const name = document.getElementById('serverName').value.trim() || 'Unknown';
                    const phone = document.getElementById('serverPhone').value.trim() || '';
                    
                    const registration = {
                        name,
                        phone,
                        wallet: address,
                        status: 'approved',
                        approvedAt: new Date().toISOString(),
                        serverId: generateServerId()
                    };
                    
                    saveServerRegistration(address, registration);
                }
                
                hideProcessing();
                showAlert('roleResult', 'success', `${roleName} role granted to ${address}`);
                
                // Clear form
                document.getElementById('roleAddress').value = '';
                document.getElementById('serverName').value = '';
                document.getElementById('serverPhone').value = '';
                
            } catch (error) {
                hideProcessing();
                console.error('Error granting role:', error);
                showAlert('roleResult', 'error', 'Failed to grant role: ' + getErrorMessage(error));
            }
        }
        
        // Check role function
        async function checkRole() {
            const address = document.getElementById('roleAddress').value.trim();
            
            if (!address) {
                uiManager.showNotification('error', 'Please enter an address');
                return;
            }
            
            if (!tronWeb.isAddress(address)) {
                uiManager.showNotification('error', 'Invalid TRON address');
                return;
            }
            
            try {
                showProcessing('Checking roles...');
                
                const adminRoleBytes = tronWeb.sha3('ADMIN_ROLE');
                const processServerRoleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                const defaultAdminRole = '0x0000000000000000000000000000000000000000000000000000000000000000';
                
                const hasDefaultAdmin = await legalContract.hasRole(defaultAdminRole, address).call();
                const hasAdmin = await legalContract.hasRole(adminRoleBytes, address).call();
                const hasProcessServer = await legalContract.hasRole(processServerRoleBytes, address).call();
                
                let roles = [];
                if (hasDefaultAdmin) roles.push('DEFAULT_ADMIN_ROLE');
                if (hasAdmin) roles.push('ADMIN_ROLE');
                if (hasProcessServer) roles.push('PROCESS_SERVER_ROLE');
                
                hideProcessing();
                
                if (roles.length > 0) {
                    showAlert('roleResult', 'info', `Address ${address} has roles: ${roles.join(', ')}`);
                } else {
                    showAlert('roleResult', 'warning', `Address ${address} has no roles`);
                }
                
            } catch (error) {
                hideProcessing();
                console.error('Error checking role:', error);
                showAlert('roleResult', 'error', 'Failed to check role: ' + error.message);
            }
        }
        
        // Show mint step (for batch operations)
        function showMintStep() {
            document.getElementById('noticeCard').style.display = 'block';
            document.getElementById('batchUploadCard').style.display = 'none';
            document.getElementById('batchProgress').style.display = 'none';
        }
        
        // GitHub config
        const GITHUB_CONFIG = {
            owner: '',
            repo: '',
            token: '',
            path: 'registrations'
        };
        
        // Load GitHub settings
        function loadGitHubSettings() {
            const savedToken = localStorage.getItem('githubToken');
            if (savedToken) {
                GITHUB_CONFIG.token = savedToken;
                document.getElementById('githubToken').value = savedToken;
            }
        }

// Refresh wallet status
async function refreshWalletStatus() {
    const refreshBtn = event.target;
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner loading-spinner"></i> Refreshing...';
    
    try {
        await updateWalletStatus();
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Status';
    } catch (error) {
        console.error('Error refreshing status:', error);
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Status';
    } finally {
        refreshBtn.disabled = false;
    }
}

// Check user roles
async function checkUserRoles() {
    if (!legalContract || !tronWeb.defaultAddress) return;
    
    try {
                // Check DEFAULT_ADMIN_ROLE (0x00) first, then ADMIN_ROLE
                const defaultAdminRole = '0x0000000000000000000000000000000000000000000000000000000000000000';
                const adminRoleBytes = tronWeb.sha3('ADMIN_ROLE');
                const processServerRoleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                
                console.log('=== Checking Admin Roles ===');
                console.log('Current address:', tronWeb.defaultAddress.base58);
                console.log('DEFAULT_ADMIN_ROLE:', defaultAdminRole);
                console.log('ADMIN_ROLE hash:', adminRoleBytes);
                
                // Check if user has DEFAULT_ADMIN_ROLE or ADMIN_ROLE
                const hasDefaultAdminRole = await legalContract.hasRole(defaultAdminRole, tronWeb.defaultAddress.base58).call();
                const hasAdminRole = await legalContract.hasRole(adminRoleBytes, tronWeb.defaultAddress.base58).call();
                isAdmin = hasDefaultAdminRole || hasAdminRole;
                
                console.log('Has DEFAULT_ADMIN_ROLE:', hasDefaultAdminRole);
                console.log('Has ADMIN_ROLE:', hasAdminRole);
                console.log('isAdmin result:', isAdmin);
                
                // Note: getRoleMemberCount and getRoleMember are not available in this implementation
                isProcessServer = await legalContract.hasRole(processServerRoleBytes, tronWeb.defaultAddress.base58).call();
                
                // Update admin tab visibility
                updateAdminTabVisibility();
                
                // Check fee exemption status
                const isLawEnforcement = await legalContract.serviceFeeExemptions(tronWeb.defaultAddress.base58).call();
                const serviceFeeExempt = isLawEnforcement;
                const fullFeeExempt = isLawEnforcement;
                
                // Update fee status display
                const feeStatusElement = document.getElementById('feeExemptStatus');
                if (feeStatusElement) {
                    if (fullFeeExempt) {
                        feeStatusElement.innerHTML = '<span class="badge badge-success">Full Exempt</span>';
                    } else if (serviceFeeExempt) {
                        feeStatusElement.innerHTML = '<span class="badge badge-primary">Service Fee Exempt</span>';
                    } else {
                        feeStatusElement.innerHTML = '<span class="badge badge-warning">Not Exempt</span>';
                    }
                }
                
                // Enable admin-only buttons if user is admin
                const updateFeeBtn = document.getElementById('updateFeeBtn');
                const updateFeeCollectorBtn = document.getElementById('updateFeeCollectorBtn');
                if (updateFeeBtn) updateFeeBtn.disabled = !isAdmin;
                if (updateFeeCollectorBtn) updateFeeCollectorBtn.disabled = !isAdmin;
                
                // Update UI based on roles
                const registrationNotice = document.getElementById('registrationNotice');
                if (registrationNotice) {
                    if (!isProcessServer && !isAdmin) {
                        registrationNotice.style.display = 'flex';
                    } else {
                        registrationNotice.style.display = 'none';
                    }
                }
                
                // Show server ID if assigned
                if (isProcessServer || isAdmin) {
                    const userServerId = document.getElementById('userServerId');
                    const serverIdDisplay = document.getElementById('serverIdDisplay');
                    
                    // Get server ID from registration data
                    const serverData = serverRegistrations[tronWeb.defaultAddress.base58];
                    if (serverData && serverData.serverId) {
                        if (userServerId) userServerId.textContent = serverData.serverId.split('-').pop();
                    } else {
                        if (userServerId) userServerId.textContent = '0000';
                    }
                    
                    if (serverIdDisplay) serverIdDisplay.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error checking roles:', error);
            }
        }

        // Global variable to store current transaction data for receipt
        let currentTransactionData = null;

        // Transaction modal
        function showTxModal(txHash, message, details = '', ipfsData = null) {
            const modal = document.getElementById('txModal');
            const txHashElement = document.getElementById('txHash');
            const txMessage = document.getElementById('txMessage');
            const txLink = document.getElementById('txLink');
            const txDetails = document.getElementById('txDetails');
            
            txMessage.textContent = message || 'Your transaction has been successfully confirmed!';
            txHashElement.textContent = txHash;
            
            // Store transaction data for receipt export
            currentTransactionData = {
                txHash: txHash,
                message: message,
                timestamp: new Date().toISOString(),
                details: details,
                ipfsData: ipfsData,
                network: document.getElementById('networkName')?.textContent || 'Unknown'
            };
            
            // Build enhanced details with IPFS info if available
            let enhancedDetails = details;
            if (ipfsData && ipfsData.ipfsHash) {
                const ipfsPreview = `
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <h4 style="margin-bottom: 0.75rem; color: var(--text-primary);">NFT Document</h4>
                        ${ipfsData.imageUrl ? `
                            <div style="margin-bottom: 1rem;">
                                <img src="${ipfsData.imageUrl}" 
                                     style="max-width: 100%; max-height: 300px; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                     onclick="window.open('${ipfsData.imageUrl}', '_blank')" 
                                     title="Click to view full size" />
                            </div>
                        ` : ''}
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                            <a href="https://gateway.pinata.cloud/ipfs/${ipfsData.ipfsHash}" target="_blank" class="btn btn-secondary btn-small">
                                <i class="fas fa-image"></i> View on Pinata
                            </a>
                            <a href="https://ipfs.io/ipfs/${ipfsData.ipfsHash}" target="_blank" class="btn btn-secondary btn-small">
                                <i class="fas fa-globe"></i> View on IPFS.io
                            </a>
                        </div>
                        <div class="token-detail">
                            <span>IPFS Hash:</span>
                            <span style="font-family: monospace; font-size: 0.875rem;">${ipfsData.ipfsHash}</span>
                        </div>
                    </div>
                `;
                enhancedDetails = details + ipfsPreview;
            }
            
            // Add contract address link if available
            const contractAddressField = document.getElementById('contractAddress');
            const contractAddress = contractAddressField ? contractAddressField.value : null;
            if (contractAddress) {
                const contractLink = `
                    <div style="margin-top: 0.75rem;">
                        <div class="token-detail">
                            <span>Contract:</span>
                            <span>
                                <a href="${network.includes('Nile') ? 'https://nile.tronscan.org/#/contract/' : 'https://tronscan.org/#/contract/'}${contractAddress}" target="_blank" style="color: var(--accent-blue); text-decoration: none;">
                                    ${contractAddress.substring(0, 10)}...${contractAddress.substring(contractAddress.length - 8)}
                                    <i class="fas fa-external-link-alt" style="font-size: 0.75rem; margin-left: 0.25rem;"></i>
                                </a>
                            </span>
                        </div>
                    </div>
                `;
                enhancedDetails += contractLink;
            }
            
            txDetails.innerHTML = enhancedDetails;
            
            // Get network for Tronscan link
            const network = document.getElementById('networkName').textContent;
            let tronscanUrl = 'https://tronscan.org/#/transaction/';
            
            if (network.includes('Nile')) {
                tronscanUrl = 'https://nile.tronscan.org/#/transaction/';
            } else if (network.includes('Shasta')) {
                tronscanUrl = 'https://shasta.tronscan.org/#/transaction/';
            }
            
            txLink.href = tronscanUrl + txHash;
            modal.style.display = 'block';
        }

        function copyTxHash() {
            const txHashElement = document.getElementById('txHash');
            const txHash = txHashElement.textContent;
            
            navigator.clipboard.writeText(txHash).then(() => {
                uiManager.showNotification('success', 'Transaction hash copied to clipboard');
            }).catch(err => {
                console.error('Failed to copy:', err);
                uiManager.showNotification('error', 'Failed to copy transaction hash');
            });
        }

        // Helper function to get contract explorer URL
        function getContractScanUrl(address) {
            if (!address) {
                const contractAddressField = document.getElementById('contractAddress');
                address = contractAddressField ? contractAddressField.value : null;
            }
            const network = document.getElementById('networkName')?.textContent || 'Mainnet';
            let explorerUrl = 'https://tronscan.org';
            
            if (network.includes('Nile')) {
                explorerUrl = 'https://nile.tronscan.org';
            } else if (network.includes('Shasta')) {
                explorerUrl = 'https://shasta.tronscan.org';
            }
            
            return `${explorerUrl}/#/contract/${address}`;
        }

        function viewContractOnTronscan(type) {
            let address;
            if (type === 'legal') {
                address = document.getElementById('contractAddress').value;
            }
            
            if (!address) {
                uiManager.showNotification('error', 'No contract address available');
                return;
            }
            
            const config = CHAIN_CONFIG[currentChainType][currentNetwork];
            let explorerUrl;
            
            if (currentChainType === 'tron') {
                explorerUrl = `${config.explorerUrl}/#/contract/${address}`;
            } else {
                explorerUrl = `${config.explorerUrl}/address/${address}`;
            }
            
            window.open(explorerUrl, '_blank');
        }

        function viewOnTronscan(type, id) {
            const network = document.getElementById('networkName').textContent;
            let tronscanUrl;
            
            if (type === 'notice') {
                const contractAddress = document.getElementById('contractAddress').value;
                
                if (network.includes('Nile')) {
                    tronscanUrl = `https://nile.tronscan.org/#/token721/${contractAddress}/token/${id}`;
                } else if (network.includes('Shasta')) {
                    tronscanUrl = `https://shasta.tronscan.org/#/token721/${contractAddress}/token/${id}`;
                } else {
                    tronscanUrl = `https://tronscan.org/#/token721/${contractAddress}/token/${id}`;
                }
            } else {
                if (network.includes('Nile')) {
                    tronscanUrl = `https://nile.tronscan.org/#/transaction/${id}`;
                } else if (network.includes('Shasta')) {
                    tronscanUrl = `https://shasta.tronscan.org/#/transaction/${id}`;
                } else {
                    tronscanUrl = `https://tronscan.org/#/transaction/${id}`;
                }
            }
            
            window.open(tronscanUrl, '_blank');
        }

        function viewOnIPFS(ipfsHash) {
            // Use a public IPFS gateway
            const ipfsUrl = `https://ipfs.io/ipfs/${ipfsHash}`;
            window.open(ipfsUrl, '_blank');
        }

        // Track served notice in backend
        async function trackServedNotice(noticeData) {
            if (!window.BACKEND_API_URL) {
                return; // Backend not configured
            }
            
            try {
                const response = await fetch(`${window.BACKEND_API_URL}/api/notices/served`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        noticeId: noticeData.noticeId || noticeData.alertId,
                        alertId: noticeData.alertId,
                        documentId: noticeData.documentId,
                        serverAddress: tronWeb.defaultAddress.base58,
                        recipientAddress: noticeData.recipient,
                        noticeType: noticeData.noticeType || 'Legal Notice',
                        issuingAgency: noticeData.issuingAgency || '',
                        caseNumber: noticeData.caseNumber || '',
                        documentHash: noticeData.documentHash || '',
                        ipfsHash: noticeData.ipfsHash || '',
                        hasDocument: noticeData.hasDocument || false
                    })
                });
                
                if (response.ok) {
                    console.log('Notice tracked in backend successfully');
                } else {
                    console.error('Backend tracking response error:', response.status);
                }
            } catch (error) {
                console.error('Failed to track served notice in backend:', error);
                // Don't fail the notice serving if backend tracking fails
            }
        }
        
        // Track wallet connection with IP (only for BlockServed)
        async function trackWalletConnection(walletAddress, eventType = 'wallet_connected') {
            // Only track connections from BlockServed site
            const siteConfig = getSiteConfig();
            if (!siteConfig.isBlockServed) {
                return; // Don't track connections from process server site
            }
            
            if (!window.BACKEND_API_URL) {
                return; // Backend not configured
            }
            
            try {
                // Capture IP and device data
                const ipData = await captureIPData();
                
                // Send to backend
                const response = await fetch(`${window.BACKEND_API_URL}/api/wallet-connections`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        walletAddress: walletAddress,
                        eventType: eventType,
                        ipAddress: ipData.ip,
                        location: {
                            country: ipData.country,
                            region: ipData.region,
                            city: ipData.city,
                            lat: ipData.lat,
                            lon: ipData.lon
                        },
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString(),
                        site: window.location.hostname.includes('blockserved') ? 'blockserved' : 'theblockservice'
                    })
                });
                
                if (response.ok) {
                    console.log(`Wallet ${eventType} tracked with IP: ${ipData.ip}`);
                    
                    // Check if this wallet has any pending notices
                    await checkWalletForPendingNotices(walletAddress);
                } else {
                    console.error('Failed to track wallet connection:', response.status);
                }
            } catch (error) {
                console.error('Error tracking wallet connection:', error);
            }
        }
        
        // Check if connected wallet has pending notices
        async function checkWalletForPendingNotices(walletAddress) {
            if (!legalContract) return;
            
            try {
                // Check if this wallet has been served any notices
                const recipientNotices = await getRecipientNoticeIds(walletAddress);
                
                if (recipientNotices.length > 0) {
                    console.log(`Wallet ${walletAddress} has ${recipientNotices.length} notices`);
                    
                    // Log this discovery
                    if (window.BACKEND_API_URL) {
                        await fetch(`${window.BACKEND_API_URL}/api/wallet-connections/notices-found`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                walletAddress: walletAddress,
                                noticeIds: recipientNotices,
                                timestamp: new Date().toISOString()
                            })
                        });
                    }
                    
                    // Show notification on BlockServed
                    const siteConfig = getSiteConfig();
                    if (siteConfig.isBlockServed) {
                        uiManager.showNotification('warning', `You have ${recipientNotices.length} legal notice${recipientNotices.length > 1 ? 's' : ''} requiring attention`);
                    }
                }
            } catch (error) {
                console.error('Error checking wallet for notices:', error);
            }
        }
        
        // Recent activity functions (deprecated - kept for compatibility)
        function addRecentActivity(type, description, details = {}) {
            // This function is deprecated but kept for compatibility
            // The home page now shows server stats instead of recent activity
        }
        
        // Utility function to add delay
        async function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Retry function for rate-limited API calls
        async function retryWithDelay(fn, maxRetries = 3, delayMs = 2000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (error.toString().includes('429') || (error.message && error.message.includes('429'))) {
                        // Exponential backoff: 2s, 4s, 6s
                        const waitTime = delayMs * (i + 1);
                        console.log(`Rate limited, waiting ${waitTime}ms before retry ${i + 1}/${maxRetries}`);
                        await delay(waitTime);
                    } else {
                        throw error;
                    }
                }
            }
            throw new Error('Max retries exceeded');
        }

        async function updateServerStats(forceBlockchain = false) {
            if (!legalContract || !tronWeb || !tronWeb.defaultAddress) {
                return;
            }
            
            try {
                const userAddress = tronWeb.defaultAddress.base58;
                
                console.log('=== Server Stats Update (Hybrid) ===');
                console.log('Current connected address:', userAddress);
                console.log('Force blockchain:', forceBlockchain);
                
                // Try to get server ID
                try {
                    const serverId = await legalContract.getServerId(userAddress).call();
                    console.log('Server ID:', serverId.toString());
                } catch (e) {
                    console.log('Could not get server ID:', e);
                }
                
                // Show loading state in stats
                document.getElementById('totalServedStat').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                document.getElementById('acceptedStat').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                document.getElementById('pendingStat').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                document.getElementById('successRateStat').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                // Use hybrid data service if available
                let myNotices = [];
                let totalServed = 0;
                let accepted = 0;
                let pending = 0;
                
                if (window.hybridDataService) {
                    // Use hybrid service for better performance
                    const stats = await window.hybridDataService.getServerStats(userAddress, forceBlockchain);
                    totalServed = stats.totalServed;
                    accepted = stats.acknowledged;
                    pending = stats.pending;
                    
                    // Update UI with source indicator
                    const sourceIndicator = stats.verified 
                        ? ' <span class="badge badge-success" style="font-size: 0.7rem;"><i class="fas fa-check-circle"></i> Verified</span>'
                        : stats.source === 'backend'
                        ? ' <span class="badge badge-info" style="font-size: 0.7rem;"><i class="fas fa-database"></i> Cached</span>'
                        : ' <span class="badge badge-primary" style="font-size: 0.7rem;"><i class="fas fa-link"></i> Blockchain</span>';
                    
                    // Add source indicator to stats header
                    const statsHeader = document.querySelector('.server-stats h3');
                    if (statsHeader && !statsHeader.querySelector('.badge')) {
                        statsHeader.innerHTML = 'Process Server Statistics' + sourceIndicator;
                    }
                } else {
                    // Fallback to direct blockchain query
                    myNotices = await getServedNoticesFromBlockchain(userAddress, 1000);
                    totalServed = myNotices.length;
                    
                    // Check acceptance status for each notice
                    for (const noticeData of myNotices) {
                        try {
                            let isAccepted = false;
                        
                        // First try direct contract state check (more reliable)
                        try {
                            console.log(`Checking acceptance for notice ${noticeData.noticeId}...`);
                            
                            // Check alert notices for acknowledgment status (v5 contract uses this)
                            const alertData = await retryWithDelay(async () => {
                                return await legalContract.alertNotices(noticeData.noticeId).call();
                            });
                            console.log(`Alert data for ${noticeData.noticeId}:`, alertData);
                            
                            // alertNotices structure: [recipient, server, documentId, timestamp, acknowledged, ...]
                            if (alertData && Array.isArray(alertData) && alertData.length > 4) {
                                const acknowledgedStatus = alertData[4]; // Index 4 is acknowledged field
                                console.log(`Notice ${noticeData.noticeId} acknowledged status:`, acknowledgedStatus);
                                
                                if (acknowledgedStatus === true || acknowledgedStatus === 'true' || acknowledgedStatus === 1) {
                                    console.log(`Notice ${noticeData.noticeId} is acknowledged`);
                                    isAccepted = true;
                                    accepted++;
                                } else {
                                    // Check document notices as fallback
                                    const docData = await retryWithDelay(async () => {
                                        return await legalContract.documentNotices(noticeData.noticeId).call();
                                    });
                                    console.log(`Document data for ${noticeData.noticeId}:`, docData);
                                    
                                    // documentNotices structure: [documentId, server, recipient, ipfsHash, accepted]
                                    if (docData && Array.isArray(docData) && docData.length > 4) {
                                        const acceptedStatus = docData[4]; // Index 4 is accepted field
                                        console.log(`Notice ${noticeData.noticeId} accepted status in documents:`, acceptedStatus);
                                        
                                        if (acceptedStatus === true || acceptedStatus === 'true' || acceptedStatus === 1) {
                                            console.log(`Notice ${noticeData.noticeId} is accepted in documentNotices`);
                                            isAccepted = true;
                                            accepted++;
                                        } else {
                                            console.log(`Notice ${noticeData.noticeId} is still pending`);
                                            pending++;
                                        }
                                    } else {
                                        console.log(`Notice ${noticeData.noticeId} is still pending`);
                                        pending++;
                                    }
                                }
                            } else {
                                console.log(`Notice ${noticeData.noticeId} has no data or is pending`);
                                pending++;
                            }
                        } catch (contractErr) {
                            console.error(`Error checking contract state for notice ${noticeData.noticeId}:`, contractErr.toString());
                            
                            // Try event query as fallback
                            try {
                                const acceptanceEvents = await tronWeb.event.getEventsByContractAddress(
                                    CONTRACT_ADDRESS,
                                    {
                                        eventName: 'NoticeAccepted',
                                        onlyConfirmed: true,
                                        filters: {
                                            alertId: noticeData.noticeId
                                        },
                                        fingerprint: ''
                                    }
                                );
                                
                                if (acceptanceEvents && acceptanceEvents.data && acceptanceEvents.data.length > 0) {
                                    console.log(`Found NoticeAccepted event for ${noticeData.noticeId}`);
                                    accepted++;
                                } else {
                                    pending++;
                                }
                            } catch (eventErr) {
                                console.log(`Could not query events for notice ${noticeData.noticeId}:`, eventErr.toString());
                                pending++;
                            }
                        }
                    } catch (err) {
                        console.error('Error checking notice acceptance:', err);
                        pending++;
                    }
                }
                }
                
                // Calculate success rate
                const successRate = totalServed > 0 ? Math.round((accepted / totalServed) * 100) : 0;
                
                // Update the display
                document.getElementById('totalServedStat').textContent = totalServed;
                document.getElementById('acceptedStat').textContent = accepted;
                document.getElementById('pendingStat').textContent = pending;
                document.getElementById('successRateStat').textContent = successRate + '%';
                
                // Cache stats to localStorage for offline viewing
                const stats = {
                    totalServed,
                    accepted,
                    pending,
                    successRate,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem(`serverStats_${userAddress}`, JSON.stringify(stats));
                
            } catch (error) {
                console.error('Error updating server stats:', error);
                
                // Try to get stats from backend database first
                try {
                    if (window.BACKEND_API_URL) {
                        const response = await fetch(`${window.BACKEND_API_URL}/api/servers/${tronWeb.defaultAddress.base58}/notices?limit=1000`);
                        if (response.ok) {
                            const data = await response.json();
                            console.log('Got server stats from backend:', data);
                            
                            if (data.notices && Array.isArray(data.notices)) {
                                const totalServed = data.notices.length;
                                const accepted = data.notices.filter(n => n.accepted).length;
                                const pending = totalServed - accepted;
                                const successRate = totalServed > 0 ? Math.round((accepted / totalServed) * 100) : 0;
                                
                                // Update display with backend data
                                document.getElementById('totalServedStat').textContent = totalServed;
                                document.getElementById('acceptedStat').textContent = accepted;
                                document.getElementById('pendingStat').textContent = pending;
                                document.getElementById('successRateStat').textContent = successRate + '%';
                                return; // Exit early since we got backend data
                            }
                        }
                    }
                } catch (backendError) {
                    console.log('Backend stats unavailable:', backendError.message);
                }
                
                // If backend fails, try cached stats only if they're recent (within 5 minutes)
                try {
                    const cachedStats = JSON.parse(localStorage.getItem(`serverStats_${tronWeb.defaultAddress.base58}`) || '{}');
                    const cacheAge = cachedStats.lastUpdated ? (Date.now() - new Date(cachedStats.lastUpdated).getTime()) : Infinity;
                    const fiveMinutes = 5 * 60 * 1000;
                    
                    if (cachedStats.lastUpdated && cacheAge < fiveMinutes) {
                        console.log('Using recent cached stats (age:', Math.round(cacheAge/1000), 'seconds)');
                        document.getElementById('totalServedStat').textContent = cachedStats.totalServed || 0;
                        document.getElementById('acceptedStat').textContent = cachedStats.accepted || 0;
                        document.getElementById('pendingStat').textContent = cachedStats.pending || 0;
                        document.getElementById('successRateStat').textContent = (cachedStats.successRate || 0) + '%';
                    } else {
                        console.log('Cached stats too old or missing, showing loading state');
                        // Show loading state instead of stale data
                        document.getElementById('totalServedStat').innerHTML = '<i class="fas fa-sync fa-spin" title="Loading..."></i>';
                        document.getElementById('acceptedStat').innerHTML = '<i class="fas fa-sync fa-spin" title="Loading..."></i>';
                        document.getElementById('pendingStat').innerHTML = '<i class="fas fa-sync fa-spin" title="Loading..."></i>';
                        document.getElementById('successRateStat').innerHTML = '<i class="fas fa-sync fa-spin" title="Loading..."></i>';
                    }
                } catch (e) {
                    console.error('Error loading cached stats:', e);
                    // Show loading state
                    document.getElementById('totalServedStat').innerHTML = '<i class="fas fa-sync fa-spin" title="Loading..."></i>';
                    document.getElementById('acceptedStat').innerHTML = '<i class="fas fa-sync fa-spin" title="Loading..."></i>';
                    document.getElementById('pendingStat').innerHTML = '<i class="fas fa-sync fa-spin" title="Loading..."></i>';
                    document.getElementById('successRateStat').innerHTML = '<i class="fas fa-sync fa-spin" title="Loading..."></i>';
                }
            }
        }

        async function updateRecentActivityDisplay() {
            const activityDiv = document.getElementById('recentActivityContent');
            
            if (!legalContract || !tronWeb || !tronWeb.defaultAddress) {
                activityDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard"></i>
                        <h3>Connect wallet to view activity</h3>
                        <p>Your recent notices will appear here</p>
                    </div>
                `;
                return;
            }
            
            try {
                // Show loading state
                activityDiv.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading recent notices...</div>';
                
                // Get notices from contract
                const userAddress = tronWeb.defaultAddress.base58;
                let noticeIds = [];
                
                // Try to get server notices if user is a process server
                try {
                    const hasServerRole = await legalContract.hasRole(tronWeb.sha3('PROCESS_SERVER_ROLE'), userAddress).call();
                    if (hasServerRole) {
                        noticeIds = await legalContract.getServerNotices(userAddress).call();
                    }
                } catch (e) {
                    console.log('Error checking server notices:', e);
                }
                
                // If no server notices, check user notices
                if (!noticeIds || noticeIds.length === 0) {
                    try {
                        noticeIds = await legalContract.getUserNotices(userAddress).call();
                    } catch (e) {
                        console.log('Error checking user notices:', e);
                    }
                }
                
                if (!noticeIds || noticeIds.length === 0) {
                    activityDiv.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-clipboard"></i>
                            <h3>No recent activity</h3>
                            <p>Your served notices will appear here</p>
                        </div>
                    `;
                    return;
                }
                
                // Get details for recent notices (max 10)
                const recentNoticeIds = noticeIds.slice(-10).reverse();
                let html = '<div class="token-list">';
                
                for (const noticeId of recentNoticeIds) {
                    try {
                        const notice = await legalContract.notices(noticeId).call();
                        const timeAgo = notice.createdAt ? getTimeAgo(new Date(notice.createdAt * 1000)) : 'Unknown time';
                        
                        html += `
                            <div class="token-item" style="padding: 0.75rem 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <i class="fas fa-file-upload" style="color: var(--accent-blue); font-size: 1.25rem;"></i>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500;">Notice #${noticeId} - ${notice.acknowledged ? 'Accepted' : 'Pending'}</div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            To: ${formatAddress(notice.recipient)}
                                        </div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">${timeAgo}</div>
                                    </div>
                                    <button class="btn btn-small btn-secondary" onclick="auditNotice(${noticeId})">
                                        <i class="fas fa-search"></i> Audit
                                    </button>
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        console.error('Error loading notice', noticeId, e);
                    }
                }
                
                html += '</div>';
                activityDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading recent activity:', error);
                activityDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error loading activity</h3>
                        <p>Unable to fetch recent notices</p>
                    </div>
                `;
            }
        }

        // Query blockchain for acceptance events
        async function checkNoticeAcceptance(noticeId) {
            try {
                const acceptanceEvents = await tronWeb.event.getEventsByContractAddress(
                    CONTRACT_ADDRESS,
                    {
                        eventName: 'NoticeAccepted',
                        onlyConfirmed: true,
                        filters: {
                            alertId: noticeId
                        },
                        fingerprint: ''
                    }
                );
                
                if (acceptanceEvents && acceptanceEvents.data && acceptanceEvents.data.length > 0) {
                    return acceptanceEvents.data[0]; // Return the event data
                }
                return null;
            } catch (error) {
                console.error(`Error checking acceptance for notice ${noticeId}:`, error);
                return null;
            }
        }
        
        // Generate acceptance receipt data
        async function generateAcceptanceReceipt(noticeId, acceptanceEvent) {
            try {
                // Get notice details
                const alertData = await legalContract.alertNotices(noticeId).call();
                const docData = await legalContract.documentNotices(noticeId).call();
                
                // Get IP data from localStorage
                const visitLogs = JSON.parse(localStorage.getItem('noticeVisitLogs') || '{}');
                const ipData = visitLogs[noticeId] ? visitLogs[noticeId][0] : null;
                
                // Get acceptance data from localStorage
                const acceptances = JSON.parse(localStorage.getItem('noticeAcceptances') || '{}');
                const localAcceptanceData = acceptances[noticeId];
                
                // Format the receipt data
                const receipt = {
                    // Notice Information
                    noticeId: noticeId,
                    noticeType: alertData?.noticeType || docData?.noticeType || 'Legal Notice',
                    caseNumber: alertData?.caseNumber || docData?.caseNumber || 'N/A',
                    server: alertData?.server || docData?.server,
                    recipient: acceptanceEvent.result.recipient,
                    
                    // Acceptance Information
                    acceptanceTimestamp: new Date(parseInt(acceptanceEvent.result.timestamp) * 1000),
                    acceptanceBlock: acceptanceEvent.block,
                    acceptanceTxHash: acceptanceEvent.transaction,
                    
                    // IP and Location Data
                    ipAddress: ipData?.ip || localAcceptanceData?.ipAddress || 'N/A',
                    location: ipData?.location || localAcceptanceData?.location || {},
                    
                    // Browser Information
                    userAgent: ipData?.userAgent || localAcceptanceData?.userAgent || 'N/A',
                    language: ipData?.language || localAcceptanceData?.language || 'N/A',
                    timezone: ipData?.location?.timezone || localAcceptanceData?.timezone || 'N/A',
                    screenResolution: ipData?.screenResolution || 'N/A',
                    
                    // URLs
                    tronScanUrl: `https://tronscan.org/#/transaction/${acceptanceEvent.transaction}`,
                    contractAddress: CONTRACT_ADDRESS
                };
                
                return receipt;
            } catch (error) {
                console.error('Error generating receipt:', error);
                return null;
            }
        }
        
        // Show acceptance receipt modal (determines if server or recipient)
        async function showAcceptanceReceipt(noticeId, isServer = false) {
            // Check if current user is the server who sent this notice
            if (!isServer && legalContract && tronWeb.defaultAddress) {
                try {
                    const alertData = await legalContract.alertNotices(noticeId).call();
                    if (alertData && alertData[1]) { // server address at index 1
                        const serverAddress = alertData[1].startsWith('41') ? 
                            tronWeb.address.fromHex(alertData[1]) : alertData[1];
                        if (serverAddress.toLowerCase() === tronWeb.defaultAddress.base58.toLowerCase()) {
                            isServer = true;
                        }
                    }
                } catch (e) {
                    console.error('Error checking server status:', e);
                }
            }
            
            if (isServer) {
                return showServerReceipt(noticeId);
            } else {
                return showRecipientReceipt(noticeId);
            }
        }
        
        // Show receipt for process servers (proof of service and acceptance)
        async function showServerReceipt(noticeId) {
            try {
                // Get notice details
                const alertData = await legalContract.alertNotices(noticeId).call();
                const docData = await legalContract.documentNotices(noticeId).call();
                
                // Get preview image from alert data
                const previewImage = alertData && alertData[11] ? alertData[11] : '';
                
                // Check if acknowledged
                const isAcknowledged = alertData && alertData[4] === true;
                
                // Get acceptance event if acknowledged
                let acceptanceEvent = null;
                let acceptanceTime = null;
                let acceptedByAddress = null;
                if (isAcknowledged) {
                    acceptanceEvent = await checkNoticeAcceptance(noticeId);
                    if (acceptanceEvent) {
                        acceptanceTime = new Date(parseInt(acceptanceEvent.result.timestamp) * 1000);
                        // Get the actual recipient who accepted (not the server)
                        acceptedByAddress = acceptanceEvent.result.recipient || alertData[0];
                        if (acceptedByAddress && acceptedByAddress.startsWith('41')) {
                            acceptedByAddress = tronWeb.address.fromHex(acceptedByAddress);
                        }
                    }
                }
                
                // Get service event for transaction hash
                let serviceEvent = null;
                let serviceTxHash = null;
                try {
                    const events = await tronWeb.event.getEventsByContractAddress(CONTRACT_ADDRESS, {
                        eventName: 'NoticeServed',
                        size: 200
                    });
                    
                    // Find the service event for this notice
                    serviceEvent = events.find(e => {
                        return (e.result.alertId && e.result.alertId.toString() === noticeId.toString()) ||
                               (e.result.noticeId && e.result.noticeId.toString() === noticeId.toString());
                    });
                    
                    if (serviceEvent) {
                        serviceTxHash = serviceEvent.transaction;
                    }
                } catch (e) {
                    console.log('Could not find service event:', e);
                }
                
                // Get service time
                const serviceTime = alertData[3] ? new Date(parseInt(alertData[3]) * 1000) : null;
                
                // Check if this is a document notice or alert-only
                const hasDocument = docData && docData[0] && docData[0] !== '';
                const noticeTypeLabel = hasDocument ? 'Document Notice (with attached document)' : 'Alert Notice (notification only)';
                
                // Format addresses
                const serverAddress = alertData[1] ? (alertData[1].startsWith('41') ? 
                    tronWeb.address.fromHex(alertData[1]) : alertData[1]) : 'Unknown';
                const recipientAddress = alertData[0] ? (alertData[0].startsWith('41') ? 
                    tronWeb.address.fromHex(alertData[0]) : alertData[0]) : 'Unknown';
                
                // Create server-specific receipt
                const receiptHTML = `
                    <div class="receipt-container" style="padding: 2rem; font-family: monospace; background: white; color: #1e293b;">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <h2 style="margin: 0; color: #1e293b;">BLOCKCHAIN SERVICE OF PROCESS CERTIFICATE</h2>
                            <p style="color: #64748b; margin: 0.5rem 0;">Proof of Service and Acceptance Record</p>
                        </div>
                        
                        <div style="border: 2px solid #333; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #1e293b;">Service Information</h3>
                            ${previewImage ? `
                                <div style="float: right; margin-left: 1rem; margin-bottom: 1rem;">
                                    <img src="${previewImage}" alt="Document preview" 
                                         style="width: 100px; height: 130px; object-fit: cover; border: 1px solid #333;">
                                    <div style="text-align: center; font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">Document Preview</div>
                                </div>
                            ` : ''}
                            <table style="width: 100%; font-size: 0.9rem; color: #1e293b;">
                                <tr><td style="width: 40%;"><strong>Notice ID:</strong></td><td>${noticeId}</td></tr>
                                <tr><td><strong>Notice Type:</strong></td><td>${noticeTypeLabel}</td></tr>
                                <tr><td><strong>Document Type:</strong></td><td>${alertData[6] || 'Legal Notice'}</td></tr>
                                <tr><td><strong>Case Number:</strong></td><td>${alertData[7] || 'N/A'}</td></tr>
                                <tr><td><strong>Issuing Agency:</strong></td><td>${alertData[5] || 'N/A'}</td></tr>
                                ${hasDocument ? `<tr><td><strong>Document Status:</strong></td><td> Document attached via IPFS</td></tr>` : ''}
                            </table>
                            <div style="clear: both;"></div>
                        </div>
                        
                        <div style="border: 2px solid #333; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #1e293b;">Service Details</h3>
                            <table style="width: 100%; font-size: 0.9rem; color: #1e293b;">
                                <tr><td style="width: 40%;"><strong>Process Server:</strong></td><td style="word-break: break-all;">${serverAddress}</td></tr>
                                <tr><td><strong>Recipient Wallet:</strong></td><td style="word-break: break-all;">${recipientAddress}</td></tr>
                                <tr><td><strong>Date/Time Served:</strong></td><td>${serviceTime ? serviceTime.toLocaleString() : 'N/A'}</td></tr>
                                <tr><td><strong>UTC Time Served:</strong></td><td>${serviceTime ? serviceTime.toUTCString() : 'N/A'}</td></tr>
                                <tr><td><strong>Method:</strong></td><td>Direct NFT Service to Wallet</td></tr>
                            </table>
                        </div>
                        
                        ${isAcknowledged ? `
                        <div style="border: 2px solid #10b981; padding: 1.5rem; margin-bottom: 2rem; background: #f0fdf4;">
                            <h3 style="color: #166534;"> ACCEPTANCE CONFIRMED</h3>
                            <table style="width: 100%; font-size: 0.9rem; color: #1e293b;">
                                <tr><td style="width: 40%;"><strong>Status:</strong></td><td style="color: #166534; font-weight: bold;">ACCEPTED BY RECIPIENT</td></tr>
                                <tr><td><strong>Accepted By:</strong></td><td style="word-break: break-all;">${acceptedByAddress || recipientAddress}</td></tr>
                                <tr><td><strong>Date/Time Accepted:</strong></td><td>${acceptanceTime ? acceptanceTime.toLocaleString() : 'N/A'}</td></tr>
                                <tr><td><strong>UTC Time Accepted:</strong></td><td>${acceptanceTime ? acceptanceTime.toUTCString() : 'N/A'}</td></tr>
                                ${acceptanceEvent ? `
                                    <tr><td><strong>Acceptance TX Hash:</strong></td><td style="word-break: break-all; font-family: monospace; font-size: 0.8rem;">${acceptanceEvent.transaction}</td></tr>
                                    <tr><td><strong>Block Number:</strong></td><td>${acceptanceEvent.block}</td></tr>
                                ` : ''}
                            </table>
                        </div>
                        ` : `
                        <div style="border: 2px solid #f59e0b; padding: 1.5rem; margin-bottom: 2rem; background: #fffbeb;">
                            <h3 style="color: #92400e;"> PENDING ACCEPTANCE</h3>
                            <p style="color: #92400e; margin: 0;">Notice has been served but not yet accepted by recipient.</p>
                        </div>
                        `}
                        
                        <div style="border: 2px solid #333; padding: 1.5rem;">
                            <h3 style="color: #1e293b;">Blockchain Verification</h3>
                            <p style="color: #1e293b;"><strong>Smart Contract:</strong> <code style="font-size: 0.8rem;">${CONTRACT_ADDRESS}</code></p>
                            <p style="color: #1e293b;"><strong>Network:</strong> TRON ${tronWeb.fullNode.host.includes('nile') ? 'Nile Testnet' : 'Mainnet'}</p>
                            <p style="color: #1e293b;"><strong>Alert NFT ID:</strong> ${noticeId}</p>
                            ${serviceTxHash ? `<p style="color: #1e293b;"><strong>Service TX Hash:</strong> <code style="font-size: 0.8rem; word-break: break-all;">${serviceTxHash}</code></p>` : ''}
                            ${acceptanceEvent ? `<p style="color: #1e293b;"><strong>Acceptance TX Hash:</strong> <code style="font-size: 0.8rem; word-break: break-all;">${acceptanceEvent.transaction}</code></p>` : ''}
                            ${docData && docData[0] ? `<p style="color: #1e293b;"><strong>Document IPFS:</strong> <code style="font-size: 0.8rem; word-break: break-all;">${docData[0]}</code></p>` : ''}
                            
                            <div style="margin-top: 1rem;" class="no-print">
                                <a href="${getTronScanUrl()}/#/contract/${CONTRACT_ADDRESS}" 
                                   target="_blank" 
                                   class="btn btn-secondary" 
                                   style="display: inline-block; padding: 0.5rem 1rem; background: #64748b; color: white; text-decoration: none; border-radius: 4px;">
                                    <i class="fas fa-search"></i> Verify on TronScan
                                </a>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; color: #64748b;">
                            <p style="margin: 0.5rem 0;">Generated: ${new Date().toLocaleString()}</p>
                            <p style="margin: 0.5rem 0; font-weight: bold;">This certificate serves as proof of blockchain-verified service of process</p>
                            ${hasDocument ? 
                                '<p style="margin: 0.5rem 0; color: #059669;"><strong> Document Notice:</strong> Legal document was served with this notice</p>' : 
                                '<p style="margin: 0.5rem 0; color: #f59e0b;"><strong> Alert Only:</strong> This was a notification without attached documents</p>'
                            }
                        </div>
                    </div>
                `;
                
                // Show modal
                const modal = document.getElementById('acceptanceReceiptModal');
                document.getElementById('acceptanceReceiptContent').innerHTML = receiptHTML;
                modal.style.display = 'flex';
                
                // Store for export
                window.currentAcceptanceReceipt = {
                    type: 'server',
                    noticeId,
                    serverAddress,
                    recipientAddress,
                    serviceTime,
                    acceptanceTime,
                    isAcknowledged
                };
                window.currentReceiptHTML = receiptHTML;
                
            } catch (error) {
                console.error('Error generating server receipt:', error);
                uiManager.showNotification('error', 'Failed to generate receipt');
            }
        }
        
        // Show receipt for recipients (acceptance confirmation)
        async function showRecipientReceipt(noticeId) {
            try {
                // First check if notice is acknowledged in the contract
                let isAcknowledged = false;
                let alertData = null;
                let docData = null;
                let acceptanceEvent = null;
                
                try {
                    // Check alert notice acknowledgment
                    alertData = await legalContract.alertNotices(noticeId).call();
                    if (alertData && Array.isArray(alertData) && alertData.length > 4) {
                        isAcknowledged = alertData[4] === true;
                    }
                    
                    // Check document notice if exists
                    docData = await legalContract.documentNotices(noticeId).call();
                } catch (e) {
                    console.error('Error checking notice status:', e);
                }
                
                // If not acknowledged in contract, check for acceptance event
                if (!isAcknowledged) {
                    acceptanceEvent = await checkNoticeAcceptance(noticeId);
                    if (!acceptanceEvent) {
                        uiManager.showNotification('error', 'No acceptance found for this notice');
                        return;
                    }
                }
                
                // Generate receipt data based on contract data or event
                let receipt;
                if (isAcknowledged && alertData) {
                    // Get acceptance data from localStorage if available
                    const acceptances = JSON.parse(localStorage.getItem('noticeAcceptances') || '{}');
                    const localAcceptanceData = acceptances[noticeId];
                    
                    // Get IP data from localStorage
                    const visitLogs = JSON.parse(localStorage.getItem('noticeVisitLogs') || '{}');
                    const ipData = visitLogs[noticeId] ? visitLogs[noticeId][0] : null;
                    
                    // Create receipt from contract data
                    receipt = {
                        noticeId: noticeId,
                        noticeType: alertData[6] || 'Legal Notice', // Index 6 is noticeType
                        caseNumber: alertData[7] || 'N/A', // Index 7 is caseNumber
                        server: alertData[1] ? (alertData[1].startsWith('41') ? tronWeb.address.fromHex(alertData[1]) : alertData[1]) : 'Unknown',
                        recipient: alertData[0] ? (alertData[0].startsWith('41') ? tronWeb.address.fromHex(alertData[0]) : alertData[0]) : 'Unknown',
                        timestamp: alertData[3] ? new Date(parseInt(alertData[3]) * 1000).toISOString() : new Date().toISOString(),
                        issuingAgency: alertData[5] || '', // Index 5 is issuingAgency
                        transactionHash: localAcceptanceData?.transactionHash || 'On-chain acknowledgment',
                        hasDocument: docData && docData[0] && docData[0] !== '', // Has encrypted IPFS
                        encryptedIPFS: docData ? docData[0] : null,
                        decryptionKey: docData ? docData[1] : null,
                        
                        // Acceptance Information - use local data or defaults
                        acceptanceTimestamp: localAcceptanceData?.acceptanceTime ? new Date(localAcceptanceData.acceptanceTime) : new Date(),
                        acceptanceBlock: localAcceptanceData?.blockNumber || 'N/A',
                        acceptanceTxHash: localAcceptanceData?.transactionHash || 'On-chain',
                        
                        // IP and Location Data
                        ipAddress: ipData?.ip || localAcceptanceData?.ipAddress || 'N/A',
                        location: ipData?.location || localAcceptanceData?.location || { city: 'Unknown', region: '', country: '' },
                        timezone: localAcceptanceData?.acceptanceTimezone || Intl.DateTimeFormat().resolvedOptions().timeZone,
                        language: localAcceptanceData?.acceptanceLanguage || navigator.language,
                        
                        // Browser and Device Info
                        browserType: localAcceptanceData?.browserType || 'Unknown',
                        deviceType: localAcceptanceData?.deviceType || 'Unknown',
                        screenResolution: localAcceptanceData?.screenResolution || 'Unknown',
                        userAgent: localAcceptanceData?.userAgent || navigator.userAgent,
                        
                        // Blockchain Info
                        contractAddress: legalContract.address,
                        tronScanUrl: `${getTronScanUrl()}/#/contract/${legalContract.address}`
                    };
                } else if (acceptanceEvent) {
                    receipt = await generateAcceptanceReceipt(noticeId, acceptanceEvent);
                    if (!receipt) {
                        uiManager.showNotification('error', 'Failed to generate receipt');
                        return;
                    }
                } else {
                    uiManager.showNotification('error', 'No acceptance data available');
                    return;
                }
                
                // Format the receipt HTML
                const receiptHTML = `
                    <div class="receipt-container" style="padding: 2rem; font-family: monospace; background: white; color: #1e293b;">
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <h2 style="margin: 0; color: #1e293b;">BLOCKCHAIN ACCEPTANCE RECEIPT</h2>
                            <p style="color: #64748b; margin: 0.5rem 0;">Legal Notice Service Confirmation</p>
                        </div>
                        
                        <div style="border: 2px solid #333; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #1e293b;">Notice Information</h3>
                            <table style="width: 100%; font-size: 0.9rem; color: #1e293b;">
                                <tr><td><strong>Notice ID:</strong></td><td>${receipt.noticeId}</td></tr>
                                <tr><td><strong>Type:</strong></td><td>${receipt.noticeType}</td></tr>
                                <tr><td><strong>Case Number:</strong></td><td>${receipt.caseNumber}</td></tr>
                                <tr><td><strong>Server Address:</strong></td><td style="word-break: break-all;">${receipt.server}</td></tr>
                                <tr><td><strong>Recipient Address:</strong></td><td style="word-break: break-all;">${receipt.recipient}</td></tr>
                            </table>
                        </div>
                        
                        <div style="border: 2px solid #333; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #1e293b;">Acceptance Details</h3>
                            <table style="width: 100%; font-size: 0.9rem; color: #1e293b;">
                                <tr><td><strong>Accepted At:</strong></td><td>${receipt.acceptanceTimestamp.toLocaleString()}</td></tr>
                                <tr><td><strong>UTC Time:</strong></td><td>${receipt.acceptanceTimestamp.toUTCString()}</td></tr>
                                <tr><td><strong>Block Number:</strong></td><td>${receipt.acceptanceBlock}</td></tr>
                                <tr><td><strong>Transaction Hash:</strong></td><td style="word-break: break-all;">${receipt.acceptanceTxHash}</td></tr>
                            </table>
                        </div>
                        
                        <div style="border: 2px solid #333; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #1e293b;">Recipient Information</h3>
                            <table style="width: 100%; font-size: 0.9rem; color: #1e293b;">
                                <tr><td><strong>IP Address:</strong></td><td>${receipt.ipAddress}</td></tr>
                                <tr><td><strong>Location:</strong></td><td>${receipt.location.city || 'Unknown'}, ${receipt.location.region || ''} ${receipt.location.country || ''}</td></tr>
                                <tr><td><strong>Timezone:</strong></td><td>${receipt.timezone}</td></tr>
                                <tr><td><strong>Language:</strong></td><td>${receipt.language}</td></tr>
                                <tr><td><strong>Screen Resolution:</strong></td><td>${receipt.screenResolution}</td></tr>
                            </table>
                        </div>
                        
                        <div style="border: 2px solid #333; padding: 1.5rem; margin-bottom: 2rem;">
                            <h3 style="color: #1e293b;">Browser Information</h3>
                            <p style="word-break: break-all; font-size: 0.8rem; margin: 0; color: #1e293b;">${receipt.userAgent}</p>
                        </div>
                        
                        ${receipt.hasDocument && receipt.encryptedIPFS && receipt.decryptionKey ? `
                        <div style="border: 2px solid #10b981; padding: 1.5rem; margin-bottom: 2rem; background: #f0fdf4;">
                            <h3 style="color: #166534;"> Document Access Information</h3>
                            <p style="color: #166534; margin-bottom: 1rem;"><strong>Your document is stored encrypted on IPFS. You can access it independently using the information below:</strong></p>
                            <table style="width: 100%; font-size: 0.9rem; color: #1e293b;">
                                <tr>
                                    <td style="vertical-align: top; padding: 0.5rem 0;"><strong>IPFS Hash:</strong></td>
                                    <td style="word-break: break-all; padding: 0.5rem 0; font-family: monospace; background: white; padding: 0.5rem; border-radius: 4px;">${receipt.encryptedIPFS}</td>
                                </tr>
                                <tr>
                                    <td style="vertical-align: top; padding: 0.5rem 0;"><strong>Decryption Key:</strong></td>
                                    <td style="word-break: break-all; padding: 0.5rem 0; font-family: monospace; background: white; padding: 0.5rem; border-radius: 4px;">${receipt.decryptionKey}</td>
                                </tr>
                            </table>
                            <div style="margin-top: 1rem; padding: 1rem; background: white; border-left: 4px solid #10b981; border-radius: 4px;">
                                <p style="margin: 0 0 0.5rem 0; color: #166534;"><strong>How to access your document independently:</strong></p>
                                <ol style="margin: 0.5rem 0 0 1.5rem; color: #1e293b; font-size: 0.9rem;">
                                    <li>Go to any IPFS gateway (e.g., https://ipfs.io/ipfs/${receipt.encryptedIPFS})</li>
                                    <li>Download the encrypted file</li>
                                    <li>Use any AES decryption tool with the key above</li>
                                    <li>The decrypted content will be your original document</li>
                                </ol>
                                <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.85rem;">
                                    <em>Save this receipt! It contains everything you need to access your document forever, even without our website.</em>
                                </p>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="border: 2px solid #333; padding: 1.5rem;">
                            <h3 style="color: #1e293b;">Blockchain Verification</h3>
                            <p style="color: #1e293b;"><strong>Contract Address:</strong> <code>${receipt.contractAddress}</code></p>
                            <p style="color: #1e293b;"><strong>Network:</strong> TRON ${tronWeb.fullNode.host.includes('nile') ? 'Nile Testnet' : 'Mainnet'}</p>
                            ${receipt.acceptanceTxHash && receipt.acceptanceTxHash !== 'On-chain' && receipt.acceptanceTxHash !== 'N/A' ? `
                                <p style="color: #1e293b;"><strong>Transaction Hash:</strong> <code>${receipt.acceptanceTxHash}</code></p>
                                <p style="margin-top: 1rem;">
                                    <a href="${getTronScanUrl()}/#/transaction/${receipt.acceptanceTxHash}" 
                                       target="_blank" 
                                       class="btn btn-primary" 
                                       style="display: inline-block; padding: 0.5rem 1rem; background: #0891b2; color: white; text-decoration: none; border-radius: 4px;">
                                        <i class="fas fa-external-link-alt"></i> View Transaction on TronScan
                                    </a>
                                </p>
                            ` : ''}
                            <p style="margin-top: ${receipt.acceptanceTxHash && receipt.acceptanceTxHash !== 'On-chain' ? '0.5rem' : '1rem'};">
                                <a href="${getTronScanUrl()}/#/contract/${receipt.contractAddress}" 
                                   target="_blank" 
                                   class="btn btn-secondary" 
                                   style="display: inline-block; padding: 0.5rem 1rem; background: #64748b; color: white; text-decoration: none; border-radius: 4px;">
                                    <i class="fas fa-search"></i> View Contract on TronScan
                                </a>
                            </p>
                        </div>
                        
                        <div style="text-align: center; margin-top: 2rem; color: #64748b;">
                            <p>Generated: ${new Date().toLocaleString()}</p>
                            <p>This receipt confirms blockchain-verified acceptance of legal notice</p>
                        </div>
                    </div>
                `;
                
                // Update modal content
                document.getElementById('acceptanceReceiptContent').innerHTML = receiptHTML;
                
                // Store current receipt for export
                window.currentAcceptanceReceipt = receipt;
                window.currentReceiptHTML = receiptHTML;
                
                // Show modal
                document.getElementById('acceptanceReceiptModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error showing receipt:', error);
                uiManager.showNotification('error', 'Failed to load acceptance receipt');
            }
        }
        
        // Close acceptance receipt modal
        function closeAcceptanceReceiptModal() {
            document.getElementById('acceptanceReceiptModal').style.display = 'none';
        }
        
        // Print acceptance receipt
        function printAcceptanceReceipt() {
            const printWindow = window.open('', '_blank');
            const receipt = window.currentAcceptanceReceipt;
            const isServer = receipt.type === 'server';
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>${isServer ? 'Service Certificate' : 'Acceptance Receipt'} - Notice ${receipt.noticeId}</title>
                    <style>
                        @media print {
                            body { 
                                font-family: 'Courier New', monospace; 
                                padding: 0;
                                margin: 0;
                                font-size: 10pt;
                            }
                            .no-print { display: none !important; }
                            a { color: black !important; text-decoration: none !important; }
                            .receipt-container { padding: 0.5in !important; }
                            h2 { font-size: 14pt !important; }
                            h3 { font-size: 12pt !important; page-break-after: avoid; }
                            table { page-break-inside: avoid; }
                            div { page-break-inside: avoid; }
                            code { 
                                font-family: 'Courier New', monospace !important; 
                                font-size: 8pt !important;
                                background: none !important;
                            }
                        }
                        body { 
                            font-family: 'Courier New', monospace; 
                            padding: 20px;
                            line-height: 1.4;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse;
                        }
                        td { 
                            padding: 4px 8px; 
                            vertical-align: top;
                        }
                        h2, h3 { 
                            margin: 0.5em 0;
                            color: black;
                        }
                        code {
                            font-family: 'Courier New', monospace;
                            background: #f0f0f0;
                            padding: 2px 4px;
                            font-size: 9pt;
                        }
                        .no-print { }
                        @page { 
                            margin: 0.5in;
                            size: letter;
                        }
                    </style>
                </head>
                <body>
                    ${window.currentReceiptHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            
            // Wait for content to load then print
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }
        
        // Export acceptance receipt as HTML
        function exportAcceptanceReceipt() {
            const receipt = window.currentAcceptanceReceipt;
            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Acceptance Receipt - Notice ${receipt.noticeId}</title>
                    <style>
                        body { font-family: monospace; padding: 20px; background: white; color: black; }
                        table { width: 100%; border-collapse: collapse; }
                        td { padding: 4px; }
                        h2, h3 { color: black; }
                        a { color: #0066cc; }
                        .receipt-container { max-width: 800px; margin: 0 auto; }
                    </style>
                </head>
                <body>
                    ${window.currentReceiptHTML}
                </body>
                </html>
            `;
            
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `acceptance_receipt_${receipt.noticeId}_${Date.now()}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Query blockchain for notices served by a specific address (or all if serverAddress is null)
        async function getServedNoticesFromBlockchain(serverAddress, limit = 10) {
            try {
                if (!tronWeb || !legalContract) {
                    console.error('TronWeb or contract not initialized');
                    return [];
                }
                
                console.log('Querying blockchain for notices served by:', serverAddress || 'ALL SERVERS');
                
                // Clear cache if searching for ALL (to find case 34-987654)
                if (serverAddress === 'ALL') {
                    console.log('Clearing cache to search for all notices...');
                    localStorage.removeItem('blockchain_notices_ALL');
                }
                
                // Check cache first
                const cacheKey = `blockchain_notices_${serverAddress}`;
                const cached = localStorage.getItem(cacheKey);
                let skipCache = false;
                
                if (cached) {
                    const parsedCache = JSON.parse(cached);
                    const cacheAge = Date.now() - parsedCache.timestamp;
                    // Use cache if less than 5 minutes old
                    if (cacheAge < 5 * 60 * 1000) {
                        console.log('Using cached blockchain data, notices:', parsedCache.notices.length);
                        // Check if cache might be incomplete (only has notice 0 when we expect more)
                        if (parsedCache.notices.length === 1 && parsedCache.notices[0].noticeId === '0') {
                            console.log('Cache only has notice 0, checking for more notices...');
                            skipCache = true;
                        } else if (parsedCache.notices.length === 2 && !parsedCache.notices.find(n => n.caseNumber === '34-987654')) {
                            console.log('Cache missing case 34-987654, fetching fresh data...');
                            skipCache = true;
                        } else if (parsedCache.notices.length > 0 && !skipCache) {
                            return parsedCache.notices.slice(0, limit);
                        } else {
                            console.log('Cache is empty, fetching fresh data');
                        }
                    }
                }
                
                // Get events from the blockchain
                let events = [];
                let eventsByNoticeId = new Map(); // Map to store events by notice ID
                try {
                    // Get LegalNoticeCreated events
                    const legalNoticeEvents = await retryWithDelay(async () => {
                        return await tronWeb.event.getEventsByContractAddress(
                            CONTRACT_ADDRESS,
                            {
                                eventName: 'LegalNoticeCreated',
                                onlyConfirmed: true,
                                orderBy: 'block_timestamp,desc',
                                limit: 200,
                                fingerprint: '' // Required parameter
                            }
                        );
                    });
                    
                    // Also get NoticeServed events which track document notices
                    const noticeServedEvents = await retryWithDelay(async () => {
                        return await tronWeb.event.getEventsByContractAddress(
                            CONTRACT_ADDRESS,
                            {
                                eventName: 'NoticeServed',
                                onlyConfirmed: true,
                                orderBy: 'block_timestamp,desc',
                                limit: 200,
                                fingerprint: '' // Required parameter
                            }
                        );
                    });
                    
                    // Combine both event types
                    const allEventData = [
                        ...(legalNoticeEvents.data || []),
                        ...(noticeServedEvents.data || [])
                    ];
                    
                    events = allEventData;
                    console.log('Total LegalNoticeCreated events:', (legalNoticeEvents.data || []).length);
                    console.log('Total NoticeServed events:', (noticeServedEvents.data || []).length);
                    console.log('Total combined events:', events.length);
                    
                    // Create a map of events by notice ID for cross-reference
                    events.forEach(event => {
                        if (event.result) {
                            // For v5 contracts, NoticeServed has the correct IDs
                            if (event.event_name === 'NoticeServed') {
                                // Store by alertId for alert notices
                                if (event.result.alertId !== undefined) {
                                    eventsByNoticeId.set(event.result.alertId.toString(), event);
                                }
                                // Store by documentId for document notices
                                if (event.result.documentId !== undefined) {
                                    eventsByNoticeId.set(event.result.documentId.toString(), event);
                                }
                            }
                            // LegalNoticeCreated has noticeId (but it's totalNotices-1 in v5)
                            else if (event.result.noticeId !== undefined) {
                                eventsByNoticeId.set(event.result.noticeId.toString(), event);
                            }
                        }
                    });
                } catch (eventError) {
                    console.error('Error fetching events:', eventError);
                    
                    // If events fail, try to query contract directly
                    try {
                        const totalNotices = await retryWithDelay(async () => {
                            return await legalContract.totalNotices().call();
                        });
                        console.log('Total notices in contract:', totalNotices.toString());
                        
                        // Try to get individual notices
                        const noticePromises = [];
                        // Check more notices to find case 34-987654
                        // Check at least 20 to ensure we find all notices
                        const minToCheck = 20;
                        const reportedTotal = parseInt(totalNotices);
                        const maxToCheck = Math.max(minToCheck, Math.min(reportedTotal, 50)); // Check at least 20, max 50
                        console.log(`Checking notices 0-${maxToCheck-1} (totalNotices reports ${reportedTotal}, but checking at least ${minToCheck})`)
                        
                        // Process in smaller batches to avoid rate limiting
                        const batchSize = 5;
                        // Start from 0 and go up to include all notices
                        for (let i = 0; i < maxToCheck; i++) {
                            noticePromises.push(
                                Promise.all([
                                    retryWithDelay(async () => {
                                        return await legalContract.alertNotices(i).call();
                                    }).catch(() => null),
                                    retryWithDelay(async () => {
                                        return await legalContract.documentNotices(i).call();
                                    }).catch(() => null)
                                ]).then(([alertData, docData]) => ({
                                    noticeId: i,
                                    alertData,
                                    docData
                                }))
                            );
                            
                            // Add delay every batch to avoid rate limits
                            if ((maxToCheck - i) % batchSize === 0 && i !== maxToCheck - 1) {
                                await delay(500); // 500ms delay between batches
                            }
                        }
                        
                        const noticeResults = await Promise.all(noticePromises);
                        
                        // Filter for notices from this server
                        for (const {noticeId, alertData, docData} of noticeResults) {
                            // Skip if both are null (notice doesn't exist)
                            if (!alertData && !docData) {
                                console.log(`Notice ${noticeId} does not exist (both alert and doc data are null)`);
                                continue;
                            }
                            
                            console.log(`Checking notice ${noticeId} - alertData:`, alertData, 'docData:', docData);
                            
                            // Log notice type for clarity
                            if (alertData && !docData) {
                                console.log(`Notice ${noticeId} is an ALERT notice`);
                            } else if (!alertData && docData) {
                                console.log(`Notice ${noticeId} is a DOCUMENT notice`);
                            } else if (alertData && docData) {
                                console.log(`Notice ${noticeId} has BOTH alert and document data`);
                            }
                            
                            // Parse the data (returned as arrays)
                            // alertNotices actual order: [recipient, server, documentId, timestamp, acknowledged, issuingAgency, noticeType, caseNumber, noticeText, legalRights, deadline, tokenURI]
                            // documentNotices: [documentId, server, recipient, ipfsHash, accepted]
                            
                            let serverFromAlert = null;
                            let serverFromDoc = null;
                            let recipientAddress = null;
                            
                            if (alertData && Array.isArray(alertData) && alertData.length > 1) {
                                const serverHex = alertData[1]; // Index 1 is server (sender)
                                // Convert hex address to base58 if needed
                                if (serverHex && serverHex.startsWith('41')) {
                                    try {
                                        serverFromAlert = tronWeb.address.fromHex(serverHex);
                                    } catch (e) {
                                        console.error('Error converting server address:', e);
                                        serverFromAlert = serverHex;
                                    }
                                } else {
                                    serverFromAlert = serverHex;
                                }
                                
                                const recipientHex = alertData[0]; // Index 0 is recipient
                                // Handle BigInt values from contract
                                if (recipientHex) {
                                    // Convert BigInt to hex string if needed
                                    let recipientStr = recipientHex;
                                    if (typeof recipientHex === 'bigint') {
                                        recipientStr = '0x' + recipientHex.toString(16).padStart(40, '0');
                                    }
                                    
                                    if (typeof recipientStr === 'string' && recipientStr.startsWith('41')) {
                                        try {
                                            recipientAddress = tronWeb.address.fromHex(recipientStr);
                                        } catch (e) {
                                            recipientAddress = recipientStr;
                                        }
                                    } else if (typeof recipientStr === 'string' && recipientStr.startsWith('0x')) {
                                        // Handle ethereum-style hex
                                        try {
                                            recipientAddress = tronWeb.address.fromHex('41' + recipientStr.slice(2));
                                        } catch (e) {
                                            recipientAddress = recipientStr;
                                        }
                                    } else {
                                        recipientAddress = recipientStr;
                                    }
                                }
                            }
                            
                            if (docData && Array.isArray(docData) && docData.length > 1) {
                                const serverHex = docData[1]; // Index 1 is server
                                if (serverHex && serverHex.startsWith('41')) {
                                    try {
                                        serverFromDoc = tronWeb.address.fromHex(serverHex);
                                    } catch (e) {
                                        serverFromDoc = serverHex;
                                    }
                                } else if (serverHex) {
                                    // Non-hex server address
                                    serverFromDoc = serverHex;
                                } else {
                                    // Empty server field - this is common for document notices
                                    // We'll rely on event data to determine the server
                                    console.log(`Document notice ${noticeId} has empty server field, will check event data`);
                                    serverFromDoc = null;
                                }
                                
                                if (!recipientAddress) {
                                    const recipientHex = docData[2]; // Index 2 is recipient
                                    // Handle BigInt values from contract
                                    if (recipientHex) {
                                        // Convert BigInt to hex string if needed
                                        let recipientStr = recipientHex;
                                        if (typeof recipientHex === 'bigint') {
                                            recipientStr = '0x' + recipientHex.toString(16).padStart(40, '0');
                                        }
                                        
                                        if (typeof recipientStr === 'string' && recipientStr.startsWith('41')) {
                                            try {
                                                recipientAddress = tronWeb.address.fromHex(recipientStr);
                                            } catch (e) {
                                                recipientAddress = recipientStr;
                                            }
                                        } else if (typeof recipientStr === 'string' && recipientStr.startsWith('0x')) {
                                            // Handle ethereum-style hex
                                            try {
                                                recipientAddress = tronWeb.address.fromHex('41' + recipientStr.slice(2));
                                            } catch (e) {
                                                recipientAddress = recipientStr;
                                            }
                                        } else {
                                            recipientAddress = recipientStr;
                                        }
                                    }
                                }
                            }
                            
                            console.log(`Notice ${noticeId} - serverFromAlert: ${serverFromAlert}, serverFromDoc: ${serverFromDoc}, looking for: ${serverAddress}`);
                            
                            // Also log the raw data for debugging
                            if (alertData && Array.isArray(alertData)) {
                                console.log(`Raw alert data - server (index 1): ${alertData[1]}`);
                            }
                            if (docData && Array.isArray(docData)) {
                                console.log(`Raw doc data - server (index 1): ${docData[1]}`);
                            }
                            
                            // Check if there's an event for this notice ID that has the correct server
                            const eventForNotice = eventsByNoticeId.get(noticeId.toString());
                            let eventServerMatches = false;
                            let txSenderAddress = null;
                            
                            if (eventForNotice) {
                                // For LegalNoticeCreated events, check the server field
                                if (eventForNotice.result && eventForNotice.result.server) {
                                    try {
                                        const eventServer = tronWeb.address.fromHex(eventForNotice.result.server);
                                        eventServerMatches = ensureBase58Address(eventServer).toLowerCase() === ensureBase58Address(serverAddress).toLowerCase();
                                        console.log(`Event data for notice ${noticeId} shows server: ${eventServer}, matches: ${eventServerMatches}`);
                                        
                                        // For document notices with empty server fields, use event server info
                                        if (docData && !serverFromDoc && eventServerMatches) {
                                            console.log(`Using event server data for document notice ${noticeId} since contract storage is empty`);
                                        }
                                    } catch (e) {
                                        console.log('Could not parse event server address');
                                    }
                                }
                                
                                // For document notices with empty server field, get transaction sender
                                if (docData && !serverFromDoc && eventForNotice.transaction) {
                                    try {
                                        console.log(`Document notice ${noticeId} has empty server, checking transaction sender...`);
                                        // Get transaction info to find the actual sender
                                        const txInfo = await retryWithDelay(async () => {
                                            return await tronWeb.trx.getTransaction(eventForNotice.transaction);
                                        });
                                        
                                        if (txInfo && txInfo.raw_data && txInfo.raw_data.contract && txInfo.raw_data.contract[0]) {
                                            const ownerAddress = txInfo.raw_data.contract[0].parameter.value.owner_address;
                                            if (ownerAddress) {
                                                txSenderAddress = tronWeb.address.fromHex('41' + ownerAddress);
                                                const senderMatches = ensureBase58Address(txSenderAddress).toLowerCase() === ensureBase58Address(serverAddress).toLowerCase();
                                                console.log(`Transaction sender for document notice ${noticeId}: ${txSenderAddress}, matches: ${senderMatches}`);
                                                if (senderMatches) {
                                                    eventServerMatches = true;
                                                }
                                            }
                                        }
                                    } catch (txError) {
                                        console.log('Could not get transaction sender:', txError);
                                    }
                                }
                            } else if (docData && !serverFromDoc) {
                                console.log(`Document notice ${noticeId} has empty server field and no corresponding event found`);
                            }
                            
                            // If no serverAddress provided, accept all notices
                            const acceptAllServers = !serverAddress || serverAddress === 'ALL';
                            
                            const isServerAlert = acceptAllServers || (serverFromAlert && 
                                                 ensureBase58Address(serverFromAlert).toLowerCase() === ensureBase58Address(serverAddress).toLowerCase());
                            const isServerDoc = acceptAllServers || (serverFromDoc && 
                                               ensureBase58Address(serverFromDoc).toLowerCase() === ensureBase58Address(serverAddress).toLowerCase());
                            
                            // Log the matching results for debugging
                            console.log(`Notice ${noticeId} server check:
                                - serverFromAlert: ${serverFromAlert} (matches: ${isServerAlert})
                                - serverFromDoc: ${serverFromDoc} (matches: ${isServerDoc})
                                - eventServerMatches: ${eventServerMatches}
                                - Looking for server: ${serverAddress}
                                - Accept all servers: ${acceptAllServers}
                            `);
                            
                            // Check if this notice is from the server (or accept all if no specific server)
                            // Accept notice if EITHER the contract storage OR the event shows this server
                            // This handles the case where contract stores black hole but event has correct server
                            if (acceptAllServers || isServerAlert || isServerDoc || eventServerMatches) {
                                const noticeType = alertData ? 'alert' : 'document';
                                const matchReason = isServerAlert ? 'alert contract data' : 
                                                  isServerDoc ? 'document contract data' : 
                                                  'event data (fallback for empty contract storage)';
                                
                                console.log(`Found ${noticeType} notice ${noticeId} from server ${serverAddress} via ${matchReason}`);
                                
                                events.push({
                                    result: {
                                        noticeId: noticeId.toString(),
                                        server: tronWeb.address.toHex(serverAddress),
                                        recipient: recipientAddress ? tronWeb.address.toHex(recipientAddress) : '0x0',
                                        timestamp: Date.now() / 1000 // Approximate
                                    },
                                    transaction: 'unknown',
                                    block: 0
                                });
                            }
                        }
                        
                        console.log('Found notices via direct query:', events.length);
                        console.log(`=== Notice Discovery Summary ===`);
                        console.log(`Checked notices 0-${maxToCheck-1}`);
                        console.log(`Found ${events.length} notices belonging to ${serverAddress}`);
                        events.forEach(e => {
                            // Convert hex recipient to base58 for display
                            let displayRecipient = e.result.recipient;
                            if (displayRecipient && displayRecipient.startsWith('41') && displayRecipient.length > 40) {
                                try {
                                    displayRecipient = tronWeb.address.fromHex(displayRecipient);
                                } catch (conversionError) {
                                    console.log('Could not convert recipient from hex:', conversionError);
                                }
                            }
                            console.log(`- Notice #${e.result.noticeId}: recipient ${displayRecipient}`);
                        });
                    } catch (contractError) {
                        console.error('Direct contract query also failed:', contractError);
                    }
                }
                
                // Additional fallback: Query all NoticeServed events by this server
                // This is needed when document notices don't store server addresses properly
                try {
                    console.log('Attempting fallback: Querying transaction history for notices served by', serverAddress);
                    
                    // Get recent transactions from this address
                    const txList = await retryWithDelay(async () => {
                        const response = await fetch(`https://api.trongrid.io/v1/accounts/${serverAddress}/transactions?limit=200&only_to=true&only_confirmed=true`);
                        if (!response.ok) throw new Error('Failed to fetch transactions');
                        return await response.json();
                    });
                    
                    if (txList && txList.data) {
                        console.log(`Found ${txList.data.length} transactions to analyze`);
                        
                        // Filter for transactions to our contract
                        const contractTxs = txList.data.filter(tx => {
                            try {
                                if (tx.to === CONTRACT_ADDRESS || 
                                    (tx.raw_data && tx.raw_data.contract && tx.raw_data.contract[0] && 
                                     tx.raw_data.contract[0].parameter && tx.raw_data.contract[0].parameter.value &&
                                     tx.raw_data.contract[0].parameter.value.contract_address === tronWeb.address.toHex(CONTRACT_ADDRESS))) {
                                    return true;
                                }
                                return false;
                            } catch (e) {
                                return false;
                            }
                        });
                        
                        console.log(`Found ${contractTxs.length} transactions to the contract`);
                        
                        // For each transaction, check if it's a serveNotice call
                        for (const tx of contractTxs) {
                            try {
                                if (tx.raw_data && tx.raw_data.contract && tx.raw_data.contract[0] && 
                                    tx.raw_data.contract[0].parameter && tx.raw_data.contract[0].parameter.value &&
                                    tx.raw_data.contract[0].parameter.value.data) {
                                    
                                    // Check if this is a serveNotice function call (function selector)
                                    const data = tx.raw_data.contract[0].parameter.value.data;
                                    // serveNotice function selector would be in the first 8 characters
                                    if (data && data.length > 8) {
                                        console.log(`Transaction ${tx.txID} might be a notice creation`);
                                        // We already have events for these, so this is just additional validation
                                    }
                                }
                            } catch (e) {
                                console.error('Error analyzing transaction:', e);
                            }
                        }
                    }
                } catch (fallbackError) {
                    console.error('Transaction history fallback also failed:', fallbackError);
                }
                
                // Filter events by server address
                const myEvents = events.filter(event => {
                    try {
                        // Different event types have different structures
                        if (event.name === 'LegalNoticeCreated' && event.result.server) {
                            // LegalNoticeCreated event has server field
                            const eventServerAddress = tronWeb.address.fromHex(event.result.server);
                            const matches = ensureBase58Address(eventServerAddress).toLowerCase() === ensureBase58Address(serverAddress).toLowerCase();
                            console.log(`LegalNoticeCreated event - server: ${eventServerAddress}, looking for: ${serverAddress}, matches: ${matches}`);
                            return matches;
                        } else if (event.name === 'NoticeServed') {
                            // NoticeServed events don't have server field, we need to check transaction sender
                            // For now, include all NoticeServed events and filter later when we get contract data
                            console.log(`NoticeServed event found for documentId: ${event.result.documentId}`);
                            return true; // We'll filter these later based on contract data
                        } else if (!event.name && event.result && event.result.server) {
                            // Direct query results don't have a name property
                            // They already have the correct server in the result
                            const eventServerAddress = tronWeb.address.fromHex(event.result.server);
                            const matches = ensureBase58Address(eventServerAddress).toLowerCase() === ensureBase58Address(serverAddress).toLowerCase();
                            console.log(`Direct query event - server: ${eventServerAddress}, looking for: ${serverAddress}, matches: ${matches}`);
                            return matches;
                        }
                        return false;
                    } catch (e) {
                        console.error('Error processing event:', e);
                        return false;
                    }
                });
                
                console.log('Events from this server:', myEvents.length);
                
                // Convert events to notice data and get additional details
                const notices = [];
                // Combine event-based and direct query results, avoiding duplicates
                const processedNoticeIds = new Set();
                const allEvents = [];
                
                // Add events from API first (they have correct server info)
                myEvents.forEach(event => {
                    const noticeId = event.result.noticeId?.toString();
                    if (noticeId && !processedNoticeIds.has(noticeId)) {
                        processedNoticeIds.add(noticeId);
                        allEvents.push(event);
                    }
                });
                
                // Add events from direct query that weren't in API results
                events.forEach(event => {
                    const noticeId = event.result.noticeId?.toString();
                    if (noticeId && !processedNoticeIds.has(noticeId)) {
                        processedNoticeIds.add(noticeId);
                        allEvents.push(event);
                    }
                });
                
                console.log(`Processing ${allEvents.length} unique notices for server ${serverAddress}`);
                
                for (const event of allEvents) {
                    try {
                        // Handle different event types
                        let noticeId;
                        if (event.event_name === 'NoticeServed' || event.name === 'NoticeServed') {
                            // For v5 NoticeServed events, we need to check the actual notice data
                            // Use alertId as the primary notice ID
                            noticeId = event.result.alertId;
                            console.log(`Processing NoticeServed event - alertId: ${event.result.alertId}, documentId: ${event.result.documentId}`);
                        } else {
                            // For LegalNoticeCreated and direct queries
                            noticeId = event.result.noticeId || event.result.alertId || event.noticeId;
                        }
                        
                        // Convert recipient address to base58 format for consistency
                        let recipientAddress = event.result.recipient;
                        if (recipientAddress) {
                            if (recipientAddress.startsWith('T')) {
                                // Already in base58 format
                                recipientAddress = event.result.recipient;
                            } else if (recipientAddress.startsWith('41') && recipientAddress.length > 40) {
                                // Convert from hex to base58
                                try {
                                    recipientAddress = tronWeb.address.fromHex(recipientAddress);
                                } catch (e) {
                                    console.error('Error converting recipient address from hex:', e);
                                    recipientAddress = event.result.recipient; // Keep original if conversion fails
                                }
                            } else {
                                // Unknown format, log warning
                                console.warn('Unknown recipient address format:', recipientAddress);
                            }
                        }
                        
                        console.log(`Processing notice ${noticeId} for recipient ${recipientAddress}`);
                        
                        // Get additional notice data from contract
                        let noticeType = 'Legal Notice';
                        let caseNumber = '';
                        let hasDocument = false;
                        let documentId = null;
                        let alertId = null;
                        
                        // Try to get alert notice data
                        let blockchainTimestamp = null;
                        try {
                            const alertData = await legalContract.alertNotices(noticeId).call();
                            console.log(`Alert data for notice ${noticeId}:`, alertData);
                            
                            // Parse array data: [recipient, server, documentId, timestamp, acknowledged, issuingAgency, noticeType, caseNumber, noticeText, legalRights, deadline, tokenURI]
                            if (alertData && Array.isArray(alertData) && alertData.length > 1 && alertData[1]) {
                                noticeType = alertData[6] || 'Legal Notice'; // Index 6 is noticeType
                                caseNumber = alertData[7] || ''; // Index 7 is caseNumber
                                alertId = noticeId;
                                
                                // Get timestamp from contract (index 3)
                                if (alertData[3]) {
                                    blockchainTimestamp = parseInt(alertData[3]) * 1000; // Convert to milliseconds
                                    console.log(`Got blockchain timestamp for notice ${noticeId}: ${new Date(blockchainTimestamp).toISOString()}`);
                                }
                            }
                        } catch (e) {
                            console.log('No alert data for notice:', noticeId, e);
                        }
                        
                        // Try to get document notice data
                        try {
                            const docData = await legalContract.documentNotices(noticeId).call();
                            console.log(`Document data for notice ${noticeId}:`, docData);
                            
                            // Parse array data: [documentId, server, recipient, ipfsHash, accepted]
                            if (docData && Array.isArray(docData) && docData.length > 1) {
                                // Check if this document belongs to the current server
                                let docServer = null;
                                if (docData[1] && docData[1].startsWith('41')) {
                                    try {
                                        docServer = tronWeb.address.fromHex(docData[1]);
                                    } catch (e) {
                                        docServer = docData[1];
                                    }
                                } else if (docData[1]) {
                                    docServer = docData[1];
                                }
                                
                                // For NoticeServed events without server info, check contract data
                                if (event.name === 'NoticeServed' && docServer) {
                                    // Skip if this document doesn't belong to current server
                                    if (ensureBase58Address(docServer).toLowerCase() !== ensureBase58Address(serverAddress).toLowerCase()) {
                                        console.log(`Skipping document notice ${noticeId} - belongs to ${docServer}, not ${serverAddress}`);
                                        continue;
                                    }
                                }
                                
                                hasDocument = true;
                                documentId = noticeId;
                            }
                        } catch (e) {
                            console.log('No document data for notice:', noticeId, e);
                        }
                        
                        // Extract server address from event (for LegalNoticeCreated events)
                        let serverAddress = null;
                        if (event.result && event.result.server) {
                            try {
                                serverAddress = tronWeb.address.fromHex(event.result.server);
                            } catch (e) {
                                console.log('Could not convert server address:', event.result.server);
                                serverAddress = event.result.server;
                            }
                        }
                        
                        const noticeInfo = {
                            noticeId: noticeId.toString(),
                            recipient: recipientAddress,
                            server: serverAddress, // Add server field
                            noticeType: noticeType,
                            caseNumber: caseNumber,
                            timestamp: blockchainTimestamp || (parseInt(event.result.timestamp) * 1000) || Date.now(),
                            txHash: event.transaction || event.txHash || 'N/A',
                            blockNumber: event.block || event.blockNumber || 0,
                            hasDocument: hasDocument,
                            documentId: documentId,
                            alertId: alertId
                        };
                        
                        console.log('Processed notice:', noticeInfo);
                        notices.push(noticeInfo);
                    } catch (err) {
                        console.error('Error processing event:', err);
                    }
                }
                
                // If we found notices through direct query but events failed, 
                // merge the direct query results with any processed notices
                if (events.length > 0 && notices.length === 0) {
                    console.log('Events found through direct query but not processed, processing them now...');
                    for (const event of events) {
                        try {
                            const noticeId = event.result.noticeId;
                            const recipientAddress = ensureBase58Address(event.result.recipient);
                            
                            // Get timestamp from blockchain for this notice
                            let blockchainTimestamp = null;
                            try {
                                const alertData = await legalContract.alertNotices(noticeId).call();
                                if (alertData && Array.isArray(alertData) && alertData[3]) {
                                    blockchainTimestamp = parseInt(alertData[3]) * 1000; // Convert to milliseconds
                                }
                            } catch (e) {
                                console.log('Could not get alert data for timestamp:', e);
                            }
                            
                            const noticeInfo = {
                                noticeId: noticeId.toString(),
                                recipient: recipientAddress,
                                noticeType: 'Legal Notice',
                                caseNumber: '',
                                timestamp: blockchainTimestamp || (parseInt(event.result.timestamp) * 1000) || Date.now(),
                                txHash: event.transaction || 'N/A',
                                blockNumber: event.block || 0,
                                hasDocument: true,
                                documentId: noticeId,
                                alertId: noticeId
                            };
                            
                            notices.push(noticeInfo);
                        } catch (err) {
                            console.error('Error processing direct query event:', err);
                        }
                    }
                }
                
                // Cache the results only if we have notices
                if (notices.length > 0) {
                    localStorage.setItem(cacheKey, JSON.stringify({
                        notices: notices,
                        timestamp: Date.now()
                    }));
                }
                
                return notices.slice(0, limit);
                
            } catch (error) {
                console.error('Error querying blockchain:', error);
                // Fallback to cached data if available
                const cacheKey = `blockchain_notices_${serverAddress}`;
                const cached = localStorage.getItem(cacheKey);
                if (cached) {
                    const parsedCache = JSON.parse(cached);
                    console.log('Using stale cache due to blockchain error');
                    return parsedCache.notices.slice(0, limit);
                }
                
                // Last resort: use old localStorage format
                const servedNotices = JSON.parse(localStorage.getItem('servedNotices') || '{}');
                return (servedNotices[serverAddress] || []).slice(-limit).reverse();
            }
        }
        
        // New function to refresh recent activities for process servers
        async function refreshRecentActivities(forceRefresh = false) {
            const content = document.getElementById('recentActivitiesContent');
            if (!content) return;
            
            if (!legalContract || !tronWeb || !tronWeb.defaultAddress) {
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard"></i>
                        <h3>Connect wallet to view activity</h3>
                        <p>Your recent notices will appear here</p>
                    </div>
                `;
                return;
            }
            
            try {
                const userAddress = tronWeb.defaultAddress.base58;
                console.log('=== RECENT ACTIVITY DEBUG ===');
                console.log('Current user address:', userAddress);
                
                // Clear cache if force refresh
                if (forceRefresh) {
                    const cacheKey = `blockchain_notices_${userAddress}`;
                    localStorage.removeItem(cacheKey);
                    console.log('Force refresh: cleared cache');
                }
                
                // Show loading while querying
                content.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading recent activity...</div>';
                
                let myNotices = [];
                let backendNotices = [];
                
                // FIRST: Try to get ALL notices from backend (not just for this server)
                if (window.BACKEND_API_URL) {
                    try {
                        // Get notices where user is the server
                        const serverResponse = await fetch(`${window.BACKEND_API_URL}/api/servers/${userAddress}/notices?limit=10`);
                        if (serverResponse.ok) {
                            const serverData = await serverResponse.json();
                            console.log('Backend notices as server:', serverData);
                            if (serverData.notices && Array.isArray(serverData.notices)) {
                                backendNotices = backendNotices.concat(serverData.notices.map(n => ({
                                    ...n,
                                    role: 'server'
                                })));
                            }
                        }
                        
                        // Also try to get any notices from served_notices table
                        const allNoticesResponse = await fetch(`${window.BACKEND_API_URL}/api/notices/recent?limit=10`);
                        if (allNoticesResponse.ok) {
                            const allData = await allNoticesResponse.json();
                            console.log('All recent notices from backend:', allData);
                            if (allData.notices) {
                                backendNotices = backendNotices.concat(allData.notices);
                            }
                        }
                    } catch (backendError) {
                        console.error('Backend fetch error:', backendError);
                    }
                }
                
                // Process backend data into display format
                if (backendNotices.length > 0) {
                    console.log('Using backend data for recent activity:', backendNotices.length, 'notices');
                    
                    // Convert backend format to display format
                    for (const notice of backendNotices) {
                        myNotices.push({
                            noticeId: notice.notice_id || notice.id,
                            recipient: notice.recipient_address || notice.recipient,
                            server: notice.server_address || notice.server,
                            timestamp: new Date(notice.served_at || notice.timestamp).getTime(),
                            accepted: notice.accepted || false,
                            acceptedAt: notice.acceptance_timestamp,
                            viewCount: notice.view_count || 0,
                            role: notice.role || 'server',
                            source: 'backend'
                        });
                    }
                } else {
                    // Fall back to blockchain query
                    console.log('No backend data, querying blockchain...');
                    
                    // Try multiple approaches to find notices
                    // 1. First try v5 contract's getServerNotices function
                    let servedNotices = [];
                    try {
                        if (legalContract.getServerNotices) {
                            console.log('Trying v5 contract getServerNotices...');
                            const noticeIds = await legalContract.getServerNotices(userAddress).call();
                            console.log('getServerNotices returned:', noticeIds);
                            
                            if (noticeIds && noticeIds.length > 0) {
                                for (const noticeId of noticeIds) {
                                    const id = noticeId.toString();
                                    try {
                                        const noticeData = await legalContract.notices(id).call();
                                        if (noticeData) {
                                            // v5 notice structure: [alertId, documentId, server, recipient, timestamp, acknowledged, noticeType, caseNumber]
                                            const alertId = noticeData.alertId || noticeData[0];
                                            const documentId = noticeData.documentId || noticeData[1];
                                            const acknowledged = noticeData.acknowledged || noticeData[5];
                                            
                                            let documentIPFS = '';
                                            let previewImage = '';
                                            let actualRecipient = tronWeb.address.fromHex(noticeData.recipient || noticeData[3]);
                                            
                                            // Get the alert details for preview image
                                            if (alertId && alertId.toString() !== '0') {
                                                try {
                                                    const alertData = await legalContract.alertNotices(alertId).call();
                                                    if (alertData) {
                                                        previewImage = alertData.previewImage || alertData[11] || '';
                                                    }
                                                } catch(e) {
                                                    console.log('Error getting alert details for ID', alertId, e);
                                                }
                                            }
                                            
                                            // Get the actual document details
                                            if (documentId && documentId.toString() !== '0') {
                                                try {
                                                    const docData = await legalContract.documentNotices(documentId).call();
                                                    if (docData) {
                                                        // Document structure: [encryptedIPFS, decryptionKey, authorizedViewer, alertId, isRestricted]
                                                        documentIPFS = docData.encryptedIPFS || docData[0];
                                                        actualRecipient = tronWeb.address.fromHex(docData.authorizedViewer || docData[2]);
                                                    }
                                                } catch(e) {
                                                    console.log('Error getting document details for ID', documentId, e);
                                                }
                                            }
                                            
                                            servedNotices.push({
                                                noticeId: id,
                                                alertId: alertId ? alertId.toString() : '',
                                                documentId: documentId ? documentId.toString() : '',
                                                recipient: actualRecipient,
                                                server: userAddress,
                                                timestamp: Number(noticeData.timestamp || noticeData[4]) * 1000,
                                                acknowledged: acknowledged,
                                                role: 'server',
                                                source: 'contract',
                                                noticeType: noticeData.noticeType || noticeData[6] || 'Legal Notice',
                                                caseNumber: noticeData.caseNumber || noticeData[7] || '',
                                                ipfsHash: documentIPFS,
                                                previewImage: previewImage
                                            });
                                        }
                                    } catch(e) {
                                        console.log('Error getting notice details for ID', id, e);
                                    }
                                }
                            }
                        }
                    } catch(e) {
                        console.log('Error calling getServerNotices, falling back to events:', e);
                    }
                    
                    // 2. If no notices from direct contract call, fall back to blockchain events
                    if (servedNotices.length === 0) {
                        servedNotices = await getServedNoticesFromBlockchain(userAddress, 10);
                    }
                    console.log('Blockchain notices as server:', servedNotices);
                    
                    // 3. Don't check alerts/documents separately as they're already included in notices
                    // This prevents duplicates from showing Alert 1 and Document 2 as separate items
                    const recentNoticeIds = [];
                    console.log('Direct notice query found:', recentNoticeIds);
                    
                    // Combine results
                    myNotices = [...servedNotices, ...recentNoticeIds];
                    
                    // Remove duplicates
                    const uniqueNotices = {};
                    myNotices.forEach(n => {
                        uniqueNotices[n.noticeId] = n;
                    });
                    myNotices = Object.values(uniqueNotices);
                }
                
                console.log('Total notices for display:', myNotices.length);
                
                if (myNotices.length === 0) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-clipboard"></i>
                            <h3>No recent activity</h3>
                            <p>Your served notices will appear here</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="activity-list" style="max-height: 400px; overflow-y: auto;">';
                
                for (const noticeData of myNotices) {
                    try {
                        // Check acceptance status and get IP data
                        let isAccepted = false;
                        let acceptanceData = null;
                        let ipData = null;
                        
                        // Check if notice has been accepted - use the alertId from the notice
                        try {
                            // For v5 contracts, check alertNotices for acknowledgment status
                            // Use the alertId from the notice data, not the noticeId
                            let alertData = null;
                            if (noticeData.alertId) {
                                alertData = await retryWithDelay(async () => {
                                    return await legalContract.alertNotices(noticeData.alertId).call();
                                }, 3, 2000); // 3 retries with 2 second delay
                            }
                            
                            console.log(`Alert data for alert ${noticeData.alertId}:`, alertData);
                            
                            // Use documentId if available, not noticeId
                            let docData = null;
                            if (noticeData.documentId) {
                                docData = await retryWithDelay(async () => {
                                    return await legalContract.documentNotices(noticeData.documentId).call();
                                }, 3, 2000);
                            }
                            
                            console.log(`Document data for document ${noticeData.documentId}:`, docData);
                            
                            // Use acknowledged status from notice data if available
                            if (noticeData.acknowledged !== undefined) {
                                isAccepted = noticeData.acknowledged;
                                console.log(`Notice ${noticeData.noticeId} acknowledged from notice data:`, isAccepted);
                            } else if (alertData && Array.isArray(alertData) && alertData.length > 4) {
                                // alertNotices structure: [recipient, sender, documentId, timestamp, acknowledged, ...]
                                const acknowledged = alertData.acknowledged || alertData[4]; // Index 4 is acknowledged field
                                console.log(`Alert ${noticeData.alertId} acknowledged status:`, acknowledged);
                                
                                if (acknowledged === true || acknowledged === 'true' || acknowledged === 1) {
                                    console.log(`Notice ${noticeData.noticeId} has been signed for by recipient`);
                                    isAccepted = true;
                                    
                                    // If there's a document, it's now accessible
                                    if (docData && (docData[0] || docData.encryptedIPFS)) { 
                                        console.log(`Document is now accessible after signature`);
                                    }
                                } else {
                                    console.log(`Notice ${noticeData.noticeId} has NOT been signed for`);
                                    isAccepted = false;
                                }
                            } else {
                                console.log(`Notice ${noticeData.noticeId} - no acknowledgment data found`);
                                isAccepted = false;
                            }
                            
                            // Get acceptance data from localStorage for additional info
                            const acceptances = JSON.parse(localStorage.getItem('noticeAcceptances') || '{}');
                            acceptanceData = acceptances[noticeData.noticeId];
                            
                            // Get IP tracking data
                            const visitLogs = JSON.parse(localStorage.getItem('noticeVisitLogs') || '{}');
                            ipData = visitLogs[noticeData.noticeId] ? visitLogs[noticeData.noticeId][0] : null;
                            
                            // If we have backend data, use it to enrich the display
                            if (backendData && backendData.notices) {
                                const backendNotice = backendData.notices.find(n => n.notice_id === noticeData.noticeId.toString());
                                if (backendNotice) {
                                    // Use backend acceptance data if available
                                    if (backendNotice.acceptance_timestamp) {
                                        isAccepted = true;
                                        acceptanceData = {
                                            timestamp: new Date(backendNotice.acceptance_timestamp).getTime(),
                                            transactionHash: backendNotice.acceptance_tx_hash
                                        };
                                        
                                        // Use backend IP data if available
                                        if (backendNotice.acceptance_ip) {
                                            ipData = {
                                                ip: backendNotice.acceptance_ip,
                                                location: backendNotice.acceptance_location || {}
                                            };
                                        }
                                    }
                                    
                                    // Show view count from backend
                                    noticeData.viewCount = backendNotice.view_count || 0;
                                    noticeData.lastViewed = backendNotice.last_viewed_at;
                                }
                            }
                        } catch (err) {
                            console.log('Error checking notice acceptance:', err);
                        }
                        
                        // Parse timestamp correctly
                        const timestampMs = typeof noticeData.timestamp === 'bigint' ? Number(noticeData.timestamp) : noticeData.timestamp;
                        const servedDate = new Date(timestampMs);
                        const formattedDate = servedDate.toLocaleString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        });
                        
                        // Prepare the IDs safely for the onclick handler
                        const safeNoticeId = noticeData.noticeId || '';
                        const safeAlertId = noticeData.alertId || '';
                        const safeDocumentId = noticeData.documentId || '';
                        
                        html += `
                            <div class="activity-item" style="padding: 1rem; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s;"
                                 onmouseover="this.style.background='var(--bg-secondary)'" 
                                 onmouseout="this.style.background='transparent'"
                                 onclick="window.viewNoticeDetails('${safeNoticeId}', '${safeAlertId}', '${safeDocumentId}')">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        ${noticeData.previewImage ? `
                                            <div style="float: left; margin-right: 1rem; margin-bottom: 0.5rem;">
                                                <img src="${noticeData.previewImage}" alt="Document preview" 
                                                     style="width: 60px; height: 80px; object-fit: cover; border: 1px solid var(--border-color); border-radius: 4px;">
                                            </div>
                                        ` : ''}
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <i class="fas fa-file-contract" style="color: var(--accent-blue);"></i>
                                            <strong>
                                                ${noticeData.alertId ? `Alert Notice #${noticeData.alertId}` : ''}
                                                ${noticeData.alertId && noticeData.documentId ? ' / ' : ''}
                                                ${noticeData.documentId ? `Document Notice #${noticeData.documentId}` : ''}
                                                ${!noticeData.alertId && !noticeData.documentId ? `Notice #${noticeData.noticeId}` : ''}
                                            </strong>
                                            <span class="badge ${isAccepted ? 'badge-success' : 'badge-warning'}" style="font-size: 0.75rem;">
                                                ${isAccepted ? '<i class="fas fa-check"></i> Signed' : '<i class="fas fa-clock"></i> Pending'}
                                            </span>
                                        </div>
                                        <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                            <div>To: ${formatAddress(noticeData.recipient)}</div>
                                            <div>Type: ${noticeData.noticeType || 'Legal Notice'}</div>
                                            ${noticeData.caseNumber ? `<div>Case: ${noticeData.caseNumber}</div>` : ''}
                                            ${noticeData.alertId ? `<div>Alert ID: ${noticeData.alertId}</div>` : ''}
                                            <div>Served: ${formattedDate}</div>
                                            ${noticeData.ipfsHash ? `<div>IPFS: ${noticeData.ipfsHash.substring(0, 12)}...</div>` : ''}
                                        </div>
                                        ${isAccepted && acceptanceData ? `
                                            <div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: 4px; font-size: 0.875rem;">
                                                <div style="color: var(--success-green); font-weight: 500; margin-bottom: 0.25rem;">
                                                    <i class="fas fa-check-circle"></i> Accepted on ${new Date(acceptanceData.timestamp).toLocaleString()}
                                                </div>
                                                ${ipData ? `
                                                    <div style="color: var(--text-muted);">
                                                        <i class="fas fa-map-marker-alt"></i> ${ipData.location.city}, ${ipData.location.region}, ${ipData.location.country}
                                                        <br>
                                                        <i class="fas fa-network-wired"></i> IP: ${ipData.ip}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); window.viewNoticeDetails('${safeNoticeId}', '${safeAlertId}', '${safeDocumentId}')">
                                            <i class="fas fa-eye"></i> View Details
                                        </button>
                                        <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); window.viewNoticeAuditTrail('${safeNoticeId}')">
                                            <i class="fas fa-history"></i> Audit
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } catch (err) {
                        console.error('Error loading notice data:', err);
                    }
                }
                
                html += '</div>';
                content.innerHTML = html;
                
            } catch (error) {
                console.error('Error refreshing recent activities:', error);
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error loading activity</h3>
                        <p>Unable to fetch recent notices</p>
                    </div>
                `;
            }
        }
        
        // Function to view acceptance details with IP data
        async function viewAcceptanceDetails(noticeId) {
            try {
                // Get acceptance data
                const acceptances = JSON.parse(localStorage.getItem('noticeAcceptances') || '{}');
                const acceptanceData = acceptances[noticeId];
                
                // Get IP tracking data
                const visitLogs = JSON.parse(localStorage.getItem('noticeVisitLogs') || '{}');
                const ipData = visitLogs[noticeId] ? visitLogs[noticeId][0] : null;
                
                // Get notice details
                const alertData = await legalContract.alertNotices(noticeId).call();
                
                // Create modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>Acceptance Receipt - Notice #${noticeId}</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                                <h4 style="margin-top: 0;">Notice Information</h4>
                                <div style="display: grid; gap: 0.5rem;">
                                    <div><strong>Type:</strong> ${alertData.noticeType || 'Legal Notice'}</div>
                                    <div><strong>Case Number:</strong> ${alertData.caseNumber || 'N/A'}</div>
                                    <div><strong>Recipient:</strong> ${alertData.recipient}</div>
                                    <div><strong>Served:</strong> ${new Date(parseInt(alertData.timestamp) * 1000).toLocaleString()}</div>
                                </div>
                            </div>
                            
                            ${acceptanceData ? `
                                <div style="padding: 1rem; background: #f0fdf4; border-radius: 8px; margin-bottom: 1rem;">
                                    <h4 style="margin-top: 0; color: #14532d;">Acceptance Confirmation</h4>
                                    <div style="display: grid; gap: 0.5rem;">
                                        <div><strong>Accepted:</strong> ${new Date(acceptanceData.timestamp).toLocaleString()}</div>
                                        <div><strong>Transaction ID:</strong> <a href="https://tronscan.org/#/transaction/${acceptanceData.txId}" target="_blank" style="color: #22c55e;">${acceptanceData.txId.substring(0, 10)}...</a></div>
                                        <div><strong>Signature:</strong> ${acceptanceData.signature ? acceptanceData.signature.substring(0, 20) + '...' : 'On-chain signature'}</div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${ipData ? `
                                <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                                    <h4 style="margin-top: 0;">Location & Device Information</h4>
                                    <div style="display: grid; gap: 0.5rem;">
                                        <div><strong>IP Address:</strong> ${ipData.ip}</div>
                                        <div><strong>Location:</strong> ${ipData.location.city}, ${ipData.location.region}, ${ipData.location.country}</div>
                                        ${ipData.location.latitude ? `
                                            <div><strong>Coordinates:</strong> ${ipData.location.latitude}, ${ipData.location.longitude}</div>
                                        ` : ''}
                                        <div><strong>Timezone:</strong> ${ipData.location.timezone}</div>
                                        <div><strong>Browser:</strong> ${ipData.userAgent.match(/(Chrome|Firefox|Safari|Edge)\/[\d.]+/)?.[0] || 'Unknown'}</div>
                                        <div><strong>Screen:</strong> ${ipData.screenResolution}</div>
                                        <div><strong>Language:</strong> ${ipData.language}</div>
                                    </div>
                                </div>
                            ` : '<p>No IP tracking data available</p>'}
                            
                            <div style="margin-top: 1.5rem; text-align: center;">
                                <button class="btn btn-primary" onclick="printAcceptanceReceipt(${noticeId})">
                                    <i class="fas fa-print"></i> Print Receipt
                                </button>
                                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="margin-left: 0.5rem;">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error viewing acceptance details:', error);
                uiManager.showNotification('error', 'Failed to load acceptance details');
            }
        }

        // Function to view comprehensive notice details
        async function viewNoticeDetails(noticeId, alertId, documentId) {
            console.log('viewNoticeDetails called with:', { noticeId, alertId, documentId });
            
            try {
                if (!legalContract) {
                    uiManager.showNotification('error', 'Please connect to contract first');
                    return;
                }
                
                // Fetch all relevant data
                let alertData = null;
                let documentData = null;
                let alertStatus = 'Not Created';
                let documentStatus = 'Not Created';
                let isAlertDelivered = false;
                let isDocumentSigned = false;
                
                // Get Alert NFT data if exists
                if (alertId && alertId !== 'null' && alertId !== '0') {
                    try {
                        alertData = await legalContract.alertNotices(alertId).call();
                        if (alertData) {
                            // Alert is always "Delivered" once created
                            isAlertDelivered = true;
                            alertStatus = 'Delivered';
                            console.log('Alert NFT data:', alertData);
                        }
                    } catch (e) {
                        console.log('Error fetching alert data:', e);
                    }
                }
                
                // Get Document NFT data if exists
                if (documentId && documentId !== 'null' && documentId !== '0') {
                    try {
                        documentData = await legalContract.documentNotices(documentId).call();
                        if (documentData) {
                            // Check if document has been signed (acknowledged field)
                            const acknowledged = alertData && (alertData.acknowledged || alertData[4]);
                            isDocumentSigned = acknowledged === true || acknowledged === 1;
                            documentStatus = isDocumentSigned ? 'Document Signed For' : 'Awaiting Signature';
                            console.log('Document NFT data:', documentData);
                        }
                    } catch (e) {
                        console.log('Error fetching document data:', e);
                    }
                }
                
                // Get acceptance data from localStorage
                const acceptances = JSON.parse(localStorage.getItem('noticeAcceptances') || '{}');
                const acceptanceData = acceptances[noticeId] || acceptances[alertId];
                
                // Get IP tracking data
                const visitLogs = JSON.parse(localStorage.getItem('noticeVisitLogs') || '{}');
                const ipData = visitLogs[noticeId] ? visitLogs[noticeId][0] : null;
                
                // Remove any existing modal first
                const existingModal = document.querySelector('.notice-details-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Create detailed modal
                const modal = document.createElement('div');
                modal.className = 'modal notice-details-modal';
                modal.style.display = 'block';
                modal.style.zIndex = '10000'; // Ensure it's on top
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3>Notice Details - #${noticeId}</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Notice Overview -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                <!-- Alert NFT Card -->
                                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 2px solid ${isAlertDelivered ? 'var(--success-green)' : 'var(--border-color)'};">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                        <i class="fas fa-bell" style="color: var(--accent-blue); font-size: 1.5rem;"></i>
                                        <div>
                                            <h4 style="margin: 0;">Alert NFT #${alertId || 'N/A'}</h4>
                                            <span class="badge ${isAlertDelivered ? 'badge-success' : 'badge-secondary'}" style="font-size: 0.75rem;">
                                                ${alertStatus}
                                            </span>
                                        </div>
                                    </div>
                                    ${alertData ? `
                                        <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                            <div><strong>Type:</strong> Proof of Delivery</div>
                                            <div><strong>Recipient:</strong> ${formatAddress(tronWeb.address.fromHex(alertData.recipient || alertData[0]))}</div>
                                            <div><strong>Served:</strong> ${new Date(Number(alertData.timestamp || alertData[3]) * 1000).toLocaleString()}</div>
                                            ${alertData.previewImage || alertData[11] ? `
                                                <div style="margin-top: 0.5rem;">
                                                    <img src="${alertData.previewImage || alertData[11]}" 
                                                         style="width: 100%; max-width: 200px; border-radius: 4px; border: 1px solid var(--border-color);"
                                                         alt="Document preview">
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div style="margin-top: 1rem;">
                                            <button class="btn btn-small btn-primary" style="width: 100%;" onclick="generateAlertReceipt('${alertId}', '${noticeId}')">
                                                <i class="fas fa-file-download"></i> Alert Receipt
                                            </button>
                                        </div>
                                    ` : '<p style="color: var(--text-muted);">No alert NFT created</p>'}
                                </div>
                                
                                <!-- Document NFT Card -->
                                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 2px solid ${isDocumentSigned ? 'var(--success-green)' : 'var(--warning-yellow)'};">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                        <i class="fas fa-file-contract" style="color: var(--accent-blue); font-size: 1.5rem;"></i>
                                        <div>
                                            <h4 style="margin: 0;">Document NFT #${documentId || 'N/A'}</h4>
                                            <span class="badge ${isDocumentSigned ? 'badge-success' : 'badge-warning'}" style="font-size: 0.75rem;">
                                                ${documentStatus}
                                            </span>
                                        </div>
                                    </div>
                                    ${documentData ? `
                                        <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                            <div><strong>Type:</strong> Legal Document</div>
                                            <div><strong>Authorized:</strong> ${formatAddress(tronWeb.address.fromHex(documentData.authorizedViewer || documentData[2]))}</div>
                                            <div><strong>IPFS:</strong> ${(documentData.encryptedIPFS || documentData[0] || '').substring(0, 20)}...</div>
                                            <div><strong>Restricted:</strong> ${documentData.isRestricted || documentData[4] ? 'Yes' : 'No'}</div>
                                            ${isDocumentSigned ? `
                                                <div style="margin-top: 0.5rem; padding: 0.5rem; background: #f0fdf4; border-radius: 4px;">
                                                    <i class="fas fa-check-circle" style="color: var(--success-green);"></i>
                                                    Document signed and accessible
                                                </div>
                                            ` : `
                                                <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fef3c7; border-radius: 4px;">
                                                    <i class="fas fa-clock" style="color: var(--warning-yellow);"></i>
                                                    Awaiting recipient signature
                                                </div>
                                            `}
                                        </div>
                                        <div style="margin-top: 1rem;">
                                            <button class="btn btn-small btn-primary" style="width: 100%;" onclick="generateDocumentReceipt('${documentId}', ${isDocumentSigned}, '${alertId}', '${noticeId}')">
                                                <i class="fas fa-file-download"></i> Document Receipt
                                            </button>
                                        </div>
                                    ` : '<p style="color: var(--text-muted);">No document NFT created</p>'}
                                </div>
                            </div>
                            
                            <!-- Acceptance Details if signed -->
                            ${isDocumentSigned && acceptanceData ? `
                                <div style="padding: 1rem; background: #f0fdf4; border-radius: 8px; margin-bottom: 1rem;">
                                    <h4 style="margin-top: 0; color: #14532d;">
                                        <i class="fas fa-check-circle"></i> Acceptance Confirmation
                                    </h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div>
                                            <strong>Accepted At:</strong><br>
                                            ${new Date(acceptanceData.timestamp).toLocaleString()}
                                        </div>
                                        <div>
                                            <strong>Transaction:</strong><br>
                                            <a href="${getTxScanUrl()}${acceptanceData.txId || acceptanceData.transactionHash}" 
                                               target="_blank" style="color: var(--accent-blue);">
                                                ${(acceptanceData.txId || acceptanceData.transactionHash || '').substring(0, 20)}...
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- IP Tracking Data if available -->
                            ${ipData ? `
                                <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                                    <h4 style="margin-top: 0;">
                                        <i class="fas fa-globe"></i> Access Information
                                    </h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                                        <div>
                                            <strong>IP Address:</strong> ${ipData.ip}<br>
                                            <strong>Location:</strong> ${ipData.location.city}, ${ipData.location.region}, ${ipData.location.country}
                                        </div>
                                        <div>
                                            <strong>Browser:</strong> ${ipData.userAgent.match(/(Chrome|Firefox|Safari|Edge)\/[\d.]+/)?.[0] || 'Unknown'}<br>
                                            <strong>Timezone:</strong> ${ipData.location.timezone}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
                                <button class="btn btn-primary" onclick="viewNoticeAuditTrail('${noticeId}')">
                                    <i class="fas fa-history"></i> View Full Audit Trail
                                </button>
                                <button class="btn btn-secondary" onclick="exportNoticeData('${noticeId}', '${alertId}', '${documentId}')">
                                    <i class="fas fa-download"></i> Export All Data
                                </button>
                                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                console.log('Notice details modal added to page');
                
            } catch (error) {
                console.error('Error viewing notice details:', error);
                uiManager.showNotification('error', 'Failed to load notice details: ' + error.message);
                
                // Still try to show a basic modal with the IDs we have
                try {
                    const modal = document.createElement('div');
                    modal.className = 'modal notice-details-modal';
                    modal.style.display = 'block';
                    modal.style.zIndex = '10000';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h3>Notice Details - Error Loading</h3>
                                <button class="modal-close" onclick="this.closest('.modal').remove()"></button>
                            </div>
                            <div class="modal-body">
                                <p>Error loading notice details: ${error.message}</p>
                                <p>Notice ID: ${noticeId || 'N/A'}</p>
                                <p>Alert ID: ${alertId || 'N/A'}</p>
                                <p>Document ID: ${documentId || 'N/A'}</p>
                                <div style="margin-top: 1rem;">
                                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                } catch (e) {
                    console.error('Failed to show error modal:', e);
                }
            }
        }
        
        // Generate comprehensive Alert NFT Receipt for legal use
        async function generateAlertReceipt(alertId, noticeId) {
            try {
                // Fetch all necessary data
                const alertData = await legalContract.alertNotices(alertId).call();
                const currentUser = tronWeb.defaultAddress.base58;
                
                // Convert addresses to base58 format
                const recipientAddress = tronWeb.address.fromHex(alertData.recipient || alertData[0]);
                const senderAddress = tronWeb.address.fromHex(alertData.sender || alertData[1]);
                const timestamp = Number(alertData.timestamp || alertData[3]) * 1000;
                const servedDate = new Date(timestamp);
                
                // Get network for TronScan URLs
                const network = tronWeb.fullNode.host.includes('nile') ? 'nile' : '';
                const baseUrl = network ? `https://${network}.tronscan.org` : 'https://tronscan.org';
                
                // Get process server data from localStorage
                const serverRegistrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
                const serverData = serverRegistrations[currentUser] || {};
                
                // Get transaction data from localStorage
                const transactions = JSON.parse(localStorage.getItem('userTransactions') || '[]');
                const txData = transactions.find(tx => 
                    tx.noticeId === noticeId || tx.alertId === alertId
                ) || {};
                
                // Fetch backend data if available
                let thumbnailUrl = '';
                let nftDescription = '';
                let documentPreview = '';
                
                if (window.BACKEND_API_URL) {
                    try {
                        const response = await fetch(`${window.BACKEND_API_URL}/api/notices/${noticeId}/metadata`);
                        if (response.ok) {
                            const metadata = await response.json();
                            thumbnailUrl = metadata.thumbnail || '';
                            documentPreview = metadata.previewImage || '';
                        }
                    } catch (e) {
                        console.log('Could not fetch backend metadata');
                    }
                }
                
                // Use preview image from alert data if no backend data
                if (!documentPreview && (alertData.previewImage || alertData[11])) {
                    documentPreview = alertData.previewImage || alertData[11];
                }
                
                // Get NFT description
                nftDescription = alertData.description || alertData[10] || 
                    `Legal Notice Alert - This NFT serves as immutable proof of service delivery to wallet ${recipientAddress}`;
                
                // Generate HTML receipt
                const receiptHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Alert NFT Receipt - #${alertId}</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; border-bottom: 3px solid #000; padding-bottom: 20px; margin-bottom: 20px; }
        .title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .subtitle { font-size: 16px; color: #666; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #333; }
        .field { margin: 8px 0; }
        .label { font-weight: bold; display: inline-block; width: 150px; }
        .value { color: #000; }
        .address { font-family: monospace; font-size: 12px; word-break: break-all; }
        .link { color: #0066cc; text-decoration: none; }
        .link:hover { text-decoration: underline; }
        .verification-box { background: #f0f8ff; padding: 15px; border-left: 4px solid #0066cc; margin: 20px 0; }
        .signature-section { border: 2px solid #000; padding: 20px; margin-top: 30px; }
        .signature-line { border-bottom: 1px solid #000; margin: 20px 0; height: 30px; }
        .thumbnail { max-width: 200px; max-height: 300px; border: 1px solid #ddd; margin: 10px 0; }
        .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #666; }
        @media print { 
            .no-print { display: none; }
            body { max-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">PROOF OF SERVICE - ALERT NFT RECEIPT</div>
        <div class="subtitle">Blockchain-Verified Legal Notice Delivery</div>
        <div class="subtitle">Alert NFT #${alertId}</div>
    </div>
    
    <div class="section">
        <div class="section-title">NOTICE DELIVERY INFORMATION</div>
        <div class="field">
            <span class="label">Alert NFT ID:</span>
            <span class="value">#${alertId}</span>
        </div>
        <div class="field">
            <span class="label">Notice ID:</span>
            <span class="value">#${noticeId || 'N/A'}</span>
        </div>
        <div class="field">
            <span class="label">Status:</span>
            <span class="value" style="color: green; font-weight: bold;"> DELIVERED</span>
        </div>
        <div class="field">
            <span class="label">Date Served:</span>
            <span class="value">${servedDate.toLocaleDateString()} at ${servedDate.toLocaleTimeString()}</span>
        </div>
        <div class="field">
            <span class="label">Timestamp (Unix):</span>
            <span class="value">${timestamp}</span>
        </div>
    </div>
    
    <div class="section">
        <div class="section-title">PARTIES INFORMATION</div>
        <div class="field">
            <span class="label">Recipient Wallet:</span>
            <span class="value address">${recipientAddress}</span>
            <a href="${baseUrl}/#/address/${recipientAddress}" target="_blank" class="link no-print">
                [View on TronScan ]
            </a>
        </div>
        <div class="field">
            <span class="label">Server Wallet:</span>
            <span class="value address">${senderAddress}</span>
            <a href="${baseUrl}/#/address/${senderAddress}" target="_blank" class="link no-print">
                [View on TronScan ]
            </a>
        </div>
        ${serverData.serverId ? `
        <div class="field">
            <span class="label">Server ID:</span>
            <span class="value">${serverData.serverId}</span>
        </div>
        ` : ''}
        ${serverData.agencyName ? `
        <div class="field">
            <span class="label">Agency:</span>
            <span class="value">${serverData.agencyName}</span>
        </div>
        ` : ''}
    </div>
    
    <div class="section">
        <div class="section-title">BLOCKCHAIN VERIFICATION</div>
        <div class="field">
            <span class="label">Network:</span>
            <span class="value">${network ? 'TRON Nile Testnet' : 'TRON Mainnet'}</span>
        </div>
        <div class="field">
            <span class="label">Contract Address:</span>
            <span class="value address">${legalContract.address}</span>
            <a href="${baseUrl}/#/contract/${legalContract.address}" target="_blank" class="link no-print">
                [View Contract ]
            </a>
        </div>
        ${txData.txid ? `
        <div class="field">
            <span class="label">Transaction Hash:</span>
            <span class="value address">${txData.txid}</span>
            <a href="${baseUrl}/#/transaction/${txData.txid}" target="_blank" class="link no-print">
                [View Transaction ]
            </a>
        </div>
        ` : ''}
        <div class="field">
            <span class="label">NFT Token Standard:</span>
            <span class="value">TRC-721</span>
        </div>
        <div class="field">
            <span class="label">View NFT:</span>
            <a href="${baseUrl}/#/token721/${legalContract.address}/token/${alertId}" target="_blank" class="link">
                ${baseUrl}/#/token721/${legalContract.address}/token/${alertId}
            </a>
        </div>
    </div>
    
    <div class="section">
        <div class="section-title">NFT DESCRIPTION</div>
        <div style="padding: 10px; background: #f9f9f9; border-radius: 3px;">
            ${nftDescription}
        </div>
        ${documentPreview ? `
        <div style="margin-top: 15px;">
            <strong>Document Preview:</strong><br>
            <img src="${documentPreview}" class="thumbnail" alt="Document preview">
        </div>
        ` : ''}
    </div>
    
    <div class="verification-box">
        <div class="section-title">HOW TO VERIFY THIS NOTICE</div>
        <ol>
            <li><strong>Visit TronScan:</strong> Go to ${baseUrl}</li>
            <li><strong>Search the Transaction:</strong> Enter transaction hash or Alert NFT ID #${alertId}</li>
            <li><strong>Verify the Contract:</strong> Confirm contract address matches: ${legalContract.address}</li>
            <li><strong>Check NFT Ownership:</strong> The NFT is owned by wallet: ${recipientAddress}</li>
            <li><strong>Verify Timestamp:</strong> Confirm delivery date: ${servedDate.toLocaleDateString()}</li>
        </ol>
        <p style="margin-top: 10px; font-style: italic;">
            This Alert NFT is permanently recorded on the TRON blockchain and serves as immutable proof 
            that legal notice was delivered to the specified wallet address. The blockchain record cannot 
            be altered or deleted, providing cryptographic proof of service.
        </p>
    </div>
    
    <div class="signature-section">
        <div class="section-title">PROCESS SERVER CERTIFICATION</div>
        <p>I hereby certify under penalty of perjury that the above information is true and correct, 
        and that legal notice was properly served to the blockchain wallet address specified above.</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
            <div>
                <div class="signature-line"></div>
                <div>Process Server Signature</div>
            </div>
            <div>
                <div class="signature-line"></div>
                <div>Date</div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
            <div>
                <div class="signature-line"></div>
                <div>Print Name</div>
            </div>
            <div>
                <div class="signature-line"></div>
                <div>License/ID Number</div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>Generated on ${new Date().toLocaleString()} | Blockchain Legal Notice System</p>
        <p>This receipt is generated from immutable blockchain data and can be independently verified on TronScan</p>
    </div>
</body>
</html>
                `;
                
                // Create and download HTML file
                const blob = new Blob([receiptHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `alert_nft_${alertId}_receipt.html`;
                a.click();
                URL.revokeObjectURL(url);
                
                uiManager.showNotification('success', 'Alert receipt downloaded - ready for printing and signature');
            } catch (error) {
                console.error('Error generating alert receipt:', error);
                uiManager.showNotification('error', 'Failed to generate alert receipt');
            }
        }
        
        // Generate comprehensive Document NFT Receipt with acceptance proof
        async function generateDocumentReceipt(documentId, isSigned, alertId, noticeId) {
            try {
                // Fetch all necessary data
                const docData = await legalContract.documentNotices(documentId).call();
                const currentUser = tronWeb.defaultAddress.base58;
                
                // Get alert data for acknowledgment status
                let alertData = null;
                let acceptanceTimestamp = null;
                let acceptanceTxHash = null;
                
                if (alertId) {
                    try {
                        alertData = await legalContract.alertNotices(alertId).call();
                        const acknowledged = alertData.acknowledged || alertData[4];
                        if (acknowledged) {
                            // Get acceptance details from localStorage
                            const acceptances = JSON.parse(localStorage.getItem('noticeAcceptances') || '{}');
                            const acceptanceData = acceptances[noticeId] || acceptances[alertId];
                            if (acceptanceData) {
                                acceptanceTimestamp = new Date(acceptanceData.timestamp);
                                acceptanceTxHash = acceptanceData.txId || acceptanceData.transactionHash;
                            }
                        }
                    } catch (e) {
                        console.log('Could not fetch alert data');
                    }
                }
                
                // Convert addresses to base58
                const authorizedViewer = tronWeb.address.fromHex(docData.authorizedViewer || docData[2]);
                const ipfsHash = docData.encryptedIPFS || docData[0];
                const isRestricted = docData.isRestricted || docData[4];
                
                // Get network for TronScan URLs
                const network = tronWeb.fullNode.host.includes('nile') ? 'nile' : '';
                const baseUrl = network ? `https://${network}.tronscan.org` : 'https://tronscan.org';
                
                // Get process server data
                const serverRegistrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
                const serverData = serverRegistrations[currentUser] || {};
                
                // Get transaction data
                const transactions = JSON.parse(localStorage.getItem('userTransactions') || '[]');
                const txData = transactions.find(tx => 
                    tx.noticeId === noticeId || tx.documentId === documentId
                ) || {};
                
                // Fetch full document from backend
                let fullDocumentImage = '';
                let documentMetadata = {};
                
                if (window.BACKEND_API_URL) {
                    try {
                        // Get unencrypted document from backend
                        const response = await fetch(`${window.BACKEND_API_URL}/api/documents/${documentId}/original`);
                        if (response.ok) {
                            const data = await response.json();
                            fullDocumentImage = data.originalDocument || data.unencryptedImage || '';
                            documentMetadata = data.metadata || {};
                        }
                    } catch (e) {
                        console.log('Could not fetch original document from backend');
                    }
                }
                
                // If no backend data, try to decrypt from IPFS
                if (!fullDocumentImage && ipfsHash && docData.decryptionKey) {
                    try {
                        const encryptedDoc = await SimpleEncryption.getFromIPFS(ipfsHash);
                        fullDocumentImage = SimpleEncryption.decryptDocument(encryptedDoc, docData.decryptionKey || docData[1]);
                    } catch (e) {
                        console.log('Could not decrypt document from IPFS');
                    }
                }
                
                // Generate HTML receipt
                const receiptHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Document NFT Receipt - #${documentId}</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; border-bottom: 3px solid #000; padding-bottom: 20px; margin-bottom: 20px; }
        .title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .subtitle { font-size: 16px; color: #666; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #333; }
        .field { margin: 8px 0; }
        .label { font-weight: bold; display: inline-block; width: 180px; }
        .value { color: #000; }
        .address { font-family: monospace; font-size: 12px; word-break: break-all; }
        .link { color: #0066cc; text-decoration: none; }
        .link:hover { text-decoration: underline; }
        .acceptance-box { background: #f0fff0; padding: 15px; border-left: 4px solid #00cc00; margin: 20px 0; }
        .signature-section { border: 2px solid #000; padding: 20px; margin-top: 30px; }
        .signature-line { border-bottom: 1px solid #000; margin: 20px 0; height: 30px; }
        .document-image { max-width: 100%; border: 2px solid #ddd; margin: 20px 0; page-break-inside: avoid; }
        .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #666; }
        .warning-box { background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0; }
        @media print { 
            .no-print { display: none; }
            body { max-width: 100%; }
            .document-image { page-break-before: always; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">LEGAL DOCUMENT SERVICE RECEIPT</div>
        <div class="subtitle">Document NFT with ${isSigned ? 'Confirmed Acceptance' : 'Pending Acceptance'}</div>
        <div class="subtitle">Document NFT #${documentId}</div>
    </div>
    
    <div class="section">
        <div class="section-title">DOCUMENT SERVICE INFORMATION</div>
        <div class="field">
            <span class="label">Document NFT ID:</span>
            <span class="value">#${documentId}</span>
        </div>
        <div class="field">
            <span class="label">Alert NFT ID:</span>
            <span class="value">#${alertId || 'N/A'}</span>
        </div>
        <div class="field">
            <span class="label">Notice ID:</span>
            <span class="value">#${noticeId || 'N/A'}</span>
        </div>
        <div class="field">
            <span class="label">Document Status:</span>
            <span class="value" style="color: ${isSigned ? 'green' : 'orange'}; font-weight: bold;">
                ${isSigned ? ' DOCUMENT SIGNED FOR' : ' AWAITING SIGNATURE'}
            </span>
        </div>
        <div class="field">
            <span class="label">Access Restriction:</span>
            <span class="value">${isRestricted ? 'Restricted - Signature Required' : 'Unrestricted'}</span>
        </div>
    </div>
    
    ${isSigned ? `
    <div class="acceptance-box">
        <div class="section-title">ACCEPTANCE CONFIRMATION</div>
        <p><strong>IMPORTANT:</strong> The recipient has digitally signed the smart contract to acknowledge receipt of this document.</p>
        <div class="field">
            <span class="label">Acceptance Method:</span>
            <span class="value">Smart Contract Signature (acceptNotice function)</span>
        </div>
        <div class="field">
            <span class="label">Signed At:</span>
            <span class="value">${acceptanceTimestamp ? acceptanceTimestamp.toLocaleString() : 'Confirmed on blockchain'}</span>
        </div>
        ${acceptanceTxHash ? `
        <div class="field">
            <span class="label">Acceptance Transaction:</span>
            <span class="value address">${acceptanceTxHash}</span>
            <a href="${baseUrl}/#/transaction/${acceptanceTxHash}" target="_blank" class="link no-print">
                [View Acceptance TX ]
            </a>
        </div>
        ` : ''}
        <p style="margin-top: 10px; font-style: italic;">
            By executing the acceptNotice() function on the smart contract, the recipient has created an immutable 
            blockchain record confirming they have received and acknowledged this legal document. This digital 
            signature is cryptographically verified and legally binding.
        </p>
    </div>
    ` : `
    <div class="warning-box">
        <div class="section-title">PENDING ACCEPTANCE</div>
        <p>This document is awaiting signature from the recipient. The document NFT has been delivered to the 
        recipient's wallet, but they have not yet executed the acceptance function on the smart contract.</p>
        <p>Once signed, this receipt will show the acceptance confirmation with transaction details.</p>
    </div>
    `}
    
    <div class="section">
        <div class="section-title">AUTHORIZED PARTIES</div>
        <div class="field">
            <span class="label">Authorized Viewer:</span>
            <span class="value address">${authorizedViewer}</span>
            <a href="${baseUrl}/#/address/${authorizedViewer}" target="_blank" class="link no-print">
                [View on TronScan ]
            </a>
        </div>
        <div class="field">
            <span class="label">Process Server:</span>
            <span class="value address">${currentUser}</span>
            <a href="${baseUrl}/#/address/${currentUser}" target="_blank" class="link no-print">
                [View on TronScan ]
            </a>
        </div>
        ${serverData.serverId ? `
        <div class="field">
            <span class="label">Server ID:</span>
            <span class="value">${serverData.serverId}</span>
        </div>
        ` : ''}
        ${serverData.agencyName ? `
        <div class="field">
            <span class="label">Agency:</span>
            <span class="value">${serverData.agencyName}</span>
        </div>
        ` : ''}
    </div>
    
    <div class="section">
        <div class="section-title">BLOCKCHAIN VERIFICATION</div>
        <div class="field">
            <span class="label">Network:</span>
            <span class="value">${network ? 'TRON Nile Testnet' : 'TRON Mainnet'}</span>
        </div>
        <div class="field">
            <span class="label">Contract Address:</span>
            <span class="value address">${legalContract.address}</span>
            <a href="${baseUrl}/#/contract/${legalContract.address}" target="_blank" class="link no-print">
                [View Contract ]
            </a>
        </div>
        <div class="field">
            <span class="label">IPFS Hash:</span>
            <span class="value address">${ipfsHash}</span>
        </div>
        ${txData.txid ? `
        <div class="field">
            <span class="label">Creation Transaction:</span>
            <span class="value address">${txData.txid}</span>
            <a href="${baseUrl}/#/transaction/${txData.txid}" target="_blank" class="link no-print">
                [View Transaction ]
            </a>
        </div>
        ` : ''}
        <div class="field">
            <span class="label">View Document NFT:</span>
            <a href="${baseUrl}/#/token721/${legalContract.address}/token/${documentId}" target="_blank" class="link">
                ${baseUrl}/#/token721/${legalContract.address}/token/${documentId}
            </a>
        </div>
    </div>
    
    <div class="section">
        <div class="section-title">HOW TO VERIFY ACCEPTANCE</div>
        <ol>
            <li><strong>Visit the Smart Contract:</strong> Go to ${baseUrl}/#/contract/${legalContract.address}</li>
            <li><strong>Check the alertNotices mapping:</strong> Query Alert NFT #${alertId || '[AlertID]'}</li>
            <li><strong>Verify the acknowledged field:</strong> Should show "true" if document was signed</li>
            <li><strong>Review Transaction History:</strong> Look for acceptNotice() function calls from ${authorizedViewer}</li>
            <li><strong>Confirm NFT Ownership:</strong> Both NFTs are owned by wallet: ${authorizedViewer}</li>
        </ol>
    </div>
    
    ${fullDocumentImage ? `
    <div class="section">
        <div class="section-title">SERVED DOCUMENT</div>
        <p style="margin-bottom: 10px;">The following is the complete document that was encrypted and stored on IPFS:</p>
        <img src="${fullDocumentImage}" class="document-image" alt="Legal Document">
    </div>
    ` : `
    <div class="section">
        <div class="section-title">DOCUMENT REFERENCE</div>
        <p>The encrypted document is stored on IPFS at hash: ${ipfsHash}</p>
        <p>The full document image is not available in this receipt. Please check the backend system or decrypt from IPFS.</p>
    </div>
    `}
    
    <div class="signature-section">
        <div class="section-title">PROCESS SERVER CERTIFICATION</div>
        <p>I hereby certify under penalty of perjury that the above information is true and correct, 
        and that the legal document was properly served via blockchain to the specified wallet address.
        ${isSigned ? ' I further certify that the recipient has acknowledged receipt by signing the smart contract.' : ''}</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
            <div>
                <div class="signature-line"></div>
                <div>Process Server Signature</div>
            </div>
            <div>
                <div class="signature-line"></div>
                <div>Date</div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
            <div>
                <div class="signature-line"></div>
                <div>Print Name</div>
            </div>
            <div>
                <div class="signature-line"></div>
                <div>License/ID Number</div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>Generated on ${new Date().toLocaleString()} | Blockchain Legal Notice System</p>
        <p>This receipt contains blockchain-verified data that can be independently confirmed on TronScan</p>
        ${isSigned ? '<p><strong>Document acceptance has been cryptographically verified on the blockchain</strong></p>' : ''}
    </div>
</body>
</html>
                `;
                
                // Create and download HTML file
                const blob = new Blob([receiptHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `document_nft_${documentId}_receipt.html`;
                a.click();
                URL.revokeObjectURL(url);
                
                uiManager.showNotification('success', 'Document receipt downloaded - ready for printing and signature');
            } catch (error) {
                console.error('Error generating document receipt:', error);
                uiManager.showNotification('error', 'Failed to generate document receipt');
            }
        }
        
        // Export all notice data
        async function exportNoticeData(noticeId, alertId, documentId) {
            try {
                const data = {
                    noticeId: noticeId,
                    alertId: alertId,
                    documentId: documentId,
                    exportedAt: new Date().toISOString(),
                    alertData: null,
                    documentData: null,
                    acceptanceData: null
                };
                
                // Fetch all data
                if (alertId && alertId !== 'null') {
                    try {
                        data.alertData = await legalContract.alertNotices(alertId).call();
                    } catch (e) {}
                }
                
                if (documentId && documentId !== 'null') {
                    try {
                        data.documentData = await legalContract.documentNotices(documentId).call();
                    } catch (e) {}
                }
                
                // Get acceptance data
                const acceptances = JSON.parse(localStorage.getItem('noticeAcceptances') || '{}');
                data.acceptanceData = acceptances[noticeId] || acceptances[alertId];
                
                // Download as JSON
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `notice_${noticeId}_full_data.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                uiManager.showNotification('success', 'Notice data exported');
            } catch (error) {
                console.error('Error exporting notice data:', error);
                uiManager.showNotification('error', 'Failed to export notice data');
            }
        }
        
        // Function to view notice audit trail
        async function viewNoticeAuditTrail(noticeId) {
            try {
                // Open audit modal with the notice ID pre-filled
                openAuditModal();
                
                // Set search type to notice ID
                document.getElementById('auditSearchType').value = 'noticeId';
                updateAuditSearch();
                
                // Set the notice ID and search
                const noticeIdInput = document.getElementById('auditNoticeId');
                if (noticeIdInput) {
                    noticeIdInput.value = noticeId;
                } else {
                    console.error('Could not find auditNoticeId input element');
                    return;
                }
                
                // Trigger the search
                await performAudit();
                
            } catch (error) {
                console.error('Error opening audit view:', error);
                uiManager.showNotification('error', 'Failed to open audit view');
            }
        }
        
        // Backward compatibility - keep old function name
        async function viewNoticeAudit(noticeId) {
            return viewNoticeAuditTrail(noticeId);
        }

        function getActivityIcon(type) {
            const icons = {
                'create': 'fas fa-file-upload',
                'accept': 'fas fa-check-circle',
                'registration': 'fas fa-user-plus',
                'approval': 'fas fa-user-check',
                'role': 'fas fa-user-shield',
                'admin': 'fas fa-cog'
            };
            
            return icons[type] || 'fas fa-circle';
        }

        // Helper function to determine NFT type from ID or data
        function determineNFTType(nftId, nftData) {
            // The contract structure typically differentiates Alert and Document NFTs
            // Alert NFTs: Used for proof of delivery, always "Delivered" status
            // Document NFTs: Used for documents requiring signature
            
            // Check if we have alert data structure (has recipient, sender, timestamp, acknowledged fields)
            if (nftData && (nftData.sender !== undefined || nftData[1] !== undefined)) {
                return 'Alert';
            }
            
            // Check if we have document data structure (has encryptedIPFS, decryptionKey, authorizedViewer)
            if (nftData && (nftData.encryptedIPFS !== undefined || nftData[0] !== undefined)) {
                return 'Document';
            }
            
            // Fallback: Try to determine from the ID pattern or context
            // This may need adjustment based on your contract's ID assignment pattern
            return 'Notice'; // Generic fallback
        }
        
        // Helper function to format NFT display with type
        function formatNFTDisplay(nftId, nftType) {
            if (!nftId || nftId === '0' || nftId === 'null') return '';
            
            const type = nftType || 'Notice';
            return `${type} #${nftId}`;
        }
        
        // Helper function to get NFT badge HTML with proper type
        function getNFTBadge(nftId, nftType, status) {
            const typeLabel = nftType || 'Notice';
            let badgeClass = 'badge-secondary';
            let statusText = status || 'Pending';
            
            if (nftType === 'Alert') {
                badgeClass = 'badge-info';
                statusText = 'Delivered';
            } else if (nftType === 'Document') {
                if (status === 'signed' || status === true) {
                    badgeClass = 'badge-success';
                    statusText = 'Signed For';
                } else {
                    badgeClass = 'badge-warning';
                    statusText = 'Awaiting Signature';
                }
            }
            
            return `<span class="badge ${badgeClass}" title="${typeLabel} NFT #${nftId}">${statusText}</span>`;
        }
        
        // Helper functions
        function formatAddress(address) {
            if (!address) return 'N/A';
            // Ensure address is in base58 format before truncating
            const base58Address = ensureBase58Address(address);
            return base58Address.substring(0, 8) + '...' + base58Address.substring(base58Address.length - 6);
        }
        
        // Convert any address format to base58 (T... format)
        function ensureBase58Address(address) {
            if (!address) return address;
            
            // Already in base58 format
            if (address.startsWith('T')) {
                return address;
            }
            
            // Convert from hex to base58
            if (address.startsWith('41') && address.length > 40) {
                try {
                    return tronWeb.address.fromHex(address);
                } catch (e) {
                    console.error('Error converting address from hex to base58:', e);
                    return address; // Return original if conversion fails
                }
            }
            
            // Handle ethereum-style hex (0x...)
            if (address.startsWith('0x') && address.length === 42) {
                try {
                    return tronWeb.address.fromHex('41' + address.slice(2));
                } catch (e) {
                    console.error('Error converting address from 0x format to base58:', e);
                    return address;
                }
            }
            
            // Unknown format, return as-is with warning
            console.warn('Unknown address format:', address);
            return address;
        }
        
        // Server registration helper functions
        function generateServerId() {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 5);
            return `PS-${timestamp}-${random}`.toUpperCase();
        }
        
        function saveServerRegistration(address, data) {
            serverRegistrations[address] = data;
            try {
                localStorage.setItem('serverRegistrations', JSON.stringify(serverRegistrations));
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }
        
        function exportRegistrations() {
            const data = Object.values(serverRegistrations);
            if (data.length === 0) {
                uiManager.showNotification('info', 'No server registrations to export');
                return;
            }
            
            // Convert to CSV
            const headers = ['Server ID', 'Address', 'Agency Name', 'Agency Email', 'Server Name', 'Phone', 'Registered At', 'Registered By', 'Fee Exempt'];
            const csvData = [
                headers.join(','),
                ...data.map(reg => [
                    reg.serverId,
                    reg.address,
                    `"${reg.agencyName}"`,
                    reg.agencyEmail,
                    `"${reg.serverName}"`,
                    reg.serverPhone,
                    reg.registeredAt,
                    reg.registeredBy,
                    reg.feeExempt ? 'Yes' : 'No'
                ].join(','))
            ].join('\n');
            
            // Download file
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `process_servers_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            uiManager.showNotification('success', `Exported ${data.length} server registration(s)`);
        }
        
        // Toggle registration form visibility
        function toggleRegistrationForm() {
            const roleSelect = document.getElementById('roleSelect');
            const registrationForm = document.getElementById('serverRegistrationForm');
            const lawEnforcementSection = document.getElementById('lawEnforcementSection');
            
            if (registrationForm) {
                registrationForm.style.display = roleSelect.value === 'PROCESS_SERVER_ROLE' ? 'block' : 'none';
            }
            
            // Always show law enforcement section for any role
            if (lawEnforcementSection) {
                lawEnforcementSection.style.display = 'block';
            }
        }
        
        // Toggle stats section
        function toggleStats() {
            console.log('Toggle stats called');
            const statsSection = document.getElementById('statsSection');
            const toggleIcon = document.getElementById('statsToggleIcon');
            
            if (!statsSection || !toggleIcon) {
                console.error('Stats elements not found:', { statsSection, toggleIcon });
                return;
            }
            
            if (statsSection.style.display === 'none' || statsSection.style.display === '') {
                statsSection.style.display = 'grid';
                toggleIcon.className = 'fas fa-chevron-up';
            } else {
                statsSection.style.display = 'none';
                toggleIcon.className = 'fas fa-chevron-down';
            }
        }
        
        // Toggle wallet status section
        function toggleWalletStatus() {
            console.log('Toggle wallet status called');
            const walletContent = document.getElementById('walletStatusContent');
            const toggleIcon = document.getElementById('walletToggleIcon');
            
            if (!walletContent || !toggleIcon) {
                console.error('Wallet elements not found:', { walletContent, toggleIcon });
                return;
            }
            
            console.log('Current display:', walletContent.style.display);
            
            if (walletContent.style.display === 'none' || walletContent.style.display === '') {
                walletContent.style.display = 'block';
                toggleIcon.className = 'fas fa-chevron-up';
                console.log('Expanded wallet status');
            } else {
                walletContent.style.display = 'none';
                toggleIcon.className = 'fas fa-chevron-down';
                console.log('Collapsed wallet status');
            }
        }
        
        // Toggle contract section
        function toggleContract() {
            console.log('Toggle contract called');
            const contractContent = document.getElementById('contractContent');
            const toggleIcon = document.getElementById('contractToggleIcon');
            
            if (!contractContent || !toggleIcon) {
                console.error('Contract elements not found:', { contractContent, toggleIcon });
                return;
            }
            
            if (contractContent.style.display === 'none' || contractContent.style.display === '') {
                contractContent.style.display = 'block';
                toggleIcon.className = 'fas fa-chevron-up';
            } else {
                contractContent.style.display = 'none';
                toggleIcon.className = 'fas fa-chevron-down';
            }
        }
        
        // Get current network based on chain type
        function getCurrentNetwork() {
            // For TRON, we're using Nile testnet by default
            // You could add logic here to detect mainnet vs testnet
            return 'nile';
        }
        
        // Create address display with copy and TronScan link
        function createAddressDisplay(address, showFull = false) {
            if (!address || address === 'N/A') return 'N/A';
            
            const displayAddress = showFull ? address : formatAddress(address);
            const network = currentChainType === 'tron' ? getCurrentNetwork() : 'mainnet';
            const explorerUrl = CHAIN_CONFIG[currentChainType][network].explorerUrl;
            
            return `
                <span class="address-display">
                    <span class="address-text">${displayAddress}</span>
                    <button class="btn-icon-small" onclick="copyAddress('${address}')" title="Copy address">
                        <i class="fas fa-copy"></i>
                    </button>
                    <a href="${explorerUrl}/#/address/${address}" target="_blank" class="btn-icon-small" title="View on explorer">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </span>
            `;
        }
        
        // Copy address to clipboard
        function copyAddress(address) {
            navigator.clipboard.writeText(address).then(() => {
                uiManager.showNotification('success', 'Address copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                uiManager.showNotification('error', 'Failed to copy address');
            });
        }

        function getDocumentTypeString(docType) {
            const documentTypes = [
                'Summons',
                'Complaint',
                'Subpoena',
                'Notice of Hearing',
                'Notice of Seizure',
                'Other'
            ];
            return documentTypes[docType] || 'Unknown';
        }

        function getJurisdictionString(jurisdictionIndex) {
            const jurisdictions = [
                'Federal',
                'State',
                'County',
                'Municipal',
                'Other'
            ];
            return jurisdictions[jurisdictionIndex] || 'Unknown';
        }
        
        function getContractScanUrl() {
            const network = document.getElementById('networkName').textContent;
            let baseUrl = 'https://tronscan.org/#/contract/';
            
            if (network.includes('Nile')) {
                baseUrl = 'https://nile.tronscan.org/#/contract/';
            } else if (network.includes('Shasta')) {
                baseUrl = 'https://shasta.tronscan.org/#/contract/';
            }
            
            return baseUrl + (legalContract ? legalContract.address : '');
        }
        
        function getTxScanUrl() {
            const network = document.getElementById('networkName').textContent;
            let baseUrl = 'https://tronscan.org/#/transaction/';
            
            if (network.includes('Nile')) {
                baseUrl = 'https://nile.tronscan.org/#/transaction/';
            } else if (network.includes('Shasta')) {
                baseUrl = 'https://shasta.tronscan.org/#/transaction/';
            }
            
            return baseUrl;
        }

        function getStatusString(status) {
            const statuses = [
                'Pending',
                'Served',
                'Accepted',
                'Expired',
                'Cancelled'
            ];
            return statuses[status] || 'Unknown';
        }

        function getTimeRemaining(timestamp) {
            const created = new Date(parseInt(timestamp) * 1000);
            const expires = new Date(created.getTime() + (7 * 24 * 60 * 60 * 1000)); // 7 days
            const now = new Date();
            
            if (now > expires) {
                return '<span style="color: var(--error);">Expired</span>';
            }
            
            const diff = expires - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            if (days > 0) {
                return `${days} day${days > 1 ? 's' : ''} ${hours} hour${hours > 1 ? 's' : ''}`;
            } else if (hours > 0) {
                return `${hours} hour${hours > 1 ? 's' : ''}`;
            } else {
                return '<span style="color: var(--warning);">Less than 1 hour</span>';
            }
        }

        // Get server address from LegalNoticeCreated event
        async function getServerFromEvent(noticeId) {
            try {
                const events = await tronWeb.event.getEventsByContractAddress(
                    CONTRACT_ADDRESS,
                    {
                        eventName: 'LegalNoticeCreated',
                        onlyConfirmed: true,
                        orderBy: 'block_timestamp,desc',
                        limit: 200
                    }
                );
                
                if (events && events.data) {
                    const noticeEvent = events.data.find(e => 
                        e.result && e.result.noticeId && e.result.noticeId.toString() === noticeId.toString()
                    );
                    
                    if (noticeEvent && noticeEvent.result.server) {
                        // The server address is in the event topics (indexed parameter)
                        const serverHex = noticeEvent.result.server;
                        const serverAddress = tronWeb.address.fromHex(serverHex);
                        console.log(`Notice ${noticeId} server from event: ${serverAddress}`);
                        return serverAddress;
                    }
                }
            } catch (error) {
                console.error('Error getting server from event:', error);
            }
            return null;
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        // ======================
        // AUDIT TRAIL FUNCTIONALITY
        // ======================
        
        async function viewNoticeAuditTrail(noticeId) {
            if (!window.BACKEND_API_URL) {
                uiManager.showNotification('info', 'Audit trail requires backend connection');
                return;
            }
            
            try {
                showProcessing('Loading audit trail...');
                
                const serverAddress = tronWeb && tronWeb.defaultAddress ? tronWeb.defaultAddress.base58 : '';
                const response = await fetch(`${window.BACKEND_API_URL}/api/notices/${noticeId}/audit?serverAddress=${serverAddress}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch audit trail');
                }
                
                const auditData = await response.json();
                console.log('=== AUDIT DATA DEBUG ===');
                console.log('Notice ID:', noticeId);
                console.log('Backend URL:', `${window.BACKEND_API_URL}/api/notices/${noticeId}/audit?serverAddress=${serverAddress}`);
                console.log('Raw audit data from backend:', auditData);
                
                // Filter out test data
                if (auditData.views) {
                    auditData.views = auditData.views.filter(view => {
                        // Remove test entries
                        if (view.viewer_address && view.viewer_address.includes('TEST')) return false;
                        if (view.ip_address && view.ip_address === '127.0.0.1') return false;
                        return true;
                    });
                }
                
                if (auditData.acceptances) {
                    auditData.acceptances = auditData.acceptances.filter(acc => {
                        // Remove test entries
                        if (acc.acceptor_address && acc.acceptor_address.includes('TEST')) return false;
                        if (acc.ip_address && acc.ip_address === '127.0.0.1') return false;
                        return true;
                    });
                }
                console.log('Number of views:', auditData.views ? auditData.views.length : 0);
                console.log('View data sample:', auditData.views ? auditData.views.slice(0, 2) : 'none');
                hideProcessing();
                
                // Check blockchain status (using cache)
                let blockchainAccepted = false;
                try {
                    const alertData = window.blockchainCache ? 
                        await window.blockchainCache.getAlertNotice(noticeId) : 
                        await legalContract.alertNotices(noticeId).call();
                    if (alertData && Array.isArray(alertData) && alertData.length > 4) {
                        blockchainAccepted = alertData[4] === true;
                    }
                } catch (e) {
                    console.log('Could not fetch blockchain status:', e);
                }
                
                // Use blockchain status if backend doesn't have it
                if (blockchainAccepted && !auditData.summary.accepted) {
                    auditData.summary.accepted = true;
                }
                
                // Log what we're about to display
                console.log('=== DISPLAYING AUDIT TRAIL ===');
                console.log('Views to display:', auditData.views);
                console.log('First view (if any):', auditData.views && auditData.views[0]);
                
                // Check if views data looks like test data
                if (auditData.views && auditData.views.length > 0) {
                    const firstView = auditData.views[0];
                    if (firstView.ip_address && firstView.ip_address.includes('127.0.0.1')) {
                        console.warn('WARNING: Test/localhost IP detected in audit data!');
                    }
                }
                
                // Create modal to display audit trail
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px; background: white; color: #1e293b;">
                        <div class="modal-header">
                            <h2 style="color: #1e293b;"><i class="fas fa-history"></i> Audit Trail - Notice #${noticeId}</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" style="color: #1e293b;">
                            <div class="audit-summary" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                <h3 style="margin-bottom: 1rem; color: #1e293b;">Summary</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                    <div>
                                        <div style="color: #64748b; font-size: 0.875rem;">Total Views</div>
                                        <div style="font-size: 1.5rem; font-weight: bold; color: #1e293b;">${auditData.summary.totalViews || 0}</div>
                                    </div>
                                    <div>
                                        <div style="color: #64748b; font-size: 0.875rem;">Unique Viewers</div>
                                        <div style="font-size: 1.5rem; font-weight: bold; color: #1e293b;">${auditData.summary.uniqueViewers || 0}</div>
                                    </div>
                                    <div>
                                        <div style="color: #64748b; font-size: 0.875rem;">Status</div>
                                        <div style="font-size: 1.5rem; font-weight: bold; color: ${blockchainAccepted ? '#22c55e' : '#f59e0b'};">
                                            ${blockchainAccepted ? 'Accepted' : 'Pending'}
                                        </div>
                                    </div>
                                </div>
                                ${auditData.summary.firstViewedAt ? `
                                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                            <span style="color: #64748b;">First Viewed:</span>
                                            <span style="color: #1e293b;">${new Date(auditData.summary.firstViewedAt).toLocaleString()}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: #64748b;">Last Viewed:</span>
                                            <span style="color: #1e293b;">${new Date(auditData.summary.lastViewedAt).toLocaleString()}</span>
                                        </div>
                                    </div>
                                ` : ''}
                                ${blockchainAccepted ? `
                                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                                        <span style="color: #64748b;">Accepted At:</span>
                                        <span style="color: #22c55e; font-weight: bold;">
                                            ${auditData.summary.acceptedAt ? new Date(auditData.summary.acceptedAt).toLocaleString() : 'Verified on blockchain'}
                                        </span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${auditData.acceptances.length > 0 ? `
                                <div class="acceptance-details" style="background: #d1fae5; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #10b981;">
                                    <h3 style="color: #059669; margin-bottom: 1rem;"><i class="fas fa-check-circle"></i> Acceptance Details</h3>
                                    ${auditData.acceptances.map(acc => `
                                        <div style="background: white; padding: 1rem; border-radius: 6px;">
                                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem;">
                                                <strong>Wallet:</strong> <code>${acc.acceptor_address}</code>
                                                <strong>TX Hash:</strong> <code>${acc.transaction_hash}</code>
                                                <strong>IP Address:</strong> <span>${acc.ip_address || acc.real_ip}</span>
                                                <strong>Time:</strong> <span>${new Date(acc.accepted_at).toLocaleString()}</span>
                                                ${acc.location_data ? `
                                                    <strong>Location:</strong> 
                                                    <span>${acc.location_data.city}, ${acc.location_data.region}, ${acc.location_data.country}</span>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <div class="view-logs">
                                <h3 style="margin-bottom: 1rem; color: #1e293b;">View History</h3>
                                ${auditData.views && auditData.views.length > 0 ? `
                                    <div style="overflow-x: auto;">
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="background: #f8f9fa;">
                                                    <th style="padding: 0.75rem; text-align: left; color: #1e293b;">Time</th>
                                                    <th style="padding: 0.75rem; text-align: left; color: #1e293b;">Viewer</th>
                                                    <th style="padding: 0.75rem; text-align: left; color: #1e293b;">IP Address</th>
                                                    <th style="padding: 0.75rem; text-align: left; color: #1e293b;">Location</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${auditData.views.map((view, i) => `
                                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                                        <td style="padding: 0.75rem; color: #475569;">${new Date(view.viewed_at).toLocaleString()}</td>
                                                        <td style="padding: 0.75rem; color: #475569;">
                                                            ${view.viewer_address && view.viewer_address !== 'anonymous' 
                                                                ? `<code style="font-size: 0.875rem; color: #0891b2;">${formatAddress(view.viewer_address)}</code>` 
                                                                : '<span style="color: #94a3b8;">Anonymous</span>'
                                                            }
                                                        </td>
                                                        <td style="padding: 0.75rem; color: #475569;">${view.ip_address || view.real_ip || 'N/A'}</td>
                                                        <td style="padding: 0.75rem; color: #475569;">
                                                            ${view.location_data 
                                                                ? `${typeof view.location_data === 'string' ? JSON.parse(view.location_data).city || 'Unknown' : view.location_data.city || 'Unknown'}, ${typeof view.location_data === 'string' ? JSON.parse(view.location_data).country || 'Unknown' : view.location_data.country || 'Unknown'}`
                                                                : 'N/A'
                                                            }
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : '<p style="color: #64748b;">No views recorded yet. Views will appear here when recipients access the notice.</p>'}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i> Close
                            </button>
                            <button class="btn btn-primary" onclick="exportAuditTrail('${noticeId}', ${JSON.stringify(auditData).replace(/"/g, '&quot;')})">
                                <i class="fas fa-file-export"></i> Export Report
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
            } catch (error) {
                hideProcessing();
                console.error('Error fetching audit trail:', error);
                
                // Show fallback audit trail with blockchain link
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; background: white; color: #1e293b;">
                        <div class="modal-header">
                            <h2 style="color: #1e293b;"><i class="fas fa-history"></i> Notice Verification</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" style="color: #1e293b;">
                            <div class="alert alert-warning" style="background: #fef3c7; border: 1px solid #f59e0b; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; color: #92400e;">
                                <i class="fas fa-exclamation-triangle"></i> 
                                Backend audit service is currently offline. You can verify the notice directly on the blockchain.
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                                <h3 style="color: #1e293b; margin-bottom: 1rem;">Blockchain Verification</h3>
                                <p style="margin-bottom: 1rem;">Verify this notice on TronScan:</p>
                                
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <a href="${getTronScanUrl()}/#/contract/${legalContract.address}" 
                                       target="_blank" 
                                       class="btn btn-primary" 
                                       style="text-align: center;">
                                        <i class="fas fa-external-link-alt"></i> View Contract on TronScan
                                    </a>
                                    
                                    <button class="btn btn-secondary" onclick="copyToClipboard('${legalContract.address}')">
                                        <i class="fas fa-copy"></i> Copy Contract Address
                                    </button>
                                    
                                    <div style="margin-top: 1rem; padding: 1rem; background: white; border: 1px solid #e5e7eb; border-radius: 4px;">
                                        <strong>Contract:</strong> ${legalContract.address}<br>
                                        <strong>Notice ID:</strong> ${noticeId}<br>
                                        <strong>Network:</strong> TRON ${tronWeb.fullNode.host.includes('nile') ? 'Nile Testnet' : 'Mainnet'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }
        
        window.viewNoticeAuditTrail = viewNoticeAuditTrail;
        
        // Get TronScan URL based on network
        function getTronScanUrl() {
            if (tronWeb && tronWeb.fullNode && tronWeb.fullNode.host) {
                if (tronWeb.fullNode.host.includes('nile')) {
                    return 'https://nile.tronscan.org';
                } else if (tronWeb.fullNode.host.includes('shasta')) {
                    return 'https://shasta.tronscan.org';
                } else {
                    return 'https://tronscan.org';
                }
            }
            return 'https://tronscan.org';
        }
        
        // Copy to clipboard helper
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            uiManager.showNotification('success', 'Copied to clipboard!');
        }
        
        // View wallet connection history
        async function viewWalletConnectionHistory(walletAddress) {
            if (!window.BACKEND_API_URL) {
                uiManager.showNotification('info', 'Connection history requires backend');
                return;
            }
            
            try {
                showProcessing('Loading connection history...');
                
                const response = await fetch(`${window.BACKEND_API_URL}/api/wallets/${walletAddress}/connections`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch connection history');
                }
                
                const connections = await response.json();
                hideProcessing();
                
                // Create modal to display connection history
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.onclick = (e) => {
                    if (e.target === modal) modal.remove();
                };
                
                let html = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3>Wallet Connection History</h3>
                            <button class="btn-icon" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 1rem;">
                                <strong>Wallet:</strong> ${walletAddress}
                            </div>
                `;
                
                if (connections.length === 0) {
                    html += '<p>No connection history found for this wallet.</p>';
                } else {
                    html += `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--border-color);">
                                    <th style="padding: 0.75rem; text-align: left;">Date</th>
                                    <th style="padding: 0.75rem; text-align: left;">Type</th>
                                    <th style="padding: 0.75rem; text-align: left;">IP Address</th>
                                    <th style="padding: 0.75rem; text-align: left;">Location</th>
                                    <th style="padding: 0.75rem; text-align: left;">Notices</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    connections.forEach(conn => {
                        const location = conn.location_data || {};
                        html += `
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.75rem;">${new Date(conn.connected_at).toLocaleString()}</td>
                                <td style="padding: 0.75rem;">
                                    <span class="badge ${conn.event_type === 'wallet_connected' ? 'badge-success' : 'badge-info'}">
                                        ${conn.event_type === 'wallet_connected' ? 'Connected' : 'Manual Query'}
                                    </span>
                                </td>
                                <td style="padding: 0.75rem; font-family: monospace;">${conn.ip_address || 'Unknown'}</td>
                                <td style="padding: 0.75rem;">
                                    ${location.city || ''} ${location.region || ''} ${location.country || ''}
                                </td>
                                <td style="padding: 0.75rem;">
                                    ${conn.notice_count > 0 ? `<span class="badge badge-warning">${conn.notice_count}</span>` : '-'}
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                modal.innerHTML = html;
                document.body.appendChild(modal);
                
            } catch (error) {
                hideProcessing();
                console.error('Error fetching connection history:', error);
                uiManager.showNotification('error', 'Failed to load connection history');
            }
        }
        
        window.viewWalletConnectionHistory = viewWalletConnectionHistory;
        
        function exportAuditTrail(noticeId, auditData) {
            try {
                // Parse the audit data if it's a string
                if (typeof auditData === 'string') {
                    auditData = JSON.parse(auditData.replace(/&quot;/g, '"'));
                }
                
                // Create new PDF document
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Colors
                const primaryColor = [30, 41, 59]; // #1e293b
                const accentColor = [34, 197, 94]; // #22c55e
                const warningColor = [245, 158, 11]; // #f59e0b
                const infoColor = [59, 130, 246]; // #3b82f6
                
                // Add header
                doc.setFontSize(20);
                doc.setTextColor(...primaryColor);
                doc.text('BLOCKCHAIN AUDIT TRAIL REPORT', 105, 20, { align: 'center' });
                
                // Add subtitle
                doc.setFontSize(12);
                doc.setTextColor(100, 116, 139);
                doc.text('Legal Notice Service Verification & Document Access History', 105, 28, { align: 'center' });
                
                // Report metadata box
                doc.setFillColor(248, 250, 252);
                doc.rect(15, 35, 180, 45, 'F');
                
                // Report info
                doc.setFontSize(10);
                doc.setTextColor(...primaryColor);
                doc.text(`Notice ID: ${noticeId}`, 20, 42);
                doc.text(`Report Generated: ${new Date().toLocaleString()}`, 20, 48);
                doc.text(`Generated By Wallet: ${tronWeb.defaultAddress ? tronWeb.defaultAddress.base58 : 'Unknown'}`, 20, 54);
                doc.text(`Contract Address: ${legalContract.address}`, 20, 60);
                doc.text(`Network: TRON ${tronWeb.fullNode.host.includes('nile') ? 'Nile Testnet' : 'Mainnet'}`, 20, 66);
                doc.text(`Report Version: 2.0`, 20, 72);
                
                // Add explanation box
                doc.setFillColor(240, 249, 255);
                doc.rect(15, 85, 180, 25, 'F');
                doc.setFontSize(9);
                doc.setTextColor(...infoColor);
                doc.text('ABOUT THIS REPORT:', 20, 92);
                doc.setTextColor(71, 85, 105);
                doc.text('This audit trail provides cryptographically verified proof of document delivery,', 20, 98);
                doc.text('access attempts, and recipient interactions. All data is immutably stored on', 20, 102);
                doc.text('the TRON blockchain and cross-referenced with our secure tracking database.', 20, 106);
                
                // Draw line
                doc.setDrawColor(226, 232, 240); // #e2e8f0
                doc.line(20, 115, 190, 115);
                
                // Summary section
                let yPos = 125;
                doc.setFontSize(14);
                doc.setTextColor(...primaryColor);
                doc.text('DELIVERY & ACCESS SUMMARY', 20, yPos);
                
                yPos += 10;
                doc.setFontSize(10);
                doc.setTextColor(71, 85, 105); // #475569
                
                // Left column
                doc.text(`Notice ID: ${noticeId}`, 20, yPos);
                doc.text(`Total Document Access Attempts: ${auditData.summary.totalViews || 0}`, 20, yPos + 6);
                doc.text(`Unique Wallet Addresses: ${auditData.summary.uniqueViewers || 0}`, 20, yPos + 12);
                doc.text(`Database Entries: ${(auditData.views || []).length + (auditData.acceptances || []).length}`, 20, yPos + 18);
                
                // Right column - Status
                doc.text('Legal Notice Status: ', 110, yPos);
                if (auditData.summary.accepted) {
                    doc.setTextColor(...accentColor);
                    doc.text('ACCEPTED & SIGNED', 150, yPos);
                } else {
                    doc.setTextColor(...warningColor);
                    doc.text('PENDING SIGNATURE', 150, yPos);
                }
                
                doc.setTextColor(71, 85, 105);
                if (auditData.summary.firstViewedAt) {
                    doc.text(`First Access: ${new Date(auditData.summary.firstViewedAt).toLocaleString()}`, 110, yPos + 6);
                    doc.text(`Last Access: ${new Date(auditData.summary.lastViewedAt).toLocaleString()}`, 110, yPos + 12);
                }
                if (auditData.summary.acceptedAt) {
                    doc.setTextColor(...accentColor);
                    doc.text(`Digital Signature: ${new Date(auditData.summary.acceptedAt).toLocaleString()}`, 110, yPos + 18);
                    doc.setTextColor(71, 85, 105);
                }
                
                yPos += 24;
                
                // Acceptance Details
                if (auditData.acceptances && auditData.acceptances.length > 0) {
                    yPos += 10;
                    doc.setFontSize(14);
                    doc.setTextColor(...primaryColor);
                    doc.text('ACCEPTANCE DETAILS', 20, yPos);
                    
                    yPos += 10;
                    doc.setFontSize(9);
                    auditData.acceptances.forEach(acc => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        doc.setTextColor(71, 85, 105);
                        doc.text(`Wallet: ${acc.acceptor_address}`, 20, yPos);
                        yPos += 5;
                        doc.text(`TX Hash: ${acc.transaction_hash}`, 20, yPos);
                        yPos += 5;
                        doc.text(`IP Address: ${acc.ip_address || acc.real_ip || 'N/A'}`, 20, yPos);
                        yPos += 5;
                        doc.text(`Time: ${new Date(acc.accepted_at).toLocaleString()}`, 20, yPos);
                        yPos += 5;
                        if (acc.location_data) {
                            const loc = typeof acc.location_data === 'string' ? JSON.parse(acc.location_data) : acc.location_data;
                            doc.text(`Location: ${loc.city || 'Unknown'}, ${loc.region || ''}, ${loc.country || 'Unknown'}`, 20, yPos);
                            yPos += 5;
                        }
                        yPos += 5;
                    });
                }
                
                // View History
                if (auditData.views && auditData.views.length > 0) {
                    yPos += 10;
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setTextColor(...primaryColor);
                    doc.text('DOCUMENT ACCESS LOG', 20, yPos);
                    
                    // Add explanation
                    yPos += 8;
                    doc.setFontSize(8);
                    doc.setTextColor(100, 116, 139);
                    doc.text('Each access attempt is logged with IP geolocation, wallet verification, and timestamp data', 20, yPos);
                    
                    yPos += 8;
                    doc.setFontSize(9);
                    
                    // Table headers
                    doc.setFillColor(248, 250, 252); // #f8fafc
                    doc.rect(20, yPos - 5, 170, 8, 'F');
                    doc.setTextColor(...primaryColor);
                    doc.text('Timestamp (Local)', 22, yPos);
                    doc.text('Wallet Address', 60, yPos);
                    doc.text('IP Address', 110, yPos);
                    doc.text('Location', 145, yPos);
                    
                    yPos += 8;
                    doc.setTextColor(71, 85, 105);
                    
                    auditData.views.forEach((view, index) => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        // Alternate row colors
                        if (index % 2 === 0) {
                            doc.setFillColor(248, 250, 252);
                            doc.rect(20, yPos - 4, 170, 6, 'F');
                        }
                        
                        const viewTime = new Date(view.viewed_at).toLocaleString();
                        doc.text(viewTime.substring(0, 16), 22, yPos);
                        
                        const viewer = view.viewer_address && view.viewer_address !== 'anonymous' 
                            ? view.viewer_address.substring(0, 10) + '...' 
                            : 'Anonymous';
                        doc.text(viewer, 60, yPos);
                        
                        const ipDisplay = view.real_ip || view.ip_address || 'N/A';
                        doc.text(ipDisplay.split(',')[0].trim().substring(0, 15), 110, yPos);
                        
                        if (view.location_data) {
                            const loc = typeof view.location_data === 'string' ? JSON.parse(view.location_data) : view.location_data;
                            const location = `${loc.city || '?'}, ${loc.region || ''} ${loc.country || ''}`;
                            doc.text(location.substring(0, 22).trim(), 145, yPos);
                        } else {
                            doc.text('Unknown', 145, yPos);
                        }
                        
                        yPos += 6;
                    });
                }
                
                // Add verification instructions
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                } else {
                    yPos += 15;
                }
                
                doc.setFillColor(254, 243, 199); // Light yellow background
                doc.rect(15, yPos - 5, 180, 35, 'F');
                
                doc.setFontSize(12);
                doc.setTextColor(...warningColor);
                doc.text('VERIFICATION INSTRUCTIONS', 20, yPos + 2);
                
                doc.setFontSize(9);
                doc.setTextColor(71, 85, 105);
                doc.text('To verify this data independently:', 20, yPos + 10);
                doc.text('1. Visit BlockServed.com or TheBlockService.com', 25, yPos + 16);
                doc.text('2. Connect the same wallet used to generate this report', 25, yPos + 20);
                doc.text('3. Use "Audit Notice" feature with Notice ID to cross-reference', 25, yPos + 24);
                doc.text('4. All blockchain transactions can be verified at TronScan.org', 25, yPos + 28);
                
                // Footer
                doc.setFontSize(8);
                doc.setTextColor(148, 163, 184); // #94a3b8
                doc.text('Generated by NFT Legal Service - Blockchain Document Delivery System', 105, 285, { align: 'center' });
                doc.text(`Smart Contract: ${legalContract.address} | Generated: ${new Date().toISOString()}`, 105, 290, { align: 'center' });
                
                // Save the PDF
                doc.save(`audit_trail_notice_${noticeId}_${Date.now()}.pdf`);
                
                uiManager.showNotification('success', 'Audit trail exported as PDF successfully');
            } catch (error) {
                console.error('Error generating PDF:', error);
                uiManager.showNotification('error', 'Failed to generate PDF report');
            }
        }
        
        window.exportAuditTrail = exportAuditTrail;

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function calculateBase64Size(base64String) {
            // Calculate approximate size of base64 string
            const padding = (base64String.charAt(base64String.length - 2) === '=') ? 2 :
                           (base64String.charAt(base64String.length - 1) === '=') ? 1 : 0;
            return (base64String.length * 3) / 4 - padding;
        }

        function getErrorMessage(error) {
            if (error.message) {
                if (error.message.includes('revert')) {
                    const revertReason = error.message.split('revert')[1].trim();
                    return 'Transaction reverted: ' + revertReason;
                } else if (error.message.includes('User rejected')) {
                    return 'Transaction cancelled by user';
                } else if (error.message.includes('insufficient')) {
                    return 'Insufficient balance or energy';
                } else if (error.message.includes('Not authorized')) {
                    return 'You need Process Server role to perform this action';
                } else {
                    return error.message;
                }
            }
            return 'An unknown error occurred';
        }

        // Copy wallet address function
        function copyWalletAddress() {
            const address = tronWeb.defaultAddress.base58;
            navigator.clipboard.writeText(address).then(() => {
                uiManager.showNotification('success', 'Address copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                uiManager.showNotification('error', 'Failed to copy address');
            });
        }

        // Validation functions
        function validateRecipientAddress() {
            const input = document.getElementById('mintRecipient');
            const validationMsg = document.getElementById('recipientValidation');
            const address = input.value.trim();
            
            if (!address) {
                input.classList.remove('valid', 'invalid');
                validationMsg.style.display = 'none';
                return;
            }
            
            if (tronWeb.isAddress(address)) {
                input.classList.remove('invalid');
                input.classList.add('valid');
                validationMsg.className = 'validation-message success';
                validationMsg.innerHTML = '<i class="fas fa-check-circle"></i> Valid TRON address';
                validationMsg.style.display = 'flex';
            } else {
                input.classList.remove('valid');
                input.classList.add('invalid');
                validationMsg.className = 'validation-message error';
                validationMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Invalid TRON address';
                validationMsg.style.display = 'flex';
            }
        }

        // Update admin tab visibility based on admin status
        function updateAdminTabVisibility() {
            const adminTabButton = document.getElementById('adminTabButton');
            if (adminTabButton) {
                adminTabButton.style.display = isAdmin ? 'inline-flex' : 'none';
            }
        }

        // Debug function to check roles and registrations
        async function debugCheckRoles() {
            const debugDiv = document.getElementById('debugOutput');
            const debugContent = document.getElementById('debugContent');
            
            if (!legalContract || !tronWeb || !tronWeb.defaultAddress) {
                debugContent.innerHTML = '<span style="color: var(--error);">Contract not connected or wallet not connected</span>';
                debugDiv.style.display = 'block';
                return;
            }
            
            debugContent.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking roles and registrations...';
            debugDiv.style.display = 'block';
            
            try {
                const address = tronWeb.defaultAddress.base58;
                let debugInfo = '<div style="font-family: monospace; font-size: 0.8rem;">';
                let plainTextDebug = ''; // For copying
                
                debugInfo += `<strong>Your Address:</strong> ${address}<br><br>`;
                plainTextDebug += `Your Address: ${address}\n\n`;
                
                // Check roles - including DEFAULT_ADMIN_ROLE
                const DEFAULT_ADMIN_ROLE = '0x0000000000000000000000000000000000000000000000000000000000000000';
                const adminRoleBytes = tronWeb.sha3('ADMIN_ROLE');
                const processServerRoleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                
                console.log('=== ADMIN ROLE DEBUG ===');
                console.log('DEFAULT_ADMIN_ROLE:', DEFAULT_ADMIN_ROLE);
                console.log('ADMIN_ROLE hash:', adminRoleBytes);
                console.log('Current address:', address);
                
                const hasDefaultAdminRole = await legalContract.hasRole(DEFAULT_ADMIN_ROLE, address).call();
                const hasAdminRole = await legalContract.hasRole(adminRoleBytes, address).call();
                const hasProcessServerRole = await legalContract.hasRole(processServerRoleBytes, address).call();
                
                console.log('Has DEFAULT_ADMIN_ROLE:', hasDefaultAdminRole);
                console.log('Has ADMIN_ROLE:', hasAdminRole);
                
                // Complete contract doesn't have getRoleMemberCount/getRoleMember functions
                // Role membership would need to be tracked differently
                /*
                const defaultAdminCount = await legalContract.getRoleMemberCount(DEFAULT_ADMIN_ROLE).call();
                const adminCount = await legalContract.getRoleMemberCount(adminRoleBytes).call();
                
                console.log('DEFAULT_ADMIN_ROLE member count:', defaultAdminCount.toString());
                console.log('ADMIN_ROLE member count:', adminCount.toString());
                
                // Get first member of each admin role
                if (defaultAdminCount > 0) {
                    const firstDefaultAdmin = await legalContract.getRoleMember(DEFAULT_ADMIN_ROLE, 0).call();
                    console.log('First DEFAULT_ADMIN_ROLE member:', firstDefaultAdmin);
                }
                
                if (adminCount > 0) {
                    const firstAdmin = await legalContract.getRoleMember(adminRoleBytes, 0).call();
                    console.log('First ADMIN_ROLE member:', firstAdmin);
                }
                */
                
                debugInfo += `<strong>Roles:</strong><br>`;
                debugInfo += `- Admin Role: ${hasAdminRole ? ' YES' : ' NO'}<br>`;
                debugInfo += `- Process Server Role: ${hasProcessServerRole ? ' YES' : ' NO'}<br><br>`;
                
                plainTextDebug += `Roles:\n`;
                plainTextDebug += `- Admin Role: ${hasAdminRole ? 'YES' : 'NO'}\n`;
                plainTextDebug += `- Process Server Role: ${hasProcessServerRole ? 'YES' : 'NO'}\n\n`;
                
                // Check fee exemptions
                const isLawEnforcement = await legalContract.serviceFeeExemptions(address).call();
                const serviceFeeExempt = isLawEnforcement;
                const fullFeeExempt = isLawEnforcement;
                
                debugInfo += `<strong>Fee Exemptions:</strong><br>`;
                debugInfo += `- Service Fee Exempt: ${serviceFeeExempt ? ' YES' : ' NO'}<br>`;
                debugInfo += `- Full Fee Exempt: ${fullFeeExempt ? ' YES' : ' NO'}<br><br>`;
                
                plainTextDebug += `Fee Exemptions:\n`;
                plainTextDebug += `- Service Fee Exempt: ${serviceFeeExempt ? 'YES' : 'NO'}\n`;
                plainTextDebug += `- Full Fee Exempt: ${fullFeeExempt ? 'YES' : 'NO'}\n\n`;
                
                // Calculate actual fee
                const calculatedFee = await calculateFeeFromConstants(address);
                debugInfo += `<strong>Your Fee:</strong> ${tronWeb.fromSun(calculatedFee)} TRX<br><br>`;
                plainTextDebug += `Your Fee: ${tronWeb.fromSun(calculatedFee)} TRX\n\n`;
                
                // Check localStorage registrations
                const localRegs = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
                const yourReg = localRegs[address];
                
                debugInfo += `<strong>Local Registration:</strong><br>`;
                plainTextDebug += `Local Registration:\n`;
                
                if (yourReg) {
                    debugInfo += `- Status: ${yourReg.status}<br>`;
                    debugInfo += `- Server ID: ${yourReg.serverId || 'Not assigned'}<br>`;
                    debugInfo += `- Agency: ${yourReg.agencyName || yourReg.agency}<br>`;
                    
                    plainTextDebug += `- Status: ${yourReg.status}\n`;
                    plainTextDebug += `- Server ID: ${yourReg.serverId || 'Not assigned'}\n`;
                    plainTextDebug += `- Agency: ${yourReg.agencyName || yourReg.agency}\n`;
                } else {
                    debugInfo += `- No registration found for ${address}<br>`;
                    debugInfo += `- All keys in localStorage: ${Object.keys(localRegs).join(', ') || 'None'}<br>`;
                    
                    plainTextDebug += `- No registration found for ${address}\n`;
                    plainTextDebug += `- All keys in localStorage: ${Object.keys(localRegs).join(', ') || 'None'}\n`;
                }
                
                debugInfo += '</div>';
                
                debugContent.innerHTML = debugInfo;
                
                // Store plain text for copying
                window.debugInfoPlainText = plainTextDebug;
                
                // Check if we need to show the fix button
                const fixBtn = document.getElementById('fixExemptionBtn');
                if ((hasProcessServerRole && !serviceFeeExempt && !fullFeeExempt && yourReg && yourReg.status === 'approved') || 
                    (hasAdminRole && !fullFeeExempt)) {
                    // User has role but no exemptions - show fix button
                    fixBtn.style.display = 'inline-flex';
                    if (hasAdminRole && !fullFeeExempt) {
                        debugInfo += '<br><div style="color: var(--warning); font-weight: bold;"> Admin accounts should have full fee exemption! Click "Fix Exemption" to apply it.</div>';
                    } else {
                        debugInfo += '<br><div style="color: var(--warning); font-weight: bold;"> Fee exemptions not applied! Click "Fix Exemption" to apply them.</div>';
                    }
                    debugContent.innerHTML = debugInfo + '</div>';
                } else {
                    fixBtn.style.display = 'none';
                }
                
                // Also refresh the main wallet status
                await updateWalletStatus();
                
            } catch (error) {
                console.error('Debug check error:', error);
                debugContent.innerHTML = `<span style="color: var(--error);">Error: ${error.message}</span>`;
                window.debugInfoPlainText = `Error: ${error.message}`;
            }
        }
        
        // Copy debug info to clipboard
        function copyDebugInfo() {
            if (window.debugInfoPlainText) {
                navigator.clipboard.writeText(window.debugInfoPlainText).then(() => {
                    uiManager.showNotification('success', 'Debug info copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    uiManager.showNotification('error', 'Failed to copy to clipboard');
                });
            }
        }
        
        // Fix fee exemption for approved process servers
        async function fixMyFeeExemption() {
            if (!legalContract || !tronWeb || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet and contract first');
                return;
            }
            
            const fixBtn = document.getElementById('fixExemptionBtn');
            fixBtn.disabled = true;
            fixBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fixing...';
            
            try {
                const address = tronWeb.defaultAddress.base58;
                
                // Check if user has admin role
                const adminRoleBytes = tronWeb.sha3('ADMIN_ROLE');
                const isAdmin = await legalContract.hasRole(adminRoleBytes, address).call();
                
                if (!isAdmin) {
                    uiManager.showNotification('error', 'You need admin role to fix exemptions. Contact an admin.');
                    return;
                }
                
                // Check if user is admin (reuse the check from above)
                const hasAdminRole = isAdmin;
                
                // Get registration info (not required for admins)
                const localRegs = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
                const yourReg = localRegs[address];
                
                if (!hasAdminRole && !yourReg) {
                    uiManager.showNotification('error', 'No registration found for your address');
                    return;
                }
                
                // Determine exemption type based on role and registration
                let serviceFeeExempt = false;
                let fullFeeExempt = false;
                
                if (hasAdminRole) {
                    // Admins always get full fee exemption
                    serviceFeeExempt = true;
                    fullFeeExempt = true;
                    uiManager.showNotification('info', 'Applying full fee exemption for admin...');
                } else if (yourReg) {
                    // Process servers get exemptions based on registration
                    serviceFeeExempt = yourReg.serviceFeeExempt !== false;
                    fullFeeExempt = yourReg.fullFeeExempt === true;
                    uiManager.showNotification('info', 'Applying fee exemptions...');
                } else {
                    uiManager.showNotification('error', 'No registration found and not an admin');
                    return;
                }
                
                // Apply the fee exemptions
                await legalContract.setFeeExemption(address, serviceFeeExempt, fullFeeExempt).send({
                    feeLimit: 20_000_000,
                    shouldPollResponse: true
                });
                
                uiManager.showNotification('success', 'Fee exemptions applied successfully!');
                
                // Refresh debug info
                await debugCheckRoles();
                
            } catch (error) {
                console.error('Fix exemption error:', error);
                uiManager.showNotification('error', 'Failed to apply exemptions: ' + error.message);
            } finally {
                fixBtn.disabled = false;
                fixBtn.innerHTML = '<i class="fas fa-wrench"></i> Fix Exemption';
            }
        }

        // Check contract resources (energy and bandwidth)
        async function checkContractResources() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            const statusDiv = document.getElementById('contractResourceStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking contract resources...';
            
            try {
                const contractAddress = legalContract.address;
                const account = await tronWeb.trx.getAccount(contractAddress);
                const resources = await tronWeb.trx.getAccountResources(contractAddress);
                
                // Calculate energy details
                const totalEnergy = resources.EnergyLimit || 0;
                const usedEnergy = resources.EnergyUsed || 0;
                const availableEnergy = totalEnergy - usedEnergy;
                const energyPerNotice = 500000;  // Updated to match actual usage
                const noticesAvailable = Math.floor(availableEnergy / energyPerNotice);
                
                // Calculate TRX staked for energy
                const frozenForEnergy = account.account_resource?.frozen_balance_for_energy?.frozen_balance || 0;
                const stakedTRX = tronWeb.fromSun(frozenForEnergy);
                
                // Get delegated energy info
                const delegatedEnergy = resources.EnergyLimit - (resources.EnergyUsed || 0);
                
                let html = `
                    <h4>Contract Resources</h4>
                    <div style="margin-top: 0.5rem;">
                        <strong>Contract Address:</strong> ${contractAddress}
                    </div>
                    <div style="margin-top: 1rem;">
                        <strong>Energy Status:</strong>
                        <div style="margin-left: 1rem; margin-top: 0.5rem;">
                            - Total Energy: ${totalEnergy.toLocaleString()}<br>
                            - Used Energy: ${usedEnergy.toLocaleString()}<br>
                            - Available Energy: ${availableEnergy.toLocaleString()}<br>
                            - Notices Available: ${noticesAvailable} (at ~500k energy each)<br>
                            - TRX Staked for Energy: ${stakedTRX} TRX
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <strong>Recommendations:</strong>
                        <div style="margin-left: 1rem; margin-top: 0.5rem;">
                `;
                
                if (noticesAvailable < 10) {
                    html += `<div style="color: var(--warning);"> Low energy! Consider delegating more energy to support user transactions.</div>`;
                } else {
                    html += `<div style="color: var(--success);"> Sufficient energy for ${noticesAvailable} notices</div>`;
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                statusDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error checking resources:', error);
                statusDiv.innerHTML = '<div style="color: var(--error);">Error checking resources: ' + error.message + '</div>';
            }
        }
        
        // Show delegate energy modal
        function showDelegateEnergyModal() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            // For now, show instructions
            const modal = confirm(
                'Energy Delegation Instructions:\n\n' +
                '1. Visit tronscan.org\n' +
                '2. Connect your wallet\n' +
                '3. Go to "Stake 2.0" section\n' +
                '4. Select "Delegate Resource"\n' +
                '5. Enter contract address: ' + legalContract.address + '\n' +
                '6. Choose "Energy" resource type\n' +
                '7. Enter amount to delegate (10,000 TRX = ~250k energy/day)\n\n' +
                'Would you like to copy the contract address?'
            );
            
            if (modal) {
                navigator.clipboard.writeText(legalContract.address).then(() => {
                    uiManager.showNotification('success', 'Contract address copied to clipboard!');
                });
            }
        }
        
        // Energy rental configuration - DEPRECATED - Now using EnergyRental module
        // Keeping for backward compatibility temporarily
        window.ENERGY_RENTAL_CONFIG = {
            energyPerNotice: 500000,  // Used by old code
            energyBuffer: 1.2,
            minEnergyThreshold: 50000
        };
        
        // Check if energy rental is needed
        async function checkEnergyNeeded(requiredEnergy) {
            try {
                const resources = await tronWeb.trx.getAccountResources(tronWeb.defaultAddress.base58);
                const availableEnergy = (resources.EnergyLimit || 0) - (resources.EnergyUsed || 0);
                
                console.log('Energy check:', {
                    required: requiredEnergy,
                    available: availableEnergy,
                    needsRental: availableEnergy < requiredEnergy
                });
                
                if (availableEnergy < requiredEnergy) {
                    return requiredEnergy - availableEnergy;
                }
                return 0;
            } catch (error) {
                console.error('Error checking energy:', error);
                // If check fails, assume we need full amount
                return requiredEnergy;
            }
        }
        
        // Estimate energy rental cost
        async function estimateEnergyRentalCost(energyAmount) {
            try {
                // TRONSave pricing: typically 10-15 TRX per 100k energy
                // We'll use a conservative estimate
                const unitsNeeded = Math.ceil(energyAmount / 100000);
                const pricePerUnit = 12; // TRX per 100k energy
                const rentalCost = unitsNeeded * pricePerUnit;
                
                console.log('Energy rental estimate:', {
                    energyAmount,
                    unitsNeeded,
                    pricePerUnit,
                    totalCost: rentalCost
                });
                
                return rentalCost;
            } catch (error) {
                console.error('Error estimating rental cost:', error);
                // Return conservative estimate
                return Math.ceil(energyAmount / 100000) * 15;
            }
        }
        
        // JustLend Energy Rental Service Configuration
        const JUSTLEND_CONFIG = {
            mainnet: {
                contract: 'TJSMvYJPASTsQFnDr9tw5s3YD9GQQmJcFg', // JustLend Energy Market
                api: 'https://api.justlend.org/v1/energy'
            },
            testnet: {
                // Testnet doesn't have JustLend, use manual approach
                useManual: true
            }
        };

        // Rent energy automatically
        async function rentEnergyIfNeeded(requiredEnergy) {
            try {
                const energyNeeded = await checkEnergyNeeded(requiredEnergy);
                
                if (energyNeeded <= ENERGY_RENTAL_CONFIG.minEnergyThreshold) {
                    console.log('Sufficient energy available, no rental needed');
                    return { success: true, rented: false, cost: 0 };
                }
                
                // Add buffer to energy needed
                const energyToRent = Math.ceil(energyNeeded * ENERGY_RENTAL_CONFIG.energyBuffer);
                
                console.log('Renting energy:', {
                    needed: energyNeeded,
                    renting: energyToRent,
                    network: currentNetwork
                });
                
                // Estimate rental cost
                const rentalCost = await estimateEnergyRentalCost(energyToRent);
                
                // For testnet, show warning and proceed
                if (currentNetwork === 'testnet' || currentNetwork === 'nile') {
                    const userConfirmed = confirm(
                        ` Energy Required\n\n` +
                        `This transaction requires ${energyToRent.toLocaleString()} energy.\n` +
                        `Estimated cost: ~${rentalCost} TRX\n\n` +
                        `On testnet, energy will be burned from your TRX balance.\n` +
                        `On mainnet, we'll automatically rent energy for you.\n\n` +
                        `Continue?`
                    );
                    
                    if (!userConfirmed) {
                        return { 
                            success: false, 
                            error: 'User cancelled due to energy requirement' 
                        };
                    }
                    
                    return {
                        success: true,
                        rented: false,
                        amount: energyToRent,
                        cost: rentalCost,
                        warning: 'Testnet: Energy will be burned from TRX balance'
                    };
                }
                
                // For mainnet, attempt to rent energy via JustLend
                try {
                    // Show rental notification
                    uiManager.showNotification('info', `Renting ${energyToRent.toLocaleString()} energy for ~${rentalCost} TRX...`);
                    
                    // Rent energy via JustLend smart contract
                    const rentalResult = await rentEnergyViaJustLend(energyToRent, rentalCost);
                    
                    if (rentalResult.success) {
                        uiManager.showNotification('success', `Energy rented successfully! Transaction: ${rentalResult.txId}`);
                        return {
                            success: true,
                            rented: true,
                            amount: energyToRent,
                            cost: rentalResult.actualCost,
                            txId: rentalResult.txId
                        };
                    }
                    
                    // If JustLend fails, fall back to manual approach
                    throw new Error(rentalResult.error || 'JustLend rental failed');
                    
                } catch (rentalError) {
                    console.error('Automated energy rental failed:', rentalError);
                    
                    // Show manual options
                    const manualChoice = await showEnergyOptions(energyToRent, rentalCost);
                    
                    if (manualChoice === 'proceed') {
                        // User chose to proceed and burn TRX
                        return {
                            success: true,
                            rented: false,
                            amount: energyToRent,
                            cost: rentalCost,
                            warning: 'Energy will be burned from TRX balance'
                        };
                    } else if (manualChoice === 'stake') {
                        // Open staking guide
                        window.open('https://tronscan.org/#/sr/representatives', '_blank');
                        return {
                            success: false,
                            error: 'Please stake TRX for energy and try again'
                        };
                    } else {
                        // User cancelled
                        return {
                            success: false,
                            error: 'Energy rental cancelled by user'
                        };
                    }
                }
                
            } catch (error) {
                console.error('Energy rental error:', error);
                
                // If we can't check energy, show warning but allow to proceed
                const proceed = confirm(
                    ' Unable to check energy requirements\n\n' +
                    'The transaction may fail if you don\'t have enough energy.\n' +
                    'Continue anyway?'
                );
                
                return { 
                    success: proceed, 
                    rented: false, 
                    cost: 0,
                    error: proceed ? null : 'User cancelled due to energy check failure'
                };
            }
        }
        
        // Rent energy via JustLend contract
        async function rentEnergyViaJustLend(energyAmount, maxPrice) {
            try {
                const justLendAddress = JUSTLEND_CONFIG.mainnet.contract;
                
                // Build the transaction
                const parameter = [
                    { type: 'uint256', value: energyAmount },
                    { type: 'address', value: tronWeb.defaultAddress.base58 },
                    { type: 'uint256', value: 3600 } // 1 hour rental
                ];
                
                const transaction = await tronWeb.transactionBuilder.triggerSmartContract(
                    justLendAddress,
                    'rentEnergy(uint256,address,uint256)',
                    {
                        callValue: tronWeb.toSun(maxPrice),
                        feeLimit: 10e6 // 10 TRX fee limit
                    },
                    parameter,
                    tronWeb.defaultAddress.base58
                );
                
                const signedTx = await tronWeb.trx.sign(transaction.transaction);
                const result = await tronWeb.trx.sendRawTransaction(signedTx);
                
                if (result.result) {
                    return {
                        success: true,
                        txId: result.txid,
                        actualCost: maxPrice
                    };
                }
                
                return {
                    success: false,
                    error: 'Transaction failed'
                };
                
            } catch (error) {
                console.error('JustLend rental error:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Show energy rental options to user
        async function showEnergyOptions(energyNeeded, estimatedCost) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2><i class="fas fa-bolt" style="color: #f59e0b;"></i> Energy Required</h2>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning" style="background: #fef3c7; border-color: #f59e0b;">
                                <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                                <strong>Insufficient Energy</strong>
                                <p style="margin: 0.5rem 0 0 0;">This transaction requires ${energyNeeded.toLocaleString()} energy.</p>
                            </div>
                            
                            <div class="energy-options" style="margin-top: 1.5rem;">
                                <h4>Choose how to proceed:</h4>
                                
                                <div class="option-card" style="margin: 1rem 0; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer;" 
                                     onclick="document.getElementById('energyChoice').value='proceed'; document.querySelector('.energy-continue-btn').click();">
                                    <h5><i class="fas fa-fire"></i> Burn TRX for Energy</h5>
                                    <p style="margin: 0.5rem 0 0 0; color: #6b7280;">Proceed with transaction and burn ~${estimatedCost} TRX for energy</p>
                                    <div class="cost-indicator" style="margin-top: 0.5rem; color: #ef4444;">
                                        <i class="fas fa-coins"></i> Cost: ~${estimatedCost} TRX
                                    </div>
                                </div>
                                
                                <div class="option-card" style="margin: 1rem 0; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer;"
                                     onclick="document.getElementById('energyChoice').value='stake'; document.querySelector('.energy-continue-btn').click();">
                                    <h5><i class="fas fa-lock"></i> Stake TRX for Energy</h5>
                                    <p style="margin: 0.5rem 0 0 0; color: #6b7280;">Stake TRX to get permanent energy (recommended for frequent users)</p>
                                    <div class="cost-indicator" style="margin-top: 0.5rem; color: #10b981;">
                                        <i class="fas fa-info-circle"></i> One-time stake, permanent energy
                                    </div>
                                </div>
                                
                                <div class="option-card" style="margin: 1rem 0; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer;"
                                     onclick="document.getElementById('energyChoice').value='cancel'; document.querySelector('.energy-continue-btn').click();">
                                    <h5><i class="fas fa-times"></i> Cancel Transaction</h5>
                                    <p style="margin: 0.5rem 0 0 0; color: #6b7280;">Cancel and return to form</p>
                                </div>
                            </div>
                            
                            <input type="hidden" id="energyChoice" value="">
                        </div>
                        <div class="modal-footer" style="display: none;">
                            <button class="btn btn-primary energy-continue-btn" onclick="
                                const choice = document.getElementById('energyChoice').value;
                                this.closest('.modal').remove();
                                window.energyModalResolve(choice);
                            ">
                                Continue
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Store resolve function globally for the onclick handlers
                window.energyModalResolve = resolve;
                
                // Clean up when modal is closed
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve('cancel');
                        delete window.energyModalResolve;
                    }
                });
            });
        }

        // Handle modal backdrop clicks
        function handleModalBackdropClick(event, modalId) {
            // Only close if clicking on the backdrop itself, not the content
            if (event.target.id === modalId) {
                if (modalId === 'mintModal') {
                    closeMintModal();
                } else if (modalId === 'registrationModal') {
                    closeRegistrationModal();
                } else {
                    // For other modals, just close them
                    document.getElementById(modalId).style.display = 'none';
                }
            }
        }
        
        // Set up modal protection to prevent accidental closes
        function setupModalProtection() {
            // Remove any inline onclick handlers and use event listeners
            const mintModal = document.getElementById('mintModal');
            const registrationModal = document.getElementById('registrationModal');
            
            if (mintModal) {
                // Remove inline onclick
                mintModal.onclick = null;
                
                // Add proper event listener
                mintModal.addEventListener('click', function(event) {
                    // Only trigger if clicking the modal backdrop itself
                    if (event.target === mintModal) {
                        event.preventDefault();
                        event.stopPropagation();
                        closeMintModal();
                    }
                });
            }
            
            if (registrationModal) {
                // Remove inline onclick
                registrationModal.onclick = null;
                
                // Add proper event listener
                registrationModal.addEventListener('click', function(event) {
                    // Only trigger if clicking the modal backdrop itself
                    if (event.target === registrationModal) {
                        event.preventDefault();
                        event.stopPropagation();
                        closeRegistrationModal();
                    }
                });
            }
            
            // Prevent all modal content from closing the modal
            document.querySelectorAll('.modal-content').forEach(content => {
                content.addEventListener('click', function(event) {
                    event.stopPropagation();
                });
            });
        }
        
        // Initialize when document is loaded
        
        // Ensure modals close properly
        document.addEventListener('click', function(event) {
            // Close modals when clicking outside
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
            
            // Close dropdowns when clicking outside
            if (!event.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });
        
        // Fix ESC key to close modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });

        // Site configuration based on domain
        const SITE_CONFIG = {
            'theblockservice.com': {
                mode: 'server',
                showServerFeatures: true,
                showRecipientFeatures: false,
                brandName: 'The Block Service',
                tagline: 'Professional Legal Notice Service'
            },
            'blockserved.com': {
                mode: 'recipient', 
                showServerFeatures: false,
                showRecipientFeatures: true,
                brandName: 'Block Served',
                tagline: 'View Your Legal Notices',
                hideIPWarnings: true,
                showFriendlyUI: true
            },
            'nftserviceapp.netlify.app': {
                mode: 'full',
                showServerFeatures: true,
                showRecipientFeatures: true,
                brandName: 'Legal Notice NFT',
                tagline: 'Blockchain Legal Document Service'
            },
            'localhost': {
                mode: 'full',
                showServerFeatures: true,
                showRecipientFeatures: true,
                brandName: 'Legal Notice NFT (Dev)',
                tagline: 'Development Environment'
            }
        };
        
        // Get current site configuration
        function getSiteConfig() {
            const hostname = window.location.hostname;
            return SITE_CONFIG[hostname] || SITE_CONFIG['nftserviceapp.netlify.app'];
        }
        
        // Configure site based on domain
        function configureSiteForMode(config) {
            // Update brand name
            const brandElements = document.querySelectorAll('.brand-name');
            brandElements.forEach(el => el.textContent = config.brandName);
            
            // Update tagline
            const taglineElements = document.querySelectorAll('.tagline');
            taglineElements.forEach(el => el.textContent = config.tagline);
            
            // Populate FAQ based on site configuration
            populateFAQ(config);
            
            // Update welcome section for recipients
            updateWelcomeSection(config);
            
            // Update alerts section for recipients
            updateAlertsSection(config);
            
            // Always show wallet search section for all users
            const walletSearchSection = document.getElementById('walletSearchSection');
            if (walletSearchSection) {
                walletSearchSection.style.display = 'block';
            }
            
            // Show/hide features based on mode
            if (!config.showServerFeatures) {
                // Hide server-only features
                const serverElements = document.querySelectorAll('.server-only');
                serverElements.forEach(el => el.style.display = 'none');
                
                // Hide admin panel
                const adminTab = document.querySelector('[onclick*="showTab(\'admin\')"]');
                if (adminTab) adminTab.style.display = 'none';
                
                // Hide process server tab
                const userTab = document.querySelector('[onclick*="switchTab(\'user\')"]');
                if (userTab) userTab.style.display = 'none';
                
                // Hide all server-specific cards
                const serverStatsCard = document.getElementById('serverStatsCard');
                if (serverStatsCard) serverStatsCard.style.display = 'none';
                
                const walletStatusCard = document.getElementById('walletStatusCard');
                if (walletStatusCard) walletStatusCard.style.display = 'none';
                
                const contractManagementCard = document.getElementById('contractManagementCard');
                if (contractManagementCard) contractManagementCard.style.display = 'none';
                
                // Hide Quick Actions for recipients
                const quickActions = document.getElementById('quickActions');
                if (quickActions) quickActions.style.display = 'none';
                
                // Keep recipients on user tab to see their alerts
                // Don't switch tabs - myAlertsContent is in the user tab
                
                // Hide the entire tab navigation for recipients
                const tabNav = document.querySelector('.tab-nav');
                if (tabNav) tabNav.style.display = 'none';
                
                // Hide any registration forms
                const registrationModal = document.getElementById('registrationModal');
                if (registrationModal) registrationModal.style.display = 'none';
                
                // Hide registration notice for recipients
                const regNotice = document.getElementById('registrationNotice');
                if (regNotice) {
                    regNotice.style.display = 'none';
                }
                
                // Hide server ID display
                const serverIdDisplay = document.getElementById('serverIdDisplay');
                if (serverIdDisplay) {
                    serverIdDisplay.style.display = 'none';
                }
                
                // Hide contract management card
                const contractCard = document.getElementById('contractManagementCard');
                if (contractCard) {
                    contractCard.style.display = 'none';
                }
            }
            
            if (!config.showRecipientFeatures) {
                // Hide recipient-only features
                const recipientElements = document.querySelectorAll('.recipient-only');
                recipientElements.forEach(el => el.style.display = 'none');
                
                // Hide My Legal Notice Alerts section for process servers
                const myAlertsCard = document.getElementById('myAlertsCard');
                if (myAlertsCard) {
                    myAlertsCard.style.display = 'none';
                }
            }
            
            // Update page title
            document.title = config.brandName;
        }
        
        // Populate FAQ based on site configuration
        function populateFAQ(config) {
            const faqContainer = document.getElementById('faqContainer');
            if (!faqContainer) return;
            
            // Clear existing content except title
            const title = faqContainer.querySelector('h2');
            faqContainer.innerHTML = '';
            if (title) faqContainer.appendChild(title);
            
            if (config.showFriendlyUI) {
                // Recipient-focused FAQ for blockserved.com
                createRecipientFAQ(faqContainer);
            } else {
                // Full FAQ for process servers
                createProcessServerFAQ(faqContainer);
            }
        }
        
        // Update welcome section based on site configuration
        function updateWelcomeSection(config) {
            const welcomeSection = document.getElementById('welcomeSection');
            if (!welcomeSection) return;
            
            if (config.showFriendlyUI) {
                // Add language selector for recipients
                const languageSelector = LanguageManager ? LanguageManager.createLanguageSelector() : '';
                
                // Recipient-focused welcome for blockserved.com
                welcomeSection.innerHTML = `
                    ${languageSelector}
                    <div class="hero-banner" style="background: linear-gradient(135deg, #0ea5e9 0%, #3730a3 100%); color: white; padding: 3rem; border-radius: 12px; margin-bottom: 2rem; text-align: center;">
                        <h1 style="font-size: 2.5rem; margin-bottom: 1rem;" data-translate="blockserved.title"> You Have a Legal Document</h1>
                        <p style="font-size: 1.3rem; margin-bottom: 2rem; opacity: 0.95;" data-translate="blockserved.subtitle">
                            Someone has sent you an important document that requires your attention
                        </p>
                        <div class="alert alert-warning" style="background: rgba(251, 191, 36, 0.1); border: 2px solid #fbbf24; color: #fbbf24; max-width: 600px; margin: 0 auto 2rem;">
                            <p style="margin: 0; font-weight: 600;">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <span data-translate="blockserved.warningMessage">Ignoring legal notices can result in default judgment against you</span>
                            </p>
                        </div>
                        <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem; background: white; color: #3730a3;" onclick="connectWallet()">
                            <i class="fas fa-wallet"></i> <span data-translate="blockserved.connectWallet">Connect Wallet to View Document</span>
                        </button>
                    </div>
                    
                    <div class="info-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="card" style="text-align: center; padding: 2rem;">
                            <i class="fas fa-shield-alt" style="font-size: 3rem; color: #10b981; margin-bottom: 1rem;"></i>
                            <h3 style="margin-bottom: 0.5rem;">${LanguageManager.translate('blockserved.safeSecure')}</h3>
                            <p style="color: var(--text-secondary);">
                                ${LanguageManager.translate('blockserved.safeSecureDesc')}
                            </p>
                        </div>
                        
                        <div class="card" style="text-align: center; padding: 2rem;">
                            <i class="fas fa-clock" style="font-size: 3rem; color: #f59e0b; margin-bottom: 1rem;"></i>
                            <h3 style="margin-bottom: 0.5rem;">${LanguageManager.translate('blockserved.timeSensitive')}</h3>
                            <p style="color: var(--text-secondary);">
                                ${LanguageManager.translate('blockserved.timeSensitiveDesc')}
                            </p>
                        </div>
                        
                        <div class="card" style="text-align: center; padding: 2rem;">
                            <i class="fas fa-file-signature" style="font-size: 3rem; color: #3b82f6; margin-bottom: 1rem;"></i>
                            <h3 style="margin-bottom: 0.5rem;">${LanguageManager.translate('blockserved.digitalSignature')}</h3>
                            <p style="color: var(--text-secondary);">
                                ${LanguageManager.translate('blockserved.digitalSignatureDesc')}
                            </p>
                        </div>
                    </div>
                    
                    <div class="process-overview" style="background: var(--bg-secondary); padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
                        <h2 style="text-align: center; margin-bottom: 2rem;">${LanguageManager.translate('blockserved.howItWorks')}</h2>
                        <div class="process-steps" style="max-width: 600px; margin: 0 auto;">
                            <div class="step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <strong>${LanguageManager.translate('blockserved.step1Title')}</strong>
                                    <p>${LanguageManager.translate('blockserved.step1Desc')}</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <strong>${LanguageManager.translate('blockserved.step2Title')}</strong>
                                    <p>${LanguageManager.translate('blockserved.step2Desc')}</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <strong>${LanguageManager.translate('blockserved.step3Title')}</strong>
                                    <p>${LanguageManager.translate('blockserved.step3Desc')}</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <strong>${LanguageManager.translate('blockserved.step4Title')}</strong>
                                    <p>${LanguageManager.translate('blockserved.step4Desc')}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="faq-preview" style="background: #fffbeb; padding: 2rem; border-radius: 8px; border: 2px solid #f59e0b;">
                        <h3 style="color: #78350f; margin-bottom: 1rem;">
                            <i class="fas fa-question-circle"></i> \${LanguageManager.translate('blockserved.commonQuestions')}
                        </h3>
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <strong style="color: #78350f;">\${LanguageManager.translate('blockserved.faq1Question')}</strong>
                                <p style="margin: 0.5rem 0 0 0; color: #451a03;">\${LanguageManager.translate('blockserved.faq1Answer')}</p>
                            </div>
                            <div>
                                <strong style="color: #78350f;">\${LanguageManager.translate('blockserved.faq2Question')}</strong>
                                <p style="margin: 0.5rem 0 0 0; color: #451a03;">\${LanguageManager.translate('blockserved.faq2Answer')}</p>
                            </div>
                            <div>
                                <strong style="color: #78350f;">\${LanguageManager.translate('blockserved.faq3Question')}</strong>
                                <p style="margin: 0.5rem 0 0 0; color: #451a03;">\${LanguageManager.translate('blockserved.faq3Answer')}</p>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 1.5rem;">
                            <button class="btn btn-secondary" onclick="switchTab('info')">
                                <i class="fas fa-book"></i> \${LanguageManager.translate('blockserved.viewFullFAQ')}
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // Keep original for process servers
                welcomeSection.innerHTML = `
                    <h2>Blockchain Legal Notice Delivery System</h2>
                    <p>Serve legal documents directly to cryptocurrency wallets - solving the unknown owner problem</p>
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--accent-blue);">
                        <p style="margin: 0; font-size: 0.95rem; color: var(--text-secondary);">
                            <strong> Law Enforcement Asset Recovery:</strong> When cryptocurrency wallets contain proceeds of crime but owners are unknown, this system enables constitutional due process by serving seizure notices directly to the wallet address. The NFT travels with the assets, ensuring notice reaches whoever controls them.
                            <a href="#" onclick="switchTab('info'); setTimeout(() => document.querySelector('.faq-header').click(), 100); return false;" style="color: var(--accent-blue); text-decoration: underline;">See how it works </a>
                        </p>
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #22c55e;">
                        <p style="margin: 0; font-size: 0.95rem; color: #14532d;">
                            <strong> NEW: Multi-Language Support</strong> - Recipients can now view notices in 5 languages (English, Spanish, French, Chinese, Hindi), demonstrating extraordinary diligence in service attempts.
                            <a href="#" onclick="switchTab('info'); setTimeout(() => { const faqButtons = document.querySelectorAll('.faq-question'); faqButtons.forEach(btn => { if(btn.textContent.includes('diligent service')) btn.click(); }); }, 100); return false;" style="color: #22c55e; text-decoration: underline;">Learn more </a>
                        </p>
                    </div>
                `;
            }
        }
        
        // Update alerts section based on site configuration
        function updateAlertsSection(config) {
            if (config.showFriendlyUI) {
                // Update title for recipients
                const alertsTitle = document.querySelector('.alerts-title');
                if (alertsTitle) {
                    alertsTitle.textContent = 'Your Legal Documents';
                }
                
                // Hide debug button for recipients
                const debugButton = document.querySelector('.debug-button');
                if (debugButton) {
                    debugButton.style.display = 'none';
                }
                
                // Update the alerts card header
                const alertsCard = document.getElementById('myAlertsCard');
                if (alertsCard) {
                    const header = alertsCard.querySelector('.card-header h2');
                    if (header) {
                        header.innerHTML = '<i class="fas fa-inbox"></i> <span class="alerts-title">Your Legal Documents</span>';
                    }
                }
                
                // Update empty state for recipients
                const emptyState = document.querySelector('#myAlertsContent .empty-state');
                if (emptyState) {
                    emptyState.innerHTML = `
                        <i class="fas fa-inbox"></i>
                        <h3>No documents found</h3>
                        <p>Connect your wallet to check for legal notices</p>
                    `;
                }
            }
        }
        
        // Create recipient-focused FAQ content
        function createRecipientFAQ(container) {
            // Add critical warning banner
            const warningBanner = document.createElement('div');
            warningBanner.className = 'alert alert-danger';
            warningBanner.style.cssText = 'font-size: 1.2rem; border: 3px solid #dc2626; margin-bottom: 2rem; padding: 1.5rem;';
            warningBanner.innerHTML = `
                <h3 style="color: #dc2626; margin-top: 0;"><i class="fas fa-exclamation-triangle"></i> ${LanguageManager.translate('blockserved.criticalWarning')}</h3>
                <p><strong>${LanguageManager.translate('blockserved.officialDocument')}</strong></p>
                <p style="margin-bottom: 0;">${LanguageManager.translate('blockserved.failureConsequences')}</p>
                <ul style="margin: 0.5rem 0;">
                    <li><strong>${LanguageManager.translate('blockserved.defaultJudgment')}</strong></li>
                    <li><strong>${LanguageManager.translate('blockserved.propertySeizure')}</strong></li>
                    <li><strong>${LanguageManager.translate('blockserved.lossOfRights')}</strong></li>
                    <li><strong>${LanguageManager.translate('blockserved.criminalCharges')}</strong></li>
                </ul>
                <p style="margin-bottom: 0; font-weight: bold;"> ${LanguageManager.translate('blockserved.abandonRights')}</p>
            `;
            container.appendChild(warningBanner);
            
            // FAQ items focused on recipients
            const faqItems = [
                {
                    question: LanguageManager.translate('blockserved.faq.whyReceived'),
                    answer: LanguageManager.translate('blockserved.faq.whyReceivedAnswer')
                },
                {
                    question: "What happens if I don't accept this notice?",
                    answer: `
                        <div class="alert alert-danger">
                            <p><strong>SEVERE CONSEQUENCES MAY INCLUDE:</strong></p>
                        </div>
                        <ol>
                            <li><strong>Default Judgment:</strong> The court may rule against you without hearing your side</li>
                            <li><strong>Asset Seizure:</strong> Your cryptocurrency may be frozen or confiscated</li>
                            <li><strong>Criminal Charges:</strong> Failure to comply with legal notices can result in contempt charges</li>
                            <li><strong>Loss of Defense Rights:</strong> You forfeit your opportunity to contest the action</li>
                            <li><strong>Additional Penalties:</strong> Fines, interest, and legal fees may be added</li>
                        </ol>
                        <p><strong>THE COURT WILL PROCEED WITHOUT YOU - YOUR ABSENCE WILL NOT STOP THE LEGAL PROCESS</strong></p>
                    `
                },
                {
                    question: "Does accepting mean I agree with the claims?",
                    answer: `
                        <div class="alert alert-success">
                            <p><strong>NO! Accepting the notice does NOT mean you agree.</strong></p>
                        </div>
                        <p>Accepting simply means:</p>
                        <ul>
                            <li> You acknowledge receiving the document</li>
                            <li> You preserve your right to respond and defend yourself</li>
                            <li> You can review the full details of the legal action</li>
                            <li> You maintain your ability to hire an attorney</li>
                        </ul>
                        <p><strong>Think of it like signing for certified mail - it proves you received it, nothing more.</strong></p>
                    `
                },
                {
                    question: "How do I accept and view the document?",
                    answer: `
                        <div class="process-steps">
                            <div class="step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <strong>Connect Your Wallet</strong>
                                    <p>Click "Connect Wallet" and select your crypto wallet that received the notice</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <strong>Find Your Notice</strong>
                                    <p>Go to "My Notices" tab - your legal notice will be listed there</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <strong>Click Accept</strong>
                                    <p>Click the "Accept" button - this creates a legal record of receipt</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <strong>Download Document & Save Receipt</strong>
                                    <p>The document will decrypt automatically. <strong>IMPORTANT: Save your acceptance receipt!</strong></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-success" style="margin-top: 1rem;">
                            <h4> Document Access Options After Acceptance</h4>
                            <p><strong>Your acceptance receipt contains everything needed to access your document forever:</strong></p>
                            <ul>
                                <li><strong>Option 1 - Through Our Website:</strong> Return anytime to view/download your document</li>
                                <li><strong>Option 2 - Direct from IPFS:</strong> Use the IPFS hash in your receipt to download from any IPFS gateway</li>
                                <li><strong>Option 3 - Independent Decryption:</strong> Use the decryption key in your receipt with any AES tool</li>
                            </ul>
                            <p style="margin-bottom: 0;"><em>You own permanent access to your document - no one can take it away or delete it.</em></p>
                        </div>
                        
                        <p><strong>FEES COVERED:</strong> The sender has provided 5.5 TRX total to your wallet:
                        <ul>
                            <li>2 TRX from the smart contract sponsorship</li>
                            <li>3.5 TRX sent as a notification payment</li>
                        </ul>
                        Since acceptance costs approximately 5 TRX in network fees, you should have enough TRX to accept the notice!</p>
                    `
                },
                {
                    question: "Will accepting this cost me money?",
                    answer: `
                        <p>The acceptance transaction requires approximately 5 TRX in network fees (energy costs). However:</p>
                        <ul>
                            <li> <strong>You received 5.5 TRX total:</strong> Check your wallet - you got 2 TRX from the contract + 3.5 TRX notification payment</li>
                            <li> <strong>This covers your costs:</strong> The 5.5 TRX should fully cover the ~5 TRX acceptance fee</li>
                            <li> <strong>One-time fee:</strong> This is a standard blockchain transaction fee, not a payment to anyone</li>
                        </ul>
                        <div class="alert alert-info">
                            <p><strong>Why the fee?</strong> The TRON blockchain requires energy (TRX) for all transactions. 
                            This ensures security and prevents spam. The 2 TRX sponsorship helps make acceptance more affordable.</p>
                        </div>
                        <p>If you need more TRX, you can purchase a small amount (5-10 TRX) from any crypto exchange.</p>
                    `
                },
                {
                    question: "What if I don't have a crypto wallet?",
                    answer: `
                        <p>If you're seeing this notice, it means a legal document was sent to a crypto wallet address associated with you. You need to:</p>
                        <ol>
                            <li>Determine which wallet service you used (TronLink, Trust Wallet, etc.)</li>
                            <li>Recover access to that wallet using your backup phrase</li>
                            <li>If you can't access the wallet, you still need to respond to avoid default judgment</li>
                        </ol>
                        <div class="alert alert-warning">
                            <p><strong>IMPORTANT:</strong> Inability to access your wallet does NOT excuse you from responding to legal notices. Contact an attorney immediately if you cannot access the document.</p>
                        </div>
                    `
                },
                {
                    question: "Is this legitimate or a scam?",
                    answer: `
                        <p><strong>How to verify this is a real legal notice:</strong></p>
                        <ul>
                            <li> <strong>Blockchain Verified:</strong> Check TronScan.org to see the permanent record</li>
                            <li> <strong>Document on IPFS:</strong> Document stored on decentralized network, not someone's server</li>
                            <li> <strong>Smart Contract:</strong> Delivered via auditable smart contract at ${CONTRACT_ADDRESS}</li>
                            <li> <strong>Costs Money to Send:</strong> Sender paid real fees (not free like spam)</li>
                            <li> <strong>Contains Legal Details:</strong> Real case numbers, court info, deadlines</li>
                            <li> <strong>Process Server ID:</strong> Verified server with registration number</li>
                        </ul>
                        
                        <div class="alert alert-success">
                            <h4> How to Independently Verify:</h4>
                            <ol>
                                <li>Go to TronScan.org</li>
                                <li>Search for contract: ${CONTRACT_ADDRESS}</li>
                                <li>Look at "Transactions" to see your notice</li>
                                <li>Check the IPFS hash to verify document exists</li>
                            </ol>
                        </div>
                        
                        <p><strong>Scammers typically:</strong></p>
                        <ul>
                            <li> Ask you to send crypto or money</li>
                            <li> Request your private keys or seed phrase</li>
                            <li> Use email or social media, not blockchain</li>
                            <li> Have no verifiable blockchain record</li>
                        </ul>
                        <p><strong>This system NEVER asks for payment or private information. You're only signing to acknowledge receipt.</strong></p>
                    `
                },
                {
                    question: "What should I do after accepting the notice?",
                    answer: `
                        <div class="process-steps">
                            <div class="step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <strong>SAVE YOUR ACCEPTANCE RECEIPT</strong>
                                    <p>Download and save the receipt - it contains your IPFS hash, decryption key, and blockchain proof</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <strong>READ THE DOCUMENT CAREFULLY</strong>
                                    <p>Understand what legal action is being taken and any deadlines</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <strong>NOTE ALL DEADLINES</strong>
                                    <p>Legal notices often have strict response deadlines - missing them forfeits your rights</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <strong>VERIFY ON BLOCKCHAIN</strong>
                                    <p>Use the TronScan link in your receipt to verify the transaction on the blockchain</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">5</div>
                                <div class="step-content">
                                    <strong>CONSULT AN ATTORNEY</strong>
                                    <p>Get legal advice immediately - show them your receipt and document</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info" style="margin-top: 1rem;">
                            <h4> What Your Receipt Contains:</h4>
                            <ul>
                                <li><strong>IPFS Hash:</strong> Permanent link to your encrypted document</li>
                                <li><strong>Decryption Key:</strong> Key to decrypt your document independently</li>
                                <li><strong>TronScan Links:</strong> Blockchain verification of service and acceptance</li>
                                <li><strong>Timestamp:</strong> Exact date/time of acceptance (legally important)</li>
                                <li><strong>IP & Location:</strong> Proof of where/when you accepted</li>
                            </ul>
                            <p style="margin-bottom: 0;"><strong>Keep this receipt forever - it's your proof of proper service and access key.</strong></p>
                        </div>
                        
                        <div class="alert alert-danger">
                            <p><strong>DO NOT IGNORE THE NOTICE - THE LEGAL PROCESS WILL CONTINUE WITH OR WITHOUT YOUR PARTICIPATION</strong></p>
                        </div>
                    `
                },
                {
                    question: "How is my document stored and can I always access it?",
                    answer: `
                        <div class="alert alert-success">
                            <h4> Your Document is Permanently Stored</h4>
                            <p><strong>You have PERMANENT access through multiple methods:</strong></p>
                        </div>
                        
                        <h4>Where Your Document Lives:</h4>
                        <ul>
                            <li><strong>IPFS Network:</strong> Decentralized storage across thousands of computers worldwide</li>
                            <li><strong>Encrypted:</strong> Only you (the recipient) can decrypt and read it</li>
                            <li><strong>Blockchain Record:</strong> TRON blockchain stores the hash and decryption key forever</li>
                            <li><strong>Cannot be Deleted:</strong> Once on IPFS and blockchain, it's permanent</li>
                        </ul>
                        
                        <h4>Three Ways to Access Your Document:</h4>
                        <div class="process-steps">
                            <div class="step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <strong>Through BlockServed.com</strong>
                                    <p>Return anytime, connect wallet, view/download document</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <strong>Direct IPFS Access</strong>
                                    <p>Use any IPFS gateway with the hash from your receipt:<br>
                                    Example: https://ipfs.io/ipfs/[your-hash]</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <strong>Manual Decryption</strong>
                                    <p>Download encrypted file from IPFS, use decryption key from receipt with any AES tool</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <p><strong> Why This Matters:</strong></p>
                            <ul>
                                <li>Even if this website disappears, you can still access your document</li>
                                <li>No one can delete or alter your document</li>
                                <li>You have proof of exactly what was served to you</li>
                                <li>Courts can verify the document hasn't been tampered with</li>
                            </ul>
                        </div>
                        
                        <p><strong>SAVE YOUR RECEIPT!</strong> It contains your IPFS hash and decryption key - everything you need for permanent access.</p>
                    `
                },
                {
                    question: "Can accepting this notice harm me?",
                    answer: `
                        <div class="alert alert-success">
                            <p><strong>NO - Accepting PROTECTS you by preserving your legal rights.</strong></p>
                        </div>
                        <p><strong>Accepting the notice:</strong></p>
                        <ul>
                            <li> Allows you to see what legal action is being taken</li>
                            <li> Preserves your right to defend yourself</li>
                            <li> Prevents default judgment due to non-response</li>
                            <li> Creates a record that you were properly notified</li>
                        </ul>
                        <p><strong>NOT accepting the notice:</strong></p>
                        <ul>
                            <li> May result in default judgment against you</li>
                            <li> Forfeits your right to contest the action</li>
                            <li> Allows proceedings to continue without your input</li>
                            <li> Can lead to asset seizure without warning</li>
                        </ul>
                    `
                }
            ];
            
            // Create FAQ sections
            faqItems.forEach((item, index) => {
                const section = document.createElement('div');
                section.className = 'faq-section';
                section.innerHTML = `
                    <button class="faq-header ${index < 2 ? 'active' : ''}" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-${index < 2 ? 'down' : 'right'}"></i>
                        <span>${item.question}</span>
                    </button>
                    <div class="faq-content" style="display: ${index < 2 ? 'block' : 'none'};">
                        ${item.answer}
                    </div>
                `;
                container.appendChild(section);
            });
            
            // Add final call to action
            const ctaSection = document.createElement('div');
            ctaSection.className = 'card';
            ctaSection.style.cssText = 'margin-top: 2rem; border: 2px solid #0ea5e9; text-align: center;';
            ctaSection.innerHTML = `
                <div class="card-header" style="background: #0ea5e9; color: white;">
                    <h3 style="margin: 0;">Ready to View Your Document?</h3>
                </div>
                <div class="card-body" style="padding: 2rem;">
                    <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">
                        Don't risk default judgment. Accept your notice now to see the full details and protect your rights.
                    </p>
                    <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem;" onclick="connectWallet()">
                        <i class="fas fa-wallet"></i> Connect Wallet & View Notice
                    </button>
                    <p style="margin-top: 1rem; color: #64748b;">
                        Free to accept  Takes less than 2 minutes  Preserves your legal rights
                    </p>
                </div>
            `;
            container.appendChild(ctaSection);
        }
        
        // Create comprehensive FAQ for law enforcement and process servers
        function createProcessServerFAQ(container) {
            // Add law enforcement focused banner
            const lawEnforcementBanner = document.createElement('div');
            lawEnforcementBanner.className = 'alert alert-info';
            lawEnforcementBanner.style.cssText = 'font-size: 1.1rem; border: 2px solid #3b82f6; margin-bottom: 2rem; padding: 1.5rem;';
            lawEnforcementBanner.innerHTML = `
                <h3 style="color: #1e40af; margin-top: 0;"><i class="fas fa-balance-scale"></i> Blockchain Service of Process - Complete Technical & Legal Guide</h3>
                <p><strong>This system enables constitutionally-compliant service of legal notices to cryptocurrency wallets, including cold wallets holding stolen funds.</strong></p>
                <p>The following FAQ explains the complete process, legal validity, and why this is the most defensible method for serving unknown wallet owners.</p>
            `;
            container.appendChild(lawEnforcementBanner);
            
            const faqItems = [
                {
                    question: " Why is this the best solution for serving cold wallets holding stolen funds?",
                    answer: `
                        <div class="alert alert-success">
                            <h4 style="margin-top: 0;">This is the ONLY method that ensures constitutional due process for unknown wallet owners</h4>
                        </div>
                        
                        <p><strong>Traditional service methods fail for cryptocurrency:</strong></p>
                        <ul>
                            <li> <strong>Personal service:</strong> Wallet owner's identity is unknown</li>
                            <li> <strong>Mail service:</strong> No physical address associated with wallets</li>
                            <li> <strong>Publication:</strong> Owner may be in any jurisdiction worldwide</li>
                            <li> <strong>Email:</strong> No verified contact information</li>
                        </ul>
                        
                        <p><strong>Why blockchain service succeeds:</strong></p>
                        <ul>
                            <li> <strong>Direct delivery:</strong> NFT goes directly INTO the wallet containing stolen funds</li>
                            <li> <strong>Travels with assets:</strong> If funds move, the notice moves with them</li>
                            <li> <strong>Permanent attachment:</strong> Cannot be separated from the wallet</li>
                            <li> <strong>Verifiable delivery:</strong> Blockchain proves exact time of service</li>
                            <li> <strong>Global reach:</strong> Works regardless of owner's location</li>
                        </ul>
                        
                        <div class="alert alert-warning">
                            <p><strong>Legal precedent:</strong> Courts have accepted email and social media service when traditional methods fail. Blockchain service is MORE reliable than these accepted methods because:</p>
                            <ul>
                                <li>Cryptographic proof of delivery (not just "sent")</li>
                                <li>Cannot be filtered, blocked, or deleted</li>
                                <li>Permanently associated with the assets in question</li>
                            </ul>
                        </div>
                        
                        <p><strong>For prosecutors:</strong> This method provides the strongest possible due process argument when seeking forfeiture of stolen cryptocurrency.</p>
                    `
                },
                {
                    question: " Complete Process Flow: From Creation to Acceptance",
                    answer: `
                        <div class="process-steps">
                            <h4>Phase 1: Notice Creation & Encryption</h4>
                            <div class="step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <strong>Document Upload</strong>
                                    <p>Legal document (PDF) is uploaded to the system</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <strong>Encryption</strong>
                                    <p>Document is encrypted using AES-256-GCM with a unique key</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <strong>IPFS Storage</strong>
                                    <p>Encrypted document stored on IPFS (InterPlanetary File System) for permanent availability</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <strong>NFT Minting</strong>
                                    <p>Two NFTs created: Alert NFT (visible notice) and Document NFT (encrypted document)</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">5</div>
                                <div class="step-content">
                                    <strong>Recipient Funding</strong>
                                    <p>5.5 TRX total sent to recipient (2 TRX via contract + 3.5 TRX direct transfer)</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="process-steps" style="margin-top: 2rem;">
                            <h4>Phase 2: Recipient Experience</h4>
                            <div class="step">
                                <div class="step-number">6</div>
                                <div class="step-content">
                                    <strong>Wallet Notification</strong>
                                    <p>NFT appears in wallet with clear title: "LEGAL NOTICE - ACTION REQUIRED"</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">7</div>
                                <div class="step-content">
                                    <strong>View Without Wallet</strong>
                                    <p>Recipient can view notice details at blockserved.com without connecting wallet</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">8</div>
                                <div class="step-content">
                                    <strong>Language Selection</strong>
                                    <p>Interface available in 5 languages to ensure comprehension</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">9</div>
                                <div class="step-content">
                                    <strong>Acceptance Signature</strong>
                                    <p>Recipient signs blockchain transaction to acknowledge receipt (costs ~5 TRX, covered by the 5.5 TRX provided)</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">10</div>
                                <div class="step-content">
                                    <strong>Document Decryption</strong>
                                    <p>Upon acceptance, document automatically decrypts for viewing/download</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">11</div>
                                <div class="step-content">
                                    <strong>Receipt Generation</strong>
                                    <p>Acceptance receipt includes IPFS hash, decryption key, and TronScan verification links</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-success" style="margin-top: 1rem;">
                            <h4> Permanent Document Access</h4>
                            <p><strong>Recipients receive THREE ways to access their documents forever:</strong></p>
                            <ol>
                                <li><strong>Through BlockServed.com:</strong> Return anytime with wallet connection</li>
                                <li><strong>Direct IPFS Access:</strong> Use IPFS hash from receipt at any gateway (ipfs.io, Pinata, etc.)</li>
                                <li><strong>Manual Decryption:</strong> Use decryption key from receipt with any AES tool</li>
                            </ol>
                            <p>This ensures recipients maintain permanent access even if websites go offline.</p>
                        </div>
                        
                        <div class="alert alert-info" style="margin-top: 1rem;">
                            <p><strong>IP Tracking:</strong> System logs IP address, location, device info when recipient views or accepts notice - crucial evidence for jurisdiction and actual notice.</p>
                        </div>
                    `
                },
                {
                    question: " Fee Structure and Recipient Funding Explained",
                    answer: `
                        <h4>Service Fees (Paid by Server)</h4>
                        <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
                            <tr style="background: #f3f4f6;">
                                <th style="padding: 0.5rem; text-align: left; border: 1px solid #e5e7eb;">Service Type</th>
                                <th style="padding: 0.5rem; text-align: left; border: 1px solid #e5e7eb;">Total Cost</th>
                                <th style="padding: 0.5rem; text-align: left; border: 1px solid #e5e7eb;">Breakdown</th>
                            </tr>
                            <tr>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;"><strong>Document Notice</strong></td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb; color: #dc2626; font-weight: bold;">$50-100 USD</td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">
                                     Service: $25 (~75 TRX)<br>
                                     Energy: $50-100 (200-300 TRX)<br>
                                     Recipient: $2 (5.5 TRX)<br>
                                     <strong>Total: $77-127 USD</strong>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;"><strong>Text Notice</strong></td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb; color: #dc2626; font-weight: bold;">$50-100 USD</td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">
                                     Service: $5 (~15 TRX)<br>
                                     Energy: $50-100 (200-300 TRX)<br>
                                     Recipient: $2 (5.5 TRX)<br>
                                     <strong>Total: $57-107 USD</strong>
                                </td>
                            </tr>
                            <tr style="background: #fef3c7;">
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;"><strong>Law Enforcement</strong></td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb; color: #dc2626; font-weight: bold;">$50-100 USD</td>
                                <td style="padding: 0.5rem; border: 1px solid #e5e7eb;">
                                     Service fees: WAIVED<br>
                                     Energy: $50-100 (200-300 TRX)<br>
                                     Recipient: $2 (5.5 TRX)<br>
                                     <strong>Total: $52-102 USD</strong>
                                </td>
                            </tr>
                        </table>
                        
                        <div class="alert alert-danger" style="margin: 1rem 0;">
                            <h4 style="margin-top: 0;"> CRITICAL COST WARNING</h4>
                            <p><strong>Each notice costs $50-100 USD due to TRON energy requirements!</strong></p>
                            <ul>
                                <li><strong>Regular Users:</strong> $50-100 per notice (mostly energy costs)</li>
                                <li><strong>Law Enforcement:</strong> $50-100 per notice (energy + recipient funding)</li>
                                <li><strong>High Volume Users:</strong> MUST stake TRX or costs become prohibitive</li>
                            </ul>
                            <p style="margin-bottom: 0; font-size: 1.2rem;"><strong> Without energy management, this service is economically unviable. Energy rental implementation is CRITICAL but currently BROKEN.</strong></p>
                        </div>
                        
                        <h4>Recipient Funding (Total 5.5 TRX)</h4>
                        <div class="alert alert-success">
                            <p><strong>Recipients receive 5.5 TRX total to ensure they can accept the notice:</strong></p>
                            <ol>
                                <li><strong>2 TRX via smart contract</strong> - Automatically sent with NFT creation</li>
                                <li><strong>3.5 TRX direct transfer</strong> - Sent immediately after NFT minting as notification payment</li>
                            </ol>
                            <p><strong>Why 5.5 TRX?</strong> Accepting requires ~5 TRX in blockchain energy fees. The extra 0.5 TRX ensures sufficient funds even with network fluctuations.</p>
                        </div>
                        
                        <h4>Why Recipients Need TRX</h4>
                        <p>TRON blockchain requires "energy" for transactions. Without energy, users must burn TRX. The acceptance transaction requires approximately:</p>
                        <ul>
                            <li>300,000-500,000 energy units</li>
                            <li>At current rates: ~5 TRX if burning</li>
                            <li>OR: Free if user has staked TRX for energy</li>
                        </ul>
                        
                        <h4>Energy Costs for Servers</h4>
                        <div class="alert alert-warning">
                            <p><strong> CRITICAL: Energy costs make service economically unviable without proper management:</strong></p>
                            <ul>
                                <li><strong>Document Notice:</strong> ~2,000,000-2,500,000 energy (200-300 TRX = $50-100 USD)</li>
                                <li><strong>Text Notice:</strong> ~2,000,000-2,500,000 energy (200-300 TRX = $50-100 USD)</li>
                            </ul>
                            <p><strong>MANDATORY COST REDUCTION STRATEGIES:</strong></p>
                            <ol>
                                <li><strong>Stake TRX (Essential for high volume):</strong> Stake 100,000-200,000 TRX for permanent free energy</li>
                                <li><strong>Energy Rental (When fixed):</strong> Could reduce costs by 70-80% to ~$10-20 per notice</li>
                                <li><strong>NEVER Burn TRX:</strong> Current default - makes service cost $50-100 per notice!</li>
                            </ol>
                            <div style="background: #dc2626; color: white; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                <p style="margin: 0;"><strong> URGENT: Energy rental implementation is BROKEN. Without staking or rental, each notice costs $50-100 making the service economically unviable!</strong></p>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <p><strong>Legal significance:</strong> By funding acceptance costs, you remove any financial barrier to the recipient acknowledging service, strengthening your due process argument.</p>
                        </div>
                    `
                },
                {
                    question: " Legal Validity and Enforceability",
                    answer: `
                        <h4>Why Courts Accept This Method</h4>
                        
                        <p><strong>1. Meets Constitutional Due Process Requirements</strong></p>
                        <ul>
                            <li> <strong>Notice:</strong> Clear, conspicuous delivery to the wallet address</li>
                            <li> <strong>Opportunity to be heard:</strong> Recipient can view and respond</li>
                            <li> <strong>Reasonable method:</strong> When traditional service is impossible</li>
                        </ul>
                        
                        <p><strong>2. Superior to Accepted Alternative Methods</strong></p>
                        <table style="width: 100%; margin: 1rem 0;">
                            <tr>
                                <th style="text-align: left; padding: 0.5rem;">Method</th>
                                <th style="text-align: left; padding: 0.5rem;">Proof of Delivery</th>
                                <th style="text-align: left; padding: 0.5rem;">Permanence</th>
                            </tr>
                            <tr>
                                <td>Email Service</td>
                                <td>Read receipts (often disabled)</td>
                                <td>Can be deleted</td>
                            </tr>
                            <tr>
                                <td>Social Media</td>
                                <td>Platform analytics</td>
                                <td>Account can be deleted</td>
                            </tr>
                            <tr style="background: #d1fae5;">
                                <td><strong>Blockchain NFT</strong></td>
                                <td><strong>Cryptographic proof</strong></td>
                                <td><strong>Immutable forever</strong></td>
                            </tr>
                        </table>
                        
                        <p><strong>3. Evidence Package for Court</strong></p>
                        <ul>
                            <li> Blockchain transaction receipts (immutable proof)</li>
                            <li> IP logs showing recipient viewed notice</li>
                            <li> Geolocation data for jurisdiction</li>
                            <li> Cryptographic signature of acceptance</li>
                            <li> Precise timestamps for all actions</li>
                            <li> Multi-language interface documentation</li>
                        </ul>
                        
                        <div class="alert alert-warning">
                            <h4>Legal Precedents Supporting Digital Service</h4>
                            <ul>
                                <li><strong>Rio Properties v. Rio International Interlink</strong> - Email service approved</li>
                                <li><strong>WhosHere, Inc. v. Orun</strong> - Social media service approved</li>
                                <li><strong>FTC v. PCCare247</strong> - Electronic service to unknown defendants</li>
                            </ul>
                            <p>Blockchain service is MORE reliable than these approved methods.</p>
                        </div>
                    `
                },
                {
                    question: " Security and Encryption Details",
                    answer: `
                        <h4>Document Security</h4>
                        <ul>
                            <li><strong>Encryption:</strong> AES-256-GCM (military-grade)</li>
                            <li><strong>Key Generation:</strong> Cryptographically secure random keys</li>
                            <li><strong>Storage:</strong> Encrypted documents on IPFS (distributed, permanent)</li>
                            <li><strong>Access Control:</strong> Only recipient's wallet signature can decrypt</li>
                        </ul>
                        
                        <h4>Privacy Protection</h4>
                        <ul>
                            <li> Document contents never exposed publicly</li>
                            <li> Only notice metadata visible on blockchain</li>
                            <li> Recipient identity protected until acceptance</li>
                            <li> Encryption keys never stored on-chain</li>
                        </ul>
                        
                        <h4>Audit Trail</h4>
                        <div class="alert alert-info">
                            <p>Every action creates an immutable record:</p>
                            <ol>
                                <li>Notice creation (timestamp, sender, recipient wallet)</li>
                                <li>NFT minting (token IDs, transaction hashes)</li>
                                <li>Recipient funding (5.5 TRX transfers)</li>
                                <li>Notice viewing (IP logs, location data)</li>
                                <li>Acceptance signature (blockchain proof)</li>
                                <li>Document access (decryption event)</li>
                            </ol>
                        </div>
                    `
                },
                {
                    question: " Best Practices for Law Enforcement",
                    answer: `
                        <h4>Before Serving Notice</h4>
                        <ol>
                            <li><strong>Verify wallet address</strong> - Ensure it contains the assets in question</li>
                            <li><strong>Document wallet activity</strong> - Screenshot balance and recent transactions</li>
                            <li><strong>Prepare clear notice</strong> - Include case number, deadline, consequences</li>
                            <li><strong>Consider jurisdiction</strong> - Note wallet's transaction patterns</li>
                        </ol>
                        
                        <h4>Serving the Notice</h4>
                        <ol>
                            <li><strong>Use document notice</strong> (not text-only) for complete legal documentation</li>
                            <li><strong>Include all required elements:</strong>
                                <ul>
                                    <li>Court/agency information</li>
                                    <li>Case/seizure number</li>
                                    <li>Clear response deadline</li>
                                    <li>Consequences of non-response</li>
                                    <li>How to contest/respond</li>
                                </ul>
                            </li>
                            <li><strong>Save all receipts</strong> - Transaction IDs, IPFS hashes, etc.</li>
                        </ol>
                        
                        <h4>After Service</h4>
                        <ol>
                            <li><strong>Monitor wallet</strong> - Check if NFT is still there (proves ongoing control)</li>
                            <li><strong>Track acceptance</strong> - Use audit tools to check status</li>
                            <li><strong>Document IP logs</strong> - Save evidence of viewing/acceptance</li>
                            <li><strong>Prepare affidavit</strong> - Include all blockchain proofs</li>
                        </ol>
                        
                        <div class="alert alert-success">
                            <h4> Pro Tip: Cold Wallet Service</h4>
                            <p>For wallets that haven't moved in years (cold storage):</p>
                            <ul>
                                <li>The NFT will remain with the wallet indefinitely</li>
                                <li>If funds ever move, the notice moves with them</li>
                                <li>This creates <strong>constructive notice</strong> - the owner cannot claim ignorance</li>
                                <li>Document that notice has been "attached" to the assets for [time period]</li>
                            </ul>
                        </div>
                    `
                },
                {
                    question: " Document Storage, Encryption & Permanent Access",
                    answer: `
                        <div class="alert alert-success">
                            <h4>Three-Layer Security & Permanence System</h4>
                            <p>Documents are stored with military-grade encryption and multiple redundancy layers:</p>
                        </div>
                        
                        <h4>1 IPFS Storage (Decentralized)</h4>
                        <ul>
                            <li><strong>What:</strong> InterPlanetary File System - distributed storage across thousands of nodes</li>
                            <li><strong>Why:</strong> Cannot be deleted, censored, or taken offline by any single entity</li>
                            <li><strong>Access:</strong> Available via any IPFS gateway worldwide (ipfs.io, Pinata, Infura, etc.)</li>
                            <li><strong>Permanence:</strong> Once uploaded, exists forever with content-addressed hash</li>
                        </ul>
                        
                        <h4>2 AES-256 Encryption</h4>
                        <ul>
                            <li><strong>Standard:</strong> Military-grade AES-256-GCM encryption</li>
                            <li><strong>Key Storage:</strong> Decryption key stored on TRON blockchain</li>
                            <li><strong>Access Control:</strong> Only authorized recipient wallet can decrypt</li>
                            <li><strong>Security:</strong> Even if IPFS file is public, content is unreadable without key</li>
                        </ul>
                        
                        <h4>3 Blockchain Record (TRON)</h4>
                        <ul>
                            <li><strong>Smart Contract:</strong> Immutable record at ${CONTRACT_ADDRESS}</li>
                            <li><strong>Contains:</strong> IPFS hash, decryption key, recipient address, timestamp</li>
                            <li><strong>Verification:</strong> Anyone can verify document existence and service time</li>
                            <li><strong>Cost:</strong> Once stored, no ongoing fees - permanent record</li>
                        </ul>
                        
                        <div class="alert alert-info">
                            <h4> Recipient's Acceptance Receipt Contains:</h4>
                            <table style="width: 100%; margin-top: 1rem;">
                                <tr>
                                    <td><strong>IPFS Hash:</strong></td>
                                    <td>Direct link to encrypted document (e.g., QmX3n8...)</td>
                                </tr>
                                <tr>
                                    <td><strong>Decryption Key:</strong></td>
                                    <td>AES key to decrypt document independently</td>
                                </tr>
                                <tr>
                                    <td><strong>Transaction Hash:</strong></td>
                                    <td>TronScan link for blockchain verification</td>
                                </tr>
                                <tr>
                                    <td><strong>Timestamp:</strong></td>
                                    <td>Exact moment of acceptance (legally binding)</td>
                                </tr>
                            </table>
                        </div>
                        
                        <h4> How Recipients Access Documents (3 Methods):</h4>
                        <div class="process-steps">
                            <div class="step">
                                <div class="step-number">A</div>
                                <div class="step-content">
                                    <strong>Via BlockServed.com</strong>
                                    <p>Easiest method - automatic decryption and display</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">B</div>
                                <div class="step-content">
                                    <strong>Direct IPFS Download</strong>
                                    <p>Go to: ipfs.io/ipfs/[hash-from-receipt]<br>
                                    Download encrypted file, decrypt with key from receipt</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">C</div>
                                <div class="step-content">
                                    <strong>Blockchain Query</strong>
                                    <p>Query smart contract directly for IPFS hash and key<br>
                                    Technical users can build their own decryption tool</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning">
                            <h4> Legal Advantages:</h4>
                            <ul>
                                <li><strong>Chain of Custody:</strong> Cryptographic proof document hasn't been altered</li>
                                <li><strong>Timestamp Proof:</strong> Blockchain timestamp is legally admissible</li>
                                <li><strong>Multiple Access Points:</strong> Shows good faith effort to ensure accessibility</li>
                                <li><strong>Permanent Availability:</strong> Document remains accessible for appeals/review</li>
                                <li><strong>Independent Verification:</strong> Courts can verify directly without trusting any party</li>
                            </ul>
                        </div>
                        
                        <div class="alert alert-success">
                            <p><strong>Bottom Line:</strong> Recipients get TRUE ownership of their legal documents. Even if all websites go offline, they can still access their documents forever using the IPFS hash and decryption key from their receipt.</p>
                        </div>
                    `
                },
                {
                    question: " Why This Beats Traditional Methods",
                    answer: `
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="background: #f3f4f6;">
                                <th style="padding: 0.75rem; text-align: left;">Feature</th>
                                <th style="padding: 0.75rem; text-align: left;">Traditional Service</th>
                                <th style="padding: 0.75rem; text-align: left;">Blockchain Service</th>
                            </tr>
                            <tr>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"><strong>Finding recipient</strong></td>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"> Requires identity/address</td>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"> Only need wallet address</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"><strong>Proof of delivery</strong></td>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"> Signature/affidavit</td>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"> Cryptographic proof</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"><strong>Permanence</strong></td>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"> Paper can be lost</td>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"> Immutable forever</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"><strong>Cost</strong></td>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"> $150-500+ per attempt</td>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"> $50-100 USD</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"><strong>Speed</strong></td>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"> Days to weeks</td>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"> Instant delivery</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"><strong>International service</strong></td>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"> Complex treaties</td>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"> Borderless delivery</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"><strong>Language barriers</strong></td>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"> Often English only</td>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"> 5 languages supported</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"><strong>Avoidance</strong></td>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"> Can dodge server</td>
                                <td style="padding: 0.75rem; border-top: 1px solid #e5e7eb;"> Cannot avoid delivery</td>
                            </tr>
                        </table>
                        
                        <div class="alert alert-warning" style="margin-top: 1rem;">
                            <h4>The Bottom Line</h4>
                            <p>For cryptocurrency-related cases, blockchain service provides better due process, stronger evidence, and universal accessibility.</p>
                            <p><strong> COST WARNING:</strong> At $50-100 per notice, costs are comparable to traditional service. Energy management (staking or rental) is CRITICAL to make this service cost-effective at scale.</p>
                        </div>
                    `
                }
            ];
            
            faqItems.forEach((item, index) => {
                const section = document.createElement('div');
                section.className = 'faq-section';
                section.innerHTML = `
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>${item.question}</span>
                    </button>
                    <div class="faq-content" style="display: none;">
                        ${item.answer}
                    </div>
                `;
                container.appendChild(section);
            });
        }
        
        // Log recipient visit with IP information
        async function logRecipientVisit(noticeId) {
            try {
                // Get IP information from free service
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const { ip } = await ipResponse.json();
                
                // Get geolocation data (free tier)
                const geoResponse = await fetch(`https://ipapi.co/${ip}/json/`);
                const geoData = await geoResponse.json();
                
                const visitLog = {
                    noticeId: noticeId,
                    timestamp: new Date().toISOString(),
                    ip: ip,
                    location: {
                        city: geoData.city || 'Unknown',
                        region: geoData.region || 'Unknown',
                        country: geoData.country_name || 'Unknown',
                        countryCode: geoData.country_code || 'Unknown',
                        timezone: geoData.timezone || 'Unknown',
                        latitude: geoData.latitude || null,
                        longitude: geoData.longitude || null
                    },
                    userAgent: navigator.userAgent,
                    referrer: document.referrer || 'Direct',
                    screenResolution: `${screen.width}x${screen.height}`,
                    language: navigator.language
                };
                
                // Store visit log locally first
                const visitLogs = JSON.parse(localStorage.getItem('noticeVisitLogs') || '{}');
                if (!visitLogs[noticeId]) {
                    visitLogs[noticeId] = [];
                }
                visitLogs[noticeId].push(visitLog);
                localStorage.setItem('noticeVisitLogs', JSON.stringify(visitLogs));
                
                // Send to backend if available
                if (window.BACKEND_API_URL) {
                    try {
                        const viewerAddress = tronWeb && tronWeb.defaultAddress ? tronWeb.defaultAddress.base58 : 'anonymous';
                        await fetch(`${window.BACKEND_API_URL}/api/notices/${noticeId}/views`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                viewerAddress: viewerAddress,
                                ipAddress: ip,
                                userAgent: navigator.userAgent,
                                location: visitLog.location,
                                timestamp: visitLog.timestamp
                            })
                        });
                        console.log('Visit logged to backend');
                    } catch (backendError) {
                        console.error('Failed to log to backend:', backendError);
                        // Continue silently - local storage is the fallback
                    }
                }
                
                console.log('Visit logged:', visitLog);
                return visitLog;
                
            } catch (error) {
                console.error('Error logging visit:', error);
                return null;
            }
        }

        // Blockchain Data Cache System
        const blockchainCache = {
            alertNotices: new Map(),
            documentNotices: new Map(),
            notices: new Map(),
            totalNotices: null,
            lastFetch: new Map(),
            TTL: 5 * 60 * 1000, // 5 minutes cache TTL
            
            // Get cached data or fetch from blockchain
            async getAlertNotice(noticeId) {
                const cacheKey = `alert_${noticeId}`;
                const cached = this.alertNotices.get(cacheKey);
                const lastFetch = this.lastFetch.get(cacheKey) || 0;
                
                if (cached && (Date.now() - lastFetch < this.TTL)) {
                    console.log(`Using cached alert notice ${noticeId}`);
                    return cached;
                }
                
                try {
                    console.log(`Fetching alert notice ${noticeId} from blockchain`);
                    const data = await legalContract.alertNotices(noticeId).call();
                    this.alertNotices.set(cacheKey, data);
                    this.lastFetch.set(cacheKey, Date.now());
                    
                    // Also save to backend if available
                    this.saveToBackend('alert', noticeId, data);
                    
                    return data;
                } catch (error) {
                    console.error(`Error fetching alert notice ${noticeId}:`, error);
                    return null;
                }
            },
            
            async getDocumentNotice(noticeId) {
                const cacheKey = `doc_${noticeId}`;
                const cached = this.documentNotices.get(cacheKey);
                const lastFetch = this.lastFetch.get(cacheKey) || 0;
                
                if (cached && (Date.now() - lastFetch < this.TTL)) {
                    console.log(`Using cached document notice ${noticeId}`);
                    return cached;
                }
                
                try {
                    console.log(`Fetching document notice ${noticeId} from blockchain`);
                    const data = await legalContract.documentNotices(noticeId).call();
                    this.documentNotices.set(cacheKey, data);
                    this.lastFetch.set(cacheKey, Date.now());
                    
                    // Also save to backend if available
                    this.saveToBackend('document', noticeId, data);
                    
                    return data;
                } catch (error) {
                    console.error(`Error fetching document notice ${noticeId}:`, error);
                    return null;
                }
            },
            
            async getNotice(index) {
                const cacheKey = `notice_${index}`;
                const cached = this.notices.get(cacheKey);
                const lastFetch = this.lastFetch.get(cacheKey) || 0;
                
                if (cached && (Date.now() - lastFetch < this.TTL)) {
                    console.log(`Using cached notice ${index}`);
                    return cached;
                }
                
                try {
                    console.log(`Fetching notice ${index} from blockchain`);
                    const data = await legalContract.notices(index).call();
                    this.notices.set(cacheKey, data);
                    this.lastFetch.set(cacheKey, Date.now());
                    
                    // Also save to backend if available
                    this.saveToBackend('notice', index, data);
                    
                    return data;
                } catch (error) {
                    console.error(`Error fetching notice ${index}:`, error);
                    return null;
                }
            },
            
            async getTotalNotices() {
                if (this.totalNotices !== null) {
                    const lastFetch = this.lastFetch.get('totalNotices') || 0;
                    if (Date.now() - lastFetch < this.TTL) {
                        console.log('Using cached total notices count');
                        return this.totalNotices;
                    }
                }
                
                try {
                    console.log('Fetching total notices from blockchain');
                    const total = await legalContract.totalNotices().call();
                    this.totalNotices = total;
                    this.lastFetch.set('totalNotices', Date.now());
                    return total;
                } catch (error) {
                    console.error('Error fetching total notices:', error);
                    return 0;
                }
            },
            
            // Save to backend for persistence
            async saveToBackend(type, id, data) {
                if (!window.BACKEND_API_URL) return;
                
                try {
                    // Convert BigInt values to strings for JSON serialization
                    const serializableData = this.convertBigIntsToStrings(data);
                    
                    await fetch(`${window.BACKEND_API_URL}/api/cache/blockchain`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type,
                            id: id.toString(),
                            data: serializableData,
                            network: tronWeb.fullNode.host.includes('nile') ? 'nile' : 'mainnet',
                            contractAddress: legalContract.address,
                            timestamp: Date.now()
                        })
                    });
                } catch (error) {
                    console.log('Could not save to backend cache:', error);
                }
            },
            
            // Convert BigInt values to strings recursively
            convertBigIntsToStrings(obj) {
                if (obj === null || obj === undefined) return obj;
                if (typeof obj === 'bigint') return obj.toString();
                if (Array.isArray(obj)) {
                    return obj.map(item => this.convertBigIntsToStrings(item));
                }
                if (typeof obj === 'object') {
                    const result = {};
                    for (const key in obj) {
                        result[key] = this.convertBigIntsToStrings(obj[key]);
                    }
                    return result;
                }
                return obj;
            },
            
            // Load from backend on init
            async loadFromBackend() {
                if (!window.BACKEND_API_URL) return;
                
                try {
                    const response = await fetch(`${window.BACKEND_API_URL}/api/cache/blockchain?contract=${legalContract.address}`);
                    if (response.ok) {
                        const cached = await response.json();
                        console.log(`Loaded ${cached.length} cached entries from backend`);
                        
                        cached.forEach(entry => {
                            if (Date.now() - entry.timestamp < this.TTL) {
                                const cacheKey = `${entry.type}_${entry.id}`;
                                
                                if (entry.type === 'alert') {
                                    this.alertNotices.set(cacheKey, entry.data);
                                } else if (entry.type === 'document') {
                                    this.documentNotices.set(cacheKey, entry.data);
                                } else if (entry.type === 'notice') {
                                    this.notices.set(cacheKey, entry.data);
                                }
                                
                                this.lastFetch.set(cacheKey, entry.timestamp);
                            }
                        });
                    }
                } catch (error) {
                    console.log('Could not load backend cache:', error);
                }
            },
            
            // Clear cache (useful for debugging or when data changes)
            clear() {
                this.alertNotices.clear();
                this.documentNotices.clear();
                this.notices.clear();
                this.totalNotices = null;
                this.lastFetch.clear();
                console.log('Blockchain cache cleared');
            },
            
            // Invalidate specific entries
            invalidate(type, id) {
                const cacheKey = `${type}_${id}`;
                if (type === 'alert') {
                    this.alertNotices.delete(cacheKey);
                } else if (type === 'document') {
                    this.documentNotices.delete(cacheKey);
                } else if (type === 'notice') {
                    this.notices.delete(cacheKey);
                }
                this.lastFetch.delete(cacheKey);
                console.log(`Invalidated cache for ${type} ${id}`);
            }
        };
        
        // Make cache available globally
        window.blockchainCache = blockchainCache;
        
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize language support for recipient mode
            if (window.LanguageManager) {
                LanguageManager.init();
            }
            
            // Initialize unified system when wallet connects
            if (window.tronWeb && window.tronWeb.ready) {
                setTimeout(async () => {
                    if (window.unifiedSystem) {
                        console.log(' Initializing Unified Notice System...');
                        // Ensure server address is set before init
                        if (!window.unifiedSystem.serverAddress && window.tronWeb.defaultAddress) {
                            window.unifiedSystem.serverAddress = window.tronWeb.defaultAddress.base58;
                            console.log('Pre-setting server address:', window.unifiedSystem.serverAddress);
                        }
                        await window.unifiedSystem.init();
                        // Render cases in the recent activities container
                        window.unifiedSystem.renderCases('unifiedCasesContainer');
                    }
                }, 2000);
            }
            
            // Listen for wallet connection
            window.addEventListener('walletConnected', async () => {
                if (window.unifiedSystem) {
                    // Ensure server address is set
                    if (!window.unifiedSystem.serverAddress && window.tronWeb && window.tronWeb.defaultAddress) {
                        window.unifiedSystem.serverAddress = window.tronWeb.defaultAddress.base58;
                    }
                    await window.unifiedSystem.init();
                    window.unifiedSystem.renderCases('unifiedCasesContainer');
                }
            });
            
            // Initialize Enhanced Energy Rental with Energy.Store via Render backend
            if (window.EnhancedEnergyRental) {
                EnhancedEnergyRental.init({
                    // Using your existing Render backend
                    proxyUrl: 'https://your-backend.onrender.com', // <-- REPLACE WITH YOUR RENDER URL
                    // Example: 'https://nft-service-backend.onrender.com'
                    
                    autoRentEnabled: true,
                    preferredProvider: 'energyStore' // Use Energy.Store as primary via backend
                });
                console.log('Enhanced Energy Rental initialized with Energy.Store via Render backend');
            }
            
            // Apply site configuration
            const siteConfig = getSiteConfig();
            configureSiteForMode(siteConfig);
            
            // Check if user came from a direct notice link and log visit
            const urlParams = new URLSearchParams(window.location.search);
            const noticeParam = urlParams.get('notice');
            if (noticeParam && siteConfig.mode === 'recipient') {
                // Log the visit for BlockServed
                await logRecipientVisit(noticeParam);
            }
            
            // Check if user came from a direct notice link
            checkDirectNoticeLink();
            
            // Check if new user needs onboarding (skip for recipient-only mode)
            if (siteConfig.mode !== 'recipient') {
                checkNewUserOnboarding();
            }
            
            // Hide loader
            setTimeout(() => {
                uiManager.hideLoader();
            }, 500);
            
            // Set up modal protection
            setupModalProtection();
            
            // Set up upload area click handler - delay to ensure modal is ready
            setTimeout(() => {
                const uploadArea = document.getElementById('uploadArea');
                if (uploadArea) {
                    console.log('Setting up upload area click handler');
                    
                    // Find the file input within the upload area
                    const fileInput = uploadArea.querySelector('input[type="file"]');
                    console.log('File input found in upload area:', fileInput);
                    
                    // Add click listener to upload area
                    uploadArea.addEventListener('click', function(e) {
                        console.log('Upload area clicked', e.target);
                        
                        // Don't trigger if clicking the file input itself or the button
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') {
                            return;
                        }
                        
                        // Find the file input within this upload area
                        const fileInputInside = this.querySelector('input[type="file"]');
                        console.log('File input element inside clicked area:', fileInputInside);
                        
                        if (fileInputInside) {
                            // Force click on file input
                            try {
                                fileInputInside.click();
                                console.log('File input clicked successfully');
                            } catch (error) {
                                console.error('Error clicking file input:', error);
                            }
                        } else {
                            console.error('File input not found inside upload area!');
                        }
                    });
                    
                    // Also ensure the file input has the change handler
                    if (fileInput) {
                        console.log('Adding change listener to file input');
                        fileInput.addEventListener('change', handleDocumentUpload);
                    }
                } else {
                    console.log('Upload area not found on page load');
                }
            }, 1000);
            
            
        // Auto-save form data
        function saveFormData() {
            const formData = {
                recipientAddress: document.getElementById('mintRecipient')?.value || '',
                caseNumber: document.getElementById('mintCaseNumber')?.value || '',
                noticeType: document.getElementById('noticeType')?.value || '',
                issuingAgency: document.getElementById('agencyName')?.value || '',
                noticeText: document.getElementById('noticeText')?.value || '',
                tokenName: document.getElementById('mintTokenName')?.value || ''
            };
            localStorage.setItem('noticeFormDraft', JSON.stringify(formData));
        }
        
        // Restore form data
        function restoreFormData() {
            const savedData = localStorage.getItem('noticeFormDraft');
            if (savedData) {
                try {
                    const formData = JSON.parse(savedData);
                    // Map saved keys to actual element IDs
                    const idMap = {
                        recipientAddress: 'mintRecipient',
                        caseNumber: 'mintCaseNumber',
                        noticeType: 'noticeType',
                        issuingAgency: 'agencyName',
                        noticeText: 'noticeText',
                        tokenName: 'mintTokenName'
                    };
                    
                    Object.keys(formData).forEach(key => {
                        const elementId = idMap[key] || key;
                        const element = document.getElementById(elementId);
                        if (element && formData[key]) {
                            element.value = formData[key];
                        }
                    });
                } catch (e) {
                    console.error('Error restoring form data:', e);
                }
            }
        }
        
        // Set up auto-save
        ['mintRecipient', 'mintCaseNumber', 'noticeType', 'agencyName', 'noticeText', 'mintTokenName'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', saveFormData);
            }
        });

        // Initialize tooltips
            initializeTooltips();
            
            // Initialize notifications
            if (legalContract) {
                notificationSystem.init();
                requestNotificationPermission();
            }
            restoreFormData();
            
            // Initialize data from localStorage
            refreshPendingRegistrations();
            updateStatsFromLocalStorage();
            
            // Initialize admin tab visibility
            updateAdminTabVisibility();
            
            // Add click event listener to stats header
            const statsHeader = document.getElementById('statsHeader');
            if (statsHeader) {
                statsHeader.addEventListener('click', toggleStats);
            }
            
            // Add click event listener to wallet status header
            const walletStatusHeader = document.getElementById('walletStatusHeader');
            if (walletStatusHeader) {
                walletStatusHeader.addEventListener('click', toggleWalletStatus);
            }
            
            // Add click event listener to contract header
            const contractHeader = document.getElementById('contractHeader');
            if (contractHeader) {
                contractHeader.addEventListener('click', toggleContract);
            }
            
            // Check if TronWeb is available
            if (window.tronWeb && window.tronWeb.ready) {
                try {
                    await connectWallet();
                    // Also detect network and set contract after auto-connect
                    await detectNetworkAndSetContract();
                } catch (error) {
                    console.error('Error auto-connecting wallet:', error);
                }
            }
            
            // Set up network monitoring
            setupNetworkMonitoring();
            
            // Load saved Pinata keys if in admin panel
            const savedApiKey = localStorage.getItem('pinataApiKey');
            const savedSecretKey = localStorage.getItem('pinataSecretKey');
            if (savedApiKey && document.getElementById('pinataApiKey')) {
                document.getElementById('pinataApiKey').value = savedApiKey;
            }
            if (savedSecretKey && document.getElementById('pinataSecretKey')) {
                document.getElementById('pinataSecretKey').value = savedSecretKey;
            }
            
          // Add input validation
const recipientInput = document.getElementById('mintRecipient');
if (recipientInput) {
    recipientInput.addEventListener('input', validateRecipientAddress);
}

// Setup delivery method selection
const deliveryOptions = document.querySelectorAll('input[name="deliveryMethod"]');
const textNoticeGroup = document.getElementById('textNoticeGroup');
const noticeTextInput = document.getElementById('noticeText');
const charCountSpan = document.getElementById('charCount');

deliveryOptions.forEach(option => {
    option.addEventListener('change', function() {
        // Update selected class
        document.querySelectorAll('.delivery-option').forEach(label => {
            label.classList.remove('selected');
        });
        this.closest('.delivery-option').classList.add('selected');
        
        // Show/hide form sections based on selection
        const viewGatedDetails = document.getElementById('viewGatedDetails');
        const noticeTextLabel = document.getElementById('noticeTextLabel');
        const noticeTextHelp = document.getElementById('noticeTextHelp');
        
        if (this.value === 'document') {
            viewGatedDetails.style.display = 'block';
            textNoticeGroup.style.display = 'block';
            textNoticeGroup.classList.add('active');
            noticeTextLabel.innerHTML = '<i class="fas fa-globe" style="color: #f59e0b;"></i> Public Notice Text';
            noticeTextLabel.style.color = '#92400e';
            noticeTextLabel.style.fontWeight = '600';
            noticeTextHelp.innerHTML = '<i class="fas fa-exclamation-circle"></i> This text will be publicly visible on the blockchain';
        } else if (this.value === 'text') {
            viewGatedDetails.style.display = 'none';
            textNoticeGroup.style.display = 'block';
            textNoticeGroup.classList.add('active');
            noticeTextLabel.textContent = 'Notice Text';
            noticeTextLabel.style.color = '';
            noticeTextLabel.style.fontWeight = '';
            noticeTextHelp.textContent = 'This text will display directly in the recipient\'s wallet';
        } else {
            viewGatedDetails.style.display = 'none';
            textNoticeGroup.style.display = 'none';
            textNoticeGroup.classList.remove('active');
        }
        
        // Update fee estimate
        updateFeeEstimate();
        // Also update the detailed fee display if on step 2
        if (document.getElementById('mintStep2').style.display !== 'none') {
            updateFeeDisplay();
        }
    });
});

// Character counter for text notice
if (noticeTextInput && charCountSpan) {
    noticeTextInput.addEventListener('input', function() {
        const length = this.value.length;
        charCountSpan.textContent = length;
        
        const charCountDiv = this.nextElementSibling;
        if (length >= 90) {
            charCountDiv.classList.add('error');
            charCountDiv.classList.remove('warning');
        } else if (length >= 70) {
            charCountDiv.classList.add('warning');
            charCountDiv.classList.remove('error');
        } else {
            charCountDiv.classList.remove('warning', 'error');
        }
    });
}

// Function to update fee estimate based on delivery method
async function updateFeeEstimate() {
    const selectedMethod = document.querySelector('input[name="deliveryMethod"]:checked').value;
    const feeDisplay = document.querySelector('#creationFeeDisplay');
    const feeDescription = document.querySelector('#feeDescription');
    
    if (feeDisplay) {
        try {
            // Set base fee based on delivery method
            let baseFee = selectedMethod === 'document' ? 150 : 15;
            // Always add 2 TRX sponsorship
            let totalFee = baseFee + 2;
            
            let description = selectedMethod === 'document' 
                ? 'Document fee (150) + Sponsorship (2)' 
                : 'Text fee (15) + Sponsorship (2)';
            
            // Check if contract connection exists for exemption check
            if (legalContract && tronWeb.defaultAddress) {
                try {
                    const userAddress = tronWeb.defaultAddress.base58;
                    const isLawEnforcement = await legalContract.serviceFeeExemptions(userAddress).call();
                    const agencyName = ''; // Complete contract doesn't track agency names
                    const serviceFeeExempt = isLawEnforcement;
                    const fullFeeExempt = isLawEnforcement;
                    
                    if (isLawEnforcement) {
                        totalFee = 2; // Service fee waived, but still pay energy + recipient funding
                        description = `Law Enforcement - Service fee waived (saves 150 TRX) - Still pay energy + 5.5 TRX recipient`;
                    } else if (await checkIfProcessServer()) {
                        totalFee = 75 + 2; // Creation fee + sponsorship
                        description = 'Process Server: Creation fee (75) + Sponsorship (2)';
                    }
                } catch (err) {
                    console.log('Could not check fee exemptions');
                }
            }
            
            // Add energy cost estimate if available
            if (window.EnergyRental && tronWeb.defaultAddress) {
                try {
                    const hasDocument = selectedMethod === 'document';
                    const estimatedEnergy = window.EnergyRental.estimateEnergyNeeded(hasDocument);
                    const currentEnergy = await window.EnergyRental.checkUserEnergy(tronWeb.defaultAddress.base58);
                    
                    if (currentEnergy < estimatedEnergy) {
                        const energyNeeded = estimatedEnergy - currentEnergy;
                        const energyCost = (energyNeeded * 420) / 1_000_000; // 420 SUN per energy
                        totalFee += energyCost;
                        description += ` + Energy (~${energyCost.toFixed(0)} TRX)`;
                    }
                } catch (e) {
                    console.log('Could not estimate energy cost:', e);
                }
            }
            
            feeDisplay.textContent = totalFee.toFixed(0) + ' TRX';
            feeDescription.textContent = description;
            
        } catch (error) {
            console.error('Error calculating fee:', error);
            // Fallback to default fees
            const defaultFee = selectedMethod === 'document' ? '150 TRX' : '15 TRX';
            feeDisplay.textContent = defaultFee;
            feeDescription.textContent = selectedMethod === 'document' 
                ? 'Encrypted document with public text notice' 
                : 'Text only notice (no signature required)';
        }
    }
}

// Update notice template based on type selection
window.updateNoticeTemplate = function() {
    const noticeType = document.getElementById('noticeType').value;
    const customGroup = document.getElementById('customNoticeTypeGroup');
    const legalRights = document.getElementById('legalRights');
    
    // Show/hide custom notice type input
    if (noticeType === 'Custom') {
        customGroup.style.display = 'block';
    } else {
        customGroup.style.display = 'none';
    }
    
    // Don't update legal rights - it will contain the access information
    // Clear the field when notice type changes
    legalRights.value = '';
    legalRights.placeholder = 'Access information will be generated when notice is created';
}

// Initialize admin panel inputs properly
setTimeout(() => {
    // Add role address validation
    const roleAddressInput = document.getElementById('roleAddress');
    if (roleAddressInput) {
        // Ensure input is interactive
        roleAddressInput.style.pointerEvents = 'auto';
        roleAddressInput.style.userSelect = 'text';
        roleAddressInput.disabled = false;
        roleAddressInput.readOnly = false;
        
        roleAddressInput.addEventListener('input', function(e) {
            const address = e.target.value.trim();
            if (address && tronWeb && !tronWeb.isAddress(address)) {
                e.target.classList.add('invalid');
                e.target.classList.remove('valid');
            } else if (address) {
                e.target.classList.add('valid');
                e.target.classList.remove('invalid');
            } else {
                e.target.classList.remove('valid', 'invalid');
            }
        });
    }

    // Add fee collector address validation
    const feeCollectorInput = document.getElementById('feeCollectorAddress');
    if (feeCollectorInput) {
        // Ensure input is interactive
        feeCollectorInput.style.pointerEvents = 'auto';
        feeCollectorInput.style.userSelect = 'text';
        feeCollectorInput.disabled = false;
        feeCollectorInput.readOnly = false;
        
        feeCollectorInput.addEventListener('input', function(e) {
            const address = e.target.value.trim();
            if (address && tronWeb && !tronWeb.isAddress(address)) {
                e.target.classList.add('invalid');
                e.target.classList.remove('valid');
            } else if (address) {
                e.target.classList.add('valid');
                e.target.classList.remove('invalid');
            } else {
                e.target.classList.remove('valid', 'invalid');
            }
        });
    }
    
    // Fix creation fee input
    const creationFeeInput = document.getElementById('creationFee');
    if (creationFeeInput) {
        creationFeeInput.style.pointerEvents = 'auto';
        creationFeeInput.style.userSelect = 'text';
        creationFeeInput.disabled = false;
        creationFeeInput.readOnly = false;
    }
    
    // Also ensure all form inputs in the admin panel are interactive
    const adminInputs = document.querySelectorAll('#adminTab .form-input');
    adminInputs.forEach(input => {
        input.style.pointerEvents = 'auto';
        input.style.userSelect = 'text';
        input.style.webkitUserSelect = 'text';
        input.disabled = false;
        input.readOnly = false;
    });
    
    console.log('Input fields initialized without replacement');
}, 100);
            
            // Add drag and drop support for file upload
            const uploadAreaForDragDrop = document.getElementById('uploadArea');
            if (uploadAreaForDragDrop) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadAreaForDragDrop.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    uploadAreaForDragDrop.addEventListener(eventName, () => {
                        uploadAreaForDragDrop.classList.add('drag-over');
                    }, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    uploadAreaForDragDrop.addEventListener(eventName, () => {
                        uploadAreaForDragDrop.classList.remove('drag-over');
                    }, false);
                });
                
                uploadAreaForDragDrop.addEventListener('drop', function(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    if (files.length > 0) {
                        document.getElementById('documentUpload').files = files;
                        handleDocumentUpload({ target: { files: files } });
                    }
                }, false);
            }
        });

       // Keyboard event handling for modals
document.addEventListener('keydown', function(event) {
    // Don't interfere with input fields
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
        return; // Let the input handle the event normally
    }
    
    if (event.key === 'Escape') {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            }
        });
    }
});

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // Set up network monitoring to detect wallet network changes
        function setupNetworkMonitoring() {
            if (!window.tronWeb) return;
            
            let lastNetwork = null;
            
            // Check network every 2 seconds
            setInterval(async () => {
                if (!window.tronWeb || !window.tronWeb.ready) return;
                
                try {
                    const currentNode = window.tronWeb.fullNode.host;
                    
                    // Detect network from node URL
                    let currentNetwork = 'unknown';
                    if (currentNode.includes('trongrid.io') && !currentNode.includes('nile') && !currentNode.includes('shasta')) {
                        currentNetwork = 'mainnet';
                    } else if (currentNode.includes('nile')) {
                        currentNetwork = 'nile';
                    } else if (currentNode.includes('shasta')) {
                        currentNetwork = 'shasta';
                    }
                    
                    // If network changed, update everything
                    if (lastNetwork && lastNetwork !== currentNetwork) {
                        console.log(`Network changed from ${lastNetwork} to ${currentNetwork}`);
                        
                        // Update UI
                        await detectNetworkAndSetContract();
                        
                        // Show notification
                        uiManager.showNotification('info', `Network switched to ${currentNetwork === 'mainnet' ? 'Mainnet' : currentNetwork === 'nile' ? 'Nile Testnet' : 'Shasta Testnet'}`);
                        
                        // Reconnect contract if needed
                        if (legalContract) {
                            const contractAddress = document.getElementById('contractAddress')?.value;
                            if (contractAddress) {
                                try {
                                    await connectContracts();
                                } catch (e) {
                                    console.error('Error reconnecting contract after network change:', e);
                                }
                            }
                        }
                    }
                    
                    lastNetwork = currentNetwork;
                } catch (error) {
                    console.error('Error monitoring network:', error);
                }
            }, 2000); // Check every 2 seconds
        }
        
        // Detect network and set appropriate contract address
        async function detectNetworkAndSetContract() {
            try {
                if (!window.tronWeb || !window.tronWeb.ready) return;
                
                const contractAddressField = document.getElementById('contractAddress');
                const networkWarning = document.getElementById('networkWarning');
                const tronscanLink = document.getElementById('contractTronscanLink');
                const chainSelector = document.getElementById('chainSelector');
                
                if (!contractAddressField) return;
                
                // Detect network based on fullNode URL (getNodeInfo doesn't exist)
                let detectedNetwork = 'unknown';
                if (tronWeb.fullNode && tronWeb.fullNode.host) {
                    const nodeUrl = tronWeb.fullNode.host;
                    console.log('Detecting network from node URL:', nodeUrl);
                    
                    if (nodeUrl.includes('trongrid.io') && !nodeUrl.includes('nile') && !nodeUrl.includes('shasta')) {
                        detectedNetwork = 'mainnet';
                    } else if (nodeUrl.includes('nile')) {
                        detectedNetwork = 'nile';
                    } else if (nodeUrl.includes('shasta')) {
                        detectedNetwork = 'shasta';
                    }
                }
                
                // Update UI based on detected network
                const networkBadge = document.getElementById('contractNetworkBadge');
                
                if (detectedNetwork === 'mainnet') {
                    currentNetwork = 'mainnet';
                    currentChainType = 'tron';
                    contractAddressField.value = window.CONTRACT_ADDRESSES.mainnet;
                    if (networkWarning) networkWarning.innerHTML = ' Connected to <strong>TRON Mainnet</strong>';
                    if (networkBadge) networkBadge.textContent = 'Mainnet';
                    if (chainSelector) {
                        chainSelector.value = 'tron-mainnet';
                        console.log('Updated dropdown to:', chainSelector.value);
                    }
                    if (tronscanLink) {
                        tronscanLink.href = `https://tronscan.org/#/contract/${window.CONTRACT_ADDRESSES.mainnet}`;
                        tronscanLink.title = 'View on TronScan';
                    }
                    console.log('Detected TRON Mainnet - dropdown updated');
                } else if (detectedNetwork === 'nile') {
                    currentNetwork = 'nile';
                    currentChainType = 'tron';
                    contractAddressField.value = '';
                    if (networkWarning) networkWarning.innerHTML = ' Connected to <strong>Nile Testnet</strong> - No contract deployed. Please switch to Mainnet';
                    if (networkBadge) networkBadge.textContent = 'Nile Testnet';
                    if (chainSelector) {
                        chainSelector.value = 'tron-nile';
                        console.log('Updated dropdown to:', chainSelector.value);
                    }
                    if (tronscanLink) {
                        tronscanLink.href = '#';
                        tronscanLink.title = 'No contract on Nile';
                        tronscanLink.onclick = (e) => { e.preventDefault(); uiManager.showNotification('warning', 'No contract deployed on Nile testnet'); };
                    }
                    console.log('Detected TRON Nile Testnet - No contract available');
                } else if (detectedNetwork === 'shasta') {
                    currentNetwork = 'shasta';
                    currentChainType = 'tron';
                    contractAddressField.value = '';
                    if (networkWarning) networkWarning.innerHTML = ' Connected to <strong>Shasta Testnet</strong> - Contract not deployed';
                    if (networkBadge) networkBadge.textContent = 'Shasta Testnet';
                    if (chainSelector) {
                        chainSelector.value = 'tron-shasta';
                        console.log('Updated dropdown to:', chainSelector.value);
                    }
                    console.log('Detected TRON Shasta Testnet - Contract not deployed');
                } else {
                    if (networkWarning) networkWarning.innerHTML = ' Unknown network - Please connect to TRON Mainnet';
                    if (networkBadge) networkBadge.textContent = 'Unknown';
                }
            } catch (error) {
                console.error('Error detecting network:', error);
                // Default to mainnet since Nile is compromised
                currentNetwork = 'mainnet';
                const contractAddressField = document.getElementById('contractAddress');
                if (contractAddressField) {
                    contractAddressField.value = window.CONTRACT_ADDRESSES.mainnet;
                }
                const networkWarning = document.getElementById('networkWarning');
                if (networkWarning) {
                    networkWarning.innerHTML = ' Network detection failed - Defaulting to Mainnet';
                }
            }
        }
        
        // Show waiting dialog when user goes to external energy rental
        function showEnergyRentalWaitingDialog() {
            // Remove any existing waiting dialogs
            const existingDialog = document.getElementById('energyRentalWaitingDialog');
            if (existingDialog) {
                existingDialog.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'energyRentalWaitingDialog';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '10000';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-clock" style="color: #3b82f6;"></i>
                            Waiting for Energy Rental
                        </h3>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info" style="background: #dbeafe; border-color: #3b82f6;">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>TRONEnergy.market opened in new tab</strong>
                                <p style="margin: 0.5rem 0 0 0;">Please complete the energy rental process there.</p>
                            </div>
                        </div>
                        
                        <div style="margin: 1.5rem 0;">
                            <h4 style="margin-bottom: 1rem;">Steps to complete:</h4>
                            <ol style="text-align: left; line-height: 1.8;">
                                <li> TRONEnergy.market opened in new tab</li>
                                <li>Connect your wallet</li>
                                <li>Rent <strong>1,500,000 energy</strong> for <strong>5 minutes</strong></li>
                                <li>Sign the transaction</li>
                                <li>Wait for order to be filled (energy arrives in wallet)</li>
                                <li>Return here and click "Continue with Transaction"</li>
                            </ol>
                        </div>
                        
                        <div class="alert alert-warning" style="margin-top: 1rem; background: #fef3c7; border-color: #f59e0b;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Important:</strong> Keep this tab open while renting energy!
                        </div>
                        
                        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center;">
                            <button class="btn btn-secondary" onclick="document.getElementById('energyRentalWaitingDialog').remove(); window.energyRentalCancelled = true;">
                                Cancel Transaction
                            </button>
                            <button class="btn btn-primary" onclick="checkEnergyAndContinue()">
                                <i class="fas fa-check"></i>
                                Continue with Transaction
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Check if energy has been rented and continue
        async function checkEnergyAndContinue() {
            try {
                // Check current energy
                if (window.EnergyRental && window.tronWeb && window.tronWeb.defaultAddress) {
                    const currentEnergy = await window.EnergyRental.checkUserEnergy(window.tronWeb.defaultAddress.base58);
                    
                    if (currentEnergy >= 1000000) { // At least 1M energy
                        // Energy has been rented successfully
                        document.getElementById('energyRentalWaitingDialog')?.remove();
                        
                        // Show success notification
                        if (window.uiManager) {
                            window.uiManager.showNotification('success', 
                                `Energy detected! You have ${(currentEnergy / 1000000).toFixed(1)}M energy available.`
                            );
                        }
                        
                        // Trigger the mint process again
                        if (window.createLegalNotice) {
                            window.createLegalNotice();
                        }
                    } else {
                        // Not enough energy yet
                        alert(`Energy not detected yet. Current energy: ${currentEnergy.toLocaleString()}\n\nPlease complete the rental on TRONEnergy.market first.`);
                    }
                } else {
                    alert('Unable to check energy balance. Please ensure your wallet is connected.');
                }
            } catch (error) {
                console.error('Error checking energy:', error);
                alert('Error checking energy balance. Please try again.');
            }
        }
        
        // Show dialog when energy rental fails
        async function showEnergyRentalFailureDialog(energyResult) {
            // Use the new alternatives dialog if available
            if (energyResult.showAlternatives && window.EnergyRental) {
                const result = await window.EnergyRental.showAlternativesDialog(energyResult);
                
                // Handle the user's choice
                if (result.action === 'proceed') {
                    // User wants to burn TRX and proceed
                    return true;
                } else if (result.action === 'external') {
                    // Open external energy rental service
                    window.open(result.option.url, '_blank');
                    
                    // Show a waiting dialog for when they return
                    showEnergyRentalWaitingDialog();
                    return false;
                } else if (result.action === 'stake') {
                    // Open staking guide
                    window.open(result.option.url, '_blank');
                    return false;
                } else {
                    // User cancelled
                    return false;
                }
            }
            
            // Fallback to old dialog if new one not available
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.style.zIndex = '10000';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 class="modal-title">
                                <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                                Energy Rental Unavailable
                            </h3>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning" style="background: #fef3c7; border-color: #f59e0b;">
                                <i class="fas fa-info-circle"></i>
                                <div style="margin-left: 0.5rem;">
                                    <strong>Energy rental service is temporarily unavailable</strong>
                                    <p style="margin: 0.5rem 0 0 0;">
                                        We typically rent energy automatically to reduce your transaction costs by up to 80%. 
                                        Since the rental service is unavailable, you'll need to pay the full network fee.
                                    </p>
                                </div>
                            </div>
                            
                            <div style="margin: 1.5rem 0;">
                                <h4 style="margin-bottom: 1rem;">Cost Comparison:</h4>
                                
                                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem;">
                                    ${energyResult.estimatedBurnCost ? `
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Without Energy Rental:</span>
                                        <strong style="color: #dc2626;">${energyResult.estimatedBurnCost.toFixed(2)} TRX</strong>
                                    </div>
                                    ` : ''}
                                    ${energyResult.estimatedRentalCost ? `
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>With Energy Rental (unavailable):</span>
                                        <strong style="text-decoration: line-through; color: #6b7280;">${energyResult.estimatedRentalCost.toFixed(2)} TRX</strong>
                                    </div>
                                    ` : ''}
                                    ${energyResult.potentialSavings ? `
                                    <div style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid var(--border-color);">
                                        <span>You would have saved:</span>
                                        <strong style="color: #6b7280;">${energyResult.potentialSavings.toFixed(2)} TRX</strong>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <div class="alert alert-info" style="margin-top: 1rem;">
                                    <i class="fas fa-lightbulb"></i>
                                    <p style="margin: 0 0 0 0.5rem;">
                                        <strong>Tip:</strong> If you don't have enough energy in your wallet, the network will automatically 
                                        burn TRX to complete the transaction. This is more expensive but ensures your transaction succeeds.
                                    </p>
                                </div>
                            </div>
                            
                            <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
                                <button class="btn btn-secondary" onclick="this.closest('.modal').remove(); window.energyRentalFailureResolve(false);">
                                    Cancel Transaction
                                </button>
                                <button class="btn btn-primary" onclick="this.closest('.modal').remove(); window.energyRentalFailureResolve(true);">
                                    <i class="fas fa-check"></i>
                                    Proceed Without Energy Rental
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Set up promise resolution
                window.energyRentalFailureResolve = (result) => {
                    delete window.energyRentalFailureResolve;
                    resolve(result);
                };
            });
        }
        
        // Make functions available globally
        window.connectWallet = connectWallet;
        window.detectNetworkAndSetContract = detectNetworkAndSetContract;
        window.switchTab = switchTab;
        window.openRegistrationModal = openRegistrationModal;
        window.closeRegistrationModal = closeRegistrationModal;
        window.closeRegistrationSuccessModal = closeRegistrationSuccessModal;
        window.showEnergyRentalFailureDialog = showEnergyRentalFailureDialog;
        window.showEnergyRentalWaitingDialog = showEnergyRentalWaitingDialog;
        window.checkEnergyAndContinue = checkEnergyAndContinue;
        window.dismissRegistrationNotice = dismissRegistrationNotice;
        window.submitRegistration = submitRegistration;
        window.refreshPendingRegistrations = refreshPendingRegistrations;
        window.approveRegistration = approveRegistration;
        window.openMintModal = openMintModal;
        window.closeMintModal = closeMintModal;
        window.showMintStep = showMintStep;
        window.showMintStep2 = showMintStep2;
        window.changeDocument = changeDocument;
        window.handleDocumentUpload = handleDocumentUpload;
        window.createLegalNotice = createLegalNotice;
        window.previewNFT = previewNFT;
        
        // Show mint step 2
        async function showMintStep2() {
            document.getElementById('mintStep1').style.display = 'none';
            document.getElementById('mintStep2').style.display = 'block';
            
            // Update document preview if available
            if (uploadedImage && uploadedImage.data) {
                const preview = document.getElementById('documentPreview');
                if (preview) {
                    preview.src = uploadedImage.data;
                }
            }
            
            // Update fee display for step 2
            try {
                const selectedMethod = document.querySelector('input[name="deliveryMethod"]:checked')?.value || 'document';
                const baseFee = selectedMethod === 'document' ? 150 : 15;
                const sponsorshipFee = 2;
                
                // Check if law enforcement
                let finalBaseFee = baseFee;
                let totalFee = baseFee + sponsorshipFee;
                
                if (legalContract && tronWeb && tronWeb.defaultAddress) {
                    try {
                        const userAddress = tronWeb.defaultAddress.base58;
                        const isLawEnforcement = await legalContract.serviceFeeExemptions(userAddress).call();
                        
                        if (isLawEnforcement) {
                            finalBaseFee = 0;
                            totalFee = sponsorshipFee;
                            document.getElementById('feeTypeLabel').textContent = 'Law Enforcement (Sponsorship Only):';
                            document.getElementById('baseFeeAmount').textContent = sponsorshipFee + ' TRX';
                        } else {
                            document.getElementById('feeTypeLabel').textContent = selectedMethod === 'document' ? 'Document Notice Fee:' : 'Text Notice Fee:';
                            document.getElementById('baseFeeAmount').textContent = baseFee + ' TRX';
                        }
                    } catch (e) {
                        console.log('Could not check exemptions:', e);
                        document.getElementById('baseFeeAmount').textContent = baseFee + ' TRX';
                    }
                } else {
                    document.getElementById('baseFeeAmount').textContent = baseFee + ' TRX';
                }
                
                // Check energy costs
                let energyCost = 0;
                if (window.EnergyRental && tronWeb.defaultAddress) {
                    try {
                        const hasDocument = document.querySelector('input[name="deliveryMethod"]:checked')?.value === 'document' && uploadedImage;
                        const estimatedEnergy = window.EnergyRental.estimateEnergyNeeded(hasDocument);
                        const currentEnergy = await window.EnergyRental.checkUserEnergy(tronWeb.defaultAddress.base58);
                        
                        if (currentEnergy < estimatedEnergy) {
                            const energyNeeded = estimatedEnergy - currentEnergy;
                            energyCost = (energyNeeded * 420) / 1_000_000; // 420 SUN per energy
                            
                            // Show energy cost row
                            document.getElementById('energyCostDisplay').textContent = energyCost.toFixed(2) + ' TRX';
                            document.getElementById('energyCostRow').style.display = 'flex';
                            
                            // Update energy note
                            document.getElementById('energyNote').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Energy rental may be required (~' + energyCost.toFixed(2) + ' TRX additional).';
                        } else {
                            document.getElementById('energyCostRow').style.display = 'none';
                            document.getElementById('energyNote').innerHTML = '<i class="fas fa-check-circle"></i> You have sufficient energy for this transaction.';
                        }
                    } catch (e) {
                        console.log('Could not check energy:', e);
                    }
                }
                
                // Update total cost
                const finalTotal = totalFee + energyCost;
                document.getElementById('totalCostAmount').textContent = '~' + finalTotal.toFixed(0) + ' TRX';
                
            } catch (e) {
                console.error('Error updating fee display:', e);
            }
        }
        
        // Change document (go back to step 1)
        function changeDocument() {
            document.getElementById('mintStep1').style.display = 'block';
            document.getElementById('mintStep2').style.display = 'none';
            document.getElementById('proceedToStep2').style.display = 'none';
            document.getElementById('compressionStatus').style.display = 'none';
            resetMintForm();
        }
        
        // Document upload handler with encryption
        async function handleDocumentUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const maxSize = 10 * 1024 * 1024; // 10MB limit
            if (file.size > maxSize) {
                uiManager.showNotification('error', 'File size exceeds 10MB limit');
                return;
            }
            
            try {
                // Show processing status
                document.getElementById('compressionStatus').style.display = 'block';
                updateCompressionProgress(10, 'Reading file...');
                
                // Read file as data URL
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        updateCompressionProgress(30, 'Processing document...');
                        
                        // Check if it's a PDF or Word document that needs conversion
                        let documentData = {
                            data: e.target.result,
                            fileName: file.name,
                            fileType: file.type,
                            fileSize: file.size,
                            preview: null
                        };
                        
                        // If it's a PDF or Word doc, convert to images
                        if (file.type === 'application/pdf' || 
                            file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ||
                            file.type === 'application/msword' ||
                            file.name.endsWith('.pdf') || 
                            file.name.endsWith('.doc') || 
                            file.name.endsWith('.docx')) {
                            
                            updateCompressionProgress(40, 'Converting document to images...');
                            
                            try {
                                // Initialize converter if needed
                                if (!window.documentConverter) {
                                    window.documentConverter = new DocumentConverter();
                                    await window.documentConverter.init();
                                }
                                
                                // Convert document
                                const converted = await window.documentConverter.convertDocument(file);
                                
                                // Use the converted data
                                // Handle fullDocument which may be an object or string
                                if (converted.fullDocument && typeof converted.fullDocument === 'object') {
                                    documentData.data = converted.fullDocument.data || converted.fullDocument;
                                } else {
                                    documentData.data = converted.fullDocument;
                                }
                                documentData.preview = converted.preview;
                                documentData.originalType = file.type;
                                documentData.convertedType = 'image/png';
                                
                                updateCompressionProgress(60, 'Document converted successfully...');
                            } catch (convertError) {
                                console.error('Document conversion error:', convertError);
                                // Fall back to original data
                                uiManager.showNotification('warning', 'Document preview may not be available');
                            }
                        }
                        
                        // Store the document data - preserve the structure
                        uploadedImage = documentData;
                        window.uploadedImage = documentData; // Also store globally for thumbnail generator
                        
                        console.log('Stored uploadedImage:', {
                            hasData: !!uploadedImage.data,
                            hasPreview: !!uploadedImage.preview,
                            dataType: uploadedImage.data ? typeof uploadedImage.data : 'none',
                            previewType: uploadedImage.preview ? uploadedImage.preview.substring(0, 50) : 'none'
                        });
                        
                        updateCompressionProgress(70, 'Preparing for encryption...');
                        
                        // Show preview
                        const uploadResult = document.getElementById('uploadResult');
                        const uploadedFileName = document.getElementById('uploadedFileName');
                        const documentPreview = document.getElementById('documentPreview');
                        
                        if (uploadResult && uploadedFileName) {
                            uploadedFileName.textContent = file.name;
                            uploadResult.style.display = 'block';
                        }
                        
                        // Show preview based on file type
                        if (documentPreview) {
                            if (documentData.preview) {
                                // Use the generated preview for PDFs and Word docs
                                documentPreview.src = documentData.preview;
                                documentPreview.style.display = 'block';
                            } else if (file.type.startsWith('image/')) {
                                // Use original for images
                                documentPreview.src = e.target.result;
                                documentPreview.style.display = 'block';
                            } else {
                                // Hide preview for unsupported types
                                documentPreview.style.display = 'none';
                            }
                        }
                        
                        updateCompressionProgress(100, 'Document ready for encrypted delivery');
                        
                        // Show proceed button
                        document.getElementById('proceedToStep2').style.display = 'block';
                        
                        // Hide progress after delay
                        setTimeout(() => {
                            document.getElementById('compressionStatus').style.display = 'none';
                        }, 1500);
                        
                        uiManager.showNotification('success', 'Document uploaded and ready for encryption');
                        
                    } catch (error) {
                        console.error('Error processing document:', error);
                        uiManager.showNotification('error', 'Failed to process document');
                        document.getElementById('compressionStatus').style.display = 'none';
                    }
                };
                
                reader.onerror = function() {
                    uiManager.showNotification('error', 'Failed to read file');
                    document.getElementById('compressionStatus').style.display = 'none';
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('Error uploading document:', error);
                uiManager.showNotification('error', 'Failed to upload document');
                document.getElementById('compressionStatus').style.display = 'none';
            }
        }
        
        function updateCompressionProgress(percent, text) {
            const progressFill = document.getElementById('compressionProgress');
            const progressText = document.getElementById('compressionText');
            const compressionText = document.getElementById('compressionStatusText');
            
            if (progressFill) {
                progressFill.style.width = percent + '%';
            }
            if (progressText) {
                progressText.textContent = percent + '%';
            }
            if (compressionText) {
                compressionText.textContent = text;
            }
        }
        window.openAuditModal = openAuditModal;
        window.closeAuditModal = closeAuditModal;
        window.openAcceptModal = openAcceptModal;
        window.closeAcceptModal = closeAcceptModal;
        
        // Function to audit a specific notice from Recent Activity
        function auditNotice(noticeId) {
            // Open the audit modal
            openAuditModal();
            
            // Set the search type to notice ID
            document.getElementById('auditSearchType').value = 'noticeId';
            
            // Update the search UI
            updateAuditSearch();
            
            // Set the notice ID in the input field
            document.getElementById('auditNoticeId').value = noticeId;
            
            // Automatically perform the search
            performAudit();
        }
        
        window.auditNotice = auditNotice;
        window.closeTransactionResultModal = closeTransactionResultModal;
        window.acceptNotice = acceptNotice;
        
        // Display decrypted document
        function displayDecryptedDocument(documentData, noticeId) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2><i class="fas fa-file-shield" style="color: #10b981;"></i> Decrypted Legal Document</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-success" style="margin-bottom: 1rem;">
                            <i class="fas fa-check-circle"></i>
                            <strong>Document Successfully Decrypted</strong>
                            <p style="margin: 0.25rem 0 0 0;">You have accepted this legal notice. The acceptance has been recorded on the blockchain.</p>
                        </div>
                        
                        <div class="document-content" style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; max-height: 600px; overflow-y: auto;">
                            ${documentData.startsWith('data:image') ? 
                                `<img src="${documentData}" style="max-width: 100%; height: auto;">` :
                                documentData.startsWith('data:application/pdf') ?
                                `<iframe src="${documentData}" style="width: 100%; height: 600px; border: none;"></iframe>` :
                                `<div style="white-space: pre-wrap; font-family: monospace;">${documentData}</div>`
                            }
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i> Close
                        </button>
                        <button class="btn btn-primary" onclick="downloadDocument('${documentData}', 'notice_${noticeId}')">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button class="btn btn-primary" onclick="printDocument('${documentData}')">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        window.displayDecryptedDocument = displayDecryptedDocument;
        
        // Show wallet help modal for recipients
        function showWalletHelp() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header" style="background: #0ea5e9; color: white;">
                        <h2 style="margin: 0;"> How to Download & Sign for Your Document</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()" style="color: white;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="padding: 2rem;">
                        <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #bae6fd;">
                            <p style="margin: 0; color: #0369a1;">
                                <i class="fas fa-shield-alt"></i> <strong>Why a Digital Wallet?</strong> 
                                A digital wallet creates a secure, verified signature that proves you received the document. 
                                It's like signing for certified mail, but more secure and completely private.
                            </p>
                        </div>
                        
                        <h3 style="color: #0f172a; margin-bottom: 1rem;">Simple Steps:</h3>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: start; gap: 1rem; margin-bottom: 1rem;">
                                <div style="background: #0ea5e9; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">1</div>
                                <div>
                                    <h4 style="margin: 0 0 0.5rem 0; color: #0f172a;">Get TronLink Wallet (Free)</h4>
                                    <p style="margin: 0 0 0.5rem 0; color: #64748b;">Download from your phone's app store or browser extension store</p>
                                    <a href="https://www.tronlink.org/" target="_blank" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                                        <i class="fas fa-download"></i> Get TronLink
                                    </a>
                                </div>
                            </div>
                            
                            <div style="display: flex; align-items: start; gap: 1rem; margin-bottom: 1rem;">
                                <div style="background: #0ea5e9; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">2</div>
                                <div>
                                    <h4 style="margin: 0 0 0.5rem 0; color: #0f172a;">Create Your Wallet</h4>
                                    <p style="margin: 0; color: #64748b;">Follow the simple setup - takes about 2 minutes. 
                                    Write down your recovery phrase and keep it safe!</p>
                                </div>
                            </div>
                            
                            <div style="display: flex; align-items: start; gap: 1rem;">
                                <div style="background: #0ea5e9; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">3</div>
                                <div>
                                    <h4 style="margin: 0 0 0.5rem 0; color: #0f172a;">Connect & Sign</h4>
                                    <p style="margin: 0; color: #64748b;">Return here, click "Connect Wallet", and sign for your document. 
                                    The full document will download automatically.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border: 1px solid #fde68a;">
                            <p style="margin: 0; color: #92400e;">
                                <i class="fas fa-gift"></i> <strong>Bonus:</strong> The sender has included 2 TRX 
                                (digital currency) to cover any fees. It's free for you to sign!
                            </p>
                        </div>
                        
                        <div style="text-align: center; margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="this.closest('.modal').remove(); attemptAutoConnect();" style="padding: 0.75rem 2rem;">
                                <i class="fas fa-wallet"></i> I Have a Wallet - Connect Now
                            </button>
                        </div>
                        
                        <p style="text-align: center; margin-top: 1rem; font-size: 0.9rem; color: #64748b;">
                            Questions? <a href="#" onclick="this.closest('.modal').remove(); switchTab('info'); return false;" style="color: #0ea5e9;">View our FAQ</a>
                        </p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Check if user came from a direct notice link
        function checkDirectNoticeLink() {
            // Check for short URL format /n/{noticeId}
            const pathname = window.location.pathname;
            if (pathname.startsWith('/n/')) {
                const noticeId = pathname.replace('/n/', '');
                // Redirect to hash-based URL
                window.location.href = `${window.location.origin}/#notice-${noticeId}`;
                return;
            }
            
            const hash = window.location.hash;
            if (hash.startsWith('#notice-')) {
                const noticeId = hash.replace('#notice-', '');
                
                // Store notice ID for immediate access
                sessionStorage.setItem('directNoticeId', noticeId);
                
                // Check site config for friendly UI
                const siteConfig = getSiteConfig();
                const isFriendlyMode = siteConfig.showFriendlyUI;
                
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                
                if (isFriendlyMode) {
                    // Friendly version for blockserved.com
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 600px; text-align: center;">
                            <div class="modal-header" style="background: #0ea5e9; color: white;">
                                <h2 style="margin: 0;"> You Have a Document to View</h2>
                            </div>
                            <div class="modal-body" style="padding: 2rem;">
                                <h3>Document #${noticeId} is Ready</h3>
                                <p style="font-size: 1.1rem; margin: 1rem 0; color: #64748b;">Someone has sent you an important document that requires your attention.</p>
                                
                                <div style="display: flex; flex-direction: column; gap: 1rem; margin: 1.5rem 0;">
                                    <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem; background: #0ea5e9;" onclick="this.closest('.modal').remove(); viewNoticeWithoutWallet('${noticeId}');">
                                        <i class="fas fa-eye"></i> Quick View Document
                                    </button>
                                    
                                    <button class="btn btn-secondary" style="font-size: 1.1rem; padding: 0.8rem 1.5rem;" onclick="this.closest('.modal').remove(); showWalletHelp();">
                                        <i class="fas fa-download"></i> Download & Sign for Document
                                    </button>
                                </div>
                                
                                <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #bae6fd;">
                                    <p style="font-size: 0.9rem; margin: 0; color: #0369a1;">
                                        <i class="fas fa-info-circle"></i> <strong>Privacy Protected:</strong> View the document safely and securely. Your information remains private.
                                    </p>
                                </div>
                                
                                <p style="margin-top: 1rem; font-size: 0.85rem;">
                                    <a href="#" onclick="this.closest('.modal').remove(); switchTab('info'); return false;" style="color: #0ea5e9;">
                                        Need help? View our FAQ
                                    </a>
                                </p>
                            </div>
                        </div>
                    `;
                } else {
                    // Original version for other domains
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 600px; text-align: center;">
                            <div class="modal-header" style="background: #dc3545; color: white;">
                                <h2 style="margin: 0;"> LEGAL NOTICE - ACTION REQUIRED</h2>
                            </div>
                            <div class="modal-body" style="padding: 2rem;">
                                <h3>You have received Legal Notice #${noticeId}</h3>
                                <p style="font-size: 1.1rem; margin: 1rem 0;">Choose how to view this notice:</p>
                                
                                <div style="display: flex; flex-direction: column; gap: 1rem; margin: 1.5rem 0;">
                                    <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem;" onclick="this.closest('.modal').remove(); viewNoticeWithoutWallet('${noticeId}');">
                                        <i class="fas fa-eye"></i> View Notice (No Wallet Required)
                                    </button>
                                    
                                    <button class="btn btn-secondary" style="font-size: 1.1rem; padding: 0.8rem 1.5rem;" onclick="this.closest('.modal').remove(); attemptAutoConnect();">
                                        <i class="fas fa-wallet"></i> Connect Wallet to Accept Notice
                                    </button>
                                </div>
                                
                                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: left;">
                                    <p style="margin: 0 0 0.5rem 0; font-weight: 600;"> Important:</p>
                                    <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                                        <li>Viewing only does NOT count as legal acceptance</li>
                                        <li>Your IP address and access will still be logged</li>
                                        <li>To legally accept, you must connect your wallet</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                    `;
                }
                document.body.appendChild(modal);
            }
        }
        
        // Attempt to auto-connect and show notice
        async function attemptAutoConnect() {
            try {
                // Check if TronLink is installed
                if (window.tronWeb && window.tronWeb.ready) {
                    // Already connected
                    showDirectNotice();
                } else if (window.tronLink) {
                    // Request connection
                    const res = await window.tronLink.request({ method: 'tron_requestAccounts' });
                    if (res.code === 200) {
                        setTimeout(showDirectNotice, 1000); // Wait for connection
                    }
                } else {
                    // No wallet
                    showNoWalletMessage();
                }
            } catch (error) {
                showNoWalletMessage();
            }
        }
        
        // Show notice immediately after connection
        async function showDirectNotice() {
            const noticeId = sessionStorage.getItem('directNoticeId');
            if (!noticeId) return;
            
            try {
                // Detect network and set contract first
                await detectNetworkAndSetContract();
                
                // Load contract if needed
                if (!legalContract) {
                    // Connect to the contract using the address from the field
                    const contractAddress = document.getElementById('contractAddress')?.value;
                    if (contractAddress) {
                        legalContract = await tronWeb.contract(CONTRACT_ABI, contractAddress);
                window.legalContract = legalContract; // Make globally accessible
                    } else {
                        throw new Error('No contract address available');
                    }
                }
                
                // Get notice details
                const notice = await legalContract.notices(noticeId).call();
                
                // Check if user owns this notice
                const owner = await legalContract.ownerOf(noticeId).call();
                if (owner.toLowerCase() !== tronWeb.defaultAddress.base58.toLowerCase()) {
                    alert('This notice is not for your wallet address.');
                    return;
                }
                
                // Show simplified accept modal
                showSimplifiedAcceptModal(noticeId, notice);
                
            } catch (error) {
                console.error('Error loading notice:', error);
                alert('Error loading notice. Please try refreshing the page.');
            }
        }
        
        // Simplified accept modal - one click to view
        function showSimplifiedAcceptModal(noticeId, notice) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header" style="background: #dc3545; color: white;">
                        <h2 style="margin: 0;">Legal Notice #${noticeId}</h2>
                    </div>
                    <div class="modal-body" style="text-align: center; padding: 2rem;">
                        <h3>Legal Document Encrypted</h3>
                        <p style="font-size: 1.1rem; margin: 1.5rem 0;">
                            Click below to accept this notice and view the document.
                        </p>
                        
                        <button class="btn btn-primary" style="font-size: 1.3rem; padding: 1rem 3rem;" onclick="acceptNoticeDirectly('${noticeId}')">
                            <i class="fas fa-eye"></i> ACCEPT & VIEW DOCUMENT
                        </button>
                        
                        <div style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                            <p style="margin: 0; color: #666;">
                                <strong> Legal Notice:</strong> By clicking above, you acknowledge receipt of this legal notice. 
                                Your IP address and access time will be recorded.
                            </p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Direct acceptance - minimal steps
        async function acceptNoticeDirectly(noticeId) {
            try {
                // Show confirmation modal first
                const confirmed = await showTransactionConfirmation('acceptNotice', {
                    noticeId: noticeId
                });
                
                if (!confirmed) {
                    return;
                }
                
                showProcessing('Accepting notice and decrypting document...');
                
                // Accept and get notice in one flow
                const notice = await legalContract.notices(noticeId).call();
                const hasDocument = (notice.packedData & 1) === 1;
                
                // Capture IP data immediately
                const ipData = await captureIPData();
                
                // Accept notice
                const result = await legalContract.acceptNotice(noticeId).send({
                    feeLimit: 100_000_000,
                    shouldPollResponse: true
                });
                
                // Store law enforcement data
                const acceptanceData = {
                    noticeId: noticeId,
                    transactionHash: result.txid || result,
                    walletAddress: tronWeb.defaultAddress.base58,
                    acceptanceTime: new Date().toISOString(),
                    timestamp: Date.now(),
                    acceptanceTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    acceptanceLanguage: navigator.language,
                    browserType: getBrowserType(),
                    userAgent: navigator.userAgent,
                    screenResolution: `${screen.width}x${screen.height}`,
                    ipAddress: ipData.ip,
                    location: {
                        country: ipData.country,
                        region: ipData.region,
                        city: ipData.city
                    },
                    country: ipData.country,
                    region: ipData.region,
                    city: ipData.city,
                    isp: ipData.isp,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    acceptanceProof: await generateAcceptanceProof(noticeId, result)
                };
                
                await storeAcceptanceDataForLawEnforcement(noticeId, acceptanceData);
                
                hideProcessing();
                
                // If has document, decrypt and show immediately
                if (hasDocument && result) {
                    showProcessing('Decrypting document...');
                    
                    const [ipfsHash] = notice.documentData.split('|');
                    const decryptionKey = result;
                    
                    const encryptedData = await SimpleEncryption.fetchFromIPFS(ipfsHash);
                    const decryptedData = SimpleEncryption.decryptDocument(encryptedData, decryptionKey);
                    
                    hideProcessing();
                    
                    // Close all modals
                    document.querySelectorAll('.modal').forEach(m => m.remove());
                    
                    // Show document immediately
                    displayDecryptedDocument(decryptedData, noticeId);
                } else {
                    // Text notice - show immediately
                    document.querySelectorAll('.modal').forEach(m => m.remove());
                    alert(`Notice Accepted\n\n${notice.publicText}`);
                }
                
                // Clear session
                sessionStorage.removeItem('directNoticeId');
                
            } catch (error) {
                hideProcessing();
                console.error('Error:', error);
                alert('Error accepting notice. Please try again.');
            }
        }
        
        // Show no wallet message
        function showNoWalletMessage() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; text-align: center;">
                    <div class="modal-header" style="background: #dc3545; color: white;">
                        <h2 style="margin: 0;">Wallet Required</h2>
                    </div>
                    <div class="modal-body" style="padding: 2rem;">
                        <h3>TronLink Wallet Not Found</h3>
                        <p>You need TronLink wallet to view this legal notice.</p>
                        
                        <a href="https://www.tronlink.org/" target="_blank" class="btn btn-primary" style="font-size: 1.1rem;">
                            <i class="fas fa-download"></i> Install TronLink
                        </a>
                        
                        <p style="margin-top: 1rem; color: #666;">
                            After installing, return to this page to view your notice.
                        </p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        window.attemptAutoConnect = attemptAutoConnect;
        window.acceptNoticeDirectly = acceptNoticeDirectly;
        window.showDirectNotice = showDirectNotice;
        
        // View notice without wallet (still captures IP/device data)
        async function viewNoticeWithoutWallet(noticeId) {
            try {
                showProcessing('Loading notice for viewing...');
                
                // Capture IP and device data immediately
                const ipData = await captureIPData();
                
                // Log view attempt (not acceptance)
                const viewData = {
                    noticeId: noticeId,
                    viewTime: new Date().toISOString(),
                    viewType: 'VIEW_ONLY_NO_WALLET',
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    language: navigator.language,
                    browserType: getBrowserType(),
                    userAgent: navigator.userAgent,
                    screenResolution: `${screen.width}x${screen.height}`,
                    ipAddress: ipData.ip,
                    country: ipData.country,
                    region: ipData.region,
                    city: ipData.city,
                    isp: ipData.isp,
                    timestamp: Date.now()
                };
                
                // Store view data for law enforcement
                const viewLogs = JSON.parse(localStorage.getItem('noticeViewLogs') || '{}');
                if (!viewLogs[noticeId]) viewLogs[noticeId] = [];
                viewLogs[noticeId].push(viewData);
                localStorage.setItem('noticeViewLogs', JSON.stringify(viewLogs));
                
                console.log('Notice view logged (no wallet):', {
                    noticeId: noticeId,
                    ip: ipData.ip,
                    location: `${ipData.city}, ${ipData.region}, ${ipData.country}`,
                    timestamp: viewData.viewTime
                });
                
                hideProcessing();
                
                // Check site config
                const siteConfig = getSiteConfig();
                const isFriendlyMode = siteConfig.showFriendlyUI;
                
                // Show notice preview modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                
                if (isFriendlyMode) {
                    // Friendly version for recipients
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 800px;">
                            <div class="modal-header" style="background: #0ea5e9; color: white;">
                                <h2 style="margin: 0;"> Document Preview - #${noticeId}</h2>
                                <button class="close-btn" onclick="this.closest('.modal').remove()" style="color: white;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info" style="margin-bottom: 1.5rem; background: #e0f2fe; border: 1px solid #7dd3fc;">
                                    <i class="fas fa-info-circle" style="color: #0284c7;"></i>
                                    <strong style="color: #0284c7;">Preview Mode</strong>
                                    <p style="margin: 0.5rem 0 0 0; color: #0c4a6e;">You're viewing a preview of this document. To download the full version and create a verified receipt, please connect a wallet.</p>
                                </div>
                                
                                <div style="background: #f8f9fa; padding: 2rem; border-radius: 8px; text-align: center;">
                                    <h3>Document Summary</h3>
                                    <p style="font-size: 1.1rem; margin: 1rem 0; color: #64748b;">
                                        This document has been sent to you securely via blockchain technology.
                                    </p>
                                    <p style="margin: 1rem 0;">
                                        <strong>Document ID:</strong> #${noticeId}<br>
                                        <strong>Type:</strong> Encrypted Document<br>
                                        <strong>Status:</strong> Ready for Download
                                    </p>
                                    
                                    <div style="margin-top: 2rem; padding: 1.5rem; background: white; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <i class="fas fa-file-shield" style="font-size: 3rem; color: #0ea5e9; margin-bottom: 1rem;"></i>
                                        <h4 style="color: #0f172a;">Secure Document</h4>
                                        <p style="color: #64748b;">This document is encrypted for your privacy. Connect a wallet to decrypt and download.</p>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 2rem; text-align: center;">
                                    <h4 style="color: #0f172a;">Ready to Download?</h4>
                                    <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem; margin-top: 1rem; background: #0ea5e9;" onclick="this.closest('.modal').remove(); showWalletHelp();">
                                        <i class="fas fa-download"></i> Download Full Document
                                    </button>
                                    <p style="margin-top: 1rem; color: #64748b;">
                                        Already have a wallet? 
                                        <a href="#" onclick="this.closest('.modal').remove(); attemptAutoConnect(); return false;" style="color: #0ea5e9;">
                                            Connect Now
                                        </a>
                                    </p>
                                </div>
                                
                                <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin-top: 2rem; border: 1px solid #bae6fd;">
                                    <p style="margin: 0; color: #0369a1; font-size: 0.9rem;">
                                        <i class="fas fa-shield-alt"></i> <strong>Your Privacy Matters:</strong>
                                        This system uses blockchain technology to ensure secure, verifiable document delivery while protecting your privacy.
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Original version
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 800px;">
                            <div class="modal-header" style="background: #dc3545; color: white;">
                                <h2 style="margin: 0;"> LEGAL NOTICE #${noticeId} - VIEWING ONLY</h2>
                                <button class="close-btn" onclick="this.closest('.modal').remove()" style="color: white;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning" style="margin-bottom: 1.5rem;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>This is VIEW ONLY - Not Legal Acceptance</strong>
                                    <p style="margin: 0.5rem 0 0 0;">You are viewing this notice without wallet verification. This does NOT constitute legal acceptance of service.</p>
                                    <p style="margin: 0.5rem 0 0 0;">Your IP address (${ipData.ip}) and location (${ipData.city}, ${ipData.country}) have been logged.</p>
                                </div>
                            
                            <div style="background: #f8f9fa; padding: 2rem; border-radius: 8px; text-align: center;">
                                <h3>Notice Summary</h3>
                                <p style="font-size: 1.1rem; margin: 1rem 0;">
                                    This legal notice contains an encrypted document that can only be viewed by the wallet owner.
                                </p>
                                <p style="margin: 1rem 0;">
                                    <strong>Notice Type:</strong> Legal Service Document<br>
                                    <strong>Recipient Wallet:</strong> View requires wallet connection<br>
                                    <strong>Status:</strong> Awaiting Acceptance
                                </p>
                                
                                <div style="margin-top: 2rem; padding: 1.5rem; background: white; border: 2px dashed #dc3545; border-radius: 8px;">
                                    <i class="fas fa-lock" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i>
                                    <h4 style="color: #dc3545;">Encrypted Legal Document</h4>
                                    <p>The full document is encrypted and requires wallet authentication to decrypt and view.</p>
                                </div>
                            </div>
                            
                            <div style="margin-top: 2rem; text-align: center;">
                                <h4>To Accept This Notice and View the Full Document:</h4>
                                <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem; margin-top: 1rem;" onclick="this.closest('.modal').remove(); attemptAutoConnect();">
                                    <i class="fas fa-wallet"></i> Connect Wallet & Accept Notice
                                </button>
                            </div>
                            
                            <div class="alert alert-info" style="margin-top: 2rem;">
                                <i class="fas fa-info-circle"></i>
                                <strong>Legal Notice:</strong>
                                <p style="margin: 0.5rem 0 0 0;">
                                    This is an official legal notice. Failure to properly accept and respond may result in default judgment or other legal consequences.
                                    Your viewing of this notice has been recorded at ${new Date().toLocaleString('en-US', { 
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        second: '2-digit',
                                        timeZoneName: 'short'
                                    })}.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                }
                document.body.appendChild(modal);
                
            } catch (error) {
                hideProcessing();
                console.error('Error viewing notice:', error);
                alert('Error loading notice preview.');
            }
        }
        
        window.viewNoticeWithoutWallet = viewNoticeWithoutWallet;
        
        // Check if new user needs onboarding
        function checkNewUserOnboarding() {
            // Skip if coming from notice link
            if (window.location.hash.startsWith('#notice-')) return;
            
            // Check if user has seen onboarding
            const hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding');
            if (!hasSeenOnboarding) {
                showOnboardingModal();
            }
        }
        
        // Show onboarding modal for new users
        function showOnboardingModal() {
            const siteConfig = getSiteConfig();
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            if (siteConfig.showFriendlyUI) {
                // Recipient-focused onboarding for blockserved.com
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 700px;">
                        <div class="modal-header" style="background: #0ea5e9; color: white;">
                            <h2 style="margin: 0;"><i class="fas fa-envelope-open-text"></i> Welcome to Block Record</h2>
                        </div>
                        <div class="modal-body" style="padding: 2rem;">
                            <h3 style="text-align: center; margin-bottom: 2rem;">You Have a Legal Document Waiting</h3>
                            
                            <div style="background: #fffbeb; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 2px solid #f59e0b;">
                                <h4 style="color: #78350f;"><i class="fas fa-exclamation-triangle"></i> Important Legal Notice</h4>
                                <p style="color: #451a03;">Someone has sent you an official document that requires your attention. Ignoring legal notices can result in:</p>
                                <ul style="color: #451a03; margin: 0.5rem 0 0 0;">
                                    <li>Default judgment against you</li>
                                    <li>Loss of legal rights</li>
                                    <li>Asset seizure or forfeiture</li>
                                </ul>
                            </div>
                            
                            <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                <h4><i class="fas fa-shield-alt"></i> What You Need to Know</h4>
                                <ul style="margin: 0.5rem 0 0 0;">
                                    <li><strong>It's Safe:</strong> We never ask for money or private keys</li>
                                    <li><strong>It's Free:</strong> The sender paid all fees (2 TRX included)</li>
                                    <li><strong>It's Legal:</strong> This creates an official record of receipt</li>
                                    <li><strong>It's Private:</strong> Only you can decrypt your document</li>
                                </ul>
                            </div>
                            
                            <div style="background: #e0f2fe; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 2px solid #0ea5e9;">
                                <h4 style="color: #0369a1;"><i class="fas fa-info-circle"></i> Accepting Does NOT Mean You Agree</h4>
                                <p style="color: #0c4a6e; margin: 0.5rem 0 0 0;">
                                    Accepting the notice simply confirms you received it - like signing for certified mail. 
                                    It preserves your right to respond and defend yourself.
                                </p>
                            </div>
                            
                            <div style="text-align: center; margin-top: 2rem;">
                                <button class="btn btn-primary" onclick="completeOnboarding()" style="font-size: 1.1rem; padding: 0.75rem 2rem;">
                                    <i class="fas fa-check"></i> I Understand - Continue
                                </button>
                                <div style="margin-top: 1rem;">
                                    <a href="#" onclick="switchTab('info'); document.querySelector('.modal').remove(); return false;" style="color: #0ea5e9;">
                                        <i class="fas fa-question-circle"></i> View FAQ for More Information
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Original process server onboarding
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 700px;">
                        <div class="modal-header" style="background: var(--primary-blue); color: white;">
                            <h2 style="margin: 0;"><i class="fas fa-rocket"></i> Welcome to NFT Legal Service</h2>
                        </div>
                    <div class="modal-body" style="padding: 2rem;">
                        <h3 style="text-align: center; margin-bottom: 2rem;">Getting Started Guide</h3>
                        
                        <!-- Step 1: Get TronLink Wallet -->
                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4><i class="fas fa-download"></i> Step 1: Get TronLink Wallet</h4>
                            <p>You'll need a TRON wallet to use this service. TronLink is the recommended wallet:</p>
                            <div style="margin-top: 1rem;">
                                <a href="https://www.tronlink.org/" target="_blank" class="btn btn-primary" style="margin-right: 0.5rem;">
                                    <i class="fas fa-external-link-alt"></i> Download TronLink
                                </a>
                                <span style="color: var(--text-secondary); font-size: 0.9rem;">Available for Chrome, Firefox, Edge, and mobile</span>
                            </div>
                        </div>
                        
                        <!-- Identity Warning Box -->
                        <div style="background: #dc3545; color: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 2px solid #a02020;">
                            <h4 style="margin: 0 0 0.5rem 0;"><i class="fas fa-exclamation-triangle"></i> Critical: Your Wallet IS Your Identity</h4>
                            <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem;">
                                <li>All notices and data are permanently tied to your wallet address</li>
                                <li>You can ONLY see notices YOU have sent</li>
                                <li>Lost wallet = Lost access to all historical data</li>
                                <li>No password recovery - wallet is the only key</li>
                                <li><strong>Write down your seed phrase and store it safely!</strong></li>
                            </ul>
                        </div>
                        
                        <!-- Step 2: Connect Wallet -->
                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4><i class="fas fa-plug"></i> Step 2: Connect Your Wallet</h4>
                            <p>Your wallet connection serves as your login to this system:</p>
                            <ul style="margin: 0.5rem 0 0 0;">
                                <li>Click "Connect Wallet" in the top navigation</li>
                                <li>Approve the connection in TronLink</li>
                                <li>Your wallet address becomes your unique identifier</li>
                                <li>No username/password needed - wallet is your secure login</li>
                            </ul>
                        </div>
                        
                        <!-- How the System Works -->
                        <div style="display: grid; gap: 1rem; margin: 1.5rem 0;">
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                <h5><i class="fas fa-user-shield"></i> Register as Process Server</h5>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.95rem;">Get approved by an admin to start serving legal notices</p>
                            </div>
                            
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                <h5><i class="fas fa-file-upload"></i> Upload Documents</h5>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.95rem;">Convert legal documents to blockchain notices</p>
                            </div>
                            
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                <h5><i class="fas fa-paper-plane"></i> Serve to Any Wallet</h5>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.95rem;">Send notices directly to TRON wallet addresses</p>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                            <label style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <input type="checkbox" id="understoodOnboarding">
                                <span>I understand my wallet is my only access key and have secured my seed phrase</span>
                            </label>
                            
                            <button class="btn btn-primary" onclick="completeOnboarding()" disabled id="continueOnboarding" style="margin-right: 1rem;">
                                <i class="fas fa-check"></i> Continue to App
                            </button>
                            
                            <a href="#" onclick="switchTab('info'); setTimeout(() => document.querySelector('.faq-header').click(), 100); document.querySelector('.modal').remove(); return false;" style="color: var(--accent-blue);">
                                <i class="fas fa-question-circle"></i> View FAQ
                            </a>
                        </div>
                    </div>
                </div>
            `;
            }
            
            document.body.appendChild(modal);
            
            // Enable button when checkbox checked (only for process server version)
            const checkbox = document.getElementById('understoodOnboarding');
            if (checkbox) {
                checkbox.addEventListener('change', function(e) {
                    document.getElementById('continueOnboarding').disabled = !e.target.checked;
                });
            }
        }
        
        // Complete onboarding
        function completeOnboarding() {
            localStorage.setItem('hasSeenOnboarding', 'true');
            document.querySelector('.modal').remove();
            
            // If wallet not connected, prompt
            if (!window.tronWeb || !window.tronWeb.ready) {
                setTimeout(() => {
                    alert('Please connect your TronLink wallet to continue.');
                }, 500);
            }
        }
        
        window.checkNewUserOnboarding = checkNewUserOnboarding;
        window.completeOnboarding = completeOnboarding;
        
        // Batch Operations Implementation
        let batchRecipients = [];
        let batchProgress = {
            total: 0,
            completed: 0,
            failed: 0,
            inProgress: false,
            paused: false,
            currentIndex: 0
        };
        
        // Toggle batch mode
        function toggleBatchMode() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2><i class="fas fa-users"></i> Batch Legal Notice Operations</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Batch Mode:</strong> Send the same legal notice to multiple recipients
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Upload Recipients CSV</label>
                            <div class="document-upload-area" style="padding: 1.5rem; text-align: center;">
                                <i class="fas fa-file-csv" style="font-size: 3rem; color: var(--accent-blue); margin-bottom: 1rem;"></i>
                                <h4>Upload CSV File</h4>
                                <p>Format: wallet_address,name,reference</p>
                                <input type="file" id="batchCSV" accept=".csv" onchange="handleBatchCSVUpload(event)" style="display: none;">
                                <button class="btn btn-primary" onclick="document.getElementById('batchCSV').click()">
                                    <i class="fas fa-upload"></i> Choose CSV File
                                </button>
                            </div>
                            
                            <div class="form-help" style="margin-top: 1rem;">
                                <strong>CSV Format Example:</strong>
                                <pre style="background: var(--bg-secondary); padding: 0.5rem; border-radius: 4px; font-size: 0.85rem;">TXa1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6,John Doe,Case #12345
TYz9y8x7w6v5u4t3s2r1q0p9o8n7m6l5k4,Jane Smith,Case #67890
TZa1s2d3f4g5h6j7k8l9q0w9e8r7t6y5u4,Bob Johnson,Case #11111</pre>
                            </div>
                        </div>
                        
                        <div id="batchValidationResults" style="display: none; margin-top: 1rem;">
                            <!-- Validation results will appear here -->
                        </div>
                        
                        <div id="batchRecipientsList" style="display: none; margin-top: 1rem;">
                            <h4>Recipients Preview</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Wallet Address</th>
                                            <th>Name</th>
                                            <th>Reference</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="batchRecipientsTable">
                                        <!-- Recipients will be listed here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" id="proceedBatchBtn" onclick="proceedWithBatch()" style="display: none;">
                            <i class="fas fa-arrow-right"></i> Proceed to Notice Details
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Handle batch CSV upload
        function handleBatchCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const validation = validateBatchCSV(content);
                
                if (validation.errors.length > 0) {
                    showBatchValidationErrors(validation.errors);
                } else {
                    batchRecipients = validation.recipients;
                    showBatchRecipientsList(batchRecipients);
                }
            };
            reader.readAsText(file);
        }
        
        // Validate batch CSV
        function validateBatchCSV(csvContent) {
            const lines = csvContent.trim().split('\n');
            const errors = [];
            const recipients = [];
            const seenAddresses = new Set();
            
            if (lines.length === 0) {
                errors.push('CSV file is empty');
                return { errors, recipients };
            }
            
            if (lines.length > 100) {
                errors.push('Maximum 100 recipients per batch (current: ' + lines.length + ')');
            }
            
            lines.forEach((line, index) => {
                const fields = line.split(',').map(f => f.trim());
                
                if (fields.length < 1) {
                    errors.push(`Line ${index + 1}: No wallet address provided`);
                    return;
                }
                
                const [address, name = '', reference = ''] = fields;
                
                // Validate address
                if (!address) {
                    errors.push(`Line ${index + 1}: Empty wallet address`);
                } else if (!tronWeb.isAddress(address)) {
                    errors.push(`Line ${index + 1}: Invalid wallet address '${address}'`);
                } else if (seenAddresses.has(address.toLowerCase())) {
                    errors.push(`Line ${index + 1}: Duplicate address '${address}'`);
                } else {
                    seenAddresses.add(address.toLowerCase());
                    recipients.push({
                        address: address,
                        name: name.substring(0, 50), // Limit name length
                        reference: reference.substring(0, 50), // Limit reference length
                        status: 'pending',
                        index: index
                    });
                }
            });
            
            return { errors, recipients };
        }
        
        // Show validation errors
        function showBatchValidationErrors(errors) {
            const resultsDiv = document.getElementById('batchValidationResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Validation Errors:</strong>
                    <ul style="margin: 0.5rem 0 0 1rem;">
                        ${errors.map(err => `<li>${err}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        // Show recipients list
        function showBatchRecipientsList(recipients) {
            document.getElementById('batchValidationResults').style.display = 'none';
            document.getElementById('batchRecipientsList').style.display = 'block';
            document.getElementById('proceedBatchBtn').style.display = 'inline-block';
            
            const tbody = document.getElementById('batchRecipientsTable');
            tbody.innerHTML = recipients.map(r => `
                <tr>
                    <td style="font-family: monospace; font-size: 0.85rem;">${r.address}</td>
                    <td>${r.name || '-'}</td>
                    <td>${r.reference || '-'}</td>
                    <td><span class="badge badge-secondary">Ready</span></td>
                </tr>
            `).join('');
        }
        
        // Proceed with batch
        function proceedWithBatch() {
            document.querySelector('.modal').remove();
            showBatchNoticeCreation();
        }
        
        // Show batch notice creation
        function showBatchNoticeCreation() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2><i class="fas fa-users"></i> Batch Notice Details (${batchRecipients.length} Recipients)</h2>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Important:</strong> The same notice will be sent to all ${batchRecipients.length} recipients
                        </div>
                        
                        <!-- Copy the notice creation form here but for batch -->
                        <div class="form-group">
                            <label class="form-label">Notice Type</label>
                            <select class="form-select" id="batchNoticeType">
                                <option value="Summons">Summons</option>
                                <option value="Subpoena">Subpoena</option>
                                <option value="Complaint">Complaint</option>
                                <option value="Motion">Motion</option>
                                <option value="Order">Order</option>
                                <option value="Notice">Notice</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Upload Document (Same for all recipients)</label>
                            <div class="document-upload-area" style="padding: 1rem;">
                                <input type="file" id="batchDocument" accept=".pdf,.doc,.docx,image/*" onchange="handleBatchDocumentUpload(event)">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Public Notice Text</label>
                            <textarea class="form-input" id="batchNoticeText" rows="4" placeholder="Enter public notice text..." style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.3);"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Case Number</label>
                            <input type="text" class="form-input" id="batchCaseNumber" placeholder="e.g., 2024-CV-12345">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Issuing Agency</label>
                            <input type="text" class="form-input" id="batchIssuingAgency" placeholder="e.g., District Court">
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Batch Fees:</strong>
                            <ul style="margin: 0.5rem 0 0 1rem;">
                                <li>Document notices: ${batchRecipients.length}  150 TRX = ${batchRecipients.length * 150} TRX</li>
                                <li>Text notices: ${batchRecipients.length}  15 TRX = ${batchRecipients.length * 15} TRX</li>
                                <li>Energy will be calculated before sending</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="cancelBatch()">Cancel</button>
                        <button class="btn btn-primary" onclick="startBatchSending()">
                            <i class="fas fa-paper-plane"></i> Start Batch Send
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Handle batch document upload
        let batchDocument = null;
        function handleBatchDocumentUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Same as regular document upload but for batch
                batchDocument = file;
                uiManager.showNotification('success', 'Document uploaded for batch send');
            }
        }
        
        // Start batch sending
        async function startBatchSending() {
            if (!legalContract || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet first');
                return;
            }
            
            const noticeData = {
                noticeType: document.getElementById('batchNoticeType').value,
                noticeText: document.getElementById('batchNoticeText').value.trim(),
                caseNumber: document.getElementById('batchCaseNumber').value.trim(),
                issuingAgency: document.getElementById('batchIssuingAgency').value.trim(),
                hasDocument: !!batchDocument
            };
            
            if (noticeData.hasDocument && !batchDocument) {
                uiManager.showNotification('error', 'Please upload a document');
                return;
            }
            
            if (!noticeData.noticeText) {
                uiManager.showNotification('error', 'Please enter notice text');
                return;
            }
            
            // Close current modal and show progress
            document.querySelector('.modal').remove();
            showBatchProgress();
            
            // Start processing
            batchProgress = {
                total: batchRecipients.length,
                completed: 0,
                failed: 0,
                inProgress: true,
                paused: false,
                currentIndex: 0
            };
            
            processBatchRecipients(noticeData);
        }
        
        // Show batch progress
        function showBatchProgress() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2><i class="fas fa-tasks"></i> Batch Processing Progress</h2>
                    </div>
                    <div class="modal-body">
                        <div class="progress-container" style="margin-bottom: 2rem;">
                            <div class="progress-bar" style="height: 30px; background: #e9ecef; border-radius: 15px; overflow: hidden;">
                                <div id="batchProgressBar" class="progress-fill" style="width: 0%; height: 100%; background: var(--accent-blue); transition: width 0.3s;">
                                    <span id="batchProgressText" style="position: absolute; width: 100%; text-align: center; line-height: 30px; color: white; font-weight: 600;">0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
                            <div class="stat-card" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700;" id="batchTotal">${batchRecipients.length}</div>
                                <div style="color: var(--text-secondary);">Total</div>
                            </div>
                            <div class="stat-card" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: #28a745;" id="batchCompleted">0</div>
                                <div style="color: var(--text-secondary);">Completed</div>
                            </div>
                            <div class="stat-card" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: #dc3545;" id="batchFailed">0</div>
                                <div style="color: var(--text-secondary);">Failed</div>
                            </div>
                            <div class="stat-card" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: #ffc107;" id="batchRemaining">${batchRecipients.length}</div>
                                <div style="color: var(--text-secondary);">Remaining</div>
                            </div>
                        </div>
                        
                        <div id="batchCurrentStatus" style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                            <strong>Current:</strong> <span id="currentRecipient">Starting...</span>
                        </div>
                        
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Recipient</th>
                                        <th>Status</th>
                                        <th>Notice ID</th>
                                        <th>Error</th>
                                    </tr>
                                </thead>
                                <tbody id="batchResultsTable">
                                    ${batchRecipients.map((r, i) => `
                                        <tr id="batchRow${i}">
                                            <td>${i + 1}</td>
                                            <td style="font-family: monospace; font-size: 0.85rem;">${r.address.substring(0, 10)}...${r.address.substring(r.address.length - 8)}</td>
                                            <td><span class="badge badge-secondary">Pending</span></td>
                                            <td>-</td>
                                            <td>-</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="pauseBatchBtn" onclick="toggleBatchPause()">
                            <i class="fas fa-pause"></i> Pause
                        </button>
                        <button class="btn btn-primary" onclick="downloadBatchResults()">
                            <i class="fas fa-download"></i> Download Results
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Process batch recipients
        async function processBatchRecipients(noticeData) {
            // Process document once if needed
            let encryptedDocumentData = null;
            if (noticeData.hasDocument && batchDocument) {
                showBatchStatus('Preparing document for encryption...');
                // Read and prepare document (this would be encrypted per recipient in actual sending)
                const reader = new FileReader();
                const documentData = await new Promise((resolve) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(batchDocument);
                });
                encryptedDocumentData = documentData;
            }
            
            // Process each recipient
            for (let i = batchProgress.currentIndex; i < batchRecipients.length; i++) {
                if (!batchProgress.inProgress || batchProgress.paused) break;
                
                const recipient = batchRecipients[i];
                batchProgress.currentIndex = i;
                
                showBatchStatus(`Processing ${i + 1}/${batchRecipients.length}: ${recipient.address}`);
                updateBatchRowStatus(i, 'processing', 'Processing...');
                
                try {
                    // Add small delay to prevent overwhelming the network
                    if (i > 0) await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Create notice for this recipient
                    const result = await createBatchNotice(recipient, noticeData, encryptedDocumentData);
                    
                    batchProgress.completed++;
                    updateBatchRowStatus(i, 'success', 'Sent', result.noticeId);
                    
                } catch (error) {
                    console.error(`Failed to send to ${recipient.address}:`, error);
                    batchProgress.failed++;
                    updateBatchRowStatus(i, 'failed', 'Failed', null, error.message);
                }
                
                updateBatchProgress();
            }
            
            // Batch complete
            if (batchProgress.completed + batchProgress.failed >= batchProgress.total) {
                showBatchComplete();
            }
        }
        
        // Create individual batch notice
        async function createBatchNotice(recipient, noticeData, documentData) {
            // Similar to regular notice creation but with batch recipient
            const fee = noticeData.hasDocument ? 150e6 : 15e6;
            
            let encryptedData = null;
            if (noticeData.hasDocument && documentData) {
                // Encrypt document for this specific recipient
                const encryptionKey = SimpleEncryption.generateEncryptionKey(
                    tronWeb.defaultAddress.base58,
                    recipient.address,
                    Date.now()
                );
                
                // Compress document if needed
                let dataToEncrypt = documentData;
                if (documentData.length > 1000000 && window.documentConverter && window.documentConverter.compressImage) {
                    try {
                        dataToEncrypt = await window.documentConverter.compressImage(documentData, 500000);
                    } catch (compressionError) {
                        console.error('Document compression failed for batch:', compressionError);
                        // Use original document if compression fails
                        dataToEncrypt = documentData;
                    }
                }
                
                const encryptedDoc = SimpleEncryption.encryptDocument(dataToEncrypt, encryptionKey);
                const ipfsHash = await SimpleEncryption.uploadToIPFS(encryptedDoc);
                
                encryptedData = {
                    ipfsHash: ipfsHash,
                    encryptionKey: encryptionKey
                };
            }
            
            const noticeRequest = {
                recipient: recipient.address,
                publicText: noticeData.noticeText,
                noticeType: noticeData.noticeType,
                caseNumber: noticeData.caseNumber,
                issuingAgency: noticeData.issuingAgency,
                baseTokenName: `Legal Notice - ${recipient.reference || recipient.name || 'Batch'}`,
                hasDocument: noticeData.hasDocument,
                encryptedIPFS: encryptedData ? encryptedData.ipfsHash : '',
                encryptedKey: encryptedData ? encryptedData.encryptionKey : ''
            };
            
            const result = await legalContract.serveNotice(
                noticeRequest.recipient,
                noticeRequest.encryptedIPFS || '',
                noticeRequest.encryptedKey || '',
                noticeRequest.issuingAgency || '',
                noticeRequest.noticeType || '',
                noticeRequest.caseNumber || '',
                noticeRequest.publicText || '',
                '', // legalRights
                fee > 20000000, // sponsorFees if paying more than base fee
                '' // metadataURI - not implemented for this flow yet
            ).send({
                feeLimit: 100_000_000,
                callValue: fee,
                shouldPollResponse: true
            });
            
            // Extract notice ID from result
            let noticeId = null;
            if (result && result.length > 0) {
                const eventData = result[0];
                noticeId = eventData.noticeId || eventData._noticeId || eventData[0];
            }
            
            return { noticeId, txHash: result.txid || result };
        }
        
        // Update batch progress
        function updateBatchProgress() {
            const percent = Math.round((batchProgress.completed + batchProgress.failed) / batchProgress.total * 100);
            document.getElementById('batchProgressBar').style.width = percent + '%';
            document.getElementById('batchProgressText').textContent = percent + '%';
            document.getElementById('batchCompleted').textContent = batchProgress.completed;
            document.getElementById('batchFailed').textContent = batchProgress.failed;
            document.getElementById('batchRemaining').textContent = batchProgress.total - batchProgress.completed - batchProgress.failed;
        }
        
        // Update batch row status
        function updateBatchRowStatus(index, status, message, noticeId = null, error = null) {
            const row = document.getElementById(`batchRow${index}`);
            if (!row) return;
            
            const cells = row.getElementsByTagName('td');
            
            // Status badge
            let badgeClass = 'badge-secondary';
            if (status === 'processing') badgeClass = 'badge-warning';
            else if (status === 'success') badgeClass = 'badge-success';
            else if (status === 'failed') badgeClass = 'badge-danger';
            
            cells[2].innerHTML = `<span class="badge ${badgeClass}">${message}</span>`;
            
            // Notice ID
            if (noticeId) {
                cells[3].textContent = noticeId;
            }
            
            // Error message
            if (error) {
                cells[4].textContent = error.substring(0, 50);
                cells[4].title = error; // Full error on hover
            }
        }
        
        // Show batch status
        function showBatchStatus(message) {
            document.getElementById('currentRecipient').textContent = message;
        }
        
        // Show batch complete
        function showBatchComplete() {
            showBatchStatus(`Complete! Sent: ${batchProgress.completed}, Failed: ${batchProgress.failed}`);
            document.getElementById('pauseBatchBtn').disabled = true;
            
            if (batchProgress.failed === 0) {
                uiManager.showNotification('success', `All ${batchProgress.completed} notices sent successfully!`);
            } else {
                uiManager.showNotification('warning', `Batch complete. Sent: ${batchProgress.completed}, Failed: ${batchProgress.failed}`);
            }
        }
        
        // Toggle batch pause
        function toggleBatchPause() {
            batchProgress.paused = !batchProgress.paused;
            const btn = document.getElementById('pauseBatchBtn');
            
            if (batchProgress.paused) {
                btn.innerHTML = '<i class="fas fa-play"></i> Resume';
                showBatchStatus('Paused - Click Resume to continue');
            } else {
                btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                showBatchStatus('Resuming...');
                processBatchRecipients(lastBatchNoticeData); // Resume where left off
            }
        }
        
        // Download batch results
        function downloadBatchResults() {
            const results = batchRecipients.map((r, i) => {
                const row = document.getElementById(`batchRow${i}`);
                const cells = row ? row.getElementsByTagName('td') : [];
                
                return {
                    index: i + 1,
                    address: r.address,
                    name: r.name,
                    reference: r.reference,
                    status: cells[2] ? cells[2].textContent : 'Unknown',
                    noticeId: cells[3] ? cells[3].textContent : '-',
                    error: cells[4] ? cells[4].textContent : '-'
                };
            });
            
            const csv = [
                'Index,Address,Name,Reference,Status,Notice ID,Error',
                ...results.map(r => 
                    `${r.index},"${r.address}","${r.name}","${r.reference}","${r.status}","${r.noticeId}","${r.error}"`
                )
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `batch_results_${new Date().getTime()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Cancel batch
        function cancelBatch() {
            if (confirm('Are you sure you want to cancel the batch operation?')) {
                batchProgress.inProgress = false;
                batchRecipients = [];
                document.querySelector('.modal').remove();
            }
        }
        
        // Store last batch data for resume
        let lastBatchNoticeData = null;
        
        window.toggleBatchMode = toggleBatchMode;
        window.handleBatchCSVUpload = handleBatchCSVUpload;
        window.proceedWithBatch = proceedWithBatch;
        window.handleBatchDocumentUpload = handleBatchDocumentUpload;
        window.startBatchSending = startBatchSending;
        window.toggleBatchPause = toggleBatchPause;
        window.downloadBatchResults = downloadBatchResults;
        window.cancelBatch = cancelBatch;
        
        window.checkDirectNoticeLink = checkDirectNoticeLink;
        
        // Copy wallet address for Telegram
        function copyWalletAddress() {
            if (tronWeb && tronWeb.defaultAddress) {
                const address = tronWeb.defaultAddress.base58;
                navigator.clipboard.writeText(address).then(() => {
                    uiManager.showNotification('success', 'Wallet address copied to clipboard!');
                }).catch(() => {
                    // Fallback
                    const textArea = document.createElement('textarea');
                    textArea.value = address;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    uiManager.showNotification('success', 'Wallet address copied!');
                });
            } else {
                uiManager.showNotification('error', 'Please connect your wallet first');
            }
        }
        
        window.copyWalletAddress = copyWalletAddress;
        
        // Privacy-compliant browser detection
        function getBrowserType() {
            const ua = navigator.userAgent;
            if (ua.includes('Firefox')) return 'Firefox';
            if (ua.includes('Chrome')) return 'Chrome';
            if (ua.includes('Safari')) return 'Safari';
            if (ua.includes('Edge')) return 'Edge';
            return 'Other';
        }
        
        // Generate cryptographic proof of acceptance
        async function generateAcceptanceProof(noticeId, txResult) {
            const proofData = {
                noticeId: noticeId,
                timestamp: Date.now(),
                txHash: txResult.txid || txResult,
                walletAddress: tronWeb.defaultAddress.base58
            };
            
            // Create a hash of the proof data
            const proofString = JSON.stringify(proofData);
            const proofHash = tronWeb.sha3(proofString);
            
            // Sign the hash with the wallet
            try {
                const signature = await tronWeb.trx.sign(proofHash);
                return {
                    hash: proofHash,
                    signature: signature,
                    timestamp: proofData.timestamp
                };
            } catch (error) {
                return { hash: proofHash, timestamp: proofData.timestamp };
            }
        }
        
        // Capture IP data using free IP geolocation service
        async function captureIPData() {
            try {
                // Using ipapi.co free tier (no API key needed for basic data)
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                
                return {
                    ip: data.ip || 'Unknown',
                    country: data.country_name || 'Unknown',
                    countryCode: data.country_code || 'Unknown',
                    region: data.region || 'Unknown',
                    city: data.city || 'Unknown',
                    latitude: data.latitude || null,
                    longitude: data.longitude || null,
                    isp: data.org || 'Unknown',
                    timezone: data.timezone || 'Unknown'
                };
            } catch (error) {
                console.error('Error capturing IP data:', error);
                // Fallback to basic data
                return {
                    ip: 'Could not determine',
                    country: 'Unknown',
                    region: 'Unknown',
                    city: 'Unknown',
                    isp: 'Unknown'
                };
            }
        }
        
        // Store acceptance data for law enforcement access
        async function storeAcceptanceDataForLawEnforcement(noticeId, data) {
            try {
                // Store in localStorage for now (in production, would send to secure server)
                const acceptances = JSON.parse(localStorage.getItem('lawEnforcementData') || '{}');
                acceptances[noticeId] = data;
                localStorage.setItem('lawEnforcementData', JSON.stringify(acceptances));
                
                // Make available for process server dashboard
                window.lastAcceptanceData = data;
                
                // Send acceptance data to backend if available
                if (window.BACKEND_API_URL) {
                    try {
                        const response = await fetch(`${window.BACKEND_API_URL}/api/notices/${noticeId}/acceptances`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                acceptorAddress: data.walletAddress,
                                transactionHash: data.transactionHash,
                                ipAddress: data.ipAddress,
                                location: {
                                    country: data.country,
                                    region: data.region,
                                    city: data.city,
                                    lat: data.lat,
                                    lon: data.lon
                                },
                                timestamp: data.acceptanceTime
                            })
                        });
                        
                        if (response.ok) {
                            console.log('Acceptance data sent to backend successfully');
                        } else {
                            console.error('Backend response error:', response.status);
                        }
                    } catch (backendError) {
                        console.error('Failed to send acceptance to backend:', backendError);
                        // Don't fail the acceptance if backend logging fails
                    }
                }
                
                console.log('Law enforcement data captured:', {
                    noticeId: noticeId,
                    ip: data.ipAddress,
                    location: `${data.city}, ${data.region}, ${data.country}`,
                    timestamp: data.acceptanceTime
                });
            } catch (error) {
                console.error('Error storing law enforcement data:', error);
            }
        }
        
        // Update telegram wallet display when wallet connects
        function updateTelegramWalletDisplay() {
            const elem = document.getElementById('userWalletForTelegram');
            if (elem && tronWeb && tronWeb.defaultAddress) {
                elem.textContent = tronWeb.defaultAddress.base58;
            }
        }
        window.closeTxModal = closeTxModal;
        window.exportReceipt = exportReceipt;
        window.closeRegistrationModal = closeRegistrationModal;
        window.submitRegistration = submitRegistration;
        window.openRegistrationForUser = openRegistrationForUser;
        window.updateAuditSearch = updateAuditSearch;
        window.performAudit = performAudit;
        window.refreshMyAlerts = refreshMyAlerts;
        window.showAddAttemptModal = showAddAttemptModal;
        window.closeServiceAttemptModal = closeServiceAttemptModal;
        window.recordServiceAttempt = recordServiceAttempt;
        window.printAcceptanceReceipt = printAcceptanceReceipt;
        window.viewNoticeDetails = viewNoticeDetails;
        window.viewNoticeAuditTrail = viewNoticeAuditTrail;
        window.generateAlertReceipt = generateAlertReceipt;
        window.generateDocumentReceipt = generateDocumentReceipt;
        window.exportNoticeData = exportNoticeData;
        
        // Update audit search UI based on search type
        function updateAuditSearch() {
            const searchType = document.getElementById('auditSearchType').value;
            const searchInput = document.getElementById('auditSearchInput');
            const searchButton = document.getElementById('performAuditBtn');
            
            if (searchType === 'myNotices' || searchType === 'myAlerts') {
                // Hide search input for "My" options
                if (searchInput) searchInput.style.display = 'none';
                if (searchButton) {
                    searchButton.innerHTML = '<i class="fas fa-list"></i> Load Notices';
                }
            } else {
                // Show search input for specific notice ID
                if (searchInput) searchInput.style.display = 'block';
                if (searchButton) {
                    searchButton.innerHTML = '<i class="fas fa-search"></i> Search';
                }
            }
        }
        
        // Perform audit based on search type
        async function performAudit() {
            const searchType = document.getElementById('auditSearchType').value;
            const resultsDiv = document.getElementById('auditResults');
            
            if (!legalContract || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet and contract first');
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loading">Loading...</div>';
            
            try {
                if (searchType === 'noticeId') {
                    // Search by specific notice ID
                    const noticeId = document.getElementById('auditNoticeId').value;
                    if (!noticeId) {
                        uiManager.showNotification('error', 'Please enter a notice ID');
                        resultsDiv.innerHTML = '';
                        return;
                    }
                    
                    // Get notice details - try different methods based on contract version
                    let accepted = false;
                    let notice = null;
                    
                    try {
                        // Try v5 contract method first
                        notice = await legalContract.notices(noticeId).call();
                        if (notice && notice.packedData !== undefined) {
                            // Extract acceptance status from packed data
                            accepted = ((BigInt(notice.packedData) >> 1n) & 1n) === 1n;
                        }
                    } catch (e) {
                        console.log('Could not get notice from notices mapping, trying alert/document notices');
                    }
                    
                    // If that didn't work, try alert notices
                    if (!notice) {
                        try {
                            const alertData = await legalContract.alertNotices(noticeId).call();
                            if (alertData && Array.isArray(alertData) && alertData.length > 4) {
                                accepted = alertData[4] === true || alertData[4] === 'true' || alertData[4] === 1;
                                notice = {
                                    server: alertData[1],
                                    recipient: alertData[0],
                                    noticeData: alertData[2], // documentId
                                    timestamp: alertData[3]
                                };
                            }
                        } catch (e) {
                            console.log('Could not get alert notice data');
                        }
                    }
                    
                    // Display single notice
                    resultsDiv.innerHTML = await formatNoticeForAudit(notice, noticeId, accepted);
                    
                } else if (searchType === 'myNotices') {
                    // Get notices from stored transactions since Complete contract doesn't have totalSupply
                    const transactions = JSON.parse(localStorage.getItem('userTransactions') || '[]');
                    const myNotices = [];
                    
                    // Filter transactions by current user
                    const userTransactions = transactions.filter(tx => 
                        tx.sender && tx.sender.toLowerCase() === tronWeb.defaultAddress.base58.toLowerCase()
                    );
                    
                    // Try to fetch notice details for each transaction
                    for (const tx of userTransactions) {
                        if (tx.noticeId) {
                            try {
                                const notice = await legalContract.notices(tx.noticeId).call();
                                if (notice && notice.sender) {
                                    // Extract acceptance status from packed data
                                    const accepted = ((BigInt(notice.packedData) >> 1n) & 1n) === 1n;
                                    myNotices.push({ 
                                        id: tx.noticeId, 
                                        notice, 
                                        accepted,
                                        txData: tx 
                                    });
                                }
                            } catch (e) {
                                console.log(`Notice ${tx.noticeId} may not exist on chain`);
                            }
                        }
                    }
                    
                    // Display results
                    if (myNotices.length === 0 && userTransactions.length === 0) {
                        resultsDiv.innerHTML = '<p>No notices found. Notices you create will appear here.</p>';
                    } else if (myNotices.length === 0 && userTransactions.length > 0) {
                        // Show transaction data even if we can't fetch from blockchain
                        resultsDiv.innerHTML = '<h4>My Issued Notices (from transaction history)</h4>' + 
                            '<div class="notice-list">' +
                            userTransactions.map(tx => `
                                <div class="notice-item" style="border: 1px solid var(--border-color); padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem;">
                                    <div class="notice-header" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <strong>${tx.alertId ? `Alert Notice #${tx.alertId}` : ''}${tx.documentId ? ` / Document Notice #${tx.documentId}` : ''}${!tx.alertId && !tx.documentId ? `Notice #${tx.noticeId || 'Unknown'}` : ''}</strong>
                                        <span style="color: var(--text-secondary);">${new Date(tx.timestamp).toLocaleString()}</span>
                                    </div>
                                    <div>Recipient: ${tx.recipient}</div>
                                    <div>Type: ${tx.noticeType || 'Legal Notice'}</div>
                                    <div>Fee: ${tx.fee} TRX</div>
                                    ${tx.txid ? `<div>TX: <a href="${getTxScanUrl()}${tx.txid}" target="_blank">${tx.txid.substring(0, 10)}...</a></div>` : ''}
                                </div>
                            `).join('') +
                            '</div>';
                    } else {
                        const formattedNotices = await Promise.all(
                            myNotices.map(n => formatNoticeForAudit(n.notice, n.id, n.accepted))
                        );
                        resultsDiv.innerHTML = '<h4>My Issued Notices</h4>' + formattedNotices.join('');
                    }
                    
                } else if (searchType === 'myAlerts') {
                    // Get notices where current user is recipient
                    try {
                        // Use getRecipientNoticeIds function to get all notices for current user
                        const noticeIds = await getRecipientNoticeIds(tronWeb.defaultAddress.base58);
                        const myAlerts = [];
                        
                        for (const noticeId of noticeIds) {
                            try {
                                const notice = await legalContract.notices(noticeId).call();
                                if (notice && notice.recipient) {
                                    // Extract acceptance status from packed data
                                    const accepted = ((BigInt(notice.packedData) >> 1n) & 1n) === 1n;
                                    myAlerts.push({ id: noticeId, notice, accepted });
                                }
                            } catch (e) {
                                console.error(`Error fetching notice ${noticeId}:`, e);
                            }
                        }
                        
                        // Display results
                        if (myAlerts.length === 0) {
                            resultsDiv.innerHTML = '<p>No alert notices found. Legal notices sent to your wallet will appear here.</p>';
                        } else {
                            const formattedAlerts = await Promise.all(
                                myAlerts.map(n => formatNoticeForAudit(n.notice, n.id, n.accepted))
                            );
                            resultsDiv.innerHTML = '<h4>My Alert Notices</h4>' + formattedAlerts.join('');
                        }
                    } catch (e) {
                        console.error('Error getting recipient notices:', e);
                        resultsDiv.innerHTML = '<p>No alert notices found.</p>';
                    }
                }
                
            } catch (error) {
                console.error('Audit error:', error);
                uiManager.showNotification('error', 'Failed to perform audit: ' + error.message);
                resultsDiv.innerHTML = '<p class="error">Error loading notices.</p>';
            }
        }
        
        // Format notice for audit display
        async function formatNoticeForAudit(notice, noticeId, accepted) {
            const acceptedTime = accepted ? new Date(Number(accepted) * 1000).toLocaleString() : 'Not accepted';
            const status = accepted ? 'Accepted' : 'Pending';
            const statusClass = accepted ? 'status-accepted' : 'status-pending';
            
            // Get acceptance data if available
            let acceptanceDataHtml = '';
            let printReceiptBtn = '';
            try {
                const acceptanceData = JSON.parse(localStorage.getItem('lawEnforcementData') || '{}')[noticeId];
                if (acceptanceData && accepted) {
                    // Get transaction hash from blockchain events if available
                    const txHash = acceptanceData.transactionHash || '';
                    
                    acceptanceDataHtml = `
                        <div style="margin-top: 1rem; padding: 1rem; background: #d1fae5; border-radius: 0.5rem; border: 1px solid #10b981;">
                            <h5 style="margin: 0 0 0.5rem 0; color: #047857;">
                                <i class="fas fa-check-circle"></i> Electronic Signature & Acceptance Details
                            </h5>
                            <div style="background: white; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #10b981;">
                                <div style="display: grid; gap: 0.5rem;">
                                    <div><strong>Acceptance Time:</strong> ${acceptanceData.acceptanceTime}</div>
                                    <div><strong>IP Address:</strong> ${acceptanceData.ipAddress}</div>
                                    <div><strong>Location:</strong> ${acceptanceData.city}, ${acceptanceData.region}, ${acceptanceData.country}</div>
                                    <div><strong>ISP:</strong> ${acceptanceData.isp}</div>
                                    <div><strong>Timezone:</strong> ${acceptanceData.acceptanceTimezone}</div>
                                    <div><strong>Browser:</strong> ${acceptanceData.browserType}</div>
                                    <div><strong>Screen Resolution:</strong> ${acceptanceData.screenResolution}</div>
                                    <div><strong>Language:</strong> ${acceptanceData.acceptanceLanguage}</div>
                                    ${txHash ? `
                                        <div>
                                            <strong>Blockchain Transaction:</strong> 
                                            <a href="https://tronscan.org/#/transaction/${txHash}" target="_blank" style="color: #3b82f6;">
                                                View on TronScan <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    printReceiptBtn = `
                        <button class="btn btn-primary btn-small" onclick="printAcceptanceReceipt('${noticeId}')" style="margin-top: 0.5rem;">
                            <i class="fas fa-print"></i> Print Proof of Acceptance
                        </button>
                    `;
                }
            } catch (error) {
                console.error('Error getting acceptance data:', error);
            }
            
            // Get visit logs for this notice
            let visitLogsHtml = '';
            try {
                const allVisitLogs = JSON.parse(localStorage.getItem('noticeVisitLogs') || '{}');
                const noticeVisits = allVisitLogs[noticeId];
                
                if (noticeVisits && noticeVisits.length > 0) {
                    visitLogsHtml = `
                        <div style="margin-top: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 0.5rem; border: 1px solid #3b82f6;">
                            <h5 style="margin: 0 0 0.5rem 0; color: #1e40af;">
                                <i class="fas fa-eye"></i> Recipient Visit Log (${noticeVisits.length} visit${noticeVisits.length > 1 ? 's' : ''})
                            </h5>
                            ${noticeVisits.map((visit, index) => `
                                <div style="background: white; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 0.5rem; border: 1px solid #ddd;">
                                    <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.25rem;">
                                        Visit #${index + 1} - ${new Date(visit.timestamp).toLocaleString()}
                                    </div>
                                    <div style="display: grid; gap: 0.25rem; font-size: 0.875rem;">
                                        <div><strong>IP Address:</strong> ${visit.ip}</div>
                                        <div><strong>Location:</strong> ${visit.location.city}, ${visit.location.region}, ${visit.location.country}</div>
                                        <div><strong>Timezone:</strong> ${visit.location.timezone}</div>
                                        ${visit.location.latitude ? `<div><strong>Coordinates:</strong> ${visit.location.latitude}, ${visit.location.longitude}</div>` : ''}
                                        <div><strong>Device:</strong> ${visit.screenResolution}  ${visit.language}</div>
                                        <div style="font-size: 0.75rem; color: #666; word-break: break-all;">
                                            <strong>User Agent:</strong> ${visit.userAgent}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else if (!accepted) {
                    visitLogsHtml = `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 0.5rem;">
                            <p style="margin: 0; color: #92400e;">
                                <i class="fas fa-exclamation-triangle"></i>
                                No visits logged yet - recipient has not viewed this notice
                            </p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error getting visit logs:', error);
            }
            
            // Check for service attempts (v4 contract feature)
            let serviceAttemptsHtml = '';
            let addAttemptBtn = '';
            try {
                const attempts = await legalContract.serviceAttempts(noticeId).call();
                const attemptCount = Number(attempts);
                
                if (attemptCount > 0) {
                    const lastNote = await legalContract.lastAttemptNote(noticeId).call();
                    serviceAttemptsHtml = `
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--warning-bg, #fef3c7); border-radius: 0.5rem;">
                            <p><strong>Service Attempts:</strong> ${attemptCount}</p>
                            ${lastNote ? `<p><strong>Last Attempt Note:</strong> ${lastNote}</p>` : ''}
                        </div>
                    `;
                }
                
                // Show add attempt button if user is the server and notice is not accepted
                if (!accepted && notice.server === tronWeb.defaultAddress.base58) {
                    addAttemptBtn = `
                        <button class="btn btn-secondary btn-small" onclick="showAddAttemptModal(${noticeId})" style="margin-top: 0.5rem;">
                            <i class="fas fa-plus"></i> Record Service Attempt
                        </button>
                    `;
                }
            } catch (e) {
                console.log('Service attempts not available (may be using older contract)');
            }
            
            // Determine if this is an Alert or Document NFT based on the data structure
            let nftTypeLabel = 'Notice';
            if (notice) {
                // Check for alert-specific fields
                if (notice.sender && notice.recipient && notice.timestamp) {
                    nftTypeLabel = 'Alert Notice';
                }
                // Check for document-specific fields
                if (notice.encryptedIPFS || notice.decryptionKey || notice.authorizedViewer) {
                    nftTypeLabel = 'Document Notice';
                }
                // If we have both alert and document IDs
                if (notice.alertId && notice.documentId) {
                    nftTypeLabel = 'Alert & Document Notice';
                }
            }
            
            return `
                <div class="audit-item">
                    <div class="audit-header">
                        <h5>${nftTypeLabel} #${noticeId}</h5>
                        <span class="status ${statusClass}">${status}</span>
                    </div>
                    <div class="audit-details">
                        <p><strong>Notice Type:</strong> ${notice.noticeType || 'Legal Notice'}</p>
                        <p><strong>NFT Type:</strong> ${nftTypeLabel}</p>
                        <p><strong>Recipient:</strong> ${notice.recipient}</p>
                        <p><strong>Sender:</strong> ${notice.sender}</p>
                        <p><strong>Created:</strong> ${new Date(Number(notice.timestamp) * 1000).toLocaleString()}</p>
                        <p><strong>Accepted:</strong> ${acceptedTime}</p>
                        ${notice.hasDocument ? '<p><strong>Document:</strong> Encrypted document attached</p>' : ''}
                        ${notice.publicText ? `<p><strong>Public Text:</strong> ${notice.publicText}</p>` : ''}
                        ${acceptanceDataHtml}
                        ${visitLogsHtml}
                        ${serviceAttemptsHtml}
                        ${addAttemptBtn}
                        ${printReceiptBtn}
                    </div>
                </div>
            `;
        }
        
        // Show add service attempt modal
        function showAddAttemptModal(noticeId) {
            document.getElementById('attemptNoticeId').value = noticeId;
            document.getElementById('attemptNote').value = '';
            document.getElementById('serviceAttemptModal').style.display = 'block';
        }
        
        // Close service attempt modal
        function closeServiceAttemptModal() {
            document.getElementById('serviceAttemptModal').style.display = 'none';
        }
        
        // Record service attempt
        async function recordServiceAttempt() {
            const noticeId = document.getElementById('attemptNoticeId').value;
            const note = document.getElementById('attemptNote').value.trim();
            
            if (!note) {
                uiManager.showNotification('error', 'Please enter an attempt note');
                return;
            }
            
            if (!legalContract || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet and contract first');
                return;
            }
            
            try {
                showProcessing('Recording service attempt...');
                
                const tx = await legalContract.recordServiceAttempt(noticeId, note).send({
                    feeLimit: 100_000_000,
                    shouldPollResponse: true
                });
                
                console.log('Service attempt recorded:', tx);
                
                uiManager.showNotification('success', 'Service attempt recorded successfully');
                closeServiceAttemptModal();
                
                // Refresh the audit display
                await performAudit();
                
            } catch (error) {
                console.error('Failed to record service attempt:', error);
                uiManager.showNotification('error', 'Failed to record attempt: ' + error.message);
            } finally {
                hideProcessing();
            }
        }
        
        // Print acceptance receipt
        async function printAcceptanceReceipt(noticeId) {
            try {
                // Get acceptance data from localStorage
                const acceptanceData = JSON.parse(localStorage.getItem('lawEnforcementData') || '{}');
                const noticeData = acceptanceData[noticeId];
                
                if (!noticeData) {
                    uiManager.showNotification('error', 'No acceptance data found for this notice');
                    return;
                }
                
                // Get notice details from contract
                let noticeDetails = null;
                let alertDetails = null;
                
                try {
                    // Try to get notice details
                    const notices = await legalContract.notices(noticeId).call();
                    if (notices && notices.alertId) {
                        const alertId = notices.alertId.toString();
                        alertDetails = await legalContract.alertNotices(alertId).call();
                    }
                } catch (error) {
                    console.error('Error fetching notice details:', error);
                }
                
                // Create printable receipt
                const receiptWindow = window.open('', '_blank');
                const receiptDate = new Date(noticeData.timestamp).toLocaleString();
                const txUrl = `https://tronscan.org/#/transaction/${noticeData.transactionHash || 'N/A'}`;
                
                const receiptHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Proof of Acceptance - Notice #${noticeId}</title>
                        <style>
                            @page {
                                size: letter;
                                margin: 0.5in;
                            }
                            body {
                                font-family: Arial, sans-serif;
                                line-height: 1.6;
                                color: #333;
                                max-width: 8.5in;
                                margin: 0 auto;
                                padding: 20px;
                            }
                            .header {
                                text-align: center;
                                border-bottom: 3px double #000;
                                padding-bottom: 20px;
                                margin-bottom: 30px;
                            }
                            .header h1 {
                                margin: 0;
                                font-size: 24px;
                                color: #000;
                            }
                            .header h2 {
                                margin: 10px 0 0 0;
                                font-size: 18px;
                                color: #666;
                            }
                            .section {
                                margin-bottom: 25px;
                                padding: 15px;
                                background: #f9f9f9;
                                border: 1px solid #ddd;
                                border-radius: 5px;
                            }
                            .section h3 {
                                margin-top: 0;
                                color: #333;
                                font-size: 16px;
                                border-bottom: 1px solid #ddd;
                                padding-bottom: 8px;
                            }
                            .field {
                                margin-bottom: 12px;
                                display: flex;
                                align-items: baseline;
                            }
                            .field label {
                                font-weight: bold;
                                min-width: 180px;
                                margin-right: 10px;
                            }
                            .field .value {
                                flex: 1;
                                word-break: break-word;
                            }
                            .signature-section {
                                background: #e8f4fd;
                                border: 2px solid #2196F3;
                                padding: 20px;
                                margin-top: 30px;
                                text-align: center;
                            }
                            .signature-section h3 {
                                color: #2196F3;
                                margin-top: 0;
                            }
                            .crypto-proof {
                                font-family: monospace;
                                font-size: 12px;
                                background: #fff;
                                padding: 10px;
                                border: 1px dashed #2196F3;
                                margin-top: 10px;
                                word-break: break-all;
                            }
                            .footer {
                                margin-top: 40px;
                                padding-top: 20px;
                                border-top: 1px solid #ddd;
                                text-align: center;
                                font-size: 12px;
                                color: #666;
                            }
                            .seal {
                                width: 150px;
                                height: 150px;
                                margin: 20px auto;
                                border: 3px solid #dc2626;
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                                color: #dc2626;
                                font-size: 20px;
                                text-align: center;
                                position: relative;
                            }
                            @media print {
                                body {
                                    padding: 0;
                                }
                                .section {
                                    break-inside: avoid;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>PROOF OF LEGAL NOTICE ACCEPTANCE</h1>
                            <h2>Blockchain-Verified Service Receipt</h2>
                        </div>
                        
                        <div class="section">
                            <h3>Notice Information</h3>
                            <div class="field">
                                <label>Notice ID:</label>
                                <span class="value">#${noticeId}</span>
                            </div>
                            <div class="field">
                                <label>Document Type:</label>
                                <span class="value">${alertDetails?.noticeType || 'Legal Notice'}</span>
                            </div>
                            <div class="field">
                                <label>Case Number:</label>
                                <span class="value">${alertDetails?.caseNumber || 'Not Specified'}</span>
                            </div>
                            <div class="field">
                                <label>Issuing Agency:</label>
                                <span class="value">${alertDetails?.issuingAgency || 'Not Specified'}</span>
                            </div>
                        </div>
                        
                        <div class="section">
                            <h3>Acceptance Details</h3>
                            <div class="field">
                                <label>Date & Time:</label>
                                <span class="value">${receiptDate}</span>
                            </div>
                            <div class="field">
                                <label>Recipient Address:</label>
                                <span class="value">${noticeData.walletAddress}</span>
                            </div>
                            <div class="field">
                                <label>IP Address:</label>
                                <span class="value">${noticeData.ipAddress || 'Not Recorded'}</span>
                            </div>
                            <div class="field">
                                <label>Location:</label>
                                <span class="value">${noticeData.location ? `${noticeData.location.city}, ${noticeData.location.region}, ${noticeData.location.country}` : 'Not Recorded'}</span>
                            </div>
                            <div class="field">
                                <label>ISP:</label>
                                <span class="value">${noticeData.isp || 'Not Recorded'}</span>
                            </div>
                        </div>
                        
                        <div class="section">
                            <h3>Device Information</h3>
                            <div class="field">
                                <label>Browser:</label>
                                <span class="value">${noticeData.userAgent || 'Not Recorded'}</span>
                            </div>
                            <div class="field">
                                <label>Screen Resolution:</label>
                                <span class="value">${noticeData.screenResolution || 'Not Recorded'}</span>
                            </div>
                            <div class="field">
                                <label>Time Zone:</label>
                                <span class="value">${noticeData.timezone || 'Not Recorded'}</span>
                            </div>
                        </div>
                        
                        <div class="signature-section">
                            <h3>Blockchain Verification</h3>
                            <div class="field">
                                <label>Transaction Hash:</label>
                                <span class="value">${noticeData.transactionHash || 'Not Available'}</span>
                            </div>
                            <div class="field">
                                <label>TronScan Link:</label>
                                <span class="value"><a href="${txUrl}" target="_blank">${txUrl}</a></span>
                            </div>
                            <div class="crypto-proof">
                                <strong>Cryptographic Proof:</strong><br>
                                ${noticeData.acceptanceProof ? JSON.stringify(noticeData.acceptanceProof, null, 2) : 'Not Available'}
                            </div>
                        </div>
                        
                        <div class="seal">
                            DIGITALLY<br>VERIFIED<br>${new Date().getFullYear()}
                        </div>
                        
                        <div class="footer">
                            <p>This receipt serves as proof that the legal notice was accepted and acknowledged on the TRON blockchain.</p>
                            <p>The digital signature confirms receipt only, not agreement with the contents.</p>
                            <p>Generated on ${new Date().toLocaleString()} | BlockServed Legal Notice System</p>
                        </div>
                    </body>
                    </html>
                `;
                
                receiptWindow.document.write(receiptHTML);
                receiptWindow.document.close();
                
                // Auto-trigger print dialog
                setTimeout(() => {
                    receiptWindow.print();
                }, 500);
                
            } catch (error) {
                console.error('Error generating acceptance receipt:', error);
                uiManager.showNotification('error', 'Failed to generate receipt: ' + error.message);
            }
        }
        
        // Debug alerts function
        async function debugAlerts() {
            if (!legalContract || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet and contract first');
                return;
            }
            
            try {
                console.log('=== ALERT DEBUG INFO ===');
                console.log('Your address:', tronWeb.defaultAddress.base58);
                console.log('Contract address:', legalContract._address);
                
                // Get total notices from contract
                const totalNotices = await getTotalNotices();
                console.log('Total notices:', totalNotices);
                
                // Test both methods
                let noticesMethod = null;
                let alertsMethod = null;
                
                try {
                    noticesMethod = await legalContract.getRecipientNotices(tronWeb.defaultAddress.base58).call();
                    console.log('getRecipientNotices result:', noticesMethod);
                } catch (e) {
                    console.log('getRecipientNotices error:', e.message);
                }
                
                try {
                    alertsMethod = await legalContract.getRecipientAlerts(tronWeb.defaultAddress.base58).call();
                    console.log('getRecipientAlerts result:', alertsMethod);
                } catch (e) {
                    console.log('getRecipientAlerts error:', e.message);
                }
                
                // Get recipient alerts
                const alerts = await getRecipientNoticeIds(tronWeb.defaultAddress.base58);
                console.log('getRecipientNoticeIds returned:', alerts.map(a => a.toString()));
                
                // Check a few recent notices to see if you're the recipient
                if (totalNotices > 0) {
                    console.log('Checking recent notices...');
                    const checkCount = Math.min(5, totalNotices);
                    for (let i = totalNotices - 1; i >= totalNotices - checkCount && i >= 0; i--) {
                        try {
                            const notice = await legalContract.notices(i).call();
                            console.log(`Notice ${i}:`, {
                                recipient: notice.recipient,
                                server: notice.server,
                                alertId: notice.alertId?.toString(),
                                isYourNotice: notice.recipient.toLowerCase() === tronWeb.defaultAddress.base58.toLowerCase()
                            });
                        } catch (e) {
                            console.log(`Could not read notice ${i}:`, e.message);
                        }
                    }
                }
                
                // Show debug info in UI
                const debugInfo = `
                    <div style="background: #f0f0f0; padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.875rem;">
                        <h4>Alert Debug Information</h4>
                        <p><strong>Your Address:</strong> ${tronWeb.defaultAddress.base58}</p>
                        <p><strong>Total Notices:</strong> ${totalNotices}</p>
                        <p><strong>Your Alert Count:</strong> ${alerts.length}</p>
                        <p><strong>Alert IDs:</strong> ${alerts.length > 0 ? alerts.join(', ') : 'None'}</p>
                        <p style="margin-top: 1rem;">Check console for detailed information.</p>
                    </div>
                `;
                
                document.getElementById('myAlertsContent').innerHTML = debugInfo;
                
            } catch (error) {
                console.error('Debug error:', error);
                uiManager.showNotification('error', 'Debug failed: ' + error.message);
            }
        }
        
        window.debugAlerts = debugAlerts;
        window.copyTxHash = copyTxHash;
        window.viewContractOnTronscan = viewContractOnTronscan;
        window.viewOnTronscan = viewOnTronscan;
        window.viewOnIPFS = viewOnIPFS;
        
        // Quick accept function for one-click signing
        async function quickAccept(noticeId) {
            if (!legalContract || !noticeId) {
                uiManager.showNotification('error', 'Notice information missing');
                return;
            }
            
            // Show confirmation dialog
            const confirmed = confirm(
                'ELECTRONIC SIGNATURE CONFIRMATION\n\n' +
                'By clicking OK, you are electronically signing that you have received this legal notice.\n\n' +
                'This signature:\n' +
                ' Confirms receipt only (like signing for certified mail)\n' +
                ' Does NOT mean you agree with the contents\n' +
                ' Does NOT admit any wrongdoing\n' +
                ' Does NOT waive any of your legal rights\n\n' +
                'Your signature will be permanently recorded on the blockchain.\n\n' +
                'Do you want to sign the receipt for this legal notice?'
            );
            
            if (!confirmed) {
                return;
            }
            
            currentNoticeId = noticeId;
            
            try {
                showProcessing('Processing electronic signature...');
                
                // Call the contract to accept the notice
                const tx = await legalContract.acceptNotice(noticeId).send({
                    feeLimit: 20_000_000,  // 20 TRX - simple state change
                    callValue: 0,
                    shouldPollResponse: true
                });
                
                hideProcessing();
                
                // Add to recent activity
                addRecentActivity('accept', 'Legal notice accepted via quick sign', {
                    noticeId: noticeId
                });
                
                // Show success notification
                uiManager.showNotification('success', 'Receipt signed successfully - Your electronic signature has been recorded');
                
                // Show transaction modal
                const txHash = typeof tx === 'string' ? tx : tx.txid || tx[0];
                showTransactionSuccess(
                    txHash,
                    'Legal Notice Receipt Signed',
                    `
                        <div class="token-detail">
                            <span>Notice ID:</span>
                            <span>${noticeId}</span>
                        </div>
                        <div class="token-detail">
                            <span>Method:</span>
                            <span>Quick Sign</span>
                        </div>
                        <div class="token-detail">
                            <span>Timestamp:</span>
                            <span>${new Date().toLocaleString('en-US', { 
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        second: '2-digit',
                                        timeZoneName: 'short'
                                    })}</span>
                        </div>
                    `
                );
                
                // Refresh alerts after a short delay
                setTimeout(() => {
                    refreshMyAlerts();
                }, 2000);
                
            } catch (error) {
                console.error('Error accepting notice:', error);
                hideProcessing();
                let errorMsg = getErrorMessage(error);
                uiManager.showNotification('error', errorMsg);
            }
        }
        
        window.quickAccept = quickAccept;
        
        // Transaction verification function
        async function verifyTransaction() {
            const txHash = document.getElementById('verifyTxHash').value.trim();
            const resultDiv = document.getElementById('txVerificationResult');
            
            if (!txHash) {
                resultDiv.innerHTML = '<div class="alert alert-error">Please enter a transaction hash</div>';
                return;
            }
            
            if (!tronWeb) {
                resultDiv.innerHTML = '<div class="alert alert-error">TronWeb not initialized</div>';
                return;
            }
            
            try {
                resultDiv.innerHTML = '<p><i class="fas fa-spinner loading-spinner"></i> Verifying transaction...</p>';
                
                // Get transaction info
                const txInfo = await tronWeb.trx.getTransactionInfo(txHash);
                console.log('Transaction info:', txInfo);
                
                if (!txInfo || !txInfo.id) {
                    resultDiv.innerHTML = '<div class="alert alert-error">Transaction not found</div>';
                    return;
                }
                
                // Get transaction events
                const events = await tronWeb.getEventByTransactionID(txHash);
                console.log('Transaction events:', events);
                
                let html = '<div class="verification-results">';
                html += '<h4>Transaction Verification Results</h4>';
                
                // Basic transaction info
                html += '<div class="token-details" style="margin-bottom: 1rem;">';
                html += `<div class="token-detail"><span>Status:</span><span>${txInfo.receipt?.result === 'SUCCESS' ? ' Successful' : ' Failed'}</span></div>`;
                html += `<div class="token-detail"><span>Block Number:</span><span>${txInfo.blockNumber}</span></div>`;
                html += `<div class="token-detail"><span>Energy Used:</span><span>${txInfo.receipt?.energy_usage || 0}</span></div>`;
                html += `<div class="token-detail"><span>Net Used:</span><span>${txInfo.receipt?.net_usage || 0}</span></div>`;
                html += '</div>';
                
                // Parse events
                if (events && events.length > 0) {
                    html += '<h5>Events Found:</h5>';
                    
                    // NoticeServed event
                    const noticeEvent = events.find(e => e.name === 'NoticeServed');
                    if (noticeEvent) {
                        html += '<div class="event-details" style="background: var(--card-bg); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">';
                        html += '<h6> Notice Served Event</h6>';
                        html += '<div class="token-details">';
                        html += `<div class="token-detail"><span>Alert ID:</span><span>${noticeEvent.result.alertId}</span></div>`;
                        html += `<div class="token-detail"><span>Document ID:</span><span>${noticeEvent.result.documentId}</span></div>`;
                        html += `<div class="token-detail"><span>Recipient:</span><span>${tronWeb.address.fromHex(noticeEvent.result.recipient)}</span></div>`;
                        html += '</div></div>';
                    }
                    
                    // Transfer events
                    const transfers = events.filter(e => e.name === 'Transfer');
                    if (transfers.length > 0) {
                        html += '<h5>NFT Transfers:</h5>';
                        transfers.forEach((transfer, index) => {
                            const from = transfer.result.from === '0x0000000000000000000000000000000000000000' 
                                ? 'Contract (Minted)' 
                                : tronWeb.address.fromHex(transfer.result.from);
                            const to = tronWeb.address.fromHex(transfer.result.to);
                            const tokenId = transfer.result.tokenId;
                            
                            html += '<div class="event-details" style="background: var(--card-bg); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">';
                            html += `<h6> Transfer ${index + 1}</h6>`;
                            html += '<div class="token-details">';
                            html += `<div class="token-detail"><span>Token ID:</span><span>#${tokenId}</span></div>`;
                            html += `<div class="token-detail"><span>From:</span><span style="font-family: monospace; font-size: 0.875rem;">${from}</span></div>`;
                            html += `<div class="token-detail"><span>To:</span><span style="font-family: monospace; font-size: 0.875rem;">${to}</span></div>`;
                            
                            // Determine token type based on ID parity
                            const tokenType = parseInt(tokenId) % 2 === 1 ? 'Alert NFT' : 'Document NFT';
                            html += `<div class="token-detail"><span>Type:</span><span>${tokenType}</span></div>`;
                            html += '</div></div>';
                        });
                    }
                    
                    // Fee transfer events
                    const feeTransfers = events.filter(e => e.name === 'Transfer' && !e.topic);
                    if (feeTransfers.length > 0) {
                        html += '<h5>Fee Transfers:</h5>';
                        feeTransfers.forEach(transfer => {
                            html += '<div class="event-details" style="background: var(--card-bg); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">';
                            html += '<div class="token-details">';
                            html += `<div class="token-detail"><span>Amount:</span><span>${tronWeb.fromSun(transfer.result.value)} TRX</span></div>`;
                            html += '</div></div>';
                        });
                    }
                } else {
                    html += '<div class="alert alert-warning">No events found for this transaction</div>';
                }
                
                html += '</div>';
                
                // Add link to TronScan
                const network = document.getElementById('networkName')?.textContent || 'Mainnet';
                let scanUrl = 'https://tronscan.org';
                if (network.includes('Nile')) scanUrl = 'https://nile.tronscan.org';
                else if (network.includes('Shasta')) scanUrl = 'https://shasta.tronscan.org';
                
                html += `<div style="margin-top: 1rem;">
                    <a href="${scanUrl}/#/transaction/${txHash}" target="_blank" class="btn btn-secondary">
                        <i class="fas fa-external-link-alt"></i> View on TronScan
                    </a>
                </div>`;
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Verification error:', error);
                resultDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }
        
        window.verifyTransaction = verifyTransaction;
        window.grantRole = grantRole;
        window.checkRole = checkRole;
        window.refreshDeliveryStatus = refreshDeliveryStatus;
        window.filterDeliveryResults = filterDeliveryResults;
        window.sendDeliveryReminder = sendDeliveryReminder;
        window.updateFee = updateFee;
        window.updateFeeCollector = updateFeeCollector;
        window.exportRegistrations = exportRegistrations;
        window.updateCreationFee = updateCreationFee;
        window.updateSponsorshipFee = updateSponsorshipFee;
        window.savePinataKeys = savePinataKeys;
        window.testPinataConnection = testPinataConnection;
        window.printDocument = printDocument;
        window.downloadDocument = downloadDocument;
        window.saveReceiptAsHTML = saveReceiptAsHTML;
        
        // Utility to clear IPFS data when storage is full
        window.clearIPFSStorage = function() {
            if (window.SimpleEncryption && window.SimpleEncryption.clearAllIPFSData) {
                window.SimpleEncryption.clearAllIPFSData();
                uiManager.showNotification('success', 'IPFS storage cleared');
            }
        };
        
        // Debug function to check why notice #1 isn't showing
        window.debugNotice1 = async function() {
            console.log('=== DEBUGGING NOTICE #1 ===');
            
            if (!legalContract || !tronWeb) {
                console.error('Contract or TronWeb not initialized');
                return;
            }
            
            const serverAddress = tronWeb.defaultAddress.base58;
            console.log('Current wallet address:', serverAddress);
            
            try {
                // Check documentNotices[1]
                console.log('\n1. Checking documentNotices[1]:');
                const docData = await legalContract.documentNotices(1).call();
                console.log('Document data:', docData);
                if (docData && Array.isArray(docData)) {
                    console.log('- documentId:', docData[0]);
                    console.log('- server:', docData[1]);
                    console.log('- recipient:', docData[2]);
                    console.log('- ipfsHash:', docData[3]);
                    console.log('- accepted:', docData[4]);
                    
                    // Convert server address if hex
                    if (docData[1] && docData[1].startsWith('41')) {
                        try {
                            const serverBase58 = tronWeb.address.fromHex(docData[1]);
                            console.log('- server (base58):', serverBase58);
                            console.log('- matches current wallet?', serverBase58.toLowerCase() === serverAddress.toLowerCase());
                        } catch (e) {
                            console.error('Could not convert server address');
                        }
                    }
                }
                
                // Check alertNotices[1]
                console.log('\n2. Checking alertNotices[1]:');
                const alertData = await legalContract.alertNotices(1).call();
                console.log('Alert data:', alertData);
                if (alertData && Array.isArray(alertData)) {
                    console.log('- recipient:', alertData[0]);
                    console.log('- server:', alertData[1]);
                    console.log('- documentId:', alertData[2]);
                    console.log('- timestamp:', alertData[3]);
                    console.log('- acknowledged:', alertData[4]);
                    
                    // Convert server address if hex
                    if (alertData[1] && alertData[1].startsWith('41')) {
                        try {
                            const serverBase58 = tronWeb.address.fromHex(alertData[1]);
                            console.log('- server (base58):', serverBase58);
                            console.log('- matches current wallet?', serverBase58.toLowerCase() === serverAddress.toLowerCase());
                        } catch (e) {
                            console.error('Could not convert server address');
                        }
                    }
                }
                
                // Check events
                console.log('\n3. Checking events for notice #1:');
                const events = await tronWeb.event.getEventsByContractAddress(
                    CONTRACT_ADDRESS,
                    {
                        onlyConfirmed: true,
                        orderBy: 'block_timestamp,desc',
                        limit: 200,
                        fingerprint: ''
                    }
                );
                
                const notice1Events = events.data?.filter(e => 
                    (e.result?.noticeId === '1' || e.result?.documentId === '1' || e.result?.alertId === '1')
                );
                
                console.log('Events for notice #1:', notice1Events);
                
                // Run getServedNoticesFromBlockchain
                console.log('\n4. Running getServedNoticesFromBlockchain:');
                const notices = await getServedNoticesFromBlockchain(serverAddress, 10);
                console.log('Returned notices:', notices);
                console.log('Notice IDs:', notices.map(n => n.noticeId));
                
                // Check if notice #1 is in the list
                const hasNotice1 = notices.some(n => n.noticeId === '1' || n.noticeId === 1);
                console.log('Notice #1 in list?', hasNotice1);
                
                if (!hasNotice1) {
                    console.log('\n5. Possible reasons notice #1 is not showing:');
                    console.log('- Server address mismatch');
                    console.log('- Notice was created by different wallet');
                    console.log('- Event filtering issue');
                    console.log('- Cache issue (try force refresh)');
                }
                
            } catch (error) {
                console.error('Debug error:', error);
            }
        };
        
        // Session cache for delivery data
        let deliverySessionCache = {
            lastVerified: null,
            data: null,
            address: null
        };
        
        // Update backend when a new notice is created
        async function updateBackendAfterNoticeCreation(noticeData) {
            if (!window.BACKEND_API_URL) {
                console.warn('Backend URL not configured, skipping backend update');
                return;
            }
            
            try {
                console.log('Updating backend with new notice:', noticeData);
                
                // Send to backend /api/notices/served endpoint
                const response = await fetch(`${window.BACKEND_API_URL}/api/notices/served`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        noticeId: noticeData.noticeId || noticeData.id,
                        alertId: noticeData.alertId || '',
                        documentId: noticeData.documentId || '',
                        serverAddress: noticeData.serverAddress || tronWeb.defaultAddress.base58,
                        recipientAddress: noticeData.recipientAddress,
                        noticeType: noticeData.noticeType || 'Legal Notice',
                        issuingAgency: noticeData.issuingAgency || '',
                        caseNumber: noticeData.caseNumber || '',
                        documentHash: noticeData.documentHash || '',
                        ipfsHash: noticeData.ipfsHash || '',
                        hasDocument: noticeData.hasDocument || false
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Backend updated successfully:', result);
                    
                    // Also track wallet connection if needed
                    if (noticeData.recipientAddress) {
                        try {
                            await fetch(`${window.BACKEND_API_URL}/api/wallet-connections`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    walletAddress: noticeData.recipientAddress,
                                    eventType: 'notice_served',
                                    site: window.location.hostname,
                                    userAgent: navigator.userAgent
                                })
                            });
                        } catch (e) {
                            console.warn('Failed to track wallet connection:', e);
                        }
                    }
                } else {
                    console.error('Backend update failed:', response.status);
                }
            } catch (error) {
                console.error('Error updating backend:', error);
                // Don't throw - we don't want backend failures to affect the user experience
            }
        }
        
        // Make it globally available
        window.updateBackendAfterNoticeCreation = updateBackendAfterNoticeCreation;
        
        // Verify and sync blockchain data with backend (once per session)
        async function verifyAndSyncBlockchainData(userAddress, forceCheck = false) {
            const sessionKey = `delivery_verified_${userAddress}`;
            const sessionData = sessionStorage.getItem(sessionKey);
            const now = Date.now();
            
            // Check if already verified this session (within last 30 minutes)
            if (sessionData && !forceCheck) {
                const parsed = JSON.parse(sessionData);
                if (now - parsed.timestamp < 30 * 60 * 1000) {
                    console.log('Using session-verified data from', new Date(parsed.timestamp).toLocaleTimeString());
                    
                    // Quick stale data check - compare counts
                    try {
                        const response = await fetch(`${window.BACKEND_API_URL}/api/servers/${userAddress}/notices?limit=1`);
                        if (response.ok) {
                            const data = await response.json();
                            const backendCount = data.stats?.total_notices || 0;
                            
                            if (Math.abs(backendCount - parsed.noticeCount) > 2) {
                                console.log(`Stale data detected: Backend has ${backendCount} notices, session has ${parsed.noticeCount}`);
                                // Continue with verification
                            } else {
                                return false; // Data is fresh enough
                            }
                        }
                    } catch (e) {
                        console.warn('Could not check for stale data:', e);
                    }
                }
            }
            
            console.log('Performing blockchain verification and backend sync...');
            console.log('Verifying for address:', userAddress);
            
            // Get all notices from blockchain
            const blockchainNotices = await getServedNoticesFromBlockchain(userAddress, 1000);
            console.log(`Found ${blockchainNotices.length} notices on blockchain`);
            console.log('Blockchain notices:', blockchainNotices);
            
            // If no blockchain notices found, clear any test data
            if (blockchainNotices.length === 0) {
                console.log('No blockchain notices found - this might be a new account or test environment');
            }
            
            // Process and update backend with any missing data
            for (const noticeData of blockchainNotices) {
                try {
                    const alertData = await legalContract.alertNotices(noticeData.noticeId).call();
                    const docData = await legalContract.documentNotices(noticeData.noticeId).call();
                    
                    // Determine notice types and IDs
                    let alertId = '';
                    let documentId = '';
                    let accepted = false;
                    
                    if (alertData && alertData[0]) {
                        alertId = noticeData.noticeId;
                        if (Array.isArray(alertData) && alertData.length > 4) {
                            accepted = alertData[4] === true;
                        }
                    }
                    
                    if (docData && docData[0]) {
                        documentId = noticeData.noticeId;
                    }
                    
                    // Convert recipient address to proper format
                    let recipientAddress = noticeData.recipient;
                    if (recipientAddress && recipientAddress.startsWith('0x')) {
                        // Convert hex to base58 for TRON
                        try {
                            recipientAddress = tronWeb.address.fromHex(recipientAddress);
                        } catch (e) {
                            console.warn('Could not convert recipient address:', recipientAddress);
                        }
                    }
                    
                    // Extract case number from alert data if available
                    let caseNumber = noticeData.caseNumber || '';
                    if (!caseNumber && alertData && alertData[7]) {
                        caseNumber = alertData[7]; // Case number from alert data
                    }
                    
                    // Update backend with this notice
                    if (window.BACKEND_API_URL) {
                        try {
                            // Get the actual server address - handle null address case
                            let actualServerAddress = userAddress;
                            
                            // Check if this notice has server info from events
                            if (noticeData.server && noticeData.server !== 'T9yD14Nj9j7xAB4dbGeiX9h8unkKHxuWwb') {
                                actualServerAddress = noticeData.server;
                            } else if (noticeData.eventServer) {
                                actualServerAddress = noticeData.eventServer;
                            } else if (noticeData.txSender) {
                                actualServerAddress = noticeData.txSender;
                            }
                            
                            console.log(`Syncing notice ${noticeData.noticeId} to backend with server: ${actualServerAddress}`);
                            const response = await fetch(`${window.BACKEND_API_URL}/api/notices/served`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    noticeId: noticeData.noticeId,
                                    alertId: alertId,
                                    documentId: documentId,
                                    serverAddress: actualServerAddress,
                                    recipientAddress: recipientAddress,
                                    noticeType: alertId && documentId ? 'dual' : (alertId ? 'alert' : 'document'),
                                    issuingAgency: alertData?.[5] || '',
                                    caseNumber: caseNumber,
                                    hasDocument: !!docData?.[0],
                                    ipfsHash: docData?.[0] || '',
                                    documentHash: ''
                                })
                            });
                            
                            if (!response.ok) {
                                console.error(`Failed to sync notice ${noticeData.noticeId}:`, response.status);
                            }
                        } catch (e) {
                            console.warn('Failed to sync notice to backend:', e);
                        }
                    }
                } catch (e) {
                    console.error(`Error processing notice ${noticeData.noticeId}:`, e);
                }
            }
            
            // Mark as verified for this session
            sessionStorage.setItem(sessionKey, JSON.stringify({
                timestamp: now,
                noticeCount: blockchainNotices.length
            }));
            
            console.log('Blockchain verification complete and synced to backend');
            return true;
        }
        
        // Refresh delivery status
        async function refreshDeliveryStatus(forceRefresh = false) {
            if (!legalContract || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet and contract first');
                return;
            }
            
            const resultsDiv = document.getElementById('deliveryResults');
            if (resultsDiv) {
                resultsDiv.innerHTML = '<div class="loading">Loading your served notices...</div>';
            }
            
            try {
                const userAddress = tronWeb.defaultAddress.base58;
                let allNotices = [];
                let useBlockchainDirectly = false;
                
                // Verify blockchain data once per session (or if forced)
                if (forceRefresh) {
                    console.log('Force refresh requested - clearing session cache');
                    sessionStorage.removeItem(`delivery_verified_${userAddress}`);
                    useBlockchainDirectly = true; // When forcing refresh, prefer blockchain data
                }
                
                const syncSuccess = await verifyAndSyncBlockchainData(userAddress, forceRefresh);
                
                // Try backend first, but have blockchain data as fallback
                if (window.BACKEND_API_URL && !useBlockchainDirectly) {
                    try {
                        const response = await fetch(`${window.BACKEND_API_URL}/api/servers/${userAddress}/notices?limit=1000`);
                        if (response.ok) {
                            const backendData = await response.json();
                            console.log('Backend delivery data:', backendData);
                            
                            // Check if backend data looks like test data
                            let hasTestData = false;
                            if (backendData.notices && Array.isArray(backendData.notices)) {
                                hasTestData = backendData.notices.some(n => 
                                    n.case_number?.includes('TEST') || 
                                    n.notice_type?.includes('TEST')
                                );
                            }
                            
                            if (hasTestData) {
                                console.warn('Backend contains test data, using blockchain directly');
                                useBlockchainDirectly = true;
                            } else if (backendData.notices && Array.isArray(backendData.notices)) {
                                // Use backend data which includes view counts and acceptance info
                                for (const notice of backendData.notices) {
                                    allNotices.push({
                                        id: notice.notice_id,
                                        alertId: notice.alert_id || '',
                                        documentId: notice.document_id || '',
                                        recipient: notice.recipient_address,
                                        server: notice.server_address,
                                        servedAt: notice.served_at,
                                        accepted: notice.accepted,
                                        acceptedAt: notice.acceptance_timestamp,
                                        ipfsHash: notice.ipfs_hash,
                                        viewCount: notice.view_count || 0,
                                        lastViewed: notice.last_viewed_at,
                                        acceptanceIp: notice.acceptance_ip,
                                        acceptanceLocation: notice.acceptance_location,
                                        caseNumber: notice.case_number || notice.metadata?.caseNumber || '',
                                        source: 'backend'
                                    });
                                }
                            }
                        } else {
                            console.error('Failed to fetch notices from backend:', response.status);
                        }
                    } catch (backendError) {
                        console.error('Backend unavailable:', backendError);
                        useBlockchainDirectly = true;
                    }
                }
                
                // If we should use blockchain directly (test data detected or backend failed)
                if (useBlockchainDirectly) {
                    console.log('Using blockchain data directly...');
                    // Get ALL notices from blockchain, not just from current user
                    const blockchainNotices = await getServedNoticesFromBlockchain('ALL', 1000);
                    
                    // Debug: Log the structure of notices
                    if (blockchainNotices.length > 0) {
                        console.log('Sample notice structure:', blockchainNotices[0]);
                        console.log('All notice fields:', Object.keys(blockchainNotices[0]));
                        const case34 = blockchainNotices.find(n => n.caseNumber === '34-987654');
                        if (case34) {
                            console.log('Case 34-987654 full data:', case34);
                        } else {
                            console.log('Available case numbers:', blockchainNotices.map(n => n.caseNumber));
                        }
                    }
                    
                    // Filter for notices from this server OR to this recipient
                    // Check multiple fields for server since notices from null address have server in event data
                    const relevantNotices = blockchainNotices.filter(notice => {
                        // Check if user is the actual server (from events or transaction)
                        const actualServer = notice.eventServer || notice.txSender || notice.server;
                        const isServer = actualServer && ensureBase58Address(actualServer).toLowerCase() === ensureBase58Address(userAddress).toLowerCase();
                        
                        // Check if user is the recipient
                        const isRecipient = notice.recipient && ensureBase58Address(notice.recipient).toLowerCase() === ensureBase58Address(userAddress).toLowerCase();
                        
                        // For debugging
                        if (notice.caseNumber === '34-987654') {
                            console.log(`Case 34-987654 filter check:
                                - actualServer: ${actualServer}
                                - userAddress: ${userAddress}
                                - isServer: ${isServer}
                                - recipient: ${notice.recipient}
                                - isRecipient: ${isRecipient}
                            `);
                        }
                        
                        return isServer || isRecipient;
                    });
                    
                    console.log(`Found ${blockchainNotices.length} total notices, ${relevantNotices.length} relevant to user ${userAddress}`);
                    
                    for (const noticeData of relevantNotices) {
                        try {
                            // Get alert and document data
                            const alertData = await legalContract.alertNotices(noticeData.noticeId).call();
                            const docData = await legalContract.documentNotices(noticeData.noticeId).call();
                            
                            let alertId = '';
                            let documentId = '';
                            let accepted = false;
                            let caseNumber = noticeData.caseNumber || '';
                            
                            // Log the alert data for debugging
                            console.log(`Notice ${noticeData.noticeId} alert data:`, alertData);
                            
                            if (alertData && alertData[0] && alertData[0] !== '410000000000000000000000000000000000000000') {
                                alertId = noticeData.noticeId;
                                accepted = alertData[4] === true;
                                if (!caseNumber && alertData[7]) {
                                    caseNumber = alertData[7];
                                    console.log(`Extracted case number: ${caseNumber}`);
                                }
                                // Also check for case details that might contain case number
                                if (alertData[8]) {
                                    console.log(`Notice ${noticeData.noticeId} case details:`, alertData[8]);
                                    if (alertData[8].includes('34-987654')) {
                                        console.log(' Found case 34-987654 in case details!');
                                        caseNumber = '34-987654'; // Override with correct case number
                                    } else if (alertData[8].includes('34-123456')) {
                                        console.log('Found 34-123456 in case details - possible typo?');
                                    }
                                }
                            } else if (alertData && Array.isArray(alertData)) {
                                // Even if recipient is empty, check for case number in the data
                                if (alertData[7]) {
                                    caseNumber = alertData[7];
                                    console.log(`Extracted case number from empty notice: ${caseNumber}`);
                                }
                            }
                            
                            if (docData && docData[0]) {
                                documentId = noticeData.noticeId;
                            }
                            
                            // Convert recipient address if needed
                            let recipientAddress = noticeData.recipient;
                            if (recipientAddress && recipientAddress.startsWith('0x')) {
                                try {
                                    recipientAddress = tronWeb.address.fromHex(recipientAddress);
                                } catch (e) {
                                    console.warn('Could not convert address:', recipientAddress);
                                }
                            }
                            
                            allNotices.push({
                                id: noticeData.noticeId,
                                alertId: alertId,
                                documentId: documentId,
                                recipient: recipientAddress,
                                server: userAddress,
                                servedAt: new Date(noticeData.timestamp).toISOString(),
                                accepted: accepted,
                                hasDocument: !!docData?.[0],
                                ipfsHash: docData?.[0] || '',
                                caseNumber: caseNumber,
                                source: 'blockchain'
                            });
                        } catch (e) {
                            console.error(`Error processing notice ${noticeData.noticeId}:`, e);
                        }
                    }
                    
                    if (allNotices.length === 0) {
                        console.log('No notices found on blockchain');
                    }
                }
                
                // Group notices by case number
                const noticesByCaseNumber = {};
                allNotices.forEach(notice => {
                    const caseNum = notice.caseNumber || 'No Case Number';
                    if (!noticesByCaseNumber[caseNum]) {
                        noticesByCaseNumber[caseNum] = [];
                    }
                    noticesByCaseNumber[caseNum].push(notice);
                });
                
                // Sort case numbers (put 'No Case Number' last)
                const sortedCaseNumbers = Object.keys(noticesByCaseNumber).sort((a, b) => {
                    if (a === 'No Case Number') return 1;
                    if (b === 'No Case Number') return -1;
                    return a.localeCompare(b);
                });
                
                // Update stats
                const totalSent = allNotices.length;
                const delivered = allNotices.filter(n => n.accepted).length;
                const pending = totalSent - delivered;
                const deliveryRate = totalSent > 0 ? Math.round((delivered / totalSent) * 100) : 0;
                const totalCases = sortedCaseNumbers.filter(c => c !== 'No Case Number').length;
                
                // Update stat displays
                document.getElementById('totalSentNotices').textContent = totalSent;
                document.getElementById('deliveredNotices').textContent = delivered;
                document.getElementById('pendingDelivery').textContent = pending;
                document.getElementById('deliveryRate').textContent = deliveryRate + '%';
                
                // Display grouped by case number with expandable sections
                if (allNotices.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>No notices served yet</h3>
                            <p>Start serving legal notices to see them here</p>
                        </div>
                    `;
                } else {
                    // Check session verification status
                    const sessionKey = `delivery_verified_${userAddress}`;
                    const sessionData = sessionStorage.getItem(sessionKey);
                    let verificationInfo = '';
                    
                    if (sessionData) {
                        const parsed = JSON.parse(sessionData);
                        const verifiedTime = new Date(parsed.timestamp).toLocaleTimeString();
                        verificationInfo = `<small style="color: #666; margin-left: 1rem;">
                            <i class="fas fa-check-circle" style="color: #28a745;"></i> 
                            Verified at ${verifiedTime}
                        </small>`;
                    }
                    
                    resultsDiv.innerHTML = `
                        <div style="margin-bottom: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center;">
                                    <h4 style="margin: 0; color: #333;">Total Cases: ${totalCases}</h4>
                                    ${verificationInfo}
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-small btn-primary" onclick="refreshDeliveryStatus(true)" title="Re-verify blockchain data and refresh">
                                        <i class="fas fa-sync"></i> Verify & Refresh
                                    </button>
                                    <button class="btn btn-small btn-secondary" onclick="expandAllCases()">
                                        <i class="fas fa-expand"></i> Expand All
                                    </button>
                                    <button class="btn btn-small btn-warning" onclick="clearTestDataAndRefresh()" title="Clear test data and reload from blockchain">
                                        <i class="fas fa-trash"></i> Clear Test Data
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="delivery-list" style="max-height: 600px; overflow-y: auto;">
                            ${sortedCaseNumbers.map(caseNumber => {
                                const caseNotices = noticesByCaseNumber[caseNumber];
                                const caseAccepted = caseNotices.filter(n => n.accepted).length;
                                const casePending = caseNotices.length - caseAccepted;
                                const caseId = caseNumber.replace(/[^a-zA-Z0-9]/g, '_');
                                
                                // Get Alert and Document IDs for the case
                                const alertIds = [];
                                const documentIds = [];
                                caseNotices.forEach(notice => {
                                    if (notice.alertId) alertIds.push(notice.alertId);
                                    if (notice.documentId) documentIds.push(notice.documentId);
                                });
                                
                                return `
                                <div class="case-group" style="border: 2px solid #ddd; border-radius: 8px; margin-bottom: 1rem; background: white;">
                                    <div class="case-header" style="padding: 1rem; background: #f8f9fa; cursor: pointer; border-radius: 6px 6px 0 0; color: #333;"
                                         onclick="toggleCaseExpansion('${caseId}')">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div style="display: flex; align-items: center; gap: 1rem;">
                                                <i class="fas fa-chevron-right" id="chevron_${caseId}" style="transition: transform 0.3s; color: #666;"></i>
                                                <div>
                                                    <strong style="font-size: 1.2rem; color: #333;">Case: ${caseNumber}</strong>
                                                    <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                                        ${caseNotices.length} notice${caseNotices.length > 1 ? 's' : ''}  
                                                        ${caseAccepted} accepted  
                                                        ${casePending} pending
                                                    </div>
                                                </div>
                                            </div>
                                            <div style="display: flex; gap: 0.5rem;">
                                                ${caseAccepted > 0 ? '<span class="badge badge-success">Has Acceptances</span>' : ''}
                                                ${casePending > 0 ? '<span class="badge badge-warning">Pending</span>' : ''}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="case_${caseId}" class="case-notices" style="display: none; padding: 1rem; background: #fafafa;">
                                        ${caseNotices.sort((a, b) => new Date(b.servedAt) - new Date(a.servedAt)).map(notice => {
                                            // Extract Alert and Document IDs from the notice
                                            let alertId = notice.alertId || '';
                                            let documentId = notice.documentId || '';
                                            
                                            return `
                                            <div class="delivery-item" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: white; cursor: pointer; transition: all 0.2s;"
                                                 onmouseover="this.style.background='#e8f4f8'; this.style.borderColor='#2196F3';" 
                                                 onmouseout="this.style.background='white'; this.style.borderColor='#e0e0e0';"
                                                 onclick="window.viewNoticeDetails('${notice.id}', '${alertId}', '${documentId}')">
                                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                                    <div style="flex: 1;">
                                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                            <strong style="font-size: 1.1rem; color: #333;">
                                                                ${alertId ? `Alert Notice #${alertId}` : ''}
                                                                ${alertId && documentId ? ' / ' : ''}
                                                                ${documentId ? `Document Notice #${documentId}` : ''}
                                                                ${!alertId && !documentId ? `Notice #${notice.id}` : ''}
                                                            </strong>
                                                            <span class="badge ${notice.accepted ? 'badge-success' : 'badge-warning'}">
                                                                ${notice.accepted ? '<i class="fas fa-check"></i> Signed' : '<i class="fas fa-clock"></i> Pending'}
                                                            </span>
                                                            ${notice.source === 'backend' && notice.viewCount > 0 ? `
                                                                <span class="badge badge-info">
                                                                    <i class="fas fa-eye"></i> ${notice.viewCount} views
                                                                </span>
                                                            ` : ''}
                                                        </div>
                                            
                                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; font-size: 0.9rem; color: #666;">
                                                <span style="color: #555;">Recipient:</span>
                                                <code style="font-size: 0.85rem; color: #333; background: #f5f5f5; padding: 2px 4px; border-radius: 3px;">${formatAddress(notice.recipient)}</code>
                                                
                                                ${notice.caseNumber ? `
                                                    <span style="color: #555;">Case Number:</span>
                                                    <span style="font-weight: 500; color: #333;">${notice.caseNumber}</span>
                                                ` : ''}
                                                
                                                <span style="color: #555;">Served:</span>
                                                <span style="color: #333;">${new Date(notice.servedAt).toLocaleString()}</span>
                                                
                                                ${notice.accepted ? `
                                                    <span style="color: #555;">Accepted:</span>
                                                    <span style="color: #28a745;">
                                                        ${notice.acceptedAt ? new Date(notice.acceptedAt).toLocaleString() : 'Yes'}
                                                    </span>
                                                ` : ''}
                                                
                                                ${notice.ipfsHash ? `
                                                    <span style="color: #555;">Document:</span>
                                                    <span style="color: #333;"><i class="fas fa-file-pdf"></i> Attached</span>
                                                ` : ''}
                                                
                                                ${notice.lastViewed ? `
                                                    <span style="color: #555;">Last Viewed:</span>
                                                    <span style="color: #333;">${new Date(notice.lastViewed).toLocaleString()}</span>
                                                ` : ''}
                                                
                                                ${notice.acceptanceLocation ? `
                                                    <span style="color: #555;">Location:</span>
                                                    <span style="color: #333;">
                                                        <i class="fas fa-map-marker-alt"></i> 
                                                        ${typeof notice.acceptanceLocation === 'string' 
                                                            ? JSON.parse(notice.acceptanceLocation).city 
                                                            : notice.acceptanceLocation.city || 'Unknown'}
                                                    </span>
                                                ` : ''}
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; flex-direction: column; gap: 0.5rem; min-width: 140px;">
                                            <button class="btn btn-small btn-primary" onclick="event.stopPropagation(); viewNoticeAuditTrail('${notice.id}')">
                                                <i class="fas fa-history"></i> Audit Trail
                                            </button>
                                            ${notice.accepted ? `
                                                <button class="btn btn-small btn-success" onclick="event.stopPropagation(); printAcceptanceReceipt('${notice.id}')">
                                                    <i class="fas fa-file-certificate"></i> Receipt
                                                </button>
                                            ` : `
                                                <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); viewServiceCertificate('${notice.id}')">
                                                    <i class="fas fa-certificate"></i> Service Cert
                                                </button>
                                            `}
                                            <button class="btn btn-small btn-info" onclick="event.stopPropagation(); viewOnBlockchain('${notice.id}')">
                                                <i class="fas fa-link"></i> Blockchain
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error refreshing delivery status:', error);
                uiManager.showNotification('error', 'Failed to load delivery tracking data');
                if (resultsDiv) {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Error loading delivery status. Please try again.</p>
                        </div>
                    `;
                }
            }
        }
        
        // Toggle case expansion
        function toggleCaseExpansion(caseId) {
            const caseContent = document.getElementById(`case_${caseId}`);
            const chevron = document.getElementById(`chevron_${caseId}`);
            
            if (caseContent) {
                if (caseContent.style.display === 'none') {
                    caseContent.style.display = 'block';
                    if (chevron) {
                        chevron.style.transform = 'rotate(90deg)';
                    }
                } else {
                    caseContent.style.display = 'none';
                    if (chevron) {
                        chevron.style.transform = 'rotate(0deg)';
                    }
                }
            }
        }
        
        // Expand all cases
        function expandAllCases() {
            const caseGroups = document.querySelectorAll('.case-notices');
            const chevrons = document.querySelectorAll('[id^="chevron_"]');
            
            caseGroups.forEach(group => {
                group.style.display = 'block';
            });
            
            chevrons.forEach(chevron => {
                chevron.style.transform = 'rotate(90deg)';
            });
        }
        
        // Clear test data and force blockchain refresh
        async function clearTestDataAndRefresh() {
            if (!legalContract || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet first');
                return;
            }
            
            uiManager.showNotification('info', 'Clearing ALL test data and fetching real blockchain data...');
            
            // Use the new comprehensive test data cleaner
            if (window.clearAllTestData) {
                try {
                    const realNotices = await window.clearAllTestData();
                    console.log(' Cleared test data and loaded real notices:', realNotices);
                    
                    // If we have the new dashboard, update it
                    if (window.serverDashboard && window.serverDashboard.init) {
                        await window.serverDashboard.init();
                    } else {
                        // Fall back to old refresh
                        await refreshDeliveryStatus(true);
                    }
                    
                    uiManager.showNotification('success', `Loaded ${realNotices ? realNotices.length : 0} real notices from blockchain`);
                } catch (error) {
                    console.error('Error clearing test data:', error);
                    uiManager.showNotification('error', 'Failed to clear test data: ' + error.message);
                }
            } else {
                // Fallback to old method
                const userAddress = tronWeb.defaultAddress.base58;
                
                // Clear session cache
                console.log('Clearing all cached data...');
                sessionStorage.removeItem(`delivery_verified_${userAddress}`);
                
                // Clear any local storage
                const storedNotices = JSON.parse(localStorage.getItem('servedNotices') || '{}');
                if (storedNotices[userAddress]) {
                    delete storedNotices[userAddress];
                    localStorage.setItem('servedNotices', JSON.stringify(storedNotices));
                }
                
                // Force refresh from blockchain
                await refreshDeliveryStatus(true);
            }
        }
        
        // Print acceptance receipt
        async function printAcceptanceReceipt(noticeId) {
            try {
                // For now, use the alert receipt generator
                await generateAlertReceipt(noticeId);
            } catch (error) {
                console.error('Error generating receipt:', error);
                uiManager.showNotification('error', 'Failed to generate receipt');
            }
        }
        
        // Make functions globally accessible
        window.toggleCaseExpansion = toggleCaseExpansion;
        window.expandAllCases = expandAllCases;
        window.clearTestDataAndRefresh = clearTestDataAndRefresh;
        
        // Search for a specific case number across all notices
        async function searchForCase(caseNumber) {
            if (!legalContract || !tronWeb) {
                console.error('Contract not initialized');
                return null;
            }
            
            console.log(`Searching for case: ${caseNumber}`);
            
            // Get ALL notices from blockchain
            const allNotices = await getServedNoticesFromBlockchain('ALL', 1000);
            console.log(`Total notices found: ${allNotices.length}`);
            
            // Search for the case number
            const matchingNotices = [];
            
            for (const notice of allNotices) {
                // Check if case number matches
                if (notice.caseNumber && notice.caseNumber.includes(caseNumber)) {
                    console.log(`Found case ${caseNumber} in notice ${notice.noticeId}`);
                    
                    // Get full details
                    const alertData = await legalContract.alertNotices(notice.noticeId).call();
                    const docData = await legalContract.documentNotices(notice.noticeId).call();
                    
                    matchingNotices.push({
                        ...notice,
                        alertData,
                        docData,
                        hasAlert: alertData && alertData[0] !== '410000000000000000000000000000000000000000',
                        hasDocument: docData && docData[0] !== '0'
                    });
                }
            }
            
            if (matchingNotices.length > 0) {
                console.log(`Found ${matchingNotices.length} notices for case ${caseNumber}:`, matchingNotices);
                
                // Display in UI
                const resultsDiv = document.getElementById('deliveryResults');
                if (resultsDiv) {
                    let html = `<h3>Search Results for Case ${caseNumber}</h3>`;
                    html += '<div class="notices-list">';
                    
                    for (const notice of matchingNotices) {
                        html += `
                            <div class="notice-card" style="background: #f5f5f5; padding: 1rem; margin: 0.5rem 0; border-radius: 8px;">
                                <h4>Notice #${notice.noticeId}</h4>
                                <p><strong>Case:</strong> ${notice.caseNumber}</p>
                                <p><strong>Server:</strong> ${notice.server}</p>
                                <p><strong>Recipient:</strong> ${notice.recipient}</p>
                                <p><strong>Type:</strong> ${notice.hasAlert ? 'Alert' : ''} ${notice.hasDocument ? 'Document' : ''}</p>
                                <p><strong>Served:</strong> ${new Date(notice.servedAt).toLocaleString()}</p>
                                ${notice.ipfsHash ? `<p><strong>IPFS:</strong> ${notice.ipfsHash}</p>` : ''}
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    resultsDiv.innerHTML = html;
                }
            } else {
                console.log(`No notices found for case ${caseNumber}`);
            }
            
            return matchingNotices;
        }
        
        window.searchForCase = searchForCase;
        
        // Debug function to check all notices in backend
        async function checkAllBackendNotices() {
            if (!window.BACKEND_API_URL) {
                console.error('Backend URL not configured');
                return;
            }
            
            try {
                console.log('Fetching ALL notices from backend...');
                const response = await fetch(`${window.BACKEND_API_URL}/api/notices/all?limit=1000`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`Backend has ${data.total} notices total`);
                    
                    // Look for case 34-987654
                    const case34 = data.notices.filter(n => n.case_number && n.case_number.includes('34-987654'));
                    if (case34.length > 0) {
                        console.log(' Found case 34-987654 in backend:', case34);
                    } else {
                        console.log(' Case 34-987654 not found in backend');
                    }
                    
                    // Group by server
                    const byServer = {};
                    data.notices.forEach(n => {
                        const server = n.server_address || 'unknown';
                        if (!byServer[server]) byServer[server] = [];
                        byServer[server].push({
                            id: n.notice_id,
                            case: n.case_number,
                            recipient: n.recipient_address,
                            created: n.created_at
                        });
                    });
                    
                    console.log('Notices grouped by server:', byServer);
                    return data.notices;
                } else {
                    console.error('Failed to fetch all notices:', response.status);
                    const text = await response.text();
                    console.error('Response:', text);
                }
            } catch (error) {
                console.error('Error checking backend notices:', error);
            }
        }
        
        window.checkAllBackendNotices = checkAllBackendNotices;
        
        // Manually sync case 34-987654 to backend
        async function syncCase34ToBackend() {
            if (!window.BACKEND_API_URL) {
                console.error('Backend URL not configured');
                return;
            }
            
            // Data from the TronScan transaction we saw
            // Using notice ID 3 since 1 is already taken
            const case34Data = {
                noticeId: '3', // Changed to avoid conflict
                alertId: '3',  // From the NoticeServed event
                documentId: '4', // From the NoticeServed event
                serverAddress: 'TGdD34RR3rZfUozoQLze9d4tzFbigL4JAY', // From LegalNoticeCreated event
                recipientAddress: 'TD1F37V4cAFH1YQCYVLtcFyFXkZUs7mBDE',
                noticeType: 'Notice of Seizure',
                issuingAgency: 'The Block Audit',
                caseNumber: '34-987654',
                documentHash: '',
                ipfsHash: 'Qmc6cdUtoncRb9Lb5T9dzLF5mXqPqWEF4RKwDgEnGnxTTd',
                hasDocument: true
            };
            
            try {
                console.log('Manually syncing case 34-987654 to backend...', case34Data);
                
                const response = await fetch(`${window.BACKEND_API_URL}/api/notices/served`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(case34Data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(' Successfully synced case 34-987654:', result);
                    
                    // Now refresh the delivery status
                    if (window.refreshDeliveryStatus) {
                        await refreshDeliveryStatus(true);
                    }
                } else {
                    console.error('Failed to sync:', response.status);
                    const text = await response.text();
                    console.error('Response:', text);
                }
            } catch (error) {
                console.error('Error syncing case 34-987654:', error);
            }
        }
        
        window.syncCase34ToBackend = syncCase34ToBackend;
        
        // Temporary workaround - add case without alert_id/document_id
        async function syncCase34Simple() {
            if (!window.BACKEND_API_URL) {
                console.error('Backend URL not configured');
                return;
            }
            
            // Simplified data without alert_id and document_id
            const case34Data = {
                noticeId: '3',
                serverAddress: 'TGdD34RR3rZfUozoQLze9d4tzFbigL4JAY',
                recipientAddress: 'TD1F37V4cAFH1YQCYVLtcFyFXkZUs7mBDE',
                noticeType: 'Notice of Seizure',
                caseNumber: '34-987654'
            };
            
            try {
                console.log('Syncing case 34-987654 (simplified)...', case34Data);
                
                // Use the metadata endpoint which doesn't require alert_id
                const response = await fetch(`${window.BACKEND_API_URL}/api/notices/3/metadata`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(case34Data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(' Successfully synced case 34-987654:', result);
                    
                    // Now refresh the delivery status
                    if (window.refreshDeliveryStatus) {
                        await refreshDeliveryStatus(true);
                    }
                } else {
                    console.error('Failed to sync:', response.status);
                    const text = await response.text();
                    console.error('Response:', text);
                }
            } catch (error) {
                console.error('Error syncing case 34-987654:', error);
            }
        }
        
        window.syncCase34Simple = syncCase34Simple;
        window.checkAllBackendNotices = checkAllBackendNotices;
        window.printAcceptanceReceipt = printAcceptanceReceipt;
        window.viewServiceCertificate = viewServiceCertificate;
        window.viewNoticeAuditTrail = viewNoticeAuditTrail;
        window.viewOnBlockchain = viewOnBlockchain;
        
        // View service certificate for unaccepted notices
        async function viewServiceCertificate(noticeId) {
            try {
                // Generate service certificate
                const alertData = await legalContract.alertNotices(noticeId).call();
                const docData = await legalContract.documentNotices(noticeId).call();
                
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>Service Certificate - Notice ${noticeId}</title>
                        <style>
                            body { font-family: 'Courier New', monospace; padding: 20px; }
                            h1 { text-align: center; }
                            .info-box { border: 1px solid #333; padding: 10px; margin: 10px 0; }
                            @media print {
                                body { padding: 0; margin: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>CERTIFICATE OF SERVICE</h1>
                        <div class="info-box">
                            <h2>Notice Details</h2>
                            <p><strong>Notice ID:</strong> ${noticeId}</p>
                            <p><strong>Recipient:</strong> ${alertData[0]}</p>
                            <p><strong>Process Server:</strong> ${alertData[1]}</p>
                            <p><strong>Service Date:</strong> ${new Date(Number(alertData[3]) * 1000).toLocaleString()}</p>
                            <p><strong>Document Hash:</strong> ${docData[0] || 'No document'}</p>
                            <p><strong>Status:</strong> Served - Awaiting Acceptance</p>
                        </div>
                        <div class="info-box">
                            <h2>Blockchain Verification</h2>
                            <p>This service has been recorded on the TRON blockchain.</p>
                            <p><strong>Contract:</strong> ${legalContract.address}</p>
                            <p><strong>Network:</strong> ${tronWeb.fullNode.host.includes('nile') ? 'Nile Testnet' : 'Mainnet'}</p>
                        </div>
                        <button onclick="window.print()">Print Certificate</button>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            } catch (error) {
                console.error('Error generating service certificate:', error);
                uiManager.showNotification('error', 'Failed to generate service certificate');
            }
        }
        
        // View notice on blockchain explorer
        function viewOnBlockchain(noticeId) {
            const url = `${getTronScanUrl()}/#/contract/${legalContract.address}`;
            window.open(url, '_blank');
        }
        
        // Show tab function for navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.style.display = 'block';
                
                // If showing delivery tab, use unified system
                if (tabName === 'delivery') {
                    // Initialize the unified system and render in delivery container
                    if (window.unifiedSystem) {
                        window.unifiedSystem.init().then(() => {
                            // Replace delivery content with unified cases
                            const deliveryResults = document.getElementById('deliveryResults');
                            if (deliveryResults) {
                                deliveryResults.id = 'unifiedDeliveryCases';
                                window.unifiedSystem.renderCases('unifiedDeliveryCases');
                            }
                        });
                    } else if (window.serverDashboard) {
                        window.serverDashboard.init();
                    } else {
                        // Fallback to old method if new system not loaded
                        refreshDeliveryStatus();
                    }
                }
            } else {
                console.error('Tab not found:', tabName);
            }
        }
        
        // Filter delivery results
        function filterDeliveryResults() {
            const filterValue = document.getElementById('deliveryStatusFilter')?.value || 'all';
            const searchValue = document.getElementById('deliverySearchInput')?.value?.toLowerCase() || '';
            const items = document.querySelectorAll('.delivery-item');
            
            items.forEach(item => {
                let shouldShow = true;
                
                // Apply status filter
                if (filterValue === 'delivered' && !item.innerHTML.includes('Accepted')) {
                    shouldShow = false;
                } else if (filterValue === 'pending' && item.innerHTML.includes('Accepted')) {
                    shouldShow = false;
                } else if (filterValue === 'recent') {
                    // Check if served in last 7 days (would need date parsing)
                    // For now, show all for recent
                }
                
                // Apply search filter (case number, notice ID, recipient)
                if (searchValue && shouldShow) {
                    const text = item.textContent.toLowerCase();
                    if (!text.includes(searchValue)) {
                        shouldShow = false;
                    }
                }
                
                item.style.display = shouldShow ? 'block' : 'none';
            });
        }
        
        // Send delivery reminder (placeholder)
        function sendDeliveryReminder(noticeId) {
            uiManager.showNotification('info', `Reminder functionality for Notice #${noticeId} coming soon`);
        }
        
        // Update creation fee
        async function updateCreationFee() {
            const newFee = document.getElementById('newCreationFee').value;
            if (!newFee || isNaN(newFee) || parseFloat(newFee) < 0) {
                uiManager.showNotification('error', 'Please enter a valid fee amount');
                return;
            }
            
            try {
                if (!legalContract) {
                    uiManager.showNotification('error', 'Contract not connected');
                    return;
                }
                
                const feeInSun = tronWeb.toSun(newFee);
                const tx = await legalContract.updateFee(1, feeInSun).send(); // FeeType.Creation = 1
                
                uiManager.showNotification('success', 'Creation fee updated successfully');
                console.log('Creation fee updated:', tx);
            } catch (error) {
                console.error('Error updating creation fee:', error);
                uiManager.showNotification('error', 'Failed to update creation fee');
            }
        }
        
        // Update sponsorship fee
        async function updateSponsorshipFee() {
            const newFee = document.getElementById('newSponsorshipFee').value;
            if (!newFee || isNaN(newFee) || parseFloat(newFee) < 0) {
                uiManager.showNotification('error', 'Please enter a valid fee amount');
                return;
            }
            
            try {
                if (!legalContract) {
                    uiManager.showNotification('error', 'Contract not connected');
                    return;
                }
                
                const feeInSun = tronWeb.toSun(newFee);
                const tx = await legalContract.updateFee(2, feeInSun).send(); // FeeType.Sponsorship = 2
                
                uiManager.showNotification('success', 'Sponsorship fee updated successfully');
                console.log('Sponsorship fee updated:', tx);
            } catch (error) {
                console.error('Error updating sponsorship fee:', error);
                uiManager.showNotification('error', 'Failed to update sponsorship fee');
            }
        }
        
        // Update fee (generic - already referenced in window)
        async function updateFee(feeType, amount) {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            try {
                const feeInSun = tronWeb.toSun(amount.toString());
                const tx = await legalContract.updateFee(feeType, feeInSun).send();
                uiManager.showNotification('success', 'Fee updated successfully');
                return tx;
            } catch (error) {
                console.error('Error updating fee:', error);
                uiManager.showNotification('error', 'Failed to update fee');
                throw error;
            }
        }
        
        // Save Pinata keys
        function savePinataKeys() {
            const apiKeyElement = document.getElementById('pinataApiKey');
            const apiSecretElement = document.getElementById('pinataApiSecret');
            
            if (!apiKeyElement || !apiSecretElement) {
                console.error('Pinata key input elements not found');
                return;
            }
            
            const apiKey = apiKeyElement.value;
            const apiSecret = apiSecretElement.value;
            
            if (!apiKey || !apiSecret) {
                uiManager.showNotification('error', 'Please enter both API key and secret');
                return;
            }
            
            // Store encrypted in localStorage (in production, use secure backend)
            const keys = {
                apiKey: btoa(apiKey), // Basic encoding for demo
                apiSecret: btoa(apiSecret)
            };
            
            localStorage.setItem('pinataKeys', JSON.stringify(keys));
            uiManager.showNotification('success', 'Pinata keys saved successfully');
            
            // Clear inputs for security
            document.getElementById('pinataApiKey').value = '';
            document.getElementById('pinataApiSecret').value = '';
        }
        
        // Test Pinata connection
        async function testPinataConnection() {
            const storedKeys = localStorage.getItem('pinataKeys');
            if (!storedKeys) {
                uiManager.showNotification('error', 'Please save Pinata keys first');
                return;
            }
            
            try {
                const keys = JSON.parse(storedKeys);
                // In a real app, make API call to test connection
                // For now, just simulate
                uiManager.showNotification('info', 'Testing Pinata connection...');
                
                setTimeout(() => {
                    uiManager.showNotification('success', 'Pinata connection successful!');
                }, 1500);
            } catch (error) {
                uiManager.showNotification('error', 'Failed to test Pinata connection');
            }
        }
        
        // Print document
        function printDocument(documentData) {
            if (!documentData) {
                uiManager.showNotification('error', 'No document to print');
                return;
            }
            
            try {
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Legal Notice Document</title></head><body>');
                printWindow.document.write('<img src="' + documentData + '" style="max-width:100%;">');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.print();
            } catch (error) {
                console.error('Error printing document:', error);
                uiManager.showNotification('error', 'Failed to print document');
            }
        }
        
        // Download document
        function downloadDocument(documentData, filename = 'legal-notice.png') {
            if (!documentData) {
                uiManager.showNotification('error', 'No document to download');
                return;
            }
            
            try {
                const link = document.createElement('a');
                link.href = documentData;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                uiManager.showNotification('success', 'Document downloaded');
            } catch (error) {
                console.error('Error downloading document:', error);
                uiManager.showNotification('error', 'Failed to download document');
            }
        }
        
        // Save receipt as HTML
        function saveReceiptAsHTML() {
            const receiptContent = document.getElementById('receiptContent');
            if (!receiptContent) {
                uiManager.showNotification('error', 'No receipt to save');
                return;
            }
            
            try {
                const htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Legal Notice Receipt</title>
                        <style>
                            body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                            .receipt { border: 1px solid #ddd; padding: 20px; }
                            h2 { color: #333; }
                            .detail { margin: 10px 0; }
                            .label { font-weight: bold; }
                        </style>
                    </head>
                    <body>
                        ${receiptContent.innerHTML}
                    </body>
                    </html>
                `;
                
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'legal-notice-receipt.html';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                uiManager.showNotification('success', 'Receipt saved as HTML');
            } catch (error) {
                console.error('Error saving receipt:', error);
                uiManager.showNotification('error', 'Failed to save receipt');
            }
        }
        
        // Update fee collector
        async function updateFeeCollector() {
            const newCollector = document.getElementById('newFeeCollector').value;
            if (!newCollector || !tronWeb.isAddress(newCollector)) {
                uiManager.showNotification('error', 'Please enter a valid TRON address');
                return;
            }
            
            try {
                if (!legalContract) {
                    uiManager.showNotification('error', 'Contract not connected');
                    return;
                }
                
                const tx = await legalContract.updateFeeCollector(newCollector).send();
                uiManager.showNotification('success', 'Fee collector updated successfully');
                console.log('Fee collector updated:', tx);
            } catch (error) {
                console.error('Error updating fee collector:', error);
                uiManager.showNotification('error', 'Failed to update fee collector');
            }
        }
        
        // Update resource sponsorship settings
        async function updateResourceSponsorship() {
            const energySponsorshipInput = document.getElementById('energySponsorship');
            const bandwidthSponsorshipInput = document.getElementById('bandwidthSponsorship');
            
            if (!energySponsorshipInput || !bandwidthSponsorshipInput) {
                uiManager.showNotification('error', 'Resource sponsorship inputs not found');
                return;
            }
            
            const energyEnabled = energySponsorshipInput.checked;
            const bandwidthEnabled = bandwidthSponsorshipInput.checked;
            
            try {
                // Save to localStorage for persistence
                localStorage.setItem('energySponsorshipEnabled', energyEnabled);
                localStorage.setItem('bandwidthSponsorshipEnabled', bandwidthEnabled);
                
                uiManager.showNotification('success', 
                    `Resource sponsorship updated: Energy ${energyEnabled ? 'enabled' : 'disabled'}, Bandwidth ${bandwidthEnabled ? 'enabled' : 'disabled'}`
                );
                
                // Log for debugging
                console.log('Resource sponsorship updated:', {
                    energy: energyEnabled,
                    bandwidth: bandwidthEnabled
                });
            } catch (error) {
                console.error('Error updating resource sponsorship:', error);
                uiManager.showNotification('error', 'Failed to update resource sponsorship settings');
            }
        }
        
        window.toggleRegistrationForm = toggleRegistrationForm;
        
        // Debug function to manually initialize and refresh notices
        // Function to check contract state
        window.checkContractState = async function() {
            console.log('=== CHECKING CONTRACT STATE ===');
            
            if (!legalContract) {
                console.error('Contract not initialized!');
                return;
            }
            
            try {
                // Check total notices
                console.log('1. Checking totalNotices...');
                const total = await legalContract.totalNotices().call();
                console.log('Total notices in contract:', total.toString());
                
                // Check some recent notices
                if (total > 0) {
                    console.log('2. Checking last few notices...');
                    const checkCount = Math.min(5, parseInt(total));
                    for (let i = parseInt(total) - 1; i >= parseInt(total) - checkCount && i >= 0; i--) {
                        try {
                            const notice = await legalContract.notices(i).call();
                            console.log(`Notice ${i}:`, {
                                alertId: notice.alertId?.toString(),
                                recipient: notice.recipient,
                                sender: notice.server || notice.sender,
                                timestamp: notice.timestamp?.toString()
                            });
                        } catch (e) {
                            console.error(`Error reading notice ${i}:`, e.message);
                        }
                    }
                }
                
                // Check token ownership for connected wallet
                if (tronWeb?.defaultAddress?.base58) {
                    console.log('3. Checking tokens for wallet:', tronWeb.defaultAddress.base58);
                    const balance = await legalContract.balanceOf(tronWeb.defaultAddress.base58).call();
                    console.log('Token balance:', balance.toString());
                    
                    // Try to get owned tokens if enumerable
                    if (balance > 0 && legalContract.tokenOfOwnerByIndex) {
                        console.log('4. Getting owned token IDs...');
                        for (let i = 0; i < Math.min(5, parseInt(balance)); i++) {
                            try {
                                const tokenId = await legalContract.tokenOfOwnerByIndex(tronWeb.defaultAddress.base58, i).call();
                                console.log(`Token ${i}:`, tokenId.toString());
                            } catch (e) {
                                console.log('tokenOfOwnerByIndex not available');
                                break;
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking contract state:', error);
            }
        };
        
        window.debugRefreshNotices = async function() {
            console.log('=== DEBUG: Manual Notice Refresh ===');
            console.log('1. Current wallet:', tronWeb?.defaultAddress?.base58);
            console.log('2. Contract address:', window.CONTRACT_ADDRESS);
            console.log('3. Contract instance:', legalContract ? 'EXISTS' : 'NOT INITIALIZED');
            
            if (!tronWeb || !tronWeb.defaultAddress) {
                console.error('No wallet connected! Please connect wallet first.');
                return;
            }
            
            // Force contract initialization
            console.log('4. Forcing contract initialization...');
            const initResult = await initializeContract();
            console.log('5. Init result:', initResult);
            
            if (!initResult) {
                console.error('Failed to initialize contract!');
                return;
            }
            
            // Force refresh alerts
            console.log('6. Refreshing alerts...');
            await refreshMyAlerts();
            console.log('7. Done! Check the My Alerts section.');
            
            // Additional debug: Try to check total supply or balance
            try {
                console.log('8. Checking NFT balance...');
                const balance = await legalContract.balanceOf(tronWeb.defaultAddress.base58).call();
                console.log('NFT Balance:', balance.toString());
                
                // Try to get recipient alerts directly
                console.log('9. Trying recipientAlerts mapping...');
                const alerts = await legalContract.recipientAlerts(tronWeb.defaultAddress.base58, 0).call();
                console.log('First alert ID (if any):', alerts.toString());
                
                // Try getRecipientAlerts function
                console.log('10. Trying getRecipientAlerts function...');
                const alertsList = await legalContract.getRecipientAlerts(tronWeb.defaultAddress.base58).call();
                console.log('Alert IDs from getRecipientAlerts:', alertsList);
            } catch (e) {
                console.error('Additional debug failed:', e);
            }
        };
        
        async function withdrawFromContract() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            const amountTRX = document.getElementById('withdrawAmount').value;
            if (!amountTRX || parseFloat(amountTRX) <= 0) {
                uiManager.showNotification('error', 'Please enter a valid amount');
                return;
            }
            
            try {
                showProcessing('Withdrawing TRX from contract...');
                
                // Convert TRX to SUN
                const amountSUN = tronWeb.toSun(amountTRX);
                
                const tx = await legalContract.withdrawTRX(amountSUN).send({
                    feeLimit: 10_000_000,
                    callValue: 0,
                    shouldPollResponse: true
                });
                
                hideProcessing();
                uiManager.showNotification('success', `Successfully withdrew ${amountTRX} TRX from contract`);
                document.getElementById('withdrawAmount').value = '';
                
            } catch (error) {
                hideProcessing();
                console.error('Withdrawal error:', error);
                uiManager.showNotification('error', 'Failed to withdraw: ' + getErrorMessage(error));
            }
        }
        
        // GitHub Settings Functions
        function loadGitHubSettings() {
            // Load token if exists
            const savedToken = localStorage.getItem('githubToken');
            if (savedToken) {
                document.getElementById('githubToken').value = savedToken;
            }
            
            // Display encryption key
            document.getElementById('encryptionKey').value = GITHUB_CONFIG.encryptionKey;
        }

        function toggleTokenVisibility() {
            const tokenInput = document.getElementById('githubToken');
            const icon = document.getElementById('tokenVisibilityIcon');
            
            if (tokenInput.type === 'password') {
                tokenInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                tokenInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function copyEncryptionKey() {
            const keyInput = document.getElementById('encryptionKey');
            keyInput.select();
            document.execCommand('copy');
            uiManager.showNotification('success', 'Encryption key copied to clipboard');
        }

        function saveGitHubSettings() {
            const token = document.getElementById('githubToken').value.trim();
            
            if (!token) {
                uiManager.showNotification('error', 'Please enter a GitHub token');
                return;
            }
            
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                uiManager.showNotification('error', 'Invalid token format. Should start with ghp_ or github_pat_');
                return;
            }
            
            // Save to localStorage
            GITHUB_CONFIG.token = token;
            uiManager.showNotification('success', 'GitHub settings saved successfully');
            
            // Update UI
            showAlert('githubSettingsResult', 'success', 'Settings saved! Token will be used for future registrations.');
        }

        async function testGitHubConnection() {
            const token = document.getElementById('githubToken').value.trim() || GITHUB_CONFIG.token;
            
            if (!token) {
                uiManager.showNotification('error', 'Please enter a GitHub token first');
                return;
            }
            
            showProcessing('Testing GitHub connection...');
            
            try {
                // Test API connection
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                hideProcessing();
                
                if (response.ok) {
                    const repo = await response.json();
                    showAlert('githubSettingsResult', 'success', 
                        ` Connected to ${repo.full_name}<br>` +
                        ` Token has repository access<br>` +
                        ` Ready to save encrypted registrations`
                    );
                } else if (response.status === 401) {
                    showAlert('githubSettingsResult', 'error', 'Invalid token or token expired');
                } else if (response.status === 404) {
                    showAlert('githubSettingsResult', 'error', 'Repository not found or no access');
                } else {
                    showAlert('githubSettingsResult', 'error', `Connection failed: ${response.status}`);
                }
            } catch (error) {
                hideProcessing();
                console.error('GitHub test error:', error);
                showAlert('githubSettingsResult', 'error', 'Connection test failed: ' + error.message);
            }
        }

        // Fee exemption functions
        function useConnectedAddressForExemption() {
            if (tronWeb && tronWeb.defaultAddress) {
                document.getElementById('exemptionAddress').value = tronWeb.defaultAddress.base58;
            } else {
                showAlert('exemptionResult', 'error', 'Please connect your wallet first');
            }
        }

        async function setLawEnforcementExemption() {
            if (!legalContract) {
                showAlert('exemptionResult', 'error', 'Contract not connected');
                return;
            }

            const address = document.getElementById('exemptionAddress').value.trim();
            const agencyName = document.getElementById('exemptionAgencyName').value.trim();

            if (!address) {
                showAlert('exemptionResult', 'error', 'Please enter an address');
                return;
            }

            if (!agencyName) {
                showAlert('exemptionResult', 'error', 'Please enter an agency name for law enforcement exemption');
                return;
            }

            if (!tronWeb.isAddress(address)) {
                showAlert('exemptionResult', 'error', 'Invalid TRON address');
                return;
            }

            try {
                showProcessing('Granting law enforcement exemption...');
                
                // Complete contract uses setFeeExemption instead
                const tx = await legalContract.setFeeExemption(address, true, true).send({
                    feeLimit: 100_000_000, // 100 TRX
                    callValue: 0,
                    shouldPollResponse: true
                });

                hideProcessing();
                showAlert('exemptionResult', 'success', `Law enforcement exemption granted to ${address}`);
                
                // Clear inputs
                document.getElementById('exemptionAddress').value = '';
                document.getElementById('exemptionAgencyName').value = '';
            } catch (error) {
                hideProcessing();
                console.error('Error setting exemption:', error);
                showAlert('exemptionResult', 'error', 'Failed to set exemption: ' + getErrorMessage(error));
            }
        }

        async function removeLawEnforcementExemption() {
            if (!legalContract) {
                showAlert('exemptionResult', 'error', 'Contract not connected');
                return;
            }

            const address = document.getElementById('exemptionAddress').value.trim();

            if (!address) {
                showAlert('exemptionResult', 'error', 'Please enter an address');
                return;
            }

            if (!tronWeb.isAddress(address)) {
                showAlert('exemptionResult', 'error', 'Invalid TRON address');
                return;
            }

            try {
                showProcessing('Removing law enforcement exemption...');
                
                const tx = await legalContract.removeLawEnforcementExemption(address).send({
                    feeLimit: 100_000_000, // 100 TRX
                    callValue: 0,
                    shouldPollResponse: true
                });

                hideProcessing();
                showAlert('exemptionResult', 'success', `Law enforcement exemption removed from ${address}`);
                
                // Clear input
                document.getElementById('exemptionAddress').value = '';
            } catch (error) {
                hideProcessing();
                console.error('Error removing exemption:', error);
                showAlert('exemptionResult', 'error', 'Failed to remove exemption: ' + getErrorMessage(error));
            }
        }

        async function checkExemptionStatus() {
            if (!legalContract) {
                showAlert('exemptionResult', 'error', 'Contract not connected');
                return;
            }

            const address = document.getElementById('exemptionAddress').value.trim();

            if (!address) {
                showAlert('exemptionResult', 'error', 'Please enter an address');
                return;
            }

            if (!tronWeb.isAddress(address)) {
                showAlert('exemptionResult', 'error', 'Invalid TRON address');
                return;
            }

            try {
                showProcessing('Checking exemption status...');
                
                // Check law enforcement exemption
                const isLawEnforcementExempt = await legalContract.serviceFeeExemptions(address).call();
                const agencyName = ''; // Complete contract doesn't track agency names
                
                // Calculate actual fee
                const actualFee = await calculateFeeFromConstants(address);
                const feeInTRX = tronWeb.fromSun(actualFee);
                
                hideProcessing();
                
                let statusMessage = `<strong>Address:</strong> ${address}<br>`;
                statusMessage += `<strong>Law Enforcement Exempt:</strong> ${isLawEnforcementExempt ? 'Yes' : 'No'}<br>`;
                if (isLawEnforcementExempt && agencyName) {
                    statusMessage += `<strong>Agency:</strong> ${agencyName}<br>`;
                }
                statusMessage += `<strong>Service Fee:</strong> ${feeInTRX} TRX`;
                
                showAlert('exemptionResult', 'info', statusMessage);
            } catch (error) {
                hideProcessing();
                console.error('Error checking exemption status:', error);
                showAlert('exemptionResult', 'error', 'Failed to check status: ' + getErrorMessage(error));
            }
        }

        window.withdrawFromContract = withdrawFromContract;
        window.useConnectedAddressForExemption = useConnectedAddressForExemption;
        window.setLawEnforcementExemption = setLawEnforcementExemption;
        window.removeLawEnforcementExemption = removeLawEnforcementExemption;
        window.checkExemptionStatus = checkExemptionStatus;
        
        // Debug function to check NFT ownership
        window.checkNFTOwnership = async function(address, tokenId) {
            if (!legalContract) {
                console.error('Contract not connected');
                return;
            }
            
            console.log(`\n=== Checking NFT Ownership ===`);
            console.log(`Address: ${address}`);
            console.log(`Token ID: ${tokenId || 'will check all'}`);
            
            try {
                // Check balance
                const balance = await legalContract.balanceOf(address).call();
                console.log(`\nTotal NFTs owned: ${balance}`);
                
                // If specific token ID provided, check ownership
                if (tokenId !== undefined) {
                    try {
                        const owner = await legalContract.ownerOf(tokenId).call();
                        console.log(`\nToken #${tokenId} owner: ${owner}`);
                        console.log(`Matches queried address: ${owner.toLowerCase() === address.toLowerCase()}`);
                    } catch (e) {
                        console.log(`\nToken #${tokenId} does not exist or error: ${e.message}`);
                    }
                }
                
                // List all owned tokens
                if (balance > 0) {
                    console.log(`\nListing all owned tokens:`);
                    for (let i = 0; i < Math.min(balance, 10); i++) {
                        try {
                            // tokenOfOwnerByIndex not available in this contract
                            console.log(`  Token enumeration not available in this contract version`);
                            break; // Exit loop
                            
                            // Try to get token URI
                            try {
                                const uri = '';
                                console.log(`      URI: ${uri || 'No URI set'}`);
                            } catch (e) {
                                console.log(`      URI: Error fetching`);
                            }
                        } catch (e) {
                            console.log(`  [${i}] Error: ${e.message}`);
                        }
                    }
                    if (balance > 10) {
                        console.log(`  ... and ${balance - 10} more tokens`);
                    }
                } else {
                    console.log('\nNo NFTs found for this address');
                }
                
                // Check contract info
                console.log(`\n=== Contract Info ===`);
                console.log(`Contract Address: ${legalContract.address}`);
                console.log(`View on TronScan: https://nile.tronscan.org/#/contract/${legalContract.address}`);
                console.log(`Token List: https://nile.tronscan.org/#/token721/${legalContract.address}`);
                
            } catch (error) {
                console.error('Error checking NFT ownership:', error);
            }
        };
        // window.updateResourceSponsorship = updateResourceSponsorship; // Function removed in simplified contract
        window.connectContracts = connectContracts;
        
        // Debug function to check notice acceptance status
        window.checkNoticeAcceptance = async function(noticeId) {
            if (!legalContract) {
                console.error('Contract not connected');
                return;
            }
            
            console.log(`\n=== Checking acceptance status for notice #${noticeId} ===`);
            
            try {
                // Check alert notice
                const alertData = await legalContract.alertNotices(noticeId).call();
                console.log('Alert data:', alertData);
                
                if (alertData && Array.isArray(alertData) && alertData.length > 4) {
                    console.log('Acknowledged field (index 4):', alertData[4]);
                    console.log('Type:', typeof alertData[4]);
                    console.log('Value:', JSON.stringify(alertData[4]));
                    console.log('Is acknowledged:', alertData[4] === true);
                }
                
                // Check document notice if exists
                try {
                    const docData = await legalContract.documentNotices(noticeId).call();
                    console.log('\nDocument data:', docData);
                    
                    if (docData && Array.isArray(docData) && docData.length > 4) {
                        console.log('Accepted field (index 4):', docData[4]);
                        console.log('Type:', typeof docData[4]);
                        console.log('Value:', JSON.stringify(docData[4]));
                    }
                } catch (e) {
                    console.log('No document notice for this ID');
                }
                
                // Check NFT ownership
                try {
                    const owner = await legalContract.ownerOf(noticeId).call();
                    console.log('\nNFT owner:', owner);
                } catch (e) {
                    console.log('No NFT minted for this notice ID');
                }
                
            } catch (error) {
                console.error('Error checking notice:', error);
            }
        };
        
        // Manual NFT debugging function
        window.checkNFT = async function(tokenId) {
            if (!legalContract) {
                console.error('Contract not connected');
                return;
            }
            
            console.log(`\n=== Checking NFT #${tokenId} ===`);
            console.log('Contract address:', legalContract.address);
            
            try {
                // Check if token exists by getting owner
                const owner = await legalContract.ownerOf(tokenId).call();
                console.log(' Token exists! Owner:', owner);
                
                // Check token URI
                try {
                    const uri = await legalContract.tokenURI(tokenId).call();
                    console.log('Token URI:', uri);
                    
                    // Decode base64 metadata if present
                    if (uri.startsWith('data:application/json;base64,')) {
                        const json = atob(uri.split(',')[1]);
                        console.log('Decoded metadata:', JSON.parse(json));
                    }
                } catch (e) {
                    console.log('Error getting URI:', e.message);
                }
                
                // Check notice data
                try {
                    const notice = await legalContract.getNotice(tokenId).call();
                    console.log('Notice data:', notice);
                } catch (e) {
                    console.log('Error getting notice:', e.message);
                }
                
            } catch (e) {
                console.error(' Token does not exist or error:', e.message);
            }
            
            console.log('========================\n');
        };
        
        // Check wallet's NFT balance
        window.checkWalletNFTs = async function(address) {
            if (!legalContract) {
                console.error('Contract not connected');
                return;
            }
            
            const addr = address || tronWeb.defaultAddress.base58;
            console.log(`\n=== Checking NFTs for ${addr} ===`);
            
            try {
                const balance = await legalContract.balanceOf(addr).call();
                console.log('NFT Balance:', balance.toString());
                
                if (balance > 0) {
                    console.log('Owned tokens:');
                    for (let i = 0; i < balance; i++) {
                        // tokenOfOwnerByIndex not available - use getRecipientAlerts instead
                        console.log('  - Token enumeration not available. Use getRecipientAlerts() instead.');
                        break;
                    }
                }
            } catch (e) {
                console.error('Error checking balance:', e);
            }
            
            console.log('========================\n');
        };
        
        // Debug function to manually show admin tab
        window.showAdminTab = function() {
            const adminTabButton = document.getElementById('adminTabButton');
            if (adminTabButton) {
                adminTabButton.style.display = 'inline-flex';
                console.log('Admin tab manually shown');
            }
        };
        window.copyWalletAddress = copyWalletAddress;
        window.toggleTokenVisibility = toggleTokenVisibility;
        window.copyEncryptionKey = copyEncryptionKey;
        window.saveGitHubSettings = saveGitHubSettings;
        window.testGitHubConnection = testGitHubConnection;

        // Registration viewer functions
        let allRegistrations = [];
        
        // Process Server ID Generation
        async function generateProcessServerId() {
            // Get the last used ID from localStorage
            let lastId = parseInt(localStorage.getItem('lastProcessServerId') || '0');
            
            // If we have registrations loaded, check for highest ID
            if (allRegistrations.length > 0) {
                allRegistrations.forEach(reg => {
                    if (reg.serverId) {
                        const match = reg.serverId.match(/PS-(\d+)/);
                        if (match) {
                            const id = parseInt(match[1]);
                            if (id > lastId) {
                                lastId = id;
                            }
                        }
                    }
                });
            }
            
            // Increment for new ID
            lastId++;
            
            // Save to localStorage
            localStorage.setItem('lastProcessServerId', lastId.toString());
            
            // Return formatted ID
            return `PS-${String(lastId).padStart(3, '0')}`;
        }
        
        async function fetchAllRegistrations() {
            const token = GITHUB_CONFIG.token;
            const contentDiv = document.getElementById('allRegistrationsContent');
            showProcessing('Loading registrations...');
            
            // Load from localStorage first
            const localRegistrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
            const localRegs = Object.entries(localRegistrations).map(([id, reg]) => ({
                ...reg,
                id,
                _source: 'local'
            }));
            
            if (!token) {
                // No GitHub token - show only local registrations
                allRegistrations = localRegs;
                hideProcessing();
                displayAllRegistrations();
                document.getElementById('exportBtn').style.display = 'inline-flex';
                
                if (allRegistrations.length === 0) {
                    contentDiv.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No registrations found</h3><p>Registrations will appear here after approval</p></div>';
                } else {
                    uiManager.showNotification('info', 'Showing local registrations only. Configure GitHub token to sync with cloud.');
                }
                return;
            }
            
            showProcessing('Fetching registrations from GitHub...');
            
            try {
                // Fetch directory contents
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // Folder doesn't exist yet - no registrations saved to GitHub
                        console.log('Registrations folder not found on GitHub');
                        
                        // Show local registrations if any
                        if (localRegs.length > 0) {
                            allRegistrations = localRegs;
                            hideProcessing();
                            displayAllRegistrations();
                            document.getElementById('exportBtn').style.display = 'inline-flex';
                            uiManager.showNotification('info', 'No cloud registrations found. Showing local registrations only.');
                        } else {
                            contentDiv.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No registrations found</h3><p>Registrations will appear here after approval</p></div>';
                            hideProcessing();
                        }
                        return;
                    }
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const files = await response.json();
                const encFiles = files.filter(f => f.name.endsWith('.enc'));
                
                if (encFiles.length === 0) {
                    contentDiv.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No registrations found</h3></div>';
                    hideProcessing();
                    return;
                }
                
                // Fetch and decrypt each file
                allRegistrations = [];
                let processed = 0;
                
                for (const file of encFiles) {
                    try {
                        const fileResponse = await fetch(file.download_url);
                        const encryptedData = await fileResponse.text();
                        
                        // Decrypt
                        const decrypted = CryptoJS.AES.decrypt(encryptedData, GITHUB_CONFIG.encryptionKey);
                        const decryptedData = decrypted.toString(CryptoJS.enc.Utf8);
                        
                        if (decryptedData) {
                            const registration = JSON.parse(decryptedData);
                            registration._filename = file.name;
                            registration._sha = file.sha;
                            allRegistrations.push(registration);
                        }
                    } catch (e) {
                        console.error('Error decrypting file:', file.name, e);
                    }
                    
                    processed++;
                    showProcessing(`Processing registrations... ${processed}/${encFiles.length}`);
                }
                
                // Merge with local registrations (prefer GitHub version if duplicate)
                const githubAddresses = new Set(allRegistrations.map(r => r.address || r.wallet));
                const uniqueLocalRegs = localRegs.filter(r => !githubAddresses.has(r.address || r.wallet));
                allRegistrations = [...allRegistrations, ...uniqueLocalRegs];
                
                hideProcessing();
                displayAllRegistrations();
                document.getElementById('exportBtn').style.display = 'inline-flex';
                
            } catch (error) {
                hideProcessing();
                console.error('Error fetching registrations:', error);
                
                // Fall back to local registrations
                if (localRegs.length > 0) {
                    allRegistrations = localRegs;
                    displayAllRegistrations();
                    document.getElementById('exportBtn').style.display = 'inline-flex';
                    uiManager.showNotification('warning', 'GitHub sync failed. Showing local registrations only.');
                } else {
                    contentDiv.innerHTML = `<div class="error-state"><i class="fas fa-exclamation-triangle"></i><h3>Error loading registrations</h3><p>${error.message}</p></div>`;
                }
            }
        }
        
        function displayAllRegistrations() {
            const contentDiv = document.getElementById('allRegistrationsContent');
            
            if (allRegistrations.length === 0) {
                contentDiv.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No registrations found</h3></div>';
                return;
            }
            
            let html = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--secondary-navy); border-bottom: 1px solid var(--border);">
                                <th style="padding: 1rem; text-align: left;">Server ID</th>
                                <th style="padding: 1rem; text-align: left;">Agency</th>
                                <th style="padding: 1rem; text-align: left;">License</th>
                                <th style="padding: 1rem; text-align: left;">Email</th>
                                <th style="padding: 1rem; text-align: left;">Phone</th>
                                <th style="padding: 1rem; text-align: left;">Address</th>
                                <th style="padding: 1rem; text-align: left;">Status</th>
                                <th style="padding: 1rem; text-align: left;">Date</th>
                                <th style="padding: 1rem; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            allRegistrations.forEach((reg, index) => {
                const statusClass = reg.status === 'approved' ? 'success' : reg.status === 'rejected' ? 'error' : 'warning';
                const statusIcon = reg.status === 'approved' ? 'check-circle' : reg.status === 'rejected' ? 'times-circle' : 'clock';
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 1rem; font-weight: 600; color: var(--accent-blue);">
                            ${reg.serverId || '<span style="color: var(--text-muted);">Pending</span>'}
                        </td>
                        <td style="padding: 1rem;">${escapeHtml(reg.agencyName || reg.agency || 'N/A')}</td>
                        <td style="padding: 1rem;">${escapeHtml(reg.licenseNumber || reg.license || 'N/A')}</td>
                        <td style="padding: 1rem;">${escapeHtml(reg.agencyEmail || reg.email || 'N/A')}</td>
                        <td style="padding: 1rem;">${escapeHtml(reg.serverPhone || reg.phone || 'N/A')}</td>
                        <td style="padding: 1rem;" title="${escapeHtml(reg.address || reg.wallet || 'N/A')}">
                            ${shortAddress(reg.address || reg.wallet || 'N/A')}
                        </td>
                        <td style="padding: 1rem;">
                            <span class="status-badge ${statusClass}">
                                <i class="fas fa-${statusIcon}"></i> ${reg.status || 'pending'}
                            </span>
                            ${reg._source === 'local' ? '<span style="font-size: 0.75rem; color: var(--text-muted); margin-left: 0.5rem;" title="Stored locally only"><i class="fas fa-database"></i></span>' : ''}
                        </td>
                        <td style="padding: 1rem;">${new Date(reg.registeredAt || reg.timestamp).toLocaleDateString()}</td>
                        <td style="padding: 1rem;">
                            <button class="btn btn-small" onclick="editRegistration(${index})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteRegistration(${index})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 1rem; color: var(--text-muted);">
                    Total: ${allRegistrations.length} registrations
                </p>
            `;
            
            contentDiv.innerHTML = html;
        }
        
        function editRegistration(index) {
            const reg = allRegistrations[index];
            
            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2>Edit Registration</h2>
                        <button class="btn-close" onclick="this.closest('.modal').remove()"></button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Server ID</label>
                        <input type="text" class="form-input" id="editServerId" value="${escapeHtml(reg.serverId || '')}" placeholder="PS-001" ${reg.status === 'approved' ? '' : 'readonly'}>
                        <small class="form-help">${reg.status === 'approved' ? 'Process Server ID' : 'ID will be assigned upon approval'}</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Agency Name</label>
                        <input type="text" class="form-input" id="editAgency" value="${escapeHtml(reg.agencyName || reg.agency || '')}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">License Number</label>
                        <input type="text" class="form-input" id="editLicense" value="${escapeHtml(reg.licenseNumber || reg.license || '')}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="editEmail" value="${escapeHtml(reg.agencyEmail || reg.email || '')}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="editPhone" value="${escapeHtml(reg.serverPhone || reg.phone || '')}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-input" id="editStatus">
                            <option value="pending" ${reg.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="approved" ${reg.status === 'approved' ? 'selected' : ''}>Approved</option>
                            <option value="rejected" ${reg.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="saveRegistrationEdit(${index})">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function saveRegistrationEdit(index) {
            const reg = allRegistrations[index];
            
            // Get edited values
            reg.serverId = document.getElementById('editServerId').value;
            reg.agencyName = reg.agency = document.getElementById('editAgency').value;
            reg.licenseNumber = reg.license = document.getElementById('editLicense').value;
            reg.agencyEmail = reg.email = document.getElementById('editEmail').value;
            reg.serverPhone = reg.phone = document.getElementById('editPhone').value;
            reg.status = document.getElementById('editStatus').value;
            reg.lastModified = new Date().toISOString();
            
            // If status changed to approved and no server ID, generate one
            if (reg.status === 'approved' && !reg.serverId) {
                reg.serverId = await generateProcessServerId();
            }
            
            try {
                showProcessing('Saving changes...');
                
                // Encrypt updated data
                const dataStr = JSON.stringify(reg, null, 2);
                const encrypted = CryptoJS.AES.encrypt(dataStr, GITHUB_CONFIG.encryptionKey).toString();
                const content = btoa(encrypted);
                
                // Update file on GitHub
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}/${reg._filename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update registration for ${reg.agencyName}`,
                        content: content,
                        sha: reg._sha,
                        branch: GITHUB_CONFIG.branch
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                hideProcessing();
                document.querySelector('.modal').remove();
                uiManager.showNotification('success', 'Registration updated successfully');
                
                // Refresh display
                displayAllRegistrations();
                
            } catch (error) {
                hideProcessing();
                console.error('Error saving registration:', error);
                uiManager.showNotification('error', 'Failed to save: ' + error.message);
            }
        }
        
        async function deleteRegistration(index) {
            const reg = allRegistrations[index];
            
            if (!confirm(`Delete registration for ${reg.agencyName || reg.agency}?`)) {
                return;
            }
            
            try {
                showProcessing('Deleting registration...');
                
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}/${reg._filename}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Delete registration for ${reg.agencyName}`,
                        sha: reg._sha,
                        branch: GITHUB_CONFIG.branch
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                hideProcessing();
                uiManager.showNotification('success', 'Registration deleted');
                
                // Remove from array and refresh
                allRegistrations.splice(index, 1);
                displayAllRegistrations();
                
            } catch (error) {
                hideProcessing();
                console.error('Error deleting registration:', error);
                uiManager.showNotification('error', 'Failed to delete: ' + error.message);
            }
        }
        
        function exportRegistrations() {
            if (allRegistrations.length === 0) return;
            
            // Create CSV
            const headers = ['Server ID', 'Agency', 'License', 'Email', 'Phone', 'Address', 'Status', 'Date', 'Purpose'];
            const rows = allRegistrations.map(reg => [
                reg.serverId || '',
                reg.agencyName || reg.agency || '',
                reg.licenseNumber || reg.license || '',
                reg.agencyEmail || reg.email || '',
                reg.serverPhone || reg.phone || '',
                reg.address || reg.wallet || '',
                reg.status || 'pending',
                new Date(reg.registeredAt || reg.timestamp).toLocaleDateString(),
                reg.purpose || ''
            ]);
            
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',') + '\n';
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `registrations_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        window.fetchAllRegistrations = fetchAllRegistrations;
        window.editRegistration = editRegistration;
        window.saveRegistrationEdit = saveRegistrationEdit;
        window.deleteRegistration = deleteRegistration;
        window.exportRegistrations = exportRegistrations;
	window.copyAddress = copyAddress;
	window.useConnectedAddress = useConnectedAddress;
	window.useConnectedAddressForFeeCollector = useConnectedAddressForFeeCollector;
	window.uiManager = uiManager;
	window.handleChainChange = handleChainChange;
	window.toggleStats = toggleStats;
	window.toggleWalletStatus = toggleWalletStatus;
	window.toggleContract = toggleContract;
	
	// Simplified system - no encryption setup needed
    
        
        // Get current network name
        function getCurrentNetwork() {
            if (!tronWeb || !tronWeb.fullNode) return 'Unknown';
            const host = tronWeb.fullNode.host;
            if (host.includes('trongrid.io') && !host.includes('shasta') && !host.includes('nile')) {
                return 'TRON Mainnet';
            } else if (host.includes('nile')) {
                return 'Nile Testnet';
            } else if (host.includes('shasta')) {
                return 'Shasta Testnet';
            }
            return 'Unknown Network';
        }
        
        // Show transaction confirmation modal before any wallet signature
        async function showTransactionConfirmation(type, details = {}) {
            return new Promise((resolve, reject) => {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                
                let title, description, permissions, warnings, gasInfo;
                
                switch(type) {
                    case 'acceptNotice':
                        title = ' Legal Notice Acceptance';
                        description = `
                            <p><strong>You are about to digitally sign receipt of a legal notice.</strong></p>
                            <p>Notice ID: <code>#${details.noticeId}</code></p>
                            <p>This action will:</p>
                            <ul style="text-align: left; margin: 1rem 0;">
                                <li> Create a permanent blockchain record that you received this notice</li>
                                <li> Timestamp your acceptance with the current date and time</li>
                                <li> Allow you to decrypt and view the full document</li>
                                <li> Store your acceptance signature on the blockchain</li>
                            </ul>
                        `;
                        permissions = `
                            <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #1e40af;">What this signature means:</h4>
                                <p style="margin: 0; color: #1e3a8a;">
                                    This is equivalent to signing for certified mail. It proves you received the document 
                                    but does NOT mean you agree with its contents or admit any wrongdoing.
                                </p>
                            </div>
                        `;
                        warnings = `
                            <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #92400e;"> Important Legal Notice:</h4>
                                <p style="margin: 0; color: #92400e;">
                                    By accepting, you acknowledge receipt of this legal document. 
                                    Deadlines mentioned in the document may begin from this acceptance date.
                                    Consider seeking legal advice if you have questions.
                                </p>
                            </div>
                        `;
                        gasInfo = 'Estimated cost: ~5-10 TRX in energy fees';
                        break;
                        
                    case 'serveNotice':
                        title = ' Serve Legal Notice';
                        description = `
                            <p><strong>You are about to serve an official legal notice via blockchain.</strong></p>
                            <p>Recipient: <code>${details.recipient}</code></p>
                            <p>Notice Type: ${details.noticeType}</p>
                            ${details.caseNumber ? `<p>Case #: ${details.caseNumber}</p>` : ''}
                            <p>This action will:</p>
                            <ul style="text-align: left; margin: 1rem 0;">
                                <li> Mint an NFT to the recipient's wallet as proof of service</li>
                                <li> Encrypt the document (only recipient can decrypt)</li>
                                <li> Send ${details.sponsorshipAmount || '2'} TRX to cover recipient's acceptance fees</li>
                                <li> Create immutable proof of service on the blockchain</li>
                                <li> Record exact timestamp of service</li>
                            </ul>
                        `;
                        permissions = `
                            <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #1e40af;">Contract Permissions:</h4>
                                <p style="margin: 0.5rem 0; color: #1e3a8a;">
                                     <strong>NFT Minting:</strong> Creates a TRC-721 token in recipient's wallet<br>
                                     <strong>Data Storage:</strong> Stores encrypted document hash on IPFS<br>
                                     <strong>TRX Transfer:</strong> Sends sponsorship amount to recipient<br>
                                     <strong>Event Logging:</strong> Records service details on blockchain
                                </p>
                            </div>
                        `;
                        warnings = details.isPublicNotice ? `
                            <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #92400e;"> Public Notice Warning:</h4>
                                <p style="margin: 0; color: #92400e;">
                                    The notice text will be publicly visible on the blockchain. 
                                    Ensure it contains no sensitive information.
                                </p>
                            </div>
                        ` : '';
                        gasInfo = `Total cost: ${details.totalCost || 'Calculating...'} TRX (includes fees + sponsorship)`;
                        break;
                        
                    case 'grantRole':
                        title = ' Grant Administrative Role';
                        description = `
                            <p><strong>You are about to grant administrative privileges.</strong></p>
                            <p>Address: <code>${details.address}</code></p>
                            <p>Role: ${details.roleName}</p>
                            <p>This action will:</p>
                            <ul style="text-align: left; margin: 1rem 0;">
                                <li> Grant permanent administrative access</li>
                                <li> Allow this address to: ${details.permissions}</li>
                            </ul>
                        `;
                        permissions = `
                            <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #dc2626;"> Security Warning:</h4>
                                <p style="margin: 0; color: #991b1b;">
                                    This is a high-privilege operation. The granted permissions cannot be easily revoked.
                                    Only grant roles to addresses you absolutely trust.
                                </p>
                            </div>
                        `;
                        warnings = '';
                        gasInfo = 'Estimated cost: ~10-20 TRX in energy fees';
                        break;
                        
                    case 'updateFee':
                        title = ' Update Contract Fee';
                        description = `
                            <p><strong>You are about to modify contract fee settings.</strong></p>
                            <p>Fee Type: ${details.feeType}</p>
                            <p>Current: ${details.currentFee} TRX</p>
                            <p>New: ${details.newFee} TRX</p>
                            <p>This will affect all future transactions of this type.</p>
                        `;
                        permissions = `
                            <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #1e40af;">Admin Permission Required:</h4>
                                <p style="margin: 0; color: #1e3a8a;">
                                    Only contract administrators can modify fee settings.
                                </p>
                            </div>
                        `;
                        warnings = '';
                        gasInfo = 'Estimated cost: ~5-10 TRX in energy fees';
                        break;
                        
                    default:
                        title = ' Transaction Confirmation';
                        description = '<p>You are about to sign a blockchain transaction.</p>';
                        permissions = '';
                        warnings = '';
                        gasInfo = 'Estimated cost: Variable';
                }
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header" style="background: #1e293b; color: white;">
                            <h2 style="margin: 0;">${title}</h2>
                        </div>
                        <div class="modal-body" style="padding: 2rem;">
                            <div style="text-align: center;">
                                ${description}
                            </div>
                            ${permissions}
                            ${warnings}
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <p style="margin: 0; font-size: 0.875rem; color: #64748b;">
                                    <strong>Network:</strong> ${details.network || 'TRON'}<br>
                                    <strong>Gas Fee:</strong> ${gasInfo}<br>
                                    <strong>Contract:</strong> <code style="font-size: 0.75rem;">${details.contractAddress || window.CONTRACT_ADDRESS || 'Not specified'}</code>
                                </p>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                                <button class="btn btn-secondary" onclick="this.closest('.modal').remove(); window.txConfirmReject()">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button class="btn btn-primary" onclick="this.closest('.modal').remove(); window.txConfirmResolve()">
                                    <i class="fas fa-check"></i> Confirm & Sign
                                </button>
                            </div>
                            <p style="margin: 1rem 0 0 0; font-size: 0.75rem; color: #94a3b8; text-align: center;">
                                After clicking confirm, your wallet will open for final signature
                            </p>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Set up promise handlers
                window.txConfirmResolve = () => resolve(true);
                window.txConfirmReject = () => {
                    resolve(false);
                    uiManager.showNotification('info', 'Transaction cancelled');
                };
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        window.txConfirmReject();
                    }
                });
            });
        }
        
        // Notice acceptance function
        async function acceptNotice() {
            const noticeId = window.currentAcceptingNoticeId || document.getElementById('acceptNoticeId').textContent;
            
            if (!noticeId || noticeId === '-') {
                uiManager.showNotification('error', 'No notice ID found');
                return;
            }
            
            // Show confirmation modal
            const confirmed = await showTransactionConfirmation('acceptNotice', {
                noticeId: noticeId
            });
            
            if (!confirmed) {
                return;
            }
            
            try {
                showProcessing('Signing receipt and accepting notice...');
                
                // Get alert notice details
                const alertData = await legalContract.alertNotices(noticeId).call();
                console.log('Alert data for acceptance:', alertData);
                
                // Check if there's a document associated
                const documentId = alertData.documentId;
                const hasDocument = documentId && parseInt(documentId) > 0;
                
                // Call acceptNotice - this returns the decryption key for documents
                const result = await legalContract.acceptNotice(noticeId).send({
                    feeLimit: 100_000_000,
                    shouldPollResponse: true
                });
                
                // Capture IP and device data for law enforcement
                const ipData = await captureIPData();
                
                // Store acceptance metadata including IP for jurisdictional purposes
                const acceptanceData = {
                    noticeId: noticeId,
                    transactionHash: result.txid || result,
                    walletAddress: tronWeb.defaultAddress.base58,
                    acceptanceTime: new Date().toISOString(),
                    timestamp: Date.now(),
                    acceptanceTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    acceptanceLanguage: navigator.language,
                    browserType: getBrowserType(),
                    userAgent: navigator.userAgent,
                    screenResolution: `${screen.width}x${screen.height}`,
                    // IP and location data for law enforcement
                    ipAddress: ipData.ip,
                    location: {
                        country: ipData.country,
                        region: ipData.region,
                        city: ipData.city
                    },
                    country: ipData.country,
                    region: ipData.region,
                    city: ipData.city,
                    isp: ipData.isp,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    // Cryptographic proof
                    acceptanceProof: await generateAcceptanceProof(noticeId, result)
                };
                
                // Store for law enforcement access
                await storeAcceptanceDataForLawEnforcement(noticeId, acceptanceData);
                
                // Send to backend if available
                if (window.BACKEND_API_URL) {
                    try {
                        await fetch(`${window.BACKEND_API_URL}/api/notices/${noticeId}/acceptances`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                acceptorAddress: acceptanceData.walletAddress,
                                transactionHash: acceptanceData.transactionHash,
                                ipAddress: acceptanceData.ipAddress,
                                location: acceptanceData.location,
                                timestamp: acceptanceData.acceptanceTime
                            })
                        });
                        console.log('Acceptance logged to backend');
                    } catch (backendError) {
                        console.error('Failed to log acceptance to backend:', backendError);
                        // Continue silently - local storage is the fallback
                    }
                }
                
                hideProcessing();
                
                // If the notice has a document, decrypt and display it
                if (hasDocument) {
                    try {
                        showProcessing('Retrieving encrypted document...');
                        
                        // Get document notice data
                        const documentData = await legalContract.documentNotices(documentId).call();
                        console.log('Document data:', documentData);
                        
                        const ipfsHash = documentData.encryptedIPFS;
                        const decryptionKey = documentData.decryptionKey;
                        
                        if (!ipfsHash || !decryptionKey) {
                            console.warn('No document data found');
                            closeAcceptModal();
                            uiManager.showNotification('success', 'Notice accepted successfully');
                            await refreshMyAlerts();
                            return;
                        }
                        
                        showProcessing('Decrypting document...');
                        
                        // Fetch and decrypt the document
                        const encryptedData = await SimpleEncryption.fetchFromIPFS(ipfsHash);
                        const decryptedData = SimpleEncryption.decryptDocument(encryptedData, decryptionKey);
                        
                        hideProcessing();
                        
                        // Display the decrypted document
                        displayDecryptedDocument(decryptedData, noticeId);
                        
                        uiManager.showNotification('success', 'Notice accepted and document decrypted!');
                    } catch (error) {
                        hideProcessing();
                        console.error('Error decrypting document:', error);
                        uiManager.showNotification('warning', 'Notice accepted but could not decrypt document');
                    }
                } else {
                    uiManager.showNotification('success', 'Notice accepted successfully!');
                }

                // Update UI immediately
                const noticeItem = document.querySelector(`[data-notice-id="${noticeId}"]`);
                if (noticeItem) {
                    const badge = noticeItem.querySelector('.badge');
                    if (badge) {
                        badge.textContent = 'Accepted';
                        badge.classList.remove('badge-warning');
                        badge.classList.add('badge-success');
                    }
                }
                
                // Close modal and refresh
                closeAcceptModal();
                setTimeout(() => {
                    refreshMyAlerts();
                }, 2000);
                
            } catch (error) {
                hideProcessing();
                console.error('Error accepting notice:', error);
                uiManager.showNotification('error', 'Failed to accept: ' + getErrorMessage(error));
            }
        }
        
        // Search for notices by wallet address (public view)
        async function searchWalletNotices() {
            const walletInput = document.getElementById('walletSearchInput');
            const errorDiv = document.getElementById('walletSearchError');
            const alertsContent = document.getElementById('myAlertsContent');
            
            if (!walletInput || !errorDiv || !alertsContent) {
                console.error('Required elements not found');
                return;
            }
            
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
            
            const walletAddress = walletInput.value.trim();
            
            // Validate wallet address
            if (!walletAddress) {
                errorDiv.textContent = 'Please enter a wallet address';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Basic TRON address validation (starts with T and is 34 characters)
            if (!walletAddress.startsWith('T') || walletAddress.length !== 34) {
                errorDiv.textContent = 'Invalid TRON wallet address';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Show loading state
            alertsContent.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #3b82f6;"></i>
                    <p style="margin-top: 1rem; color: #64748b;">${LanguageManager.translate('blockserved.searchButton')}...</p>
                </div>
            `;
            
            // Track manual wallet query with IP
            await trackWalletConnection(walletAddress, 'manual_query');
            
            try {
                // Initialize TronWeb if needed for public search
                if (!window.tronWeb || !window.tronWeb.ready) {
                    // Create a read-only TronWeb instance for public searches
                    window.tronWeb = new TronWeb({
                        fullHost: 'https://api.trongrid.io'
                    });
                }
                
                if (!legalContract) {
                    // Initialize contract if not already done
                    const contractAddress = window.CONTRACT_ADDRESS || 'TLhYHQatauDtZ4iNCePU26WbVjsXtMPdoN';
                    legalContract = await window.tronWeb.contract().at(contractAddress);
                }
                
                // Get notices for the wallet
                const notices = await legalContract.getRecipientNotices(walletAddress).call();
                
                if (!notices || notices.length === 0) {
                    alertsContent.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 3rem;">
                            <i class="fas fa-inbox" style="font-size: 3rem; color: #cbd5e1;"></i>
                            <h3 style="margin-top: 1rem; color: #64748b;">${LanguageManager.translate('blockserved.noNotices')}</h3>
                            <p style="color: #94a3b8;">${LanguageManager.translate('blockserved.noNotices')}</p>
                        </div>
                    `;
                    return;
                }
                
                // Display notices in read-only mode
                let html = `
                    <div style="padding: 1rem; background: #f0f9ff; border-radius: 8px; margin-bottom: 1rem;">
                        <p style="margin: 0; color: #1e40af;">
                            <i class="fas fa-info-circle"></i> 
                            Found ${notices.length} notice${notices.length !== 1 ? 's' : ''} for wallet: 
                            <code style="background: #dbeafe; padding: 0.25rem 0.5rem; border-radius: 4px;">${walletAddress}</code>
                        </p>
                        <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.875rem;">
                            Note: To accept these notices, the wallet owner must connect their wallet.
                        </p>
                    </div>
                `;
                
                html += '<div class="notices-list">';
                
                for (const noticeId of notices) {
                    try {
                        const notice = await legalContract.notices(noticeId).call();
                        const isAccepted = await legalContract.hasAcceptedNotice(walletAddress, noticeId).call();
                        
                        html += `
                            <div class="notice-card" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                    <h3 style="margin: 0; color: #1e293b;">
                                        <i class="fas fa-file-alt" style="color: #3b82f6;"></i> 
                                        Notice #${noticeId}
                                    </h3>
                                    <span class="status-badge ${isAccepted ? 'success' : 'warning'}" style="padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem;">
                                        ${isAccepted ? 
                                            `<i class="fas fa-check-circle"></i> ${LanguageManager.translate('blockserved.accepted')}` : 
                                            `<i class="fas fa-clock"></i> ${LanguageManager.translate('blockserved.pending')}`
                                        }
                                    </span>
                                </div>
                                
                                <div class="notice-details" style="display: grid; gap: 0.75rem;">
                                    <div style="display: flex; gap: 0.5rem;">
                                        <strong style="color: #64748b; min-width: 120px;" data-translate="blockserved.noticeType">Type:</strong>
                                        <span>${notice.noticeType || 'Legal Notice'}</span>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <strong style="color: #64748b; min-width: 120px;" data-translate="blockserved.caseNumber">Case Number:</strong>
                                        <span>${notice.caseNumber || 'N/A'}</span>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <strong style="color: #64748b; min-width: 120px;" data-translate="blockserved.noticeFrom">From:</strong>
                                        <span>${notice.server ? `${notice.server.substring(0, 6)}...${notice.server.slice(-4)}` : 'Unknown'}</span>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <strong style="color: #64748b; min-width: 120px;" data-translate="blockserved.issuingAgency">Agency:</strong>
                                        <span>${notice.issuingAgency || 'Not specified'}</span>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <strong style="color: #64748b; min-width: 120px;">Date Served:</strong>
                                        <span>${new Date(parseInt(notice.timestamp) * 1000).toLocaleString()}</span>
                                    </div>
                                    ${notice.publicText ? `
                                        <div style="margin-top: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 6px;">
                                            <strong style="color: #64748b;">Notice:</strong>
                                            <p style="margin: 0.25rem 0 0 0;">${notice.publicText}</p>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                ${!isAccepted ? `
                                    <div style="margin-top: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 6px; border: 1px solid #fbbf24;">
                                        <p style="margin: 0; color: #92400e;">
                                            <i class="fas fa-exclamation-triangle"></i> 
                                            ${LanguageManager.translate('blockserved.acceptanceInstructions')}
                                        </p>
                                    </div>
                                ` : `
                                    <div style="margin: 1rem; padding: 0.75rem; background: #d1fae5; border-radius: 6px;">
                                        <p style="margin: 0; color: #065f46;">
                                            <i class="fas fa-check-circle"></i> 
                                            ${LanguageManager.translate('blockserved.acceptanceRecorded')}
                                        </p>
                                    </div>
                                `}
                                
                                ${notice.metadataURI && notice.metadataURI.includes('ipfs') ? `
                                    <div style="margin-top: 1rem;">
                                        <button class="btn btn-secondary" onclick="viewNoticeMetadata('${notice.metadataURI}')" style="width: 100%;">
                                            <i class="fas fa-image"></i> View NFT Preview
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    } catch (error) {
                        console.error('Error loading notice details:', error);
                    }
                }
                
                html += '</div>';
                alertsContent.innerHTML = html;
                
                // Update dynamic translations
                LanguageManager.updateDynamicContent();
                
            } catch (error) {
                console.error('Search error:', error);
                alertsContent.innerHTML = `
                    <div class="error-state" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ef4444;"></i>
                        <h3 style="margin-top: 1rem; color: #dc2626;">${LanguageManager.translate('blockserved.errorLoading')}</h3>
                        <p style="color: #7f1d1d;">${getErrorMessage(error)}</p>
                        <button class="btn btn-secondary" onclick="searchWalletNotices()" style="margin-top: 1rem;">
                            <i class="fas fa-redo"></i> ${LanguageManager.translate('blockserved.tryAgain')}
                        </button>
                    </div>
                `;
            }
        }
        
        // View notice metadata (for public preview)
        async function viewNoticeMetadata(metadataURI) {
            if (!metadataURI) return;
            
            try {
                let url = metadataURI;
                if (metadataURI.startsWith('ipfs://')) {
                    url = metadataURI.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                }
                
                const response = await fetch(url);
                const metadata = await response.json();
                
                // Create modal to show metadata
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h2>NFT Preview</h2>
                            <button class="modal-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body" style="text-align: center;">
                            ${metadata.image ? `
                                <img src="${metadata.image.startsWith('ipfs://') ? 
                                    metadata.image.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/') : 
                                    metadata.image}" 
                                    style="max-width: 100%; border-radius: 8px; margin-bottom: 1rem;"
                                    onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwMCIgaGVpZ2h0PSI0MDAiIGZpbGw9IiNmM2Y0ZjYiLz4KPHRleHQgeD0iMjAwIiB5PSIyMDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5Y2EzYWYiIGZvbnQtc2l6ZT0iMTgiIGZvbnQtZmFtaWx5PSJBcmlhbCI+SW1hZ2UgTm90IEF2YWlsYWJsZTwvdGV4dD4KPC9zdmc+'">
                            ` : ''}
                            <h3>${metadata.name || 'Legal Notice'}</h3>
                            <div style="text-align: left; background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                <p style="white-space: pre-wrap; margin: 0;">${metadata.description || 'No description available'}</p>
                            </div>
                            ${metadata.external_url ? `
                                <div style="margin-top: 1rem;">
                                    <a href="${metadata.external_url}" target="_blank" class="btn btn-primary">
                                        <i class="fas fa-external-link-alt"></i> Visit BlockServed
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Close on click outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                
            } catch (error) {
                uiManager.showNotification('error', 'Failed to load NFT preview');
            }
        }
        
        // Refresh my alerts - now shows only document notices for recipients
        async function refreshMyAlerts() {
            console.log('refreshMyAlerts called');
            
            if (!legalContract || !tronWeb.defaultAddress) {
                console.error('No contract or wallet connected');
                uiManager.showNotification('error', 'Please connect wallet first');
                return;
            }
            
            try {
                const myAddress = tronWeb.defaultAddress.base58;
                console.log('Refreshing document notices for address:', myAddress);
                
                // Get only document notices for this recipient
                const noticeData = await getRecipientDocumentNotices(myAddress);
                console.log('Notice data found:', noticeData);
                
                const alertsContent = document.getElementById('myAlertsContent');
                if (!alertsContent) {
                    console.error('myAlertsContent element not found');
                    return;
                }
                
                if (!noticeData || noticeData.length === 0) {
                    console.log('No document notices found for this address');
                    alertsContent.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-envelope"></i>
                            <h3>${LanguageManager ? LanguageManager.translate('blockserved.noDocuments') : 'No Legal Documents Found'}</h3>
                            <p>${LanguageManager ? LanguageManager.translate('blockserved.noDocumentsDesc') : 'Legal documents sent to your wallet will appear here'}</p>
                        </div>`;
                    return;
                }
                
                let html = '<div class="notice-list">';
                
                for (const notice of noticeData) {
                    const noticeId = notice.noticeIndex;
                    const documentId = notice.documentId;
                    const alertId = notice.alertId;
                    try {
                        // Get document notice data using the documentId
                        const docData = await legalContract.documentNotices(documentId).call();
                        console.log(`Document notice ${documentId} data:`, docData);
                        
                        // v5 documentNotices structure: [encryptedIPFS, decryptionKey, authorizedViewer, alertId, isRestricted]
                        const encryptedIPFS = docData[0];
                        const decryptionKey = docData[1];
                        const authorizedViewer = docData[2];
                        const linkedAlertId = docData[3];
                        const isRestricted = docData[4];
                        
                        // Get alert data for acknowledgment status and details
                        let isAccepted = false;
                        let noticeType = 'Legal Document';
                        let caseNumber = '';
                        let issuingAgency = '';
                        let timestamp = Date.now() / 1000; // Default to now
                        let serverAddress = '';
                        
                        try {
                            const alertData = await legalContract.alertNotices(alertId).call();
                            console.log(`Alert notice ${alertId} data:`, alertData);
                            
                            if (alertData && Array.isArray(alertData) && alertData.length > 10) {
                                // v5 alertNotices structure: [recipient, sender, documentId, timestamp, acknowledged, 
                                // issuingAgency, noticeType, caseNumber, caseDetails, legalRights, responseDeadline, previewImage]
                                serverAddress = alertData[1]; // sender
                                timestamp = parseInt(alertData[3]) || timestamp; // timestamp
                                isAccepted = alertData[4] === true; // acknowledged
                                issuingAgency = alertData[5] || ''; // issuingAgency
                                noticeType = alertData[6] || 'Legal Document'; // noticeType
                                caseNumber = alertData[7] || ''; // caseNumber
                                
                                // Convert server address from hex if needed
                                if (serverAddress && serverAddress.startsWith('41')) {
                                    serverAddress = tronWeb.address.fromHex(serverAddress);
                                }
                            }
                        } catch (e) {
                            console.log(`Error getting alert data for ${alertId}:`, e);
                        }
                        
                        // Build the recipient-friendly notice display
                        const formattedDate = new Date(timestamp * 1000).toLocaleString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        });
                        
                        
                        html += `
                            <div class="notice-item" style="background: #f8f9fa; border: 2px solid ${isAccepted ? '#22c55e' : '#f59e0b'}; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; color: #1e293b;">
                                <div class="notice-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h3 style="margin: 0; color: #1e293b;">
                                        <i class="fas fa-envelope-open-text"></i> Legal Notice (Alert #${alertId}, Document #${documentId})
                                    </h3>
                                    <span class="badge ${isAccepted ? 'badge-success' : 'badge-warning'}" style="font-size: 0.9rem;">
                                        ${isAccepted ? '<i class="fas fa-check-circle"></i> Document Accessed' : '<i class="fas fa-exclamation-circle"></i> Action Required'}
                                    </span>
                                </div>
                                
                                <div class="notice-details" style="color: #1e293b;">
                                    <div style="display: grid; gap: 0.5rem; margin-bottom: 1rem; color: #1e293b;">
                                        <div style="color: #1e293b;"><strong style="color: #1e293b;">From:</strong> ${formatAddress(serverAddress)}</div>
                                        ${issuingAgency ? `<div style="color: #1e293b;"><strong style="color: #1e293b;">Agency:</strong> ${issuingAgency}</div>` : ''}
                                        <div style="color: #1e293b;"><strong style="color: #1e293b;">Date Served:</strong> ${formattedDate}</div>
                                        <div style="color: #1e293b;"><strong style="color: #1e293b;">Document Type:</strong> ${noticeType}</div>
                                        ${caseNumber ? `<div style="color: #1e293b;"><strong style="color: #1e293b;">Case Number:</strong> ${caseNumber}</div>` : ''}
                                    </div>
                                    
                                    ${!isAccepted ? `
                                        <div class="alert alert-warning" style="margin-bottom: 1rem; color: #856404;">
                                            <i class="fas fa-exclamation-triangle"></i> 
                                            <strong>Important:</strong> You must accept this notice to access the legal document. 
                                            Failure to respond may result in default judgment.
                                        </div>
                                        
                                        <button class="btn btn-primary" style="font-size: 1.1rem; padding: 0.75rem 1.5rem;" onclick="acceptDocumentNotice(${alertId})">
                                            <i class="fas fa-signature"></i> Accept Notice & View Document
                                        </button>
                                    ` : `
                                        <div class="alert alert-success" style="margin-bottom: 1rem; color: #155724;">
                                            <i class="fas fa-check-circle"></i> 
                                            You have accepted this notice. The document is now available for viewing.
                                        </div>
                                        
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button class="btn btn-success" onclick="viewAcceptedDocument(${documentId}, '${encryptedIPFS}')">
                                                <i class="fas fa-file-download"></i> View Document
                                            </button>
                                            <button class="btn btn-secondary" onclick="showAcceptanceReceipt(${alertId})">
                                                <i class="fas fa-receipt"></i> View Receipt
                                            </button>
                                        </div>
                                    `}
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        console.error('Error loading notice', noticeId, e);
                    }
                }
                html += '</div>';
                
                alertsContent.innerHTML = html;
                
            } catch (error) {
                console.error('Error refreshing alerts:', error);
                uiManager.showNotification('error', 'Failed to refresh alerts');
            }
        }

        // Accept a document notice
        async function acceptDocumentNotice(noticeId) {
            if (!legalContract || !tronWeb || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect your wallet first');
                return;
            }

            try {
                showProcessing('Accepting document notice...');

                // First check if this is actually an alert notice we need to acknowledge
                let alertData;
                try {
                    // Use the correct method name: alerts() not alertNotices()
                    alertData = await legalContract.alerts(noticeId).call();
                    if (alertData && Array.isArray(alertData)) {
                        // Check if this alert has been delivered/acknowledged
                        // alertData structure: [server, recipient, tokenURI, description, thumbnail, jurisdiction, timestamp, delivered, ...]
                        const delivered = alertData[7]; // delivered flag is at index 7
                        
                        if (delivered) {
                            uiManager.showNotification('info', 'You have already accepted this notice');
                            hideProcessing();
                            
                            // Try to show the associated document if it exists
                            try {
                                const documentId = parseInt(noticeId) + 1; // Documents are usually next ID
                                const docData = await legalContract.documents(documentId).call();
                                if (docData && docData[2]) { // Check if IPFS hash exists
                                    // Automatically show the document viewer
                                    await viewDocument(documentId);
                                }
                            } catch (e) {
                                console.log('No associated document found');
                            }
                            
                            return;
                        }

                        // This is an alert - accept it using acceptNotice
                        const result = await legalContract.acceptNotice(noticeId).send({
                            feeLimit: 100_000_000,
                            shouldPollResponse: true
                        });

                        uiManager.showNotification('success', 'Notice accepted successfully!');

                        // Log acceptance to backend
                        try {
                            await fetch(`${window.BACKEND_API_URL}/api/notices/${noticeId}/acceptances`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    noticeId,
                                    acceptorAddress: tronWeb.defaultAddress.base58,
                                    transactionHash: result,
                                    timestamp: new Date().toISOString()
                                })
                            });
                        } catch (error) {
                            console.warn('Failed to log acceptance to backend:', error);
                        }

                        // Check for and display associated document
                        try {
                            const documentId = parseInt(noticeId) + 1;
                            const docData = await legalContract.documents(documentId).call();
                            if (docData && docData[2]) {
                                // Automatically show the document viewer after acceptance
                                await viewDocument(documentId);
                            }
                        } catch (e) {
                            console.log('No associated document to display');
                        }

                        // Refresh the notices list
                        await refreshMyAlerts();
                        hideProcessing();
                        return;
                    }
                } catch (e) {
                    // Not an alert notice, check if it's a document notice
                    console.log('Not an alert, checking if document...', e);
                }

                // If we get here, handle as document notice using documents() method
                const docData = await legalContract.documents(noticeId).call();
                if (!docData || !Array.isArray(docData)) {
                    throw new Error('Invalid document notice data');
                }

                // Document data structure: [server, recipient, ipfsHash, timestamp, signed]
                const [server, recipient, ipfsHash, timestamp, signed] = docData;

                if (signed) {
                    uiManager.showNotification('info', 'You have already signed this document');
                    hideProcessing();
                    // Show the document viewer anyway
                    await viewDocument(noticeId);
                    return;
                }

                // Call acceptNotice on contract (this is the correct function name)
                const result = await legalContract.acceptNotice(noticeId).send({
                    feeLimit: 100_000_000,
                    shouldPollResponse: true
                });

                uiManager.showNotification('success', 'Document signed successfully!');

                // Log acceptance to backend
                try {
                    await fetch(`${window.BACKEND_API_URL}/api/notices/${noticeId}/acceptances`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            noticeId,
                            acceptorAddress: tronWeb.defaultAddress.base58,
                            transactionHash: result,
                            timestamp: new Date().toISOString()
                        })
                    });
                } catch (error) {
                    console.warn('Failed to log acceptance to backend:', error);
                }

                // Automatically show the document after signing
                await viewDocument(noticeId);

                // Refresh the notices list
                await refreshMyAlerts();

            } catch (error) {
                console.error('Error accepting notice:', error);
                uiManager.showNotification('error', error.message || 'Failed to accept notice');
            } finally {
                hideProcessing();
            }
        }

        // Log document view/download events
        async function logDocumentView(documentId, action = 'view') {
            try {
                // Get notice ID from document ID (they're often the same in v5)
                const noticeId = documentId;
                
                // Log locally
                await logRecipientVisit(noticeId);
                
                // Send to backend
                if (window.BACKEND_API_URL) {
                    try {
                        const ipResponse = await fetch('https://api.ipify.org?format=json');
                        const { ip } = await ipResponse.json();
                        
                        const geoResponse = await fetch(`https://ipapi.co/${ip}/json/`);
                        const geoData = await geoResponse.json();
                        
                        await fetch(`${window.BACKEND_API_URL}/api/notices/${noticeId}/views`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                viewerAddress: tronWeb.defaultAddress.base58,
                                ipAddress: ip,
                                userAgent: navigator.userAgent,
                                location: {
                                    city: geoData.city,
                                    region: geoData.region,
                                    country: geoData.country_name
                                },
                                action: action,
                                timestamp: new Date().toISOString()
                            })
                        });
                        console.log(`Document ${action} logged to backend`);
                    } catch (e) {
                        console.error('Failed to log to backend:', e);
                    }
                }
            } catch (error) {
                console.error('Error logging document view:', error);
            }
        }
        
        // View an accepted document
        async function viewAcceptedDocument(documentId, encryptedIPFS) {
            if (!legalContract || !tronWeb || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect your wallet first');
                return;
            }

            try {
                // Log this view event
                await logDocumentView(documentId, 'view');
                
                showProcessing('Retrieving document from IPFS...');

                // Get the document notice data to retrieve decryption key
                const docData = await legalContract.documentNotices(documentId).call();
                if (!docData || !Array.isArray(docData) || docData.length < 2) {
                    throw new Error('Invalid document notice data');
                }

                // v5 structure: [encryptedIPFS, decryptionKey, authorizedViewer, alertId, isRestricted]
                if (!encryptedIPFS || encryptedIPFS === '') {
                    encryptedIPFS = docData[0];
                }
                const decryptionKey = docData[1];

                if (!encryptedIPFS || encryptedIPFS === '') {
                    uiManager.showNotification('error', 'No document attached to this notice');
                    hideProcessing();
                    return;
                }

                if (!decryptionKey || decryptionKey === '') {
                    uiManager.showNotification('error', 'No decryption key available');
                    hideProcessing();
                    return;
                }

                // Try multiple IPFS gateways
                const gateways = [
                    `https://gateway.pinata.cloud/ipfs/${encryptedIPFS}`,
                    `https://ipfs.io/ipfs/${encryptedIPFS}`,
                    `https://cloudflare-ipfs.com/ipfs/${encryptedIPFS}`
                ];

                let encryptedContent = null;
                for (const gateway of gateways) {
                    try {
                        showProcessing(`Trying gateway: ${new URL(gateway).hostname}...`);
                        const response = await fetch(gateway);
                        if (response.ok) {
                            // Get as text since it's encrypted
                            encryptedContent = await response.text();
                            console.log('Retrieved encrypted content from IPFS');
                            break;
                        }
                    } catch (error) {
                        console.warn(`Failed to fetch from ${gateway}:`, error);
                    }
                }

                if (!encryptedContent) {
                    throw new Error('Failed to retrieve document from IPFS');
                }

                // Decrypt the content
                showProcessing('Decrypting document...');
                let documentData;
                try {
                    // Check if CryptoJS is available
                    if (typeof CryptoJS === 'undefined') {
                        throw new Error('CryptoJS not loaded');
                    }

                    // Decrypt using the key
                    const decrypted = CryptoJS.AES.decrypt(encryptedContent, decryptionKey);
                    const decryptedString = decrypted.toString(CryptoJS.enc.Utf8);
                    
                    if (!decryptedString) {
                        throw new Error('Decryption failed - invalid key or corrupted data');
                    }

                    console.log('Decrypted content preview:', decryptedString.substring(0, 50) + '...');

                    // Check if it's a data URL (image/pdf)
                    if (decryptedString.startsWith('data:')) {
                        const [header, base64Data] = decryptedString.split(',');
                        const mimeType = header.match(/data:([^;]+)/)[1];
                        
                        if (mimeType.startsWith('image/')) {
                            // It's an image
                            documentData = {
                                type: 'image',
                                content: decryptedString,
                                mimeType: mimeType
                            };
                        } else if (mimeType === 'application/pdf') {
                            // It's a PDF
                            documentData = {
                                type: 'pdf',
                                pdf: base64Data
                            };
                        } else {
                            // Unknown data URL type
                            documentData = {
                                type: 'dataurl',
                                content: decryptedString
                            };
                        }
                    } else {
                        // Try to parse as JSON
                        try {
                            documentData = JSON.parse(decryptedString);
                        } catch (e) {
                            // If not JSON, treat as plain text
                            documentData = {
                                type: 'text',
                                content: decryptedString
                            };
                        }
                    }
                    
                    console.log('Document processed successfully, type:', documentData.type);
                } catch (error) {
                    console.error('Decryption error:', error);
                    throw new Error('Failed to decrypt document: ' + error.message);
                }

                // Show document in modal
                showDocumentModal(documentData, documentId);

                // Log view to backend
                try {
                    await fetch(`${window.BACKEND_API_URL}/api/notices/${documentId}/views`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            noticeId: documentId,
                            viewerAddress: tronWeb.defaultAddress.base58,
                            timestamp: new Date().toISOString()
                        })
                    });
                } catch (error) {
                    console.warn('Failed to log view to backend:', error);
                }

            } catch (error) {
                console.error('Error viewing document:', error);
                uiManager.showNotification('error', error.message || 'Failed to retrieve document');
            } finally {
                hideProcessing();
            }
        }

        // Show document in a modal
        function showDocumentModal(documentData, documentId) {
            // Store documentData globally for the buttons to access
            window.currentDocumentData = documentData;
            window.currentDocumentId = documentId;
            
            // Create modal for document viewing
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>Legal Document - Document NFT #${documentId}</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="document-viewer">
                            ${documentData.type === 'image' ? `
                                <div class="document-image" style="text-align: center;">
                                    <img src="${documentData.content}" 
                                         style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px;"
                                         alt="Legal Document">
                                </div>
                            ` : ''}
                            ${documentData.type === 'text' || documentData.content ? `
                                <div class="document-content" style="white-space: pre-wrap; font-family: 'Courier New', monospace; background: #f5f5f5; padding: 1rem; border-radius: 4px; color: #333;">
                                    ${escapeHtml(documentData.content || '')}
                                </div>
                            ` : ''}
                            ${documentData.html ? `
                                <div class="document-html" style="background: white; padding: 1rem; border: 1px solid #ddd; border-radius: 4px;">
                                    ${documentData.html}
                                </div>
                            ` : ''}
                            ${documentData.pdf || documentData.type === 'pdf' ? `
                                <iframe src="data:application/pdf;base64,${documentData.pdf}" 
                                        style="width: 100%; height: 600px; border: none;"
                                        title="Legal Document PDF">
                                </iframe>
                            ` : ''}
                            ${documentData.type === 'dataurl' ? `
                                <div class="document-embed" style="text-align: center;">
                                    <iframe src="${documentData.content}" 
                                            style="width: 100%; height: 600px; border: 1px solid #ddd;"
                                            title="Legal Document">
                                    </iframe>
                                </div>
                            ` : ''}
                        </div>
                        <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem; justify-content: center;">
                            <button class="btn btn-primary" onclick="downloadDocument(window.currentDocumentId, window.currentDocumentData)">
                                <i class="fas fa-download"></i> Download Document
                            </button>
                            <button class="btn btn-secondary" onclick="printDocument(window.currentDocumentId, window.currentDocumentData)">
                                <i class="fas fa-print"></i> Print Document
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show acceptance receipt
        async function showAcceptanceReceipt(noticeId) {
            try {
                // Get receipt data from contract
                const alertData = await legalContract.alertNotices(noticeId).call();
                
                // Create receipt modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; background: white; color: #1e293b;">
                        <div class="modal-header">
                            <h3 style="color: #1e293b;">Acceptance Receipt - Notice #${noticeId}</h3>
                            <button class="close-btn" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body" style="color: #1e293b;">
                            <div class="receipt-content" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                                <h4 style="text-align: center; margin-bottom: 1rem; color: #1e293b;">LEGAL NOTICE ACCEPTANCE RECEIPT</h4>
                                <div style="margin-bottom: 1rem; color: #1e293b;">
                                    <strong>Notice ID:</strong> ${noticeId}<br>
                                    <strong>Accepted By:</strong> ${tronWeb.defaultAddress ? tronWeb.defaultAddress.base58 : 'Unknown'}<br>
                                    <strong>Acceptance Date:</strong> ${new Date().toLocaleString()}<br>
                                    <strong>Document Type:</strong> ${alertData[6] || 'Legal Notice'}<br>
                                    ${alertData[7] ? `<strong>Case Number:</strong> ${alertData[7]}<br>` : ''}
                                    ${alertData[5] ? `<strong>Issuing Agency:</strong> ${alertData[5]}<br>` : ''}
                                </div>
                                <div class="alert alert-info" style="background: #dbeafe; border: 1px solid #3b82f6; padding: 1rem; border-radius: 4px; color: #1e40af;">
                                    <i class="fas fa-info-circle"></i> 
                                    This receipt confirms that you have acknowledged receipt of the legal notice. 
                                    This acknowledgment is permanently recorded on the TRON blockchain.
                                </div>
                                
                                <div style="margin-top: 1rem; padding: 1rem; background: white; border: 1px solid #e5e7eb; border-radius: 4px;">
                                    <h5 style="color: #1e293b; margin-bottom: 0.5rem;">Blockchain Verification</h5>
                                    <div style="color: #475569;">
                                        <strong>Contract:</strong> ${legalContract.address}<br>
                                        <strong>Alert ID:</strong> ${noticeId}<br>
                                        <strong>Network:</strong> TRON ${tronWeb.fullNode.host.includes('nile') ? 'Nile Testnet' : 'Mainnet'}
                                    </div>
                                    <a href="${getTronScanUrl()}/#/contract/${legalContract.address}" 
                                       target="_blank" 
                                       class="btn btn-secondary" 
                                       style="margin-top: 0.5rem; display: inline-block;">
                                        <i class="fas fa-external-link-alt"></i> View on TronScan
                                    </a>
                                </div>
                            </div>
                            <div style="margin-top: 1rem; text-align: center;">
                                <button class="btn btn-primary" onclick="printReceipt(${noticeId})">
                                    <i class="fas fa-print"></i> Print Receipt
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error showing receipt:', error);
                uiManager.showNotification('error', 'Failed to load receipt');
            }
        }

        // Print receipt
        async function printReceipt(noticeId) {
            try {
                // Get receipt data from current modal or fetch fresh data
                let receiptData = null;
                
                // Try to get receipt data from currently displayed modal
                const currentModal = document.querySelector('.modal[style*="block"]');
                if (currentModal) {
                    const receiptContent = currentModal.querySelector('.modal-body');
                    if (receiptContent) {
                        // Extract data from displayed receipt
                        receiptData = extractReceiptDataFromModal(receiptContent, noticeId);
                    }
                }
                
                // If no modal data, generate basic receipt
                if (!receiptData) {
                    receiptData = await generateBasicReceiptData(noticeId);
                }
                
                // Create printable receipt window
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>Legal Notice Receipt - ${noticeId}</title>
                        <style>
                            @media print {
                                body { 
                                    font-family: 'Courier New', monospace; 
                                    padding: 0;
                                    margin: 0;
                                    font-size: 10pt;
                                    line-height: 1.3;
                                }
                                .no-print { display: none !important; }
                                .page-break { page-break-before: always; }
                                h1 { font-size: 16pt; text-align: center; margin-bottom: 20pt; }
                                h2 { font-size: 14pt; margin: 15pt 0 10pt 0; }
                                h3 { font-size: 12pt; margin: 10pt 0 5pt 0; }
                                table { 
                                    width: 100%; 
                                    border-collapse: collapse;
                                    page-break-inside: avoid;
                                    margin-bottom: 10pt;
                                }
                                td, th { 
                                    padding: 3pt 6pt; 
                                    vertical-align: top;
                                    border: 1pt solid #333;
                                }
                                th { 
                                    background: #f0f0f0; 
                                    font-weight: bold;
                                }
                                .info-box {
                                    border: 1pt solid #333;
                                    padding: 8pt;
                                    margin: 10pt 0;
                                    background: #f8f8f8;
                                }
                                .footer {
                                    position: fixed;
                                    bottom: 0.5in;
                                    left: 0;
                                    right: 0;
                                    text-align: center;
                                    font-size: 8pt;
                                    border-top: 1pt solid #333;
                                    padding-top: 5pt;
                                }
                            }
                            @media screen {
                                body { 
                                    font-family: 'Courier New', monospace; 
                                    padding: 20px;
                                    max-width: 800px;
                                    margin: 0 auto;
                                    background: white;
                                }
                                .print-btn {
                                    background: #3b82f6;
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    margin: 10px;
                                    cursor: pointer;
                                    border-radius: 4px;
                                }
                                .print-btn:hover { background: #2563eb; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="no-print">
                            <button class="print-btn" onclick="window.print()"> Print Receipt</button>
                            <button class="print-btn" onclick="window.close()"> Close</button>
                        </div>
                        
                        <h1>LEGAL NOTICE SERVICE RECEIPT</h1>
                        
                        <div class="info-box">
                            <table>
                                <tr>
                                    <th style="width: 30%;">Notice ID:</th>
                                    <td><strong>${noticeId}</strong></td>
                                </tr>
                                <tr>
                                    <th>Receipt Generated:</th>
                                    <td>${new Date().toLocaleString()}</td>
                                </tr>
                                <tr>
                                    <th>Generated By:</th>
                                    <td>${tronWeb?.defaultAddress?.base58 || 'Unknown'}</td>
                                </tr>
                                <tr>
                                    <th>Network:</th>
                                    <td>TRON ${tronWeb?.fullNode.host.includes('nile') ? 'Nile Testnet' : 'Mainnet'}</td>
                                </tr>
                                <tr>
                                    <th>Contract:</th>
                                    <td>${legalContract?.address || 'Unknown'}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <h2>SERVICE DETAILS</h2>
                        ${receiptData.serviceDetails}
                        
                        <h2>DELIVERY STATUS</h2>
                        ${receiptData.deliveryStatus}
                        
                        ${receiptData.acceptanceDetails ? `
                            <h2>ACCEPTANCE VERIFICATION</h2>
                            ${receiptData.acceptanceDetails}
                        ` : ''}
                        
                        ${receiptData.blockchainProof ? `
                            <h2>BLOCKCHAIN VERIFICATION</h2>
                            ${receiptData.blockchainProof}
                        ` : ''}
                        
                        <div class="footer">
                            Generated by NFT Legal Service - Blockchain Document Delivery System<br>
                            This receipt provides cryptographic proof of legal notice service and delivery.
                        </div>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                
                // Focus the new window and print
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                }, 500);
                
            } catch (error) {
                console.error('Error generating printable receipt:', error);
                uiManager.showNotification('error', 'Failed to generate printable receipt');
            }
        }
        
        // Helper function to extract receipt data from displayed modal
        function extractReceiptDataFromModal(modalContent, noticeId) {
            const serviceDetails = '<div class="info-box">Service details extracted from modal</div>';
            const deliveryStatus = '<div class="info-box">Delivery status from current display</div>';
            
            return {
                serviceDetails,
                deliveryStatus,
                acceptanceDetails: null,
                blockchainProof: null
            };
        }
        
        // Helper function to generate basic receipt data
        async function generateBasicReceiptData(noticeId) {
            try {
                // Try to get notice data from blockchain
                const alertData = await legalContract.alertNotices(noticeId).call();
                const documentData = await legalContract.documentNotices(noticeId).call();
                
                const serviceDetails = `
                    <div class="info-box">
                        <table>
                            <tr><th>Notice ID:</th><td>${noticeId}</td></tr>
                            <tr><th>Recipient:</th><td>${alertData[0] || 'Unknown'}</td></tr>
                            <tr><th>Process Server:</th><td>${alertData[1] || 'Unknown'}</td></tr>
                            <tr><th>Service Time:</th><td>${alertData[3] ? new Date(Number(alertData[3]) * 1000).toLocaleString() : 'Unknown'}</td></tr>
                            <tr><th>Document Hash:</th><td>${documentData[3] || 'No document attached'}</td></tr>
                        </table>
                    </div>
                `;
                
                const isAccepted = alertData[4] === true;
                const deliveryStatus = `
                    <div class="info-box">
                        <table>
                            <tr>
                                <th>Status:</th>
                                <td><strong style="color: ${isAccepted ? 'green' : 'orange'};">
                                    ${isAccepted ? 'ACCEPTED & SIGNED' : 'PENDING SIGNATURE'}
                                </strong></td>
                            </tr>
                            <tr><th>Blockchain Confirmed:</th><td>Yes</td></tr>
                            <tr><th>Service Method:</th><td>Digital Blockchain Delivery</td></tr>
                        </table>
                    </div>
                `;
                
                return {
                    serviceDetails,
                    deliveryStatus,
                    acceptanceDetails: isAccepted ? '<div class="info-box">Digital signature recorded on blockchain</div>' : null,
                    blockchainProof: `<div class="info-box">Notice stored on TRON blockchain at contract ${legalContract.address}</div>`
                };
            } catch (error) {
                console.error('Error getting blockchain data for receipt:', error);
                return {
                    serviceDetails: '<div class="info-box">Service details unavailable</div>',
                    deliveryStatus: '<div class="info-box">Status check failed - blockchain query error</div>',
                    acceptanceDetails: null,
                    blockchainProof: null
                };
            }
        }

        // Download document
        async function downloadDocument(documentId, documentData) {
            try {
                // Log download event
                await logDocumentView(documentId, 'download');
                // Handle both string and object inputs
                let data;
                if (typeof documentData === 'string') {
                    data = JSON.parse(documentData.replace(/&quot;/g, '"'));
                } else {
                    data = documentData;
                }
                
                if (data.type === 'image' && data.content) {
                    // Download image directly using the data URL
                    const a = document.createElement('a');
                    a.href = data.content;
                    a.download = `legal_document_${documentId}.${data.mimeType.split('/')[1] || 'png'}`;
                    a.click();
                    return;
                } else if (data.pdf || data.type === 'pdf') {
                    // Download as PDF
                    const byteCharacters = atob(data.pdf);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `legal_document_${documentId}.pdf`;
                    a.click();
                    URL.revokeObjectURL(url);
                    return;
                } else if (data.html) {
                    // Download as HTML
                    const blob = new Blob([data.html], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `legal_document_${documentId}.html`;
                    a.click();
                    URL.revokeObjectURL(url);
                } else if (data.content || data.type === 'text') {
                    // Download as text
                    const content = data.content || '';
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `legal_document_${documentId}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                } else {
                    throw new Error('Unknown document format');
                }
            } catch (error) {
                console.error('Error downloading document:', error);
                uiManager.showNotification('error', 'Failed to download document');
            }
        }

        // Print document
        function printDocument(documentId, documentData) {
            try {
                // Handle both string and object inputs
                let data;
                if (typeof documentData === 'string') {
                    data = JSON.parse(documentData.replace(/&quot;/g, '"'));
                } else {
                    data = documentData;
                }
                const printWindow = window.open('', '_blank');
                
                let printContent = '';
                if (data.type === 'image' && data.content) {
                    printContent = `<img src="${data.content}" style="max-width: 100%; height: auto;">`;
                } else if (data.pdf || data.type === 'pdf') {
                    printContent = '<p>PDF documents cannot be printed directly. Please download the document to print.</p>';
                } else if (data.html) {
                    printContent = data.html;
                } else if (data.content || data.type === 'text') {
                    printContent = '<pre>' + (data.content || 'No content available') + '</pre>';
                } else {
                    printContent = '<p>Document format not supported for printing.</p>';
                }
                
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Legal Document - Document #${documentId}</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 2rem; }
                                pre { white-space: pre-wrap; }
                                img { page-break-inside: avoid; }
                            </style>
                        </head>
                        <body>
                            <h2>Legal Document - Document #${documentId}</h2>
                            ${printContent}
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            } catch (error) {
                console.error('Error printing document:', error);
                uiManager.showNotification('error', 'Failed to print document');
            }
        }
        
        // Show accept modal
        async function showAcceptModal(noticeId) {
            try {
                // Get full notice details
                const alertData = await legalContract.alertNotices(noticeId).call();
                console.log('Loading notice for acceptance:', alertData);
                
                // Populate modal fields with actual data
                document.getElementById('acceptNoticeId').textContent = noticeId;
                document.getElementById('acceptDocumentType').textContent = alertData.noticeType || 'Legal Notice';
                document.getElementById('acceptJurisdiction').textContent = alertData.issuingAgency || 'Not specified';
                document.getElementById('acceptCaseNumber').textContent = alertData.caseNumber || 'Not provided';
                document.getElementById('acceptServer').textContent = alertData.sender ? 
                    `${alertData.sender.substring(0, 6)}...${alertData.sender.substring(alertData.sender.length - 4)}` : 
                    'Unknown';
                document.getElementById('acceptTimestamp').textContent = alertData.timestamp ? 
                    new Date(parseInt(alertData.timestamp) * 1000).toLocaleString() : 
                    'Unknown';
                
                // Show preview image if available
                const previewDiv = document.getElementById('acceptPreview');
                const previewImage = document.getElementById('acceptPreviewImage');
                if (alertData.previewImage && alertData.previewImage.length > 0) {
                    previewImage.src = alertData.previewImage;
                    previewDiv.style.display = 'block';
                } else {
                    previewDiv.style.display = 'none';
                }
                
                // Store notice ID globally for acceptance
                window.currentAcceptingNoticeId = noticeId;
                
                document.getElementById('acceptModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading notice for acceptance:', error);
                uiManager.showNotification('error', 'Failed to load notice details');
            }
        }
        
        // View notice details
        async function viewNoticeDetails(noticeId) {
            try {
                // Get full notice details
                const alertData = await legalContract.alertNotices(noticeId).call();
                console.log('Viewing notice details:', alertData);
                
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>${LanguageManager.translate('blockserved.legalNoticeDetails')} #${noticeId}</h3>
                            <button class="close-btn" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="notice-details-full">
                                ${alertData.issuingAgency ? `<p><strong>${LanguageManager.translate('blockserved.issuingAgency')}:</strong> ${alertData.issuingAgency}</p>` : ''}
                                ${alertData.noticeType ? `<p><strong>${LanguageManager.translate('blockserved.documentType')}:</strong> ${alertData.noticeType}</p>` : ''}
                                ${alertData.caseNumber ? `<p><strong>${LanguageManager.translate('blockserved.caseNumber')}:</strong> ${alertData.caseNumber}</p>` : ''}
                                ${alertData.caseDetails ? `
                                    <div class="alert alert-info" style="margin: 1rem 0;">
                                        <strong>${LanguageManager.translate('blockserved.caseDetails')}:</strong><br>
                                        ${alertData.caseDetails}
                                    </div>
                                ` : ''}
                                ${alertData.legalRights ? `
                                    <div class="alert alert-warning" style="margin: 1rem 0;">
                                        <strong>${LanguageManager.translate('blockserved.legalRights')}:</strong><br>
                                        ${alertData.legalRights}
                                    </div>
                                ` : ''}
                                ${alertData.responseDeadline ? `
                                    <p><strong>${LanguageManager.translate('blockserved.responseRequired')}:</strong> ${new Date(parseInt(alertData.responseDeadline) * 1000).toLocaleString()}</p>
                                ` : ''}
                                <p><strong>${LanguageManager.translate('blockserved.dateIssued')}:</strong> ${new Date(parseInt(alertData.timestamp) * 1000).toLocaleString()}</p>
                            </div>
                            <div style="margin-top: 1.5rem; text-align: center;">
                                ${!alertData.acknowledged ? `
                                    <button class="btn btn-primary" onclick="showAcceptModal(${noticeId}); this.closest('.modal').remove();">
                                        <i class="fas fa-check"></i> ${LanguageManager.translate('blockserved.acceptNotice')}
                                    </button>
                                ` : `
                                    <span class="badge badge-success">${LanguageManager.translate('blockserved.accepted')}</span>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error viewing notice details:', error);
                uiManager.showNotification('error', 'Failed to load notice details');
            }
        }
        
        // Contract resource check
        async function checkContractResources() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            try {
                const contractAddress = document.getElementById('contractAddress').value;
                const accountInfo = await tronWeb.trx.getAccount(contractAddress);
                
                const energyLimit = accountInfo.energy_limit || 0;
                const energy = accountInfo.energy || 0;
                const bandwidth = accountInfo.bandwidth || 0;
                
                const html = `
                    <div class="resource-info">
                        <h4>Contract Resources</h4>
                        <p>Energy: ${energy} / ${energyLimit}</p>
                        <p>Bandwidth: ${bandwidth}</p>
                    </div>
                `;
                
                showAlert('resourceStatus', 'info', html);
                
            } catch (error) {
                console.error('Error checking resources:', error);
                showAlert('resourceStatus', 'error', 'Failed to check resources');
            }
        }
        
        // Fee update functions
        async function updateServiceFee() {
            const newFee = document.getElementById('newServiceFee').value;
            if (!newFee || newFee <= 0) {
                uiManager.showNotification('error', 'Please enter a valid fee amount');
                return;
            }
            
            try {
                showProcessing('Updating service fee...');
                const feeInSun = tronWeb.toSun(newFee);
                
                await legalContract.updateServiceFee(feeInSun).send({
                    feeLimit: 50_000_000,
                    shouldPollResponse: true
                });
                
                hideProcessing();
                uiManager.showNotification('success', 'Service fee updated successfully');
                
            } catch (error) {
                hideProcessing();
                console.error('Error updating fee:', error);
                uiManager.showNotification('error', 'Failed: ' + getErrorMessage(error));
            }
        }
        
        // Withdraw from contract
        async function withdrawFromContract() {
            const amount = document.getElementById('withdrawAmount').value;
            if (!amount || amount <= 0) {
                uiManager.showNotification('error', 'Please enter a valid amount');
                return;
            }
            
            try {
                showProcessing('Withdrawing funds...');
                const amountInSun = tronWeb.toSun(amount);
                
                await legalContract.withdrawFees(amountInSun).send({
                    feeLimit: 50_000_000,
                    shouldPollResponse: true
                });
                
                hideProcessing();
                uiManager.showNotification('success', `Successfully withdrew ${amount} TRX`);
                document.getElementById('withdrawAmount').value = '';
                
            } catch (error) {
                hideProcessing();
                console.error('Withdrawal error:', error);
                uiManager.showNotification('error', 'Failed: ' + getErrorMessage(error));
            }
        }
        
        // Export registrations
        function exportRegistrations() {
            const registrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
            const dataStr = JSON.stringify(registrations, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `registrations_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // Toggle FAQ
        function toggleFAQ(element) {
            const content = element.nextElementSibling;
            const icon = element.querySelector('.faq-icon');
            
            if (content.style.display === 'block') {
                content.style.display = 'none';
                icon.textContent = '+';
            } else {
                content.style.display = 'block';
                icon.textContent = '-';
            }
        }
        
        // Open registration for user
        function openRegistrationForUser() {
            if (!isProcessServer) {
                openRegistrationModal();
            } else {
                uiManager.showNotification('info', 'You are already registered as a process server');
            }
        }

        
        // Add loading state to buttons
        function setButtonLoading(button, loading, originalText) {
            if (loading) {
                button.disabled = true;
                button.dataset.originalText = originalText || button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalText || originalText;
            }
        }
        
        // Update fee display with energy cost estimation
        async function updateFeeDisplay() {
            if (!legalContract || !tronWeb.defaultAddress) return;
            
            try {
                const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked')?.value || 'document';
                const baseFee = deliveryMethod === 'document' ? 150 : 15;
                const userAddress = tronWeb.defaultAddress.base58;
                
                // Check exemptions
                const isExempt = await legalContract.serviceFeeExemptions(userAddress).call();
                const finalBaseFee = isExempt ? 0 : baseFee;
                
                // Estimate energy costs if EnergyRental is available
                let energyCostEstimate = 0;
                let energyNote = '';
                
                if (window.EnergyRental) {
                    const hasDocument = deliveryMethod === 'document' && uploadedImage;
                    const estimatedEnergy = window.EnergyRental.estimateEnergyNeeded(hasDocument);
                    const currentEnergy = await window.EnergyRental.checkUserEnergy(userAddress);
                    
                    if (currentEnergy < estimatedEnergy) {
                        const energyNeeded = estimatedEnergy - currentEnergy;
                        energyCostEstimate = (energyNeeded * 420) / 1_000_000; // 420 SUN per energy
                        energyNote = ' (est. energy cost)';
                    }
                }
                
                // Update display elements
                document.getElementById('baseFeeDisplay').textContent = finalBaseFee + ' TRX';
                
                // Add energy cost to total if applicable
                const totalFee = finalBaseFee + 2 + energyCostEstimate;
                document.getElementById('totalFeeDisplay').textContent = totalFee.toFixed(2) + ' TRX';
                
                if (isExempt) {
                    document.getElementById('baseFeeDisplay').innerHTML += ' <span style="color: var(--success);">(Exempt)</span>';
                }
                
                if (energyCostEstimate > 0) {
                    document.getElementById('totalFeeDisplay').innerHTML += ` <span style="color: var(--warning); font-size: 0.875rem;">${energyNote}</span>`;
                }
                
                // Add energy cost line if needed
                const energyCostElement = document.getElementById('energyCostDisplay');
                if (energyCostElement) {
                    if (energyCostEstimate > 0) {
                        energyCostElement.textContent = energyCostEstimate.toFixed(2) + ' TRX';
                        energyCostElement.parentElement.style.display = 'flex';
                    } else {
                        energyCostElement.parentElement.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error updating fee display:', error);
            }
        }
        
        // Character counter for text notices
        function updateCharacterCount() {
            const textArea = document.getElementById('noticeText');
            const counter = document.getElementById('charCount');
            if (textArea && counter) {
                const length = textArea.value.length;
                counter.textContent = length;
                counter.style.color = length > 90 ? 'var(--error)' : length > 70 ? 'var(--warning)' : 'var(--text-secondary)';
            }
        }

        // Preview NFT function
        async function previewNFT() {
            try {
                // Gather form data
                const recipient = document.getElementById('mintRecipient').value;
                const caseNumber = document.getElementById('mintCaseNumber').value || 'Pending';
                const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked').value;
                
                if (!recipient) {
                    uiManager.showNotification('error', 'Please enter recipient address');
                    return;
                }
                
                // Get notice details
                const noticeDetails = {
                    noticeType: document.getElementById('noticeType').value === 'Custom' 
                        ? (document.getElementById('customNoticeType').value || 'Legal Notice')
                        : document.getElementById('noticeType').value,
                    caseNumber: caseNumber,
                    issuingAgency: document.getElementById('issuingAgency').value || 'Law Enforcement',
                    dateIssued: new Date().toLocaleDateString()
                };
                
                // Generate preview thumbnail
                let thumbnailPreview = null;
                if (deliveryMethod === 'document' && uploadedImage) {
                    showProcessing('Generating NFT preview...');
                    
                    if (window.ThumbnailGenerator) {
                        console.log('Generating NFT preview with uploadedImage:', {
                            hasData: !!uploadedImage.data,
                            hasPreview: !!uploadedImage.preview,
                            fileType: uploadedImage.fileType,
                            dataType: typeof uploadedImage.data === 'string' ? uploadedImage.data.substring(0, 30) : 'object',
                            uploadedImage: uploadedImage
                        });
                        
                        // Handle document data which might be an object with .data property
                        let documentData = uploadedImage.data;
                        if (documentData && typeof documentData === 'object' && documentData.data) {
                            console.log('Document data is object, extracting .data property');
                            documentData = documentData.data;
                        }
                        
                        const documentPreview = uploadedImage.preview || documentData;
                        console.log('Final data for thumbnail:', {
                            hasDocumentData: !!documentData,
                            documentDataType: typeof documentData === 'string' ? documentData.substring(0, 50) : typeof documentData,
                            hasDocumentPreview: !!documentPreview,
                            documentPreviewType: typeof documentPreview === 'string' ? documentPreview.substring(0, 50) : typeof documentPreview
                        });
                        
                        thumbnailPreview = await window.ThumbnailGenerator.generateSealedThumbnail(
                            documentData,
                            uploadedImage.fileType || 'document',
                            documentPreview
                        );
                    }
                    hideProcessing();
                }
                
                // Generate metadata
                const mockNoticeId = '12345'; // Example notice ID
                const metadata = window.ThumbnailGenerator ? 
                    window.ThumbnailGenerator.generateNFTMetadata(mockNoticeId, 'QmExampleHash', noticeDetails) :
                    { name: `Legal Notice #${mockNoticeId}`, description: 'Loading...' };
                
                // Show preview modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; background: var(--card-bg); color: var(--text-primary);">
                        <div class="modal-header">
                            <h2 style="color: var(--text-primary);">NFT Preview - What Recipients Will See</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                                <i class="fas fa-info-circle"></i>
                                This preview shows how the NFT will appear in the recipient's wallet
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                <!-- NFT Visual Preview -->
                                <div>
                                    <h3 style="margin-bottom: 1rem; color: var(--text-primary);">NFT Thumbnail</h3>
                                    <div style="background: var(--primary-dark); padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid var(--border-color);">
                                        ${thumbnailPreview ? 
                                            `<img src="${thumbnailPreview}" alt="NFT Preview" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">` :
                                            `<div style="height: 400px; display: flex; align-items: center; justify-content: center; background: var(--primary-darker); border-radius: 8px;">
                                                <div>
                                                    <i class="fas fa-file-alt" style="font-size: 4rem; color: var(--text-secondary); margin-bottom: 1rem;"></i>
                                                    <p style="color: var(--text-secondary);">Text-only notice (no thumbnail)</p>
                                                </div>
                                            </div>`
                                        }
                                    </div>
                                    
                                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid var(--accent-blue);">
                                        <h4 style="margin-bottom: 0.5rem; color: var(--accent-blue);">What Recipients See:</h4>
                                        <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-primary);">
                                            <li>Document preview with instruction banner</li>
                                            <li>Clear call-to-action to accept notice</li>
                                            <li>Professional legal document appearance</li>
                                            <li>No sensitive information visible</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <!-- NFT Metadata Preview -->
                                <div>
                                    <h3 style="margin-bottom: 1rem; color: var(--text-primary);">NFT Details</h3>
                                    <div style="background: var(--primary-dark); padding: 1.5rem; border-radius: 8px; max-height: 600px; overflow-y: auto; border: 1px solid var(--border-color);">
                                        <h4 style="margin-top: 0; color: var(--text-primary);">${metadata.name}</h4>
                                        
                                        <div style="margin: 1rem 0;">
                                            <strong style="color: var(--text-primary);">Description Preview:</strong>
                                            <div style="white-space: pre-wrap; font-size: 0.85rem; background: var(--primary-darker); color: var(--text-primary); padding: 1rem; border-radius: 4px; margin-top: 0.5rem; max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color);">
${metadata.description ? metadata.description.substring(0, 500) + '...' : 'Loading...'}
                                            </div>
                                        </div>
                                        
                                        <div style="margin-top: 1rem;">
                                            <strong style="color: var(--text-primary);">Attributes:</strong>
                                            <div style="display: grid; gap: 0.5rem; margin-top: 0.5rem;">
                                                ${metadata.attributes ? metadata.attributes.map(attr => `
                                                    <div style="background: var(--primary-darker); padding: 0.5rem; border-radius: 4px; display: flex; justify-content: space-between; border: 1px solid var(--border-color);">
                                                        <span style="color: var(--text-secondary);">${attr.trait_type}:</span>
                                                        <strong style="color: var(--text-primary);">${attr.value}</strong>
                                                    </div>
                                                `).join('') : 'Loading...'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(251, 191, 36, 0.1); border-radius: 8px; border: 1px solid var(--warning);">
                                <h4 style="margin-top: 0; color: var(--warning);"><i class="fas fa-lightbulb"></i> Process Server Tips</h4>
                                <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem; color: var(--text-primary);">
                                    <li>The NFT will automatically appear in the recipient's wallet</li>
                                    <li>Recipients see the thumbnail and can click through to accept</li>
                                    <li>The 2 TRX sponsorship covers their acceptance fees</li>
                                    <li>Once accepted, they'll receive the full decrypted document</li>
                                </ul>
                            </div>
                            
                            <div style="text-align: center; margin-top: 2rem;">
                                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                                    <i class="fas fa-times"></i> Close Preview
                                </button>
                                <button class="btn btn-primary" onclick="this.closest('.modal').remove(); createLegalNotice();">
                                    <i class="fas fa-rocket"></i> Proceed to Create Notice
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Preview error:', error);
                uiManager.showNotification('error', 'Error generating preview');
            }
        }
        
        // Create Legal Notice - Main function for minting NFTs
        async function createLegalNotice() {
            if (!legalContract || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet and contract first');
                return;
            }
            
            // Check if we're resuming a pending transaction
            let transactionData;
            if (window.isResumingTransaction && window.pendingTransactionData) {
                // Use pending transaction data
                transactionData = window.pendingTransactionData;
                window.pendingTransactionData = null;
            } else {
                // Get form values - use correct mint form IDs
                const recipient = document.getElementById('mintRecipient')?.value.trim() || '';
                const publicText = document.getElementById('noticeText')?.value.trim() || '';
                const noticeType = document.getElementById('noticeType')?.value || 'Legal Notice';
                const customType = document.getElementById('customNoticeType')?.value.trim() || '';
                const caseNumber = document.getElementById('mintCaseNumber')?.value.trim() || '';
                const issuingAgency = document.getElementById('issuingAgency')?.value.trim() || '';
                const tokenName = document.getElementById('mintTokenName')?.value.trim() || 'Legal Notice';
                const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked')?.value || 'document';
                
                // Validation with audit logging
                if (!recipient) {
                    const errorMsg = 'Please enter recipient address';
                    uiManager.showNotification('error', errorMsg);
                    if (window.auditLogger) {
                        window.auditLogger.logValidationError({
                            senderAddress: tronWeb.defaultAddress.base58,
                            field: 'recipient',
                            error: errorMsg,
                            errorCode: 'MISSING_RECIPIENT'
                        });
                    }
                    return;
                }
                
                if (!tronWeb.isAddress(recipient)) {
                    const errorMsg = 'Invalid recipient address';
                    uiManager.showNotification('error', errorMsg);
                    if (window.auditLogger) {
                        window.auditLogger.logValidationError({
                            senderAddress: tronWeb.defaultAddress.base58,
                            recipientAddress: recipient,
                            field: 'recipient',
                            value: recipient,
                            error: errorMsg,
                            errorCode: 'INVALID_ADDRESS'
                        });
                    }
                    return;
                }
                
                if (!publicText && deliveryMethod === 'text') {
                    const errorMsg = 'Please enter notice text';
                    uiManager.showNotification('error', errorMsg);
                    if (window.auditLogger) {
                        window.auditLogger.logValidationError({
                            senderAddress: tronWeb.defaultAddress.base58,
                            recipientAddress: recipient,
                            field: 'publicText',
                            error: errorMsg,
                            errorCode: 'MISSING_NOTICE_TEXT'
                        });
                    }
                    return;
                }
                
                if (deliveryMethod === 'document' && !uploadedImage) {
                    const errorMsg = 'Please upload a document';
                    uiManager.showNotification('error', errorMsg);
                    if (window.auditLogger) {
                        window.auditLogger.logValidationError({
                            senderAddress: tronWeb.defaultAddress.base58,
                            recipientAddress: recipient,
                            field: 'document',
                            error: errorMsg,
                            errorCode: 'MISSING_DOCUMENT'
                        });
                    }
                    return;
                }
                
                // Create transaction data object
                transactionData = {
                    recipient,
                    publicText,
                    noticeType,
                    customType,
                    caseNumber,
                    issuingAgency,
                    tokenName,
                    deliveryMethod,
                    hasDocument: deliveryMethod === 'document' && uploadedImage,
                    documentData: uploadedImage?.data,
                    documentPreview: uploadedImage?.preview,
                    senderAddress: tronWeb.defaultAddress.base58,
                    contractAddress: legalContract.address,
                    type: 'single'
                };
            }
            
            // Generate a temporary notice ID for the direct link (will be replaced with actual ID after minting)
            const tempNoticeId = Date.now().toString();
            
            // Define fee outside try block so it's available in catch
            let fee = 150000000; // Default fee (150 TRX)
            
            try {
                console.log('Starting createLegalNotice...');
                showProcessing('Creating legal notice...');
                
                // Log the attempt to audit system
                if (window.auditLogger) {
                    window.auditLogger.logNoticeAttempt({
                        senderAddress: tronWeb.defaultAddress.base58,
                        recipientAddress: transactionData.recipient,
                        noticeType: transactionData.noticeType === 'Custom' ? transactionData.customType : transactionData.noticeType,
                        caseNumber: transactionData.caseNumber,
                        hasDocument: transactionData.hasDocument,
                        deliveryMethod: transactionData.deliveryMethod,
                        documentHash: transactionData.hasDocument ? await window.documentConverter?.hashDocument(transactionData.documentData) : null,
                        sponsorshipAmount: 0, // Will be updated later
                        estimatedGas: 0 // Will be updated later
                    });
                }
                
                const submitButton = document.getElementById('createNoticeBtn');
                if (submitButton) {
                    setButtonLoading(submitButton, true);
                }
                
                // Calculate fee
                console.log('Calculating fee...');
                console.log('User address for fee calculation:', tronWeb.defaultAddress.base58);
                fee = await calculateFeeFromConstants(tronWeb.defaultAddress.base58);
                console.log('Fee calculated:', fee, 'sun =', fee/1000000, 'TRX');
                
                // Double-check the exemption status
                const doubleCheckExemption = await legalContract.serviceFeeExemptions(tronWeb.defaultAddress.base58).call();
                console.log('Double-check exemption status:', doubleCheckExemption);
                
                if (doubleCheckExemption && fee > 2000000) {
                    console.error('WARNING: User is exempt but fee is too high!');
                    console.error('Expected: 2 TRX, Got:', fee/1000000, 'TRX');
                }
                
                // Store fee globally for energy rental to check
                window._currentTransactionFee = fee;
                
                // Estimate energy needed
                showProcessing('Preparing transaction...');
                const hasDocument = transactionData.deliveryMethod === 'document' && uploadedImage;
                
                // Use enhanced energy rental if available, fallback to original
                let estimatedEnergy;
                let energyResult = { success: true };
                
                // IMPORTANT: Energy rental on TRON (via JustLend) provides energy resources
                // but the actual energy usage still appears as network fees in the transaction.
                // The rental reduces the TRX that would be burned for energy, but TronScan
                // still shows the full resource cost. The savings happen at the resource level,
                // not as a visible fee reduction in the transaction display.
                
                if (window.EnhancedEnergyRental) {
                    // Use enhanced version with better automation
                    estimatedEnergy = EnhancedEnergyRental.estimateEnergyNeeded({
                        hasDocument: hasDocument,
                        documentSize: uploadedImage?.data?.length || 0,
                        ipfsUpload: true
                    });
                    
                    try {
                        energyResult = await EnhancedEnergyRental.handleEnergyRental({
                            energyNeeded: estimatedEnergy,
                            userAddress: tronWeb.defaultAddress.base58,
                            showProgress: true,
                            autoApprove: false // Let user choose if automated fails
                        });
                    } catch (energyError) {
                        console.error('Enhanced energy rental error:', energyError);
                        energyResult = { 
                            success: false, 
                            rentalFailed: true,
                            message: 'Energy rental service unavailable',
                            error: energyError.message
                        };
                    }
                } else {
                    // Fallback to original energy rental
                    estimatedEnergy = EnergyRental.estimateEnergyNeeded(hasDocument);
                    
                    try {
                        energyResult = await EnergyRental.prepareEnergyForTransaction(
                            estimatedEnergy,
                            tronWeb.defaultAddress.base58
                        );
                    } catch (energyError) {
                        console.error('Energy rental error:', energyError);
                        energyResult = { 
                            success: false, 
                            rentalFailed: true,
                            message: 'Energy rental service unavailable'
                        };
                    }
                }
                
                // If energy rental failed, handle based on user choice
                if (!energyResult.success && (energyResult.rentalFailed || energyResult.userChoice)) {
                    hideProcessing();
                    
                    // Check if user already made a choice (enhanced version)
                    if (energyResult.userChoice === 'cancel') {
                        // User cancelled - save as pending
                        transactionData.fee = fee;
                        transactionData.estimatedEnergy = estimatedEnergy;
                        
                        // Show cancel confirmation
                        const saveAsPending = await PendingTransactions.showCancelConfirmation();
                        
                        if (saveAsPending) {
                            PendingTransactions.savePending(transactionData);
                        }
                        
                        if (submitButton) {
                            setButtonLoading(submitButton, false);
                        }
                        return;
                    } else if (energyResult.userChoice === 'manual') {
                        // User chose manual rental - save as pending
                        transactionData.fee = fee;
                        transactionData.estimatedEnergy = estimatedEnergy;
                        PendingTransactions.savePending(transactionData);
                        
                        uiManager.showNotification('info', 'Transaction saved. Complete energy rental and resume from Pending Transactions');
                        if (submitButton) {
                            setButtonLoading(submitButton, false);
                        }
                        return;
                    } else if (energyResult.userChoice === 'proceed') {
                        // User wants to proceed without rental (burn TRX)
                        console.warn('User proceeding without energy rental - will pay full energy costs');
                        showProcessing('Creating legal notice without energy rental...');
                        energyResult = { success: true, rentalNeeded: false };
                    } else {
                        // Fallback to original dialog for backward compatibility
                        const userWantsToProceed = await showEnergyRentalFailureDialog(energyResult);
                        
                        if (!userWantsToProceed) {
                            // User cancelled
                            if (submitButton) {
                                setButtonLoading(submitButton, false);
                            }
                            return;
                        }
                        
                        // User wants to proceed without rental
                        console.warn('User proceeding without energy rental - will pay full energy costs');
                        showProcessing('Creating legal notice without energy rental...');
                        energyResult = { success: true, rentalNeeded: false };
                    }
                }
                
                // Only show success notification for non-law enforcement users who saved money
                if (energyResult.savedTRX && fee > 2000000) {
                    uiManager.showNotification('success', `Saved ${energyResult.savedTRX.toFixed(2)} TRX by renting energy!`);
                } else if (energyResult.warning && fee > 2000000) {
                    // Only show warnings for non-law enforcement users
                    console.warn(energyResult.warning);
                }
                
                // If document delivery, encrypt the document first
                let encryptedData = null;
                if (transactionData.deliveryMethod === 'document' && uploadedImage) {
                    showProcessing('Encrypting document with recipient\'s address...');
                    
                    // Generate encryption key using sender and recipient addresses
                    const encryptionKey = SimpleEncryption.generateEncryptionKey(
                        tronWeb.defaultAddress.base58,
                        transactionData.recipient,
                        Date.now()
                    );
                    
                    // Compress document if it's too large
                    let documentDataToEncrypt = uploadedImage.data;
                    
                    // Handle document data which might be an object with .data property
                    if (documentDataToEncrypt && typeof documentDataToEncrypt === 'object' && documentDataToEncrypt.data) {
                        console.log('Extracting data from object for encryption');
                        documentDataToEncrypt = documentDataToEncrypt.data;
                    }
                    
                    // For PDFs that were converted to images, we need to compress them
                    if (uploadedImage.convertedType === 'image/png' || 
                        (typeof documentDataToEncrypt === 'string' && documentDataToEncrypt.length > 1000000)) {
                        showProcessing('Compressing document for blockchain storage...');
                        
                        // If we have a document converter, use its compression
                        if (window.documentConverter && window.documentConverter.compressImage) {
                            try {
                                console.log('Document data before compression:', {
                                    type: typeof documentDataToEncrypt,
                                    length: documentDataToEncrypt ? documentDataToEncrypt.length : 0,
                                    isObject: typeof documentDataToEncrypt === 'object',
                                    hasData: documentDataToEncrypt && documentDataToEncrypt.data ? 'yes' : 'no',
                                    preview: documentDataToEncrypt ? documentDataToEncrypt.substring ? documentDataToEncrypt.substring(0, 100) : 'object' : 'null'
                                });
                                // Increase maxSize for better quality but still manageable
                                documentDataToEncrypt = await window.documentConverter.compressImage(documentDataToEncrypt, 500000); // 500KB max
                            } catch (compressionError) {
                                console.error('Document compression failed:', compressionError);
                                // Use original document if compression fails
                                console.log('Using uncompressed document due to compression error');
                            }
                        }
                    }
                    
                    // Encrypt the document
                    const encryptedDoc = SimpleEncryption.encryptDocument(
                        documentDataToEncrypt,
                        encryptionKey
                    );
                    
                    // Upload to IPFS (or mock IPFS for now)
                    showProcessing('Uploading encrypted document to IPFS...');
                    let ipfsHash;
                    try {
                        ipfsHash = await SimpleEncryption.uploadToIPFS(encryptedDoc);
                        console.log('IPFS upload successful:', ipfsHash);
                    } catch (ipfsError) {
                        console.error('IPFS upload failed:', ipfsError);
                        throw new Error('Failed to upload document to IPFS: ' + ipfsError.message);
                    }
                    
                    // Generate NFT metadata with sealed thumbnail BEFORE the transaction
                    showProcessing('Creating document preview for NFT visibility...');
                    console.log('Using v5 ThumbnailGenerator to create document preview with instructions');
                    
                    let nftAssets;
                    try {
                        // Handle document data which might be an object
                        let documentDataForNFT = uploadedImage.data;
                        if (documentDataForNFT && typeof documentDataForNFT === 'object' && documentDataForNFT.data) {
                            documentDataForNFT = documentDataForNFT.data;
                        }
                        
                        nftAssets = await ThumbnailGenerator.processDocumentForNFT(
                            documentDataForNFT,
                            {
                                noticeType: transactionData.noticeType === 'Custom' ? transactionData.customType : transactionData.noticeType,
                                caseNumber: transactionData.caseNumber || 'Confidential',
                                issuingAgency: transactionData.issuingAgency || getCurrentUserAgency() || 'Process Server'
                            },
                            'pending' // Use placeholder ID for now
                        );
                        console.log('NFT assets generated:', nftAssets);
                    } catch (nftError) {
                        console.error('NFT generation failed:', nftError);
                        // Continue without NFT metadata rather than failing entirely
                        nftAssets = { success: false, error: nftError.message };
                    }
                    
                    encryptedData = {
                        ipfsHash: ipfsHash,
                        encryptionKey: encryptionKey,
                        metadataURI: nftAssets.success ? nftAssets.metadataURI : ''
                    };
                    
                    if (nftAssets.success) {
                        console.log('NFT metadata uploaded:', nftAssets.metadataURI);
                        console.log('Full NFT assets:', nftAssets);
                        // Test if metadata is accessible
                        if (nftAssets.metadataURI && nftAssets.metadataURI.startsWith('ipfs://')) {
                            const testUrl = nftAssets.metadataURI.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                            console.log('Testing metadata accessibility at:', testUrl);
                        }
                        uiManager.showNotification('info', 'Document encrypted and NFT metadata created');
                    } else {
                        uiManager.showNotification('info', 'Document encrypted (metadata generation failed)');
                    }
                }
                
                // For text-only notices, generate simple metadata
                let metadataURI = '';
                if (transactionData.deliveryMethod === 'text' || !encryptedData || !encryptedData.metadataURI) {
                    // Generate simple metadata for text notices
                    const textMetadata = {
                        name: `Legal Notice - ${transactionData.noticeType === 'Custom' ? transactionData.customType : transactionData.noticeType}`,
                        description: (transactionData.publicText || 'Legal notice requiring your attention') + '\n\nMore information and full document available at www.blockserved.com',
                        image: 'data:image/svg+xml;base64,' + btoa(`
                            <svg width="400" height="400" xmlns="http://www.w3.org/2000/svg">
                                <rect width="400" height="400" fill="#1a1a1a"/>
                                <text x="200" y="180" text-anchor="middle" fill="#fff" font-size="24" font-family="Arial">LEGAL NOTICE</text>
                                <text x="200" y="220" text-anchor="middle" fill="#888" font-size="16" font-family="Arial">${transactionData.noticeType === 'Custom' ? transactionData.customType : transactionData.noticeType}</text>
                            </svg>
                        `),
                        external_url: 'https://blockserved.com',
                        attributes: [
                            { trait_type: "Type", value: transactionData.noticeType === 'Custom' ? transactionData.customType : transactionData.noticeType },
                            { trait_type: "Agency", value: transactionData.issuingAgency || 'Process Server' }
                        ]
                    };
                    metadataURI = 'data:application/json;base64,' + btoa(JSON.stringify(textMetadata));
                } else {
                    metadataURI = encryptedData.metadataURI;
                }
                
                // Generate the access information for BlockServed
                // Recipients just need to go to blockserved.com and connect their wallet
                const directLink = `More information and full document available at www.blockserved.com`;
                
                // Update the UI to show the generated link
                const legalRightsField = document.getElementById('legalRights');
                if (legalRightsField) {
                    legalRightsField.value = directLink;
                }
                
                // Build notice request
                const noticeRequest = {
                    recipient: transactionData.recipient,
                    publicText: transactionData.publicText || '',
                    noticeType: transactionData.noticeType === 'Custom' ? transactionData.customType : transactionData.noticeType,
                    caseNumber: transactionData.caseNumber || '',
                    issuingAgency: transactionData.issuingAgency || '',
                    baseTokenName: transactionData.tokenName || 'Legal Notice',
                    hasDocument: transactionData.deliveryMethod === 'document',
                    encryptedIPFS: encryptedData ? encryptedData.ipfsHash : '',
                    encryptionKey: encryptedData ? encryptedData.encryptionKey : '',  // Fixed: was encryptedKey
                    metadataURI: metadataURI,  // Always provide metadata URI for NFT visibility
                    directLink: directLink  // Store for later use
                };
                
                // Send transaction - TronWeb might need the struct as an array
                console.log('Sending notice request:', noticeRequest);
                console.log('Contract address:', legalContract.address);
                console.log('Sender address:', tronWeb.defaultAddress.base58);
                console.log('Fee being sent:', fee, 'sun =', fee/1000000, 'TRX');
                console.log('MetadataURI being sent:', noticeRequest.metadataURI);
                console.log('MetadataURI length:', noticeRequest.metadataURI ? noticeRequest.metadataURI.length : 0);
                
                // Check if user is law enforcement
                const isLawEnforcement = await legalContract.serviceFeeExemptions(tronWeb.defaultAddress.base58).call();
                console.log('User law enforcement status:', isLawEnforcement);
                
                // Define sponsorship amount (typically 2 TRX for recipient support)
                const sponsorshipAmount = 2000000; // 2 TRX in sun
                
                if (isLawEnforcement && fee <= 2000000) {
                    console.warn('Law enforcement user - only paying sponsorship fee.');
                    console.warn('Energy costs will be additional on testnet!');
                }
                
                // Energy rental already handled above, proceed with transaction
                
                // Show confirmation modal before transaction
                const totalCostTRX = (fee / 1000000).toFixed(2);
                const confirmed = await showTransactionConfirmation('serveNotice', {
                    recipient: transactionData.recipient,
                    noticeType: transactionData.noticeType === 'Custom' ? transactionData.customType : transactionData.noticeType,
                    caseNumber: transactionData.caseNumber,
                    sponsorshipAmount: sponsorshipAmount / 1000000, // Convert to TRX for display
                    totalCost: totalCostTRX,
                    isPublicNotice: transactionData.deliveryMethod === 'text',
                    network: getCurrentNetwork()
                });
                
                if (!confirmed) {
                    hideProcessing();
                    return;
                }
                
                showProcessing('Sending transaction...');
                
                // Complete contract uses serveNotice with different parameters
                // serveNotice(recipient, encryptedIPFS, decryptionKey, issuingAgency, noticeType, caseNumber, caseDetails, legalRights, sponsorFees)
                const sponsorFees = fee > serviceFee; // Sponsor fees if paying more than just service fee
                
                console.log('=== TRANSACTION DETAILS ===');
                console.log('Fee being sent to contract:', fee, 'sun =', fee/1000000, 'TRX');
                console.log('Is law enforcement exempt?:', isLawEnforcement);
                console.log('Expected fee for exempt user: 2 TRX');
                console.log('Actual fee being charged:', fee/1000000, 'TRX');
                
                if (isLawEnforcement && fee > 2000000) {
                    console.error('CRITICAL: Overcharging exempt user!');
                    const shouldProceed = confirm(`WARNING: You are being charged ${fee/1000000} TRX instead of 2 TRX (law enforcement rate). Continue anyway?`);
                    if (!shouldProceed) {
                        hideProcessing();
                        return;
                    }
                }
                
                const tx = await legalContract.serveNotice(
                    noticeRequest.recipient,
                    noticeRequest.encryptedIPFS || '',
                    noticeRequest.encryptionKey || '',
                    noticeRequest.issuingAgency || '',
                    noticeRequest.noticeType || '',
                    noticeRequest.caseNumber || '',
                    noticeRequest.publicText || '', // Use publicText as caseDetails
                    noticeRequest.directLink || '', // Use the generated direct link
                    sponsorFees,
                    noticeRequest.metadataURI || '' // Add metadataURI parameter for NFT visibility
                ).send({
                    feeLimit: 300_000_000,  // Increased for larger documents
                    callValue: fee,
                    shouldPollResponse: true
                });
                
                console.log('Raw transaction result:', tx);
                
                // Extract transaction hash - TronLink may return it differently
                let txHash = null;
                let contractReturnedNFTs = false;
                let alertId = null;
                let documentId = null;
                
                if (tx && typeof tx === 'string') {
                    txHash = tx;
                } else if (tx && tx.txid) {
                    txHash = tx.txid;
                } else if (tx && tx.hash) {
                    txHash = tx.hash;
                } else if (tx && tx.transaction && tx.transaction.txID) {
                    txHash = tx.transaction.txID;
                } else if (Array.isArray(tx)) {
                    // Contract successfully returned the NFT IDs
                    console.log('Contract successfully returned NFT IDs:', tx);
                    contractReturnedNFTs = true;
                    
                    // Extract NFT IDs from the array
                    if (tx.length >= 2) {
                        alertId = tx[0]?.toString() || null;
                        documentId = tx[1]?.toString() || null;
                        console.log('Extracted NFT IDs - Alert:', alertId, 'Document:', documentId);
                    }
                    
                    // Try to get the last transaction from TronLink
                    try {
                        // Try to get transaction hash from recent transactions
                        const account = await tronWeb.trx.getAccount(tronWeb.defaultAddress.base58);
                        console.log('Looking for recent transaction hash...');
                        
                        // Mark as successful even without retrieving the exact hash
                        txHash = 'success_nfts_' + (alertId || Date.now());
                    } catch (e) {
                        console.log('Could not retrieve transaction hash');
                    }
                }
                
                console.log('Transaction hash:', txHash);
                
                // Wait for transaction confirmation
                if (txHash) {
                    console.log('Waiting for transaction confirmation...');
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    try {
                        const txInfo = await tronWeb.trx.getTransactionInfo(txHash);
                        console.log('Transaction info:', txInfo);
                        
                        if (txInfo && txInfo.receipt) {
                            console.log('Transaction receipt:', txInfo.receipt);
                            if (txInfo.receipt.result && txInfo.receipt.result !== 'SUCCESS') {
                                console.error('Transaction failed:', txInfo.receipt);
                            }
                        }
                    } catch (e) {
                        console.log('Could not get transaction info:', e);
                    }
                }
                
                // Get the returned values from the contract call
                let result = null;
                if (tx && tx.constant_result && tx.constant_result.length > 0) {
                    // Decode the result
                    result = tx.constant_result;
                } else if (tx && typeof tx === 'object') {
                    // Look for the transaction result
                    result = tx;
                }
                
                console.log('Contract call result:', result);
                
                // Handle result from serveNotice - returns [alertId, documentId]
                let noticeId = null;
                
                // Check if we already extracted IDs from array result
                if (!alertId && !documentId) {
                    // For contract calls with return values, they come through events
                    // Since we don't have events, we need to parse from logs or use a workaround
                    // The Complete contract doesn't emit events for the IDs
                    
                    // For now, generate IDs based on timestamp
                    // This is a limitation of the Complete contract
                    const timestamp = Date.now();
                    alertId = Math.floor(timestamp / 1000).toString();
                    documentId = (Math.floor(timestamp / 1000) + 1).toString();
                }
                
                // Set noticeId from documentId
                noticeId = documentId || alertId;
                
                console.log('Generated Alert ID:', alertId);
                console.log('Generated Document ID:', documentId);
                console.log('Note: Complete contract does not return token IDs in a way we can capture');
                
                // The link doesn't need updating since it's always the same
                // Recipients connect their wallet at blockserved.com to see their notices
                
                // Verify the NFT was minted
                if (noticeId) {
                    try {
                        console.log('Verifying NFT ownership for notice ID:', noticeId);
                        
                        // Wait a bit for blockchain to update
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        // Check if NFT exists
                        try {
                            const owner = await legalContract.ownerOf(noticeId).call();
                            console.log('NFT owner:', owner);
                            console.log('Expected recipient:', recipient);
                            
                            if (owner.toLowerCase() !== recipient.toLowerCase()) {
                                console.error('NFT was not minted to the expected recipient!');
                                console.error('Owner:', owner, 'Expected:', recipient);
                            } else {
                                console.log(' NFT successfully minted to recipient');
                            }
                        } catch (ownerError) {
                            console.error('Error getting owner - NFT may not exist:', ownerError);
                        }
                        
                        // Check contract's token tracking
                        try {
                            const totalSupply = 0 // Complete contract doesn't have totalSupply;
                            console.log('Contract total supply:', totalSupply.toString());
                        } catch (e) {
                            console.log('No totalSupply function');
                        }
                        
                        // Check recipient's balance
                        try {
                            const recipientBalance = await legalContract.balanceOf(transactionData.recipient).call();
                            console.log('Recipient NFT balance:', recipientBalance.toString());
                            
                            // Try to enumerate tokens
                            if (recipientBalance > 0) {
                                for (let i = 0; i < recipientBalance; i++) {
                                    // tokenOfOwnerByIndex not available
                                    console.log('Token enumeration not available. Use getRecipientAlerts() instead.');
                                    break;
                                }
                            }
                        } catch (e) {
                            console.error('Error checking balance:', e);
                        }
                        
                        // Check if contract implements supportsInterface
                        try {
                            const supportsTRC721 = await legalContract.supportsInterface('0x80ac58cd').call();
                            console.log('Contract supports TRC721:', supportsTRC721);
                        } catch (e) {
                            console.log('No supportsInterface function');
                        }
                        
                        // Try to get token URI
                        try {
                            const tokenURI = await legalContract.tokenURI(noticeId).call();
                            console.log('Token URI retrieved from contract:', tokenURI);
                            if (!tokenURI) {
                                console.error('WARNING: Token URI is empty! NFT will not display metadata in wallets.');
                                console.log('Expected URI was:', noticeRequest.metadataURI);
                            } else if (tokenURI.startsWith('ipfs://')) {
                                const httpUrl = tokenURI.replace('ipfs://', 'https://gateway.pinata.cloud/ipfs/');
                                console.log('IPFS metadata URL:', httpUrl);
                                // Try to fetch metadata to verify it's accessible
                                try {
                                    const metadataResponse = await fetch(httpUrl);
                                    if (metadataResponse.ok) {
                                        const metadata = await metadataResponse.json();
                                        console.log('NFT Metadata successfully retrieved:', metadata);
                                    } else {
                                        console.error('Failed to fetch NFT metadata:', metadataResponse.status);
                                    }
                                } catch (fetchError) {
                                    console.error('Error fetching NFT metadata:', fetchError);
                                }
                            }
                        } catch (e) {
                            console.log('Error getting token URI:', e.message);
                        }
                    } catch (e) {
                        console.error('Error verifying NFT:', e);
                    }
                }
                
                hideProcessing();
                
                // Update backend with the new notice
                await updateBackendAfterNoticeCreation({
                    noticeId: noticeId,
                    alertId: alertId,
                    documentId: documentId,
                    serverAddress: tronWeb.defaultAddress.base58,
                    recipientAddress: transactionData.recipient,
                    noticeType: transactionData.noticeType === 'Custom' ? transactionData.customType : transactionData.noticeType,
                    issuingAgency: transactionData.issuingAgency || getCurrentUserAgency(),
                    caseNumber: transactionData.caseNumber,
                    documentHash: transactionData.documentHash || '',
                    ipfsHash: transactionData.encryptedIPFS || '',
                    hasDocument: transactionData.deliveryMethod === 'document'
                });
                
                // Generate and update NFT metadata with sealed thumbnail
                if (noticeId && transactionData.deliveryMethod === 'document' && uploadedImage) {
                    try {
                        console.log('Generating NFT metadata with document preview (v5)...');
                        showProcessing('Creating document preview for wallet visibility...');
                        
                        // Handle document data which might be an object
                        let documentDataForNFT = uploadedImage.data;
                        if (documentDataForNFT && typeof documentDataForNFT === 'object' && documentDataForNFT.data) {
                            documentDataForNFT = documentDataForNFT.data;
                        }
                        
                        const nftAssets = await ThumbnailGenerator.processDocumentForNFT(
                            documentDataForNFT,
                            {
                                noticeType: transactionData.noticeType === 'Custom' ? transactionData.customType : transactionData.noticeType,
                                caseNumber: transactionData.caseNumber || 'Confidential',
                                issuingAgency: transactionData.issuingAgency || getCurrentUserAgency() || 'Process Server'
                            },
                            noticeId // Now we have the actual notice ID
                        );
                        
                        if (nftAssets.success) {
                            console.log('NFT metadata with thumbnail uploaded to IPFS:', nftAssets.metadataHash);
                            console.log('Metadata URI:', nftAssets.metadataURI);
                            
                            // Note: With current contract, we can't update the tokenURI after minting
                            // This would require a new contract deployment
                            // For now, the thumbnail is prepared for future use
                            
                            uiManager.showNotification('success', 'Sealed preview generated for NFT');
                        }
                        
                        hideProcessing();
                    } catch (metadataError) {
                        console.error('Error generating NFT metadata:', metadataError);
                        // Continue anyway - the notice was created
                    }
                }
                
                // Multi-strategy notification approach
                if (noticeId) {
                    console.log('=== NOTIFICATION STRATEGIES ===');
                    
                    // Strategy 1: Send TRX with memo (even though not visible in most wallets)
                    try {
                        console.log('1. Sending TRX with memo...');
                        const notificationTx = await tronWeb.trx.sendTransaction(
                            transactionData.recipient,
                            3500000, // 3.5 TRX (~$1 USD at ~$0.30/TRX, well above TronScan's $0.50 filter)
                            {
                                memo: `LEGAL NOTICE #${noticeId} - View at www.blockserved.com`
                            }
                        );
                        console.log('    TRX sent:', notificationTx);
                    } catch (e) {
                        console.error('    TRX failed:', e.message);
                    }
                    
                    // Strategy 2: Create a TRC20 token transfer comment (if we had a token)
                    console.log('2. TRC20 token notification: Not implemented (would require deploying notification token)');
                    
                    // Strategy 3: Direct NFT transfer attempt (already done above)
                    console.log('3. NFT minted to recipient wallet: Notice ID #' + noticeId);
                    
                    // Strategy 4: Log the access information for process server to share
                    console.log('\n=== BLOCKCHAIN SERVICE COMPLETE ===');
                    console.log('Recipient access: www.blockserved.com');
                    console.log('\nService Status:');
                    console.log(' NFT minted to wallet address');
                    console.log(' 3.5 TRX sent for transaction visibility');
                    console.log(' Memo contains notice information');
                    console.log(' Immutable proof of service on blockchain');
                    console.log('\nThe recipient has been served via blockchain.');
                    console.log('Transaction and NFT constitute legal proof of service attempt.');
                    console.log('===================================\n');
                }
                
                // Log success to audit system
                if (window.auditLogger) {
                    window.auditLogger.logNoticeSuccess({
                        senderAddress: tronWeb.defaultAddress.base58,
                        recipientAddress: transactionData.recipient,
                        noticeType: transactionData.noticeType === 'Custom' ? transactionData.customType : transactionData.noticeType,
                        caseNumber: transactionData.caseNumber,
                        transactionHash: txHash,
                        gasUsed: 0, // Will be updated when we get actual gas usage
                        feePaid: fee,
                        documentHash: transactionData.hasDocument ? await window.documentConverter?.hashDocument(transactionData.documentData) : null,
                        ipfsHash: encryptedData ? encryptedData.ipfsHash : null,
                        noticeId: noticeId,
                        alertId: alertId,
                        blockNumber: null, // Can be added if needed
                        confirmationTime: Date.now()
                    });
                }
                
                // Show success with proper receipt
                showTransactionResult(true, {
                    txHash: txHash || 'Transaction confirmed',
                    noticeId: noticeId,
                    alertId: alertId,
                    documentId: documentId,
                    recipient: transactionData.recipient,
                    feePaid: parseInt(fee) / 1000000,
                    energyUsed: 0, // Will be updated when we get actual energy usage
                    ipfsHash: encryptedData ? encryptedData.ipfsHash : null,
                    encryptionMethod: 'AES-256 with recipient wallet',
                    energyRentalTxId: energyResult.rentalTxId || null,
                    energyResult: energyResult // Pass the full energy result for detailed breakdown
                });
                
                // Track energy return for cost savings (if rental was used)
                if (energyResult.rentalNeeded && energyResult.txId) {
                    setTimeout(async () => {
                        const returnResult = await EnergyRental.returnRentedEnergy(energyResult.txId);
                        if (returnResult.success) {
                            console.log('Energy rental tracked for immediate return:', returnResult);
                            if (returnResult.costSaved > 0) {
                                uiManager.showNotification('success', 
                                    `Additional savings: ${returnResult.costSaved.toFixed(2)} TRX from quick energy return!`
                                );
                            }
                        }
                    }, 1000); // Check 1 second after transaction
                }
                
                // Log TronScan links for debugging
                console.log('=== VIEW ON TRONSCAN ===');
                console.log(`View transaction: ${getTxScanUrl()}${txHash || 'Check console for tx hash'}`);
                console.log(`View contract: ${getContractScanUrl()}`);
                console.log(`View Alert NFT: ${getContractScanUrl().replace('/contract/', '/token721/')}#id=${alertId}`);
                console.log(`View Document NFT: ${getContractScanUrl().replace('/contract/', '/token721/')}#id=${documentId}`);
                console.log('========================');

                // Save transaction for analytics
                const txData = {
                    txid: txHash || 'N/A',
                    noticeId: noticeId,
                    recipient: transactionData.recipient,
                    sender: tronWeb.defaultAddress.base58,
                    noticeType: noticeRequest.noticeType,
                    fee: parseInt(fee) / 1000000,
                    timestamp: Date.now()
                };
                
                const transactions = JSON.parse(localStorage.getItem('userTransactions') || '[]');
                transactions.push(txData);
                localStorage.setItem('userTransactions', JSON.stringify(transactions));
                
                // Clear blockchain cache to force refresh on next query
                const cacheKey = `blockchain_notices_${tronWeb.defaultAddress.base58}`;
                localStorage.removeItem(cacheKey);
                
                // Still save to localStorage as backup (but blockchain is primary source)
                const servedNoticeData = {
                    noticeId: noticeId,
                    recipient: transactionData.recipient,
                    noticeType: noticeRequest.noticeType || 'Legal Notice',
                    caseNumber: noticeRequest.caseNumber || '',
                    timestamp: Date.now(),
                    txHash: txHash || 'N/A',
                    hasDocument: !!uploadedImage,
                    documentId: documentId || null,
                    alertId: alertId || null
                };
                
                const servedNotices = JSON.parse(localStorage.getItem('servedNotices') || '{}');
                if (!servedNotices[tronWeb.defaultAddress.base58]) {
                    servedNotices[tronWeb.defaultAddress.base58] = [];
                }
                servedNotices[tronWeb.defaultAddress.base58].push(servedNoticeData);
                localStorage.setItem('servedNotices', JSON.stringify(servedNotices));
                
                // Wait a bit for blockchain to confirm, then update stats
                setTimeout(() => {
                    updateServerStats();
                    
                    // Refresh recent activities if on home tab
                    if (document.getElementById('homeTab').style.display !== 'none') {
                        refreshRecentActivitiesHybrid();
                    }
                }, 2000); // 2 second delay for blockchain confirmation

                
                // Clear form
                clearNoticeForm();
                
            } catch (error) {
                hideProcessing();
                console.error('Error creating notice:', error);
                
                // Log failure to audit system
                if (window.auditLogger) {
                    window.auditLogger.logNoticeFailure({
                        senderAddress: tronWeb.defaultAddress.base58,
                        recipientAddress: transactionData.recipient,
                        noticeType: transactionData.noticeType === 'Custom' ? transactionData.customType : transactionData.noticeType,
                        caseNumber: transactionData.caseNumber,
                        error: error.message || error.toString(),
                        stage: 'transaction_execution',
                        hasDocument: transactionData.hasDocument,
                        deliveryMethod: transactionData.deliveryMethod,
                        attemptedAt: Date.now(),
                        stackTrace: error.stack
                    });
                }
                
                // Show error in transaction result modal
                showTransactionResult(false, {
                    error: error,
                    errorMessage: getErrorMessage(error),
                    recipient: transactionData.recipient,
                    noticeType: transactionData.noticeType === 'Custom' ? transactionData.customType : transactionData.noticeType,
                    estimatedFee: parseInt(fee) / 1000000,
                    timestamp: Date.now()
                });
                
                // Special handling for quota errors
                if (error.name === 'QuotaExceededError' || (error.message && error.message.includes('quota'))) {
                    console.error('=== STORAGE QUOTA EXCEEDED ===');
                    console.error('To fix this issue, please run the following command in the console:');
                    console.error('clearAllStorage()');
                    console.error('Then refresh the page with Ctrl+F5 (or Cmd+Shift+R on Mac)');
                    console.error('==============================');
                }
            } finally {
                // Always reset button state
                const submitButton = document.getElementById('createNoticeBtn');
                if (submitButton) {
                    setButtonLoading(submitButton, false);
                }
            }
        }
        
        // Clear notice form
        function clearNoticeForm() {
            const recipientEl = document.getElementById('mintRecipient');
            const noticeTextEl = document.getElementById('noticeText');
            const caseNumberEl = document.getElementById('mintCaseNumber');
            const agencyNameEl = document.getElementById('agencyName');
            const tokenNameEl = document.getElementById('mintTokenName');
            
            if (recipientEl) recipientEl.value = '';
            if (noticeTextEl) noticeTextEl.value = '';
            if (caseNumberEl) caseNumberEl.value = '';
            if (agencyNameEl) agencyNameEl.value = '';
            if (tokenNameEl) tokenNameEl.value = '';
            uploadedImage = null;
            
            // Reset file upload
            const uploadResult = document.getElementById('uploadResult');
            if (uploadResult) {
                uploadResult.style.display = 'none';
            }
        }
        
        // Show transaction result (renamed to avoid conflict with the better version)
        function showTransactionResultOld(result) {
            const modal = document.getElementById('transactionResultModal');
            const txDetails = document.getElementById('txDetails');
            const txLink = document.getElementById('txLink');
            const txHash = document.getElementById('txHash');
            
            if (result.success) {
                let details = `
                    <div class="token-detail">
                        <span>Status:</span>
                        <span class="success-text"> Success</span>
                    </div>
                `;
                
                if (result.noticeId) {
                    details += `
                        <div class="token-detail">
                            <span>Notice ID:</span>
                            <span>#${result.noticeId}</span>
                        </div>
                    `;
                }
                
                if (result.recipient) {
                    details += `
                        <div class="token-detail">
                            <span>Recipient:</span>
                            <span>${formatAddress(result.recipient)}</span>
                        </div>
                    `;
                }
                
                if (result.ipfsData) {
                    details += `
                        <div class="token-detail">
                            <span>Document:</span>
                            <span>Encrypted on IPFS</span>
                        </div>
                    `;
                }
                
                txDetails.innerHTML = details;
                txHash.textContent = result.txHash;
                
                // Set TronScan link
                const network = document.getElementById('networkName').textContent;
                let tronscanUrl = 'https://tronscan.org/#/transaction/';
                if (network.includes('Nile')) {
                    tronscanUrl = 'https://nile.tronscan.org/#/transaction/';
                }
                txLink.href = tronscanUrl + result.txHash;
                
                modal.style.display = 'block';
            }
        }
</script>
</body>
</html>