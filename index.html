<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LegalNotice - Blockchain Legal Document Service</title>
    <meta name="description" content="Secure multi-chain blockchain legal document service supporting TRON, Ethereum, Polygon, and BSC">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pica/9.0.1/pica.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@4.3.0/dist/web3.min.js"></script>
    <!-- Document conversion libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/documentConverter.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-dark: #0a0a0a;
            --primary-navy: #111111;
            --secondary-navy: #1a1a1a;
            --accent-blue: #0ea5e9;
            --accent-light: #38bdf8;
            --text-primary: #ffffff;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --border-color: #262626;
            --card-bg: #141414;
            --hover-bg: #1f1f1f;
            --alert-color: #0ea5e9;
            --gray-800: #1f2937;
            --gray-700: #374151;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--primary-dark);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* Loader */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-navy) 0%, var(--secondary-navy) 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .logo:hover {
            transform: translateY(-1px);
        }

        .logo i {
            font-size: 2rem;
            color: var(--accent-blue);
            animation: pulse 2s infinite;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .contract-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.75rem;
            position: relative;
            overflow: hidden;
        }
        
        .contract-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(14, 165, 233, 0.2), transparent);
            animation: shimmer 3s infinite;
        }
        
        .contract-indicator span:first-child {
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .contract-indicator span:nth-child(2) {
            color: var(--accent-light);
            font-family: monospace;
        }
        
        .btn-icon {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
        }
        
        .btn-icon:hover {
            color: var(--accent-blue);
            background: rgba(14, 165, 233, 0.1);
        }
        
        .btn-icon-small {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.125rem 0.25rem;
            font-size: 0.875rem;
            transition: color 0.3s ease;
            margin-left: 0.25rem;
        }
        
        .btn-icon-small:hover {
            color: var(--accent-blue);
        }
        
        .address-display {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .address-text {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }

        .chain-selector {
            margin-right: 1rem;
        }

        .chain-dropdown {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chain-dropdown:hover {
            border-color: var(--accent-blue);
        }

        .chain-dropdown:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .chain-dropdown optgroup {
            background: var(--primary-navy);
            color: var(--text-secondary);
            font-weight: 600;
        }

        .chain-dropdown option {
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 0.5rem;
        }

        .network-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            color: var(--accent-light);
            font-size: 0.75rem;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .network-indicator.connected {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .network-indicator.connected i {
            color: var(--success);
        }

        .wallet-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .wallet-address {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .main-container {
            margin-top: 80px;
            padding: 2rem;
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
            animation: fadeIn 0.5s ease;
        }

        /* Welcome Section */
        .welcome-section {
            text-align: center;
            padding: 3rem 0;
            margin-bottom: 2rem;
            animation: slideIn 0.5s ease;
        }

        .welcome-section h2 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-section p {
            font-size: 1.125rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Stats Section */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-light));
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .stat-card:hover::before {
            transform: translateX(0);
        }

        .stat-card i {
            font-size: 2rem;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .tab-navigation {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            font-size: 0.938rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-button:hover {
            color: var(--text-primary);
        }

        .tab-button.active {
            color: var(--accent-blue);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-blue);
            animation: slideIn 0.3s ease;
        }

        .tab-button .badge {
            background: var(--accent-blue);
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            margin-left: 0.5rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(14, 165, 233, 0.1), transparent);
            transition: all 0.5s ease;
            transform: translate(-50%, -50%);
        }

        .card:hover::before {
            width: 100%;
            height: 100%;
        }

        .card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(14, 165, 233, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-header i {
            font-size: 1.25rem;
            color: var(--accent-blue);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1.5rem;
        }

        .action-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(14, 165, 233, 0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
            transform: rotate(45deg);
        }

        .action-card:hover::before {
            opacity: 1;
        }

        .action-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-blue);
            box-shadow: 0 12px 32px rgba(59, 130, 246, 0.2);
        }

        .action-card.primary {
            border-color: var(--accent-blue);
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(59, 130, 246, 0.1) 100%);
        }

        .action-card i {
            font-size: 3rem;
            color: var(--accent-blue);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .action-card:hover i {
            transform: scale(1.1);
        }

        .action-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .action-card p {
            color: var(--text-secondary);
            font-size: 0.938rem;
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-navy);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--hover-bg);
            border-color: var(--accent-blue);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--primary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.2s ease;
	    pointer-events: auto !important;
            user-select: text !important;
            -webkit-user-select: text !important;
        }
/* Specifically target admin panel inputs */
#adminTab .form-input {
    pointer-events: auto !important;
    user-select: text !important;
    -webkit-user-select: text !important;
    cursor: text !important;
}

/* Ensure inputs are not disabled by parent elements */
#adminContent * {
    pointer-events: auto !important;
}

/* Fix for any potential z-index issues */
#adminTab .card {
    position: relative;
    z-index: 1;
}

#adminTab .form-input {
    position: relative;
    z-index: 2;
}
        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            color: var(--text-primary);
        }

        /* Custom checkbox */
        input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background: var(--primary-dark);
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        input[type="checkbox"]:checked {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        input[type="checkbox"]:checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .status-complete {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .token-list {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .token-item {
            padding: 1rem;
            background: var(--primary-dark);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .token-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
            animation: scan 3s infinite;
        }

        .token-item:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .token-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .token-details {
            display: grid;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .token-detail {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
        }

        .token-preview {
            margin-top: 1rem;
            text-align: center;
        }

        .token-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }

        .token-preview img:hover {
            transform: scale(1.05);
        }

        .notification-banner {
            background: rgba(14, 165, 233, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideIn 0.5s ease;
        }

        .notification-banner i {
            color: var(--accent-blue);
            font-size: 1.25rem;
            animation: pulse 2s infinite;
        }

        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .processing-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem 3rem;
            text-align: center;
            border: 1px solid var(--accent-blue);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        .processing-card i {
            font-size: 3rem;
            color: var(--accent-blue);
            margin-bottom: 1rem;
        }

        .processing-card h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .processing-card p {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: relative;
            max-width: 800px;
            margin: 5% auto;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            animation: slideIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            padding: 0.25rem;
            border-radius: 4px;
        }

        .modal-close:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .alert {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--error);
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: var(--accent-light);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--warning);
        }

        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            background: var(--primary-dark);
        }

        .upload-area:hover {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
        }

        .upload-area.active {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .upload-area.drag-over {
            border-color: var(--accent-blue);
            background: rgba(14, 165, 233, 0.05);
            transform: scale(1.02);
        }

        .upload-area.processing {
            pointer-events: none;
            opacity: 0.8;
        }

        .upload-area.error {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--accent-blue);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .upload-area:hover .upload-icon {
            transform: translateY(-5px);
        }

        .upload-area.drag-over .upload-icon {
            animation: bounce 1s infinite;
        }

        .upload-area input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .preview-container {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
        }

        .preview-image {
            flex: 0 0 200px;
            text-align: center;
        }

        .preview-image img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .preview-details {
            flex: 1;
        }

        .tx-details {
            background: var(--primary-dark);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid var(--border-color);
        }

        .tx-hash {
            font-family: 'Inter', monospace;
            font-size: 0.875rem;
            word-break: break-all;
            color: var(--accent-light);
            margin: 0.5rem 0;
        }

        .server-id-display {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--primary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-weight: 600;
            color: var(--accent-blue);
            animation: slideIn 0.5s ease;
        }

        /* Enhanced form validation styles */
        .form-input.invalid {
            border-color: var(--error);
            animation: shake 0.3s ease;
        }

        .form-input.valid {
            border-color: var(--success);
        }

        .validation-message {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            animation: slideIn 0.3s ease;
        }

        .validation-message.error {
            color: var(--error);
        }

        .validation-message.warning {
            color: var(--warning);
        }

        .validation-message.success {
            color: var(--success);
        }

        /* Upload metadata */
        .upload-metadata {
            background: var(--primary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .upload-metadata h5 {
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
            font-size: 0.938rem;
        }

        .upload-metadata .metadata-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .upload-metadata .metadata-item strong {
            color: var(--text-primary);
        }

        /* Compression status */
        .compression-status {
            background: var(--primary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .compression-status.active {
            border-color: var(--accent-blue);
        }

        .compression-progress {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-blue);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.5);
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            min-width: 50px;
            text-align: right;
        }

        /* Notification system */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            min-width: 300px;
            max-width: 500px;
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 9999;
            transition: all 0.3s ease;
            transform: translateX(400px);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
        }

        .notification-enter {
            transform: translateX(400px);
        }

        .notification-active {
            transform: translateX(0);
        }

        .notification-exit {
            transform: translateX(400px);
            opacity: 0;
        }

        .notification-success {
            background: rgba(16, 185, 129, 0.9);
            color: white;
            border: 1px solid rgba(16, 185, 129, 1);
        }

        .notification-error {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: 1px solid rgba(239, 68, 68, 1);
        }

        .notification-warning {
            background: rgba(245, 158, 11, 0.9);
            color: white;
            border: 1px solid rgba(245, 158, 11, 1);
        }

        .notification-info {
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border: 1px solid rgba(59, 130, 246, 1);
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.25rem;
            margin-left: auto;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .notification-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Empty states */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.125rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        /* Animations */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes shimmer {
            to { left: 100%; }
        }

        @keyframes scan {
            to { left: 100%; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .admin-controls {
                grid-template-columns: 1fr;
            }

            .stats-section {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .preview-container {
                flex-direction: column;
            }
            
            .preview-image {
                flex: unset;
            }

            .modal-content {
                margin: 2% 1rem;
                padding: 1.5rem;
            }

            .welcome-section h2 {
                font-size: 2rem;
            }

            .stats-section {
                grid-template-columns: 1fr;
            }

            .tab-navigation {
                justify-content: start;
            }

            .notification {
                right: 0.5rem;
                left: 0.5rem;
                min-width: auto;
            }
        }

        /* Print styles */
        @media print {
            .header,
            .tab-navigation,
            .btn,
            .modal {
                display: none !important;
            }

            body {
                background: white;
                color: black;
            }

            .card {
                border: 1px solid #ccc;
                page-break-inside: avoid;
            }
        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Focus styles */
        *:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            :root {
                --primary-dark: #000000;
                --text-primary: #ffffff;
                --accent-blue: #00a8ff;
            }
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div class="loader-container" id="loader">
        <div class="loader"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo" onclick="location.reload()">
                <i class="fas fa-shield-alt"></i>
                <h1>LegalNotice</h1>
            </div>
            <div class="header-controls">
                <div id="contractsStatus" style="display: none;">
                    <div class="contract-indicator">
                        <span>Contract:</span>
                        <span id="legalContractShort">-</span>
                        <button class="btn-icon" onclick="viewContractOnTronscan('legal')" title="View on TronScan">
                            <i class="fas fa-external-link-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="chain-selector">
                    <select id="chainSelector" class="chain-dropdown" onchange="handleChainChange()">
                        <optgroup label="TRON">
                            <option value="tron-mainnet">TRON Mainnet</option>
                            <option value="tron-nile" selected>TRON Nile Testnet</option>
                            <option value="tron-shasta">TRON Shasta Testnet</option>
                        </optgroup>
                        <optgroup label="Ethereum">
                            <option value="evm-ethereum">Ethereum Mainnet</option>
                            <option value="evm-sepolia">Ethereum Sepolia</option>
                        </optgroup>
                        <optgroup label="Polygon">
                            <option value="evm-polygon">Polygon Mainnet</option>
                            <option value="evm-mumbai">Polygon Mumbai</option>
                        </optgroup>
                        <optgroup label="BNB Chain">
                            <option value="evm-bsc">BNB Smart Chain</option>
                            <option value="evm-bscTestnet">BSC Testnet</option>
                        </optgroup>
                    </select>
                </div>
                <div class="network-indicator" id="networkIndicator">
                    <i class="fas fa-circle"></i>
                    <span id="networkName">Disconnected</span>
                </div>
                <div class="wallet-status">
                    <div class="wallet-address" id="walletAddress" style="display: none;">
                        <span id="walletAddressText">Not Connected</span>
                        <button class="btn-icon" onclick="copyWalletAddress()" title="Copy address">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <span id="walletStatus" style="display: block;">Not Connected</span>
                    <button class="btn btn-primary btn-small" onclick="connectWallet()" id="connectBtn">
                        <i class="fas fa-link"></i>
                        Connect
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Welcome Section -->
        <div class="welcome-section" id="welcomeSection">
            <h2>Blockchain Legal Document Service</h2>
            <p>Secure, verifiable, and immutable legal document serving on the TRON network</p>
        </div>

        <!-- Stats Section -->
        <div class="stats-section" id="statsSection" style="display: none;">
            <div class="stat-card">
                <i class="fas fa-file-alt"></i>
                <div class="stat-value" id="totalNotices">0</div>
                <div class="stat-label">Total Notices</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-check-circle"></i>
                <div class="stat-value" id="acceptedNotices">0</div>
                <div class="stat-label">Accepted</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-clock"></i>
                <div class="stat-value" id="pendingNotices">0</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-users"></i>
                <div class="stat-value" id="activeServers">0</div>
                <div class="stat-label">Process Servers</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('user')">
                <i class="fas fa-user"></i> Process Server
                <span class="badge" id="userBadge" style="display: none;">0</span>
            </button>
            <button class="tab-button" onclick="switchTab('admin')">
                <i class="fas fa-user-shield"></i> Admin Panel
            </button>
            <button class="tab-button" onclick="switchTab('help')">
                <i class="fas fa-question-circle"></i> Help
            </button>
        </div>

        <!-- User Tab -->
        <div id="userTab" class="tab-content active">
            <!-- Contract Management Card -->
            <div class="card" id="contractManagementCard">
                <div class="card-header">
                    <h2><i class="fas fa-file-contract"></i> Contract Connection</h2>
                </div>
                <div class="form-group">
                    <label class="form-label">Legal Notice Contract Address</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" class="form-input" id="contractAddress" 
                               placeholder="Enter contract address (e.g., TXxxx...)"
                               value="THiFCfipFxnvjp7DRB1JtFhT7HsRkKNQAA" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="copyAddress(document.getElementById('contractAddress').value)" title="Copy address">
                            <i class="fas fa-copy"></i>
                        </button>
                        <a href="https://nile.tronscan.org/#/contract/THiFCfipFxnvjp7DRB1JtFhT7HsRkKNQAA" target="_blank" class="btn btn-secondary" title="View on TronScan">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                    <p class="form-help">Enter the deployed Legal Notice smart contract address</p>
                </div>
                <button class="btn btn-primary" onclick="connectContracts()" id="connectContractBtn">
                    <i class="fas fa-plug"></i>
                    Connect Contract
                </button>
                <div id="contractStatus"></div>
            </div>

            <!-- New User Registration Notice -->
            <div id="registrationNotice" class="notification-banner">
                <i class="fas fa-info-circle"></i>
                <div style="flex: 1;">
                    <strong>New User?</strong>
                    Please register as a Process Server to get your unique identifier.
                    <button class="btn btn-primary btn-small" style="margin-left: 1rem;" onclick="openRegistrationModal()">
                        <i class="fas fa-user-plus"></i> Register Now
                    </button>
                </div>
                <button class="btn-icon" onclick="dismissRegistrationNotice()" title="Dismiss">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Server ID Display -->
            <div id="serverIdDisplay" style="display: none; margin-bottom: 1.5rem;">
                <div class="server-id-display">
                    <i class="fas fa-id-badge"></i>
                    Your Server ID: <span id="userServerId">00</span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid-2" style="margin-bottom: 2rem;">
                <div class="action-card primary" onclick="openMintModal()">
                    <i class="fas fa-file-upload"></i>
                    <h3>Create Legal Notice</h3>
                    <p>Upload document and create NFT with automatic alert</p>
                </div>
                
                <div class="action-card" onclick="openAuditModal()">
                    <i class="fas fa-clipboard-check"></i>
                    <h3>Audit Issued Notices</h3>
                    <p>View all notices, delivery status, and transaction details</p>
                </div>
            </div>

            <!-- My Alerts -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-bell"></i> My Legal Notice Alerts</h2>
                    <button class="btn btn-secondary btn-small" onclick="refreshMyAlerts()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div id="myAlertsContent">
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>No alerts yet</h3>
                        <p>Click refresh to check for new legal notices</p>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-history"></i> Recent Activity</h2>
                </div>
                <div id="recentActivityContent">
                    <div class="empty-state">
                        <i class="fas fa-clipboard"></i>
                        <h3>No recent activity</h3>
                        <p>Your recent transactions will appear here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="adminTab" class="tab-content">
            <!-- Admin Access Check -->
            <div id="adminAccessDenied" class="alert alert-error" style="display: none;">
                <i class="fas fa-lock"></i>
                <div>
                    <strong>Access Denied</strong>
                    <p>You need admin role to access this section.</p>
                </div>
            </div>

            <div id="adminContent" style="display: none;">
                <!-- Pending Registrations -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-user-clock"></i> Pending Process Server Registrations</h2>
                        <button class="btn btn-secondary btn-small" onclick="refreshPendingRegistrations()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div id="pendingRegistrations">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No pending registrations</h3>
                            <p>New registration requests will appear here</p>
                        </div>
                    </div>
                </div>

                <!-- Admin Controls -->
                <div class="admin-controls">
                    <!-- Fee Structure Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-coins"></i> Fee Structure Management</h2>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Creation Fee (TRX)</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number" class="form-input" id="creationFee" 
                                       step="0.01" min="0" placeholder="0.1" style="flex: 1;">
                                <span class="form-help" id="currentCreationFee">Current: 0.1 TRX</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="updateFee()" id="updateFeeBtn">
                            <i class="fas fa-save"></i> Update Fee
                        </button>
                        <div id="feeUpdateResult"></div>
                    </div>

                    <!-- Role Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-users-cog"></i> Role & Exemption Management</h2>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Select Role</label>
                            <select class="form-input" id="roleSelect">
                                <option value="PROCESS_SERVER_ROLE">Process Server</option>
                                <option value="ADMIN_ROLE">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
    <label class="form-label">Wallet Address</label>
    <div style="display: flex; gap: 0.5rem;">
        <input type="text" class="form-input" id="roleAddress" 
               placeholder="Enter TRON wallet address" style="flex: 1;">
        <button class="btn btn-secondary btn-small" onclick="useConnectedAddress()" title="Use my address">
            <i class="fas fa-user"></i>
        </button>
    </div>
    <p class="form-help">Enter address or click button to use your connected wallet</p>
</div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="feeExemptCheck">
                            <label for="feeExemptCheck">Grant fee exemption</label>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="grantRole()" id="grantRoleBtn">
                                <i class="fas fa-user-plus"></i>
                                Grant Role
                            </button>
                            <button class="btn btn-secondary" onclick="checkRole()" id="checkRoleBtn">
                                <i class="fas fa-user-check"></i>
                                Check Role
                            </button>
                        </div>
                        <div id="roleResult"></div>
                    </div>

                    <!-- Fee Collector Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-wallet"></i> Update Fee Collector</h2>
                        </div>
                        <div class="form-group">
    <label class="form-label">Fee Collector Address</label>
    <div style="display: flex; gap: 0.5rem;">
        <input type="text" class="form-input" id="feeCollectorAddress" 
               placeholder="Enter wallet address" style="flex: 1;">
        <button class="btn btn-secondary btn-small" onclick="useConnectedAddressForFeeCollector()" title="Use my address">
            <i class="fas fa-user"></i>
        </button>
    </div>
    <p class="form-help">Address that receives all contract fees</p>
</div>
                        <button class="btn btn-primary" onclick="updateFeeCollector()" id="updateFeeCollectorBtn">
                            <i class="fas fa-save"></i>
                            Update Fee Collector
                        </button>
                        <div id="feeCollectorResult"></div>
                    </div>

                    <!-- Contract Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-cog"></i> Contract Management</h2>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Resource Sponsorship</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="resourceSponsorshipCheck" checked>
                                <label for="resourceSponsorshipCheck">Enable resource sponsorship</label>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="updateResourceSponsorship()">
                            <i class="fas fa-save"></i>
                            Update Settings
                        </button>
                        <div id="contractManagementResult"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Tab -->
        <div id="helpTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-question-circle"></i> Getting Started</h2>
                </div>
                <div style="padding: 1rem;">
                    <h3 style="margin-bottom: 1rem;">For Process Servers</h3>
                    <ol style="margin-left: 1.5rem; color: var(--text-secondary);">
                        <li style="margin-bottom: 0.5rem;">Connect your TronLink wallet</li>
                        <li style="margin-bottom: 0.5rem;">Register as a Process Server to get your unique ID</li>
                        <li style="margin-bottom: 0.5rem;">Connect to the Legal Notice smart contract</li>
                        <li style="margin-bottom: 0.5rem;">Create legal notices by uploading documents</li>
                        <li style="margin-bottom: 0.5rem;">Track delivery status and acceptances</li>
                    </ol>

                    <h3 style="margin: 2rem 0 1rem;">For Recipients</h3>
                    <ol style="margin-left: 1.5rem; color: var(--text-secondary);">
                        <li style="margin-bottom: 0.5rem;">Check "My Legal Notice Alerts" for pending notices</li>
                        <li style="margin-bottom: 0.5rem;">Click "Accept" to acknowledge receipt</li>
                        <li style="margin-bottom: 0.5rem;">The blockchain records your acceptance permanently</li>
                    </ol>

                    <h3 style="margin: 2rem 0 1rem;">Document Requirements</h3>
                    <ul style="margin-left: 1.5rem; color: var(--text-secondary);">
                        <li style="margin-bottom: 0.5rem;">Format: JPEG or PNG only</li>
                        <li style="margin-bottom: 0.5rem;">Recommended: 8.511" documents</li>
                        <li style="margin-bottom: 0.5rem;">Max file size: 400KB after compression</li>
                        <li style="margin-bottom: 0.5rem;">Documents are automatically optimized for blockchain</li>
                    </ul>

                    <h3 style="margin: 2rem 0 1rem;">Fees</h3>
                    <p style="color: var(--text-secondary);">
                        A small fee (default 0.1 TRX) is required to create legal notices. 
                        This covers blockchain transaction costs and prevents spam.
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-shield-alt"></i> Security & Privacy</h2>
                </div>
                <div style="padding: 1rem;">
                    <ul style="margin-left: 1.5rem; color: var(--text-secondary);">
                        <li style="margin-bottom: 0.5rem;">All documents are stored on IPFS for decentralization</li>
                        <li style="margin-bottom: 0.5rem;">Document hashes are recorded on blockchain for verification</li>
                        <li style="margin-bottom: 0.5rem;">Only authorized process servers can create notices</li>
                        <li style="margin-bottom: 0.5rem;">Recipients must actively accept notices</li>
                        <li style="margin-bottom: 0.5rem;">All transactions are transparent and auditable</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-link"></i> Useful Links</h2>
                </div>
                <div style="padding: 1rem;">
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <a href="https://www.tronlink.org/" target="_blank" class="btn btn-secondary">
                            <i class="fas fa-wallet"></i> Get TronLink Wallet
                        </a>
                        <a href="https://tronscan.org/" target="_blank" class="btn btn-secondary">
                            <i class="fas fa-search"></i> View on Tronscan
                        </a>
                        <a href="https://developers.tron.network/" target="_blank" class="btn btn-secondary">
                            <i class="fas fa-book"></i> TRON Documentation
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTINUE TO PART 2 FOR MODALS -->
<!-- PART 2: ALL MODALS -->
    
    <!-- Processing Overlay -->
    <div id="processingOverlay" class="processing-overlay" style="display: none;">
        <div class="processing-card">
            <i class="fas fa-spinner loading-spinner" style="font-size: 3rem;"></i>
            <h3>Processing Transaction</h3>
            <p id="processingMessage">Please confirm the transaction in your wallet...</p>
            <div id="processingStatus"></div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-user-plus"></i>
                    Process Server Registration
                </h3>
                <button class="modal-close" onclick="closeRegistrationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Important:</strong> Registration requires admin approval. You'll be notified once approved.
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Agency/Company Name</label>
                    <input type="text" class="form-input" id="regAgency" 
                           placeholder="Enter your agency or company name">
                </div>
                <div class="form-group">
                    <label class="form-label">Purpose/Use Case</label>
                    <textarea class="form-input" id="regPurpose" rows="3"
                             placeholder="Describe how you'll use the system"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Contact Email</label>
                    <input type="email" class="form-input" id="regEmail" 
                           placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Wallet Address</label>
                    <input type="text" class="form-input" id="regWallet" readonly>
                    <p class="form-help">This is your connected wallet address</p>
                </div>
                <button class="btn btn-primary" onclick="submitRegistration()">
                    <i class="fas fa-paper-plane"></i>
                    Submit Registration
                </button>
                <button class="btn btn-secondary" onclick="closeRegistrationModal()" style="margin-left: 0.5rem;">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <div id="registrationResult" style="margin-top: 1rem;"></div>
            </div>
        </div>
    </div>

    <!-- Registration Success Modal -->
    <div id="registrationSuccessModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    Registration Submitted
                </h3>
                <button class="modal-close" onclick="closeRegistrationSuccessModal()">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <i class="fas fa-user-check" style="font-size: 4rem; color: var(--success); margin-bottom: 1rem;"></i>
                <h4 style="margin-bottom: 1rem;">Your registration has been submitted successfully!</h4>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    An administrator will review your application and assign you a Server ID. 
                    You'll be notified once your registration is approved.
                </p>
                <button class="btn btn-primary" onclick="closeRegistrationSuccessModal()">
                    <i class="fas fa-check"></i>
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Mint Modal -->
    <div id="mintModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-upload"></i>
                    Create Legal Notice
                </h3>
                <button class="modal-close" onclick="closeMintModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Upload -->
                <div id="mintStep1">
                    <h4 style="margin-bottom: 1rem;">Step 1: Upload Document Image</h4>
                    <div class="alert alert-info" style="margin-bottom: 1rem;">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Document Requirements:</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                <li>Format: JPEG or PNG only</li>
                                <li>Recommended: 8.511" documents</li>
                                <li>Max file size: 400KB after compression</li>
                                <li>Documents will be automatically optimized for blockchain storage</li>
                                <li>High-resolution documents will be compressed to ensure transaction success</li>
                            </ul>
                        </div>
                    </div>
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('documentUpload').click()">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <h4>Click to upload legal document</h4>
                        <p style="color: var(--text-secondary);">Supports PDF, Word, JPEG and PNG</p>
                        <p style="color: var(--text-muted); font-size: 0.875rem;">Drag and drop also supported</p>
                        <input type="file" id="documentUpload" accept=".pdf,.doc,.docx,image/jpeg,image/jpg,image/png,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" onchange="handleDocumentUpload(event)">
                    </div>
                    <div id="compressionStatus" class="compression-status" style="display: none;">
                        <h5 style="color: var(--accent-blue); margin-bottom: 0.5rem;">
                            <i class="fas fa-compress"></i> Processing Document
                        </h5>
                        <div class="compression-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="compressionProgress" style="width: 0%;"></div>
                            </div>
                            <div class="progress-text" id="compressionText">0%</div>
                        </div>
                        <div id="compressionDetails" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);"></div>
                    </div>
                </div>

                <!-- Step 2: Details -->
                <div id="mintStep2" style="display: none;">
                    <h4 style="margin-bottom: 1rem;">Step 2: Legal Notice Details</h4>
                    
                    <div class="preview-container">
                        <div class="preview-image">
                            <img id="documentPreview" src="" alt="Document preview">
                            <button class="btn btn-secondary btn-small" style="margin-top: 0.5rem;" onclick="changeDocument()">
                                <i class="fas fa-exchange-alt"></i>
                                Change
                            </button>
                            <div id="uploadMetadata" class="upload-metadata" style="display: none;">
                                <h5>Document Info</h5>
                                <div class="metadata-item">
                                    <span>Original Size:</span>
                                    <strong id="originalSize">-</strong>
                                </div>
                                <div class="metadata-item">
                                    <span>Final Size:</span>
                                    <strong id="finalSize">-</strong>
                                </div>
                                <div class="metadata-item">
                                    <span>Compression:</span>
                                    <strong id="compressionRatio">-</strong>
                                </div>
                                <div class="metadata-item">
                                    <span>Format:</span>
                                    <strong id="fileFormat">-</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div class="preview-details">
                            <div class="form-group">
                                <label class="form-label">Recipient Address</label>
                                <input type="text" class="form-input" id="mintRecipient" 
                                       placeholder="Enter recipient's TRON address">
                                <div class="validation-message" id="recipientValidation" style="display: none;"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Case Number</label>
                                <input type="text" class="form-input" id="mintCaseNumber" 
                                       placeholder="e.g., CV-2024-001234">
                                <p class="form-help">Use your standard case numbering format</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Jurisdiction</label>
                                <select class="form-input" id="mintJurisdiction">
                                    <option value="0">Federal</option>
                                    <option value="1">State</option>
                                    <option value="2">County</option>
                                    <option value="3">Municipal</option>
                                    <option value="4">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Document Type</label>
                                <select class="form-input" id="mintDocumentType">
                                    <option value="0">Summons</option>
                                    <option value="1">Complaint</option>
                                    <option value="2">Subpoena</option>
                                    <option value="3">Notice of Hearing</option>
                                    <option value="4">Notice of Seizure</option>
                                    <option value="5">Other</option>
                                </select>
                            </div>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-coins"></i>
                                <div>
                                    <strong>Fee Required:</strong> <span id="creationFeeDisplay">0.1 TRX</span>
                                    <br><small>This fee covers blockchain transaction costs</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button class="btn btn-secondary" onclick="showMintStep(1)">
                            <i class="fas fa-arrow-left"></i>
                            Back
                        </button>
                        <button class="btn btn-primary" onclick="createLegalNotice()" id="createNoticeBtn">
                            <i class="fas fa-rocket"></i>
                            Create Legal Notice
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Modal -->
    <div id="auditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-clipboard-check"></i>
                    Notice Audit & Delivery Status
                </h3>
                <button class="modal-close" onclick="closeAuditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Search Options</label>
                    <select class="form-input" id="auditSearchType" onchange="updateAuditSearch()">
                        <option value="noticeId">By Notice ID</option>
                        <option value="myNotices">My Issued Notices</option>
                        <option value="myAlerts">My Alert Notices</option>
                    </select>
                </div>
                
                <div id="auditSearchInput" class="form-group">
                    <label class="form-label">Notice ID</label>
                    <input type="text" class="form-input" id="auditNoticeId" 
                           placeholder="Enter notice ID (e.g., 0, 1, 2...)">
                </div>
                
                <button class="btn btn-primary" onclick="performAudit()" id="performAuditBtn">
                    <i class="fas fa-search"></i>
                    Search
                </button>
                
                <div id="auditResults" style="margin-top: 2rem;"></div>
            </div>
        </div>
    </div>

    <!-- Accept Notice Modal -->
    <div id="acceptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-check-circle"></i>
                    Accept Legal Notice
                </h3>
                <button class="modal-close" onclick="closeAcceptModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="acceptDetails" style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">Notice Details</h4>
                    <div class="token-item">
                        <div class="token-details">
                            <div class="token-detail">
                                <span>Notice ID:</span>
                                <span id="acceptNoticeId">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Document Type:</span>
                                <span id="acceptDocumentType">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Jurisdiction:</span>
                                <span id="acceptJurisdiction">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Case Number Hash:</span>
                                <span id="acceptCaseNumber">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Server:</span>
                                <span id="acceptServer">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Timestamp:</span>
                                <span id="acceptTimestamp">-</span>
                            </div>
                        </div>
                        <div id="acceptPreview" class="token-preview" style="display: none;">
                            <img id="acceptPreviewImage" src="" alt="Document preview">
                        </div>
                    </div>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Important:</strong> By accepting this notice, you acknowledge receipt of this legal document. The transaction will be recorded on the blockchain as proof of service.
                    </div>
                </div>

                <div style="margin-top: 1.5rem; display: flex; justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="closeAcceptModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="acceptNotice()" id="acceptNoticeBtn">
                        <i class="fas fa-check"></i>
                        Accept Notice
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Success Modal -->
    <div id="txModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    Transaction Successful
                </h3>
                <button class="modal-close" onclick="closeTxModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="txMessage" style="color: var(--text-primary); margin-bottom: 1rem;">
                    Your transaction has been successfully confirmed!
                </p>
                <div id="txDetails" style="margin-bottom: 1rem;"></div>
                <div class="tx-details">
                    <strong>Transaction Hash:</strong>
                    <div class="tx-hash" id="txHash"></div>
                </div>
                <a id="txLink" href="#" target="_blank" class="btn btn-secondary" style="margin-top: 1rem;">
                    <i class="fas fa-external-link-alt"></i>
                    View on Tronscan
                </a>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="copyTxHash()">
                    <i class="fas fa-copy"></i>
                    Copy Hash
                </button>
                <button class="btn btn-secondary" onclick="closeTxModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- BEGIN JAVASCRIPT IN PART 3 -->
<!-- PART 3: JAVASCRIPT -->
    <script>
        // Global variables
        let tronWeb = null;
        let legalContract = null;
        let currentUserServerId = null;
        let isAdmin = false;
        let isProcessServer = false;
        
        // In-memory storage (since localStorage is not available in sandbox)
        let registrations = [];
        let serverIds = {};
        let recentActivity = [];
        
        // Fee configuration
        let currentCreationFee = 0.1; // Default value in TRX
        
        // Document upload vars
        let uploadedImage = null;
        let uploadedFileInfo = null;
        let currentNoticeId = null;
        
        // Contract ABI (minified for production)
        const CONTRACT_ABI = [{"inputs":[{"internalType":"address payable","name":"_feeCollector","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"acceptNotice","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"alerts","outputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint256","name":"noticeId","type":"uint256"},{"internalType":"string","name":"previewImage","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"creationFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"string","name":"ipfsHash","type":"string"},{"internalType":"string","name":"previewImage","type":"string"},{"internalType":"bytes32","name":"contentHash","type":"bytes32"},{"internalType":"string","name":"caseNumber","type":"string"},{"internalType":"uint16","name":"jurisdictionIndex","type":"uint16"},{"internalType":"uint8","name":"documentType","type":"uint8"}],"name":"createLegalNotice","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"depositForFees","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"feeExemptions","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserAlerts","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserNotices","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"grantRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"hasRole","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"notices","outputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"address","name":"server","type":"address"},{"internalType":"string","name":"ipfsHash","type":"string"},{"internalType":"bytes32","name":"contentHash","type":"bytes32"},{"internalType":"uint128","name":"timestamp","type":"uint128"},{"internalType":"uint64","name":"caseNumberHash","type":"uint64"},{"internalType":"uint32","name":"alertTokenId","type":"uint32"},{"internalType":"uint16","name":"jurisdictionIndex","type":"uint16"},{"internalType":"uint8","name":"documentType","type":"uint8"},{"internalType":"uint8","name":"status","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"revokeRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"bool","name":"exempt","type":"bool"}],"name":"setFeeExemption","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"enabled","type":"bool"}],"name":"setResourceSponsorship","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"updateFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address payable","name":"newCollector","type":"address"}],"name":"updateFeeCollector","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawTRX","outputs":[],"stateMutability":"nonpayable","type":"function"}];

        // Multi-chain configuration
        const CHAIN_CONFIG = {
            tron: {
                mainnet: {
                    name: 'TRON Mainnet',
                    contractAddress: 'TYour_Mainnet_Contract_Address',
                    explorerUrl: 'https://tronscan.org',
                    nativeToken: 'TRX',
                    chainId: null
                },
                nile: {
                    name: 'TRON Nile Testnet',
                    contractAddress: 'THiFCfipFxnvjp7DRB1JtFhT7HsRkKNQAA',
                    explorerUrl: 'https://nile.tronscan.org',
                    nativeToken: 'TRX',
                    chainId: null
                },
                shasta: {
                    name: 'TRON Shasta Testnet',
                    contractAddress: 'TYour_Shasta_Contract_Address',
                    explorerUrl: 'https://shasta.tronscan.org',
                    nativeToken: 'TRX',
                    chainId: null
                }
            },
            evm: {
                ethereum: {
                    name: 'Ethereum Mainnet',
                    contractAddress: '0xYour_Ethereum_Contract_Address',
                    explorerUrl: 'https://etherscan.io',
                    nativeToken: 'ETH',
                    chainId: 1,
                    rpcUrl: 'https://eth-mainnet.g.alchemy.com/v2/YOUR_ALCHEMY_KEY'
                },
                sepolia: {
                    name: 'Ethereum Sepolia',
                    contractAddress: '0xYour_Sepolia_Contract_Address',
                    explorerUrl: 'https://sepolia.etherscan.io',
                    nativeToken: 'ETH',
                    chainId: 11155111,
                    rpcUrl: 'https://eth-sepolia.g.alchemy.com/v2/YOUR_ALCHEMY_KEY'
                },
                polygon: {
                    name: 'Polygon Mainnet',
                    contractAddress: '0xYour_Polygon_Contract_Address',
                    explorerUrl: 'https://polygonscan.com',
                    nativeToken: 'MATIC',
                    chainId: 137,
                    rpcUrl: 'https://polygon-rpc.com'
                },
                mumbai: {
                    name: 'Polygon Mumbai',
                    contractAddress: '0xYour_Mumbai_Contract_Address',
                    explorerUrl: 'https://mumbai.polygonscan.com',
                    nativeToken: 'MATIC',
                    chainId: 80001,
                    rpcUrl: 'https://rpc-mumbai.maticvigil.com'
                },
                bsc: {
                    name: 'BNB Smart Chain',
                    contractAddress: '0xYour_BSC_Contract_Address',
                    explorerUrl: 'https://bscscan.com',
                    nativeToken: 'BNB',
                    chainId: 56,
                    rpcUrl: 'https://bsc-dataseed.binance.org'
                },
                bscTestnet: {
                    name: 'BSC Testnet',
                    contractAddress: '0xYour_BSC_Testnet_Contract_Address',
                    explorerUrl: 'https://testnet.bscscan.com',
                    nativeToken: 'BNB',
                    chainId: 97,
                    rpcUrl: 'https://data-seed-prebsc-1-s1.binance.org:8545'
                }
            }
        };

        // Current chain state
        let currentChainType = 'tron'; // 'tron' or 'evm'
        let currentNetwork = 'nile'; // Default to Nile testnet where contract is deployed
        let web3Instance = null;
        let evmContract = null;

        // Enhanced UI Manager
        class UIManager {
            constructor() {
                this.notifications = [];
            }

            showNotification(type, message, duration = 5000) {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type} notification-enter`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                    <button class="notification-close" onclick="uiManager.removeNotification(this)"></button>
                `;
                
                document.body.appendChild(notification);
                this.notifications.push(notification);
                
                // Trigger animation
                setTimeout(() => {
                    notification.classList.remove('notification-enter');
                    notification.classList.add('notification-active');
                }, 10);
                
                // Auto-remove after duration
                setTimeout(() => {
                    this.removeNotification(notification);
                }, duration);
            }

            removeNotification(notification) {
                // If passed a button, get the parent notification
                if (notification.tagName === 'BUTTON') {
                    notification = notification.parentElement;
                }
                
                notification.classList.remove('notification-active');
                notification.classList.add('notification-exit');
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                    const index = this.notifications.indexOf(notification);
                    if (index > -1) {
                        this.notifications.splice(index, 1);
                    }
                }, 300);
            }

            updateStats(stats) {
                document.getElementById('totalNotices').textContent = stats.total || '0';
                document.getElementById('acceptedNotices').textContent = stats.accepted || '0';
                document.getElementById('pendingNotices').textContent = stats.pending || '0';
                document.getElementById('activeServers').textContent = stats.servers || '0';
                
                // Show stats section if hidden
                const statsSection = document.getElementById('statsSection');
                if (statsSection.style.display === 'none') {
                    statsSection.style.display = 'grid';
                }
            }

            updateBadge(tab, count) {
                const badge = document.getElementById(`${tab}Badge`);
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }

            showLoader() {
                document.getElementById('loader').style.display = 'flex';
            }

            hideLoader() {
                const loader = document.getElementById('loader');
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                    loader.style.opacity = '1';
                }, 500);
            }
        }

        const uiManager = new UIManager();
// Use connected wallet address function
function useConnectedAddress() {
    if (tronWeb && tronWeb.defaultAddress) {
        document.getElementById('roleAddress').value = tronWeb.defaultAddress.base58;
        
        // Trigger validation if exists
        const event = new Event('input', { bubbles: true });
        document.getElementById('roleAddress').dispatchEvent(event);
        
        uiManager.showNotification('success', 'Connected wallet address inserted');
    } else {
        uiManager.showNotification('error', 'No wallet connected');
    }
}

// Use connected wallet address for fee collector
function useConnectedAddressForFeeCollector() {
    if (tronWeb && tronWeb.defaultAddress) {
        document.getElementById('feeCollectorAddress').value = tronWeb.defaultAddress.base58;
        
        // Trigger validation if exists
        const event = new Event('input', { bubbles: true });
        document.getElementById('feeCollectorAddress').dispatchEvent(event);
        
        uiManager.showNotification('success', 'Connected wallet address inserted');
    } else {
        uiManager.showNotification('error', 'No wallet connected');
    }
}
        // Handle chain change
        async function handleChainChange() {
            const chainSelector = document.getElementById('chainSelector');
            const selectedValue = chainSelector.value;
            const [chainType, network] = selectedValue.split('-');
            
            currentChainType = chainType;
            currentNetwork = network;
            
            // Update contract address field
            const config = CHAIN_CONFIG[chainType][network];
            const contractAddressField = document.getElementById('contractAddress');
            if (contractAddressField) {
                contractAddressField.value = config.contractAddress;
            }
            
            // Disconnect current wallet if connected
            if (window.tronWeb && window.tronWeb.ready && chainType === 'evm') {
                // Switching from TRON to EVM
                disconnectWallet();
            } else if (web3Instance && chainType === 'tron') {
                // Switching from EVM to TRON
                disconnectWallet();
            }
            
            uiManager.showNotification('info', `Switched to ${config.name}. Please connect your wallet.`);
        }

        // Connect Wallet function
        async function connectWallet() {
            const connectBtn = document.getElementById('connectBtn');
            
            if (currentChainType === 'tron') {
                await connectTronWallet();
            } else {
                await connectEVMWallet();
            }
        }

        // Connect TRON wallet
        async function connectTronWallet() {
            const connectBtn = document.getElementById('connectBtn');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const networkIndicator = document.getElementById('networkIndicator');
            const networkName = document.getElementById('networkName');

            try {
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<span class="loading-spinner"></span> Connecting...';

                // Check if TronWeb is available
                if (typeof window.tronWeb === 'undefined') {
                    throw new Error('TronLink not detected. Please install TronLink extension');
                }

                // Use recommended TronLink account request method
                try {
                    await window.tronLink.request({method: 'tron_requestAccounts'});
                } catch (error) {
                    throw new Error('Please unlock your TronLink wallet and grant permission');
                }

                // Wait for TronWeb to be ready
                let tries = 0;
                while (!window.tronWeb.ready && tries < 10) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    tries++;
                }

                if (!window.tronWeb.ready) {
                    throw new Error('Please unlock your TronLink wallet');
                }

                tronWeb = window.tronWeb;
                const address = tronWeb.defaultAddress.base58;

                // Update UI
                walletStatus.style.display = 'none';
                walletAddress.style.display = 'flex';
                
                const shortAddress = address.substring(0, 6) + '...' + address.substring(address.length - 4);
                document.getElementById('walletAddressText').textContent = shortAddress;
                
                // Get network name
                const fullNode = tronWeb.fullNode.host;
                let network = 'Unknown Network';
                
                if (fullNode.includes('trongrid.io') && !fullNode.includes('shasta') && !fullNode.includes('nile')) {
                    network = 'Mainnet';
                } else if (fullNode.includes('nile')) {
                    network = 'Nile Testnet';
                } else if (fullNode.includes('shasta')) {
                    network = 'Shasta Testnet';
                }
                
                networkName.textContent = network;
                networkIndicator.classList.add('connected');

                connectBtn.innerHTML = '<i class="fas fa-check"></i> Connected';
                connectBtn.classList.remove('btn-primary');
                connectBtn.classList.add('btn-success');

                // If registration modal is open, update wallet field
                const regWalletField = document.getElementById('regWallet');
                if (regWalletField) {
                    regWalletField.value = address;
                }

                // Hide welcome section
                document.getElementById('welcomeSection').style.display = 'none';

                uiManager.showNotification('success', `Connected to ${network}`);

                // Check if contract is already in the address field
                const contractAddressField = document.getElementById('contractAddress');
                if (contractAddressField && contractAddressField.value) {
                    // Automatically connect to contract
                    await connectContracts();
                }

            } catch (error) {
                console.error('Connection error:', error);
                
                connectBtn.innerHTML = '<i class="fas fa-link"></i> Connect';
                connectBtn.disabled = false;
                
                uiManager.showNotification('error', error.message || 'Failed to connect wallet');
            }
        }

        // Connect EVM wallet
        async function connectEVMWallet() {
            const connectBtn = document.getElementById('connectBtn');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const networkIndicator = document.getElementById('networkIndicator');
            const networkName = document.getElementById('networkName');

            try {
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<span class="loading-spinner"></span> Connecting...';

                // Check if MetaMask is available
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask not detected. Please install MetaMask extension');
                }

                // Create Web3 instance
                web3Instance = new Web3(window.ethereum);

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts found. Please unlock MetaMask');
                }

                const address = accounts[0];
                const chainId = await web3Instance.eth.getChainId();
                const config = CHAIN_CONFIG.evm[currentNetwork];

                // Check if on correct network
                if (Number(chainId) !== config.chainId) {
                    uiManager.showNotification('warning', `Please switch to ${config.name} in MetaMask`);
                    
                    // Try to switch network
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: web3Instance.utils.toHex(config.chainId) }],
                        });
                    } catch (switchError) {
                        // This error code indicates that the chain has not been added to MetaMask
                        if (switchError.code === 4902) {
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: web3Instance.utils.toHex(config.chainId),
                                        chainName: config.name,
                                        rpcUrls: [config.rpcUrl],
                                        blockExplorerUrls: [config.explorerUrl],
                                        nativeCurrency: {
                                            name: config.nativeToken,
                                            symbol: config.nativeToken,
                                            decimals: 18
                                        }
                                    }],
                                });
                            } catch (addError) {
                                throw new Error('Failed to add network to MetaMask');
                            }
                        } else {
                            throw switchError;
                        }
                    }
                }

                // Update UI
                walletStatus.style.display = 'none';
                walletAddress.style.display = 'flex';
                
                const shortAddress = address.substring(0, 6) + '...' + address.substring(address.length - 4);
                document.getElementById('walletAddressText').textContent = shortAddress;
                
                networkName.textContent = config.name;
                networkIndicator.classList.add('connected');

                connectBtn.innerHTML = '<i class="fas fa-check"></i> Connected';
                connectBtn.classList.remove('btn-primary');
                connectBtn.classList.add('btn-success');

                // Hide welcome section
                document.getElementById('welcomeSection').style.display = 'none';

                uiManager.showNotification('success', `Connected to ${config.name}`);

                // Connect to contract
                const contractAddressField = document.getElementById('contractAddress');
                if (contractAddressField && contractAddressField.value) {
                    await connectContracts();
                }

                // Listen for account changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        disconnectWallet();
                    } else {
                        window.location.reload();
                    }
                });

                // Listen for chain changes
                window.ethereum.on('chainChanged', () => {
                    window.location.reload();
                });

            } catch (error) {
                console.error('Connection error:', error);
                
                connectBtn.innerHTML = '<i class="fas fa-link"></i> Connect';
                connectBtn.disabled = false;
                
                uiManager.showNotification('error', error.message || 'Failed to connect wallet');
            }
        }

        // Disconnect wallet
        function disconnectWallet() {
            // Reset UI
            const connectBtn = document.getElementById('connectBtn');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const networkIndicator = document.getElementById('networkIndicator');
            const networkName = document.getElementById('networkName');
            
            walletStatus.style.display = 'block';
            walletStatus.textContent = 'Not Connected';
            walletAddress.style.display = 'none';
            networkName.textContent = 'Disconnected';
            networkIndicator.classList.remove('connected');
            
            connectBtn.innerHTML = '<i class="fas fa-link"></i> Connect';
            connectBtn.classList.remove('btn-success');
            connectBtn.classList.add('btn-primary');
            connectBtn.disabled = false;
            
            // Show welcome section
            document.getElementById('welcomeSection').style.display = 'block';
            
            // Reset contract connection
            legalContract = null;
            evmContract = null;
            web3Instance = null;
            tronWeb = null;
            
            // Hide contract status
            document.getElementById('contractsStatus').style.display = 'none';
            document.getElementById('contractAddress').disabled = false;
            
            // Reset contract connect button
            const contractConnectBtn = document.getElementById('connectContractBtn');
            if (contractConnectBtn) {
                contractConnectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect to Contract';
                contractConnectBtn.classList.remove('btn-success');
                contractConnectBtn.classList.add('btn-primary');
                contractConnectBtn.disabled = false;
            }
            
            uiManager.showNotification('info', 'Wallet disconnected');
        }

        // Tab switching function
        function switchTab(tabName) {
            const tabs = ['user', 'admin', 'help'];
            
            tabs.forEach(tab => {
                const tabButton = document.querySelector(`[onclick="switchTab('${tab}')"]`);
                const tabContent = document.getElementById(`${tab}Tab`);
                
                if (tab === tabName) {
                    tabButton.classList.add('active');
                    tabContent.classList.add('active');
                } else {
                    tabButton.classList.remove('active');
                    tabContent.classList.remove('active');
                }
            });

            // Check admin access when switching to admin tab
            if (tabName === 'admin') {
                checkAdminAccess();
            }
        }

        // Check admin access
        async function checkAdminAccess() {
            const adminAccessDenied = document.getElementById('adminAccessDenied');
            const adminContent = document.getElementById('adminContent');
            
            if (!legalContract || !tronWeb.defaultAddress) {
                adminAccessDenied.style.display = 'block';
                adminContent.style.display = 'none';
                return;
            }
            
            if (isAdmin) {
                adminAccessDenied.style.display = 'none';
                adminContent.style.display = 'block';
                refreshPendingRegistrations();
            } else {
                adminAccessDenied.style.display = 'block';
                adminContent.style.display = 'none';
            }
        }

        // Modal functions
        function openRegistrationModal() {
            const modal = document.getElementById('registrationModal');
            modal.style.display = 'block';
            
            // Auto-fill wallet address if connected
            if (tronWeb && tronWeb.defaultAddress) {
                document.getElementById('regWallet').value = tronWeb.defaultAddress.base58;
            }
        }

        function closeRegistrationModal() {
            document.getElementById('registrationModal').style.display = 'none';
            clearRegistrationForm();
        }

        function clearRegistrationForm() {
            document.getElementById('regAgency').value = '';
            document.getElementById('regPurpose').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('registrationResult').innerHTML = '';
        }

        function closeRegistrationSuccessModal() {
            document.getElementById('registrationSuccessModal').style.display = 'none';
        }

        function dismissRegistrationNotice() {
            document.getElementById('registrationNotice').style.display = 'none';
        }

        function openMintModal() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Please connect to contract first');
                return;
            }
            
            if (!isProcessServer && !isAdmin) {
                uiManager.showNotification('error', 'You need Process Server role to create notices');
                return;
            }
            
            const modal = document.getElementById('mintModal');
            modal.style.display = 'block';
            resetMintForm();
            
            // Update fee display
            document.getElementById('creationFeeDisplay').textContent = `${currentCreationFee} TRX`;
        }

        function closeMintModal() {
            document.getElementById('mintModal').style.display = 'none';
            resetMintForm();
        }

        function openAuditModal() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Please connect to contract first');
                return;
            }
            
            document.getElementById('auditModal').style.display = 'block';
        }

        function closeAuditModal() {
            document.getElementById('auditModal').style.display = 'none';
        }

        async function openAcceptModal(noticeId) {
            currentNoticeId = noticeId;
            
            // Fetch notice details
            try {
                const details = await getNoticeDetails(noticeId);
                if (details) {
                    document.getElementById('acceptNoticeId').textContent = noticeId;
                    document.getElementById('acceptDocumentType').textContent = getDocumentTypeString(details.documentType);
                    document.getElementById('acceptJurisdiction').textContent = getJurisdictionString(details.jurisdictionIndex);
                    document.getElementById('acceptCaseNumber').textContent = details.caseNumberHash || 'Not Available';
                    document.getElementById('acceptServer').innerHTML = createAddressDisplay(details.server);
                    document.getElementById('acceptTimestamp').textContent = new Date(parseInt(details.timestamp) * 1000).toLocaleString();
                    
                    // Try to get alert preview if available
                    try {
                        const alert = await legalContract.alerts(details.alertTokenId).call();
                        if (alert.previewImage) {
                            document.getElementById('acceptPreviewImage').src = `data:image/jpeg;base64,${alert.previewImage}`;
                            document.getElementById('acceptPreview').style.display = 'block';
                        }
                    } catch (e) {
                        console.log('No preview available');
                    }
                    
                    document.getElementById('acceptModal').style.display = 'block';
                } else {
                    uiManager.showNotification('error', 'Failed to load notice details');
                }
            } catch (error) {
                console.error('Error loading notice:', error);
                uiManager.showNotification('error', 'Failed to load notice details');
            }
        }

        function closeAcceptModal() {
            document.getElementById('acceptModal').style.display = 'none';
            currentNoticeId = null;
        }

        function closeTxModal() {
            document.getElementById('txModal').style.display = 'none';
        }

        // Processing overlay
        function showProcessing(message) {
            document.getElementById('processingMessage').textContent = message;
            document.getElementById('processingOverlay').style.display = 'flex';
        }

        function hideProcessing() {
            document.getElementById('processingOverlay').style.display = 'none';
        }

        // Alert helper
        function showAlert(elementId, type, message) {
            const element = document.getElementById(elementId);
            const icons = {
                success: '<i class="fas fa-check-circle"></i>',
                error: '<i class="fas fa-exclamation-circle"></i>',
                info: '<i class="fas fa-info-circle"></i>',
                warning: '<i class="fas fa-exclamation-triangle"></i>'
            };
            
            element.className = 'alert alert-' + type;
            element.innerHTML = icons[type] + ' ' + message;
            element.style.display = 'flex';
        }

        // Registration functions
        async function submitRegistration() {
            const agency = document.getElementById('regAgency').value.trim();
            const purpose = document.getElementById('regPurpose').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const wallet = document.getElementById('regWallet').value;
            
            // Validation
            const errors = [];
            if (!agency) errors.push('Agency/Company name is required');
            if (!purpose) errors.push('Purpose/Use case is required');
            if (!email) errors.push('Email is required');
            if (email && !isValidEmail(email)) errors.push('Invalid email format');
            
            if (errors.length > 0) {
                showAlert('registrationResult', 'error', errors.join('<br>'));
                return;
            }
            
            // Create registration submission
            const registration = {
                id: Date.now(),
                agency,
                purpose,
                email,
                wallet,
                timestamp: new Date(),
                status: 'pending'
            };
            
            // Store registration
            registrations.push(registration);
            
            // Add to recent activity
            addRecentActivity('registration', 'Registration submitted', { agency });
            
            // Close registration modal
            closeRegistrationModal();
            
            // Show success modal
            setTimeout(() => {
                document.getElementById('registrationSuccessModal').style.display = 'block';
            }, 100);
            
            // Refresh the pending registrations list if admin
            if (isAdmin) {
                refreshPendingRegistrations();
            }
            
            // Hide registration notice
            dismissRegistrationNotice();
        }
        
        function refreshPendingRegistrations() {
            const pendingDiv = document.getElementById('pendingRegistrations');
            const pending = registrations.filter(r => r.status === 'pending');
            
            if (pending.length === 0) {
                pendingDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>No pending registrations</h3>
                        <p>New registration requests will appear here</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="token-list">';
            pending.forEach(reg => {
                const shortWallet = createAddressDisplay(reg.wallet);
                html += `
                    <div class="token-item">
                        <div class="token-item-header">
                            <div>
                                <strong>${escapeHtml(reg.agency)}</strong>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                    ${escapeHtml(reg.email)}  ${new Date(reg.timestamp).toLocaleDateString()}
                                </div>
                            </div>
                            <button class="btn btn-success btn-small" onclick="approveRegistration(${reg.id})">
                                <i class="fas fa-check"></i> Approve
                            </button>
                        </div>
                        <div class="token-details">
                            <div class="token-detail">
                                <span>Purpose:</span>
                                <span>${escapeHtml(reg.purpose)}</span>
                            </div>
                            <div class="token-detail">
                                <span>Wallet:</span>
                                <span title="${reg.wallet}">${shortWallet}</span>
                            </div>
                            <div class="token-detail">
                                <span>Submitted:</span>
                                <span>${new Date(reg.timestamp).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            pendingDiv.innerHTML = html;
        }

        async function approveRegistration(regId) {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            const registration = registrations.find(r => r.id == regId);
            if (!registration) return;
            
            try {
                showProcessing('Granting process server role...');
                
                // Grant PROCESS_SERVER_ROLE to the user
                const roleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                const tx = await legalContract.grantRole(roleBytes, registration.wallet).send({
                    feeLimit: 100_000_000,
                    callValue: 0,
                    shouldPollResponse: true
                });
                
                registration.status = 'approved';
                
                hideProcessing();
                uiManager.showNotification('success', 'Registration approved and role granted!');
                refreshPendingRegistrations();
                
                // Add to recent activity
                addRecentActivity('approval', 'Registration approved', { 
                    agency: registration.agency,
                    wallet: registration.wallet 
                });
                
            } catch (error) {
                hideProcessing();
                console.error('Error approving registration:', error);
                uiManager.showNotification('error', 'Failed to grant role: ' + getErrorMessage(error));
            }
        }

        // Mint functions
        function showMintStep(step) {
            document.getElementById('mintStep1').style.display = step === 1 ? 'block' : 'none';
            document.getElementById('mintStep2').style.display = step === 2 ? 'block' : 'none';
        }

        function resetMintForm() {
            document.getElementById('documentUpload').value = '';
            document.getElementById('mintRecipient').value = '';
            document.getElementById('mintCaseNumber').value = '';
            document.getElementById('mintJurisdiction').selectedIndex = 0;
            document.getElementById('mintDocumentType').selectedIndex = 0;
            uploadedImage = null;
            uploadedFileInfo = null;
            showMintStep(1);
            document.getElementById('compressionStatus').style.display = 'none';
            document.getElementById('uploadArea').classList.remove('processing', 'error', 'active', 'drag-over');
            document.getElementById('recipientValidation').style.display = 'none';
        }

        function changeDocument() {
            showMintStep(1);
        }

        // Enhanced File upload handler with compression
        async function handleDocumentUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const uploadArea = document.getElementById('uploadArea');
            const compressionStatus = document.getElementById('compressionStatus');
            const compressionProgress = document.getElementById('compressionProgress');
            const compressionText = document.getElementById('compressionText');
            const compressionDetails = document.getElementById('compressionDetails');
            
            // Validate file type
            const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
            const isWord = file.type.includes('word') || file.type.includes('document') || 
                          file.name.toLowerCase().endsWith('.doc') || file.name.toLowerCase().endsWith('.docx');
            const isImage = file.type.match(/image\/(jpeg|jpg|png)/);
            
            if (!isPDF && !isWord && !isImage) {
                uiManager.showNotification('error', 'Please upload a PDF, Word document, or image (JPEG/PNG)');
                event.target.value = '';
                uploadArea.classList.add('error');
                setTimeout(() => uploadArea.classList.remove('error'), 2000);
                return;
            }
            
            // Validate file size (max 25MB for legal documents before compression)
            if (file.size > 25 * 1024 * 1024) {
                uiManager.showNotification('error', 'File size must be less than 25MB. Large documents will be compressed automatically.');
                event.target.value = '';
                uploadArea.classList.add('error');
                setTimeout(() => uploadArea.classList.remove('error'), 2000);
                return;
            }
            
            // Store original file info
            uploadedFileInfo = {
                originalSize: file.size,
                originalSizeStr: formatFileSize(file.size),
                format: file.type.split('/')[1].toUpperCase()
            };
            
            uploadArea.classList.add('processing');
            compressionStatus.style.display = 'block';
            compressionStatus.classList.add('active');
            
            try {
                // Initialize document converter
                const converter = new DocumentConverter();
                await converter.init();
                
                // Start processing
                updateCompressionProgress(10, 'Reading file...');
                
                if (isPDF || isWord) {
                    // Convert PDF/Word to images
                    try {
                        updateCompressionProgress(20, 'Converting document to image format...');
                        
                        const converted = await converter.convertDocument(file);
                        
                        updateCompressionProgress(50, 'Generating preview for wallet display...');
                        
                        // Compress preview for blockchain storage - allow larger size for readability
                        const compressedPreview = await converter.compressImage(converted.preview, 200000); // 200KB max for readable preview
                        
                        updateCompressionProgress(70, 'Preparing full document...');
                        
                        // Store results
                        uploadedImage = compressedPreview;
                        uploadedFileInfo.fullDocument = converted.fullDocument;
                        uploadedFileInfo.documentHash = converted.documentHash;
                        uploadedFileInfo.finalSize = compressedPreview.length;
                        uploadedFileInfo.finalSizeStr = formatFileSize(compressedPreview.length);
                        uploadedFileInfo.compressionRatio = 'Converted';
                        uploadedFileInfo.format = converted.fileType.toUpperCase();
                        
                        // Show preview using object URL to avoid data URL length limits
                        const previewElement = document.getElementById('documentPreview');
                        
                        // Convert base64 to blob for object URL
                        const base64Data = compressedPreview.split(',')[1];
                        const byteCharacters = atob(base64Data);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const blob = new Blob([byteArray], {type: 'image/jpeg'});
                        const objectURL = URL.createObjectURL(blob);
                        
                        // Clean up previous object URL if exists
                        if (previewElement.src && previewElement.src.startsWith('blob:')) {
                            URL.revokeObjectURL(previewElement.src);
                        }
                        
                        previewElement.src = objectURL;
                        showMintStep(2);
                        
                        updateCompressionProgress(100, 'Document conversion complete!');
                        
                        setTimeout(() => {
                            uploadArea.classList.remove('processing');
                            compressionStatus.style.display = 'none';
                            compressionStatus.classList.remove('active');
                        }, 1000);
                        
                        uiManager.showNotification('success', 'Document converted and ready for service');
                        
                    } catch (conversionError) {
                        console.error('Document conversion error:', conversionError);
                        console.error('Stack trace:', conversionError.stack);
                        throw new Error('Failed to convert document: ' + conversionError.message);
                    }
                } else {
                    // Handle regular images
                    const reader = new FileReader();
                    
                    reader.onload = async function(e) {
                        try {
                            updateCompressionProgress(20, 'Analyzing document dimensions...');
                            
                            // Load image to get dimensions
                            const img = new Image();
                        img.onload = async function() {
                            updateCompressionProgress(30, 'Optimizing for legal document format...');
                            
                            // Compress image specifically for legal documents
                            const compressedImage = await compressLegalDocument(img, file, (progress) => {
                                const totalProgress = 30 + (progress * 0.6);
                                updateCompressionProgress(totalProgress, `Compressing: ${Math.round(progress)}% complete`);
                            });
                            
                            updateCompressionProgress(90, 'Finalizing compression...');
                            
                            uploadedImage = compressedImage.base64;
                            uploadedFileInfo.finalSize = compressedImage.size;
                            uploadedFileInfo.finalSizeStr = formatFileSize(compressedImage.size);
                            uploadedFileInfo.compressionRatio = Math.round((1 - compressedImage.size / file.size) * 100) + '%';
                            
                            // Show preview using object URL to avoid data URL length limits
                            const previewElement = document.getElementById('documentPreview');
                            
                            // Convert base64 to blob for object URL
                            const base64Data = compressedImage.dataUrl.split(',')[1];
                            const byteCharacters = atob(base64Data);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const blob = new Blob([byteArray], {type: 'image/jpeg'});
                            const objectURL = URL.createObjectURL(blob);
                            
                            // Clean up previous object URL if exists
                            if (previewElement.src && previewElement.src.startsWith('blob:')) {
                                URL.revokeObjectURL(previewElement.src);
                            }
                            
                            previewElement.src = objectURL;
                            showMintStep(2);
                            
                            // Update metadata display
                            document.getElementById('originalSize').textContent = uploadedFileInfo.originalSizeStr;
                            document.getElementById('finalSize').textContent = uploadedFileInfo.finalSizeStr;
                            document.getElementById('compressionRatio').textContent = uploadedFileInfo.compressionRatio;
                            document.getElementById('fileFormat').textContent = uploadedFileInfo.format;
                            document.getElementById('uploadMetadata').style.display = 'block';
                            
                            updateCompressionProgress(100, 'Compression complete!');
                            
                            setTimeout(() => {
                                uploadArea.classList.remove('processing');
                                compressionStatus.style.display = 'none';
                                compressionStatus.classList.remove('active');
                            }, 1000);
                            
                            uiManager.showNotification('success', 'Document uploaded and optimized successfully');
                            
                        };
                        img.onerror = function() {
                            throw new Error('Invalid image file');
                        };
                        img.src = e.target.result;
                        
                    } catch (error) {
                        console.error('Processing error:', error);
                        uploadArea.classList.remove('processing');
                        uploadArea.classList.add('error');
                        compressionStatus.style.display = 'none';
                        uiManager.showNotification('error', 'Failed to process image: ' + error.message);
                    }
                };
                
                reader.onerror = function() {
                    uploadArea.classList.remove('processing');
                    uploadArea.classList.add('error');
                    compressionStatus.style.display = 'none';
                    uiManager.showNotification('error', 'Failed to read file');
                };
                
                reader.readAsDataURL(file);
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                uploadArea.classList.remove('processing');
                uploadArea.classList.add('error');
                compressionStatus.style.display = 'none';
                uiManager.showNotification('error', 'Failed to upload file');
            }
            
            function updateCompressionProgress(percent, message) {
                compressionProgress.style.width = percent + '%';
                compressionText.textContent = Math.round(percent) + '%';
                compressionDetails.textContent = message;
            }
        }

        // Enhanced compression function for legal documents
        async function compressLegalDocument(img, file, progressCallback) {
            return new Promise((resolve) => {
                console.log('=== Optimized Compression for Legal Documents ===');
                console.log('Original file size:', formatFileSize(file.size));
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Balanced compression settings
                const TARGET_SIZE = 30000; // Target size for optimized blockchain storage
                const MAX_WIDTH = 800;
                const MAX_HEIGHT = 1200;
                
                let width = img.width;
                let height = img.height;
                
                // Scale down if too large
                if (width > MAX_WIDTH || height > MAX_HEIGHT) {
                    const scale = Math.min(MAX_WIDTH / width, MAX_HEIGHT / height);
                    width = Math.round(width * scale);
                    height = Math.round(height * scale);
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Progressive compression
                const qualities = [0.8, 0.6, 0.4, 0.3, 0.2, 0.1];
                let bestResult = null;
                
                progressCallback(30);
                
                // Draw image to canvas
                ctx.drawImage(img, 0, 0, width, height);
                
                // Try different compression qualities
                for (let i = 0; i < qualities.length; i++) {
                    const quality = qualities[i];
                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    const base64 = dataUrl.split(',')[1];
                    const size = calculateBase64Size(base64);
                    
                    console.log(`Quality ${quality}: ${formatFileSize(size)}`);
                    progressCallback(30 + (i / qualities.length) * 50);
                    
                    if (!bestResult || size <= TARGET_SIZE) {
                        bestResult = { dataUrl, base64, size, quality, width, height };
                        if (size <= TARGET_SIZE) break;
                    }
                }
                
                progressCallback(80);
                
                // If still too large, reduce dimensions further
                if (bestResult.size > TARGET_SIZE) {
                    width = Math.round(width * 0.8);
                    height = Math.round(height * 0.8);
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.2);
                    const base64 = dataUrl.split(',')[1];
                    const size = calculateBase64Size(base64);
                    
                    bestResult = { dataUrl, base64, size, quality: 0.2, width, height };
                }
                
                console.log('=== Compression Complete ===');
                console.log('Final size:', formatFileSize(bestResult.size));
                console.log('Final dimensions:', bestResult.width + 'x' + bestResult.height);
                console.log('Final quality:', bestResult.quality);
                
                progressCallback(100);
                resolve(bestResult);
            });
        }

        // Generate a small thumbnail from the uploaded image
        async function generateThumbnail(base64Image) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    // Clean up object URL after loading
                    if (img.src.startsWith('blob:')) {
                        URL.revokeObjectURL(img.src);
                    }
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Create an ultra-tiny thumbnail for blockchain storage (25x35px)
                    canvas.width = 25;
                    canvas.height = 35;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, 25, 35);
                    
                    // Get as base64 with very low quality for minimal blockchain storage
                    const thumbnailBase64 = canvas.toDataURL('image/jpeg', 0.05).split(',')[1];
                    resolve(thumbnailBase64);
                };
                
                // Use object URL instead of data URL to avoid length limits
                try {
                    const objectURL = createObjectURLFromBase64(base64Image);
                    img.src = objectURL;
                } catch (error) {
                    console.error('Error creating object URL for thumbnail:', error);
                    // Fallback: try the original method for smaller images
                    img.src = base64Image.startsWith('data:') ? base64Image : `data:image/jpeg;base64,${base64Image}`;
                }
            });
        }

        // Utility function to convert base64 to object URL for large images
        function createObjectURLFromBase64(base64Data, mimeType = 'image/jpeg') {
            const base64 = base64Data.includes(',') ? base64Data.split(',')[1] : base64Data;
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], {type: mimeType});
            return URL.createObjectURL(blob);
        }

        // Upload to IPFS (using Netlify Function)
        async function uploadToIPFS(base64Image) {
            try {
                console.log('Starting IPFS upload, image size:', base64Image.length);
                
                // Add timeout for the fetch request
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                
                // Call Netlify function to handle the IPFS upload
                const response = await fetch('/.netlify/functions/upload-to-ipfs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: base64Image }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                console.log('IPFS upload response status:', response.status);
                
                const data = await response.json();
                console.log('IPFS upload response data:', data);
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to upload to IPFS');
                }
                
                return data.ipfsHash;
            } catch (error) {
                console.error('IPFS upload error:', error);
                console.error('Error stack:', error.stack);
                
                if (error.name === 'AbortError') {
                    throw new Error('IPFS upload timed out. Please try again.');
                }
                console.error('IPFS upload error:', error);
                
                // Fallback: use a mock IPFS hash for testing
                console.log('Using mock IPFS hash for testing');
                return 'Qm' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            }
        }

        // Generate content hash for document
        function generateContentHash(data) {
            return tronWeb.sha3(data);
        }

        // Create Legal Notice function
        async function createLegalNotice() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            const recipient = document.getElementById('mintRecipient').value.trim();
            const caseNumber = document.getElementById('mintCaseNumber').value.trim();
            const jurisdictionIndex = document.getElementById('mintJurisdiction').value;
            const documentType = document.getElementById('mintDocumentType').value;
            
            // Validation
            const errors = [];
            if (!recipient) errors.push('Recipient address is required');
            if (recipient) {
                if (currentChainType === 'tron' && !tronWeb.isAddress(recipient)) {
                    errors.push('Invalid TRON address');
                } else if (currentChainType === 'evm' && !web3Instance.utils.isAddress(recipient)) {
                    errors.push('Invalid Ethereum address');
                }
            }
            if (!caseNumber) errors.push('Case number is required');
            if (!uploadedImage) errors.push('Document image is required');
            
            if (errors.length > 0) {
                uiManager.showNotification('error', errors.join(', '));
                return;
            }
            
            // Disable create button
            const createBtn = document.getElementById('createNoticeBtn');
            createBtn.disabled = true;
            
            try {
                showProcessing('Preparing legal notice...');
                console.log('Starting transaction process with uploadedImage size:', uploadedImage ? uploadedImage.length : 'null');
                
                // Generate a smaller preview image for the alert token
                console.log('Generating thumbnail...');
                const previewImage = await generateThumbnail(uploadedImage);
                console.log('Thumbnail generated, size:', previewImage.length);
                
                // Upload the full-size document to IPFS
                showProcessing('Uploading document to IPFS...');
                console.log('Starting IPFS upload...');
                const ipfsHash = await uploadToIPFS(uploadedImage);
                console.log('IPFS upload complete, hash:', ipfsHash);
                
                // Generate content hash
                const contentHash = generateContentHash(ipfsHash + caseNumber);
                
                showProcessing('Creating legal notice on blockchain...');
                
                let tx;
                
                if (currentChainType === 'tron') {
                    // Get fee in Sun
                    const feeInSun = tronWeb.toSun(currentCreationFee);
                    
                    // Call the contract with both IPFS hash and base64 preview
                    tx = await legalContract.createLegalNotice(
                        recipient,
                        ipfsHash,             // Full document on IPFS
                        previewImage,         // Base64 preview for the alert
                        contentHash,
                        caseNumber,
                        jurisdictionIndex,
                        documentType
                    ).send({
                        feeLimit: 50_000_000, // 50 TRX max
                        callValue: feeInSun,
                        shouldPollResponse: true
                    });
                } else {
                    // EVM chains
                    const accounts = await web3Instance.eth.getAccounts();
                    const feeInWei = web3Instance.utils.toWei(currentCreationFee.toString(), 'ether');
                    
                    // Estimate gas
                    const gasEstimate = await legalContract.methods.createLegalNotice(
                        recipient,
                        ipfsHash,
                        previewImage,
                        contentHash,
                        caseNumber,
                        jurisdictionIndex,
                        documentType
                    ).estimateGas({
                        from: accounts[0],
                        value: feeInWei
                    });
                    
                    // Send transaction
                    tx = await legalContract.methods.createLegalNotice(
                        recipient,
                        ipfsHash,
                        previewImage,
                        contentHash,
                        caseNumber,
                        jurisdictionIndex,
                        documentType
                    ).send({
                        from: accounts[0],
                        value: feeInWei,
                        gas: Math.floor(gasEstimate * 1.2) // Add 20% buffer
                    });
                }
                
                hideProcessing();
                closeMintModal();
                
                // Parse transaction events to get notice and alert IDs
                let noticeId = 'N/A';
                let alertId = 'N/A';
                
                if (currentChainType === 'tron') {
                    if (tx && tx.length > 0) {
                        // Look for LegalNoticeCreated event
                        const events = await tronWeb.getEventByTransactionID(tx);
                        if (events && events.length > 0) {
                            const createEvent = events.find(e => e.name === 'LegalNoticeCreated');
                            if (createEvent) {
                                noticeId = createEvent.result.noticeId;
                                alertId = createEvent.result.alertId;
                            }
                        }
                    }
                } else {
                    // EVM chains - parse events from transaction receipt
                    if (tx && tx.events && tx.events.LegalNoticeCreated) {
                        const event = tx.events.LegalNoticeCreated;
                        noticeId = event.returnValues.noticeId;
                        alertId = event.returnValues.alertId;
                    }
                }
                
                // Add to recent activity
                addRecentActivity('create', 'Legal notice created', {
                    recipient: recipient,
                    documentType: getDocumentTypeString(documentType),
                    noticeId,
                    alertId
                });
                
                // Show success with notice details
                const txDetails = `
                    <div class="token-details" style="margin-bottom: 1rem;">
                        <div class="token-detail">
                            <span>Notice ID:</span>
                            <span><strong>${noticeId}</strong></span>
                        </div>
                        <div class="token-detail">
                            <span>Alert ID:</span>
                            <span><strong>${alertId}</strong></span>
                        </div>
                        <div class="token-detail">
                            <span>Recipient:</span>
                            ${createAddressDisplay(recipient)}
                        </div>
                        <div class="token-detail">
                            <span>Document Type:</span>
                            <span>${getDocumentTypeString(documentType)}</span>
                        </div>
                    </div>
                `;
                
                // Show success notification and transaction modal
                uiManager.showNotification('success', 'Legal notice created successfully!');
                showTxModal(tx, 'Legal notice created successfully!', txDetails);
                
                // Refresh my notices after a delay
                setTimeout(() => refreshMyNotices(), 2000);
                
            } catch (error) {
                console.error('Error creating legal notice:', error);
                
                let errorMsg = 'Failed to create legal notice';
                errorMsg = getErrorMessage(error);
                
                uiManager.showNotification('error', errorMsg);
            } finally {
                hideProcessing();
                createBtn.disabled = false;
            }
        }

        // Accept Notice function
        async function acceptNotice() {
            if (!legalContract || !currentNoticeId) {
                uiManager.showNotification('error', 'Notice information missing');
                return;
            }
            
            const acceptBtn = document.getElementById('acceptNoticeBtn');
            acceptBtn.disabled = true;
            
            try {
                showProcessing('Accepting legal notice...');
                
                // Call the contract to accept the notice
                const tx = await legalContract.acceptNotice(currentNoticeId).send({
                    feeLimit: 100_000_000,
                    callValue: 0,
                    shouldPollResponse: true
                });
                
                hideProcessing();
                closeAcceptModal();
                
                // Add to recent activity
                addRecentActivity('accept', 'Legal notice accepted', {
                    noticeId: currentNoticeId
                });
                
                // Show success notification
                uiManager.showNotification('success', 'Legal notice accepted successfully');
                
                // Show transaction modal
                const txDetails = `
                    <div class="token-details" style="margin-bottom: 1rem;">
                        <div class="token-detail">
                            <span>Notice ID:</span>
                            <span><strong>${currentNoticeId}</strong></span>
                        </div>
                        <div class="token-detail">
                            <span>Status:</span>
                            <span><strong style="color: var(--success);">Accepted</strong></span>
                        </div>
                    </div>
                `;
                showTxModal(tx, 'Legal notice accepted successfully!', txDetails);
                
                // Refresh alerts after a short delay
                setTimeout(() => {
                    refreshMyAlerts();
                }, 2000);
                
            } catch (error) {
                console.error('Error accepting notice:', error);
                
                let errorMsg = getErrorMessage(error);
                uiManager.showNotification('error', errorMsg);
            } finally {
                hideProcessing();
                acceptBtn.disabled = false;
            }
        }

        // Audit functions
        function updateAuditSearch() {
            const searchType = document.getElementById('auditSearchType').value;
            const searchInput = document.getElementById('auditSearchInput');
            
            if (searchType === 'myNotices' || searchType === 'myAlerts') {
                searchInput.style.display = 'none';
            } else {
                searchInput.style.display = 'block';
                const label = searchInput.querySelector('.form-label');
                const input = document.getElementById('auditNoticeId');
                
                if (searchType === 'noticeId') {
                    label.textContent = 'Notice ID';
                    input.placeholder = 'Enter notice ID (e.g., 0, 1, 2...)';
                }
            }
        }

        async function performAudit() {
            const searchType = document.getElementById('auditSearchType').value;
            const resultsDiv = document.getElementById('auditResults');
            const auditBtn = document.getElementById('performAuditBtn');
            
            if (!legalContract) {
                resultsDiv.innerHTML = '<div class="alert alert-error">Contract not connected</div>';
                return;
            }
            
            auditBtn.disabled = true;
            
            try {
                resultsDiv.innerHTML = '<p><i class="fas fa-spinner loading-spinner"></i> Searching...</p>';
                
                let notices = [];
                
                switch (searchType) {
                    case 'noticeId':
                        const noticeId = document.getElementById('auditNoticeId').value.trim();
                        if (!noticeId && noticeId !== '0') {
                            resultsDiv.innerHTML = '<div class="alert alert-error">Please enter a notice ID</div>';
                            return;
                        }
                        const noticeDetails = await getNoticeDetails(noticeId);
                        if (noticeDetails) notices.push(noticeDetails);
                        break;
                        
                    case 'myNotices':
                        notices = await getMyNotices();
                        break;
                        
                    case 'myAlerts':
                        notices = await getMyAlerts();
                        break;
                }
                
                if (notices.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <h3>No notices found</h3>
                            <p>Try adjusting your search criteria</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="token-list">';
                for (const notice of notices) {
                    html += await renderNoticeItem(notice);
                }
                html += '</div>';
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error performing audit:', error);
                resultsDiv.innerHTML = '<div class="alert alert-error">Error: ' + getErrorMessage(error) + '</div>';
            } finally {
                auditBtn.disabled = false;
            }
        }

        async function renderNoticeItem(notice) {
            // Determine status badge
            let statusBadge;
            switch (parseInt(notice.status)) {
                case 0: // PENDING
                    statusBadge = '<span class="status-badge status-pending"><i class="fas fa-clock"></i> Pending</span>';
                    break;
                case 1: // SERVED
                    statusBadge = '<span class="status-badge" style="background: rgba(59, 130, 246, 0.2); color: var(--accent-blue);"><i class="fas fa-paper-plane"></i> Served</span>';
                    break;
                case 2: // ACCEPTED
                    statusBadge = '<span class="status-badge status-complete"><i class="fas fa-check"></i> Accepted</span>';
                    break;
                case 3: // EXPIRED
                    statusBadge = '<span class="status-badge" style="background: rgba(156, 163, 175, 0.2); color: var(--text-muted);"><i class="fas fa-calendar-times"></i> Expired</span>';
                    break;
                case 4: // CANCELLED
                    statusBadge = '<span class="status-badge status-error"><i class="fas fa-ban"></i> Cancelled</span>';
                    break;
                default:
                    statusBadge = '<span class="status-badge" style="background: rgba(156, 163, 175, 0.2); color: var(--text-muted);"><i class="fas fa-question"></i> Unknown</span>';
            }
            
            // Action button based on notice status and ownership
            let actionButton = '';
            if (notice.status == 0 && notice.recipient === tronWeb.defaultAddress.base58) {
                actionButton = `
                    <button class="btn btn-primary btn-small" onclick="openAcceptModal(${notice.id})">
                        <i class="fas fa-check"></i> Accept
                    </button>
                `;
            }
            
            // Get preview image if available
            let previewHtml = '';
            try {
                if (notice.alertTokenId) {
                    const alert = await legalContract.alerts(notice.alertTokenId).call();
                    if (alert.previewImage) {
                        previewHtml = `
                            <div class="token-preview">
                                <img src="data:image/jpeg;base64,${alert.previewImage}" alt="Document preview">
                            </div>
                        `;
                    }
                }
            } catch (e) {
                console.log('No preview available');
            }
            
            return `
                <div class="token-item">
                    <div class="token-item-header">
                        <div>
                            <strong>Notice #${notice.id}</strong>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                ${getDocumentTypeString(notice.documentType)}  ${getJurisdictionString(notice.jurisdictionIndex)}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            ${statusBadge}
                            ${actionButton}
                        </div>
                    </div>
                    <div class="token-details">
                        <div class="token-detail">
                            <span>Recipient:</span>
                            ${createAddressDisplay(notice.recipient)}
                        </div>
                        <div class="token-detail">
                            <span>Server:</span>
                            ${createAddressDisplay(notice.server)}
                        </div>
                        <div class="token-detail">
                            <span>Created:</span>
                            <span>${new Date(parseInt(notice.timestamp) * 1000).toLocaleString()}</span>
                        </div>
                        <div class="token-detail">
                            <span>Alert Token ID:</span>
                            <span>${notice.alertTokenId}</span>
                        </div>
                        <div class="token-detail">
                            <span>IPFS Hash:</span>
                            <span style="font-family: monospace; font-size: 0.75rem;">${notice.ipfsHash.substring(0, 12)}...</span>
                        </div>
                    </div>
                    ${previewHtml}
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary btn-small" onclick="viewOnTronscan('notice', ${notice.id})">
                            <i class="fas fa-external-link-alt"></i> View on Tronscan
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="viewOnIPFS('${notice.ipfsHash}')">
                            <i class="fas fa-globe"></i> View on IPFS
                        </button>
                    </div>
                </div>
            `;
        }

        // My notices and alerts functions
        async function getMyNotices() {
            try {
                const notices = await legalContract.getUserNotices(tronWeb.defaultAddress.base58).call();
                
                const noticeDetails = [];
                for (const noticeId of notices) {
                    const details = await getNoticeDetails(noticeId);
                    if (details) noticeDetails.push(details);
                }
                
                return noticeDetails;
            } catch (error) {
                console.error('Error getting my notices:', error);
                return [];
            }
        }

        async function getMyAlerts() {
            try {
                const alerts = await legalContract.getUserAlerts(tronWeb.defaultAddress.base58).call();
                
                const noticeDetails = [];
                for (const alertId of alerts) {
                    const alert = await getAlertDetails(alertId);
                    if (alert && alert.noticeId) {
                        const notice = await getNoticeDetails(alert.noticeId);
                        if (notice) noticeDetails.push(notice);
                    }
                }
                
                return noticeDetails;
            } catch (error) {
                console.error('Error getting my alerts:', error);
                return [];
            }
        }

        async function refreshMyAlerts() {
            const alertsDiv = document.getElementById('myAlertsContent');
            
            if (!legalContract || !tronWeb.defaultAddress) {
                alertsDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>Not connected</h3>
                        <p>Please connect wallet and contract first</p>
                    </div>
                `;
                return;
            }
            
            try {
                alertsDiv.innerHTML = '<p><i class="fas fa-spinner loading-spinner"></i> Loading alerts...</p>';
                
                const notices = await getMyAlerts();
                
                // Count pending alerts
                const pendingAlerts = notices.filter(n => n.status == 0);
                
                // Update badge
                uiManager.updateBadge('user', pendingAlerts.length);
                
                if (notices.length === 0) {
                    alertsDiv.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-bell-slash"></i>
                            <h3>No alerts found</h3>
                            <p>You don't have any legal notice alerts</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="token-list">';
                for (const notice of notices) {
                    if (notice.status == 0) { // Only show pending notices as alerts
                        html += await renderAlertItem(notice);
                    }
                }
                html += '</div>';
                
                if (html === '<div class="token-list"></div>') {
                    alertsDiv.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <h3>All clear!</h3>
                            <p>No pending alerts - all notices have been handled</p>
                        </div>
                    `;
                } else {
                    alertsDiv.innerHTML = html;
                }
                
            } catch (error) {
                console.error('Error refreshing alerts:', error);
                alertsDiv.innerHTML = '<div class="alert alert-error">Error: ' + getErrorMessage(error) + '</div>';
            }
        }

        async function renderAlertItem(notice) {
            // Get preview image if available
            let previewHtml = '';
            try {
                if (notice.alertTokenId) {
                    const alert = await legalContract.alerts(notice.alertTokenId).call();
                    if (alert.previewImage) {
                        previewHtml = `
                            <div class="token-preview">
                                <img src="data:image/jpeg;base64,${alert.previewImage}" alt="Document preview">
                            </div>
                        `;
                    }
                }
            } catch (e) {
                console.log('No preview available');
            }
            
            return `
                <div class="token-item" style="border-color: var(--alert-color);">
                    <div class="token-item-header">
                        <div>
                            <strong style="color: var(--alert-color);">
                                <i class="fas fa-exclamation-triangle"></i> Legal Notice #${notice.id}
                            </strong>
                            <div style="font-size: 0.875rem;">
                                ${getDocumentTypeString(notice.documentType)}
                            </div>
                        </div>
                        <button class="btn btn-primary btn-small" onclick="openAcceptModal(${notice.id})">
                            <i class="fas fa-check"></i> Accept
                        </button>
                    </div>
                    <div class="token-details">
                        <div class="token-detail">
                            <span>From:</span>
                            ${createAddressDisplay(notice.server)}
                        </div>
                        <div class="token-detail">
                            <span>Date:</span>
                            <span>${new Date(parseInt(notice.timestamp) * 1000).toLocaleDateString()}</span>
                        </div>
                        <div class="token-detail">
                            <span>Jurisdiction:</span>
                            <span>${getJurisdictionString(notice.jurisdictionIndex)}</span>
                        </div>
                        <div class="token-detail">
                            <span>Time Remaining:</span>
                            <span>${getTimeRemaining(notice.timestamp)}</span>
                        </div>
                    </div>
                    ${previewHtml}
                </div>
            `;
        }

        async function refreshMyNotices() {
            // This function can be implemented to refresh the current user's notices
            // Similar to refreshMyAlerts but for owned notices
            try {
                const notices = await getMyNotices();
                
                // Update stats
                const stats = {
                    total: notices.length,
                    accepted: notices.filter(n => n.status == 2).length,
                    pending: notices.filter(n => n.status == 0).length,
                    servers: new Set(notices.map(n => n.server)).size
                };
                
                uiManager.updateStats(stats);
                
            } catch (error) {
                console.error('Error refreshing notices:', error);
            }
        }

        // Get notice and alert details
        async function getNoticeDetails(noticeId) {
            try {
                const notice = await legalContract.notices(noticeId).call();
                return {
                    id: noticeId,
                    recipient: notice.recipient,
                    server: notice.server,
                    ipfsHash: notice.ipfsHash,
                    contentHash: notice.contentHash,
                    timestamp: notice.timestamp,
                    caseNumberHash: notice.caseNumberHash,
                    alertTokenId: notice.alertTokenId,
                    jurisdictionIndex: notice.jurisdictionIndex,
                    documentType: notice.documentType,
                    status: notice.status
                };
            } catch (error) {
                console.error('Error getting notice details:', error);
                return null;
            }
        }

        async function getAlertDetails(alertId) {
            try {
                const alert = await legalContract.alerts(alertId).call();
                return {
                    id: alertId,
                    owner: alert.owner,
                    noticeId: alert.noticeId,
                    previewImage: alert.previewImage
                };
            } catch (error) {
                console.error('Error getting alert details:', error);
                return null;
            }
        }

        // Role management functions
        async function grantRole() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            const roleSelect = document.getElementById('roleSelect');
            const address = document.getElementById('roleAddress').value.trim();
            const feeExempt = document.getElementById('feeExemptCheck').checked;
            
            if (!address) {
                showAlert('roleResult', 'error', 'Please enter an address');
                return;
            }
            
            if (!tronWeb.isAddress(address)) {
                showAlert('roleResult', 'error', 'Invalid TRON address');
                return;
            }
            
            try {
                showProcessing('Granting role...');
                
                // Convert role string to bytes32
                const roleBytes = tronWeb.sha3(roleSelect.value);
                
                // Call the contract to grant the role
                await legalContract.grantRole(roleBytes, address).send({
                    feeLimit: 100_000_000,
                    callValue: 0,
                    shouldPollResponse: true
                });
                
                // If fee exemption is checked, set fee exemption
                if (feeExempt) {
                    showProcessing('Setting fee exemption...');
                    
                    await legalContract.setFeeExemption(address, true).send({
                        feeLimit: 100_000_000,
                        callValue: 0,
                        shouldPollResponse: true
                    });
                }
                
                hideProcessing();
                showAlert('roleResult', 'success', `Role ${roleSelect.options[roleSelect.selectedIndex].text} granted to ${formatAddress(address)}`);
                
                // Clear inputs
                document.getElementById('roleAddress').value = '';
                document.getElementById('feeExemptCheck').checked = false;
                
                // Add to recent activity
                addRecentActivity('role', 'Role granted', {
                    role: roleSelect.options[roleSelect.selectedIndex].text,
                    address: formatAddress(address),
                    feeExempt
                });
                
            } catch (error) {
                hideProcessing();
                console.error('Error granting role:', error);
                showAlert('roleResult', 'error', 'Failed to grant role: ' + getErrorMessage(error));
            }
        }

        async function checkRole() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            const roleSelect = document.getElementById('roleSelect');
            const address = document.getElementById('roleAddress').value.trim();
            
            if (!address) {
                showAlert('roleResult', 'error', 'Please enter an address');
                return;
            }
            
            if (!tronWeb.isAddress(address)) {
                showAlert('roleResult', 'error', 'Invalid TRON address');
                return;
            }
            
            try {
                // Convert role string to bytes32
                const roleBytes = tronWeb.sha3(roleSelect.value);
                
                // Call the contract to check the role
                const hasRole = await legalContract.hasRole(roleBytes, address).call();
                
                // Check fee exemption
                const isFeeExempt = await legalContract.feeExemptions(address).call();
                
                // Show result
                const roleName = roleSelect.options[roleSelect.selectedIndex].text;
                const exemptText = isFeeExempt ? ' and is fee exempt' : '';
                const resultMessage = hasRole ? 
                    `Address has ${roleName} role${exemptText}` : 
                    `Address does not have ${roleName} role`;
                
                showAlert('roleResult', hasRole ? 'success' : 'info', resultMessage);
                
            } catch (error) {
                console.error('Error checking role:', error);
                showAlert('roleResult', 'error', 'Failed to check role: ' + getErrorMessage(error));
            }
        }

        // Fee management functions
        async function loadCurrentFee() {
            if (!legalContract) return;
            
            try {
                let fee;
                let tokenSymbol;
                
                if (currentChainType === 'tron') {
                    fee = await legalContract.creationFee().call();
                    currentCreationFee = parseFloat(tronWeb.fromSun(fee));
                    tokenSymbol = 'TRX';
                } else {
                    fee = await legalContract.methods.creationFee().call();
                    currentCreationFee = parseFloat(web3Instance.utils.fromWei(fee, 'ether'));
                    tokenSymbol = CHAIN_CONFIG.evm[currentNetwork].nativeToken;
                }
                
                document.getElementById('currentCreationFee').textContent = `Current: ${currentCreationFee} ${tokenSymbol}`;
                document.getElementById('creationFee').value = currentCreationFee;
                
            } catch (error) {
                console.error('Error loading fee:', error);
            }
        }

        async function updateFee() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            const newFee = document.getElementById('creationFee').value;
            
            if (!newFee || isNaN(newFee) || newFee < 0) {
                showAlert('feeUpdateResult', 'error', 'Please enter a valid fee');
                return;
            }
            
            try {
                showProcessing('Updating fee...');
                
                // Convert to Sun (TRX smallest unit)
                const feeInSun = tronWeb.toSun(newFee);
                
                // Call the contract to update the fee
                await legalContract.updateFee(feeInSun).send({
                    feeLimit: 100_000_000,
                    callValue: 0,
                    shouldPollResponse: true
                });
                
                hideProcessing();
                showAlert('feeUpdateResult', 'success', `Fee updated to ${newFee} TRX`);
                
                // Reload current fee
                currentCreationFee = parseFloat(newFee);
                document.getElementById('currentCreationFee').textContent = `Current: ${newFee} TRX`;
                
                // Add to recent activity
                addRecentActivity('admin', 'Fee updated', {
                    oldFee: currentCreationFee,
                    newFee: newFee
                });
                
            } catch (error) {
                hideProcessing();
                console.error('Error updating fee:', error);
                showAlert('feeUpdateResult', 'error', 'Failed to update fee: ' + getErrorMessage(error));
            }
        }

        async function updateFeeCollector() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            const newCollector = document.getElementById('feeCollectorAddress').value.trim();
            
            if (!newCollector) {
                showAlert('feeCollectorResult', 'error', 'Please enter an address');
                return;
            }
            
            if (!tronWeb.isAddress(newCollector)) {
                showAlert('feeCollectorResult', 'error', 'Invalid TRON address');
                return;
            }
            
            try {
                showProcessing('Updating fee collector...');
                
                // Call the contract to update the fee collector
                await legalContract.updateFeeCollector(newCollector).send({
                    feeLimit: 100_000_000,
                    callValue: 0,
                    shouldPollResponse: true
                });
                
                hideProcessing();
                showAlert('feeCollectorResult', 'success', `Fee collector updated to ${formatAddress(newCollector)}`);
                
                // Clear input
                document.getElementById('feeCollectorAddress').value = '';
                
                // Add to recent activity
                addRecentActivity('admin', 'Fee collector updated', {
                    address: formatAddress(newCollector)
                });
                
            } catch (error) {
                hideProcessing();
                console.error('Error updating fee collector:', error);
                showAlert('feeCollectorResult', 'error', 'Failed to update fee collector: ' + getErrorMessage(error));
            }
        }

        async function updateResourceSponsorship() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            const enabled = document.getElementById('resourceSponsorshipCheck').checked;
            
            // First check current status
            try {
                const currentStatus = await legalContract.resourceSponsorshipEnabled().call();
                console.log('Current sponsorship status:', currentStatus);
                
                if (currentStatus === enabled) {
                    showAlert('contractManagementResult', 'info', `Resource sponsorship is already ${enabled ? 'enabled' : 'disabled'}`);
                    return;
                }
            } catch (e) {
                console.log('Could not check current status:', e);
            }
            
            try {
                showProcessing('Updating resource sponsorship...');
                console.log('Sending setResourceSponsorship transaction, enabled:', enabled);
                
                const tx = await legalContract.setResourceSponsorship(enabled).send({
                    feeLimit: 100_000_000,
                    callValue: 0,
                    shouldPollResponse: false // Don't auto-poll, we'll do it manually
                });
                
                console.log('Transaction sent, hash:', tx);
                showProcessing('Waiting for confirmation...');
                
                // Manual polling with timeout
                let confirmed = false;
                let attempts = 0;
                const maxAttempts = 20; // 20 seconds timeout
                
                while (!confirmed && attempts < maxAttempts) {
                    try {
                        const info = await tronWeb.trx.getTransactionInfo(tx);
                        if (info && info.id) {
                            confirmed = true;
                            console.log('Transaction confirmed:', info);
                        }
                    } catch (e) {
                        // Transaction not found yet, keep polling
                    }
                    
                    if (!confirmed) {
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second
                        attempts++;
                    }
                }
                
                hideProcessing();
                
                if (confirmed) {
                    showAlert('contractManagementResult', 'success', `Resource sponsorship ${enabled ? 'enabled' : 'disabled'}`);
                } else {
                    showAlert('contractManagementResult', 'warning', 'Transaction sent but confirmation timed out. Check TronScan for status.');
                }
                
            } catch (error) {
                hideProcessing();
                console.error('Error updating resource sponsorship:', error);
                showAlert('contractManagementResult', 'error', 'Failed to update: ' + getErrorMessage(error));
            }
        }

        // Contract connection functions
        async function connectContracts() {
            const contractAddress = document.getElementById('contractAddress').value.trim();
            
            if (!contractAddress) {
                showAlert('contractStatus', 'error', 'Please enter the contract address');
                return;
            }
            
            if (currentChainType === 'tron') {
                if (!tronWeb || !tronWeb.defaultAddress) {
                    showAlert('contractStatus', 'error', 'Please connect your wallet first');
                    return;
                }
                
                if (!tronWeb.isAddress(contractAddress)) {
                    showAlert('contractStatus', 'error', 'Invalid TRON address');
                    return;
                }
            } else {
                if (!web3Instance) {
                    showAlert('contractStatus', 'error', 'Please connect your wallet first');
                    return;
                }
                
                if (!web3Instance.utils.isAddress(contractAddress)) {
                    showAlert('contractStatus', 'error', 'Invalid Ethereum address');
                    return;
                }
            }
            
            try {
                showAlert('contractStatus', 'info', '<i class="fas fa-spinner loading-spinner"></i> Connecting to contract...');
                
                // Create contract instance based on chain type
                if (currentChainType === 'tron') {
                    legalContract = await tronWeb.contract(CONTRACT_ABI, contractAddress);
                    window.legalContract = legalContract;
                } else {
                    evmContract = new web3Instance.eth.Contract(CONTRACT_ABI, contractAddress);
                    legalContract = evmContract; // Use same variable for compatibility
                    window.legalContract = evmContract;
                }
                
                // Update UI
                document.getElementById('contractsStatus').style.display = 'flex';
                document.getElementById('legalContractShort').innerHTML = createAddressDisplay(contractAddress);
                
                // Enable role management buttons
                document.getElementById('grantRoleBtn').disabled = false;
                document.getElementById('checkRoleBtn').disabled = false;
                
                // Check user roles
                await checkUserRoles();
                
                // Load current fee
                await loadCurrentFee();
                
                // Hide contract management card
// Update the card to show connection status instead of hiding it
const connectBtn = document.getElementById('connectContractBtn');
connectBtn.innerHTML = '<i class="fas fa-check"></i> Connected';
connectBtn.classList.remove('btn-primary');
connectBtn.classList.add('btn-success');
connectBtn.disabled = true;

// Disable the input field but keep it visible
document.getElementById('contractAddress').disabled = true;

// Add a disconnect button
const disconnectBtn = document.createElement('button');
disconnectBtn.className = 'btn btn-secondary';
disconnectBtn.style.marginLeft = '0.5rem';
disconnectBtn.innerHTML = '<i class="fas fa-unlink"></i> Disconnect';
disconnectBtn.onclick = function() {
    // Reset contract connection
    legalContract = null;
    document.getElementById('contractsStatus').style.display = 'none';
    document.getElementById('contractAddress').disabled = false;
    
    // Reset buttons
    connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect Contract';
    connectBtn.classList.remove('btn-success');
    connectBtn.classList.add('btn-primary');
    connectBtn.disabled = false;
    
    // Remove disconnect button
    this.remove();
    
    // Reset role flags
    isAdmin = false;
    isProcessServer = false;
    
    // Hide server ID display
    document.getElementById('serverIdDisplay').style.display = 'none';
    
    // Show registration notice if needed
    document.getElementById('registrationNotice').style.display = 'flex';
    
    // Clear any status messages
    document.getElementById('contractStatus').innerHTML = '';
    
    // Update UI elements that depend on roles
    document.getElementById('updateFeeBtn').disabled = true;
    document.getElementById('updateFeeCollectorBtn').disabled = true;
    document.getElementById('grantRoleBtn').disabled = true;
    document.getElementById('checkRoleBtn').disabled = true;
    
    uiManager.showNotification('info', 'Contract disconnected');
};

// Add the disconnect button next to connect button
connectBtn.parentNode.insertBefore(disconnectBtn, connectBtn.nextSibling);

showAlert('contractStatus', 'success', 'Contract connected successfully!');

// Auto-refresh alerts if user has process server role
if (isProcessServer || isAdmin) {
    setTimeout(() => refreshMyAlerts(), 1000);
}

} catch (error) {
    console.error('Contract connection error:', error);
    showAlert('contractStatus', 'error', 'Failed to connect to contract: ' + getErrorMessage(error));
}
}

// Check user roles
async function checkUserRoles() {
    if (!legalContract || !tronWeb.defaultAddress) return;
    
    try {
                const adminRoleBytes = tronWeb.sha3('ADMIN_ROLE');
                const processServerRoleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                
                isAdmin = await legalContract.hasRole(adminRoleBytes, tronWeb.defaultAddress.base58).call();
                isProcessServer = await legalContract.hasRole(processServerRoleBytes, tronWeb.defaultAddress.base58).call();
                
                // Enable admin-only buttons if user is admin
                document.getElementById('updateFeeBtn').disabled = !isAdmin;
                document.getElementById('updateFeeCollectorBtn').disabled = !isAdmin;
                
                // Update UI based on roles
                if (!isProcessServer && !isAdmin) {
                    document.getElementById('registrationNotice').style.display = 'flex';
                } else {
                    document.getElementById('registrationNotice').style.display = 'none';
                }
                
                // Show server ID if assigned
                if (isProcessServer || isAdmin) {
                    // For now, show a placeholder ID
                    document.getElementById('userServerId').textContent = '01';
                    document.getElementById('serverIdDisplay').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error checking roles:', error);
            }
        }

        // Transaction modal
        function showTxModal(txHash, message, details = '') {
            const modal = document.getElementById('txModal');
            const txHashElement = document.getElementById('txHash');
            const txMessage = document.getElementById('txMessage');
            const txLink = document.getElementById('txLink');
            const txDetails = document.getElementById('txDetails');
            
            txMessage.textContent = message || 'Your transaction has been successfully confirmed!';
            txHashElement.textContent = txHash;
            txDetails.innerHTML = details;
            
            // Get network for Tronscan link
            const network = document.getElementById('networkName').textContent;
            let tronscanUrl = 'https://tronscan.org/#/transaction/';
            
            if (network.includes('Nile')) {
                tronscanUrl = 'https://nile.tronscan.org/#/transaction/';
            } else if (network.includes('Shasta')) {
                tronscanUrl = 'https://shasta.tronscan.org/#/transaction/';
            }
            
            txLink.href = tronscanUrl + txHash;
            modal.style.display = 'block';
        }

        function copyTxHash() {
            const txHashElement = document.getElementById('txHash');
            const txHash = txHashElement.textContent;
            
            navigator.clipboard.writeText(txHash).then(() => {
                uiManager.showNotification('success', 'Transaction hash copied to clipboard');
            }).catch(err => {
                console.error('Failed to copy:', err);
                uiManager.showNotification('error', 'Failed to copy transaction hash');
            });
        }

        function viewContractOnTronscan(type) {
            let address;
            if (type === 'legal') {
                address = document.getElementById('contractAddress').value;
            }
            
            if (!address) {
                uiManager.showNotification('error', 'No contract address available');
                return;
            }
            
            const config = CHAIN_CONFIG[currentChainType][currentNetwork];
            let explorerUrl;
            
            if (currentChainType === 'tron') {
                explorerUrl = `${config.explorerUrl}/#/contract/${address}`;
            } else {
                explorerUrl = `${config.explorerUrl}/address/${address}`;
            }
            
            window.open(explorerUrl, '_blank');
        }

        function viewOnTronscan(type, id) {
            const network = document.getElementById('networkName').textContent;
            let tronscanUrl;
            
            if (type === 'notice') {
                const contractAddress = document.getElementById('contractAddress').value;
                
                if (network.includes('Nile')) {
                    tronscanUrl = `https://nile.tronscan.org/#/token721/${contractAddress}/token/${id}`;
                } else if (network.includes('Shasta')) {
                    tronscanUrl = `https://shasta.tronscan.org/#/token721/${contractAddress}/token/${id}`;
                } else {
                    tronscanUrl = `https://tronscan.org/#/token721/${contractAddress}/token/${id}`;
                }
            } else {
                if (network.includes('Nile')) {
                    tronscanUrl = `https://nile.tronscan.org/#/transaction/${id}`;
                } else if (network.includes('Shasta')) {
                    tronscanUrl = `https://shasta.tronscan.org/#/transaction/${id}`;
                } else {
                    tronscanUrl = `https://tronscan.org/#/transaction/${id}`;
                }
            }
            
            window.open(tronscanUrl, '_blank');
        }

        function viewOnIPFS(ipfsHash) {
            // Use a public IPFS gateway
            const ipfsUrl = `https://ipfs.io/ipfs/${ipfsHash}`;
            window.open(ipfsUrl, '_blank');
        }

        // Recent activity functions
        function addRecentActivity(type, description, details = {}) {
            const activity = {
                type,
                description,
                details,
                timestamp: new Date()
            };
            
            recentActivity.unshift(activity);
            
            // Keep only last 10 activities
            if (recentActivity.length > 10) {
                recentActivity = recentActivity.slice(0, 10);
            }
            
            updateRecentActivityDisplay();
        }

        function updateRecentActivityDisplay() {
            const activityDiv = document.getElementById('recentActivityContent');
            
            if (recentActivity.length === 0) {
                activityDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard"></i>
                        <h3>No recent activity</h3>
                        <p>Your recent transactions will appear here</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="token-list">';
            
            recentActivity.forEach(activity => {
                const icon = getActivityIcon(activity.type);
                const timeAgo = getTimeAgo(activity.timestamp);
                
                html += `
                    <div class="token-item" style="padding: 0.75rem 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <i class="${icon}" style="color: var(--accent-blue); font-size: 1.25rem;"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${escapeHtml(activity.description)}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${timeAgo}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            activityDiv.innerHTML = html;
        }

        function getActivityIcon(type) {
            const icons = {
                'create': 'fas fa-file-upload',
                'accept': 'fas fa-check-circle',
                'registration': 'fas fa-user-plus',
                'approval': 'fas fa-user-check',
                'role': 'fas fa-user-shield',
                'admin': 'fas fa-cog'
            };
            
            return icons[type] || 'fas fa-circle';
        }

        // Helper functions
        function formatAddress(address) {
            if (!address) return 'N/A';
            return address.substring(0, 8) + '...' + address.substring(address.length - 6);
        }
        
        // Get current network based on chain type
        function getCurrentNetwork() {
            // For TRON, we're using Nile testnet by default
            // You could add logic here to detect mainnet vs testnet
            return 'nile';
        }
        
        // Create address display with copy and TronScan link
        function createAddressDisplay(address, showFull = false) {
            if (!address || address === 'N/A') return 'N/A';
            
            const displayAddress = showFull ? address : formatAddress(address);
            const network = currentChainType === 'tron' ? getCurrentNetwork() : 'mainnet';
            const explorerUrl = CHAIN_CONFIG[currentChainType][network].explorerUrl;
            
            return `
                <span class="address-display">
                    <span class="address-text">${displayAddress}</span>
                    <button class="btn-icon-small" onclick="copyAddress('${address}')" title="Copy address">
                        <i class="fas fa-copy"></i>
                    </button>
                    <a href="${explorerUrl}/#/address/${address}" target="_blank" class="btn-icon-small" title="View on explorer">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </span>
            `;
        }
        
        // Copy address to clipboard
        function copyAddress(address) {
            navigator.clipboard.writeText(address).then(() => {
                uiManager.showNotification('success', 'Address copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                uiManager.showNotification('error', 'Failed to copy address');
            });
        }

        function getDocumentTypeString(docType) {
            const documentTypes = [
                'Summons',
                'Complaint',
                'Subpoena',
                'Notice of Hearing',
                'Notice of Seizure',
                'Other'
            ];
            return documentTypes[docType] || 'Unknown';
        }

        function getJurisdictionString(jurisdictionIndex) {
            const jurisdictions = [
                'Federal',
                'State',
                'County',
                'Municipal',
                'Other'
            ];
            return jurisdictions[jurisdictionIndex] || 'Unknown';
        }

        function getStatusString(status) {
            const statuses = [
                'Pending',
                'Served',
                'Accepted',
                'Expired',
                'Cancelled'
            ];
            return statuses[status] || 'Unknown';
        }

        function getTimeRemaining(timestamp) {
            const created = new Date(parseInt(timestamp) * 1000);
            const expires = new Date(created.getTime() + (7 * 24 * 60 * 60 * 1000)); // 7 days
            const now = new Date();
            
            if (now > expires) {
                return '<span style="color: var(--error);">Expired</span>';
            }
            
            const diff = expires - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            if (days > 0) {
                return `${days} day${days > 1 ? 's' : ''} ${hours} hour${hours > 1 ? 's' : ''}`;
            } else if (hours > 0) {
                return `${hours} hour${hours > 1 ? 's' : ''}`;
            } else {
                return '<span style="color: var(--warning);">Less than 1 hour</span>';
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function calculateBase64Size(base64String) {
            // Calculate approximate size of base64 string
            const padding = (base64String.charAt(base64String.length - 2) === '=') ? 2 :
                           (base64String.charAt(base64String.length - 1) === '=') ? 1 : 0;
            return (base64String.length * 3) / 4 - padding;
        }

        function getErrorMessage(error) {
            if (error.message) {
                if (error.message.includes('revert')) {
                    const revertReason = error.message.split('revert')[1].trim();
                    return 'Transaction reverted: ' + revertReason;
                } else if (error.message.includes('User rejected')) {
                    return 'Transaction cancelled by user';
                } else if (error.message.includes('insufficient')) {
                    return 'Insufficient balance or energy';
                } else if (error.message.includes('Not authorized')) {
                    return 'You need Process Server role to perform this action';
                } else {
                    return error.message;
                }
            }
            return 'An unknown error occurred';
        }

        // Copy wallet address function
        function copyWalletAddress() {
            const address = tronWeb.defaultAddress.base58;
            navigator.clipboard.writeText(address).then(() => {
                uiManager.showNotification('success', 'Address copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                uiManager.showNotification('error', 'Failed to copy address');
            });
        }

        // Validation functions
        function validateRecipientAddress() {
            const input = document.getElementById('mintRecipient');
            const validationMsg = document.getElementById('recipientValidation');
            const address = input.value.trim();
            
            if (!address) {
                input.classList.remove('valid', 'invalid');
                validationMsg.style.display = 'none';
                return;
            }
            
            if (tronWeb.isAddress(address)) {
                input.classList.remove('invalid');
                input.classList.add('valid');
                validationMsg.className = 'validation-message success';
                validationMsg.innerHTML = '<i class="fas fa-check-circle"></i> Valid TRON address';
                validationMsg.style.display = 'flex';
            } else {
                input.classList.remove('valid');
                input.classList.add('invalid');
                validationMsg.className = 'validation-message error';
                validationMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Invalid TRON address';
                validationMsg.style.display = 'flex';
            }
        }

        // Initialize when document is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Hide loader
            setTimeout(() => {
                uiManager.hideLoader();
            }, 500);
            
            // Check if TronWeb is available
            if (window.tronWeb && window.tronWeb.ready) {
                connectWallet();
            }
            
          // Add input validation
const recipientInput = document.getElementById('mintRecipient');
if (recipientInput) {
    recipientInput.addEventListener('input', validateRecipientAddress);
}

// Initialize admin panel inputs properly
setTimeout(() => {
    // Add role address validation
    const roleAddressInput = document.getElementById('roleAddress');
    if (roleAddressInput) {
        // Ensure input is interactive
        roleAddressInput.style.pointerEvents = 'auto';
        roleAddressInput.style.userSelect = 'text';
        roleAddressInput.disabled = false;
        roleAddressInput.readOnly = false;
        
        roleAddressInput.addEventListener('input', function(e) {
            const address = e.target.value.trim();
            if (address && tronWeb && !tronWeb.isAddress(address)) {
                e.target.classList.add('invalid');
                e.target.classList.remove('valid');
            } else if (address) {
                e.target.classList.add('valid');
                e.target.classList.remove('invalid');
            } else {
                e.target.classList.remove('valid', 'invalid');
            }
        });
    }

    // Add fee collector address validation
    const feeCollectorInput = document.getElementById('feeCollectorAddress');
    if (feeCollectorInput) {
        // Ensure input is interactive
        feeCollectorInput.style.pointerEvents = 'auto';
        feeCollectorInput.style.userSelect = 'text';
        feeCollectorInput.disabled = false;
        feeCollectorInput.readOnly = false;
        
        feeCollectorInput.addEventListener('input', function(e) {
            const address = e.target.value.trim();
            if (address && tronWeb && !tronWeb.isAddress(address)) {
                e.target.classList.add('invalid');
                e.target.classList.remove('valid');
            } else if (address) {
                e.target.classList.add('valid');
                e.target.classList.remove('invalid');
            } else {
                e.target.classList.remove('valid', 'invalid');
            }
        });
    }
    
    // Fix creation fee input
    const creationFeeInput = document.getElementById('creationFee');
    if (creationFeeInput) {
        creationFeeInput.style.pointerEvents = 'auto';
        creationFeeInput.style.userSelect = 'text';
        creationFeeInput.disabled = false;
        creationFeeInput.readOnly = false;
    }
    
    // Also ensure all form inputs in the admin panel are interactive
    const adminInputs = document.querySelectorAll('#adminTab .form-input');
    adminInputs.forEach(input => {
        input.style.pointerEvents = 'auto';
        input.style.userSelect = 'text';
        input.style.webkitUserSelect = 'text';
        input.disabled = false;
        input.readOnly = false;
    });
    
    console.log('Input fields initialized without replacement');
}, 100);
            
            // Add drag and drop support for file upload
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, () => {
                        uploadArea.classList.add('drag-over');
                    }, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, () => {
                        uploadArea.classList.remove('drag-over');
                    }, false);
                });
                
                uploadArea.addEventListener('drop', function(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    if (files.length > 0) {
                        document.getElementById('documentUpload').files = files;
                        handleDocumentUpload({ target: { files: files } });
                    }
                }, false);
            }
        });

       // Keyboard event handling for modals
document.addEventListener('keydown', function(event) {
    // Don't interfere with input fields
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
        return; // Let the input handle the event normally
    }
    
    if (event.key === 'Escape') {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            }
        });
    }
});

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // Make functions available globally
        window.connectWallet = connectWallet;
        window.switchTab = switchTab;
        window.openRegistrationModal = openRegistrationModal;
        window.closeRegistrationModal = closeRegistrationModal;
        window.closeRegistrationSuccessModal = closeRegistrationSuccessModal;
        window.dismissRegistrationNotice = dismissRegistrationNotice;
        window.submitRegistration = submitRegistration;
        window.refreshPendingRegistrations = refreshPendingRegistrations;
        window.approveRegistration = approveRegistration;
        window.openMintModal = openMintModal;
        window.closeMintModal = closeMintModal;
        window.showMintStep = showMintStep;
        window.changeDocument = changeDocument;
        window.handleDocumentUpload = handleDocumentUpload;
        window.createLegalNotice = createLegalNotice;
        window.openAuditModal = openAuditModal;
        window.closeAuditModal = closeAuditModal;
        window.openAcceptModal = openAcceptModal;
        window.closeAcceptModal = closeAcceptModal;
        window.acceptNotice = acceptNotice;
        window.closeTxModal = closeTxModal;
        window.updateAuditSearch = updateAuditSearch;
        window.performAudit = performAudit;
        window.refreshMyAlerts = refreshMyAlerts;
        window.copyTxHash = copyTxHash;
        window.viewContractOnTronscan = viewContractOnTronscan;
        window.viewOnTronscan = viewOnTronscan;
        window.viewOnIPFS = viewOnIPFS;
        window.grantRole = grantRole;
        window.checkRole = checkRole;
        window.updateFee = updateFee;
        window.updateFeeCollector = updateFeeCollector;
        window.updateResourceSponsorship = updateResourceSponsorship;
        window.connectContracts = connectContracts;
	window.copyWalletAddress = copyWalletAddress;
	window.copyAddress = copyAddress;
	window.useConnectedAddress = useConnectedAddress;
	window.useConnectedAddressForFeeCollector = useConnectedAddressForFeeCollector;
	window.uiManager = uiManager;
	window.handleChainChange = handleChainChange;
    </script>
</body>
</html>