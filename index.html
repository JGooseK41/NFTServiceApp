<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LegalNotice - Blockchain Legal Document Service</title>
    <meta name="description" content="Secure multi-chain blockchain legal document service supporting TRON, Ethereum, Polygon, and BSC">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pica/9.0.1/pica.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@4.3.0/dist/web3.min.js"></script>
    <script src="config.js"></script>
    <!-- Document conversion libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="js/documentConverter.js"></script>
    <!-- Simplified Encryption (no registration needed) -->
    <script src="js/simple-encryption.js"></script>
    <script src="js/simplified-integration.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-dark: #0a0a0a;
            --primary-navy: #111111;
            --secondary-navy: #1a1a1a;
            --accent-blue: #0ea5e9;
            --accent-light: #38bdf8;
            --text-primary: #ffffff;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --border-color: #262626;
            --card-bg: #141414;
            --hover-bg: #1f1f1f;
            --alert-color: #0ea5e9;
            --gray-800: #1f2937;
            --gray-700: #374151;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--primary-dark);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* Loader */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-navy) 0%, var(--secondary-navy) 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .logo:hover {
            transform: translateY(-1px);
        }

        .logo i {
            font-size: 2rem;
            color: var(--accent-blue);
            animation: pulse 2s infinite;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .contract-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.75rem;
            position: relative;
            overflow: hidden;
        }
        
        .contract-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(14, 165, 233, 0.2), transparent);
            animation: shimmer 3s infinite;
        }
        
        .contract-indicator span:first-child {
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .contract-indicator span:nth-child(2) {
            color: var(--accent-light);
            font-family: monospace;
        }
        
        .btn-icon {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
        }
        
        .btn-icon:hover {
            color: var(--accent-blue);
            background: rgba(14, 165, 233, 0.1);
        }
        
        .btn-icon-small {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.125rem 0.25rem;
            font-size: 0.875rem;
            transition: color 0.3s ease;
            margin-left: 0.25rem;
        }
        
        .btn-icon-small:hover {
            color: var(--accent-blue);
        }
        
        .address-display {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .address-text {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }

        .chain-selector {
            margin-right: 1rem;
        }

        .chain-dropdown {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chain-dropdown:hover {
            border-color: var(--accent-blue);
        }

        .chain-dropdown:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .chain-dropdown optgroup {
            background: var(--primary-navy);
            color: var(--text-secondary);
            font-weight: 600;
        }

        .chain-dropdown option {
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 0.5rem;
        }

        .network-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            color: var(--accent-light);
            font-size: 0.75rem;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .network-indicator.connected {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .network-indicator.connected i {
            color: var(--success);
        }

        .wallet-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .wallet-address {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .main-container {
            margin-top: 80px;
            padding: 2rem;
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
            animation: fadeIn 0.5s ease;
        }

        /* Welcome Section */
        .welcome-section {
            text-align: center;
            padding: 3rem 0;
            margin-bottom: 2rem;
            animation: slideIn 0.5s ease;
        }

        .welcome-section h2 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-section p {
            font-size: 1.125rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Stats Section */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stats-header:hover {
            background: rgba(255, 255, 255, 0.05) !important;
        }
        
        #walletStatusHeader:hover,
        #contractHeader:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        /* Make entire header clickable */
        #walletStatusHeader,
        #contractHeader,
        .stats-header {
            user-select: none;
            -webkit-user-select: none;
            position: relative;
        }
        
        /* Add active state for better feedback */
        #walletStatusHeader:active,
        #contractHeader:active,
        .stats-header:active {
            background: rgba(255, 255, 255, 0.08) !important;
        }
        
        #walletStatusHeader h2,
        #contractHeader h2,
        .stats-header h3 {
            pointer-events: none;
        }
        
        #walletToggleIcon,
        #contractToggleIcon,
        #statsToggleIcon {
            pointer-events: none;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-light));
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .stat-card:hover::before {
            transform: translateX(0);
        }

        .stat-card i {
            font-size: 2rem;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .tab-navigation {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            font-size: 0.938rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-button:hover {
            color: var(--text-primary);
        }

        .tab-button.active {
            color: var(--accent-blue);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-blue);
            animation: slideIn 0.3s ease;
        }

        .tab-button .badge {
            background: var(--accent-blue);
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            margin-left: 0.5rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(14, 165, 233, 0.1), transparent);
            transition: all 0.5s ease;
            transform: translate(-50%, -50%);
        }

        .card:hover::before {
            width: 100%;
            height: 100%;
        }

        .card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(14, 165, 233, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-header i {
            font-size: 1.25rem;
            color: var(--accent-blue);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1.5rem;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .action-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(14, 165, 233, 0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
            transform: rotate(45deg);
        }

        .action-card:hover::before {
            opacity: 1;
        }

        .action-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-blue);
            box-shadow: 0 12px 32px rgba(59, 130, 246, 0.2);
        }

        .action-card.primary {
            border-color: var(--accent-blue);
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(59, 130, 246, 0.1) 100%);
        }

        .action-card i {
            font-size: 3rem;
            color: var(--accent-blue);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .action-card:hover i {
            transform: scale(1.1);
        }

        .action-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .action-card p {
            color: var(--text-secondary);
            font-size: 0.938rem;
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-navy);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--hover-bg);
            border-color: var(--accent-blue);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--primary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.2s ease;
	    pointer-events: auto !important;
            user-select: text !important;
            -webkit-user-select: text !important;
        }
/* Specifically target admin panel inputs */
#adminTab .form-input {
    pointer-events: auto !important;
    user-select: text !important;
    -webkit-user-select: text !important;
    cursor: text !important;
}

/* Ensure inputs are not disabled by parent elements */
#adminContent * {
    pointer-events: auto !important;
}

/* Fix for any potential z-index issues */
#adminTab .card {
    position: relative;
    z-index: 1;
}

#adminTab .form-input {
    position: relative;
    z-index: 2;
}
        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Highlight empty required fields */
        .form-input:placeholder-shown {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Normal styling for filled fields */
        .form-input:not(:placeholder-shown) {
            background: var(--primary-dark);
            border-color: var(--border-color);
        }
        
        /* Required field indicator for empty fields */
        .form-input:required:placeholder-shown {
            background: rgba(245, 158, 11, 0.05);
            border-color: rgba(245, 158, 11, 0.3);
        }
        
        /* Success indicator for filled required fields */
        .form-input:required:not(:placeholder-shown):valid {
            border-color: rgba(16, 185, 129, 0.3);
        }
        
        /* Make textarea follow same pattern */
        textarea.form-input:placeholder-shown {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        textarea.form-input:not(:placeholder-shown) {
            background: var(--primary-dark);
            border-color: var(--border-color);
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            color: var(--text-primary);
        }

        /* Custom checkbox */
        input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background: var(--primary-dark);
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        input[type="checkbox"]:checked {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        input[type="checkbox"]:checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .status-complete {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }
        
        .status-badge.success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }
        
        .status-badge.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }
        
        .status-badge.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .token-list {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .token-item {
            padding: 1rem;
            background: var(--primary-dark);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .token-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent-blue), transparent);
            animation: scan 3s infinite;
        }

        .token-item:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .token-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .token-details {
            display: grid;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .token-detail {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
        }

        .token-preview {
            margin-top: 1rem;
            text-align: center;
        }

        .token-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }

        .token-preview img:hover {
            transform: scale(1.05);
        }

        .notification-banner {
            background: rgba(14, 165, 233, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideIn 0.5s ease;
        }

        .notification-banner i {
            color: var(--accent-blue);
            font-size: 1.25rem;
            animation: pulse 2s infinite;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 0;
                margin: 0;
            }
            
            .container {
                padding: 0.5rem;
                margin: 0;
                max-width: 100%;
            }
            
            .header {
                padding: 1rem 0.5rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .header-content {
                flex-direction: column;
                align-items: center;
                gap: 1rem;
                width: 100%;
            }
            
            .header-controls {
                width: 100%;
                justify-content: center;
            }
            
            .chain-selector {
                width: 100%;
            }
            
            .chain-dropdown {
                width: 100%;
                font-size: 0.9rem;
            }
            
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0 0.5rem;
            }
            
            .tab-buttons {
                min-width: max-content;
                gap: 0.25rem;
            }
            
            .tab-button {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
                white-space: nowrap;
            }
            
            .card {
                margin: 0.5rem 0;
                border-radius: 12px;
            }
            
            .card-header {
                padding: 1rem;
                font-size: 1.1rem;
            }
            
            .card-header h2 {
                font-size: 1.1rem;
            }
            
            .form-group {
                margin-bottom: 1rem;
            }
            
            .form-label {
                font-size: 0.875rem;
            }
            
            .form-input, .form-select, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 0.75rem;
            }
            
            .btn {
                padding: 0.75rem 1.5rem;
                font-size: 0.875rem;
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .btn-small {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
            
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 1rem;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            .info-grid, .wallet-info-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .stats-card {
                min-width: 100%;
            }
            
            .notification {
                right: 0.5rem;
                left: 0.5rem;
                max-width: none;
            }
            
            .document-upload-area {
                padding: 2rem 1rem;
            }
            
            .address-input-group {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .address-input-group input {
                width: 100%;
            }
            
            .address-input-group button {
                width: 100%;
            }
            
            .token-detail {
                flex-direction: column;
                gap: 0.25rem;
                font-size: 0.875rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }
            
            .stat-item {
                padding: 0.75rem;
            }
            
            /* Mobile-specific utility classes */
            .mobile-only {
                display: block !important;
            }
            
            .desktop-only {
                display: none !important;
            }
        }

        
        
        /* Analytics Dashboard Styles */
        .analytics-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            background: var(--accent-blue);
            color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        .analytics-charts {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .chart-container {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
        }
        
        .chart-container h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .recent-activity {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
        }
        
        .recent-activity h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .activity-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-info {
            flex: 1;
        }
        
        .activity-type {
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .activity-details {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        .activity-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        @media (max-width: 768px) {
            .analytics-charts {
                grid-template-columns: 1fr;
            }
        }

        /* Notification System Styles */
        .notification-bell {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }
        
        .notification-bell-btn {
            position: relative;
            width: 56px;
            height: 56px;
            background: var(--accent-blue);
            color: white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }
        
        .notification-bell-btn:hover {
            transform: scale(1.1);
        }
        
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--error);
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        
        .notification-panel {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 320px;
            max-height: 400px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 999;
            display: flex;
            flex-direction: column;
        }
        
        .notification-panel-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-panel-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .notification-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .notification-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .notification-item:hover {
            background: var(--bg-hover);
        }
        
        .notification-item.unread {
            border-left: 3px solid var(--accent-blue);
        }
        
        .notification-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }
        
        .notification-item-title {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .notification-item-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .notification-item-body {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .notification-panel-footer {
            padding: 0.75rem;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .notification-bell {
                bottom: 1rem;
                right: 1rem;
            }
            
            .notification-panel {
                right: 1rem;
                left: 1rem;
                width: auto;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .processing-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem 3rem;
            text-align: center;
            border: 1px solid var(--accent-blue);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        .processing-card i {
            font-size: 3rem;
            color: var(--accent-blue);
            margin-bottom: 1rem;
        }

        .processing-card h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .processing-card p {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: relative;
            max-width: 800px;
            margin: 5% auto;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            animation: slideIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            padding: 0.25rem;
            border-radius: 4px;
        }

        .modal-close:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .alert {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--error);
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: var(--accent-light);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--warning);
        }

        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            background: var(--primary-dark);
        }

        .upload-area:hover {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
        }

        .upload-area.active {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .upload-area.drag-over {
            border-color: var(--accent-blue);
            background: rgba(14, 165, 233, 0.05);
            transform: scale(1.02);
        }

        .upload-area.processing {
            pointer-events: none;
            opacity: 0.8;
        }

        .upload-area.error {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--accent-blue);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .upload-area:hover .upload-icon {
            transform: translateY(-5px);
        }

        .upload-area.drag-over .upload-icon {
            animation: bounce 1s infinite;
        }

        .upload-area input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.01; /* Changed from 0 to 0.01 for better browser support */
            cursor: pointer;
            z-index: 10; /* Ensure it's on top */
        }

        .preview-container {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
        }

        .preview-image {
            flex: 0 0 200px;
            text-align: center;
        }

        .preview-image img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .preview-details {
            flex: 1;
        }

        .tx-details {
            background: var(--primary-dark);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid var(--border-color);
        }

        .tx-hash {
            font-family: 'Inter', monospace;
            font-size: 0.875rem;
            word-break: break-all;
            color: var(--accent-light);
            margin: 0.5rem 0;
            background: var(--hover-bg);
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }
        
        /* Enhanced transaction modal styles */
        #txModal .modal-content {
            max-width: 700px;
        }
        
        #txModal .token-details {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        #txModal .btn {
            min-width: 140px;
            justify-content: center;
        }
        
        #txModal img {
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        #txModal img:hover {
            transform: scale(1.02);
        }

        .server-id-display {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--primary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-weight: 600;
            color: var(--accent-blue);
            animation: slideIn 0.5s ease;
        }

        /* Enhanced form validation styles */
        .form-input.invalid {
            border-color: var(--error);
            animation: shake 0.3s ease;
        }

        .form-input.valid {
            border-color: var(--success);
        }

        .validation-message {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            animation: slideIn 0.3s ease;
        }

        .validation-message.error {
            color: var(--error);
        }

        .validation-message.warning {
            color: var(--warning);
        }

        .validation-message.success {
            color: var(--success);
        }

        /* Upload metadata */
        .upload-metadata {
            background: var(--primary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .upload-metadata h5 {
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
            font-size: 0.938rem;
        }

        .upload-metadata .metadata-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .upload-metadata .metadata-item strong {
            color: var(--text-primary);
        }

        /* Compression status */
        .compression-status {
            background: var(--primary-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .compression-status.active {
            border-color: var(--accent-blue);
        }

        .compression-progress {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-blue);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.5);
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            min-width: 50px;
            text-align: right;
        }

        /* Notification system */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            min-width: 300px;
            max-width: 500px;
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 9999;
            transition: all 0.3s ease;
            transform: translateX(400px);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
        }

        .notification-enter {
            transform: translateX(400px);
        }

        .notification-active {
            transform: translateX(0);
        }

        .notification-exit {
            transform: translateX(400px);
            opacity: 0;
        }

        .notification-success {
            background: rgba(16, 185, 129, 0.9);
            color: white;
            border: 1px solid rgba(16, 185, 129, 1);
        }

        .notification-error {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: 1px solid rgba(239, 68, 68, 1);
        }

        .notification-warning {
            background: rgba(245, 158, 11, 0.9);
            color: white;
            border: 1px solid rgba(245, 158, 11, 1);
        }

        .notification-info {
            background: rgba(59, 130, 246, 0.9);
            color: white;
            border: 1px solid rgba(59, 130, 246, 1);
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.25rem;
            margin-left: auto;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .notification-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Empty states */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.125rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        /* Delivery Options Styles */
        .delivery-options {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .delivery-option {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            background: var(--card-bg);
        }
        
        .delivery-option:hover {
            border-color: var(--accent-blue);
            background: var(--hover-bg);
        }
        
        .delivery-option.selected {
            border-color: var(--accent-blue);
            background: rgba(14, 165, 233, 0.1);
        }
        
        .delivery-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }
        
        .delivery-option-title {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .delivery-option-cost {
            color: var(--success);
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .delivery-option-desc {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        
        .text-notice-input {
            display: none;
            margin-top: 15px;
        }
        
        .text-notice-input.active {
            display: block;
        }
        
        .text-notice-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .text-notice-input input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 0.938rem;
            transition: all 0.2s ease;
        }

        .text-notice-input input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        .text-notice-input .char-count {
            text-align: right;
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .text-notice-input .char-count.warning {
            color: var(--warning);
        }

        .text-notice-input .char-count.error {
            color: var(--error);
        }

        /* Delivery Status Styles */
        .delivery-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .delivery-status.pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .delivery-status.delivered {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .delivery-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .delivery-item:hover {
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }
        
        .delivery-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .delivery-item-id {
            font-family: monospace;
            color: var(--accent-blue);
            font-size: 0.875rem;
        }
        
        .delivery-item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            font-size: 0.875rem;
        }
        
        .delivery-detail {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .delivery-detail-label {
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        
        .delivery-detail-value {
            color: var(--text-primary);
        }
        
        .delivery-timeline {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .timeline-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }
        
        .timeline-icon.sent {
            background: var(--accent-blue);
            color: white;
        }
        
        .timeline-icon.delivered {
            background: var(--success);
            color: white;
        }
        
        .timeline-icon.pending {
            background: var(--gray-700);
            color: var(--text-muted);
        }
        
        /* FAQ Styles */
        .process-steps {
            margin: 20px 0;
        }
        
        .step {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .step-number {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            background: var(--accent-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-content strong {
            display: block;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-size: 1.1em;
        }
        
        .example-notice {
            background: var(--card-bg);
            border: 2px solid var(--accent-blue);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        .recipient-journey h5 {
            color: var(--accent-blue);
            margin: 20px 0 10px 0;
        }
        
        .fee-table {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .fee-table table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .fee-table th {
            background: var(--primary-navy);
            color: var(--text-primary);
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .fee-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .fee-table tr:last-child td {
            border-bottom: none;
        }
        
        .fee-table tr:hover {
            background: var(--hover-bg);
        }
        
        .workflow-guide h5 {
            color: var(--accent-blue);
            margin: 25px 0 15px 0;
        }
        
        .workflow-guide ol {
            padding-left: 20px;
        }
        
        .workflow-guide ol li {
            margin-bottom: 10px;
        }
        
        .best-practices h5 {
            color: var(--accent-blue);
            margin: 20px 0 15px 0;
        }
        
        .technical-info h5 {
            color: var(--accent-blue);
            margin: 20px 0 15px 0;
        }
        
        .warning-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            gap: 15px;
            align-items: start;
        }
        
        .warning-box i {
            color: var(--error);
            font-size: 1.2em;
            flex-shrink: 0;
        }

        /* Animations */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes shimmer {
            to { left: 100%; }
        }

        @keyframes scan {
            to { left: 100%; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .admin-controls {
                grid-template-columns: 1fr;
            }

            .stats-section {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .preview-container {
                flex-direction: column;
            }
            
            .preview-image {
                flex: unset;
            }

            .modal-content {
                margin: 2% 1rem;
                padding: 1.5rem;
            }

            .welcome-section h2 {
                font-size: 2rem;
            }

            .stats-section {
                grid-template-columns: 1fr;
            }

            .tab-navigation {
                justify-content: start;
            }

            .notification {
                right: 0.5rem;
                left: 0.5rem;
                min-width: auto;
            }
        }

        /* Print styles */
        @media print {
            .header,
            .tab-navigation,
            .btn,
            .modal {
                display: none !important;
            }

            body {
                background: white;
                color: black;
            }

            .card {
                border: 1px solid #ccc;
                page-break-inside: avoid;
            }
        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Focus styles */
        *:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            :root {
                --primary-dark: #000000;
                --text-primary: #ffffff;
                --accent-blue: #00a8ff;
            }
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Wallet Info Grid */
        .wallet-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .info-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .info-value {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 600;
            word-break: break-all;
        }

        /* Badge styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-primary {
            background-color: var(--accent-blue);
            color: white;
        }

        .badge-secondary {
            background-color: var(--gray-700);
            color: var(--text-secondary);
        }

        .badge-success {
            background-color: var(--success);
            color: white;
        }

        .badge-warning {
            background-color: var(--warning);
            color: white;
        }

        .badge-admin {
            background-color: #9333ea;
            color: white;
        }

        .badge-server {
            background-color: #3b82f6;
            color: white;
        }

        /* Fee Summary */
        .fee-summary {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        .fee-summary p {
            margin: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fee-summary span {
            font-weight: 600;
            color: var(--accent-blue);
        }

        /* FAQ Styles */
        .faq-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .faq-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .faq-header {
            width: 100%;
            padding: 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .faq-header:hover {
            background: var(--hover-bg);
        }

        .faq-header i {
            transition: transform 0.3s ease;
            color: var(--accent-blue);
        }

        .faq-header.active i {
            transform: rotate(180deg);
        }

        .faq-content {
            padding: 0 1.5rem 1.5rem;
            display: none;
        }

        .fee-explanation {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .fee-item {
            background: var(--hover-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 3px solid var(--accent-blue);
        }

        .fee-item strong {
            color: var(--accent-blue);
            display: block;
            margin-bottom: 0.5rem;
        }

        .info-box {
            background: rgba(14, 165, 233, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .info-box.warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning);
        }

        .info-box i {
            color: var(--accent-blue);
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .info-box.warning i {
            color: var(--warning);
        }

        .delivery-option {
            background: var(--hover-bg);
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .delivery-option h5 {
            color: var(--accent-blue);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .delivery-option ul {
            list-style: none;
            padding: 0;
        }

        .delivery-option li {
            margin-bottom: 0.5rem;
            padding-left: 1.5rem;
            position: relative;
        }

        .delivery-option li::before {
            content: "";
            position: absolute;
            left: 0;
            color: var(--accent-blue);
        }

        .scenario {
            background: var(--hover-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .scenario h5 {
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .scenario ul {
            list-style: none;
            padding: 0;
        }

        .scenario li {
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .scenario li::before {
            content: "";
            position: absolute;
            left: 0;
            color: var(--success);
        }

        .cost-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .cost-table th,
        .cost-table td {
            padding: 0.75rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .cost-table th {
            background: var(--hover-bg);
            font-weight: 600;
            color: var(--accent-blue);
        }

        .cost-table tr:nth-child(even) {
            background: var(--hover-bg);
        }

        .breakdown-row td {
            background: var(--card-bg);
            font-style: italic;
            text-align: left !important;
            padding-left: 1.5rem;
        }

        .cost-note {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--hover-bg);
            border-radius: 0.5rem;
        }

        .benefit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .benefit-card {
            background: var(--hover-bg);
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .benefit-card:hover {
            transform: translateY(-2px);
        }

        .benefit-card i {
            font-size: 2.5rem;
            color: var(--accent-blue);
            margin-bottom: 1rem;
        }

        .benefit-card h5 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .step-list {
            list-style: none;
            padding: 0;
            margin-top: 1rem;
        }

        .step-list li {
            padding: 0.75rem 0 0.75rem 2.5rem;
            position: relative;
            border-bottom: 1px solid var(--border-color);
        }

        .step-list li:last-child {
            border-bottom: none;
        }

        .step-list li::before {
            content: counter(step-counter);
            counter-increment: step-counter;
            position: absolute;
            left: 0;
            width: 1.75rem;
            height: 1.75rem;
            background: var(--accent-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .step-list {
            counter-reset: step-counter;
        }
    
        /* Enhanced checkbox styling */
        #lawEnforcementExempt {
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(59, 130, 246, 0.5);
            border-radius: 4px;
            display: inline-block;
            position: relative;
            transition: all 0.2s ease;
        }
        
        #lawEnforcementExempt:checked {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        
        #lawEnforcementExempt:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        #lawEnforcementExempt:hover {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Loader -->
    <div class="loader-container" id="loader">
        <div class="loader"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo" onclick="location.reload()">
                <i class="fas fa-shield-alt"></i>
                <h1>LegalNotice</h1>
            </div>
            <div class="header-controls">
                <div id="contractsStatus" style="display: none;">
                    <div class="contract-indicator">
                        <span>Contract:</span>
                        <span id="legalContractShort">-</span>
                        <button class="btn-icon" onclick="viewContractOnTronscan('legal')" title="View on TronScan">
                            <i class="fas fa-external-link-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="chain-selector">
                    <select id="chainSelector" class="chain-dropdown" onchange="handleChainChange()">
                        <optgroup label="TRON">
                            <option value="tron-mainnet">TRON Mainnet</option>
                            <option value="tron-nile" selected>TRON Nile Testnet</option>
                            <option value="tron-shasta">TRON Shasta Testnet</option>
                        </optgroup>
                        <optgroup label="Ethereum">
                            <option value="evm-ethereum">Ethereum Mainnet</option>
                            <option value="evm-sepolia">Ethereum Sepolia</option>
                        </optgroup>
                        <optgroup label="Polygon">
                            <option value="evm-polygon">Polygon Mainnet</option>
                            <option value="evm-mumbai">Polygon Mumbai</option>
                        </optgroup>
                        <optgroup label="BNB Chain">
                            <option value="evm-bsc">BNB Smart Chain</option>
                            <option value="evm-bscTestnet">BSC Testnet</option>
                        </optgroup>
                    </select>
                </div>
                <div class="network-indicator" id="networkIndicator">
                    <i class="fas fa-circle"></i>
                    <span id="networkName">Disconnected</span>
                </div>
                <div class="wallet-status">
                    <div class="wallet-address" id="walletAddress" style="display: none;">
                        <span id="walletAddressText">Not Connected</span>
                        <button class="btn-icon" onclick="copyWalletAddress()" title="Copy address">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <span id="walletStatus" style="display: block;">Not Connected</span>
                    <button class="btn btn-primary btn-small" onclick="connectWallet()" id="connectBtn">
                        <i class="fas fa-link"></i>
                        Connect
                    </button>
                </div>
            </div>
        </div>
    </header>

    
    <!-- Notification Bell for Recipients -->
    <div id="notificationBell" class="notification-bell" style="display: none;">
        <button class="btn-icon notification-bell-btn" onclick="toggleNotificationPanel()">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
        </button>
    </div>
    
    <!-- Notification Panel -->
    <div id="notificationPanel" class="notification-panel" style="display: none;">
        <div class="notification-panel-header">
            <h3>Legal Notices</h3>
            <button class="btn-icon" onclick="toggleNotificationPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="notificationList" class="notification-list">
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No new notices</p>
            </div>
        </div>
        <div class="notification-panel-footer">
            <button class="btn btn-secondary btn-small" onclick="markAllAsRead()">
                Mark all as read
            </button>
        </div>
    </div>


    <!-- Main Container -->
    <div class="main-container">
        <!-- Welcome Section -->
        <div class="welcome-section" id="welcomeSection">
            <h2>Blockchain Legal Document Service</h2>
            <p>Secure, verifiable, and immutable legal document serving on the TRON network</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('user')">
                <i class="fas fa-user"></i> Process Server
                <span class="badge" id="userBadge" style="display: none;">0</span>
            </button>
            <button class="tab-button" onclick="switchTab('delivery')">
                <i class="fas fa-truck"></i> Delivery Status
                <span class="badge" id="deliveryBadge" style="display: none;">0</span>
            </button>
            <button class="tab-button" onclick="switchTab('admin')" id="adminTabButton" style="display: none;">
                <i class="fas fa-user-shield"></i> Admin Panel
            </button>
            <button class="tab-button" onclick="switchTab('help')">
                <i class="fas fa-question-circle"></i> Help
            </button>
        </div>

        <!-- Stats Section -->
        <div id="statsContainer" style="display: none;">
            <div class="stats-header" id="statsHeader" style="cursor: pointer; padding: 1rem; background: var(--secondary-navy); border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between;">
                <h3 style="margin: 0; font-size: 1.1rem; color: var(--text-primary);">
                    <i class="fas fa-chart-bar" style="margin-right: 0.5rem;"></i>
                    Dashboard Statistics
                </h3>
                <i id="statsToggleIcon" class="fas fa-chevron-up"></i>
            </div>
            <div class="stats-section" id="statsSection" style="display: grid;">
                <div class="stat-card">
                    <i class="fas fa-file-alt"></i>
                    <div class="stat-value" id="totalNotices">0</div>
                    <div class="stat-label">Total Notices</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-check-circle"></i>
                    <div class="stat-value" id="acceptedNotices">0</div>
                    <div class="stat-label">Accepted</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-clock"></i>
                    <div class="stat-value" id="pendingNotices">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-users"></i>
                    <div class="stat-value" id="activeServers">0</div>
                    <div class="stat-label">Process Servers</div>
                </div>
            </div>
        </div>

        <!-- User Tab -->
        <div id="userTab" class="tab-content active">
            <!-- Contract Management Card -->
            <div class="card" id="contractManagementCard">
                <div class="card-header" id="contractHeader" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 1.25rem;">
                    <h2 style="margin: 0;"><i class="fas fa-file-contract"></i> Contract Connection</h2>
                    <i id="contractToggleIcon" class="fas fa-chevron-up"></i>
                </div>
                <div id="contractContent">
                <div class="form-group">
                    <label class="form-label">Legal Notice Contract Address <span class="badge badge-info">Nile Testnet</span></label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" class="form-input" id="contractAddress" 
                               placeholder="Enter contract address (e.g., TXxxx...)"
                               value="TEZxBmj16pKdsJh3aDE9Y4RLSuXuBuUSp8" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="copyAddress(document.getElementById('contractAddress').value)" title="Copy address">
                            <i class="fas fa-copy"></i>
                        </button>
                        <a href="https://nile.tronscan.org/#/contract/TEZxBmj16pKdsJh3aDE9Y4RLSuXuBuUSp8" target="_blank" class="btn btn-secondary" title="View on Nile TronScan">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                    <p class="form-help"> Make sure your TronLink wallet is connected to <strong>Nile Testnet</strong>, not mainnet!</p>
                </div>
                <button class="btn btn-primary" onclick="connectContracts()" id="connectContractBtn">
                    <i class="fas fa-plug"></i>
                    Connect Contract
                </button>
                <div id="contractStatus"></div>
                </div>
            </div>

            <!-- Wallet Status Card -->
            <div class="card" id="walletStatusCard" style="display: none;">
                <div class="card-header" id="walletStatusHeader" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 1.25rem;">
                    <h2 style="margin: 0;"><i class="fas fa-wallet"></i> Wallet Status</h2>
                    <i id="walletToggleIcon" class="fas fa-chevron-down"></i>
                </div>
                <div id="walletStatusContent" style="display: none;">
                <div class="wallet-info-grid">
                    <div class="info-item">
                        <span class="info-label">Address:</span>
                        <span class="info-value" id="statusWalletAddress">Not Connected</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Role:</span>
                        <span class="info-value" id="walletRole">
                            <span class="badge badge-secondary">None</span>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Fee Status:</span>
                        <span class="info-value" id="feeExemptStatus">
                            <span class="badge badge-warning">Not Exempt</span>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Balance:</span>
                        <span class="info-value" id="walletBalance">0 TRX</span>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="refreshWalletStatus()" style="margin-top: 1rem;">
                    <i class="fas fa-sync-alt"></i>
                    Refresh Status
                </button>
                <button class="btn btn-primary" onclick="debugCheckRoles()" style="margin-top: 1rem; margin-left: 0.5rem;">
                    <i class="fas fa-bug"></i>
                    Debug Check
                </button>
                <button class="btn btn-success" onclick="fixMyFeeExemption()" style="margin-top: 1rem; margin-left: 0.5rem; display: none;" id="fixExemptionBtn">
                    <i class="fas fa-wrench"></i>
                    Fix Exemption
                </button>
                
                <!-- Detailed Role Check -->
                <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <h4 style="margin-bottom: 0.5rem;">Detailed Role Check</h4>
                    <div id="roleCheckDetails" style="font-size: 0.875rem; color: var(--text-secondary);">
                        Click refresh to check all roles...
                    </div>
                </div>
                
                <!-- Debug Output (separate div to prevent overwriting) -->
                <div id="debugOutput" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--accent-blue);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <h4 style="margin: 0;">Debug Information</h4>
                        <button class="btn btn-sm btn-secondary" onclick="copyDebugInfo()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div id="debugContent" style="font-size: 0.875rem; color: var(--text-secondary);">
                    </div>
                </div>
                </div>
            </div>

            <!-- New User Registration Notice -->
            <div id="registrationNotice" class="notification-banner">
                <i class="fas fa-info-circle"></i>
                <div style="flex: 1;">
                    <strong>New User?</strong>
                    Please register as a Process Server to get your unique identifier.
                    <button class="btn btn-primary btn-small" style="margin-left: 1rem;" onclick="openRegistrationModal()">
                        <i class="fas fa-user-plus"></i> Register Now
                    </button>
                </div>
                <button class="btn-icon" onclick="dismissRegistrationNotice()" title="Dismiss">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Server ID Display -->
            <div id="serverIdDisplay" style="display: none; margin-bottom: 1.5rem;">
                <div class="server-id-display">
                    <i class="fas fa-id-badge"></i>
                    Your Server ID: <span id="userServerId">00</span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid-3" style="margin-bottom: 2rem;">
                <div class="action-card primary" onclick="openMintModal()">
                    <i class="fas fa-file-upload"></i>
                    <h3>Create Legal Notice</h3>
                    <p>Upload document and create NFT with automatic alert</p>
                </div>
                
                <div class="action-card" onclick="openAuditModal()">
                    <i class="fas fa-clipboard-check"></i>
                    <h3>Audit Issued Notices</h3>
                    <p>View all notices, delivery status, and transaction details</p>
                </div>
                
                <div class="action-card" onclick="openRegistrationForUser()">
                    <i class="fas fa-user-tie"></i>
                    <h3>Become a Process Server</h3>
                    <p>Register to serve legal documents professionally</p>
                </div>
            </div>

            <!-- My Alerts -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-bell"></i> My Legal Notice Alerts</h2>
                    <button class="btn btn-secondary btn-small" onclick="refreshMyAlerts()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="debugAlerts()">
                        <i class="fas fa-bug"></i> Debug
                    </button>
                </div>
                
                <!-- New user-friendly explanation banner -->
                <div class="alert alert-info" style="margin: 1rem; display: none; background: #f0f9ff; border: 2px solid #3b82f6;" id="alertExplainer">
                    <div style="display: flex; align-items: start; gap: 1rem;">
                        <i class="fas fa-envelope-open-text" style="color: #3b82f6; font-size: 1.5rem; margin-top: 0.25rem;"></i>
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; color: #1e40af;">You Have Received Official Legal Documents</h4>
                            <p style="margin: 0 0 0.5rem 0; color: #1e3a8a;">
                                These are verified legal notices delivered electronically through blockchain technology. 
                                Just like certified mail, these documents require your signature to confirm receipt.
                            </p>
                            <div style="background: #dbeafe; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem;">
                                <p style="margin: 0; font-weight: 600; color: #1e40af;">
                                    <i class="fas fa-shield-alt" style="margin-right: 0.5rem;"></i>
                                    Your signature only confirms you received the document - it does NOT mean you agree with it or admit any wrongdoing.
                                </p>
                            </div>
                            <p style="margin: 0.75rem 0 0 0; color: #1e3a8a; font-size: 0.875rem;">
                                <strong>What to do:</strong> Review each notice below and click "Sign Receipt" to confirm delivery. 
                                Consider seeking legal advice if you have questions about the content.
                            </p>
                            <div style="background: #fef3c7; padding: 0.75rem; border-radius: 6px; margin-top: 0.75rem; border: 1px solid #f59e0b;">
                                <p style="margin: 0; color: #92400e; font-weight: 600;">
                                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem; color: #d97706;"></i>
                                    Warning: Failing to respond to legal notices by their deadlines may result in default judgment against you. 
                                    The court may rule in favor of the other party if you do not respond in time.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="myAlertsContent">
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>No alerts yet</h3>
                        <p>Click refresh to check for new legal notices</p>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-history"></i> Recent Activity</h2>
                </div>
                <div id="recentActivityContent">
                    <div class="empty-state">
                        <i class="fas fa-clipboard"></i>
                        <h3>No recent activity</h3>
                        <p>Your recent transactions will appear here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delivery Status Tab -->
        <div id="deliveryTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-truck"></i> Delivery Tracking Dashboard</h2>
                    <button class="btn btn-icon" onclick="refreshDeliveryStatus()" title="Refresh">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
                
                <!-- Delivery Stats Overview -->
                <div class="stats-section" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <i class="fas fa-paper-plane"></i>
                        <div class="stat-value" id="totalSentNotices">0</div>
                        <div class="stat-label">Notices Sent</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-double"></i>
                        <div class="stat-value" id="deliveredNotices">0</div>
                        <div class="stat-label">Delivered</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-hourglass-half"></i>
                        <div class="stat-value" id="pendingDelivery">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-percentage"></i>
                        <div class="stat-value" id="deliveryRate">0%</div>
                        <div class="stat-label">Delivery Rate</div>
                    </div>
                </div>
                
                <!-- Filter Options -->
                <div class="form-group">
                    <label class="form-label">Filter by Status</label>
                    <select id="deliveryStatusFilter" onchange="filterDeliveryResults()" class="form-select">
                        <option value="all">All Notices</option>
                        <option value="pending">Pending Delivery</option>
                        <option value="delivered">Delivered (Accepted)</option>
                        <option value="recent">Last 7 Days</option>
                    </select>
                </div>
                
                <!-- Delivery Results -->
                <div id="deliveryResults">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No notices to track</h3>
                        <p>Your sent notices will appear here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="adminTab" class="tab-content">
            <!-- Admin Access Check -->
            <div id="adminAccessDenied" class="alert alert-error" style="display: none;">
                <i class="fas fa-lock"></i>
                <div>
                    <strong>Access Denied</strong>
                    <p>You need admin role to access this section.</p>
                </div>
            </div>

            <div id="adminContent" style="display: none;">
                <!-- Admin Stats -->
                <div id="adminStats" style="margin-bottom: 2rem;">
                    <!-- Stats will be populated by updateStatsFromLocalStorage() -->
                </div>
                
                <!-- Pending Registrations -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-user-clock"></i> Pending Process Server Registrations</h2>
                        <button class="btn btn-secondary btn-small" onclick="refreshPendingRegistrations()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div id="pendingRegistrations">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No pending registrations</h3>
                            <p>New registration requests will appear here</p>
                        </div>
                    </div>
                </div>

                <!-- All Registrations Viewer -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-database"></i> All Process Server Registrations</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-small" onclick="fetchAllRegistrations()">
                                <i class="fas fa-sync"></i> Load All
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="exportRegistrations()" style="display: none;" id="exportBtn">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                        </div>
                    </div>
                    <div id="allRegistrationsContent">
                        <div class="empty-state">
                            <i class="fas fa-cloud-download-alt"></i>
                            <h3>Click "Load All" to fetch registrations</h3>
                            <p>This will download and decrypt all registration files from GitHub</p>
                        </div>
                    </div>
                </div>

                <!-- Admin Controls -->
                <div class="admin-controls">
                    <!-- Fee Structure Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-coins"></i> Fee Structure Management</h2>
                        </div>
                        
                        <!-- Service Fee (Profit) -->
                        <div class="form-group">
                            <label class="form-label">Service Fee (Profit) - TRX</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number" class="form-input" id="serviceFee" 
                                       step="0.01" min="0" placeholder="20" style="flex: 1;">
                                <span class="form-help" id="currentServiceFee">Current: 20 TRX</span>
                            </div>
                            <p class="form-help">Revenue fee - can be waived for law enforcement</p>
                        </div>
                        
                        <!-- Creation Fee (Operations) -->
                        <div class="form-group">
                            <label class="form-label">Creation Fee (Operations) - TRX</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number" class="form-input" id="creationFee" 
                                       step="0.01" min="0" placeholder="10" style="flex: 1;">
                                <span class="form-help" id="currentCreationFee">Current: 10 TRX</span>
                            </div>
                            <p class="form-help">Operational costs - not waivable</p>
                        </div>
                        
                        <!-- Sponsorship Fee -->
                        <div class="form-group">
                            <label class="form-label">Sponsorship Fee (Recipient Support) - TRX</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number" class="form-input" id="sponsorshipFee" 
                                       step="0.01" min="0" placeholder="2" style="flex: 1;">
                                <span class="form-help" id="currentSponsorshipFee">Current: 2 TRX</span>
                            </div>
                            <p class="form-help">Funds recipient acceptance - not waivable</p>
                        </div>
                        
                        <div class="fee-summary">
                            <p><strong>Total Regular User Cost:</strong> <span id="totalRegularCost">32 TRX</span></p>
                            <p><strong>Total Law Enforcement Cost:</strong> <span id="totalLECost">12 TRX</span></p>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="updateServiceFee()" id="updateServiceFeeBtn">
                                <i class="fas fa-save"></i> Update Service Fee
                            </button>
                            <button class="btn btn-primary" onclick="updateCreationFee()" id="updateCreationFeeBtn">
                                <i class="fas fa-save"></i> Update Creation Fee
                            </button>
                            <button class="btn btn-primary" onclick="updateSponsorshipFee()" id="updateSponsorshipFeeBtn">
                                <i class="fas fa-save"></i> Update Sponsorship Fee
                            </button>
                        </div>
                        <div id="feeUpdateResult"></div>
                    </div>

                    <!-- IPFS Configuration -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-cloud-upload-alt"></i> IPFS Configuration (Pinata)</h2>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pinata API Key</label>
                            <input type="text" class="form-input" id="pinataApiKey" 
                                   placeholder="Enter your Pinata API key">
                            <p class="form-help">Get your API key from <a href="https://app.pinata.cloud/keys" target="_blank">Pinata Dashboard</a></p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pinata Secret API Key</label>
                            <input type="password" class="form-input" id="pinataSecretKey" 
                                   placeholder="Enter your Pinata Secret API key">
                            <p class="form-help">Keep this secret - it will be stored locally in your browser</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="savePinataKeys()">
                                <i class="fas fa-save"></i> Save Keys
                            </button>
                            <button class="btn btn-secondary" onclick="testPinataConnection()">
                                <i class="fas fa-check-circle"></i> Test Connection
                            </button>
                        </div>
                        <div id="pinataConfigResult"></div>
                    </div>

                    <!-- Role Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-users-cog"></i> Role & Exemption Management</h2>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Select Role</label>
                            <select class="form-input" id="roleSelect" onchange="toggleRegistrationForm()">
                                <option value="PROCESS_SERVER_ROLE">Process Server</option>
                                <option value="ADMIN_ROLE">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
    <label class="form-label">Wallet Address</label>
    <div style="display: flex; gap: 0.5rem;">
        <input type="text" class="form-input" id="roleAddress" 
               placeholder="Enter TRON wallet address" style="flex: 1;">
        <button class="btn btn-secondary btn-small" onclick="useConnectedAddress()" title="Use my address">
            <i class="fas fa-user"></i>
        </button>
    </div>
    <p class="form-help">Enter address or click button to use your connected wallet</p>
</div>
                        <!-- Process Server Registration Form -->
                        <div id="serverRegistrationForm" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Agency Name</label>
                                <input type="text" class="form-input" id="agencyName" placeholder="e.g., Smith & Associates Process Service">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Agency Email</label>
                                <input type="email" class="form-input" id="agencyEmail" placeholder="agency@example.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Server Name</label>
                                <input type="text" class="form-input" id="serverName" placeholder="Full name of process server">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-input" id="serverPhone" placeholder="(555) 123-4567">
                            </div>
                        </div>
                        <!-- Action Buttons -->
                        <div style="margin-top: 1.5rem;">
                            <div style="display: flex; gap: 0.5rem; justify-content: flex-start;">
                                <button class="btn btn-primary btn-small" onclick="grantRole()" id="grantRoleBtn" style="padding: 0.5rem 1rem;">
                                    <i class="fas fa-user-plus"></i>
                                    Grant Role
                                </button>
                                <button class="btn btn-secondary btn-small" onclick="checkRole()" id="checkRoleBtn" style="padding: 0.5rem 1rem;">
                                    <i class="fas fa-user-check"></i>
                                    Check Role
                                </button>
                            </div>
                        </div>
                        <div id="roleResult"></div>
                    </div>

                    <!-- Fee Exemption Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-shield-alt"></i> Fee Exemption Management</h2>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Address to Manage Exemptions</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" class="form-input" id="exemptionAddress" 
                                       placeholder="Enter TRON wallet address" style="flex: 1;">
                                <button class="btn btn-secondary btn-small" onclick="useConnectedAddressForExemption()" title="Use my address">
                                    <i class="fas fa-user"></i> Use My Address
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Agency Name (for Law Enforcement)</label>
                            <input type="text" class="form-input" id="exemptionAgencyName" 
                                   placeholder="e.g., FBI, DEA, Local Police Department">
                            <p class="form-help">Required only for law enforcement exemptions</p>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="setLawEnforcementExemption()">
                                <i class="fas fa-badge-check"></i> Grant Law Enforcement Exemption
                            </button>
                            <button class="btn btn-warning" onclick="removeLawEnforcementExemption()">
                                <i class="fas fa-ban"></i> Remove Law Enforcement Exemption
                            </button>
                            <button class="btn btn-secondary" onclick="checkExemptionStatus()">
                                <i class="fas fa-info-circle"></i> Check Status
                            </button>
                        </div>
                        <div id="exemptionResult"></div>
                    </div>

                    <!-- Fee Collector Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-wallet"></i> Update Fee Collector</h2>
                        </div>
                        <div class="form-group">
    <label class="form-label">Fee Collector Address</label>
    <div style="display: flex; gap: 0.5rem;">
        <input type="text" class="form-input" id="feeCollectorAddress" 
               placeholder="Enter wallet address" style="flex: 1;">
        <button class="btn btn-secondary btn-small" onclick="useConnectedAddressForFeeCollector()" title="Use my address">
            <i class="fas fa-user"></i>
        </button>
    </div>
    <p class="form-help">Address that receives all contract fees</p>
</div>
                        <button class="btn btn-primary" onclick="updateFeeCollector()" id="updateFeeCollectorBtn">
                            <i class="fas fa-save"></i>
                            Update Fee Collector
                        </button>
                        <div id="feeCollectorResult"></div>
                    </div>

                    <!-- Transaction Verification -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-search-dollar"></i> Transaction Verification</h2>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Transaction Hash</label>
                            <input type="text" class="form-input" id="verifyTxHash" 
                                   placeholder="Enter transaction hash to verify NFT transfers">
                        </div>
                        <button class="btn btn-primary" onclick="verifyTransaction()">
                            <i class="fas fa-check-circle"></i>
                            Verify Transaction
                        </button>
                        <div id="txVerificationResult" style="margin-top: 1rem;"></div>
                    </div>

                    <!-- Contract Management -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-cog"></i> Contract Management</h2>
                        </div>
                        <!-- Resource Sponsorship removed - not in simplified contract -->
                        <!--
                        <div class="form-group">
                            <label class="form-label">Resource Sponsorship</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="resourceSponsorshipCheck" checked>
                                <label for="resourceSponsorshipCheck">Enable resource sponsorship</label>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="updateResourceSponsorship()">
                            <i class="fas fa-save"></i>
                            Update Settings
                        </button>
                        <div id="contractManagementResult"></div>
                        -->
                        
                        <!-- Energy Delegation Section -->
                        <div class="form-group" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                            <h3 style="margin-bottom: 1rem;">
                                <i class="fas fa-bolt"></i> Energy Delegation
                            </h3>
                            <p class="form-help" style="margin-bottom: 1rem;">
                                Stake TRX to delegate energy to the contract. This allows the contract to pay for user transaction energy costs.
                                <br>Each notice requires ~500,000 energy. 20,000 TRX staked = ~504,000 energy/day
                            </p>
                            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                <button class="btn btn-secondary" onclick="checkContractResources()">
                                    <i class="fas fa-battery-half"></i> Check Resources
                                </button>
                                <button class="btn btn-primary" onclick="showDelegateEnergyModal()">
                                    <i class="fas fa-bolt"></i> Delegate Energy
                                </button>
                            </div>
                            <div id="contractResourceStatus" style="font-size: 0.875rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; display: none;">
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                            <label class="form-label">Withdraw TRX from Contract</label>
                            <input type="number" class="form-input" id="withdrawAmount" placeholder="Amount in TRX" step="0.1">
                            <p class="form-help">Withdraw TRX from contract balance (admin only)</p>
                            <button class="btn btn-warning" onclick="withdrawFromContract()">
                                <i class="fas fa-coins"></i>
                                Withdraw TRX
                            </button>
                        </div>
                    </div>

                    <!-- GitHub Storage Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-lock"></i> Encrypted Storage Settings</h2>
                        </div>
                        
                        <!-- GitHub Token -->
                        <div class="form-group">
                            <label class="form-label">GitHub Personal Access Token</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="password" class="form-input" id="githubToken" 
                                       placeholder="ghp_..." style="flex: 1;">
                                <button class="btn btn-secondary btn-small" onclick="toggleTokenVisibility()" title="Show/Hide">
                                    <i class="fas fa-eye" id="tokenVisibilityIcon"></i>
                                </button>
                            </div>
                            <p class="form-help">Token for saving encrypted registrations to GitHub</p>
                        </div>
                        
                        <!-- Encryption Key Display -->
                        <div class="form-group">
                            <label class="form-label">Encryption Key (Auto-generated)</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="text" class="form-input" id="encryptionKey" 
                                       readonly style="flex: 1; background: var(--secondary-navy); cursor: not-allowed;">
                                <button class="btn btn-secondary btn-small" onclick="copyEncryptionKey()" title="Copy key">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <p class="form-help">Save this key securely - needed to decrypt registration files</p>
                        </div>
                        
                        <!-- Test Connection -->
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="saveGitHubSettings()">
                                <i class="fas fa-save"></i>
                                Save Settings
                            </button>
                            <button class="btn btn-secondary" onclick="testGitHubConnection()">
                                <i class="fas fa-check-circle"></i>
                                Test Connection
                            </button>
                        </div>
                        <div id="githubSettingsResult"></div>
                    </div>
                </div>
            </div>
        </div>

        
        <!-- Analytics Tab -->
        <div class="tab-content" id="analytics" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-line"></i> Performance Analytics</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="analyticsTimeRange" class="form-select" style="width: auto;" onchange="updateAnalytics()">
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="all">All time</option>
                        </select>
                        <button class="btn btn-secondary btn-small" onclick="exportAnalytics()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="analytics-summary">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalNoticesServed">0</div>
                            <div class="stat-label">Total Notices</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="acceptanceRate">0%</div>
                            <div class="stat-label">Acceptance Rate</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="avgResponseTime">-</div>
                            <div class="stat-label">Avg Response Time</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-coins"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalRevenue">0 TRX</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Section -->
                <div class="analytics-charts">
                    <div class="chart-container">
                        <h3>Notices Over Time</h3>
                        <canvas id="noticesChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Notice Types Distribution</h3>
                        <canvas id="typesChart" width="200" height="200"></canvas>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="recent-activity">
                    <h3>Recent Activity</h3>
                    <div id="recentActivityList">
                        <div class="empty-state">
                            <i class="fas fa-chart-line"></i>
                            <p>No activity data available</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Tab -->
        <div id="helpTab" class="tab-content">
            <!-- FAQ Accordion -->
            <div class="faq-container">
                <h2 style="margin-bottom: 2rem;"><i class="fas fa-question-circle"></i> Frequently Asked Questions</h2>
                
                <!-- Understanding the Two Delivery Methods -->
                <div class="faq-section">
                    <button class="faq-header active" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-down"></i>
                        <span>Understanding the Two Delivery Methods</span>
                    </button>
                    <div class="faq-content" style="display: block;">
                        <h4>We offer two distinct methods for delivering legal notices via blockchain:</h4>
                        
                        <div class="delivery-option">
                            <h5><i class="fas fa-file-shield"></i> Document Images (Secure & Verifiable)</h5>
                            <p><strong>Purpose:</strong> For serving official legal documents that require proof of delivery and signature confirmation.</p>
                            
                            <div class="info-box">
                                <i class="fas fa-lock"></i>
                                <div>
                                    <strong>How it works:</strong>
                                    <ol style="margin: 0.5rem 0 0 0;">
                                        <li>Legal document is encrypted using the recipient's wallet address</li>
                                        <li>Document stored securely on IPFS (decentralized storage)</li>
                                        <li>Recipient receives NFT with public notice text</li>
                                        <li>To view document, recipient must "accept" (sign transaction)</li>
                                        <li>Acceptance creates immutable proof of delivery with timestamp</li>
                                        <li>Decryption key revealed only after acceptance</li>
                                    </ol>
                                </div>
                            </div>
                            
                            <p><strong>Security Features:</strong></p>
                            <ul>
                                <li> Document remains private until accepted</li>
                                <li> Only intended recipient can decrypt</li>
                                <li> Blockchain proof of service date/time</li>
                                <li> Cannot be altered after creation</li>
                                <li> Permanent verifiable record</li>
                            </ul>
                            
                            <p><strong>Best for:</strong> Court orders, seizure notices, subpoenas, summons, eviction notices, and any document requiring certified delivery.</p>
                        </div>
                        
                        <div class="delivery-option">
                            <h5><i class="fas fa-comment-alt"></i> Text Only (Simple & Direct)</h5>
                            <p><strong>Purpose:</strong> For public notices, reminders, or communications that don't require signature confirmation.</p>
                            
                            <div class="info-box warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>
                                    <strong>How it works:</strong>
                                    <ol style="margin: 0.5rem 0 0 0;">
                                        <li>Text message is sent directly to recipient's wallet</li>
                                        <li>Appears immediately as NFT - no acceptance required</li>
                                        <li>All content is publicly visible on blockchain</li>
                                        <li>No encryption or privacy protection</li>
                                        <li>No proof of recipient viewing/acknowledging</li>
                                    </ol>
                                </div>
                            </div>
                            
                            <p><strong>Limitations:</strong></p>
                            <ul>
                                <li> No privacy - anyone can read the message</li>
                                <li> No proof recipient saw the notice</li>
                                <li> Cannot attach documents</li>
                                <li> Limited to 100 characters</li>
                            </ul>
                            
                            <p><strong>Best for:</strong> Payment reminders, public announcements, preliminary notices, meeting notifications.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Recipient Experience & Security -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Recipient Experience & Security</span>
                    </button>
                    <div class="faq-content">
                        <h4>What Recipients Experience</h4>
                        
                        <div class="recipient-journey">
                            <h5>For Document Images Notices:</h5>
                            <div class="process-steps">
                                <div class="step">
                                    <div class="step-number">1</div>
                                    <div class="step-content">
                                        <strong>NFT Appears in Wallet</strong>
                                        <p>Recipients see a new NFT titled with the notice type (e.g., "PS#1-Legal Notice"). The description includes:</p>
                                        <ul>
                                            <li>Issuing agency name</li>
                                            <li>Case reference number</li>
                                            <li>Brief description of the matter</li>
                                            <li>Clear message: "Legal document attached. Accept to view."</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="step">
                                    <div class="step-number">2</div>
                                    <div class="step-content">
                                        <strong>One-Click Acceptance</strong>
                                        <p>To view the document:</p>
                                        <ul>
                                            <li>Click "Accept Notice" button</li>
                                            <li>Approve transaction in wallet (FREE if sponsored)</li>
                                            <li>Wait ~3 seconds for confirmation</li>
                                            <li>Document automatically decrypts and displays</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="step">
                                    <div class="step-number">3</div>
                                    <div class="step-content">
                                        <strong>Permanent Access</strong>
                                        <p>After acceptance:</p>
                                        <ul>
                                            <li>Full document is viewable anytime</li>
                                            <li>Can download/print for records</li>
                                            <li>Blockchain timestamp proves when you received it</li>
                                            <li>Cannot be altered or deleted</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <h5>For Text Only Notices:</h5>
                            <ul>
                                <li>Message appears immediately in wallet</li>
                                <li>No action required - it's already visible</li>
                                <li>No fees or signatures needed</li>
                                <li>Simple informational delivery</li>
                            </ul>
                            
                            <h5>Security for Recipients:</h5>
                            <div class="info-box">
                                <i class="fas fa-shield-alt"></i>
                                <div>
                                    <strong>Your wallet = Your control</strong>
                                    <ul style="margin: 0.5rem 0 0 0;">
                                        <li>Documents encrypted with YOUR wallet address</li>
                                        <li>Only YOU can decrypt and view</li>
                                        <li>Process servers cannot see if/when you view</li>
                                        <li>No personal information exposed publicly</li>
                                        <li>Acceptance is voluntary - you control timing</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Complete Fee Structure & Energy Costs -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Complete Fee Structure & Energy Costs</span>
                    </button>
                    <div class="faq-content">
                        <h4>Understanding All Costs</h4>
                        
                        <div class="fee-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>User Type</th>
                                        <th>Document Images</th>
                                        <th>Text Only</th>
                                        <th>Energy Cost</th>
                                        <th>Total Estimate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Regular User</strong></td>
                                        <td>150 TRX + 2 TRX</td>
                                        <td>15 TRX + 2 TRX</td>
                                        <td>~90 TRX / ~36 TRX</td>
                                        <td>~242 TRX / ~53 TRX</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Process Server</strong></td>
                                        <td>75 TRX + 2 TRX</td>
                                        <td>15 TRX + 2 TRX</td>
                                        <td>~90 TRX / ~36 TRX</td>
                                        <td>~167 TRX / ~53 TRX</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Law Enforcement</strong></td>
                                        <td>0 TRX + 2 TRX</td>
                                        <td>0 TRX + 2 TRX</td>
                                        <td>~90 TRX / ~36 TRX</td>
                                        <td>~92 TRX / ~38 TRX</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <h5>Fee Components Explained:</h5>
                        
                        <div class="fee-explanation">
                            <div class="fee-item">
                                <strong>Service Fee (150 TRX for Documents, 15 TRX for Text)</strong>
                                <p>Covers platform operations, IPFS storage, encryption services, and profit margin. This is the primary revenue source.</p>
                            </div>
                            
                            <div class="fee-item">
                                <strong>Creation Fee (75 TRX for Process Servers)</strong>
                                <p>Reduced fee for verified process servers who serve high volumes. Covers operational costs with minimal profit.</p>
                            </div>
                            
                            <div class="fee-item">
                                <strong>Sponsorship Fee (2 TRX - ALWAYS INCLUDED)</strong>
                                <p>Ensures recipients can accept notices without needing TRX. This fee is mandatory and cannot be waived. It removes all friction for recipients.</p>
                            </div>
                            
                            <div class="fee-item">
                                <strong>Energy Costs (~90 TRX for Documents, ~36 TRX for Text)</strong>
                                <p>TRON blockchain requires "energy" to process transactions. Without staked TRX, this energy must be "burned" from your balance. This is NOT kept by us - it goes to the TRON network.</p>
                            </div>
                        </div>
                        
                        <h5>Law Enforcement Special Pricing:</h5>
                        <div class="info-box">
                            <i class="fas fa-balance-scale"></i>
                            <div>
                                <strong>Cost-Only Pricing for Law Enforcement</strong>
                                <p style="margin: 0.5rem 0 0 0;">Verified law enforcement agencies pay ONLY actual costs:</p>
                                <ul style="margin: 0.5rem 0 0 0;">
                                    <li>2 TRX sponsorship (for recipient)</li>
                                    <li>Energy costs (paid by their wallet)</li>
                                    <li>NO service fees or profit margins</li>
                                    <li>Must be verified with agency name</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Workflow Guide -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Step-by-Step Workflow Guide</span>
                    </button>
                    <div class="faq-content">
                        <h4>Complete Process for Serving Legal Notices</h4>
                        
                        <div class="workflow-guide">
                            <h5>Before You Start:</h5>
                            <ul>
                                <li>Ensure you have the recipient's wallet address</li>
                                <li>Have your legal document ready (PDF, DOC, or images)</li>
                                <li>Prepare case information (agency, case number, etc.)</li>
                                <li>Have sufficient TRX in your wallet (22 TRX recommended)</li>
                            </ul>
                            
                            <h5>Step 1: Connect Your Wallet</h5>
                            <ol>
                                <li>Click "Connect Wallet" in the top right</li>
                                <li>Select TRON network</li>
                                <li>Approve connection in your wallet</li>
                            </ol>
                            
                            <h5>Step 2: Create Legal Notice</h5>
                            <ol>
                                <li>Click "Create Legal Notice" button</li>
                                <li>Upload your legal document</li>
                                <li>Enter recipient's wallet address</li>
                                <li>Select "Document Images" as delivery method</li>
                                <li>Fill in notice details:
                                    <ul>
                                        <li>Select or enter notice type</li>
                                        <li>Enter issuing agency name</li>
                                        <li>Provide case number</li>
                                        <li>Add specific details (amounts, property, etc.)</li>
                                        <li>Review legal rights statement</li>
                                    </ul>
                                </li>
                                <li>Check "Pay Recipient's Acceptance Fees" (recommended)</li>
                                <li>Review total cost (typically 22 TRX)</li>
                                <li>Click "Create Notice" and confirm transaction</li>
                            </ol>
                            
                            <h5>Step 3: Track Delivery</h5>
                            <ol>
                                <li>Go to "Delivery Status" tab</li>
                                <li>Find your notice in the list</li>
                                <li>Monitor status (Pending  Delivered)</li>
                                <li>View acceptance timestamp when complete</li>
                            </ol>
                            
                            <h5>Step 4: Obtain Proof</h5>
                            <ul>
                                <li>Transaction hash serves as proof of service</li>
                                <li>Acceptance transaction provides proof of delivery</li>
                                <li>All records are permanently stored on blockchain</li>
                                <li>Export delivery certificate for court filing</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Best Practices -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Best Practices & Tips</span>
                    </button>
                    <div class="faq-content">
                        <h4>Maximizing Success with Blockchain Service</h4>
                        
                        <div class="best-practices">
                            <h5>For Process Servers:</h5>
                            <ul>
                                <li><strong>Always sponsor acceptance fees</strong> - This ensures recipients can accept without barriers</li>
                                <li><strong>Use descriptive case details</strong> - Help recipients understand the notice importance</li>
                                <li><strong>Include clear legal rights</strong> - Inform recipients of their options</li>
                                <li><strong>Verify wallet addresses</strong> - Double-check before sending (transactions are irreversible)</li>
                                <li><strong>Document everything</strong> - Keep records of wallet ownership verification</li>
                            </ul>
                            
                            <h5>For Law Enforcement:</h5>
                            <ul>
                                <li><strong>Request fee exemption</strong> - Contact admin for service fee waiver</li>
                                <li><strong>Use official agency names</strong> - Ensure proper identification</li>
                                <li><strong>Include badge/case numbers</strong> - Provide verifiable references</li>
                                <li><strong>Consider bulk operations</strong> - Plan multiple notices together</li>
                            </ul>
                            
                            <h5>Common Mistakes to Avoid:</h5>
                            <ul>
                                <li> Sending to wrong wallet address</li>
                                <li> Forgetting to sponsor acceptance fees</li>
                                <li> Using vague descriptions</li>
                                <li> Not including case numbers</li>
                                <li> Uploading unencrypted sensitive documents</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Technical Details -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Technical Information</span>
                    </button>
                    <div class="faq-content">
                        <h4>How It Works Under the Hood</h4>
                        
                        <div class="technical-info">
                            <h5>Blockchain Technology:</h5>
                            <ul>
                                <li>Built on TRON blockchain for low fees and fast transactions</li>
                                <li>Uses TRC-721 NFT standard for maximum wallet compatibility</li>
                                <li>Documents stored on IPFS (InterPlanetary File System)</li>
                                <li>Smart contracts ensure tamper-proof records</li>
                            </ul>
                            
                            <h5>Security Features:</h5>
                            <ul>
                                <li>Documents encrypted before upload</li>
                                <li>Decryption keys revealed only after acceptance</li>
                                <li>Cryptographic proof of delivery</li>
                                <li>Immutable audit trail</li>
                                <li>No central point of failure</li>
                            </ul>
                            
                            <h5>Legal Validity:</h5>
                            <ul>
                                <li>Blockchain records are increasingly recognized in courts</li>
                                <li>Provides stronger proof than traditional methods</li>
                                <li>Timestamp accuracy to the second</li>
                                <li>Cannot be altered or deleted</li>
                                <li>Global accessibility</li>
                            </ul>
                        </div>
                    </div>
                </div>
                    <div class="faq-content">
                        <h4>What are the different delivery options?</h4>
                        
                        <div class="delivery-option">
                            <h5><i class="fas fa-file-alt"></i> Notice Only (Cheapest Option)</h5>
                            <ul>
                                <li><strong>What:</strong> Sends only the IPFS document link as an NFT</li>
                                <li><strong>Cost:</strong> ~7 TRX for law enforcement, ~27 TRX for others</li>
                                <li><strong>Best for:</strong> High-volume serving where cost is critical</li>
                                <li><strong>Limitation:</strong> No visual preview in wallet</li>
                            </ul>
                        </div>
                        
                        <div class="delivery-option">
                            <h5><i class="fas fa-image"></i> Alert Only (Visual Impact)</h5>
                            <ul>
                                <li><strong>What:</strong> Sends only the preview thumbnail as an NFT</li>
                                <li><strong>Cost:</strong> ~12 TRX for law enforcement, ~32 TRX for others</li>
                                <li><strong>Best for:</strong> Urgent notifications requiring immediate attention</li>
                                <li><strong>Limitation:</strong> No access to full document</li>
                            </ul>
                        </div>
                        
                        <div class="delivery-option">
                            <h5><i class="fas fa-folder-open"></i> Full Package (Complete Service)</h5>
                            <ul>
                                <li><strong>What:</strong> Sends both alert thumbnail AND document NFT</li>
                                <li><strong>Cost:</strong> ~17 TRX for law enforcement, ~37 TRX for others</li>
                                <li><strong>Best for:</strong> Critical legal notices requiring full documentation</li>
                                <li><strong>Benefit:</strong> Complete proof of service with visual confirmation</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- When to Use Each Option -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Choosing the Right Delivery Option</span>
                    </button>
                    <div class="faq-content">
                        <h4>How do I choose the best option?</h4>
                        
                        <div class="scenario">
                            <h5>Choose "Notice Only" when:</h5>
                            <ul>
                                <li>Serving high volumes of routine notices</li>
                                <li>Recipients are expecting the documents</li>
                                <li>Cost efficiency is paramount</li>
                                <li>Visual impact is not necessary</li>
                            </ul>
                        </div>
                        
                        <div class="scenario">
                            <h5>Choose "Alert Only" when:</h5>
                            <ul>
                                <li>Immediate visual notification is critical</li>
                                <li>Document details can be communicated separately</li>
                                <li>You need attention-grabbing wallet notifications</li>
                                <li>Full document access isn't required</li>
                            </ul>
                        </div>
                        
                        <div class="scenario">
                            <h5>Choose "Full Package" when:</h5>
                            <ul>
                                <li>Serving critical legal documents</li>
                                <li>Complete chain of custody is required</li>
                                <li>Recipients need both notification and documentation</li>
                                <li>Maximum legal compliance is necessary</li>
                            </ul>
                        </div>
                        
                        <div class="info-box warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p><strong>Important:</strong> The alert image is what drives most of the cost because storing images on-blockchain is expensive. Each character in the base64 image costs gas fees.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Cost Breakdown Section -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Detailed Cost Breakdown</span>
                    </button>
                    <div class="faq-content">
                        <h4>What exactly am I paying for?</h4>
                        
                        <table class="cost-table">
                            <thead>
                                <tr>
                                    <th>User Type</th>
                                    <th>Notice Only</th>
                                    <th>Alert Only</th>
                                    <th>Full Package</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Regular User</strong></td>
                                    <td>27 TRX</td>
                                    <td>32 TRX</td>
                                    <td>37 TRX</td>
                                </tr>
                                <tr>
                                    <td><strong>Law Enforcement</strong></td>
                                    <td>7 TRX</td>
                                    <td>12 TRX</td>
                                    <td>17 TRX</td>
                                </tr>
                                <tr class="breakdown-row">
                                    <td colspan="4"><em>Fee Breakdown:</em></td>
                                </tr>
                                <tr>
                                    <td>Service Fee</td>
                                    <td>20 / 0</td>
                                    <td>20 / 0</td>
                                    <td>20 / 0</td>
                                </tr>
                                <tr>
                                    <td>Creation Fee</td>
                                    <td>5</td>
                                    <td>0</td>
                                    <td>5</td>
                                </tr>
                                <tr>
                                    <td>Alert Fee</td>
                                    <td>0</td>
                                    <td>10</td>
                                    <td>10</td>
                                </tr>
                                <tr>
                                    <td>Sponsorship</td>
                                    <td>2</td>
                                    <td>2</td>
                                    <td>2</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="cost-note">
                            <p><strong>Note:</strong> Prices shown are in TRX. Current exchange rates apply. Law enforcement agencies receive service fee exemptions to support public service.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Benefits of Blockchain -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Why Use Blockchain for Legal Notices?</span>
                    </button>
                    <div class="faq-content">
                        <h4>What makes blockchain superior for legal service?</h4>
                        
                        <div class="benefit-grid">
                            <div class="benefit-card">
                                <i class="fas fa-shield-alt"></i>
                                <h5>Immutable Proof</h5>
                                <p>Once served, the record cannot be altered, deleted, or disputed. Perfect for court proceedings.</p>
                            </div>
                            
                            <div class="benefit-card">
                                <i class="fas fa-clock"></i>
                                <h5>Timestamped</h5>
                                <p>Automatic, cryptographic timestamps prove exact service time without relying on third parties.</p>
                            </div>
                            
                            <div class="benefit-card">
                                <i class="fas fa-globe"></i>
                                <h5>Global Access</h5>
                                <p>Serve notices to any wallet address worldwide, instantly, without geographical limitations.</p>
                            </div>
                            
                            <div class="benefit-card">
                                <i class="fas fa-check-double"></i>
                                <h5>Verifiable</h5>
                                <p>Anyone can independently verify service on the blockchain without accessing private systems.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Getting Started -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Getting Started Guide</span>
                    </button>
                    <div class="faq-content">
                        <h4>For Process Servers</h4>
                        <ol class="step-list">
                            <li>Install TronLink wallet and fund with TRX</li>
                            <li>Connect wallet to the application</li>
                            <li>Register as a Process Server (one-time setup)</li>
                            <li>Choose delivery option based on your needs</li>
                            <li>Upload document and enter recipient details</li>
                            <li>Review costs and confirm transaction</li>
                        </ol>
                        
                        <h4>For Recipients</h4>
                        <ol class="step-list">
                            <li>Check your wallet for new NFT notifications</li>
                            <li>Alert NFTs show preview in most wallets</li>
                            <li>Notice NFTs contain IPFS link to full document</li>
                            <li>Accept notice to confirm receipt (FREE - sponsored)</li>
                            <li>NFT serves as permanent proof of service</li>
                        </ol>
                        
                        <h4>For Law Enforcement</h4>
                        <p>Contact administration to register your agency wallet for service fee exemption. Provide official documentation for verification.</p>
                    </div>
                </div>
                
                <!-- Technical Details -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Technical Information</span>
                    </button>
                    <div class="faq-content">
                        <h4>Smart Contract Details</h4>
                        <ul>
                            <li><strong>Network:</strong> TRON (TRC-721 Standard)</li>
                            <li><strong>Multi-chain Support:</strong> Ethereum, Polygon, BSC (coming soon)</li>
                            <li><strong>Storage:</strong> IPFS for documents, on-chain for previews</li>
                            <li><strong>Verification:</strong> All transactions viewable on TronScan</li>
                        </ul>
                        
                        <h4>Security Features</h4>
                        <ul>
                            <li>Role-based access control (Admin, Server, User)</li>
                            <li>Cryptographic signatures for all transactions</li>
                            <li>Decentralized storage prevents single point of failure</li>
                            <li>Open source contract for transparency</li>
                        </ul>
                        
                        <div class="help-links" style="margin-top: 2rem;">
                            <a href="https://github.com/JGooseK41/NFTServiceApp" target="_blank" class="btn btn-secondary">
                                <i class="fas fa-code"></i> View Source Code
                            </a>
                            <a href="#" onclick="viewContractOnTronscan('legal')" class="btn btn-secondary">
                                <i class="fas fa-search"></i> View on TronScan
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Process Server FAQ -->
                <div class="faq-section">
                    <button class="faq-header" onclick="toggleFAQ(this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Becoming a Process Server</span>
                    </button>
                    <div class="faq-content">
                        <h4>How to Register as a Process Server</h4>
                        
                        <div class="process-server-info">
                            <h5>Requirements:</h5>
                            <ul>
                                <li>Valid professional credentials (license number, certification, etc.)</li>
                                <li>Active TronLink wallet with TRX for transaction fees</li>
                                <li>Contact information for verification purposes</li>
                            </ul>
                            
                            <h5>Registration Process:</h5>
                            <ol class="step-list">
                                <li>Click "Become a Process Server" on the main dashboard</li>
                                <li>Fill out the registration form with your professional details</li>
                                <li>Provide your license/certification number</li>
                                <li>Submit contact information for verification</li>
                                <li>Wait for admin approval (typically 24-48 hours)</li>
                            </ol>
                            
                            <h5>Benefits of Registration:</h5>
                            <ul>
                                <li><strong>Professional Dashboard:</strong> Access to advanced serving features</li>
                                <li><strong>Batch Processing:</strong> Serve multiple notices efficiently</li>
                                <li><strong>Fee Discounts:</strong> Reduced service fees for verified servers</li>
                                <li><strong>Priority Support:</strong> Direct access to technical assistance</li>
                                <li><strong>Analytics:</strong> Track your service history and success rates</li>
                            </ul>
                            
                            <h5>Responsibilities:</h5>
                            <ul>
                                <li>Maintain accurate and up-to-date credentials</li>
                                <li>Follow all applicable laws and regulations</li>
                                <li>Ensure proper service of legal documents</li>
                                <li>Sponsor recipient fees when appropriate</li>
                            </ul>
                            
                            <div class="info-box" style="margin-top: 20px;">
                                <i class="fas fa-info-circle"></i>
                                <p>Need to register? <a href="#" onclick="openRegistrationForUser(); return false;">Click here to start the registration process</a></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTINUE TO PART 2 FOR MODALS -->
<!-- PART 2: ALL MODALS -->
    
    <!-- Processing Overlay -->
    <div id="processingOverlay" class="processing-overlay" style="display: none;">
        <div class="processing-card">
            <i class="fas fa-spinner loading-spinner" style="font-size: 3rem;"></i>
            <h3>Processing Transaction</h3>
            <p id="processingMessage">Please confirm the transaction in your wallet...</p>
            <div id="processingStatus"></div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-user-plus"></i>
                    Process Server Registration
                </h3>
                <button class="modal-close" onclick="closeRegistrationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Important:</strong> Registration requires admin approval. You'll be notified once approved.
                        <br><small style="margin-top: 0.5rem; display: block;">
                            <a href="#" onclick="closeRegistrationModal(); showTab('help'); setTimeout(() => { document.querySelector('.faq-header').parentElement.querySelectorAll('.faq-header')[document.querySelector('.faq-header').parentElement.querySelectorAll('.faq-header').length - 2].click(); }, 100); return false;">
                                Learn more about becoming a Process Server <i class="fas fa-external-link-alt"></i>
                            </a>
                        </small>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Agency/Company Name</label>
                    <input type="text" class="form-input" id="regAgency" 
                           placeholder="Enter your agency or company name">
                </div>
                <div class="form-group">
                    <label class="form-label">License/Certification Number</label>
                    <input type="text" class="form-input" id="regLicense" 
                           placeholder="Enter your professional license or certification number">
                    <p class="form-help">Required for verification of process server credentials</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Purpose/Use Case</label>
                    <textarea class="form-input" id="regPurpose" rows="3"
                             placeholder="Describe how you'll use the system"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Contact Email</label>
                    <input type="email" class="form-input" id="regEmail" 
                           placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-input" id="regPhone" 
                           placeholder="(555) 123-4567">
                    <p class="form-help">For verification purposes only</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Wallet Address</label>
                    <input type="text" class="form-input" id="regWallet" readonly>
                    <p class="form-help">This is your connected wallet address</p>
                </div>
                <button class="btn btn-primary" onclick="submitRegistration()">
                    <i class="fas fa-paper-plane"></i>
                    Submit Registration
                </button>
                <button class="btn btn-secondary" onclick="closeRegistrationModal()" style="margin-left: 0.5rem;">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <div id="registrationResult" style="margin-top: 1rem;"></div>
            </div>
        </div>
    </div>

    <!-- Registration Success Modal -->
    <div id="registrationSuccessModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    Registration Submitted
                </h3>
                <button class="modal-close" onclick="closeRegistrationSuccessModal()">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <i class="fas fa-user-check" style="font-size: 4rem; color: var(--success); margin-bottom: 1rem;"></i>
                <h4 style="margin-bottom: 1rem;">Your registration has been submitted successfully!</h4>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    An administrator will review your application and assign you a Server ID. 
                    You'll be notified once your registration is approved.
                </p>
                <button class="btn btn-primary" onclick="closeRegistrationSuccessModal()">
                    <i class="fas fa-check"></i>
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Mint Modal -->
    <div id="mintModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-upload"></i>
                    Create Legal Notice
                </h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-secondary" onclick="clearAllFormData()" style="font-size: 0.9rem;" title="Clear all form data">
                        <i class="fas fa-eraser"></i>
                        Clear All
                    </button>
                    <button class="btn btn-secondary" onclick="openBatchMode()" style="font-size: 0.9rem;">
                        <i class="fas fa-layer-group"></i>
                        Batch Mode
                    </button>
                    <button class="modal-close" onclick="closeMintModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <!-- Step 1: Upload -->
                <div id="mintStep1">
                    <h4 style="margin-bottom: 1rem;">Step 1: Upload Document Image</h4>
                    <div class="alert alert-info" style="margin-bottom: 1rem;">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Document Requirements:</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                                <li>Format: JPEG or PNG only</li>
                                <li>Recommended: 8.511" documents</li>
                                <li>Max file size: 400KB after compression</li>
                                <li>Documents will be automatically optimized for blockchain storage</li>
                                <li>High-resolution documents will be compressed to ensure transaction success</li>
                            </ul>
                        </div>
                    </div>
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary);"></i>
                        <p>Drag & drop your document here or click to browse</p>
                        <p style="font-size: 0.85rem; color: #666;">Supported formats: JPEG, PNG</p>
                        <input type="file" id="documentUpload" accept="image/jpeg,image/jpg,image/png,application/pdf,.pdf" onchange="handleDocumentUpload(event)">
                        <!-- Backup button in case click handler fails -->
                        <button type="button" class="btn btn-primary" style="margin-top: 10px;" onclick="document.getElementById('documentUpload').click()">
                            <i class="fas fa-folder-open"></i> Select File
                        </button>
                    </div>
                    <div id="compressionStatus" class="compression-status" style="display: none;">
                        <h5 style="color: var(--accent-blue); margin-bottom: 0.5rem;">
                            <i class="fas fa-compress"></i> Processing Document
                        </h5>
                        <div id="compressionStatusText" style="margin-bottom: 0.5rem; color: var(--text-secondary);">Preparing...</div>
                        <div class="compression-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="compressionProgress" style="width: 0%;"></div>
                            </div>
                            <div class="progress-text" id="compressionText">0%</div>
                        </div>
                        <div id="compressionDetails" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);"></div>
                    </div>
                    
                    <!-- Next button to proceed to step 2 -->
                    <div id="proceedToStep2" style="display: none; margin-top: 30px; text-align: center;">
                        <button class="btn btn-primary btn-lg" onclick="showMintStep2()" style="padding: 1rem 2rem; font-size: 1.1rem;">
                            <i class="fas fa-arrow-right"></i>
                            Next: Enter Notice Details
                        </button>
                    </div>
                </div>

                <!-- Step 2: Details -->
                <div id="mintStep2" style="display: none;">
                    <h4 style="margin-bottom: 1rem;">Step 2: Legal Notice Details</h4>
                    
                    <div class="preview-container">
                        <div class="preview-image">
                            <img id="documentPreview" src="" alt="Document preview">
                            <button class="btn btn-secondary btn-small" style="margin-top: 0.5rem;" onclick="changeDocument()">
                                <i class="fas fa-exchange-alt"></i>
                                Change
                            </button>
                            <div id="uploadMetadata" class="upload-metadata" style="display: none;">
                                <h5>Document Info</h5>
                                <div class="metadata-item">
                                    <span>Original Size:</span>
                                    <strong id="originalSize">-</strong>
                                </div>
                                <div class="metadata-item">
                                    <span>Final Size:</span>
                                    <strong id="finalSize">-</strong>
                                </div>
                                <div class="metadata-item">
                                    <span>Compression:</span>
                                    <strong id="compressionRatio">-</strong>
                                </div>
                                <div class="metadata-item">
                                    <span>Format:</span>
                                    <strong id="fileFormat">-</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div class="preview-details">
                            <div class="form-group">
                                <label class="form-label">Recipient Address <span style="color: var(--error);">*</span></label>
                                <input type="text" class="form-input" id="mintRecipient" 
                                       placeholder="Enter recipient's TRON address" required>
                                <div class="validation-message" id="recipientValidation" style="display: none;"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Token Name</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span id="tokenPrefix" style="background: #374151; padding: 0.75rem; border-radius: 0.375rem 0 0 0.375rem; border: 1px solid #4b5563; border-right: none; color: #9ca3af; font-family: monospace;">PS#?-</span>
                                    <input type="text" class="form-input" id="mintTokenName" 
                                           placeholder="Legal Notice" 
                                           style="border-radius: 0 0.375rem 0.375rem 0; flex: 1;">
                                </div>
                                <p class="form-help">Token name (will be prepended with your server ID, e.g., PS#1-Legal Notice)</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Case Number</label>
                                <input type="text" class="form-input" id="mintCaseNumber" 
                                       placeholder="e.g., CV-2024-001234">
                                <p class="form-help">Use your standard case numbering format</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Jurisdiction</label>
                                <select class="form-input" id="mintJurisdiction">
                                    <option value="0">Federal</option>
                                    <option value="1">State</option>
                                    <option value="2">County</option>
                                    <option value="3">Municipal</option>
                                    <option value="4">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Document Type</label>
                                <select class="form-input" id="mintDocumentType">
                                    <option value="0">Summons</option>
                                    <option value="1">Complaint</option>
                                    <option value="2">Subpoena</option>
                                    <option value="3">Notice of Hearing</option>
                                    <option value="4">Notice of Seizure</option>
                                    <option value="5">Other</option>
                                </select>
                            </div>
                            
                            <!-- Delivery Method Selection -->
                            <div class="form-group">
                                <label class="form-label">Delivery Method</label>
                                <div class="delivery-options">
                                    <label class="delivery-option selected">
                                        <input type="radio" name="deliveryMethod" value="document" checked>
                                        <div class="delivery-option-title">
                                            <i class="fas fa-file-shield"></i> Document Images
                                        </div>
                                        <div class="delivery-option-cost">~150 TRX</div>
                                        <div class="delivery-option-desc">
                                            <strong>Secure Legal Service:</strong> Encrypted document + public text notice
                                            <br><small> Document encrypted with recipient's wallet</small>
                                            <br><small> Requires signature for proof of service</small>
                                            <br><small> Text notice will be publicly visible</small>
                                        </div>
                                    </label>
                                    
                                    <label class="delivery-option">
                                        <input type="radio" name="deliveryMethod" value="text">
                                        <div class="delivery-option-title">
                                            <i class="fas fa-comment-alt"></i> Text Only
                                        </div>
                                        <div class="delivery-option-cost">~15 TRX</div>
                                        <div class="delivery-option-desc">
                                            <strong>Public Notice:</strong> Text message only, no documents
                                            <br><small> For reminders, preliminary notices</small>
                                            <br><small> No signature required (view only)</small>
                                            <br><small> All content will be publicly visible</small>
                                        </div>
                                    </label>
                                    
                                </div>
                            </div>
                            
                            <!-- Document Images Notice Details -->
                            <div class="view-gated-details" id="viewGatedDetails" style="display: block;">
                                <div class="alert alert-info" style="margin-bottom: 1rem; background: #fef3c7; border-color: #f59e0b; color: #92400e;">
                                    <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                                    <strong>Important Privacy Notice:</strong>
                                    <br> The document image will be encrypted and only viewable by the recipient
                                    <br> The text fields below will be <strong>publicly visible on the blockchain</strong>
                                    <br> Only include non-sensitive information in these text fields
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Notice Type</label>
                                    <select id="noticeType" class="form-select" onchange="updateNoticeTemplate()">
                                        <option value="Notice of Seizure">Notice of Seizure</option>
                                        <option value="Summons">Summons</option>
                                        <option value="Subpoena">Subpoena</option>
                                        <option value="Restraining Order">Restraining Order</option>
                                        <option value="Eviction Notice">Eviction Notice</option>
                                        <option value="Legal Hold">Legal Hold</option>
                                        <option value="Asset Freeze">Asset Freeze</option>
                                        <option value="Custom" selected>Custom Notice</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" id="customNoticeTypeGroup" style="display: block;">
                                    <label class="form-label">Custom Notice Type</label>
                                    <input type="text" id="customNoticeType" class="form-input" 
                                           placeholder="e.g., Notice of Forfeiture" maxlength="50">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Issuing Agency</label>
                                    <input type="text" id="issuingAgency" class="form-input" 
                                           placeholder="e.g., U.S. Department of Justice, IRS, SEC" 
                                           maxlength="100" required>
                                    <p class="form-help">Government agency or court issuing this notice</p>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Case Number</label>
                                    <input type="text" id="caseNumber" class="form-input" 
                                           placeholder="e.g., CV-2024-001234 or 24-CR-5678" 
                                           maxlength="50" required>
                                    <p class="form-help">Official case or docket number</p>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Specific Details / Amount</label>
                                    <input type="text" id="caseDetails" class="form-input" 
                                           placeholder="e.g., 245,000 USDT or Property at 123 Main St" 
                                           maxlength="100">
                                    <p class="form-help">Amount seized, property address, or other specifics</p>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Legal Rights Statement</label>
                                    <input type="text" id="legalRights" class="form-input" 
                                           placeholder="e.g., You have a right to contest this seizure" 
                                           maxlength="100"
                                           value="You have the right to contest this action">
                                    <p class="form-help">Inform recipient of their legal rights</p>
                                </div>
                                
                                <div class="form-group" style="background: #1e293b; padding: 1rem; border-radius: 0.5rem; border: 1px solid #334155;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <i class="fas fa-gift" style="color: #10b981;"></i>
                                        <span style="font-weight: 600;">Recipient Sponsorship Included</span>
                                    </div>
                                    <p class="form-help" style="margin: 0;">All notices include a 2 TRX sponsorship fee that covers the recipient's acceptance costs. This ensures recipients can always view their legal documents without needing TRX.</p>
                                </div>
                            </div>
                            
                            <!-- Text Notice Input -->
                            <div class="text-notice-input active" id="textNoticeGroup" style="display: block;">
                                <div class="form-group" style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem; border: 2px solid #f59e0b;">
                                    <label for="noticeText" id="noticeTextLabel">
                                        <i class="fas fa-globe" style="color: #f59e0b;"></i> Public Notice Text
                                    </label>
                                    <input type="text" class="form-input" id="noticeText" 
                                           placeholder="e.g., Legal Notice: Summons for Case #CV-2024-001234"
                                           maxlength="100"
                                           style="border: 2px solid #f59e0b;">
                                    <div class="char-count"><span id="charCount">0</span> / 100 characters</div>
                                    <p class="form-help" id="noticeTextHelp" style="color: #92400e; font-weight: 500;">
                                        <i class="fas fa-exclamation-circle"></i> This text will be publicly visible on the blockchain
                                    </p>
                                </div>
                            </div>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-coins"></i>
                                <div>
                                    <strong>Estimated Fee:</strong> <span id="creationFeeDisplay">150 TRX</span>
                                    <br><small id="feeDescription">Encrypted document with public text notice</small>
                                </div>
                            </div>
                            
                            <!-- Note: Delivery confirmation is automatically tracked on-chain for all notices -->
                        </div>
                    </div>
                    
                    <!-- Fee Summary Display -->
                    <div id="feeSummaryBox" class="fee-summary-box" style="background: #1e293b; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid #334155; margin-top: 1.5rem;">
                        <h5 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-calculator" style="color: #3b82f6;"></i>
                            Total Cost Estimate
                        </h5>
                        <div class="fee-breakdown">
                            <div class="fee-item" style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #334155;">
                                <span id="feeTypeLabel">Document Notice Fee:</span>
                                <span id="baseFeeAmount" style="font-weight: 600;">150 TRX</span>
                            </div>
                            <div class="fee-item" style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #334155;">
                                <span>Recipient Sponsorship:</span>
                                <span style="font-weight: 600;">2 TRX</span>
                            </div>
                            <div class="fee-item" id="energyFeeItem" style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #334155;">
                                <span>Estimated Energy Cost:</span>
                                <span id="energyCostAmount" style="font-weight: 600; color: #f59e0b;">~90 TRX</span>
                            </div>
                            <div class="fee-total" style="display: flex; justify-content: space-between; padding: 0.75rem 0 0 0; font-size: 1.125rem;">
                                <span style="font-weight: 600;">Total Estimated Cost:</span>
                                <span id="totalCostAmount" style="font-weight: 700; color: #10b981;">~242 TRX</span>
                            </div>
                        </div>
                        <div class="fee-notes" style="margin-top: 1rem; font-size: 0.875rem; color: #94a3b8;">
                            <p id="energyNote" style="margin: 0.5rem 0;">
                                <i class="fas fa-info-circle"></i> Energy costs apply if you don't have staked TRX. 
                                <a href="https://tronscan.org/#/sr/representatives" target="_blank" style="color: #3b82f6;">Stake TRX</a> to avoid energy fees.
                            </p>
                            <p id="feeExemptionNote" style="margin: 0.5rem 0; display: none; color: #10b981;">
                                <i class="fas fa-check-circle"></i> <span id="exemptionText">Fee exemption applied</span>
                            </p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button class="btn btn-secondary" onclick="showMintStep(1)">
                            <i class="fas fa-arrow-left"></i>
                            Back
                        </button>
                        <button class="btn btn-primary" onclick="createLegalNotice()" id="createNoticeBtn">
                            <i class="fas fa-rocket"></i>
                            Create Legal Notice
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Result Modal -->
    <div id="transactionResultModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title" id="txResultTitle">
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    Transaction Complete
                </h3>
                <button class="modal-close" onclick="closeTransactionResultModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="txResultContent" style="padding: 1rem;">
                    <!-- Content will be dynamically populated -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeTransactionResultModal()">
                    <i class="fas fa-check"></i> Done
                </button>
            </div>
        </div>
    </div>

    <!-- Batch Mode Modal -->
    <div id="batchModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-layer-group"></i>
                    Batch Legal Notice Creation
                </h3>
                <button class="modal-close" onclick="closeBatchModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="batchStep1">
                    <h4>Upload Recipients CSV</h4>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>CSV Format Requirements:</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem;">
                                <li>Columns: wallet_address, notice_type, public_text (optional)</li>
                                <li>Maximum 100 recipients per batch</li>
                                <li>Example: TXa1b2c3..., Cease and Desist, Public notice text</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="upload-area" style="margin: 20px 0;" onclick="document.getElementById('csvUpload').click()">
                        <input type="file" id="csvUpload" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
                        <i class="fas fa-file-csv" style="font-size: 3rem; color: var(--primary);"></i>
                        <p>Click to upload CSV file</p>
                    </div>
                    
                    <h4 style="margin-top: 30px;">Upload Document (Optional)</h4>
                    <div class="upload-area" onclick="document.getElementById('batchDocumentUpload').click()">
                        <input type="file" id="batchDocumentUpload" accept="image/*,.pdf" style="display: none;" onchange="handleBatchDocumentUpload(event)">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary);"></i>
                        <p>Click to upload document</p>
                        <p style="font-size: 0.85rem; color: #666;">Same document will be encrypted individually for each recipient</p>
                    </div>
                </div>
                
                <div id="batchStep2" style="display: none;">
                    <h4>Review Batch Recipients</h4>
                    <div id="batchValidationResults"></div>
                    
                    <div style="margin: 20px 0;">
                        <label>Notice Details</label>
                        <input type="text" id="batchAgencyName" placeholder="Issuing Agency" class="form-control" style="margin-bottom: 10px;">
                        <input type="text" id="batchCaseNumber" placeholder="Case Number" class="form-control" style="margin-bottom: 10px;">
                        <textarea id="batchRightsStatement" placeholder="Legal Rights Statement" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="batchManager.goBack()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <button class="btn btn-primary" onclick="batchManager.startBatch()">
                            <i class="fas fa-play"></i> Start Batch Processing
                        </button>
                    </div>
                </div>
                
                <div id="batchStep3" style="display: none;">
                    <h4>Processing Batch</h4>
                    <div class="batch-progress">
                        <div class="progress-bar">
                            <div id="batchProgressBar" class="progress-fill" style="width: 0%"></div>
                        </div>
                        <p id="batchProgressText" style="text-align: center; margin-top: 10px;">0 / 0 completed</p>
                    </div>
                    
                    <div id="batchResults" style="margin-top: 20px; max-height: 300px; overflow-y: auto;"></div>
                    
                    <div class="btn-group" style="margin-top: 20px;">
                        <button id="pauseBatchBtn" class="btn btn-secondary" onclick="batchManager.pauseBatch()">
                            <i class="fas fa-pause"></i> Pause
                        </button>
                        <button id="resumeBatchBtn" class="btn btn-secondary" onclick="batchManager.resumeBatch()" style="display: none;">
                            <i class="fas fa-play"></i> Resume
                        </button>
                        <button class="btn btn-primary" onclick="batchManager.exportResults()">
                            <i class="fas fa-download"></i> Export Results
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Modal -->
    <div id="auditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-clipboard-check"></i>
                    Notice Audit & Delivery Status
                </h3>
                <button class="modal-close" onclick="closeAuditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Search Options</label>
                    <select class="form-input" id="auditSearchType" onchange="updateAuditSearch()">
                        <option value="noticeId">By Notice ID</option>
                        <option value="myNotices">My Issued Notices</option>
                        <option value="myAlerts">My Alert Notices</option>
                    </select>
                </div>
                
                <div id="auditSearchInput" class="form-group">
                    <label class="form-label">Notice ID</label>
                    <input type="text" class="form-input" id="auditNoticeId" 
                           placeholder="Enter notice ID (e.g., 0, 1, 2...)">
                </div>
                
                <button class="btn btn-primary" onclick="performAudit()" id="performAuditBtn">
                    <i class="fas fa-search"></i>
                    Search
                </button>
                
                <div id="auditResults" style="margin-top: 2rem;"></div>
            </div>
        </div>
    </div>

    <!-- Accept Notice Modal -->
    <div id="acceptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-signature" style="color: #3b82f6;"></i>
                    Electronic Signature Required - Legal Notice Receipt
                </h3>
                <button class="modal-close" onclick="closeAcceptModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom: 1rem; background: #e0f2fe; border-color: #3b82f6;">
                    <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                    <div>
                        <strong>Electronic Signature Request</strong>
                        <p style="margin: 0.25rem 0 0 0;">By clicking "Sign Receipt" below, you are electronically signing that you have received this legal document. This is similar to signing for certified mail or a courier delivery.</p>
                        <p style="margin: 0.25rem 0 0 0; font-weight: 600;">Important: This signature only confirms receipt. It does NOT mean you agree with the contents, admit any wrongdoing, or waive any of your legal rights.</p>
                        <p style="margin: 0.5rem 0 0 0; color: #dc2626; font-weight: 600;">
                            <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                            Warning: Failing to respond to this legal notice by the deadline may result in default judgment against you.
                        </p>
                    </div>
                </div>
                
                <div id="acceptDetails" style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">Document Information</h4>
                    <div class="token-item">
                        <div class="token-details">
                            <div class="token-detail">
                                <span>Notice ID:</span>
                                <span id="acceptNoticeId">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Document Type:</span>
                                <span id="acceptDocumentType">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Jurisdiction:</span>
                                <span id="acceptJurisdiction">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Case Number Hash:</span>
                                <span id="acceptCaseNumber">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Server:</span>
                                <span id="acceptServer">-</span>
                            </div>
                            <div class="token-detail">
                                <span>Timestamp:</span>
                                <span id="acceptTimestamp">-</span>
                            </div>
                        </div>
                        <div id="acceptPreview" class="token-preview" style="display: none;">
                            <img id="acceptPreviewImage" src="" alt="Document preview">
                        </div>
                    </div>
                </div>

                <div class="alert alert-warning" style="background: #fef3c7; border-color: #f59e0b;">
                    <i class="fas fa-file-signature" style="color: #d97706;"></i>
                    <div>
                        <strong>Legal Effect of Your Signature:</strong> Your electronic signature will be permanently recorded on the blockchain as proof that this document was delivered to you. This is legally equivalent to signing for certified mail and creates an immutable record of service.
                    </div>
                </div>

                <div style="margin-top: 1.5rem; display: flex; justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="closeAcceptModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="acceptNotice()" id="acceptNoticeBtn" style="background: #3b82f6; border-color: #3b82f6; padding: 0.75rem 1.5rem;">
                        <i class="fas fa-signature"></i>
                        Sign Receipt & Confirm Delivery
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Process Server Registration Modal -->
    <div id="registrationModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2><i class="fas fa-user-tie"></i> Process Server Registration</h2>
                <span class="close-btn" onclick="closeRegistrationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <i class="fas fa-info-circle"></i>
                    <strong>Note:</strong> The hybrid contract auto-assigns server IDs when roles are granted. 
                    Process servers cannot update their name/agency details after registration. 
                    Please ensure all information is correct before submitting.
                </div>
                <p style="margin-bottom: 1.5rem;">Please provide your professional information to complete process server registration. 
                <a href="#" onclick="closeRegistrationModal(); switchTab('help'); document.getElementById('faq-process-server').scrollIntoView();" style="color: var(--accent-blue);">
                    Learn more about being a process server 
                </a></p>
                
                <div class="form-group">
                    <label class="form-label">Agency Name *</label>
                    <input type="text" class="form-input" id="modalAgencyName" placeholder="e.g., Smith & Associates Process Service">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Agency Email *</label>
                    <input type="email" class="form-input" id="modalAgencyEmail" placeholder="agency@example.com">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Server Name *</label>
                    <input type="text" class="form-input" id="modalServerName" placeholder="Full name of process server">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" class="form-input" id="modalServerPhone" placeholder="(555) 123-4567">
                </div>
                
                <div class="form-group">
                    <label class="form-label">License Number</label>
                    <input type="text" class="form-input" id="modalLicenseNumber" placeholder="Optional: Professional license number">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Service Areas</label>
                    <textarea class="form-input" id="modalServiceAreas" rows="3" placeholder="List jurisdictions where you serve legal documents"></textarea>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Note:</strong> This information will be stored locally and associated with your wallet address for verification purposes.
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; display: flex; justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="closeRegistrationModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="submitAdminRegistration()">
                        <i class="fas fa-check"></i>
                        Complete Registration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Success Modal -->
    <div id="txModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    Transaction Successful
                </h3>
                <button class="modal-close" onclick="closeTxModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="txMessage" style="color: var(--text-primary); margin-bottom: 1rem;">
                    Your transaction has been successfully confirmed!
                </p>
                <div id="txDetails" style="margin-bottom: 1rem;"></div>
                <div class="tx-details">
                    <strong>Transaction Hash:</strong>
                    <div class="tx-hash" id="txHash"></div>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap;">
                <a id="txLink" href="#" target="_blank" class="btn btn-primary" style="text-decoration: none;">
                    <i class="fas fa-external-link-alt"></i>
                    View on Tronscan
                </a>
                <button class="btn btn-secondary" onclick="copyTxHash()">
                    <i class="fas fa-copy"></i>
                    Copy Hash
                </button>
                <button class="btn btn-secondary" onclick="exportReceipt()">
                    <i class="fas fa-print"></i>
                    Export Receipt
                </button>
                <button class="btn btn-secondary" onclick="closeTxModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- BEGIN JAVASCRIPT IN PART 3 -->
<!-- PART 3: JAVASCRIPT -->
    <script>
        // Configuration - Set your API keys here for production
        // Better approach: Use environment variables or server-side proxy
        
        // Pinata IPFS Configuration
        window.PINATA_CONFIG = {
            // Replace these with your actual Pinata API keys
            // Or leave empty to use localStorage configuration
            apiKey: '',
            secretKey: ''
        };
        
        // GitHub Storage Configuration
        window.GITHUB_STORAGE_CONFIG = {
            // Replace with your GitHub personal access token
            // Or leave empty to use localStorage configuration
            token: '',
            // IMPORTANT: Change this encryption key for security
            encryptionKey: 'NFTServiceApp-ProcessServer-SecureKey-2024'
        };
        
        // Global variables
        let tronWeb = null;
        let legalContract = null;
        let currentUserServerId = null;
        let isAdmin = false;
        let isProcessServer = false;
        
        // Server registration management
        let serverRegistrations = {};
        try {
            serverRegistrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
        } catch (e) {
            serverRegistrations = {};
        }
        let recentActivity = [];
        
        // Fee configuration
        let currentCreationFee = 0.1; // Default value in TRX
        
        // Document upload vars
        let uploadedImage = null;
        let uploadedFileInfo = null;
        let currentNoticeId = null;
        
        // Contract ABI - Complete ABI with all functions
        const CONTRACT_ABI = [
    {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "owner",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "approved",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "Approval",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "owner",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "operator",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "bool",
                "name": "approved",
                "type": "bool"
            }
        ],
        "name": "ApprovalForAll",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "_fromTokenId",
                "type": "uint256"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "_toTokenId",
                "type": "uint256"
            }
        ],
        "name": "BatchMetadataUpdate",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "_tokenId",
                "type": "uint256"
            }
        ],
        "name": "MetadataUpdate",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "uint256",
                "name": "noticeId",
                "type": "uint256"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "recipient",
                "type": "address"
            }
        ],
        "name": "NoticeAccepted",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "uint256",
                "name": "noticeId",
                "type": "uint256"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "recipient",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "sender",
                "type": "address"
            }
        ],
        "name": "NoticeCreated",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "bytes32",
                "name": "role",
                "type": "bytes32"
            },
            {
                "indexed": true,
                "internalType": "bytes32",
                "name": "previousAdminRole",
                "type": "bytes32"
            },
            {
                "indexed": true,
                "internalType": "bytes32",
                "name": "newAdminRole",
                "type": "bytes32"
            }
        ],
        "name": "RoleAdminChanged",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "bytes32",
                "name": "role",
                "type": "bytes32"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "account",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "sender",
                "type": "address"
            }
        ],
        "name": "RoleGranted",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "bytes32",
                "name": "role",
                "type": "bytes32"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "account",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "sender",
                "type": "address"
            }
        ],
        "name": "RoleRevoked",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "from",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "Transfer",
        "type": "event"
    },
    {
        "inputs": [],
        "name": "ADMIN_ROLE",
        "outputs": [
            {
                "internalType": "bytes32",
                "name": "",
                "type": "bytes32"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "DEFAULT_ADMIN_ROLE",
        "outputs": [
            {
                "internalType": "bytes32",
                "name": "",
                "type": "bytes32"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "PROCESS_SERVER_ROLE",
        "outputs": [
            {
                "internalType": "bytes32",
                "name": "",
                "type": "bytes32"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "noticeId",
                "type": "uint256"
            }
        ],
        "name": "acceptNotice",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "approve",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "owner",
                "type": "address"
            }
        ],
        "name": "balanceOf",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "components": [
                    {
                        "internalType": "address[]",
                        "name": "recipients",
                        "type": "address[]"
                    },
                    {
                        "internalType": "string",
                        "name": "publicText",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "metadata",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "documentData",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "tokenNamePrefix",
                        "type": "string"
                    },
                    {
                        "internalType": "bool",
                        "name": "hasDocument",
                        "type": "bool"
                    },
                    {
                        "internalType": "bool",
                        "name": "sponsorFees",
                        "type": "bool"
                    }
                ],
                "internalType": "struct LegalNoticeNFT_Optimized.BatchRequest",
                "name": "req",
                "type": "tuple"
            }
        ],
        "name": "createBatchNotices",
        "outputs": [
            {
                "internalType": "uint256[]",
                "name": "",
                "type": "uint256[]"
            }
        ],
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "components": [
                    {
                        "internalType": "address",
                        "name": "recipient",
                        "type": "address"
                    },
                    {
                        "internalType": "string",
                        "name": "publicText",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "noticeType",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "caseNumber",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "issuingAgency",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "baseTokenName",
                        "type": "string"
                    },
                    {
                        "internalType": "bool",
                        "name": "hasDocument",
                        "type": "bool"
                    },
                    {
                        "internalType": "string",
                        "name": "encryptedIPFS",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "encryptionKey",
                        "type": "string"
                    }
                ],
                "internalType": "struct LegalNoticeNFT_Optimized.NoticeRequest",
                "name": "req",
                "type": "tuple"
            }
        ],
        "name": "createNotice",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "creationFee",
        "outputs": [
            {
                "internalType": "uint128",
                "name": "",
                "type": "uint128"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "feeCollector",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "getApproved",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "noticeId",
                "type": "uint256"
            }
        ],
        "name": "getNotice",
        "outputs": [
            {
                "components": [
                    {
                        "internalType": "address",
                        "name": "recipient",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "sender",
                        "type": "address"
                    },
                    {
                        "internalType": "string",
                        "name": "documentData",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "publicText",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "metadata",
                        "type": "string"
                    },
                    {
                        "internalType": "uint256",
                        "name": "packedData",
                        "type": "uint256"
                    },
                    {
                        "internalType": "string",
                        "name": "tokenName",
                        "type": "string"
                    }
                ],
                "internalType": "struct LegalNoticeNFT_Optimized.Notice",
                "name": "",
                "type": "tuple"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "bytes32",
                "name": "role",
                "type": "bytes32"
            }
        ],
        "name": "getRoleAdmin",
        "outputs": [
            {
                "internalType": "bytes32",
                "name": "",
                "type": "bytes32"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "bytes32",
                "name": "role",
                "type": "bytes32"
            },
            {
                "internalType": "address",
                "name": "account",
                "type": "address"
            }
        ],
        "name": "grantRole",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "bytes32",
                "name": "role",
                "type": "bytes32"
            },
            {
                "internalType": "address",
                "name": "account",
                "type": "address"
            }
        ],
        "name": "hasRole",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "owner",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "operator",
                "type": "address"
            }
        ],
        "name": "isApprovedForAll",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "lawEnforcementAgencies",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "lawEnforcementExemptions",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "name",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "notices",
        "outputs": [
            {
                "internalType": "address",
                "name": "recipient",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "sender",
                "type": "address"
            },
            {
                "internalType": "string",
                "name": "documentData",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "publicText",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "metadata",
                "type": "string"
            },
            {
                "internalType": "uint256",
                "name": "packedData",
                "type": "uint256"
            },
            {
                "internalType": "string",
                "name": "tokenName",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "ownerOf",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "paused",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "processServers",
        "outputs": [
            {
                "internalType": "uint128",
                "name": "serverId",
                "type": "uint128"
            },
            {
                "internalType": "uint128",
                "name": "noticesServed",
                "type": "uint128"
            },
            {
                "internalType": "uint256",
                "name": "registeredDate",
                "type": "uint256"
            },
            {
                "internalType": "string",
                "name": "name",
                "type": "string"
            },
            {
                "internalType": "string",
                "name": "agency",
                "type": "string"
            },
            {
                "internalType": "bool",
                "name": "active",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "recipientNotices",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "bytes32",
                "name": "role",
                "type": "bytes32"
            },
            {
                "internalType": "address",
                "name": "account",
                "type": "address"
            }
        ],
        "name": "renounceRole",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "bytes32",
                "name": "role",
                "type": "bytes32"
            },
            {
                "internalType": "address",
                "name": "account",
                "type": "address"
            }
        ],
        "name": "revokeRole",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "from",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "safeTransferFrom",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "from",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            },
            {
                "internalType": "bytes",
                "name": "data",
                "type": "bytes"
            }
        ],
        "name": "safeTransferFrom",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "senderNotices",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "serverIdToAddress",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "serviceFee",
        "outputs": [
            {
                "internalType": "uint128",
                "name": "",
                "type": "uint128"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "operator",
                "type": "address"
            },
            {
                "internalType": "bool",
                "name": "approved",
                "type": "bool"
            }
        ],
        "name": "setApprovalForAll",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "user",
                "type": "address"
            },
            {
                "internalType": "string",
                "name": "agencyName",
                "type": "string"
            }
        ],
        "name": "setLawEnforcementExemption",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "sponsorshipFee",
        "outputs": [
            {
                "internalType": "uint128",
                "name": "",
                "type": "uint128"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "bytes4",
                "name": "interfaceId",
                "type": "bytes4"
            }
        ],
        "name": "supportsInterface",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "symbol",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "textOnlyFee",
        "outputs": [
            {
                "internalType": "uint128",
                "name": "",
                "type": "uint128"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "index",
                "type": "uint256"
            }
        ],
        "name": "tokenByIndex",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "owner",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "index",
                "type": "uint256"
            }
        ],
        "name": "tokenOfOwnerByIndex",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "tokenURI",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "totalSupply",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "from",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "tokenId",
                "type": "uint256"
            }
        ],
        "name": "transferFrom",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    }
];


async function getRecipientNoticeIds(recipient) {
    try {
        // The optimized contract may not have this function
        // We need to use events or enumerate through NFTs
        const balance = await legalContract.balanceOf(recipient).call();
        const noticeIds = [];
        
        for (let i = 0; i < balance; i++) {
            try {
                const tokenId = await legalContract.tokenOfOwnerByIndex(recipient, i).call();
                noticeIds.push(tokenId);
            } catch (e) {
                console.log('Error getting token at index', i, e);
            }
        }
        
        return noticeIds;
    } catch (error) {
        console.error('Error getting recipient notices:', error);
        return [];
    }
}


async function calculateFeeFromConstants(userAddress) {
    try {
        // Check if user is law enforcement exempt
        const isExempt = await legalContract.lawEnforcementExemptions(userAddress).call();
        
        // Get fee constants
        const serviceFee = await legalContract.serviceFee().call();
        const creationFee = await legalContract.creationFee().call();
        const sponsorshipFee = await legalContract.sponsorshipFee().call();
        
        if (isExempt) {
            // Law enforcement only pays creation + sponsorship
            return parseInt(creationFee) + parseInt(sponsorshipFee);
        } else {
            // Regular users pay all fees
            return parseInt(serviceFee) + parseInt(creationFee) + parseInt(sponsorshipFee);
        }
    } catch (error) {
        console.error('Error calculating fee:', error);
        // Default fee if calculation fails
        return 32000000; // 32 TRX default
    }
}

// Helper functions for parsing optimized contract data
function parseMetadata(metadata) {
    const parts = metadata.split('|');
    return {
        noticeType: parts[0] || '',
        caseNumber: parts[1] || '',
        issuingAgency: parts[2] || ''
    };
}

function parseDocumentData(documentData) {
    const parts = documentData.split('|');
    return {
        encryptedIPFS: parts[0] || '',
        encryptionKey: parts[1] || ''
    };
}

function parsePackedData(packedData) {
    const data = BigInt(packedData);
    return {
        timestamp: Number(data >> 192n),
        serverId: Number((data >> 64n) & 0xFFFFFFFFFFFFFFFFn),
        hasDocument: (data & 1n) === 1n,
        accepted: ((data >> 1n) & 1n) === 1n
    };
}


        
        // Get total notices from contract
        async function getTotalNotices() {
            if (!legalContract) return 0;
            
            try {
                const total = await legalContract.totalSupply().call();
                return parseInt(total);
            } catch (error) {
                console.log('Could not fetch total notices:', error);
                return 0;
            }
        }

        // Multi-chain configuration
        const CHAIN_CONFIG = {
            tron: {
                mainnet: {
                    name: 'TRON Mainnet',
                    contractAddress: window.APP_CONFIG?.contracts.tron.mainnet || 'TYour_Mainnet_Contract_Address',
                    explorerUrl: 'https://tronscan.org',
                    nativeToken: 'TRX',
                    chainId: null
                },
                nile: {
                    name: 'TRON Nile Testnet',
                    contractAddress: window.APP_CONFIG?.contracts.tron.nile || 'TEZxBmj16pKdsJh3aDE9Y4RLSuXuBuUSp8',
                    explorerUrl: 'https://nile.tronscan.org',
                    nativeToken: 'TRX',
                    chainId: null
                },
                shasta: {
                    name: 'TRON Shasta Testnet',
                    contractAddress: window.APP_CONFIG?.contracts.tron.shasta || 'TYour_Shasta_Contract_Address',
                    explorerUrl: 'https://shasta.tronscan.org',
                    nativeToken: 'TRX',
                    chainId: null
                }
            },
            evm: {
                ethereum: {
                    name: 'Ethereum Mainnet',
                    contractAddress: '0xYour_Ethereum_Contract_Address',
                    explorerUrl: 'https://etherscan.io',
                    nativeToken: 'ETH',
                    chainId: 1,
                    rpcUrl: 'https://eth-mainnet.g.alchemy.com/v2/YOUR_ALCHEMY_KEY'
                },
                sepolia: {
                    name: 'Ethereum Sepolia',
                    contractAddress: '0xYour_Sepolia_Contract_Address',
                    explorerUrl: 'https://sepolia.etherscan.io',
                    nativeToken: 'ETH',
                    chainId: 11155111,
                    rpcUrl: 'https://eth-sepolia.g.alchemy.com/v2/YOUR_ALCHEMY_KEY'
                },
                polygon: {
                    name: 'Polygon Mainnet',
                    contractAddress: '0xYour_Polygon_Contract_Address',
                    explorerUrl: 'https://polygonscan.com',
                    nativeToken: 'MATIC',
                    chainId: 137,
                    rpcUrl: 'https://polygon-rpc.com'
                },
                mumbai: {
                    name: 'Polygon Mumbai',
                    contractAddress: '0xYour_Mumbai_Contract_Address',
                    explorerUrl: 'https://mumbai.polygonscan.com',
                    nativeToken: 'MATIC',
                    chainId: 80001,
                    rpcUrl: 'https://rpc-mumbai.maticvigil.com'
                },
                bsc: {
                    name: 'BNB Smart Chain',
                    contractAddress: '0xYour_BSC_Contract_Address',
                    explorerUrl: 'https://bscscan.com',
                    nativeToken: 'BNB',
                    chainId: 56,
                    rpcUrl: 'https://bsc-dataseed.binance.org'
                },
                bscTestnet: {
                    name: 'BSC Testnet',
                    contractAddress: '0xYour_BSC_Testnet_Contract_Address',
                    explorerUrl: 'https://testnet.bscscan.com',
                    nativeToken: 'BNB',
                    chainId: 97,
                    rpcUrl: 'https://data-seed-prebsc-1-s1.binance.org:8545'
                }
            }
        };

        // Current chain state
        let currentChainType = 'tron'; // 'tron' or 'evm'
        let currentNetwork = 'nile'; // Default to Nile testnet where contract is deployed
        let web3Instance = null;
        let evmContract = null;
        
        // Processing modal functions
        function showProcessing(message = 'Processing...') {
            let modal = document.getElementById('processingModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'processingModal';
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                modal.innerHTML = `
                    <div class="modal-content" style="background: var(--bg-primary); padding: 2rem; border-radius: 12px; text-align: center; max-width: 300px;">
                        <div class="loading-spinner" style="margin: 0 auto 1rem; width: 48px; height: 48px;"></div>
                        <p id="processingMessage" style="margin: 0; color: var(--text-primary);">${message}</p>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                document.getElementById('processingMessage').textContent = message;
                modal.style.display = 'flex';
            }
        }
        
        function hideProcessing() {
            const modal = document.getElementById('processingModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Show alert function
        function showAlert(elementId, type, message) {
            const element = document.getElementById(elementId);
            if (element) {
                const alertClass = type === 'success' ? 'alert-success' : 
                                 type === 'error' ? 'alert-error' : 
                                 type === 'warning' ? 'alert-warning' : 'alert-info';
                element.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
                element.style.display = 'block';
                
                // Auto-hide after 5 seconds for success messages
                if (type === 'success') {
                    setTimeout(() => {
                        element.style.display = 'none';
                    }, 5000);
                }
            }
        }
        
        // Get error message helper
        function getErrorMessage(error) {
            if (error.message) {
                if (error.message.includes('User rejected')) {
                    return 'Transaction cancelled by user';
                }
                if (error.message.includes('insufficient')) {
                    return 'Insufficient balance or energy';
                }
                return error.message;
            }
            return 'Unknown error occurred';
        }

        // Enhanced UI Manager
        class UIManager {
            constructor() {
                this.notifications = [];
            }

            showNotification(type, message, duration = 5000) {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type} notification-enter`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                    <button class="notification-close" onclick="uiManager.removeNotification(this)"></button>
                `;
                
                document.body.appendChild(notification);
                this.notifications.push(notification);
                
                // Trigger animation
                setTimeout(() => {
                    notification.classList.remove('notification-enter');
                    notification.classList.add('notification-active');
                }, 10);
                
                // Auto-remove after duration
                setTimeout(() => {
                    this.removeNotification(notification);
                }, duration);
            }

            removeNotification(notification) {
                // If passed a button, get the parent notification
                if (notification.tagName === 'BUTTON') {
                    notification = notification.parentElement;
                }
                
                notification.classList.remove('notification-active');
                notification.classList.add('notification-exit');
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                    const index = this.notifications.indexOf(notification);
                    if (index > -1) {
                        this.notifications.splice(index, 1);
                    }
                }, 300);
            }

            updateStats(stats) {
                document.getElementById('totalNotices').textContent = stats.total || '0';
                document.getElementById('acceptedNotices').textContent = stats.accepted || '0';
                document.getElementById('pendingNotices').textContent = stats.pending || '0';
                document.getElementById('activeServers').textContent = stats.servers || '0';
                
                // Show stats container if hidden (but keep collapsed state)
                const statsContainer = document.getElementById('statsContainer');
                if (statsContainer.style.display === 'none') {
                    statsContainer.style.display = 'block';
                }
            }

            updateBadge(tab, count) {
                const badge = document.getElementById(`${tab}Badge`);
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }

            showLoader() {
                document.getElementById('loader').style.display = 'flex';
            }

            hideLoader() {
                const loader = document.getElementById('loader');
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                    loader.style.opacity = '1';
                }, 500);
            }
        }

        const uiManager = new UIManager();
        
        
        
        // Analytics System
        class AnalyticsSystem {
            constructor() {
                this.data = JSON.parse(localStorage.getItem('analyticsData') || '{}');
                this.charts = {};
            }
            
            async loadAnalytics() {
                if (!legalContract || !tronWeb.defaultAddress) {
                    this.showNoData();
                    return;
                }
                
                try {
                    const address = tronWeb.defaultAddress.base58;
                    
                    // Get server info
                    const serverInfo = await legalContract.processServers(address).call();
                    const serverId = serverInfo[0] || 0;
                    const noticesServed = parseInt(serverInfo[1] || 0);
                    
                    // Load transaction history from localStorage
                    const transactions = JSON.parse(localStorage.getItem('userTransactions') || '[]');
                    const myTransactions = transactions.filter(tx => tx.sender === address);
                    
                    // Calculate stats
                    const timeRange = parseInt(document.getElementById('analyticsTimeRange').value);
                    const cutoffDate = timeRange === 0 ? 0 : Date.now() - (timeRange * 24 * 60 * 60 * 1000);
                    const filteredTx = myTransactions.filter(tx => tx.timestamp > cutoffDate);
                    
                    // Update summary stats
                    document.getElementById('totalNoticesServed').textContent = noticesServed;
                    
                    // Calculate acceptance rate (mock data for now)
                    const acceptanceRate = noticesServed > 0 ? Math.floor(70 + Math.random() * 20) : 0;
                    document.getElementById('acceptanceRate').textContent = acceptanceRate + '%';
                    
                    // Average response time (mock data)
                    const avgResponseTime = noticesServed > 0 ? (24 + Math.floor(Math.random() * 48)) + 'h' : '-';
                    document.getElementById('avgResponseTime').textContent = avgResponseTime;
                    
                    // Calculate revenue
                    const revenue = filteredTx.reduce((sum, tx) => sum + (tx.fee || 77), 0);
                    document.getElementById('totalRevenue').textContent = revenue + ' TRX';
                    
                    // Update charts
                    this.updateCharts(filteredTx);
                    
                    // Update recent activity
                    this.updateRecentActivity(filteredTx);
                    
                } catch (error) {
                    console.error('Error loading analytics:', error);
                    this.showNoData();
                }
            }
            
            updateCharts(transactions) {
                // Notices over time chart
                const ctx1 = document.getElementById('noticesChart').getContext('2d');
                
                // Group by day
                const dailyData = {};
                transactions.forEach(tx => {
                    const date = new Date(tx.timestamp).toLocaleDateString();
                    dailyData[date] = (dailyData[date] || 0) + 1;
                });
                
                const labels = Object.keys(dailyData).slice(-7);
                const data = labels.map(label => dailyData[label] || 0);
                
                if (this.charts.notices) {
                    this.charts.notices.destroy();
                }
                
                this.charts.notices = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Notices Created',
                            data: data,
                            borderColor: 'rgb(52, 152, 219)',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
                
                // Notice types chart
                const ctx2 = document.getElementById('typesChart').getContext('2d');
                
                const typeData = {};
                transactions.forEach(tx => {
                    const type = tx.noticeType || 'Other';
                    typeData[type] = (typeData[type] || 0) + 1;
                });
                
                if (this.charts.types) {
                    this.charts.types.destroy();
                }
                
                this.charts.types = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(typeData),
                        datasets: [{
                            data: Object.values(typeData),
                            backgroundColor: [
                                'rgb(52, 152, 219)',
                                'rgb(46, 204, 113)',
                                'rgb(155, 89, 182)',
                                'rgb(241, 196, 15)',
                                'rgb(231, 76, 60)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
            
            updateRecentActivity(transactions) {
                const list = document.getElementById('recentActivityList');
                
                if (transactions.length === 0) {
                    list.innerHTML = '<div class="empty-state"><i class="fas fa-chart-line"></i><p>No activity data available</p></div>';
                    return;
                }
                
                const recent = transactions.slice(0, 10);
                list.innerHTML = recent.map(tx => `
                    <div class="activity-item">
                        <div class="activity-info">
                            <div class="activity-type">${tx.noticeType || 'Legal Notice'}</div>
                            <div class="activity-details">To: ${tx.recipient.substring(0, 10)}...</div>
                        </div>
                        <div class="activity-time">${this.formatTime(tx.timestamp)}</div>
                    </div>
                `).join('');
            }
            
            formatTime(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            }
            
            showNoData() {
                document.getElementById('totalNoticesServed').textContent = '0';
                document.getElementById('acceptanceRate').textContent = '0%';
                document.getElementById('avgResponseTime').textContent = '-';
                document.getElementById('totalRevenue').textContent = '0 TRX';
            }
            
            exportData() {
                const data = {
                    exportDate: new Date().toISOString(),
                    stats: {
                        totalNotices: document.getElementById('totalNoticesServed').textContent,
                        acceptanceRate: document.getElementById('acceptanceRate').textContent,
                        avgResponseTime: document.getElementById('avgResponseTime').textContent,
                        totalRevenue: document.getElementById('totalRevenue').textContent
                    },
                    transactions: JSON.parse(localStorage.getItem('userTransactions') || '[]')
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `analytics_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            }
        }
        
        const analyticsSystem = new AnalyticsSystem();
        
        // Analytics functions
        function updateAnalytics() {
            analyticsSystem.loadAnalytics();
        }
        
        function exportAnalytics() {
            analyticsSystem.exportData();
        }

        // Notification System
        class NotificationSystem {
            constructor() {
                this.notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
                this.unreadCount = 0;
                this.checkInterval = null;
            }
            
            async init() {
                // Show bell for recipients only
                if (tronWeb && tronWeb.defaultAddress) {
                    const isRecipient = await this.checkIfRecipient();
                    if (isRecipient) {
                        document.getElementById('notificationBell').style.display = 'block';
                        this.updateNotificationUI();
                        this.startPolling();
                    }
                }
            }
            
            async checkIfRecipient() {
                try {
                    const balance = await legalContract.balanceOf(tronWeb.defaultAddress.base58).call();
                    return parseInt(balance) > 0;
                } catch (error) {
                    return false;
                }
            }
            
            async checkForNewNotices() {
                if (!legalContract || !tronWeb.defaultAddress) return;
                
                try {
                    const myAddress = tronWeb.defaultAddress.base58;
                    const noticeIds = await getRecipientNoticeIds(myAddress);
                    
                    // Check for new notices
                    const existingIds = this.notifications.map(n => n.noticeId);
                    const newNotices = [];
                    
                    for (const noticeId of noticeIds) {
                        if (!existingIds.includes(noticeId.toString())) {
                            try {
                                const notice = await legalContract.getNotice(noticeId).call();
                                const { timestamp, serverId, hasDocument, accepted } = parsePackedData(notice.packedData);
                                
                                newNotices.push({
                                    noticeId: noticeId.toString(),
                                    sender: notice.sender,
                                    timestamp: timestamp,
                                    type: notice.metadata.split('|')[0] || 'Legal Notice',
                                    hasDocument: hasDocument,
                                    accepted: accepted,
                                    read: false,
                                    receivedAt: Date.now()
                                });
                            } catch (e) {
                                console.error('Error fetching notice:', e);
                            }
                        }
                    }
                    
                    if (newNotices.length > 0) {
                        this.addNotifications(newNotices);
                        this.showDesktopNotification(newNotices[0]);
                    }
                    
                } catch (error) {
                    console.error('Error checking for notices:', error);
                }
            }
            
            addNotifications(newNotices) {
                this.notifications.unshift(...newNotices);
                this.saveNotifications();
                this.updateNotificationUI();
            }
            
            showDesktopNotification(notice) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('New Legal Notice', {
                        body: `You have received a new legal notice from ${notice.sender.substring(0, 10)}...`,
                        icon: '/favicon.ico',
                        tag: notice.noticeId
                    });
                }
            }
            
            updateNotificationUI() {
                const unread = this.notifications.filter(n => !n.read);
                this.unreadCount = unread.length;
                
                // Update badge
                const badge = document.getElementById('notificationCount');
                if (badge) {
                    badge.textContent = this.unreadCount;
                    badge.style.display = this.unreadCount > 0 ? 'block' : 'none';
                }
                
                // Update list
                const list = document.getElementById('notificationList');
                if (list) {
                    if (this.notifications.length === 0) {
                        list.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No notices</p></div>';
                    } else {
                        list.innerHTML = this.notifications.map(n => `
                            <div class="notification-item ${n.read ? '' : 'unread'}" onclick="viewNoticeFromNotification('${n.noticeId}')">
                                <div class="notification-item-header">
                                    <span class="notification-item-title">${n.type}</span>
                                    <span class="notification-item-time">${this.formatTime(n.receivedAt)}</span>
                                </div>
                                <div class="notification-item-body">
                                    From: ${n.sender.substring(0, 10)}...${n.sender.substring(n.sender.length - 8)}
                                </div>
                            </div>
                        `).join('');
                    }
                }
            }
            
            formatTime(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                
                if (diff < 60000) return 'Just now';
                if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
                if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
                return new Date(timestamp).toLocaleDateString();
            }
            
            markAsRead(noticeId) {
                const notification = this.notifications.find(n => n.noticeId === noticeId);
                if (notification && !notification.read) {
                    notification.read = true;
                    this.saveNotifications();
                    this.updateNotificationUI();
                }
            }
            
            markAllAsRead() {
                this.notifications.forEach(n => n.read = true);
                this.saveNotifications();
                this.updateNotificationUI();
            }
            
            saveNotifications() {
                localStorage.setItem('notifications', JSON.stringify(this.notifications));
            }
            
            startPolling() {
                // Check every 30 seconds
                this.checkInterval = setInterval(() => {
                    this.checkForNewNotices();
                }, 30000);
                
                // Initial check
                this.checkForNewNotices();
            }
            
            stopPolling() {
                if (this.checkInterval) {
                    clearInterval(this.checkInterval);
                }
            }
        }
        
        // Initialize notification system
        const notificationSystem = new NotificationSystem();
        
        // Notification functions
        function toggleNotificationPanel() {
            const panel = document.getElementById('notificationPanel');
            panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
        }
        
        function markAllAsRead() {
            notificationSystem.markAllAsRead();
        }
        
        function viewNoticeFromNotification(noticeId) {
            notificationSystem.markAsRead(noticeId);
            showAcceptModal(noticeId);
            toggleNotificationPanel();
        }
        
        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // Initialize tooltips
        function initializeTooltips() {
            const tooltips = [
                { id: 'recipientAddress', text: 'The TRON wallet address of the person receiving the legal notice' },
                { id: 'caseNumber', text: 'Your internal case or reference number' },
                { id: 'noticeType', text: 'Select the type of legal notice you are serving' },
                { id: 'tokenName', text: 'A short name for this notice (e.g., "Smith Summons")' }
            ];
            
            tooltips.forEach(tooltip => {
                const element = document.getElementById(tooltip.id);
                if (element) {
                    const label = element.previousElementSibling;
                    if (label && !label.querySelector('.tooltip-icon')) {
                        label.innerHTML += ' <i class="fas fa-question-circle tooltip-icon" title="' + tooltip.text + '" style="color: var(--text-secondary); cursor: help;"></i>';
                    }
                }
            });
        }
        
        // Close modal functions
        function closeTransactionResultModal() {
            const modal = document.getElementById('transactionResultModal');
            if (modal) modal.style.display = 'none';
        }
        
        function closeTxModal() {
            closeTransactionResultModal();
        }
        
        function closeAcceptModal() {
            const modal = document.getElementById('acceptModal');
            if (modal) modal.style.display = 'none';
        }
        
        function closeMintModal() {
            const modal = document.getElementById('batchMintModal');
            if (modal) modal.style.display = 'none';
        }
        
        function closeRegistrationModal() {
            const modal = document.getElementById('registrationModal');
            if (modal) modal.style.display = 'none';
        }
        
        function closeRegistrationSuccessModal() {
            const modal = document.getElementById('registrationSuccessModal');
            if (modal) modal.style.display = 'none';
        }
        
        function closeAuditModal() {
            const modal = document.getElementById('auditModal');
            if (modal) modal.style.display = 'none';
        }
        
        // Open registration modal
        function openRegistrationModal() {
            const modal = document.getElementById('registrationModal');
            if (modal) {
                modal.style.display = 'flex';
                // Pre-fill wallet address if connected
                if (tronWeb && tronWeb.defaultAddress) {
                    document.getElementById('regWallet').value = tronWeb.defaultAddress.base58;
                }
            }
        }
        
        // Dismiss registration notice
        function dismissRegistrationNotice() {
            const notice = document.getElementById('registrationNotice');
            if (notice) {
                notice.style.display = 'none';
                localStorage.setItem('registrationNoticeDismissed', 'true');
            }
        }
        
        // Copy functions
        function copyWalletAddress() {
            if (tronWeb && tronWeb.defaultAddress) {
                navigator.clipboard.writeText(tronWeb.defaultAddress.base58).then(() => {
                    uiManager.showNotification('success', 'Address copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    uiManager.showNotification('error', 'Failed to copy address');
                });
            }
        }
        
        function copyAddress(address) {
            navigator.clipboard.writeText(address).then(() => {
                uiManager.showNotification('success', 'Address copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                uiManager.showNotification('error', 'Failed to copy address');
            });
        }
        
        // Fee management functions
        async function setLawEnforcementExemption() {
            const address = document.getElementById('exemptionAddress').value.trim();
            const agencyName = document.getElementById('exemptionAgencyName').value.trim();
            
            if (!address || !agencyName) {
                uiManager.showNotification('error', 'Please fill in all fields');
                return;
            }
            
            if (!tronWeb.isAddress(address)) {
                uiManager.showNotification('error', 'Invalid address');
                return;
            }
            
            try {
                showProcessing('Setting law enforcement exemption...');
                
                await legalContract.grantRoleWithExemption(
                    tronWeb.sha3('PROCESS_SERVER_ROLE'),
                    address,
                    agencyName
                ).send({
                    feeLimit: 100_000_000,
                    shouldPollResponse: true
                });
                
                hideProcessing();
                if (submitButton) setButtonLoading(submitButton, false, '<i class="fas fa-paper-plane"></i> Create Notice');
                showAlert('exemptionResult', 'success', `Exemption granted to ${address}`);
                
                // Clear form
                document.getElementById('exemptionAddress').value = '';
                document.getElementById('exemptionAgencyName').value = '';
                
            } catch (error) {
                hideProcessing();
                console.error('Error setting exemption:', error);
                showAlert('exemptionResult', 'error', 'Failed: ' + getErrorMessage(error));
            }
        }
        
        function useConnectedAddressForExemption() {
            if (tronWeb && tronWeb.defaultAddress) {
                document.getElementById('exemptionAddress').value = tronWeb.defaultAddress.base58;
            }
        }
        
        // Toggle registration form based on role
        function toggleRegistrationForm() {
            const roleSelect = document.getElementById('roleSelect');
            const serverFields = document.getElementById('processServerFields');
            
            if (roleSelect && serverFields) {
                serverFields.style.display = roleSelect.value === 'PROCESS_SERVER_ROLE' ? 'block' : 'none';
            }
        }
        
        // Change document function (for batch operations)
        function changeDocument() {
            // Reset to upload step
            document.getElementById('uploadCard').style.display = 'block';
            document.getElementById('mintCard').style.display = 'none';
            
            // Clear the uploaded image
            uploadedImage = null;
            document.getElementById('uploadedFileName').textContent = '';
            document.getElementById('uploadResult').style.display = 'none';
            
            // Reset file input
            const fileInput = document.getElementById('imageUpload');
            if (fileInput) {
                fileInput.value = '';
            }
        }
// Use connected wallet address function
function useConnectedAddress() {
    if (tronWeb && tronWeb.defaultAddress) {
        document.getElementById('roleAddress').value = tronWeb.defaultAddress.base58;
        
        // Trigger validation if exists
        const event = new Event('input', { bubbles: true });
        document.getElementById('roleAddress').dispatchEvent(event);
        
        uiManager.showNotification('success', 'Connected wallet address inserted');
    } else {
        uiManager.showNotification('error', 'No wallet connected');
    }
}

// Use connected wallet address for fee collector
function useConnectedAddressForFeeCollector() {
    if (tronWeb && tronWeb.defaultAddress) {
        document.getElementById('feeCollectorAddress').value = tronWeb.defaultAddress.base58;
        
        // Trigger validation if exists
        const event = new Event('input', { bubbles: true });
        document.getElementById('feeCollectorAddress').dispatchEvent(event);
        
        uiManager.showNotification('success', 'Connected wallet address inserted');
    } else {
        uiManager.showNotification('error', 'No wallet connected');
    }
}
        // Handle chain change
        async function handleChainChange() {
            const chainSelector = document.getElementById('chainSelector');
            const selectedValue = chainSelector.value;
            const [chainType, network] = selectedValue.split('-');
            
            currentChainType = chainType;
            currentNetwork = network;
            
            // Update contract address field
            const config = CHAIN_CONFIG[chainType][network];
            const contractAddressField = document.getElementById('contractAddress');
            if (contractAddressField) {
                contractAddressField.value = config.contractAddress;
            }
            
            // Disconnect current wallet if connected
            if (window.tronWeb && window.tronWeb.ready && chainType === 'evm') {
                // Switching from TRON to EVM
                disconnectWallet();
            } else if (web3Instance && chainType === 'tron') {
                // Switching from EVM to TRON
                disconnectWallet();
            }
            
            uiManager.showNotification('info', `Switched to ${config.name}. Please connect your wallet.`);
        }

        // Connect Wallet function
        async function connectWallet() {
            const connectBtn = document.getElementById('connectBtn');
            
            if (currentChainType === 'tron') {
                await connectTronWallet();
            } else {
                await connectEVMWallet();
            }
        }

        // Connect TRON wallet
        async function connectTronWallet() {
            const connectBtn = document.getElementById('connectBtn');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const networkIndicator = document.getElementById('networkIndicator');
            const networkName = document.getElementById('networkName');

            try {
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<span class="loading-spinner"></span> Connecting...';

                // Check if TronWeb is available
                if (typeof window.tronWeb === 'undefined') {
                    throw new Error('TronLink not detected. Please install TronLink extension');
                }

                // Use recommended TronLink account request method
                try {
                    await window.tronLink.request({method: 'tron_requestAccounts'});
                } catch (error) {
                    throw new Error('Please unlock your TronLink wallet and grant permission');
                }

                // Wait for TronWeb to be ready
                let tries = 0;
                while (!window.tronWeb.ready && tries < 10) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    tries++;
                }

                if (!window.tronWeb.ready) {
                    throw new Error('Please unlock your TronLink wallet');
                }

                tronWeb = window.tronWeb;
                const address = tronWeb.defaultAddress.base58;

                // Update UI
                walletStatus.style.display = 'none';
                walletAddress.style.display = 'flex';
                
                const shortAddress = address.substring(0, 6) + '...' + address.substring(address.length - 4);
                document.getElementById('walletAddressText').textContent = shortAddress;
                
                // Get network name
                const fullNode = tronWeb.fullNode.host;
                let network = 'Unknown Network';
                
                if (fullNode.includes('trongrid.io') && !fullNode.includes('shasta') && !fullNode.includes('nile')) {
                    network = 'Mainnet';
                } else if (fullNode.includes('nile')) {
                    network = 'Nile Testnet';
                } else if (fullNode.includes('shasta')) {
                    network = 'Shasta Testnet';
                }
                
                networkName.textContent = network;
                networkIndicator.classList.add('connected');

                connectBtn.innerHTML = '<i class="fas fa-check"></i> Connected';
                connectBtn.classList.remove('btn-primary');
                connectBtn.classList.add('btn-success');

                // If registration modal is open, update wallet field
                const regWalletField = document.getElementById('regWallet');
                if (regWalletField) {
                    regWalletField.value = address;
                }

                // Hide welcome section
                document.getElementById('welcomeSection').style.display = 'none';

                uiManager.showNotification('success', `Connected to ${network}`);

                // Check if contract is already in the address field
                const contractAddressField = document.getElementById('contractAddress');
                if (contractAddressField && contractAddressField.value) {
                    // Automatically connect to contract after a short delay to ensure TronWeb is ready
                    setTimeout(async () => {
                        await connectContracts();
                    }, 1000); // 1 second delay
                }

            } catch (error) {
                console.error('Connection error:', error);
                
                connectBtn.innerHTML = '<i class="fas fa-link"></i> Connect';
                connectBtn.disabled = false;
                
                uiManager.showNotification('error', error.message || 'Failed to connect wallet');
            }
        }

        // Connect EVM wallet
        async function connectEVMWallet() {
            const connectBtn = document.getElementById('connectBtn');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const networkIndicator = document.getElementById('networkIndicator');
            const networkName = document.getElementById('networkName');

            try {
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<span class="loading-spinner"></span> Connecting...';

                // Check if MetaMask is available
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask not detected. Please install MetaMask extension');
                }

                // Create Web3 instance
                web3Instance = new Web3(window.ethereum);

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts found. Please unlock MetaMask');
                }

                const address = accounts[0];
                const chainId = await web3Instance.eth.getChainId();
                const config = CHAIN_CONFIG.evm[currentNetwork];

                // Check if on correct network
                if (Number(chainId) !== config.chainId) {
                    uiManager.showNotification('warning', `Please switch to ${config.name} in MetaMask`);
                    
                    // Try to switch network
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: web3Instance.utils.toHex(config.chainId) }],
                        });
                    } catch (switchError) {
                        // This error code indicates that the chain has not been added to MetaMask
                        if (switchError.code === 4902) {
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: web3Instance.utils.toHex(config.chainId),
                                        chainName: config.name,
                                        rpcUrls: [config.rpcUrl],
                                        blockExplorerUrls: [config.explorerUrl],
                                        nativeCurrency: {
                                            name: config.nativeToken,
                                            symbol: config.nativeToken,
                                            decimals: 18
                                        }
                                    }],
                                });
                            } catch (addError) {
                                throw new Error('Failed to add network to MetaMask');
                            }
                        } else {
                            throw switchError;
                        }
                    }
                }

                // Update UI
                walletStatus.style.display = 'none';
                walletAddress.style.display = 'flex';
                
                const shortAddress = address.substring(0, 6) + '...' + address.substring(address.length - 4);
                document.getElementById('walletAddressText').textContent = shortAddress;
                
                networkName.textContent = config.name;
                networkIndicator.classList.add('connected');

                connectBtn.innerHTML = '<i class="fas fa-check"></i> Connected';
                connectBtn.classList.remove('btn-primary');
                connectBtn.classList.add('btn-success');

                // Hide welcome section
                document.getElementById('welcomeSection').style.display = 'none';

                uiManager.showNotification('success', `Connected to ${config.name}`);

                // Connect to contract
                const contractAddressField = document.getElementById('contractAddress');
                if (contractAddressField && contractAddressField.value) {
                    await connectContracts();
                }

                // Listen for account changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        disconnectWallet();
                    } else {
                        window.location.reload();
                    }
                });

                // Listen for chain changes
                window.ethereum.on('chainChanged', () => {
                    window.location.reload();
                });

            } catch (error) {
                console.error('Connection error:', error);
                
                connectBtn.innerHTML = '<i class="fas fa-link"></i> Connect';
                connectBtn.disabled = false;
                
                uiManager.showNotification('error', error.message || 'Failed to connect wallet');
            }
        }

        // Disconnect wallet
        function disconnectWallet() {
            // Reset UI
            const connectBtn = document.getElementById('connectBtn');
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            const networkIndicator = document.getElementById('networkIndicator');
            const networkName = document.getElementById('networkName');
            
            walletStatus.style.display = 'block';
            walletStatus.textContent = 'Not Connected';
            walletAddress.style.display = 'none';
            networkName.textContent = 'Disconnected';
            networkIndicator.classList.remove('connected');
            
            connectBtn.innerHTML = '<i class="fas fa-link"></i> Connect';
            connectBtn.classList.remove('btn-success');
            connectBtn.classList.add('btn-primary');
            connectBtn.disabled = false;
            
            // Show welcome section
            document.getElementById('welcomeSection').style.display = 'block';
            
            // Reset contract connection
            legalContract = null;
            evmContract = null;
            web3Instance = null;
            tronWeb = null;
            
            // Hide contract status
            document.getElementById('contractsStatus').style.display = 'none';
            document.getElementById('contractAddress').disabled = false;
            
            // Reset contract connect button
            const contractConnectBtn = document.getElementById('connectContractBtn');
            if (contractConnectBtn) {
                contractConnectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect to Contract';
                contractConnectBtn.classList.remove('btn-success');
                contractConnectBtn.classList.add('btn-primary');
                contractConnectBtn.disabled = false;
            }
            
            uiManager.showNotification('info', 'Wallet disconnected');
        }

        // Tab switching function
        function switchTab(tabName) {
            // Check admin access before allowing admin tab
            if (tabName === 'admin' && !isAdmin) {
                uiManager.showNotification('error', 'Admin access required');
                return;
            }
            
            const tabs = ['user', 'delivery', 'admin', 'help'];
            
            tabs.forEach(tab => {
                const tabButton = document.querySelector(`[onclick="switchTab('${tab}')"]`);
                const tabContent = document.getElementById(`${tab}Tab`);
                
                if (tab === tabName) {
                    tabButton.classList.add('active');
                    tabContent.classList.add('active');
                } else {
                    tabButton.classList.remove('active');
                    tabContent.classList.remove('active');
                }
            });

            // Check admin access when switching to admin tab
            if (tabName === 'analytics') {
                analyticsSystem.loadAnalytics();
            }
            
            if (tabName === 'admin') {
                checkAdminAccess();
                refreshPendingRegistrations();
                updateStatsFromLocalStorage();
            }
            
            // Load delivery status when switching to delivery tab
            if (tabName === 'delivery') {
                refreshDeliveryStatus();
            }
        }

        // Toggle FAQ accordion sections
        function toggleFAQ(button) {
            const section = button.parentElement;
            const content = section.querySelector('.faq-content');
            const icon = button.querySelector('i');
            
            // Toggle active state
            button.classList.toggle('active');
            
            // Toggle content visibility
            if (content.style.display === 'block') {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-right';
            } else {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-down';
            }
        }

        // Check admin access
        async function checkAdminAccess() {
            const adminAccessDenied = document.getElementById('adminAccessDenied');
            const adminContent = document.getElementById('adminContent');
            
            if (!legalContract || !tronWeb.defaultAddress) {
                adminAccessDenied.style.display = 'block';
                adminContent.style.display = 'none';
                return;
            }
            
            if (isAdmin) {
                adminAccessDenied.style.display = 'none';
                adminContent.style.display = 'block';
                refreshPendingRegistrations();
                loadGitHubSettings();
            } else {
                adminAccessDenied.style.display = 'block';
                adminContent.style.display = 'none';
            }
        }

        // Modal functions
        function openRegistrationModal() {
            const modal = document.getElementById('registrationModal');
            modal.style.display = 'block';
            
            // Auto-fill wallet address if connected
            if (tronWeb && tronWeb.defaultAddress) {
                document.getElementById('regWallet').value = tronWeb.defaultAddress.base58;
            }
        }

        function closeRegistrationModal() {
            document.getElementById('registrationModal').style.display = 'none';
            clearRegistrationForm();
        }

        function clearRegistrationForm() {
            document.getElementById('regAgency').value = '';
            document.getElementById('regPurpose').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('registrationResult').innerHTML = '';
        }

        function closeRegistrationSuccessModal() {
            document.getElementById('registrationSuccessModal').style.display = 'none';
        }

        function dismissRegistrationNotice() {
            document.getElementById('registrationNotice').style.display = 'none';
        }

        async function openMintModal() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Please connect to contract first');
                return;
            }
            
            if (!isProcessServer && !isAdmin) {
                uiManager.showNotification('error', 'You need Process Server role to create notices');
                return;
            }
            
            const modal = document.getElementById('mintModal');
            modal.style.display = 'block';
            resetMintForm();
            
            // Update token prefix based on user role
            await updateTokenPrefix();
            
            // Setup upload area for this modal instance - delay to ensure DOM is ready
            setTimeout(() => {
                setupUploadAreaForModal();
            }, 100);
            
            
        async function calculateFeeForDisplay(userAddress, deliveryMethod) {
            try {
                if (!legalContract) return { base: 0, total: 0, isExempt: false };
                
                // Check exemption status
                const isExempt = await legalContract.lawEnforcementExemptions(userAddress).call();
                
                // Base fees
                const baseFee = deliveryMethod === 'document' ? 150 : 15;
                const sponsorshipFee = 2;
                
                // If exempt, only pay sponsorship
                const finalBaseFee = isExempt ? 0 : baseFee;
                const totalFee = finalBaseFee + sponsorshipFee;
                
                return {
                    base: finalBaseFee,
                    total: totalFee,
                    isExempt: isExempt
                };
            } catch (error) {
                console.error('Error calculating fee:', error);
                return { base: 0, total: 0, isExempt: false };
            }
        }

        // Update fee display based on actual contract calculation
            try {
                const userAddress = tronWeb.defaultAddress.base58;
                const fee = await calculateFeeFromConstants(userAddress);
                const feeInTrx = tronWeb.fromSun(fee);
                
                // Get specific fees for different notice types
                let documentFee, textFee;
                try {
                    const docFeeRaw = await legalContract.serviceFee().call();
                    const textFeeRaw = await legalContract.textOnlyFee().call();
                    documentFee = tronWeb.fromSun(docFeeRaw);
                    textFee = tronWeb.fromSun(textFeeRaw);
                } catch (e) {
                    // Fallback to single fee if new fee structure not available
                    documentFee = feeInTrx;
                    textFee = feeInTrx;
                }
                
                // Display fee based on current selection
                const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked')?.value || 'document';
                const baseFee = deliveryMethod === 'document' ? documentFee : textFee;
                const totalWithSponsorship = parseFloat(baseFee) + 2; // Add mandatory sponsorship
                
                document.getElementById('creationFeeDisplay').textContent = `${totalWithSponsorship} TRX (${deliveryMethod === 'document' ? 'Document' : 'Text Only'})`;
                
                // Check if user has fee exemptions
                const isLawEnforcement = await legalContract.lawEnforcementExemptions(userAddress).call();
                const agencyName = await legalContract.lawEnforcementAgencies(userAddress).call();
                
                if (isLawEnforcement) {
                    document.getElementById('feeDescription').textContent = `Law Enforcement (${agencyName}) - Cost only: Sponsorship (2 TRX)`;
                    document.getElementById('creationFeeDisplay').textContent = '2 TRX';
                } else if (hasRole(PROCESS_SERVER_ROLE, userAddress)) {
                    document.getElementById('feeDescription').textContent = 'Process Server: Creation fee + Sponsorship (2)';
                } else {
                    document.getElementById('feeDescription').textContent = 'Service fee + Sponsorship (2)';
                }
            } catch (error) {
                console.error('Error calculating fee:', error);
                document.getElementById('creationFeeDisplay').textContent = `${currentCreationFee} TRX`;
            }
        }

        function closeMintModal(force = false) {
            // Check if there's unsaved data
            const hasData = checkMintFormHasData();
            
            if (!force && hasData) {
                const confirmClose = confirm(
                    'You have unsaved data in this form. Are you sure you want to close and lose your progress?'
                );
                if (!confirmClose) {
                    return;
                }
            }
            
            document.getElementById('mintModal').style.display = 'none';
            resetMintForm();
        }
        
        // Open batch mode modal
        function openBatchMode() {
            closeMintModal(true); // Force close mint modal
            document.getElementById('batchModal').style.display = 'flex';
            document.getElementById('batchStep1').style.display = 'block';
            document.getElementById('batchStep2').style.display = 'none';
            document.getElementById('batchStep3').style.display = 'none';
        }
        
        // Close batch modal
        function closeBatchModal() {
            document.getElementById('batchModal').style.display = 'none';
            // Reset batch state if needed
            if (batchManager) {
                batchManager.reset();
            }
        }
        
        // Handle CSV upload
        function handleCSVUpload(event) {
            if (batchManager) {
                batchManager.handleCSVUpload(event);
            }
        }
        
        // Handle batch document upload
        function handleBatchDocumentUpload(event) {
            if (batchManager) {
                batchManager.handleDocumentUpload(event);
            }
        }
        
        // Setup upload area when modal opens
        function setupUploadAreaForModal() {
            console.log('Setting up upload area for modal');
            
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('documentUpload');
            
            console.log('Upload area:', uploadArea);
            console.log('File input:', fileInput);
            
            if (!uploadArea || !fileInput) {
                console.error('Upload area or file input not found!');
                return;
            }
            
            // Remove any existing onclick attribute
            uploadArea.removeAttribute('onclick');
            
            // Add click handler to the upload area
            uploadArea.onclick = function(e) {
                console.log('Upload area onclick triggered');
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
                    e.preventDefault();
                    e.stopPropagation();
                    fileInput.click();
                }
            };
            
            // Make sure file input has change handler
            fileInput.onchange = handleDocumentUpload;
            
            console.log('Upload area setup complete');
        }
        
        // Batch Manager implementation
        const batchManager = {
            recipients: [],
            document: null,
            currentIndex: 0,
            isPaused: false,
            results: [],
            
            reset() {
                this.recipients = [];
                this.document = null;
                this.currentIndex = 0;
                this.isPaused = false;
                this.results = [];
            },
            
            handleCSVUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n').filter(line => line.trim());
                        const recipients = [];
                        
                        // Parse CSV (skip header if present)
                        const startIndex = lines[0].toLowerCase().includes('wallet') ? 1 : 0;
                        
                        for (let i = startIndex; i < lines.length && recipients.length < 100; i++) {
                            const parts = lines[i].split(',').map(p => p.trim());
                            if (parts[0] && tronWeb.isAddress(parts[0])) {
                                recipients.push({
                                    address: parts[0],
                                    noticeType: parts[1] || 'Legal Notice',
                                    publicText: parts[2] || ''
                                });
                            }
                        }
                        
                        this.recipients = recipients;
                        this.showValidationResults();
                        
                    } catch (error) {
                        console.error('CSV parse error:', error);
                        uiManager.showNotification('error', 'Failed to parse CSV file');
                    }
                };
                reader.readAsText(file);
            },
            
            handleDocumentUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.document = {
                        data: e.target.result,
                        name: file.name,
                        type: file.type,
                        size: file.size
                    };
                    uiManager.showNotification('success', 'Document uploaded for batch processing');
                };
                reader.readAsDataURL(file);
            },
            
            showValidationResults() {
                const validCount = this.recipients.filter(r => tronWeb.isAddress(r.address)).length;
                const invalidCount = this.recipients.length - validCount;
                
                const resultsDiv = document.getElementById('batchValidationResults');
                if (resultsDiv) {
                    resultsDiv.innerHTML = `
                        <div class="validation-summary">
                            <p><strong>Total Recipients:</strong> ${this.recipients.length}</p>
                            <p><strong>Valid Addresses:</strong> ${validCount}</p>
                            ${invalidCount > 0 ? `<p class="error"><strong>Invalid Addresses:</strong> ${invalidCount}</p>` : ''}
                        </div>
                        <div class="recipient-list" style="max-height: 200px; overflow-y: auto;">
                            ${this.recipients.map((r, i) => `
                                <div class="recipient-item">
                                    <span>${i + 1}. ${r.address.substring(0, 10)}...${r.address.substring(r.address.length - 8)}</span>
                                    <span>${r.noticeType}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Show step 2
                document.getElementById('batchStep1').style.display = 'none';
                document.getElementById('batchStep2').style.display = 'block';
            },
            
            goBack() {
                document.getElementById('batchStep1').style.display = 'block';
                document.getElementById('batchStep2').style.display = 'none';
                document.getElementById('batchStep3').style.display = 'none';
            },
            
            async startBatch() {
                if (!this.recipients.length) {
                    uiManager.showNotification('error', 'No recipients to process');
                    return;
                }
                
                if (!legalContract) {
                    uiManager.showNotification('error', 'Contract not connected');
                    return;
                }
                
                // Get additional details
                const agencyName = document.getElementById('batchAgencyName').value || '';
                const caseNumber = document.getElementById('batchCaseNumber').value || '';
                const rightsStatement = document.getElementById('batchRightsStatement').value || '';
                
                // Show step 3
                document.getElementById('batchStep2').style.display = 'none';
                document.getElementById('batchStep3').style.display = 'block';
                
                this.isPaused = false;
                this.currentIndex = 0;
                this.results = [];
                
                // Start processing
                this.processBatch(agencyName, caseNumber, rightsStatement);
            },
            
            async processBatch(agencyName, caseNumber, rightsStatement) {
                const progressBar = document.getElementById('batchProgressBar');
                const progressText = document.getElementById('batchProgressText');
                const resultsDiv = document.getElementById('batchResults');
                
                while (this.currentIndex < this.recipients.length && !this.isPaused) {
                    const recipient = this.recipients[this.currentIndex];
                    const progress = Math.round((this.currentIndex / this.recipients.length) * 100);
                    
                    progressBar.style.width = progress + '%';
                    progressText.textContent = `${this.currentIndex} / ${this.recipients.length} completed`;
                    
                    try {
                        // Create notice for this recipient
                        const result = await this.createSingleNotice(recipient, agencyName, caseNumber, rightsStatement);
                        
                        this.results.push({
                            address: recipient.address,
                            status: 'success',
                            noticeId: result.noticeId,
                            txHash: result.txHash
                        });
                        
                        // Update results display
                        resultsDiv.innerHTML = this.formatResults();
                        
                    } catch (error) {
                        console.error(`Failed for ${recipient.address}:`, error);
                        this.results.push({
                            address: recipient.address,
                            status: 'failed',
                            error: error.message
                        });
                        
                        resultsDiv.innerHTML = this.formatResults();
                    }
                    
                    this.currentIndex++;
                    
                    // Small delay between transactions
                    if (this.currentIndex < this.recipients.length) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                // Update final progress
                const finalProgress = Math.round((this.currentIndex / this.recipients.length) * 100);
                progressBar.style.width = finalProgress + '%';
                progressText.textContent = `${this.currentIndex} / ${this.recipients.length} completed`;
                
                if (this.currentIndex === this.recipients.length) {
                    uiManager.showNotification('success', 'Batch processing completed!');
                }
            },
            
            async createSingleNotice(recipient, agencyName, caseNumber, rightsStatement) {
                // Simplified version - in real implementation, would use full encryption logic
                const tx = await legalContract.createNotice(
                    recipient.address,
                    recipient.noticeType,
                    recipient.publicText,
                    this.document ? 'encrypted-ipfs-hash' : '',
                    {
                        agencyName,
                        caseNumber,
                        rightsStatement
                    }
                ).send();
                
                return {
                    noticeId: tx.noticeId || Math.floor(Math.random() * 10000),
                    txHash: tx
                };
            },
            
            pauseBatch() {
                this.isPaused = true;
                document.getElementById('pauseBatchBtn').style.display = 'none';
                document.getElementById('resumeBatchBtn').style.display = 'inline-block';
                uiManager.showNotification('info', 'Batch processing paused');
            },
            
            resumeBatch() {
                this.isPaused = false;
                document.getElementById('pauseBatchBtn').style.display = 'inline-block';
                document.getElementById('resumeBatchBtn').style.display = 'none';
                
                // Get stored details
                const agencyName = document.getElementById('batchAgencyName').value || '';
                const caseNumber = document.getElementById('batchCaseNumber').value || '';
                const rightsStatement = document.getElementById('batchRightsStatement').value || '';
                
                this.processBatch(agencyName, caseNumber, rightsStatement);
                uiManager.showNotification('info', 'Batch processing resumed');
            },
            
            formatResults() {
                return this.results.map(r => `
                    <div class="batch-result-item ${r.status}">
                        <span>${r.address.substring(0, 10)}...${r.address.substring(r.address.length - 8)}</span>
                        <span>${r.status === 'success' ? ` Notice #${r.noticeId}` : ` ${r.error}`}</span>
                    </div>
                `).join('');
            },
            
            exportResults() {
                if (!this.results.length) {
                    uiManager.showNotification('error', 'No results to export');
                    return;
                }
                
                const csv = 'Address,Status,Notice ID,Transaction Hash,Error\n' +
                    this.results.map(r => 
                        `${r.address},${r.status},${r.noticeId || ''},${r.txHash || ''},${r.error || ''}`
                    ).join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `batch-results-${Date.now()}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                uiManager.showNotification('success', 'Results exported');
            }
        };
        
        // Reset mint form to initial state
        function resetMintForm() {
            // Reset to step 1
            document.getElementById('mintStep1').style.display = 'block';
            document.getElementById('mintStep2').style.display = 'none';
            
            // Clear form fields
            const fieldsToReset = [
                'documentUpload',
                'recipientAddress',
                'noticeText',
                'noticeType',
                'agencyName',
                'caseNumber',
                'specificDetails',
                'rightsStatement'
            ];
            
            fieldsToReset.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    if (field.type === 'file') {
                        field.value = '';
                    } else if (field.tagName === 'SELECT') {
                        field.selectedIndex = 0;
                    } else {
                        field.value = '';
                    }
                }
            });
            
            // Clear document preview and restore upload area
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.innerHTML = `
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary);"></i>
                    <p>Drag & drop your document here or click to browse</p>
                    <p style="font-size: 0.85rem; color: #666;">Supported formats: JPEG, PNG</p>
                    <input type="file" id="documentUpload" accept="image/jpeg,image/jpg,image/png,application/pdf,.pdf" onchange="handleDocumentUpload(event)">
                    <!-- Backup button in case click handler fails -->
                    <button type="button" class="btn btn-primary" style="margin-top: 10px;" onclick="document.getElementById('documentUpload').click()">
                        <i class="fas fa-folder-open"></i> Select File
                    </button>
                `;
            }
            
            // Clear any stored document data
            window.uploadedDocument = null;
            
            // Reset fee display
            if (typeof updateFeeEstimate === 'function') {
                updateFeeEstimate();
            }
        }
        
        // Clear all form data function
        function clearAllFormData() {
            // Confirm with user
            if (!confirm('Are you sure you want to clear all form data? This will reset everything including uploaded documents.')) {
                return;
            }
            
            // Clear all mint form fields
            const fieldsToReset = [
                'mintRecipient',
                'mintTokenName',
                'mintCaseNumber',
                'mintJurisdiction',
                'noticeText',
                'noticeType',
                'agencyName',
                'caseNumber',
                'specificDetails',
                'rightsStatement',
                'documentUpload'
            ];
            
            fieldsToReset.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    if (field.type === 'file') {
                        field.value = '';
                    } else if (field.tagName === 'SELECT') {
                        field.selectedIndex = 0;
                    } else if (field.type === 'checkbox' || field.type === 'radio') {
                        field.checked = false;
                    } else {
                        field.value = '';
                    }
                }
            });
            
            // Reset delivery method to default (document)
            const documentRadio = document.querySelector('input[name="deliveryMethod"][value="document"]');
            if (documentRadio) {
                documentRadio.checked = true;
            }
            
            // Clear document preview and restore upload area
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.innerHTML = `
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary);"></i>
                    <p>Drag & drop your document here or click to browse</p>
                    <p style="font-size: 0.85rem; color: #666;">Supported formats: JPEG, PNG, PDF</p>
                    <input type="file" id="documentUpload" accept="image/jpeg,image/jpg,image/png,application/pdf,.pdf" onchange="handleDocumentUpload(event)">
                    <!-- Backup button in case click handler fails -->
                    <button type="button" class="btn btn-primary" style="margin-top: 10px;" onclick="document.getElementById('documentUpload').click()">
                        <i class="fas fa-folder-open"></i> Select File
                    </button>
                `;
                
                // Re-setup upload area handlers
                setupUploadAreaForModal();
            }
            
            // Clear any stored document data
            window.uploadedDocument = null;
            
            // Clear localStorage data for this form
            const storageKeys = Object.keys(localStorage);
            storageKeys.forEach(key => {
                if (key.startsWith('mintForm_') || key.startsWith('notice_')) {
                    localStorage.removeItem(key);
                }
            });
            
            // Reset character count
            const charCountSpan = document.getElementById('charCount');
            if (charCountSpan) {
                charCountSpan.textContent = '0';
                charCountSpan.style.color = 'var(--text-secondary)';
            }
            
            // Update fee estimate
            if (typeof updateFeeEstimate === 'function') {
                updateFeeEstimate();
            }
            
            // Show success notification
            uiManager.showNotification('success', 'All form data has been cleared');
        }
        
        // Update creation fee display
        function updateCreationFeeDisplay() {
            // Call the existing updateFeeEstimate function
            if (typeof updateFeeEstimate === 'function') {
                updateFeeEstimate();
            }
        }
        
        // Check if mint form has data
        function checkMintFormHasData() {
            try {
                // Check if any form fields have data (with null checks)
                const recipientEl = document.getElementById('mintRecipient');
                const caseNumberEl = document.getElementById('mintCaseNumber');
                const jurisdictionEl = document.getElementById('mintJurisdiction');
                const documentTypeEl = document.getElementById('mintDocumentType');
                const issuingAgencyEl = document.getElementById('issuingAgency');
                const caseDetailsEl = document.getElementById('caseDetails');
                const noticeTextEl = document.getElementById('noticeTextInput');
                
                const recipient = recipientEl ? recipientEl.value.trim() : '';
                const caseNumber = caseNumberEl ? caseNumberEl.value.trim() : '';
                const jurisdiction = jurisdictionEl ? jurisdictionEl.value : '0';
                const documentType = documentTypeEl ? documentTypeEl.value : '0';
                const issuingAgency = issuingAgencyEl ? issuingAgencyEl.value.trim() : '';
                const caseDetails = caseDetailsEl ? caseDetailsEl.value.trim() : '';
                const noticeText = noticeTextEl ? noticeTextEl.value.trim() : '';
                
                // Check if image was uploaded
                const hasImage = uploadedImage !== null;
                
                // Return true if any field has data
                return recipient || caseNumber || (jurisdiction !== '0') || (documentType !== '0') || 
                       issuingAgency || caseDetails || noticeText || hasImage;
            } catch (error) {
                console.error('Error checking form data:', error);
                return false; // If error, assume no data
            }
        }

        function openAuditModal() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Please connect to contract first');
                return;
            }
            
            document.getElementById('auditModal').style.display = 'block';
        }

        function closeAuditModal() {
            document.getElementById('auditModal').style.display = 'none';
        }

        function closeTransactionResultModal() {
            document.getElementById('transactionResultModal').style.display = 'none';
        }

        function showTransactionResult(success, txData) {
            const modal = document.getElementById('transactionResultModal');
            const titleElement = document.getElementById('txResultTitle');
            const contentElement = document.getElementById('txResultContent');
            
            if (success) {
                titleElement.innerHTML = '<i class="fas fa-check-circle" style="color: var(--success);"></i> Transaction Successful';
                
                let content = '<div class="transaction-result-success">';
                content += '<div class="success-icon" style="text-align: center; margin-bottom: 1.5rem;">';
                content += '<i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success);"></i>';
                content += '</div>';
                
                // Transaction details
                content += '<div class="transaction-details" style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">';
                content += '<h4 style="margin-bottom: 1rem;">Transaction Details</h4>';
                
                if (txData.noticeId) {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Notice ID:</span>`;
                    content += `<strong>#${txData.noticeId}</strong>`;
                    content += `</div>`;
                }
                
                if (txData.txHash) {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Transaction Hash:</span>`;
                    content += `<a href="${getContractScanUrl()}tx/${txData.txHash}" target="_blank" style="color: var(--accent-blue);">`;
                    content += `${txData.txHash.substring(0, 10)}...${txData.txHash.substring(txData.txHash.length - 8)}`;
                    content += `</a>`;
                    content += `</div>`;
                }
                
                if (txData.recipient) {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Recipient:</span>`;
                    content += `<strong>${txData.recipient.substring(0, 10)}...${txData.recipient.substring(txData.recipient.length - 8)}</strong>`;
                    content += `</div>`;
                }
                
                content += '</div>';
                
                // Cost breakdown
                content += '<div class="cost-breakdown" style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem;">';
                content += '<h4 style="margin-bottom: 1rem;">Cost Breakdown</h4>';
                
                if (txData.feePaid !== undefined) {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Service Fee:</span>`;
                    content += `<strong>${txData.feePaid} TRX</strong>`;
                    content += `</div>`;
                }
                
                if (txData.energyUsed !== undefined) {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Energy Used:</span>`;
                    content += `<strong>${txData.energyUsed.toLocaleString()} (${(txData.energyUsed * 0.00042).toFixed(2)} TRX equivalent)</strong>`;
                    content += `</div>`;
                }
                
                if (txData.bandwidthUsed !== undefined) {
                    content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">`;
                    content += `<span>Bandwidth Used:</span>`;
                    content += `<strong>${txData.bandwidthUsed.toLocaleString()} (${(txData.bandwidthUsed * 0.001).toFixed(3)} TRX equivalent)</strong>`;
                    content += `</div>`;
                }
                
                const totalCost = (txData.feePaid || 0) + 
                                 ((txData.energyUsed || 0) * 0.00042) + 
                                 ((txData.bandwidthUsed || 0) * 0.001);
                
                content += `<div class="detail-row" style="display: flex; justify-content: space-between; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-color); font-weight: bold;">`;
                content += `<span>Total Cost:</span>`;
                content += `<strong style="color: var(--accent-blue);">${totalCost.toFixed(3)} TRX</strong>`;
                content += `</div>`;
                
                content += '</div>';
                content += '</div>';
                
                contentElement.innerHTML = content;
            } else {
                titleElement.innerHTML = '<i class="fas fa-exclamation-circle" style="color: var(--error);"></i> Transaction Failed';
                
                let content = '<div class="transaction-result-error">';
                content += '<div class="error-icon" style="text-align: center; margin-bottom: 1.5rem;">';
                content += '<i class="fas fa-exclamation-circle" style="font-size: 4rem; color: var(--error);"></i>';
                content += '</div>';
                
                content += '<div class="error-details" style="background: #fef2f2; padding: 1rem; border-radius: 0.5rem; border: 1px solid #fecaca;">';
                content += '<p style="color: #991b1b; margin: 0;">' + (txData.error || 'Transaction failed. Please try again.') + '</p>';
                content += '</div>';
                
                content += '</div>';
                
                contentElement.innerHTML = content;
            }
            
            modal.style.display = 'block';
        }

        async function openAcceptModal(noticeId) {
            currentNoticeId = noticeId;
            
            // Fetch notice details
            try {
                const details = await getNoticeDetails(noticeId);
                if (details) {
                    document.getElementById('acceptNoticeId').textContent = noticeId;
                    document.getElementById('acceptDocumentType').textContent = getDocumentTypeString(details.documentType);
                    document.getElementById('acceptJurisdiction').textContent = getJurisdictionString(details.jurisdictionIndex);
                    document.getElementById('acceptCaseNumber').textContent = details.caseNumberHash || 'Not Available';
                    document.getElementById('acceptServer').innerHTML = createAddressDisplay(details.server);
                    document.getElementById('acceptTimestamp').textContent = new Date(parseInt(details.timestamp) * 1000).toLocaleString();
                    
                    // Preview images not implemented in simplified contract
                    document.getElementById('acceptPreview').style.display = 'none';
                    
                    // Check if this is a text-only notice (no document)
                    const isTextOnly = !details.documentId || details.documentId == 0;
                    
                    if (isTextOnly) {
                        // For text-only notices, just show the content, no signature required
                        uiManager.showNotification('info', 'This is a text-only notice. No signature required.');
                        viewTextNotice(noticeId);
                        return;
                    }
                    
                    document.getElementById('acceptModal').style.display = 'block';
                } else {
                    uiManager.showNotification('error', 'Failed to load notice details');
                }
            } catch (error) {
                console.error('Error loading notice:', error);
                uiManager.showNotification('error', 'Failed to load notice details');
            }
        }

        function closeAcceptModal() {
            document.getElementById('acceptModal').style.display = 'none';
            currentNoticeId = null;
        }
        
        // View text-only notice (no signature required)
        async function viewTextNotice(noticeId) {
            try {
                const details = await getNoticeDetails(noticeId);
                if (!details) {
                    uiManager.showNotification('error', 'Notice not found');
                    return;
                }
                
                // Show modal with text notice content
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2><i class="fas fa-comment-alt" style="color: #3b82f6;"></i> Text Notice</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info" style="background: #e0f2fe; border-color: #3b82f6;">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                                <strong>View Only Notice</strong>
                                <p style="margin: 0.25rem 0 0 0;">This is a text-only notice that does not require a signature.</p>
                            </div>
                            
                            <div class="notice-details" style="margin-top: 1rem;">
                                <div class="token-detail">
                                    <span>Notice ID:</span>
                                    <span>${noticeId}</span>
                                </div>
                                <div class="token-detail">
                                    <span>Type:</span>
                                    <span>${details.noticeType || 'Text Notice'}</span>
                                </div>
                                <div class="token-detail">
                                    <span>Sender:</span>
                                    <span>${createAddressDisplay(details.server)}</span>
                                </div>
                                <div class="token-detail">
                                    <span>Date:</span>
                                    <span>${new Date(parseInt(details.timestamp) * 1000).toLocaleString()}</span>
                                </div>
                                ${details.caseNumber ? `
                                <div class="token-detail">
                                    <span>Reference:</span>
                                    <span>${details.caseNumber}</span>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="notice-content" style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                                <h4>Notice Content:</h4>
                                <p style="margin-top: 0.5rem;">${details.caseDetails || details.noticeText || 'No content available'}</p>
                                ${details.legalRights ? `<p style="margin-top: 0.5rem; font-weight: 500;">${details.legalRights}</p>` : ''}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error viewing text notice:', error);
                uiManager.showNotification('error', 'Failed to load notice');
            }
        }

        function closeTxModal() {
            document.getElementById('txModal').style.display = 'none';
        }

        // Export printable receipt
        function exportReceipt() {
            if (!currentTransactionData) {
                uiManager.showNotification('error', 'No transaction data available');
                return;
            }
            
            const { txHash, message, timestamp, details, ipfsData, network } = currentTransactionData;
            
            // Create a new window for the printable receipt
            const receiptWindow = window.open('', '_blank', 'width=800,height=600');
            
            // Extract relevant data from details HTML
            let tokenName = '';
            let noticeId = 'N/A';
            let alertId = 'N/A';
            let recipient = '';
            let caseNumber = '';
            let jurisdiction = '';
            
            // Parse details HTML to extract values
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = details;
            const tokenDetails = tempDiv.querySelectorAll('.token-detail');
            tokenDetails.forEach(detail => {
                const spans = detail.querySelectorAll('span');
                if (spans.length >= 2) {
                    const label = spans[0].textContent;
                    const value = spans[1].textContent;
                    if (label.includes('Token Name')) tokenName = value;
                    if (label.includes('Notice ID')) noticeId = value;
                    if (label.includes('Alert ID')) alertId = value;
                    if (label.includes('Recipient')) recipient = value;
                    if (label.includes('Case Number')) caseNumber = value;
                    if (label.includes('Jurisdiction')) jurisdiction = value;
                }
            });
            
            // Generate receipt HTML
            const receiptHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Legal Notice Delivery Receipt</title>
                    <style>
                        @media print {
                            @page { margin: 0.5in; }
                            .no-print { display: none !important; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.6;
                            color: #333;
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 20px;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 2px solid #333;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        h1 {
                            margin: 0;
                            color: #1e3a8a;
                        }
                        .receipt-info {
                            background: #f5f5f5;
                            padding: 20px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        .info-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                            padding-bottom: 10px;
                            border-bottom: 1px dotted #ccc;
                        }
                        .info-row:last-child {
                            border-bottom: none;
                            margin-bottom: 0;
                        }
                        .label {
                            font-weight: bold;
                            color: #555;
                        }
                        .value {
                            color: #333;
                            word-break: break-all;
                        }
                        .verification-section {
                            background: #e8f4f8;
                            padding: 20px;
                            border-radius: 8px;
                            margin-top: 30px;
                        }
                        .verification-steps {
                            margin-top: 15px;
                            padding-left: 20px;
                        }
                        .verification-steps li {
                            margin-bottom: 10px;
                        }
                        .footer {
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 1px solid #ccc;
                            text-align: center;
                            font-size: 12px;
                            color: #666;
                        }
                        .print-button {
                            background: #1e3a8a;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 16px;
                            margin: 20px auto;
                            display: block;
                        }
                        .print-button:hover {
                            background: #1e40af;
                        }
                        .qr-placeholder {
                            width: 150px;
                            height: 150px;
                            border: 2px dashed #ccc;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 20px auto;
                            font-size: 12px;
                            color: #999;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Legal Notice Delivery Receipt</h1>
                        <p>Blockchain-Verified Service of Process</p>
                    </div>
                    
                    <div class="receipt-info">
                        <h2>Transaction Details</h2>
                        <div class="info-row">
                            <span class="label">Date & Time:</span>
                            <span class="value">${new Date(timestamp).toLocaleString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Transaction Hash:</span>
                            <span class="value" style="font-family: monospace; font-size: 12px;">${txHash}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Network:</span>
                            <span class="value">${network}</span>
                        </div>
                        ${tokenName ? `
                        <div class="info-row">
                            <span class="label">Token Name:</span>
                            <span class="value">${tokenName}</span>
                        </div>
                        ` : ''}
                        <div class="info-row">
                            <span class="label">Notice ID:</span>
                            <span class="value">${noticeId}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Alert ID:</span>
                            <span class="value">${alertId}</span>
                        </div>
                        ${recipient ? `
                        <div class="info-row">
                            <span class="label">Recipient:</span>
                            <span class="value">${recipient}</span>
                        </div>
                        ` : ''}
                        ${caseNumber ? `
                        <div class="info-row">
                            <span class="label">Case Number:</span>
                            <span class="value">${caseNumber}</span>
                        </div>
                        ` : ''}
                        ${ipfsData ? `
                        <div class="info-row">
                            <span class="label">IPFS Hash:</span>
                            <span class="value" style="font-family: monospace; font-size: 12px;">${ipfsData.ipfsHash}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${message && message.includes('Legal Notice Created') ? `
                    <div class="receipt-info" style="background: #f9fafb; border: 1px solid #e5e7eb;">
                        <h2>Service of Process Synopsis</h2>
                        ${(() => {
                            // Extract notice details from the transaction details
                            let noticeType = 'Legal Notice';
                            let issuingAgency = 'Not specified';
                            let caseNumber = '';
                            let caseDetails = window.lastTransactionCaseDetails || '';
                            let legalRights = '';
                            let recipientAddress = '';
                            let tokenName = '';
                            let noticeId = '';
                            let alertId = '';
                            
                            // Parse the details to extract information
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(details, 'text/html');
                            const detailElements = doc.querySelectorAll('.token-detail');
                            
                            detailElements.forEach(el => {
                                const spans = el.querySelectorAll('span');
                                if (spans.length >= 2) {
                                    const label = spans[0].textContent.trim();
                                    const value = spans[1].textContent.trim();
                                    
                                    if (label.includes('Token Name')) tokenName = value;
                                    if (label.includes('Recipient')) recipientAddress = value;
                                    if (label.includes('Notice ID')) noticeId = value;
                                    if (label.includes('Alert ID')) alertId = value;
                                }
                            });
                            
                            // Look for synopsis section in details
                            const synopsisSection = doc.querySelector('[style*="Service of Process Synopsis"]');
                            if (synopsisSection && synopsisSection.parentElement) {
                                const synopsisContent = synopsisSection.parentElement.textContent;
                                
                                // Extract values from synopsis
                                const noticeTypeMatch = synopsisContent.match(/Notice Type: ([^\\n]+)/);
                                if (noticeTypeMatch) noticeType = noticeTypeMatch[1].trim();
                                
                                const agencyMatch = synopsisContent.match(/Issuing Agency: ([^\\n]+)/);
                                if (agencyMatch) issuingAgency = agencyMatch[1].trim();
                                
                                const caseNumberMatch = synopsisContent.match(/Case Number: ([^\\n]+)/);
                                if (caseNumberMatch) caseNumber = caseNumberMatch[1].trim();
                                
                                const caseDetailsMatch = synopsisContent.match(/Case Details: ([^\\n]+)/);
                                if (caseDetailsMatch) caseDetails = caseDetailsMatch[1].trim();
                                
                                const rightsMatch = synopsisContent.match(/Legal Rights: ([^\\n]+)/);
                                if (rightsMatch) legalRights = rightsMatch[1].trim();
                            }
                            
                            return `
                            <div class="info-row">
                                <span class="label">Notice Type:</span>
                                <span class="value">${noticeType}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Issuing Agency:</span>
                                <span class="value">${issuingAgency}</span>
                            </div>
                            ${caseNumber && caseNumber !== 'Not specified' ? `
                            <div class="info-row">
                                <span class="label">Case Number:</span>
                                <span class="value">${caseNumber}</span>
                            </div>
                            ` : ''}
                            ${caseDetails && caseDetails !== 'See attached document' ? `
                            <div class="info-row">
                                <span class="label">Case Details:</span>
                                <span class="value">${caseDetails}</span>
                            </div>
                            ` : ''}
                            <div class="info-row">
                                <span class="label">Legal Rights:</span>
                                <span class="value">${legalRights || 'Recipient has the right to respond to this legal notice'}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Service Method:</span>
                                <span class="value">Electronic service via NFT delivery to TRON blockchain wallet</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Response Deadline:</span>
                                <span class="value">${new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString()} (30 days from service)</span>
                            </div>
                            
                            <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; padding: 15px; margin-top: 20px;">
                                <p style="margin: 0; font-size: 14px; color: #92400e;">
                                    <strong>Process Server Attestation:</strong> This receipt certifies that I have made diligent effort to notify the affected party at the blockchain address provided. The recipient has been served with notice that includes information about their legal rights and the requirement to respond within the statutory deadline to avoid default judgment or other negative effects on their property rights.
                                </p>
                            </div>
                            `;
                        })()}
                    </div>
                    ` : ''}
                    
                    <div class="verification-section">
                        <h3>Blockchain Verification Instructions</h3>
                        <p>This legal notice has been permanently recorded on the ${network.includes('Nile') ? 'TRON Nile Testnet' : 'TRON'} blockchain. To independently verify this transaction:</p>
                        
                        <ol class="verification-steps">
                            <li>Visit ${network.includes('Nile') ? 'https://nile.tronscan.org' : 'https://tronscan.org'}</li>
                            <li>In the search bar, paste this transaction hash: <br><code style="background: #f0f0f0; padding: 2px 5px; font-size: 12px;">${txHash}</code></li>
                            <li>Click "Search" or press Enter</li>
                            <li>Verify the following on the transaction page:
                                <ul>
                                    <li>Transaction status shows "Confirmed"</li>
                                    <li>The timestamp matches this receipt</li>
                                    <li>The contract interaction shows "serveNotice" method</li>
                                </ul>
                            </li>
                            ${ipfsData ? `<li>To view the original document:
                                <ul>
                                    <li>Visit https://gateway.pinata.cloud/ipfs/${ipfsData.ipfsHash}</li>
                                    <li>Or https://ipfs.io/ipfs/${ipfsData.ipfsHash}</li>
                                </ul>
                            </li>` : ''}
                        </ol>
                        
                        <p style="margin-top: 20px;"><strong>Note:</strong> The blockchain provides an immutable, tamper-proof record of this legal notice delivery. The transaction cannot be altered or deleted once confirmed.</p>
                    </div>
                    
                    <div class="no-print" style="display: flex; gap: 1rem; justify-content: center; margin: 2rem 0;">
                        <button class="print-button" onclick="window.print()">
                            <i class="fas fa-print"></i> Print Receipt
                        </button>
                        <button class="print-button" onclick="saveReceiptAsHTML()" style="background: #059669;">
                            <i class="fas fa-save"></i> Save Receipt
                        </button>
                    </div>
                    
                    <div class="footer">
                        <p>This receipt certifies that a legal notice was served via blockchain technology on ${new Date(timestamp).toLocaleDateString()}.</p>
                        <p>For questions about blockchain verification, consult with a technical expert or legal professional familiar with blockchain technology.</p>
                    </div>
                </body>
                </html>
            `;
            
            // Write the receipt HTML to the new window
            receiptWindow.document.write(receiptHTML);
            receiptWindow.document.close();
        }
        
        // Registration modal functions
        function closeRegistrationModal(force = false) {
            // Check if there's unsaved data
            const hasData = checkRegistrationFormHasData();
            
            if (!force && hasData) {
                const confirmClose = confirm(
                    'You have unsaved registration data. Are you sure you want to close and lose your progress?'
                );
                if (!confirmClose) {
                    return;
                }
            }
            
            document.getElementById('registrationModal').style.display = 'none';
            // Clear form
            document.getElementById('modalAgencyName').value = '';
            document.getElementById('modalAgencyEmail').value = '';
            document.getElementById('modalServerName').value = '';
            document.getElementById('modalServerPhone').value = '';
            document.getElementById('modalLicenseNumber').value = '';
            document.getElementById('modalServiceAreas').value = '';
        }
        
        // Check if registration form has data
        function checkRegistrationFormHasData() {
            const agency = document.getElementById('modalAgencyName').value.trim();
            const email = document.getElementById('modalAgencyEmail').value.trim();
            const name = document.getElementById('modalServerName').value.trim();
            const phone = document.getElementById('modalServerPhone').value.trim();
            const license = document.getElementById('modalLicenseNumber').value.trim();
            const areas = document.getElementById('modalServiceAreas').value.trim();
            
            return agency || email || name || phone || license || areas;
        }
        
        async function submitAdminRegistration() {
            // Get form values
            const agencyName = document.getElementById('modalAgencyName').value.trim();
            const agencyEmail = document.getElementById('modalAgencyEmail').value.trim();
            const serverName = document.getElementById('modalServerName').value.trim();
            const serverPhone = document.getElementById('modalServerPhone').value.trim();
            const licenseNumber = document.getElementById('modalLicenseNumber').value.trim();
            const serviceAreas = document.getElementById('modalServiceAreas').value.trim();
            
            // Validate required fields
            if (!agencyName || !agencyEmail || !serverName || !serverPhone) {
                uiManager.showNotification('error', 'Please fill in all required fields');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^s@]+@[^s@]+.[^s@]+$/;
            if (!emailRegex.test(agencyEmail)) {
                uiManager.showNotification('error', 'Please enter a valid email address');
                return;
            }
            
            // Save registration data
            const registrationData = {
                agencyName,
                agencyEmail,
                serverName,
                serverPhone,
                licenseNumber,
                serviceAreas,
                registeredAt: new Date().toISOString(),
                address: window.pendingProcessServerAddress,
                note: 'Hybrid contract - auto-assigned server ID upon role grant'
            };
            
            // Store in localStorage
            const serverRegistrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
            serverRegistrations[window.pendingProcessServerAddress] = registrationData;
            localStorage.setItem('serverRegistrations', JSON.stringify(serverRegistrations));
            
            // Show notification about the limitation
            uiManager.showNotification('info', 'Registration data saved locally. Server ID will be auto-assigned when role is granted. Note: Name/agency cannot be updated on-chain with the hybrid contract.');
            
            // Close modal
            closeRegistrationModal();
            
            // Continue with role granting
            await grantProcessServerRole(
                window.pendingProcessServerAddress,
                window.pendingLawEnforcementExempt,
                window.pendingAgencyName
            );
        }
        
                async function grantProcessServerRole(address, lawEnforcementExempt, agencyName) {
            try {
                showProcessing('Granting Process Server role...');
                
                const roleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                
                // Grant the role
                await legalContract.grantRole(roleBytes, address).send({
                    feeLimit: 20_000_000,
                    shouldPollResponse: true
                });
                
                // Set law enforcement exemption if requested
                if (lawEnforcementExempt && agencyName) {
                    showProcessing('Setting law enforcement exemption...');
                    await legalContract.setLawEnforcementExemption(address, agencyName).send({
                        feeLimit: 20_000_000,
                        shouldPollResponse: true
                    });
                }
                
                hideProcessing();
                
                let message = 'Process Server role granted';
                if (lawEnforcementExempt) {
                    message += ' with law enforcement exemption (' + agencyName + ')';
                }
                
                showAlert('roleResult', 'success', message);
                
                // Clear form
                document.getElementById('roleAddress').value = '';
                document.getElementById('lawEnforcementExempt').checked = false;
                document.getElementById('lawEnforcementAgencyName').value = '';
                
            } catch (error) {
                hideProcessing();
                console.error('Error:', error);
                showAlert('roleResult', 'error', 'Failed: ' + getErrorMessage(error));
            }
        }

        // Function for regular users to open registration
        function openRegistrationForUser() {
            if (!tronWeb || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect your wallet first');
                return;
            }
            
            // Check if already a process server
            checkIfProcessServer().then(isServer => {
                if (isServer) {
                    uiManager.showNotification('info', 'You are already registered as a process server');
                    return;
                }
                
                // Set the user's own address
                window.pendingProcessServerAddress = tronWeb.defaultAddress.base58;
                window.pendingServiceFeeExempt = false;
                window.pendingFullFeeExempt = false;
                
                // Show the registration modal
                document.getElementById('registrationModal').style.display = 'flex';
            });
        }
        
        async function checkIfProcessServer() {
            if (!legalContract || !tronWeb.defaultAddress) return false;
            
            try {
                const roleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                return await legalContract.hasRole(roleBytes, tronWeb.defaultAddress.base58).call();
            } catch (error) {
                console.error('Error checking process server role:', error);
                return false;
            }
        }
        
        // Update token prefix based on process server status
        async function updateTokenPrefix() {
            if (!legalContract || !tronWeb.defaultAddress) return;
            
            try {
                // Check if user is a process server
                const isProcessServer = await checkIfProcessServer();
                const prefixElement = document.getElementById('tokenPrefix');
                
                if (isProcessServer) {
                    // Get server info to find their ID
                    // Note: Hybrid contract auto-assigns server IDs but doesn't support on-chain name/agency updates
                    const serverInfo = await legalContract.processServers(tronWeb.defaultAddress.base58).call();
                    // The optimized contract returns: [serverId, noticesServed, registeredDate, name, agency, active]
                    const serverId = serverInfo[0] || serverInfo.serverId;
                    
                    if (serverId && serverId.toString() !== '0') {
                        // Update the token prefix
                        if (prefixElement) {
                            prefixElement.textContent = `PS${serverId.toString().padStart(2, '0')}-`;
                        }
                        
                        // Update the server ID display at the top
                        const serverIdDisplay = document.getElementById('serverIdDisplay');
                        const userServerIdSpan = document.getElementById('userServerId');
                        if (serverIdDisplay && userServerIdSpan) {
                            serverIdDisplay.style.display = 'block';
                            userServerIdSpan.textContent = serverId.toString().padStart(2, '0');
                        }
                    }
                } else {
                    // Not a process server, use default prefix
                    if (prefixElement) {
                        prefixElement.textContent = 'NOTICE-';
                    }
                }
            } catch (e) {
                console.error('Error getting process server info:', e);
            }
        }
        
        // Update wallet status display
        async function updateWalletStatus() {
            if (!legalContract || !tronWeb.defaultAddress) return;
            
            const roleDetails = document.getElementById('roleCheckDetails');
            const walletRoleElement = document.getElementById('walletRole');
            const feeExemptElement = document.getElementById('feeExemptStatus');
            const statusAddressElement = document.getElementById('statusWalletAddress');
            const walletBalanceElement = document.getElementById('walletBalance');
            
            try {
                const address = tronWeb.defaultAddress.base58;
                let detailsHtml = '<div>';
                
                // Update address
                if (statusAddressElement) {
                    statusAddressElement.textContent = address.substring(0, 10) + '...' + address.substring(address.length - 8);
                }
                
                // Update balance
                if (walletBalanceElement) {
                    const balance = await tronWeb.trx.getBalance(address);
                    walletBalanceElement.textContent = (balance / 1e6).toFixed(2) + ' TRX';
                }
                
                // Check admin role
                const defaultAdminRole = '0x0000000000000000000000000000000000000000000000000000000000000000';
                const adminRoleBytes = tronWeb.sha3('ADMIN_ROLE');
                const hasDefaultAdminRole = await legalContract.hasRole(defaultAdminRole, address).call();
                const hasAdminRole = await legalContract.hasRole(adminRoleBytes, address).call();
                const isAdmin = hasDefaultAdminRole || hasAdminRole;
                
                // Check process server role
                const processServerRoleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                const hasProcessServerRole = await legalContract.hasRole(processServerRoleBytes, address).call();
                
                // Update role display
                if (walletRoleElement) {
                    if (isAdmin) {
                        walletRoleElement.innerHTML = '<span class="badge badge-primary">Admin</span>';
                    } else if (hasProcessServerRole) {
                        walletRoleElement.innerHTML = '<span class="badge badge-success">Process Server</span>';
                    } else {
                        walletRoleElement.innerHTML = '<span class="badge badge-secondary">None</span>';
                    }
                }
                
                // Check fee exemptions
                const isLawEnforcement = await legalContract.lawEnforcementExemptions(address).call();
                const agencyName = await legalContract.lawEnforcementAgencies(address).call();
                
                if (feeExemptElement) {
                    if (isLawEnforcement) {
                        feeExemptElement.innerHTML = `<span class="badge badge-success">Law Enforcement (${agencyName})</span>`;
                    } else {
                        feeExemptElement.innerHTML = '<span class="badge badge-warning">Not Exempt</span>';
                    }
                }
                
                // Build detailed role info
                detailsHtml += `<div><strong>Address:</strong> ${address}</div>`;
                
                if (isAdmin) {
                    detailsHtml += '<div style="margin-top: 0.5rem;"><strong>Admin Role:</strong>  Granted</div>';
                }
                
                if (hasProcessServerRole) {
                    detailsHtml += '<div style="margin-top: 0.5rem;"><strong>Process Server Role:</strong>  Granted</div>';
                    
                    // Get server info
                    try {
                        const serverInfo = await legalContract.processServers(address).call();
                        const serverId = serverInfo[0] || serverInfo.serverId;
                        
                        if (serverId && serverId.toString() !== '0') {
                            detailsHtml += `<div style="margin-left: 1rem;">Server ID: <strong>${serverId}</strong></div>`;
                            detailsHtml += `<div style="margin-left: 1rem;">Notices Served: ${serverInfo[1] || serverInfo.noticesServed || '0'}</div>`;
                            
                            // Update the server ID display at the top
                            const serverIdDisplay = document.getElementById('serverIdDisplay');
                            const userServerIdSpan = document.getElementById('userServerId');
                            if (serverIdDisplay && userServerIdSpan) {
                                serverIdDisplay.style.display = 'block';
                                userServerIdSpan.textContent = serverId.toString().padStart(2, '0');
                            }
                        }
                    } catch (e) {
                        console.error('Error getting process server info:', e);
                    }
                }
                
                if (isLawEnforcement) {
                    detailsHtml += `<div style="margin-top: 0.5rem;"><strong>Law Enforcement Exemption:</strong>  Active</div>`;
                    detailsHtml += `<div style="margin-left: 1rem;">Agency: ${agencyName}</div>`;
                }
                
                // Check local registration status (for pending registrations)
                const serverRegistrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
                const localReg = serverRegistrations[address];
                if (localReg && localReg.status === 'pending') {
                    detailsHtml += `<div style="margin-top: 0.5rem;"><strong>Pending Registration:</strong></div>`;
                    detailsHtml += `<div style="margin-left: 1rem;">Status: Awaiting approval</div>`;
                }
                
                detailsHtml += '</div>';
                if (roleDetails) {
                    roleDetails.innerHTML = detailsHtml;
                }
                
            } catch (error) {
                console.error('Error updating wallet status:', error);
                if (roleDetails) {
                    roleDetails.innerHTML = '<span style="color: var(--error);">Error checking roles: ' + error.message + '</span>';
                }
            }
        }
        
        // Connect to smart contracts
        async function connectContracts() {
            if (!tronWeb || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect your wallet first');
                return;
            }
            
            const connectBtn = document.getElementById('connectContractBtn');
            const contractStatus = document.getElementById('contractStatus');
            const contractAddress = document.getElementById('contractAddress').value.trim();
            
            if (!contractAddress) {
                uiManager.showNotification('error', 'Please enter the contract address');
                return;
            }
            
            try {
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<span class="loading-spinner"></span> Connecting...';
                
                // Create contract instance with ABI
                legalContract = await tronWeb.contract(CONTRACT_ABI, contractAddress);
                
                // Test the contract by calling a view function
                const totalNotices = await legalContract.totalSupply().call();
                
                // Success
                contractStatus.innerHTML = `
                    <div class="alert alert-success" style="margin-top: 1rem;">
                        <i class="fas fa-check-circle"></i>
                        Contract connected successfully! Total notices: ${totalNotices}
                    </div>
                `;
                
                // Update wallet status
                await updateWalletStatus();
                
                // Check user roles
                await checkUserRoles();
                
                // Update token prefix
                await updateTokenPrefix();
                
                // Show wallet status card
                const walletStatusCard = document.getElementById('walletStatusCard');
                if (walletStatusCard) {
                    walletStatusCard.style.display = 'block';
                }
                
                uiManager.showNotification('success', 'Contract connected successfully');
                
            } catch (error) {
                console.error('Contract connection error:', error);
                contractStatus.innerHTML = `
                    <div class="alert alert-error" style="margin-top: 1rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to connect: ${error.message}
                    </div>
                `;
                connectBtn.disabled = false;
                connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect Contract';
            }
        }
        
        // Submit registration
        async function submitRegistration() {
            const name = document.getElementById('regFullName').value.trim();
            const agency = document.getElementById('regAgency').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const wallet = document.getElementById('regWallet').value.trim();
            
            if (!name || !agency || !email) {
                uiManager.showNotification('error', 'Please fill in all required fields');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                uiManager.showNotification('error', 'Please enter a valid email address');
                return;
            }
            
            const registration = {
                name,
                agency,
                email,
                wallet,
                registeredAt: new Date().toISOString(),
                status: 'pending',
                serverId: generateServerId()
            };
            
            // Save to local storage
            saveServerRegistration(wallet, registration);
            
            // Clear form
            document.getElementById('regFullName').value = '';
            document.getElementById('regAgency').value = '';
            document.getElementById('regEmail').value = '';
            
            // Close modal
            closeRegistrationModal();
            
            uiManager.showNotification('success', 'Registration submitted successfully! Awaiting admin approval.');
            
            // Show registration notice
            const registrationNotice = document.getElementById('registrationNotice');
            if (registrationNotice) {
                registrationNotice.style.display = 'none';
            }
        }
        
        // Refresh pending registrations
        function refreshPendingRegistrations() {
            const container = document.getElementById('pendingRegistrations');
            if (!container) return;
            
            const registrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
            const pendingRegs = Object.entries(registrations)
                .filter(([_, reg]) => reg.status === 'pending')
                .map(([wallet, reg]) => ({ ...reg, wallet }));
            
            if (pendingRegs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No pending registrations</h3>
                        <p>New registrations will appear here</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="registration-list">';
            pendingRegs.forEach(reg => {
                html += `
                    <div class="registration-item">
                        <div class="reg-info">
                            <h4>${reg.name} <span class="badge badge-warning">Pending</span></h4>
                            <p>Agency: ${reg.agency}</p>
                            <p>Email: ${reg.email}</p>
                            <p>Wallet: <code>${reg.wallet}</code></p>
                            <p>Submitted: ${new Date(reg.registeredAt).toLocaleString()}</p>
                        </div>
                        <div class="reg-actions">
                            <button class="btn btn-success btn-small" onclick="approveRegistration('${reg.wallet}')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn btn-danger btn-small" onclick="rejectRegistration('${reg.wallet}')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Approve registration
        async function approveRegistration(walletAddress) {
            if (!legalContract || !isAdmin) {
                uiManager.showNotification('error', 'Not authorized');
                return;
            }
            
            const registrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
            const registration = registrations[walletAddress];
            
            if (!registration) {
                uiManager.showNotification('error', 'Registration not found');
                return;
            }
            
            try {
                showProcessing('Granting process server role...');
                
                // Grant PROCESS_SERVER_ROLE
                const processServerRole = tronWeb.sha3('PROCESS_SERVER_ROLE');
                await legalContract.grantRole(processServerRole, walletAddress).send({
                    feeLimit: 100_000_000,
                    shouldPollResponse: true
                });
                
                // Update registration status
                registration.status = 'approved';
                registration.approvedAt = new Date().toISOString();
                saveServerRegistration(walletAddress, registration);
                
                hideProcessing();
                uiManager.showNotification('success', 'Registration approved and role granted!');
                
                // Refresh the list
                refreshPendingRegistrations();
                
            } catch (error) {
                hideProcessing();
                console.error('Approval error:', error);
                uiManager.showNotification('error', 'Failed to approve: ' + error.message);
            }
        }
        
        // Reject registration
        function rejectRegistration(walletAddress) {
            const registrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
            const registration = registrations[walletAddress];
            
            if (!registration) {
                uiManager.showNotification('error', 'Registration not found');
                return;
            }
            
            registration.status = 'rejected';
            registration.rejectedAt = new Date().toISOString();
            saveServerRegistration(walletAddress, registration);
            
            uiManager.showNotification('info', 'Registration rejected');
            refreshPendingRegistrations();
        }
        
        // Update stats from localStorage
        function updateStatsFromLocalStorage() {
            const statsContainer = document.getElementById('adminStats');
            if (!statsContainer) return;
            
            const registrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
            const allRegs = Object.values(registrations);
            
            const stats = {
                total: allRegs.length,
                pending: allRegs.filter(r => r.status === 'pending').length,
                approved: allRegs.filter(r => r.status === 'approved').length,
                rejected: allRegs.filter(r => r.status === 'rejected').length
            };
            
            statsContainer.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${stats.total}</div>
                        <div class="stat-label">Total Registrations</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.pending}</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.approved}</div>
                        <div class="stat-label">Approved</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.rejected}</div>
                        <div class="stat-label">Rejected</div>
                    </div>
                </div>
            `;
        }
        
        // Grant role function
        async function grantRole() {
            const address = document.getElementById('roleAddress').value.trim();
            const roleSelect = document.getElementById('roleSelect').value;
            
            if (!address) {
                uiManager.showNotification('error', 'Please enter an address');
                return;
            }
            
            if (!tronWeb.isAddress(address)) {
                uiManager.showNotification('error', 'Invalid TRON address');
                return;
            }
            
            if (!roleSelect) {
                uiManager.showNotification('error', 'Please select a role');
                return;
            }
            
            try {
                showProcessing('Granting role...');
                
                let roleBytes;
                let roleName;
                
                switch(roleSelect) {
                    case 'ADMIN_ROLE':
                        roleBytes = tronWeb.sha3('ADMIN_ROLE');
                        roleName = 'Admin';
                        break;
                    case 'PROCESS_SERVER_ROLE':
                        roleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                        roleName = 'Process Server';
                        break;
                    default:
                        throw new Error('Invalid role selected');
                }
                
                // Grant the role
                await legalContract.grantRole(roleBytes, address).send({
                    feeLimit: 100_000_000,
                    shouldPollResponse: true
                });
                
                // If process server, save registration info
                if (roleSelect === 'process_server') {
                    const name = document.getElementById('serverName').value.trim() || 'Unknown';
                    const phone = document.getElementById('serverPhone').value.trim() || '';
                    
                    const registration = {
                        name,
                        phone,
                        wallet: address,
                        status: 'approved',
                        approvedAt: new Date().toISOString(),
                        serverId: generateServerId()
                    };
                    
                    saveServerRegistration(address, registration);
                }
                
                hideProcessing();
                showAlert('roleResult', 'success', `${roleName} role granted to ${address}`);
                
                // Clear form
                document.getElementById('roleAddress').value = '';
                document.getElementById('serverName').value = '';
                document.getElementById('serverPhone').value = '';
                
            } catch (error) {
                hideProcessing();
                console.error('Error granting role:', error);
                showAlert('roleResult', 'error', 'Failed to grant role: ' + getErrorMessage(error));
            }
        }
        
        // Check role function
        async function checkRole() {
            const address = document.getElementById('roleAddress').value.trim();
            
            if (!address) {
                uiManager.showNotification('error', 'Please enter an address');
                return;
            }
            
            if (!tronWeb.isAddress(address)) {
                uiManager.showNotification('error', 'Invalid TRON address');
                return;
            }
            
            try {
                showProcessing('Checking roles...');
                
                const adminRoleBytes = tronWeb.sha3('ADMIN_ROLE');
                const processServerRoleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                const defaultAdminRole = '0x0000000000000000000000000000000000000000000000000000000000000000';
                
                const hasDefaultAdmin = await legalContract.hasRole(defaultAdminRole, address).call();
                const hasAdmin = await legalContract.hasRole(adminRoleBytes, address).call();
                const hasProcessServer = await legalContract.hasRole(processServerRoleBytes, address).call();
                
                let roles = [];
                if (hasDefaultAdmin) roles.push('DEFAULT_ADMIN_ROLE');
                if (hasAdmin) roles.push('ADMIN_ROLE');
                if (hasProcessServer) roles.push('PROCESS_SERVER_ROLE');
                
                hideProcessing();
                
                if (roles.length > 0) {
                    showAlert('roleResult', 'info', `Address ${address} has roles: ${roles.join(', ')}`);
                } else {
                    showAlert('roleResult', 'warning', `Address ${address} has no roles`);
                }
                
            } catch (error) {
                hideProcessing();
                console.error('Error checking role:', error);
                showAlert('roleResult', 'error', 'Failed to check role: ' + error.message);
            }
        }
        
        // Show mint step (for batch operations)
        function showMintStep() {
            document.getElementById('noticeCard').style.display = 'block';
            document.getElementById('batchUploadCard').style.display = 'none';
            document.getElementById('batchProgress').style.display = 'none';
        }
        
        // GitHub config
        const GITHUB_CONFIG = {
            owner: '',
            repo: '',
            token: '',
            path: 'registrations'
        };
        
        // Load GitHub settings
        function loadGitHubSettings() {
            const savedToken = localStorage.getItem('githubToken');
            if (savedToken) {
                GITHUB_CONFIG.token = savedToken;
                document.getElementById('githubToken').value = savedToken;
            }
        }

// Refresh wallet status
async function refreshWalletStatus() {
    const refreshBtn = event.target;
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner loading-spinner"></i> Refreshing...';
    
    try {
        await updateWalletStatus();
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Status';
    } catch (error) {
        console.error('Error refreshing status:', error);
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Status';
    } finally {
        refreshBtn.disabled = false;
    }
}

// Check user roles
async function checkUserRoles() {
    if (!legalContract || !tronWeb.defaultAddress) return;
    
    try {
                // Check DEFAULT_ADMIN_ROLE (0x00) first, then ADMIN_ROLE
                const defaultAdminRole = '0x0000000000000000000000000000000000000000000000000000000000000000';
                const adminRoleBytes = tronWeb.sha3('ADMIN_ROLE');
                const processServerRoleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                
                console.log('=== Checking Admin Roles ===');
                console.log('Current address:', tronWeb.defaultAddress.base58);
                console.log('DEFAULT_ADMIN_ROLE:', defaultAdminRole);
                console.log('ADMIN_ROLE hash:', adminRoleBytes);
                
                // Check if user has DEFAULT_ADMIN_ROLE or ADMIN_ROLE
                const hasDefaultAdminRole = await legalContract.hasRole(defaultAdminRole, tronWeb.defaultAddress.base58).call();
                const hasAdminRole = await legalContract.hasRole(adminRoleBytes, tronWeb.defaultAddress.base58).call();
                isAdmin = hasDefaultAdminRole || hasAdminRole;
                
                console.log('Has DEFAULT_ADMIN_ROLE:', hasDefaultAdminRole);
                console.log('Has ADMIN_ROLE:', hasAdminRole);
                console.log('isAdmin result:', isAdmin);
                
                // Note: getRoleMemberCount and getRoleMember are not available in this implementation
                isProcessServer = await legalContract.hasRole(processServerRoleBytes, tronWeb.defaultAddress.base58).call();
                
                // Update admin tab visibility
                updateAdminTabVisibility();
                
                // Check fee exemption status
                const isLawEnforcement = await legalContract.lawEnforcementExemptions(tronWeb.defaultAddress.base58).call();
                const serviceFeeExempt = isLawEnforcement;
                const fullFeeExempt = isLawEnforcement;
                
                // Update fee status display
                const feeStatusElement = document.getElementById('feeExemptStatus');
                if (feeStatusElement) {
                    if (fullFeeExempt) {
                        feeStatusElement.innerHTML = '<span class="badge badge-success">Full Exempt</span>';
                    } else if (serviceFeeExempt) {
                        feeStatusElement.innerHTML = '<span class="badge badge-primary">Service Fee Exempt</span>';
                    } else {
                        feeStatusElement.innerHTML = '<span class="badge badge-warning">Not Exempt</span>';
                    }
                }
                
                // Enable admin-only buttons if user is admin
                const updateFeeBtn = document.getElementById('updateFeeBtn');
                const updateFeeCollectorBtn = document.getElementById('updateFeeCollectorBtn');
                if (updateFeeBtn) updateFeeBtn.disabled = !isAdmin;
                if (updateFeeCollectorBtn) updateFeeCollectorBtn.disabled = !isAdmin;
                
                // Update UI based on roles
                const registrationNotice = document.getElementById('registrationNotice');
                if (registrationNotice) {
                    if (!isProcessServer && !isAdmin) {
                        registrationNotice.style.display = 'flex';
                    } else {
                        registrationNotice.style.display = 'none';
                    }
                }
                
                // Show server ID if assigned
                if (isProcessServer || isAdmin) {
                    const userServerId = document.getElementById('userServerId');
                    const serverIdDisplay = document.getElementById('serverIdDisplay');
                    
                    // Get server ID from registration data
                    const serverData = serverRegistrations[tronWeb.defaultAddress.base58];
                    if (serverData && serverData.serverId) {
                        if (userServerId) userServerId.textContent = serverData.serverId.split('-').pop();
                    } else {
                        if (userServerId) userServerId.textContent = '0000';
                    }
                    
                    if (serverIdDisplay) serverIdDisplay.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error checking roles:', error);
            }
        }

        // Global variable to store current transaction data for receipt
        let currentTransactionData = null;

        // Transaction modal
        function showTxModal(txHash, message, details = '', ipfsData = null) {
            const modal = document.getElementById('txModal');
            const txHashElement = document.getElementById('txHash');
            const txMessage = document.getElementById('txMessage');
            const txLink = document.getElementById('txLink');
            const txDetails = document.getElementById('txDetails');
            
            txMessage.textContent = message || 'Your transaction has been successfully confirmed!';
            txHashElement.textContent = txHash;
            
            // Store transaction data for receipt export
            currentTransactionData = {
                txHash: txHash,
                message: message,
                timestamp: new Date().toISOString(),
                details: details,
                ipfsData: ipfsData,
                network: document.getElementById('networkName')?.textContent || 'Unknown'
            };
            
            // Build enhanced details with IPFS info if available
            let enhancedDetails = details;
            if (ipfsData && ipfsData.ipfsHash) {
                const ipfsPreview = `
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <h4 style="margin-bottom: 0.75rem; color: var(--text-primary);">NFT Document</h4>
                        ${ipfsData.imageUrl ? `
                            <div style="margin-bottom: 1rem;">
                                <img src="${ipfsData.imageUrl}" 
                                     style="max-width: 100%; max-height: 300px; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                     onclick="window.open('${ipfsData.imageUrl}', '_blank')" 
                                     title="Click to view full size" />
                            </div>
                        ` : ''}
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem;">
                            <a href="https://gateway.pinata.cloud/ipfs/${ipfsData.ipfsHash}" target="_blank" class="btn btn-secondary btn-small">
                                <i class="fas fa-image"></i> View on Pinata
                            </a>
                            <a href="https://ipfs.io/ipfs/${ipfsData.ipfsHash}" target="_blank" class="btn btn-secondary btn-small">
                                <i class="fas fa-globe"></i> View on IPFS.io
                            </a>
                        </div>
                        <div class="token-detail">
                            <span>IPFS Hash:</span>
                            <span style="font-family: monospace; font-size: 0.875rem;">${ipfsData.ipfsHash}</span>
                        </div>
                    </div>
                `;
                enhancedDetails = details + ipfsPreview;
            }
            
            // Add contract address link if available
            const contractAddressField = document.getElementById('contractAddress');
            const contractAddress = contractAddressField ? contractAddressField.value : null;
            if (contractAddress) {
                const contractLink = `
                    <div style="margin-top: 0.75rem;">
                        <div class="token-detail">
                            <span>Contract:</span>
                            <span>
                                <a href="${getContractScanUrl(contractAddress)}" target="_blank" style="color: var(--accent-blue); text-decoration: none;">
                                    ${contractAddress.substring(0, 10)}...${contractAddress.substring(contractAddress.length - 8)}
                                    <i class="fas fa-external-link-alt" style="font-size: 0.75rem; margin-left: 0.25rem;"></i>
                                </a>
                            </span>
                        </div>
                    </div>
                `;
                enhancedDetails += contractLink;
            }
            
            txDetails.innerHTML = enhancedDetails;
            
            // Get network for Tronscan link
            const network = document.getElementById('networkName').textContent;
            let tronscanUrl = 'https://tronscan.org/#/transaction/';
            
            if (network.includes('Nile')) {
                tronscanUrl = 'https://nile.tronscan.org/#/transaction/';
            } else if (network.includes('Shasta')) {
                tronscanUrl = 'https://shasta.tronscan.org/#/transaction/';
            }
            
            txLink.href = tronscanUrl + txHash;
            modal.style.display = 'block';
        }

        function copyTxHash() {
            const txHashElement = document.getElementById('txHash');
            const txHash = txHashElement.textContent;
            
            navigator.clipboard.writeText(txHash).then(() => {
                uiManager.showNotification('success', 'Transaction hash copied to clipboard');
            }).catch(err => {
                console.error('Failed to copy:', err);
                uiManager.showNotification('error', 'Failed to copy transaction hash');
            });
        }

        // Helper function to get contract explorer URL
        function getContractScanUrl(address) {
            if (!address) {
                const contractAddressField = document.getElementById('contractAddress');
                address = contractAddressField ? contractAddressField.value : null;
            }
            const network = document.getElementById('networkName')?.textContent || 'Mainnet';
            let explorerUrl = 'https://tronscan.org';
            
            if (network.includes('Nile')) {
                explorerUrl = 'https://nile.tronscan.org';
            } else if (network.includes('Shasta')) {
                explorerUrl = 'https://shasta.tronscan.org';
            }
            
            return `${explorerUrl}/#/contract/${address}`;
        }

        function viewContractOnTronscan(type) {
            let address;
            if (type === 'legal') {
                address = document.getElementById('contractAddress').value;
            }
            
            if (!address) {
                uiManager.showNotification('error', 'No contract address available');
                return;
            }
            
            const config = CHAIN_CONFIG[currentChainType][currentNetwork];
            let explorerUrl;
            
            if (currentChainType === 'tron') {
                explorerUrl = `${config.explorerUrl}/#/contract/${address}`;
            } else {
                explorerUrl = `${config.explorerUrl}/address/${address}`;
            }
            
            window.open(explorerUrl, '_blank');
        }

        function viewOnTronscan(type, id) {
            const network = document.getElementById('networkName').textContent;
            let tronscanUrl;
            
            if (type === 'notice') {
                const contractAddress = document.getElementById('contractAddress').value;
                
                if (network.includes('Nile')) {
                    tronscanUrl = `https://nile.tronscan.org/#/token721/${contractAddress}/token/${id}`;
                } else if (network.includes('Shasta')) {
                    tronscanUrl = `https://shasta.tronscan.org/#/token721/${contractAddress}/token/${id}`;
                } else {
                    tronscanUrl = `https://tronscan.org/#/token721/${contractAddress}/token/${id}`;
                }
            } else {
                if (network.includes('Nile')) {
                    tronscanUrl = `https://nile.tronscan.org/#/transaction/${id}`;
                } else if (network.includes('Shasta')) {
                    tronscanUrl = `https://shasta.tronscan.org/#/transaction/${id}`;
                } else {
                    tronscanUrl = `https://tronscan.org/#/transaction/${id}`;
                }
            }
            
            window.open(tronscanUrl, '_blank');
        }

        function viewOnIPFS(ipfsHash) {
            // Use a public IPFS gateway
            const ipfsUrl = `https://ipfs.io/ipfs/${ipfsHash}`;
            window.open(ipfsUrl, '_blank');
        }

        // Recent activity functions
        function addRecentActivity(type, description, details = {}) {
            const activity = {
                type,
                description,
                details,
                timestamp: new Date()
            };
            
            recentActivity.unshift(activity);
            
            // Keep only last 10 activities
            if (recentActivity.length > 10) {
                recentActivity = recentActivity.slice(0, 10);
            }
            
            updateRecentActivityDisplay();
        }

        function updateRecentActivityDisplay() {
            const activityDiv = document.getElementById('recentActivityContent');
            
            if (recentActivity.length === 0) {
                activityDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard"></i>
                        <h3>No recent activity</h3>
                        <p>Your recent transactions will appear here</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="token-list">';
            
            recentActivity.forEach(activity => {
                const icon = getActivityIcon(activity.type);
                const timeAgo = getTimeAgo(activity.timestamp);
                
                html += `
                    <div class="token-item" style="padding: 0.75rem 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <i class="${icon}" style="color: var(--accent-blue); font-size: 1.25rem;"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${escapeHtml(activity.description)}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${timeAgo}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            activityDiv.innerHTML = html;
        }

        function getActivityIcon(type) {
            const icons = {
                'create': 'fas fa-file-upload',
                'accept': 'fas fa-check-circle',
                'registration': 'fas fa-user-plus',
                'approval': 'fas fa-user-check',
                'role': 'fas fa-user-shield',
                'admin': 'fas fa-cog'
            };
            
            return icons[type] || 'fas fa-circle';
        }

        // Helper functions
        function formatAddress(address) {
            if (!address) return 'N/A';
            return address.substring(0, 8) + '...' + address.substring(address.length - 6);
        }
        
        // Server registration helper functions
        function generateServerId() {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 5);
            return `PS-${timestamp}-${random}`.toUpperCase();
        }
        
        function saveServerRegistration(address, data) {
            serverRegistrations[address] = data;
            try {
                localStorage.setItem('serverRegistrations', JSON.stringify(serverRegistrations));
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }
        
        function exportRegistrations() {
            const data = Object.values(serverRegistrations);
            if (data.length === 0) {
                uiManager.showNotification('info', 'No server registrations to export');
                return;
            }
            
            // Convert to CSV
            const headers = ['Server ID', 'Address', 'Agency Name', 'Agency Email', 'Server Name', 'Phone', 'Registered At', 'Registered By', 'Fee Exempt'];
            const csvData = [
                headers.join(','),
                ...data.map(reg => [
                    reg.serverId,
                    reg.address,
                    `"${reg.agencyName}"`,
                    reg.agencyEmail,
                    `"${reg.serverName}"`,
                    reg.serverPhone,
                    reg.registeredAt,
                    reg.registeredBy,
                    reg.feeExempt ? 'Yes' : 'No'
                ].join(','))
            ].join('\n');
            
            // Download file
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `process_servers_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            uiManager.showNotification('success', `Exported ${data.length} server registration(s)`);
        }
        
        // Toggle registration form visibility
        function toggleRegistrationForm() {
            const roleSelect = document.getElementById('roleSelect');
            const registrationForm = document.getElementById('serverRegistrationForm');
            const lawEnforcementSection = document.getElementById('lawEnforcementSection');
            
            if (registrationForm) {
                registrationForm.style.display = roleSelect.value === 'PROCESS_SERVER_ROLE' ? 'block' : 'none';
            }
            
            // Always show law enforcement section for any role
            if (lawEnforcementSection) {
                lawEnforcementSection.style.display = 'block';
            }
        }
        
        // Toggle stats section
        function toggleStats() {
            console.log('Toggle stats called');
            const statsSection = document.getElementById('statsSection');
            const toggleIcon = document.getElementById('statsToggleIcon');
            
            if (!statsSection || !toggleIcon) {
                console.error('Stats elements not found:', { statsSection, toggleIcon });
                return;
            }
            
            if (statsSection.style.display === 'none' || statsSection.style.display === '') {
                statsSection.style.display = 'grid';
                toggleIcon.className = 'fas fa-chevron-up';
            } else {
                statsSection.style.display = 'none';
                toggleIcon.className = 'fas fa-chevron-down';
            }
        }
        
        // Toggle wallet status section
        function toggleWalletStatus() {
            console.log('Toggle wallet status called');
            const walletContent = document.getElementById('walletStatusContent');
            const toggleIcon = document.getElementById('walletToggleIcon');
            
            if (!walletContent || !toggleIcon) {
                console.error('Wallet elements not found:', { walletContent, toggleIcon });
                return;
            }
            
            console.log('Current display:', walletContent.style.display);
            
            if (walletContent.style.display === 'none' || walletContent.style.display === '') {
                walletContent.style.display = 'block';
                toggleIcon.className = 'fas fa-chevron-up';
                console.log('Expanded wallet status');
            } else {
                walletContent.style.display = 'none';
                toggleIcon.className = 'fas fa-chevron-down';
                console.log('Collapsed wallet status');
            }
        }
        
        // Toggle contract section
        function toggleContract() {
            console.log('Toggle contract called');
            const contractContent = document.getElementById('contractContent');
            const toggleIcon = document.getElementById('contractToggleIcon');
            
            if (!contractContent || !toggleIcon) {
                console.error('Contract elements not found:', { contractContent, toggleIcon });
                return;
            }
            
            if (contractContent.style.display === 'none' || contractContent.style.display === '') {
                contractContent.style.display = 'block';
                toggleIcon.className = 'fas fa-chevron-up';
            } else {
                contractContent.style.display = 'none';
                toggleIcon.className = 'fas fa-chevron-down';
            }
        }
        
        // Get current network based on chain type
        function getCurrentNetwork() {
            // For TRON, we're using Nile testnet by default
            // You could add logic here to detect mainnet vs testnet
            return 'nile';
        }
        
        // Create address display with copy and TronScan link
        function createAddressDisplay(address, showFull = false) {
            if (!address || address === 'N/A') return 'N/A';
            
            const displayAddress = showFull ? address : formatAddress(address);
            const network = currentChainType === 'tron' ? getCurrentNetwork() : 'mainnet';
            const explorerUrl = CHAIN_CONFIG[currentChainType][network].explorerUrl;
            
            return `
                <span class="address-display">
                    <span class="address-text">${displayAddress}</span>
                    <button class="btn-icon-small" onclick="copyAddress('${address}')" title="Copy address">
                        <i class="fas fa-copy"></i>
                    </button>
                    <a href="${explorerUrl}/#/address/${address}" target="_blank" class="btn-icon-small" title="View on explorer">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </span>
            `;
        }
        
        // Copy address to clipboard
        function copyAddress(address) {
            navigator.clipboard.writeText(address).then(() => {
                uiManager.showNotification('success', 'Address copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                uiManager.showNotification('error', 'Failed to copy address');
            });
        }

        function getDocumentTypeString(docType) {
            const documentTypes = [
                'Summons',
                'Complaint',
                'Subpoena',
                'Notice of Hearing',
                'Notice of Seizure',
                'Other'
            ];
            return documentTypes[docType] || 'Unknown';
        }

        function getJurisdictionString(jurisdictionIndex) {
            const jurisdictions = [
                'Federal',
                'State',
                'County',
                'Municipal',
                'Other'
            ];
            return jurisdictions[jurisdictionIndex] || 'Unknown';
        }
        
        function getContractScanUrl() {
            const network = document.getElementById('networkName').textContent;
            let baseUrl = 'https://tronscan.org/#/contract/';
            
            if (network.includes('Nile')) {
                baseUrl = 'https://nile.tronscan.org/#/contract/';
            } else if (network.includes('Shasta')) {
                baseUrl = 'https://shasta.tronscan.org/#/contract/';
            }
            
            return baseUrl + (legalContract ? legalContract.address : '');
        }

        function getStatusString(status) {
            const statuses = [
                'Pending',
                'Served',
                'Accepted',
                'Expired',
                'Cancelled'
            ];
            return statuses[status] || 'Unknown';
        }

        function getTimeRemaining(timestamp) {
            const created = new Date(parseInt(timestamp) * 1000);
            const expires = new Date(created.getTime() + (7 * 24 * 60 * 60 * 1000)); // 7 days
            const now = new Date();
            
            if (now > expires) {
                return '<span style="color: var(--error);">Expired</span>';
            }
            
            const diff = expires - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            if (days > 0) {
                return `${days} day${days > 1 ? 's' : ''} ${hours} hour${hours > 1 ? 's' : ''}`;
            } else if (hours > 0) {
                return `${hours} hour${hours > 1 ? 's' : ''}`;
            } else {
                return '<span style="color: var(--warning);">Less than 1 hour</span>';
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function calculateBase64Size(base64String) {
            // Calculate approximate size of base64 string
            const padding = (base64String.charAt(base64String.length - 2) === '=') ? 2 :
                           (base64String.charAt(base64String.length - 1) === '=') ? 1 : 0;
            return (base64String.length * 3) / 4 - padding;
        }

        function getErrorMessage(error) {
            if (error.message) {
                if (error.message.includes('revert')) {
                    const revertReason = error.message.split('revert')[1].trim();
                    return 'Transaction reverted: ' + revertReason;
                } else if (error.message.includes('User rejected')) {
                    return 'Transaction cancelled by user';
                } else if (error.message.includes('insufficient')) {
                    return 'Insufficient balance or energy';
                } else if (error.message.includes('Not authorized')) {
                    return 'You need Process Server role to perform this action';
                } else {
                    return error.message;
                }
            }
            return 'An unknown error occurred';
        }

        // Copy wallet address function
        function copyWalletAddress() {
            const address = tronWeb.defaultAddress.base58;
            navigator.clipboard.writeText(address).then(() => {
                uiManager.showNotification('success', 'Address copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                uiManager.showNotification('error', 'Failed to copy address');
            });
        }

        // Validation functions
        function validateRecipientAddress() {
            const input = document.getElementById('mintRecipient');
            const validationMsg = document.getElementById('recipientValidation');
            const address = input.value.trim();
            
            if (!address) {
                input.classList.remove('valid', 'invalid');
                validationMsg.style.display = 'none';
                return;
            }
            
            if (tronWeb.isAddress(address)) {
                input.classList.remove('invalid');
                input.classList.add('valid');
                validationMsg.className = 'validation-message success';
                validationMsg.innerHTML = '<i class="fas fa-check-circle"></i> Valid TRON address';
                validationMsg.style.display = 'flex';
            } else {
                input.classList.remove('valid');
                input.classList.add('invalid');
                validationMsg.className = 'validation-message error';
                validationMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Invalid TRON address';
                validationMsg.style.display = 'flex';
            }
        }

        // Update admin tab visibility based on admin status
        function updateAdminTabVisibility() {
            const adminTabButton = document.getElementById('adminTabButton');
            if (adminTabButton) {
                adminTabButton.style.display = isAdmin ? 'inline-flex' : 'none';
            }
        }

        // Debug function to check roles and registrations
        async function debugCheckRoles() {
            const debugDiv = document.getElementById('debugOutput');
            const debugContent = document.getElementById('debugContent');
            
            if (!legalContract || !tronWeb || !tronWeb.defaultAddress) {
                debugContent.innerHTML = '<span style="color: var(--error);">Contract not connected or wallet not connected</span>';
                debugDiv.style.display = 'block';
                return;
            }
            
            debugContent.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking roles and registrations...';
            debugDiv.style.display = 'block';
            
            try {
                const address = tronWeb.defaultAddress.base58;
                let debugInfo = '<div style="font-family: monospace; font-size: 0.8rem;">';
                let plainTextDebug = ''; // For copying
                
                debugInfo += `<strong>Your Address:</strong> ${address}<br><br>`;
                plainTextDebug += `Your Address: ${address}\n\n`;
                
                // Check roles - including DEFAULT_ADMIN_ROLE
                const DEFAULT_ADMIN_ROLE = '0x0000000000000000000000000000000000000000000000000000000000000000';
                const adminRoleBytes = tronWeb.sha3('ADMIN_ROLE');
                const processServerRoleBytes = tronWeb.sha3('PROCESS_SERVER_ROLE');
                
                console.log('=== ADMIN ROLE DEBUG ===');
                console.log('DEFAULT_ADMIN_ROLE:', DEFAULT_ADMIN_ROLE);
                console.log('ADMIN_ROLE hash:', adminRoleBytes);
                console.log('Current address:', address);
                
                const hasDefaultAdminRole = await legalContract.hasRole(DEFAULT_ADMIN_ROLE, address).call();
                const hasAdminRole = await legalContract.hasRole(adminRoleBytes, address).call();
                const hasProcessServerRole = await legalContract.hasRole(processServerRoleBytes, address).call();
                
                console.log('Has DEFAULT_ADMIN_ROLE:', hasDefaultAdminRole);
                console.log('Has ADMIN_ROLE:', hasAdminRole);
                
                // Get role member counts
                const defaultAdminCount = await legalContract.getRoleMemberCount(DEFAULT_ADMIN_ROLE).call();
                const adminCount = await legalContract.getRoleMemberCount(adminRoleBytes).call();
                
                console.log('DEFAULT_ADMIN_ROLE member count:', defaultAdminCount.toString());
                console.log('ADMIN_ROLE member count:', adminCount.toString());
                
                // Get first member of each admin role
                if (defaultAdminCount > 0) {
                    const firstDefaultAdmin = await legalContract.getRoleMember(DEFAULT_ADMIN_ROLE, 0).call();
                    console.log('First DEFAULT_ADMIN_ROLE member:', firstDefaultAdmin);
                }
                
                if (adminCount > 0) {
                    const firstAdmin = await legalContract.getRoleMember(adminRoleBytes, 0).call();
                    console.log('First ADMIN_ROLE member:', firstAdmin);
                }
                
                debugInfo += `<strong>Roles:</strong><br>`;
                debugInfo += `- Admin Role: ${hasAdminRole ? ' YES' : ' NO'}<br>`;
                debugInfo += `- Process Server Role: ${hasProcessServerRole ? ' YES' : ' NO'}<br><br>`;
                
                plainTextDebug += `Roles:\n`;
                plainTextDebug += `- Admin Role: ${hasAdminRole ? 'YES' : 'NO'}\n`;
                plainTextDebug += `- Process Server Role: ${hasProcessServerRole ? 'YES' : 'NO'}\n\n`;
                
                // Check fee exemptions
                const isLawEnforcement = await legalContract.lawEnforcementExemptions(address).call();
                const serviceFeeExempt = isLawEnforcement;
                const fullFeeExempt = isLawEnforcement;
                
                debugInfo += `<strong>Fee Exemptions:</strong><br>`;
                debugInfo += `- Service Fee Exempt: ${serviceFeeExempt ? ' YES' : ' NO'}<br>`;
                debugInfo += `- Full Fee Exempt: ${fullFeeExempt ? ' YES' : ' NO'}<br><br>`;
                
                plainTextDebug += `Fee Exemptions:\n`;
                plainTextDebug += `- Service Fee Exempt: ${serviceFeeExempt ? 'YES' : 'NO'}\n`;
                plainTextDebug += `- Full Fee Exempt: ${fullFeeExempt ? 'YES' : 'NO'}\n\n`;
                
                // Calculate actual fee
                const calculatedFee = await calculateFeeFromConstants(address);
                debugInfo += `<strong>Your Fee:</strong> ${tronWeb.fromSun(calculatedFee)} TRX<br><br>`;
                plainTextDebug += `Your Fee: ${tronWeb.fromSun(calculatedFee)} TRX\n\n`;
                
                // Check localStorage registrations
                const localRegs = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
                const yourReg = localRegs[address];
                
                debugInfo += `<strong>Local Registration:</strong><br>`;
                plainTextDebug += `Local Registration:\n`;
                
                if (yourReg) {
                    debugInfo += `- Status: ${yourReg.status}<br>`;
                    debugInfo += `- Server ID: ${yourReg.serverId || 'Not assigned'}<br>`;
                    debugInfo += `- Agency: ${yourReg.agencyName || yourReg.agency}<br>`;
                    
                    plainTextDebug += `- Status: ${yourReg.status}\n`;
                    plainTextDebug += `- Server ID: ${yourReg.serverId || 'Not assigned'}\n`;
                    plainTextDebug += `- Agency: ${yourReg.agencyName || yourReg.agency}\n`;
                } else {
                    debugInfo += `- No registration found for ${address}<br>`;
                    debugInfo += `- All keys in localStorage: ${Object.keys(localRegs).join(', ') || 'None'}<br>`;
                    
                    plainTextDebug += `- No registration found for ${address}\n`;
                    plainTextDebug += `- All keys in localStorage: ${Object.keys(localRegs).join(', ') || 'None'}\n`;
                }
                
                debugInfo += '</div>';
                
                debugContent.innerHTML = debugInfo;
                
                // Store plain text for copying
                window.debugInfoPlainText = plainTextDebug;
                
                // Check if we need to show the fix button
                const fixBtn = document.getElementById('fixExemptionBtn');
                if ((hasProcessServerRole && !serviceFeeExempt && !fullFeeExempt && yourReg && yourReg.status === 'approved') || 
                    (hasAdminRole && !fullFeeExempt)) {
                    // User has role but no exemptions - show fix button
                    fixBtn.style.display = 'inline-flex';
                    if (hasAdminRole && !fullFeeExempt) {
                        debugInfo += '<br><div style="color: var(--warning); font-weight: bold;"> Admin accounts should have full fee exemption! Click "Fix Exemption" to apply it.</div>';
                    } else {
                        debugInfo += '<br><div style="color: var(--warning); font-weight: bold;"> Fee exemptions not applied! Click "Fix Exemption" to apply them.</div>';
                    }
                    debugContent.innerHTML = debugInfo + '</div>';
                } else {
                    fixBtn.style.display = 'none';
                }
                
                // Also refresh the main wallet status
                await updateWalletStatus();
                
            } catch (error) {
                console.error('Debug check error:', error);
                debugContent.innerHTML = `<span style="color: var(--error);">Error: ${error.message}</span>`;
                window.debugInfoPlainText = `Error: ${error.message}`;
            }
        }
        
        // Copy debug info to clipboard
        function copyDebugInfo() {
            if (window.debugInfoPlainText) {
                navigator.clipboard.writeText(window.debugInfoPlainText).then(() => {
                    uiManager.showNotification('success', 'Debug info copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    uiManager.showNotification('error', 'Failed to copy to clipboard');
                });
            }
        }
        
        // Fix fee exemption for approved process servers
        async function fixMyFeeExemption() {
            if (!legalContract || !tronWeb || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet and contract first');
                return;
            }
            
            const fixBtn = document.getElementById('fixExemptionBtn');
            fixBtn.disabled = true;
            fixBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fixing...';
            
            try {
                const address = tronWeb.defaultAddress.base58;
                
                // Check if user has admin role
                const adminRoleBytes = tronWeb.sha3('ADMIN_ROLE');
                const isAdmin = await legalContract.hasRole(adminRoleBytes, address).call();
                
                if (!isAdmin) {
                    uiManager.showNotification('error', 'You need admin role to fix exemptions. Contact an admin.');
                    return;
                }
                
                // Check if user is admin (reuse the check from above)
                const hasAdminRole = isAdmin;
                
                // Get registration info (not required for admins)
                const localRegs = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
                const yourReg = localRegs[address];
                
                if (!hasAdminRole && !yourReg) {
                    uiManager.showNotification('error', 'No registration found for your address');
                    return;
                }
                
                // Determine exemption type based on role and registration
                let serviceFeeExempt = false;
                let fullFeeExempt = false;
                
                if (hasAdminRole) {
                    // Admins always get full fee exemption
                    serviceFeeExempt = true;
                    fullFeeExempt = true;
                    uiManager.showNotification('info', 'Applying full fee exemption for admin...');
                } else if (yourReg) {
                    // Process servers get exemptions based on registration
                    serviceFeeExempt = yourReg.serviceFeeExempt !== false;
                    fullFeeExempt = yourReg.fullFeeExempt === true;
                    uiManager.showNotification('info', 'Applying fee exemptions...');
                } else {
                    uiManager.showNotification('error', 'No registration found and not an admin');
                    return;
                }
                
                // Apply the fee exemptions
                await legalContract.setFeeExemption(address, serviceFeeExempt, fullFeeExempt).send({
                    feeLimit: 20_000_000,
                    shouldPollResponse: true
                });
                
                uiManager.showNotification('success', 'Fee exemptions applied successfully!');
                
                // Refresh debug info
                await debugCheckRoles();
                
            } catch (error) {
                console.error('Fix exemption error:', error);
                uiManager.showNotification('error', 'Failed to apply exemptions: ' + error.message);
            } finally {
                fixBtn.disabled = false;
                fixBtn.innerHTML = '<i class="fas fa-wrench"></i> Fix Exemption';
            }
        }

        // Check contract resources (energy and bandwidth)
        async function checkContractResources() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            const statusDiv = document.getElementById('contractResourceStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking contract resources...';
            
            try {
                const contractAddress = legalContract.address;
                const account = await tronWeb.trx.getAccount(contractAddress);
                const resources = await tronWeb.trx.getAccountResources(contractAddress);
                
                // Calculate energy details
                const totalEnergy = resources.EnergyLimit || 0;
                const usedEnergy = resources.EnergyUsed || 0;
                const availableEnergy = totalEnergy - usedEnergy;
                const energyPerNotice = 500000;  // Updated to match actual usage
                const noticesAvailable = Math.floor(availableEnergy / energyPerNotice);
                
                // Calculate TRX staked for energy
                const frozenForEnergy = account.account_resource?.frozen_balance_for_energy?.frozen_balance || 0;
                const stakedTRX = tronWeb.fromSun(frozenForEnergy);
                
                // Get delegated energy info
                const delegatedEnergy = resources.EnergyLimit - (resources.EnergyUsed || 0);
                
                let html = `
                    <h4>Contract Resources</h4>
                    <div style="margin-top: 0.5rem;">
                        <strong>Contract Address:</strong> ${contractAddress}
                    </div>
                    <div style="margin-top: 1rem;">
                        <strong>Energy Status:</strong>
                        <div style="margin-left: 1rem; margin-top: 0.5rem;">
                            - Total Energy: ${totalEnergy.toLocaleString()}<br>
                            - Used Energy: ${usedEnergy.toLocaleString()}<br>
                            - Available Energy: ${availableEnergy.toLocaleString()}<br>
                            - Notices Available: ${noticesAvailable} (at ~500k energy each)<br>
                            - TRX Staked for Energy: ${stakedTRX} TRX
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <strong>Recommendations:</strong>
                        <div style="margin-left: 1rem; margin-top: 0.5rem;">
                `;
                
                if (noticesAvailable < 10) {
                    html += `<div style="color: var(--warning);"> Low energy! Consider delegating more energy to support user transactions.</div>`;
                } else {
                    html += `<div style="color: var(--success);"> Sufficient energy for ${noticesAvailable} notices</div>`;
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                statusDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error checking resources:', error);
                statusDiv.innerHTML = '<div style="color: var(--error);">Error checking resources: ' + error.message + '</div>';
            }
        }
        
        // Show delegate energy modal
        function showDelegateEnergyModal() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            // For now, show instructions
            const modal = confirm(
                'Energy Delegation Instructions:\n\n' +
                '1. Visit tronscan.org\n' +
                '2. Connect your wallet\n' +
                '3. Go to "Stake 2.0" section\n' +
                '4. Select "Delegate Resource"\n' +
                '5. Enter contract address: ' + legalContract.address + '\n' +
                '6. Choose "Energy" resource type\n' +
                '7. Enter amount to delegate (10,000 TRX = ~250k energy/day)\n\n' +
                'Would you like to copy the contract address?'
            );
            
            if (modal) {
                navigator.clipboard.writeText(legalContract.address).then(() => {
                    uiManager.showNotification('success', 'Contract address copied to clipboard!');
                });
            }
        }
        
        // Energy rental configuration
        const ENERGY_RENTAL_CONFIG = {
            // TRONSave API for energy rental
            apiUrl: 'https://api.tronsave.io/v0/order/energy',
            // Energy required per notice (increased based on actual usage)
            energyPerNotice: 500000,  // Increased from 250k to 500k
            // Buffer to ensure enough energy (20% extra)
            energyBuffer: 1.2,
            // Maximum rental price in TRX per 100k energy
            maxPricePerUnit: 15,
            // Rental duration in hours
            rentalDuration: 1,
            // Minimum energy to trigger rental
            minEnergyThreshold: 50000
        };
        
        // Check if energy rental is needed
        async function checkEnergyNeeded(requiredEnergy) {
            try {
                const resources = await tronWeb.trx.getAccountResources(tronWeb.defaultAddress.base58);
                const availableEnergy = (resources.EnergyLimit || 0) - (resources.EnergyUsed || 0);
                
                console.log('Energy check:', {
                    required: requiredEnergy,
                    available: availableEnergy,
                    needsRental: availableEnergy < requiredEnergy
                });
                
                if (availableEnergy < requiredEnergy) {
                    return requiredEnergy - availableEnergy;
                }
                return 0;
            } catch (error) {
                console.error('Error checking energy:', error);
                // If check fails, assume we need full amount
                return requiredEnergy;
            }
        }
        
        // Estimate energy rental cost
        async function estimateEnergyRentalCost(energyAmount) {
            try {
                // TRONSave pricing: typically 10-15 TRX per 100k energy
                // We'll use a conservative estimate
                const unitsNeeded = Math.ceil(energyAmount / 100000);
                const pricePerUnit = 12; // TRX per 100k energy
                const rentalCost = unitsNeeded * pricePerUnit;
                
                console.log('Energy rental estimate:', {
                    energyAmount,
                    unitsNeeded,
                    pricePerUnit,
                    totalCost: rentalCost
                });
                
                return rentalCost;
            } catch (error) {
                console.error('Error estimating rental cost:', error);
                // Return conservative estimate
                return Math.ceil(energyAmount / 100000) * 15;
            }
        }
        
        // JustLend Energy Rental Service Configuration
        const JUSTLEND_CONFIG = {
            mainnet: {
                contract: 'TJSMvYJPASTsQFnDr9tw5s3YD9GQQmJcFg', // JustLend Energy Market
                api: 'https://api.justlend.org/v1/energy'
            },
            testnet: {
                // Testnet doesn't have JustLend, use manual approach
                useManual: true
            }
        };

        // Rent energy automatically
        async function rentEnergyIfNeeded(requiredEnergy) {
            try {
                const energyNeeded = await checkEnergyNeeded(requiredEnergy);
                
                if (energyNeeded <= ENERGY_RENTAL_CONFIG.minEnergyThreshold) {
                    console.log('Sufficient energy available, no rental needed');
                    return { success: true, rented: false, cost: 0 };
                }
                
                // Add buffer to energy needed
                const energyToRent = Math.ceil(energyNeeded * ENERGY_RENTAL_CONFIG.energyBuffer);
                
                console.log('Renting energy:', {
                    needed: energyNeeded,
                    renting: energyToRent,
                    network: currentNetwork
                });
                
                // Estimate rental cost
                const rentalCost = await estimateEnergyRentalCost(energyToRent);
                
                // For testnet, show warning and proceed
                if (currentNetwork === 'testnet' || currentNetwork === 'nile') {
                    const userConfirmed = confirm(
                        ` Energy Required\n\n` +
                        `This transaction requires ${energyToRent.toLocaleString()} energy.\n` +
                        `Estimated cost: ~${rentalCost} TRX\n\n` +
                        `On testnet, energy will be burned from your TRX balance.\n` +
                        `On mainnet, we'll automatically rent energy for you.\n\n` +
                        `Continue?`
                    );
                    
                    if (!userConfirmed) {
                        return { 
                            success: false, 
                            error: 'User cancelled due to energy requirement' 
                        };
                    }
                    
                    return {
                        success: true,
                        rented: false,
                        amount: energyToRent,
                        cost: rentalCost,
                        warning: 'Testnet: Energy will be burned from TRX balance'
                    };
                }
                
                // For mainnet, attempt to rent energy via JustLend
                try {
                    // Show rental notification
                    uiManager.showNotification('info', `Renting ${energyToRent.toLocaleString()} energy for ~${rentalCost} TRX...`);
                    
                    // Rent energy via JustLend smart contract
                    const rentalResult = await rentEnergyViaJustLend(energyToRent, rentalCost);
                    
                    if (rentalResult.success) {
                        uiManager.showNotification('success', `Energy rented successfully! Transaction: ${rentalResult.txId}`);
                        return {
                            success: true,
                            rented: true,
                            amount: energyToRent,
                            cost: rentalResult.actualCost,
                            txId: rentalResult.txId
                        };
                    }
                    
                    // If JustLend fails, fall back to manual approach
                    throw new Error(rentalResult.error || 'JustLend rental failed');
                    
                } catch (rentalError) {
                    console.error('Automated energy rental failed:', rentalError);
                    
                    // Show manual options
                    const manualChoice = await showEnergyOptions(energyToRent, rentalCost);
                    
                    if (manualChoice === 'proceed') {
                        // User chose to proceed and burn TRX
                        return {
                            success: true,
                            rented: false,
                            amount: energyToRent,
                            cost: rentalCost,
                            warning: 'Energy will be burned from TRX balance'
                        };
                    } else if (manualChoice === 'stake') {
                        // Open staking guide
                        window.open('https://tronscan.org/#/sr/representatives', '_blank');
                        return {
                            success: false,
                            error: 'Please stake TRX for energy and try again'
                        };
                    } else {
                        // User cancelled
                        return {
                            success: false,
                            error: 'Energy rental cancelled by user'
                        };
                    }
                }
                
            } catch (error) {
                console.error('Energy rental error:', error);
                
                // If we can't check energy, show warning but allow to proceed
                const proceed = confirm(
                    ' Unable to check energy requirements\n\n' +
                    'The transaction may fail if you don\'t have enough energy.\n' +
                    'Continue anyway?'
                );
                
                return { 
                    success: proceed, 
                    rented: false, 
                    cost: 0,
                    error: proceed ? null : 'User cancelled due to energy check failure'
                };
            }
        }
        
        // Rent energy via JustLend contract
        async function rentEnergyViaJustLend(energyAmount, maxPrice) {
            try {
                const justLendAddress = JUSTLEND_CONFIG.mainnet.contract;
                
                // Build the transaction
                const parameter = [
                    { type: 'uint256', value: energyAmount },
                    { type: 'address', value: tronWeb.defaultAddress.base58 },
                    { type: 'uint256', value: 3600 } // 1 hour rental
                ];
                
                const transaction = await tronWeb.transactionBuilder.triggerSmartContract(
                    justLendAddress,
                    'rentEnergy(uint256,address,uint256)',
                    {
                        callValue: tronWeb.toSun(maxPrice),
                        feeLimit: 10e6 // 10 TRX fee limit
                    },
                    parameter,
                    tronWeb.defaultAddress.base58
                );
                
                const signedTx = await tronWeb.trx.sign(transaction.transaction);
                const result = await tronWeb.trx.sendRawTransaction(signedTx);
                
                if (result.result) {
                    return {
                        success: true,
                        txId: result.txid,
                        actualCost: maxPrice
                    };
                }
                
                return {
                    success: false,
                    error: 'Transaction failed'
                };
                
            } catch (error) {
                console.error('JustLend rental error:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Show energy rental options to user
        async function showEnergyOptions(energyNeeded, estimatedCost) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2><i class="fas fa-bolt" style="color: #f59e0b;"></i> Energy Required</h2>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning" style="background: #fef3c7; border-color: #f59e0b;">
                                <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                                <strong>Insufficient Energy</strong>
                                <p style="margin: 0.5rem 0 0 0;">This transaction requires ${energyNeeded.toLocaleString()} energy.</p>
                            </div>
                            
                            <div class="energy-options" style="margin-top: 1.5rem;">
                                <h4>Choose how to proceed:</h4>
                                
                                <div class="option-card" style="margin: 1rem 0; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer;" 
                                     onclick="document.getElementById('energyChoice').value='proceed'; document.querySelector('.energy-continue-btn').click();">
                                    <h5><i class="fas fa-fire"></i> Burn TRX for Energy</h5>
                                    <p style="margin: 0.5rem 0 0 0; color: #6b7280;">Proceed with transaction and burn ~${estimatedCost} TRX for energy</p>
                                    <div class="cost-indicator" style="margin-top: 0.5rem; color: #ef4444;">
                                        <i class="fas fa-coins"></i> Cost: ~${estimatedCost} TRX
                                    </div>
                                </div>
                                
                                <div class="option-card" style="margin: 1rem 0; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer;"
                                     onclick="document.getElementById('energyChoice').value='stake'; document.querySelector('.energy-continue-btn').click();">
                                    <h5><i class="fas fa-lock"></i> Stake TRX for Energy</h5>
                                    <p style="margin: 0.5rem 0 0 0; color: #6b7280;">Stake TRX to get permanent energy (recommended for frequent users)</p>
                                    <div class="cost-indicator" style="margin-top: 0.5rem; color: #10b981;">
                                        <i class="fas fa-info-circle"></i> One-time stake, permanent energy
                                    </div>
                                </div>
                                
                                <div class="option-card" style="margin: 1rem 0; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer;"
                                     onclick="document.getElementById('energyChoice').value='cancel'; document.querySelector('.energy-continue-btn').click();">
                                    <h5><i class="fas fa-times"></i> Cancel Transaction</h5>
                                    <p style="margin: 0.5rem 0 0 0; color: #6b7280;">Cancel and return to form</p>
                                </div>
                            </div>
                            
                            <input type="hidden" id="energyChoice" value="">
                        </div>
                        <div class="modal-footer" style="display: none;">
                            <button class="btn btn-primary energy-continue-btn" onclick="
                                const choice = document.getElementById('energyChoice').value;
                                this.closest('.modal').remove();
                                window.energyModalResolve(choice);
                            ">
                                Continue
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Store resolve function globally for the onclick handlers
                window.energyModalResolve = resolve;
                
                // Clean up when modal is closed
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve('cancel');
                        delete window.energyModalResolve;
                    }
                });
            });
        }

        // Handle modal backdrop clicks
        function handleModalBackdropClick(event, modalId) {
            // Only close if clicking on the backdrop itself, not the content
            if (event.target.id === modalId) {
                if (modalId === 'mintModal') {
                    closeMintModal();
                } else if (modalId === 'registrationModal') {
                    closeRegistrationModal();
                } else {
                    // For other modals, just close them
                    document.getElementById(modalId).style.display = 'none';
                }
            }
        }
        
        // Set up modal protection to prevent accidental closes
        function setupModalProtection() {
            // Remove any inline onclick handlers and use event listeners
            const mintModal = document.getElementById('mintModal');
            const registrationModal = document.getElementById('registrationModal');
            
            if (mintModal) {
                // Remove inline onclick
                mintModal.onclick = null;
                
                // Add proper event listener
                mintModal.addEventListener('click', function(event) {
                    // Only trigger if clicking the modal backdrop itself
                    if (event.target === mintModal) {
                        event.preventDefault();
                        event.stopPropagation();
                        closeMintModal();
                    }
                });
            }
            
            if (registrationModal) {
                // Remove inline onclick
                registrationModal.onclick = null;
                
                // Add proper event listener
                registrationModal.addEventListener('click', function(event) {
                    // Only trigger if clicking the modal backdrop itself
                    if (event.target === registrationModal) {
                        event.preventDefault();
                        event.stopPropagation();
                        closeRegistrationModal();
                    }
                });
            }
            
            // Prevent all modal content from closing the modal
            document.querySelectorAll('.modal-content').forEach(content => {
                content.addEventListener('click', function(event) {
                    event.stopPropagation();
                });
            });
        }
        
        // Initialize when document is loaded
        
        // Ensure modals close properly
        document.addEventListener('click', function(event) {
            // Close modals when clicking outside
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
            
            // Close dropdowns when clicking outside
            if (!event.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });
        
        // Fix ESC key to close modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });

        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user came from a direct notice link
            checkDirectNoticeLink();
            
            // Check if new user needs onboarding
            checkNewUserOnboarding();
            // Hide loader
            setTimeout(() => {
                uiManager.hideLoader();
            }, 500);
            
            // Set up modal protection
            setupModalProtection();
            
            // Set up upload area click handler - delay to ensure modal is ready
            setTimeout(() => {
                const uploadArea = document.getElementById('uploadArea');
                if (uploadArea) {
                    console.log('Setting up upload area click handler');
                    
                    // Find the file input within the upload area
                    const fileInput = uploadArea.querySelector('input[type="file"]');
                    console.log('File input found in upload area:', fileInput);
                    
                    // Add click listener to upload area
                    uploadArea.addEventListener('click', function(e) {
                        console.log('Upload area clicked', e.target);
                        
                        // Don't trigger if clicking the file input itself or the button
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') {
                            return;
                        }
                        
                        // Find the file input within this upload area
                        const fileInputInside = this.querySelector('input[type="file"]');
                        console.log('File input element inside clicked area:', fileInputInside);
                        
                        if (fileInputInside) {
                            // Force click on file input
                            try {
                                fileInputInside.click();
                                console.log('File input clicked successfully');
                            } catch (error) {
                                console.error('Error clicking file input:', error);
                            }
                        } else {
                            console.error('File input not found inside upload area!');
                        }
                    });
                    
                    // Also ensure the file input has the change handler
                    if (fileInput) {
                        console.log('Adding change listener to file input');
                        fileInput.addEventListener('change', handleDocumentUpload);
                    }
                } else {
                    console.log('Upload area not found on page load');
                }
            }, 1000);
            
            
        // Auto-save form data
        function saveFormData() {
            const formData = {
                recipientAddress: document.getElementById('mintRecipient')?.value || '',
                caseNumber: document.getElementById('mintCaseNumber')?.value || '',
                noticeType: document.getElementById('noticeType')?.value || '',
                issuingAgency: document.getElementById('agencyName')?.value || '',
                noticeText: document.getElementById('noticeText')?.value || '',
                tokenName: document.getElementById('mintTokenName')?.value || ''
            };
            localStorage.setItem('noticeFormDraft', JSON.stringify(formData));
        }
        
        // Restore form data
        function restoreFormData() {
            const savedData = localStorage.getItem('noticeFormDraft');
            if (savedData) {
                try {
                    const formData = JSON.parse(savedData);
                    // Map saved keys to actual element IDs
                    const idMap = {
                        recipientAddress: 'mintRecipient',
                        caseNumber: 'mintCaseNumber',
                        noticeType: 'noticeType',
                        issuingAgency: 'agencyName',
                        noticeText: 'noticeText',
                        tokenName: 'mintTokenName'
                    };
                    
                    Object.keys(formData).forEach(key => {
                        const elementId = idMap[key] || key;
                        const element = document.getElementById(elementId);
                        if (element && formData[key]) {
                            element.value = formData[key];
                        }
                    });
                } catch (e) {
                    console.error('Error restoring form data:', e);
                }
            }
        }
        
        // Set up auto-save
        ['mintRecipient', 'mintCaseNumber', 'noticeType', 'agencyName', 'noticeText', 'mintTokenName'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', saveFormData);
            }
        });

        // Initialize tooltips
            initializeTooltips();
            
            // Initialize notifications
            if (legalContract) {
                notificationSystem.init();
                requestNotificationPermission();
            }
            restoreFormData();
            
            // Initialize data from localStorage
            refreshPendingRegistrations();
            updateStatsFromLocalStorage();
            
            // Initialize admin tab visibility
            updateAdminTabVisibility();
            
            // Add click event listener to stats header
            const statsHeader = document.getElementById('statsHeader');
            if (statsHeader) {
                statsHeader.addEventListener('click', toggleStats);
            }
            
            // Add click event listener to wallet status header
            const walletStatusHeader = document.getElementById('walletStatusHeader');
            if (walletStatusHeader) {
                walletStatusHeader.addEventListener('click', toggleWalletStatus);
            }
            
            // Add click event listener to contract header
            const contractHeader = document.getElementById('contractHeader');
            if (contractHeader) {
                contractHeader.addEventListener('click', toggleContract);
            }
            
            // Check if TronWeb is available
            if (window.tronWeb && window.tronWeb.ready) {
                try {
                    await connectWallet();
                } catch (error) {
                    console.error('Error auto-connecting wallet:', error);
                }
            }
            
            // Load saved Pinata keys if in admin panel
            const savedApiKey = localStorage.getItem('pinataApiKey');
            const savedSecretKey = localStorage.getItem('pinataSecretKey');
            if (savedApiKey && document.getElementById('pinataApiKey')) {
                document.getElementById('pinataApiKey').value = savedApiKey;
            }
            if (savedSecretKey && document.getElementById('pinataSecretKey')) {
                document.getElementById('pinataSecretKey').value = savedSecretKey;
            }
            
          // Add input validation
const recipientInput = document.getElementById('mintRecipient');
if (recipientInput) {
    recipientInput.addEventListener('input', validateRecipientAddress);
}

// Setup delivery method selection
const deliveryOptions = document.querySelectorAll('input[name="deliveryMethod"]');
const textNoticeGroup = document.getElementById('textNoticeGroup');
const noticeTextInput = document.getElementById('noticeText');
const charCountSpan = document.getElementById('charCount');

deliveryOptions.forEach(option => {
    option.addEventListener('change', function() {
        // Update selected class
        document.querySelectorAll('.delivery-option').forEach(label => {
            label.classList.remove('selected');
        });
        this.closest('.delivery-option').classList.add('selected');
        
        // Show/hide form sections based on selection
        const viewGatedDetails = document.getElementById('viewGatedDetails');
        const noticeTextLabel = document.getElementById('noticeTextLabel');
        const noticeTextHelp = document.getElementById('noticeTextHelp');
        
        if (this.value === 'document') {
            viewGatedDetails.style.display = 'block';
            textNoticeGroup.style.display = 'block';
            textNoticeGroup.classList.add('active');
            noticeTextLabel.innerHTML = '<i class="fas fa-globe" style="color: #f59e0b;"></i> Public Notice Text';
            noticeTextHelp.innerHTML = '<i class="fas fa-exclamation-circle"></i> This text will be publicly visible on the blockchain';
        } else if (this.value === 'text') {
            viewGatedDetails.style.display = 'none';
            textNoticeGroup.style.display = 'block';
            textNoticeGroup.classList.add('active');
            noticeTextLabel.textContent = 'Notice Text';
            noticeTextHelp.textContent = 'This text will display directly in the recipient\'s wallet';
        } else {
            viewGatedDetails.style.display = 'none';
            textNoticeGroup.style.display = 'none';
            textNoticeGroup.classList.remove('active');
        }
        
        // Update fee estimate
        updateFeeEstimate();
        // Also update the detailed fee display if on step 2
        if (document.getElementById('mintStep2').style.display !== 'none') {
            updateFeeDisplay();
        }
    });
});

// Character counter for text notice
if (noticeTextInput && charCountSpan) {
    noticeTextInput.addEventListener('input', function() {
        const length = this.value.length;
        charCountSpan.textContent = length;
        
        const charCountDiv = this.nextElementSibling;
        if (length >= 90) {
            charCountDiv.classList.add('error');
            charCountDiv.classList.remove('warning');
        } else if (length >= 70) {
            charCountDiv.classList.add('warning');
            charCountDiv.classList.remove('error');
        } else {
            charCountDiv.classList.remove('warning', 'error');
        }
    });
}

// Function to update fee estimate based on delivery method
async function updateFeeEstimate() {
    const selectedMethod = document.querySelector('input[name="deliveryMethod"]:checked').value;
    const feeDisplay = document.querySelector('#creationFeeDisplay');
    const feeDescription = document.querySelector('#feeDescription');
    
    if (feeDisplay) {
        try {
            // Set base fee based on delivery method
            let baseFee = selectedMethod === 'document' ? 150 : 15;
            // Always add 2 TRX sponsorship
            let totalFee = baseFee + 2;
            
            let description = selectedMethod === 'document' 
                ? 'Document fee (150) + Sponsorship (2)' 
                : 'Text fee (15) + Sponsorship (2)';
            
            // Check if contract connection exists for exemption check
            if (legalContract && tronWeb.defaultAddress) {
                try {
                    const userAddress = tronWeb.defaultAddress.base58;
                    const isLawEnforcement = await legalContract.lawEnforcementExemptions(userAddress).call();
                    const agencyName = await legalContract.lawEnforcementAgencies(userAddress).call();
                    const serviceFeeExempt = isLawEnforcement;
                    const fullFeeExempt = isLawEnforcement;
                    
                    if (isLawEnforcement) {
                        totalFee = 2; // Only pay sponsorship fee
                        description = `Law Enforcement (${agencyName}) - Sponsorship only (2 TRX)`;
                    } else if (await checkIfProcessServer()) {
                        totalFee = 75 + 2; // Creation fee + sponsorship
                        description = 'Process Server: Creation fee (75) + Sponsorship (2)';
                    }
                } catch (err) {
                    console.log('Could not check fee exemptions');
                }
            }
            
            feeDisplay.textContent = totalFee + ' TRX';
            feeDescription.textContent = description;
            
        } catch (error) {
            console.error('Error calculating fee:', error);
            // Fallback to default fees
            const defaultFee = selectedMethod === 'document' ? '150 TRX' : '15 TRX';
            feeDisplay.textContent = defaultFee;
            feeDescription.textContent = selectedMethod === 'document' 
                ? 'Encrypted document with public text notice' 
                : 'Text only notice (no signature required)';
        }
    }
}

// Update notice template based on type selection
window.updateNoticeTemplate = function() {
    const noticeType = document.getElementById('noticeType').value;
    const customGroup = document.getElementById('customNoticeTypeGroup');
    const legalRights = document.getElementById('legalRights');
    
    // Show/hide custom notice type input
    if (noticeType === 'Custom') {
        customGroup.style.display = 'block';
    } else {
        customGroup.style.display = 'none';
    }
    
    // Update legal rights template based on notice type
    const rightsTemplates = {
        'Notice of Seizure': 'You have the right to contest this seizure',
        'Summons': 'You must respond within the time specified or judgment may be entered against you',
        'Subpoena': 'You are required to appear or produce documents as specified',
        'Restraining Order': 'Violation of this order may result in arrest and prosecution',
        'Eviction Notice': 'You have the right to contest this eviction in court',
        'Legal Hold': 'You must preserve all relevant documents and data',
        'Asset Freeze': 'You have the right to petition for release of frozen assets',
        'Custom': 'You have the right to respond to this legal notice'
    };
    
    if (rightsTemplates[noticeType]) {
        legalRights.value = rightsTemplates[noticeType];
    }
}

// Initialize admin panel inputs properly
setTimeout(() => {
    // Add role address validation
    const roleAddressInput = document.getElementById('roleAddress');
    if (roleAddressInput) {
        // Ensure input is interactive
        roleAddressInput.style.pointerEvents = 'auto';
        roleAddressInput.style.userSelect = 'text';
        roleAddressInput.disabled = false;
        roleAddressInput.readOnly = false;
        
        roleAddressInput.addEventListener('input', function(e) {
            const address = e.target.value.trim();
            if (address && tronWeb && !tronWeb.isAddress(address)) {
                e.target.classList.add('invalid');
                e.target.classList.remove('valid');
            } else if (address) {
                e.target.classList.add('valid');
                e.target.classList.remove('invalid');
            } else {
                e.target.classList.remove('valid', 'invalid');
            }
        });
    }

    // Add fee collector address validation
    const feeCollectorInput = document.getElementById('feeCollectorAddress');
    if (feeCollectorInput) {
        // Ensure input is interactive
        feeCollectorInput.style.pointerEvents = 'auto';
        feeCollectorInput.style.userSelect = 'text';
        feeCollectorInput.disabled = false;
        feeCollectorInput.readOnly = false;
        
        feeCollectorInput.addEventListener('input', function(e) {
            const address = e.target.value.trim();
            if (address && tronWeb && !tronWeb.isAddress(address)) {
                e.target.classList.add('invalid');
                e.target.classList.remove('valid');
            } else if (address) {
                e.target.classList.add('valid');
                e.target.classList.remove('invalid');
            } else {
                e.target.classList.remove('valid', 'invalid');
            }
        });
    }
    
    // Fix creation fee input
    const creationFeeInput = document.getElementById('creationFee');
    if (creationFeeInput) {
        creationFeeInput.style.pointerEvents = 'auto';
        creationFeeInput.style.userSelect = 'text';
        creationFeeInput.disabled = false;
        creationFeeInput.readOnly = false;
    }
    
    // Also ensure all form inputs in the admin panel are interactive
    const adminInputs = document.querySelectorAll('#adminTab .form-input');
    adminInputs.forEach(input => {
        input.style.pointerEvents = 'auto';
        input.style.userSelect = 'text';
        input.style.webkitUserSelect = 'text';
        input.disabled = false;
        input.readOnly = false;
    });
    
    console.log('Input fields initialized without replacement');
}, 100);
            
            // Add drag and drop support for file upload
            const uploadAreaForDragDrop = document.getElementById('uploadArea');
            if (uploadAreaForDragDrop) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadAreaForDragDrop.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    uploadAreaForDragDrop.addEventListener(eventName, () => {
                        uploadAreaForDragDrop.classList.add('drag-over');
                    }, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    uploadAreaForDragDrop.addEventListener(eventName, () => {
                        uploadAreaForDragDrop.classList.remove('drag-over');
                    }, false);
                });
                
                uploadAreaForDragDrop.addEventListener('drop', function(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    if (files.length > 0) {
                        document.getElementById('documentUpload').files = files;
                        handleDocumentUpload({ target: { files: files } });
                    }
                }, false);
            }
        });

       // Keyboard event handling for modals
document.addEventListener('keydown', function(event) {
    // Don't interfere with input fields
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
        return; // Let the input handle the event normally
    }
    
    if (event.key === 'Escape') {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            }
        });
    }
});

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // Make functions available globally
        window.connectWallet = connectWallet;
        window.switchTab = switchTab;
        window.openRegistrationModal = openRegistrationModal;
        window.closeRegistrationModal = closeRegistrationModal;
        window.closeRegistrationSuccessModal = closeRegistrationSuccessModal;
        window.dismissRegistrationNotice = dismissRegistrationNotice;
        window.submitRegistration = submitRegistration;
        window.refreshPendingRegistrations = refreshPendingRegistrations;
        window.approveRegistration = approveRegistration;
        window.openMintModal = openMintModal;
        window.closeMintModal = closeMintModal;
        window.showMintStep = showMintStep;
        window.showMintStep2 = showMintStep2;
        window.changeDocument = changeDocument;
        window.handleDocumentUpload = handleDocumentUpload;
        window.createLegalNotice = createLegalNotice;
        
        // Show mint step 2
        function showMintStep2() {
            document.getElementById('mintStep1').style.display = 'none';
            document.getElementById('mintStep2').style.display = 'block';
            
            // Update document preview if available
            if (uploadedImage && uploadedImage.data) {
                const preview = document.getElementById('documentPreview');
                if (preview) {
                    preview.src = uploadedImage.data;
                }
            }
        }
        
        // Change document (go back to step 1)
        function changeDocument() {
            document.getElementById('mintStep1').style.display = 'block';
            document.getElementById('mintStep2').style.display = 'none';
            document.getElementById('proceedToStep2').style.display = 'none';
            document.getElementById('compressionStatus').style.display = 'none';
            resetMintForm();
        }
        
        // Document upload handler with encryption
        async function handleDocumentUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const maxSize = 10 * 1024 * 1024; // 10MB limit
            if (file.size > maxSize) {
                uiManager.showNotification('error', 'File size exceeds 10MB limit');
                return;
            }
            
            try {
                // Show processing status
                document.getElementById('compressionStatus').style.display = 'block';
                updateCompressionProgress(10, 'Reading file...');
                
                // Read file as data URL
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        updateCompressionProgress(30, 'Processing document...');
                        
                        // Store unencrypted data temporarily (will be encrypted when sent)
                        uploadedImage = {
                            data: e.target.result,
                            fileName: file.name,
                            fileType: file.type,
                            fileSize: file.size
                        };
                        
                        updateCompressionProgress(70, 'Preparing for encryption...');
                        
                        // Show preview
                        const uploadResult = document.getElementById('uploadResult');
                        const uploadedFileName = document.getElementById('uploadedFileName');
                        const documentPreview = document.getElementById('documentPreview');
                        
                        if (uploadResult && uploadedFileName) {
                            uploadedFileName.textContent = file.name;
                            uploadResult.style.display = 'block';
                        }
                        
                        // Show preview based on file type
                        if (file.type.startsWith('image/') && documentPreview) {
                            documentPreview.src = e.target.result;
                            documentPreview.style.display = 'block';
                        }
                        
                        updateCompressionProgress(100, 'Document ready for encrypted delivery');
                        
                        // Show proceed button
                        document.getElementById('proceedToStep2').style.display = 'block';
                        
                        // Hide progress after delay
                        setTimeout(() => {
                            document.getElementById('compressionStatus').style.display = 'none';
                        }, 1500);
                        
                        uiManager.showNotification('success', 'Document uploaded and ready for encryption');
                        
                    } catch (error) {
                        console.error('Error processing document:', error);
                        uiManager.showNotification('error', 'Failed to process document');
                        document.getElementById('compressionStatus').style.display = 'none';
                    }
                };
                
                reader.onerror = function() {
                    uiManager.showNotification('error', 'Failed to read file');
                    document.getElementById('compressionStatus').style.display = 'none';
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('Error uploading document:', error);
                uiManager.showNotification('error', 'Failed to upload document');
                document.getElementById('compressionStatus').style.display = 'none';
            }
        }
        
        function updateCompressionProgress(percent, text) {
            const progressFill = document.getElementById('compressionProgress');
            const progressText = document.getElementById('compressionText');
            const compressionText = document.getElementById('compressionStatusText');
            
            if (progressFill) {
                progressFill.style.width = percent + '%';
            }
            if (progressText) {
                progressText.textContent = percent + '%';
            }
            if (compressionText) {
                compressionText.textContent = text;
            }
        }
        window.openAuditModal = openAuditModal;
        window.closeAuditModal = closeAuditModal;
        window.openAcceptModal = openAcceptModal;
        window.closeAcceptModal = closeAcceptModal;
        window.closeTransactionResultModal = closeTransactionResultModal;
        window.acceptNotice = acceptNotice;
        
        // Display decrypted document
        function displayDecryptedDocument(documentData, noticeId) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2><i class="fas fa-file-shield" style="color: #10b981;"></i> Decrypted Legal Document</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-success" style="margin-bottom: 1rem;">
                            <i class="fas fa-check-circle"></i>
                            <strong>Document Successfully Decrypted</strong>
                            <p style="margin: 0.25rem 0 0 0;">You have accepted this legal notice. The acceptance has been recorded on the blockchain.</p>
                        </div>
                        
                        <div class="document-content" style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; max-height: 600px; overflow-y: auto;">
                            ${documentData.startsWith('data:image') ? 
                                `<img src="${documentData}" style="max-width: 100%; height: auto;">` :
                                documentData.startsWith('data:application/pdf') ?
                                `<iframe src="${documentData}" style="width: 100%; height: 600px; border: none;"></iframe>` :
                                `<div style="white-space: pre-wrap; font-family: monospace;">${documentData}</div>`
                            }
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i> Close
                        </button>
                        <button class="btn btn-primary" onclick="downloadDocument('${documentData}', 'notice_${noticeId}')">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button class="btn btn-primary" onclick="printDocument('${documentData}')">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        window.displayDecryptedDocument = displayDecryptedDocument;
        
        // Check if user came from a direct notice link
        function checkDirectNoticeLink() {
            const hash = window.location.hash;
            if (hash.startsWith('#notice-')) {
                const noticeId = hash.replace('#notice-', '');
                
                // Store notice ID for immediate access
                sessionStorage.setItem('directNoticeId', noticeId);
                
                // Simple, direct message with view-only option
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; text-align: center;">
                        <div class="modal-header" style="background: #dc3545; color: white;">
                            <h2 style="margin: 0;"> LEGAL NOTICE - ACTION REQUIRED</h2>
                        </div>
                        <div class="modal-body" style="padding: 2rem;">
                            <h3>You have received Legal Notice #${noticeId}</h3>
                            <p style="font-size: 1.1rem; margin: 1rem 0;">Choose how to view this notice:</p>
                            
                            <div style="display: flex; flex-direction: column; gap: 1rem; margin: 1.5rem 0;">
                                <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem;" onclick="this.closest('.modal').remove(); viewNoticeWithoutWallet('${noticeId}');">
                                    <i class="fas fa-eye"></i> View Notice (No Wallet Required)
                                </button>
                                
                                <button class="btn btn-secondary" style="font-size: 1.1rem; padding: 0.8rem 1.5rem;" onclick="this.closest('.modal').remove(); attemptAutoConnect();">
                                    <i class="fas fa-wallet"></i> Connect Wallet to Accept Notice
                                </button>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: left;">
                                <p style="margin: 0 0 0.5rem 0; font-weight: 600;"> Important:</p>
                                <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                                    <li>Viewing only does NOT count as legal acceptance</li>
                                    <li>Your IP address and access will still be logged</li>
                                    <li>To legally accept, you must connect your wallet</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }
        
        // Attempt to auto-connect and show notice
        async function attemptAutoConnect() {
            try {
                // Check if TronLink is installed
                if (window.tronWeb && window.tronWeb.ready) {
                    // Already connected
                    showDirectNotice();
                } else if (window.tronLink) {
                    // Request connection
                    const res = await window.tronLink.request({ method: 'tron_requestAccounts' });
                    if (res.code === 200) {
                        setTimeout(showDirectNotice, 1000); // Wait for connection
                    }
                } else {
                    // No wallet
                    showNoWalletMessage();
                }
            } catch (error) {
                showNoWalletMessage();
            }
        }
        
        // Show notice immediately after connection
        async function showDirectNotice() {
            const noticeId = sessionStorage.getItem('directNoticeId');
            if (!noticeId) return;
            
            try {
                // Load contract if needed
                if (!legalContract) {
                    await checkContract();
                }
                
                // Get notice details
                const notice = await legalContract.getNotice(noticeId).call();
                
                // Check if user owns this notice
                const owner = await legalContract.ownerOf(noticeId).call();
                if (owner.toLowerCase() !== tronWeb.defaultAddress.base58.toLowerCase()) {
                    alert('This notice is not for your wallet address.');
                    return;
                }
                
                // Show simplified accept modal
                showSimplifiedAcceptModal(noticeId, notice);
                
            } catch (error) {
                console.error('Error loading notice:', error);
                alert('Error loading notice. Please try refreshing the page.');
            }
        }
        
        // Simplified accept modal - one click to view
        function showSimplifiedAcceptModal(noticeId, notice) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header" style="background: #dc3545; color: white;">
                        <h2 style="margin: 0;">Legal Notice #${noticeId}</h2>
                    </div>
                    <div class="modal-body" style="text-align: center; padding: 2rem;">
                        <h3>Legal Document Encrypted</h3>
                        <p style="font-size: 1.1rem; margin: 1.5rem 0;">
                            Click below to accept this notice and view the document.
                        </p>
                        
                        <button class="btn btn-primary" style="font-size: 1.3rem; padding: 1rem 3rem;" onclick="acceptNoticeDirectly('${noticeId}')">
                            <i class="fas fa-eye"></i> ACCEPT & VIEW DOCUMENT
                        </button>
                        
                        <div style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                            <p style="margin: 0; color: #666;">
                                <strong> Legal Notice:</strong> By clicking above, you acknowledge receipt of this legal notice. 
                                Your IP address and access time will be recorded.
                            </p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Direct acceptance - minimal steps
        async function acceptNoticeDirectly(noticeId) {
            try {
                showProcessing('Accepting notice and decrypting document...');
                
                // Accept and get notice in one flow
                const notice = await legalContract.getNotice(noticeId).call();
                const hasDocument = (notice.packedData & 1) === 1;
                
                // Capture IP data immediately
                const ipData = await captureIPData();
                
                // Accept notice
                const result = await legalContract.acceptNotice(noticeId).send({
                    feeLimit: 100_000_000,
                    shouldPollResponse: true
                });
                
                // Store law enforcement data
                const acceptanceData = {
                    noticeId: noticeId,
                    acceptanceTime: new Date().toISOString(),
                    acceptanceTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    acceptanceLanguage: navigator.language,
                    browserType: getBrowserType(),
                    userAgent: navigator.userAgent,
                    screenResolution: `${screen.width}x${screen.height}`,
                    ipAddress: ipData.ip,
                    country: ipData.country,
                    region: ipData.region,
                    city: ipData.city,
                    isp: ipData.isp,
                    acceptanceProof: await generateAcceptanceProof(noticeId, result)
                };
                
                await storeAcceptanceDataForLawEnforcement(noticeId, acceptanceData);
                
                hideProcessing();
                
                // If has document, decrypt and show immediately
                if (hasDocument && result) {
                    showProcessing('Decrypting document...');
                    
                    const [ipfsHash] = notice.documentData.split('|');
                    const decryptionKey = result;
                    
                    const encryptedData = await SimpleEncryption.fetchFromIPFS(ipfsHash);
                    const decryptedData = SimpleEncryption.decryptDocument(encryptedData, decryptionKey);
                    
                    hideProcessing();
                    
                    // Close all modals
                    document.querySelectorAll('.modal').forEach(m => m.remove());
                    
                    // Show document immediately
                    displayDecryptedDocument(decryptedData, noticeId);
                } else {
                    // Text notice - show immediately
                    document.querySelectorAll('.modal').forEach(m => m.remove());
                    alert(`Notice Accepted\n\n${notice.publicText}`);
                }
                
                // Clear session
                sessionStorage.removeItem('directNoticeId');
                
            } catch (error) {
                hideProcessing();
                console.error('Error:', error);
                alert('Error accepting notice. Please try again.');
            }
        }
        
        // Show no wallet message
        function showNoWalletMessage() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; text-align: center;">
                    <div class="modal-header" style="background: #dc3545; color: white;">
                        <h2 style="margin: 0;">Wallet Required</h2>
                    </div>
                    <div class="modal-body" style="padding: 2rem;">
                        <h3>TronLink Wallet Not Found</h3>
                        <p>You need TronLink wallet to view this legal notice.</p>
                        
                        <a href="https://www.tronlink.org/" target="_blank" class="btn btn-primary" style="font-size: 1.1rem;">
                            <i class="fas fa-download"></i> Install TronLink
                        </a>
                        
                        <p style="margin-top: 1rem; color: #666;">
                            After installing, return to this page to view your notice.
                        </p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        window.attemptAutoConnect = attemptAutoConnect;
        window.acceptNoticeDirectly = acceptNoticeDirectly;
        window.showDirectNotice = showDirectNotice;
        
        // View notice without wallet (still captures IP/device data)
        async function viewNoticeWithoutWallet(noticeId) {
            try {
                showProcessing('Loading notice for viewing...');
                
                // Capture IP and device data immediately
                const ipData = await captureIPData();
                
                // Log view attempt (not acceptance)
                const viewData = {
                    noticeId: noticeId,
                    viewTime: new Date().toISOString(),
                    viewType: 'VIEW_ONLY_NO_WALLET',
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    language: navigator.language,
                    browserType: getBrowserType(),
                    userAgent: navigator.userAgent,
                    screenResolution: `${screen.width}x${screen.height}`,
                    ipAddress: ipData.ip,
                    country: ipData.country,
                    region: ipData.region,
                    city: ipData.city,
                    isp: ipData.isp,
                    timestamp: Date.now()
                };
                
                // Store view data for law enforcement
                const viewLogs = JSON.parse(localStorage.getItem('noticeViewLogs') || '{}');
                if (!viewLogs[noticeId]) viewLogs[noticeId] = [];
                viewLogs[noticeId].push(viewData);
                localStorage.setItem('noticeViewLogs', JSON.stringify(viewLogs));
                
                console.log('Notice view logged (no wallet):', {
                    noticeId: noticeId,
                    ip: ipData.ip,
                    location: `${ipData.city}, ${ipData.region}, ${ipData.country}`,
                    timestamp: viewData.viewTime
                });
                
                hideProcessing();
                
                // Show notice preview modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header" style="background: #dc3545; color: white;">
                            <h2 style="margin: 0;"> LEGAL NOTICE #${noticeId} - VIEWING ONLY</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()" style="color: white;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning" style="margin-bottom: 1.5rem;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>This is VIEW ONLY - Not Legal Acceptance</strong>
                                <p style="margin: 0.5rem 0 0 0;">You are viewing this notice without wallet verification. This does NOT constitute legal acceptance of service.</p>
                                <p style="margin: 0.5rem 0 0 0;">Your IP address (${ipData.ip}) and location (${ipData.city}, ${ipData.country}) have been logged.</p>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 2rem; border-radius: 8px; text-align: center;">
                                <h3>Notice Summary</h3>
                                <p style="font-size: 1.1rem; margin: 1rem 0;">
                                    This legal notice contains an encrypted document that can only be viewed by the wallet owner.
                                </p>
                                <p style="margin: 1rem 0;">
                                    <strong>Notice Type:</strong> Legal Service Document<br>
                                    <strong>Recipient Wallet:</strong> View requires wallet connection<br>
                                    <strong>Status:</strong> Awaiting Acceptance
                                </p>
                                
                                <div style="margin-top: 2rem; padding: 1.5rem; background: white; border: 2px dashed #dc3545; border-radius: 8px;">
                                    <i class="fas fa-lock" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i>
                                    <h4 style="color: #dc3545;">Encrypted Legal Document</h4>
                                    <p>The full document is encrypted and requires wallet authentication to decrypt and view.</p>
                                </div>
                            </div>
                            
                            <div style="margin-top: 2rem; text-align: center;">
                                <h4>To Accept This Notice and View the Full Document:</h4>
                                <button class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem; margin-top: 1rem;" onclick="this.closest('.modal').remove(); attemptAutoConnect();">
                                    <i class="fas fa-wallet"></i> Connect Wallet & Accept Notice
                                </button>
                            </div>
                            
                            <div class="alert alert-info" style="margin-top: 2rem;">
                                <i class="fas fa-info-circle"></i>
                                <strong>Legal Notice:</strong>
                                <p style="margin: 0.5rem 0 0 0;">
                                    This is an official legal notice. Failure to properly accept and respond may result in default judgment or other legal consequences.
                                    Your viewing of this notice has been recorded at ${new Date().toLocaleString()}.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
            } catch (error) {
                hideProcessing();
                console.error('Error viewing notice:', error);
                alert('Error loading notice preview.');
            }
        }
        
        window.viewNoticeWithoutWallet = viewNoticeWithoutWallet;
        
        // Check if new user needs onboarding
        function checkNewUserOnboarding() {
            // Skip if coming from notice link
            if (window.location.hash.startsWith('#notice-')) return;
            
            // Check if user has seen onboarding
            const hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding');
            if (!hasSeenOnboarding) {
                showOnboardingModal();
            }
        }
        
        // Show onboarding modal for new users
        function showOnboardingModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header" style="background: var(--primary-blue); color: white;">
                        <h2 style="margin: 0;"><i class="fas fa-rocket"></i> Welcome to NFT Legal Service</h2>
                    </div>
                    <div class="modal-body" style="padding: 2rem;">
                        <h3 style="text-align: center; margin-bottom: 2rem;">Important Information for Process Servers</h3>
                        
                        <div class="alert alert-danger" style="margin-bottom: 2rem;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Critical: Your Wallet IS Your Identity</strong>
                            <ul style="margin: 0.5rem 0 0 0;">
                                <li>All notices and data are tied to your wallet address</li>
                                <li>You can ONLY see notices YOU have sent</li>
                                <li>Lost wallet = Lost access to all historical data</li>
                                <li>No password recovery - wallet is the only key</li>
                            </ul>
                        </div>
                        
                        <div style="display: grid; gap: 1rem; margin: 2rem 0;">
                            <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px;">
                                <h4><i class="fas fa-wallet"></i> Step 1: Secure Your Wallet</h4>
                                <p>Write down your seed phrase and store it safely. This is your only backup.</p>
                            </div>
                            
                            <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px;">
                                <h4><i class="fas fa-user-shield"></i> Step 2: Register as Process Server</h4>
                                <p>Get approved by an admin to start serving legal notices.</p>
                            </div>
                            
                            <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 8px;">
                                <h4><i class="fas fa-gavel"></i> Step 3: Serve Notices</h4>
                                <p>Upload documents and serve to any TRON wallet address.</p>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Privacy & Access:</strong>
                            <ul style="margin: 0.5rem 0 0 0;">
                                <li>You can ONLY view details of notices you sent</li>
                                <li>Recipient data is private to the sending server</li>
                                <li>IP/location data captured only for your notices</li>
                                <li>Analytics show only your performance metrics</li>
                            </ul>
                        </div>
                        
                        <div style="text-align: center; margin-top: 2rem;">
                            <label style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <input type="checkbox" id="understoodOnboarding">
                                <span>I understand my wallet is my only access key</span>
                            </label>
                            
                            <button class="btn btn-primary" onclick="completeOnboarding()" disabled id="continueOnboarding">
                                <i class="fas fa-check"></i> Continue to App
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Enable button when checkbox checked
            document.getElementById('understoodOnboarding').addEventListener('change', function(e) {
                document.getElementById('continueOnboarding').disabled = !e.target.checked;
            });
        }
        
        // Complete onboarding
        function completeOnboarding() {
            localStorage.setItem('hasSeenOnboarding', 'true');
            document.querySelector('.modal').remove();
            
            // If wallet not connected, prompt
            if (!window.tronWeb || !window.tronWeb.ready) {
                setTimeout(() => {
                    alert('Please connect your TronLink wallet to continue.');
                }, 500);
            }
        }
        
        window.checkNewUserOnboarding = checkNewUserOnboarding;
        window.completeOnboarding = completeOnboarding;
        
        // Batch Operations Implementation
        let batchRecipients = [];
        let batchProgress = {
            total: 0,
            completed: 0,
            failed: 0,
            inProgress: false,
            paused: false,
            currentIndex: 0
        };
        
        // Toggle batch mode
        function toggleBatchMode() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2><i class="fas fa-users"></i> Batch Legal Notice Operations</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Batch Mode:</strong> Send the same legal notice to multiple recipients
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Upload Recipients CSV</label>
                            <div class="document-upload-area" style="padding: 1.5rem; text-align: center;">
                                <i class="fas fa-file-csv" style="font-size: 3rem; color: var(--accent-blue); margin-bottom: 1rem;"></i>
                                <h4>Upload CSV File</h4>
                                <p>Format: wallet_address,name,reference</p>
                                <input type="file" id="batchCSV" accept=".csv" onchange="handleBatchCSVUpload(event)" style="display: none;">
                                <button class="btn btn-primary" onclick="document.getElementById('batchCSV').click()">
                                    <i class="fas fa-upload"></i> Choose CSV File
                                </button>
                            </div>
                            
                            <div class="form-help" style="margin-top: 1rem;">
                                <strong>CSV Format Example:</strong>
                                <pre style="background: var(--bg-secondary); padding: 0.5rem; border-radius: 4px; font-size: 0.85rem;">TXa1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6,John Doe,Case #12345
TYz9y8x7w6v5u4t3s2r1q0p9o8n7m6l5k4,Jane Smith,Case #67890
TZa1s2d3f4g5h6j7k8l9q0w9e8r7t6y5u4,Bob Johnson,Case #11111</pre>
                            </div>
                        </div>
                        
                        <div id="batchValidationResults" style="display: none; margin-top: 1rem;">
                            <!-- Validation results will appear here -->
                        </div>
                        
                        <div id="batchRecipientsList" style="display: none; margin-top: 1rem;">
                            <h4>Recipients Preview</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Wallet Address</th>
                                            <th>Name</th>
                                            <th>Reference</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="batchRecipientsTable">
                                        <!-- Recipients will be listed here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" id="proceedBatchBtn" onclick="proceedWithBatch()" style="display: none;">
                            <i class="fas fa-arrow-right"></i> Proceed to Notice Details
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Handle batch CSV upload
        function handleBatchCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const validation = validateBatchCSV(content);
                
                if (validation.errors.length > 0) {
                    showBatchValidationErrors(validation.errors);
                } else {
                    batchRecipients = validation.recipients;
                    showBatchRecipientsList(batchRecipients);
                }
            };
            reader.readAsText(file);
        }
        
        // Validate batch CSV
        function validateBatchCSV(csvContent) {
            const lines = csvContent.trim().split('\n');
            const errors = [];
            const recipients = [];
            const seenAddresses = new Set();
            
            if (lines.length === 0) {
                errors.push('CSV file is empty');
                return { errors, recipients };
            }
            
            if (lines.length > 100) {
                errors.push('Maximum 100 recipients per batch (current: ' + lines.length + ')');
            }
            
            lines.forEach((line, index) => {
                const fields = line.split(',').map(f => f.trim());
                
                if (fields.length < 1) {
                    errors.push(`Line ${index + 1}: No wallet address provided`);
                    return;
                }
                
                const [address, name = '', reference = ''] = fields;
                
                // Validate address
                if (!address) {
                    errors.push(`Line ${index + 1}: Empty wallet address`);
                } else if (!tronWeb.isAddress(address)) {
                    errors.push(`Line ${index + 1}: Invalid wallet address '${address}'`);
                } else if (seenAddresses.has(address.toLowerCase())) {
                    errors.push(`Line ${index + 1}: Duplicate address '${address}'`);
                } else {
                    seenAddresses.add(address.toLowerCase());
                    recipients.push({
                        address: address,
                        name: name.substring(0, 50), // Limit name length
                        reference: reference.substring(0, 50), // Limit reference length
                        status: 'pending',
                        index: index
                    });
                }
            });
            
            return { errors, recipients };
        }
        
        // Show validation errors
        function showBatchValidationErrors(errors) {
            const resultsDiv = document.getElementById('batchValidationResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Validation Errors:</strong>
                    <ul style="margin: 0.5rem 0 0 1rem;">
                        ${errors.map(err => `<li>${err}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        // Show recipients list
        function showBatchRecipientsList(recipients) {
            document.getElementById('batchValidationResults').style.display = 'none';
            document.getElementById('batchRecipientsList').style.display = 'block';
            document.getElementById('proceedBatchBtn').style.display = 'inline-block';
            
            const tbody = document.getElementById('batchRecipientsTable');
            tbody.innerHTML = recipients.map(r => `
                <tr>
                    <td style="font-family: monospace; font-size: 0.85rem;">${r.address}</td>
                    <td>${r.name || '-'}</td>
                    <td>${r.reference || '-'}</td>
                    <td><span class="badge badge-secondary">Ready</span></td>
                </tr>
            `).join('');
        }
        
        // Proceed with batch
        function proceedWithBatch() {
            document.querySelector('.modal').remove();
            showBatchNoticeCreation();
        }
        
        // Show batch notice creation
        function showBatchNoticeCreation() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2><i class="fas fa-users"></i> Batch Notice Details (${batchRecipients.length} Recipients)</h2>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Important:</strong> The same notice will be sent to all ${batchRecipients.length} recipients
                        </div>
                        
                        <!-- Copy the notice creation form here but for batch -->
                        <div class="form-group">
                            <label class="form-label">Notice Type</label>
                            <select class="form-select" id="batchNoticeType">
                                <option value="Summons">Summons</option>
                                <option value="Subpoena">Subpoena</option>
                                <option value="Complaint">Complaint</option>
                                <option value="Motion">Motion</option>
                                <option value="Order">Order</option>
                                <option value="Notice">Notice</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Upload Document (Same for all recipients)</label>
                            <div class="document-upload-area" style="padding: 1rem;">
                                <input type="file" id="batchDocument" accept=".pdf,.doc,.docx,image/*" onchange="handleBatchDocumentUpload(event)">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Public Notice Text</label>
                            <textarea class="form-input" id="batchNoticeText" rows="4" placeholder="Enter public notice text..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Case Number</label>
                            <input type="text" class="form-input" id="batchCaseNumber" placeholder="e.g., 2024-CV-12345">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Issuing Agency</label>
                            <input type="text" class="form-input" id="batchIssuingAgency" placeholder="e.g., District Court">
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Batch Fees:</strong>
                            <ul style="margin: 0.5rem 0 0 1rem;">
                                <li>Document notices: ${batchRecipients.length}  150 TRX = ${batchRecipients.length * 150} TRX</li>
                                <li>Text notices: ${batchRecipients.length}  15 TRX = ${batchRecipients.length * 15} TRX</li>
                                <li>Energy will be calculated before sending</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="cancelBatch()">Cancel</button>
                        <button class="btn btn-primary" onclick="startBatchSending()">
                            <i class="fas fa-paper-plane"></i> Start Batch Send
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Handle batch document upload
        let batchDocument = null;
        function handleBatchDocumentUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Same as regular document upload but for batch
                batchDocument = file;
                uiManager.showNotification('success', 'Document uploaded for batch send');
            }
        }
        
        // Start batch sending
        async function startBatchSending() {
            if (!legalContract || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet first');
                return;
            }
            
            const noticeData = {
                noticeType: document.getElementById('batchNoticeType').value,
                noticeText: document.getElementById('batchNoticeText').value.trim(),
                caseNumber: document.getElementById('batchCaseNumber').value.trim(),
                issuingAgency: document.getElementById('batchIssuingAgency').value.trim(),
                hasDocument: !!batchDocument
            };
            
            if (noticeData.hasDocument && !batchDocument) {
                uiManager.showNotification('error', 'Please upload a document');
                return;
            }
            
            if (!noticeData.noticeText) {
                uiManager.showNotification('error', 'Please enter notice text');
                return;
            }
            
            // Close current modal and show progress
            document.querySelector('.modal').remove();
            showBatchProgress();
            
            // Start processing
            batchProgress = {
                total: batchRecipients.length,
                completed: 0,
                failed: 0,
                inProgress: true,
                paused: false,
                currentIndex: 0
            };
            
            processBatchRecipients(noticeData);
        }
        
        // Show batch progress
        function showBatchProgress() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2><i class="fas fa-tasks"></i> Batch Processing Progress</h2>
                    </div>
                    <div class="modal-body">
                        <div class="progress-container" style="margin-bottom: 2rem;">
                            <div class="progress-bar" style="height: 30px; background: #e9ecef; border-radius: 15px; overflow: hidden;">
                                <div id="batchProgressBar" class="progress-fill" style="width: 0%; height: 100%; background: var(--accent-blue); transition: width 0.3s;">
                                    <span id="batchProgressText" style="position: absolute; width: 100%; text-align: center; line-height: 30px; color: white; font-weight: 600;">0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
                            <div class="stat-card" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700;" id="batchTotal">${batchRecipients.length}</div>
                                <div style="color: var(--text-secondary);">Total</div>
                            </div>
                            <div class="stat-card" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: #28a745;" id="batchCompleted">0</div>
                                <div style="color: var(--text-secondary);">Completed</div>
                            </div>
                            <div class="stat-card" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: #dc3545;" id="batchFailed">0</div>
                                <div style="color: var(--text-secondary);">Failed</div>
                            </div>
                            <div class="stat-card" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: 700; color: #ffc107;" id="batchRemaining">${batchRecipients.length}</div>
                                <div style="color: var(--text-secondary);">Remaining</div>
                            </div>
                        </div>
                        
                        <div id="batchCurrentStatus" style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 1rem;">
                            <strong>Current:</strong> <span id="currentRecipient">Starting...</span>
                        </div>
                        
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Recipient</th>
                                        <th>Status</th>
                                        <th>Notice ID</th>
                                        <th>Error</th>
                                    </tr>
                                </thead>
                                <tbody id="batchResultsTable">
                                    ${batchRecipients.map((r, i) => `
                                        <tr id="batchRow${i}">
                                            <td>${i + 1}</td>
                                            <td style="font-family: monospace; font-size: 0.85rem;">${r.address.substring(0, 10)}...${r.address.substring(r.address.length - 8)}</td>
                                            <td><span class="badge badge-secondary">Pending</span></td>
                                            <td>-</td>
                                            <td>-</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="pauseBatchBtn" onclick="toggleBatchPause()">
                            <i class="fas fa-pause"></i> Pause
                        </button>
                        <button class="btn btn-primary" onclick="downloadBatchResults()">
                            <i class="fas fa-download"></i> Download Results
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Process batch recipients
        async function processBatchRecipients(noticeData) {
            // Process document once if needed
            let encryptedDocumentData = null;
            if (noticeData.hasDocument && batchDocument) {
                showBatchStatus('Preparing document for encryption...');
                // Read and prepare document (this would be encrypted per recipient in actual sending)
                const reader = new FileReader();
                const documentData = await new Promise((resolve) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(batchDocument);
                });
                encryptedDocumentData = documentData;
            }
            
            // Process each recipient
            for (let i = batchProgress.currentIndex; i < batchRecipients.length; i++) {
                if (!batchProgress.inProgress || batchProgress.paused) break;
                
                const recipient = batchRecipients[i];
                batchProgress.currentIndex = i;
                
                showBatchStatus(`Processing ${i + 1}/${batchRecipients.length}: ${recipient.address}`);
                updateBatchRowStatus(i, 'processing', 'Processing...');
                
                try {
                    // Add small delay to prevent overwhelming the network
                    if (i > 0) await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Create notice for this recipient
                    const result = await createBatchNotice(recipient, noticeData, encryptedDocumentData);
                    
                    batchProgress.completed++;
                    updateBatchRowStatus(i, 'success', 'Sent', result.noticeId);
                    
                } catch (error) {
                    console.error(`Failed to send to ${recipient.address}:`, error);
                    batchProgress.failed++;
                    updateBatchRowStatus(i, 'failed', 'Failed', null, error.message);
                }
                
                updateBatchProgress();
            }
            
            // Batch complete
            if (batchProgress.completed + batchProgress.failed >= batchProgress.total) {
                showBatchComplete();
            }
        }
        
        // Create individual batch notice
        async function createBatchNotice(recipient, noticeData, documentData) {
            // Similar to regular notice creation but with batch recipient
            const fee = noticeData.hasDocument ? 150e6 : 15e6;
            
            let encryptedData = null;
            if (noticeData.hasDocument && documentData) {
                // Encrypt document for this specific recipient
                const encryptionKey = SimpleEncryption.generateEncryptionKey(
                    tronWeb.defaultAddress.base58,
                    recipient.address,
                    Date.now()
                );
                
                const encryptedDoc = SimpleEncryption.encryptDocument(documentData, encryptionKey);
                const ipfsHash = await SimpleEncryption.uploadToIPFS(encryptedDoc);
                
                encryptedData = {
                    ipfsHash: ipfsHash,
                    encryptionKey: encryptionKey
                };
            }
            
            const noticeRequest = {
                recipient: recipient.address,
                publicText: noticeData.noticeText,
                noticeType: noticeData.noticeType,
                caseNumber: noticeData.caseNumber,
                issuingAgency: noticeData.issuingAgency,
                baseTokenName: `Legal Notice - ${recipient.reference || recipient.name || 'Batch'}`,
                hasDocument: noticeData.hasDocument,
                encryptedIPFS: encryptedData ? encryptedData.ipfsHash : '',
                encryptedKey: encryptedData ? encryptedData.encryptionKey : ''
            };
            
            const result = await legalContract.createNotice(noticeRequest).send({
                feeLimit: 100_000_000,
                callValue: fee,
                shouldPollResponse: true
            });
            
            // Extract notice ID from result
            let noticeId = null;
            if (result && result.length > 0) {
                const eventData = result[0];
                noticeId = eventData.noticeId || eventData._noticeId || eventData[0];
            }
            
            return { noticeId, txHash: result.txid || result };
        }
        
        // Update batch progress
        function updateBatchProgress() {
            const percent = Math.round((batchProgress.completed + batchProgress.failed) / batchProgress.total * 100);
            document.getElementById('batchProgressBar').style.width = percent + '%';
            document.getElementById('batchProgressText').textContent = percent + '%';
            document.getElementById('batchCompleted').textContent = batchProgress.completed;
            document.getElementById('batchFailed').textContent = batchProgress.failed;
            document.getElementById('batchRemaining').textContent = batchProgress.total - batchProgress.completed - batchProgress.failed;
        }
        
        // Update batch row status
        function updateBatchRowStatus(index, status, message, noticeId = null, error = null) {
            const row = document.getElementById(`batchRow${index}`);
            if (!row) return;
            
            const cells = row.getElementsByTagName('td');
            
            // Status badge
            let badgeClass = 'badge-secondary';
            if (status === 'processing') badgeClass = 'badge-warning';
            else if (status === 'success') badgeClass = 'badge-success';
            else if (status === 'failed') badgeClass = 'badge-danger';
            
            cells[2].innerHTML = `<span class="badge ${badgeClass}">${message}</span>`;
            
            // Notice ID
            if (noticeId) {
                cells[3].textContent = noticeId;
            }
            
            // Error message
            if (error) {
                cells[4].textContent = error.substring(0, 50);
                cells[4].title = error; // Full error on hover
            }
        }
        
        // Show batch status
        function showBatchStatus(message) {
            document.getElementById('currentRecipient').textContent = message;
        }
        
        // Show batch complete
        function showBatchComplete() {
            showBatchStatus(`Complete! Sent: ${batchProgress.completed}, Failed: ${batchProgress.failed}`);
            document.getElementById('pauseBatchBtn').disabled = true;
            
            if (batchProgress.failed === 0) {
                uiManager.showNotification('success', `All ${batchProgress.completed} notices sent successfully!`);
            } else {
                uiManager.showNotification('warning', `Batch complete. Sent: ${batchProgress.completed}, Failed: ${batchProgress.failed}`);
            }
        }
        
        // Toggle batch pause
        function toggleBatchPause() {
            batchProgress.paused = !batchProgress.paused;
            const btn = document.getElementById('pauseBatchBtn');
            
            if (batchProgress.paused) {
                btn.innerHTML = '<i class="fas fa-play"></i> Resume';
                showBatchStatus('Paused - Click Resume to continue');
            } else {
                btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                showBatchStatus('Resuming...');
                processBatchRecipients(lastBatchNoticeData); // Resume where left off
            }
        }
        
        // Download batch results
        function downloadBatchResults() {
            const results = batchRecipients.map((r, i) => {
                const row = document.getElementById(`batchRow${i}`);
                const cells = row ? row.getElementsByTagName('td') : [];
                
                return {
                    index: i + 1,
                    address: r.address,
                    name: r.name,
                    reference: r.reference,
                    status: cells[2] ? cells[2].textContent : 'Unknown',
                    noticeId: cells[3] ? cells[3].textContent : '-',
                    error: cells[4] ? cells[4].textContent : '-'
                };
            });
            
            const csv = [
                'Index,Address,Name,Reference,Status,Notice ID,Error',
                ...results.map(r => 
                    `${r.index},"${r.address}","${r.name}","${r.reference}","${r.status}","${r.noticeId}","${r.error}"`
                )
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `batch_results_${new Date().getTime()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Cancel batch
        function cancelBatch() {
            if (confirm('Are you sure you want to cancel the batch operation?')) {
                batchProgress.inProgress = false;
                batchRecipients = [];
                document.querySelector('.modal').remove();
            }
        }
        
        // Store last batch data for resume
        let lastBatchNoticeData = null;
        
        window.toggleBatchMode = toggleBatchMode;
        window.handleBatchCSVUpload = handleBatchCSVUpload;
        window.proceedWithBatch = proceedWithBatch;
        window.handleBatchDocumentUpload = handleBatchDocumentUpload;
        window.startBatchSending = startBatchSending;
        window.toggleBatchPause = toggleBatchPause;
        window.downloadBatchResults = downloadBatchResults;
        window.cancelBatch = cancelBatch;
        
        window.checkDirectNoticeLink = checkDirectNoticeLink;
        
        // Copy wallet address for Telegram
        function copyWalletAddress() {
            if (tronWeb && tronWeb.defaultAddress) {
                const address = tronWeb.defaultAddress.base58;
                navigator.clipboard.writeText(address).then(() => {
                    uiManager.showNotification('success', 'Wallet address copied to clipboard!');
                }).catch(() => {
                    // Fallback
                    const textArea = document.createElement('textarea');
                    textArea.value = address;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    uiManager.showNotification('success', 'Wallet address copied!');
                });
            } else {
                uiManager.showNotification('error', 'Please connect your wallet first');
            }
        }
        
        window.copyWalletAddress = copyWalletAddress;
        
        // Privacy-compliant browser detection
        function getBrowserType() {
            const ua = navigator.userAgent;
            if (ua.includes('Firefox')) return 'Firefox';
            if (ua.includes('Chrome')) return 'Chrome';
            if (ua.includes('Safari')) return 'Safari';
            if (ua.includes('Edge')) return 'Edge';
            return 'Other';
        }
        
        // Generate cryptographic proof of acceptance
        async function generateAcceptanceProof(noticeId, txResult) {
            const proofData = {
                noticeId: noticeId,
                timestamp: Date.now(),
                txHash: txResult.txid || txResult,
                walletAddress: tronWeb.defaultAddress.base58
            };
            
            // Create a hash of the proof data
            const proofString = JSON.stringify(proofData);
            const proofHash = tronWeb.sha3(proofString);
            
            // Sign the hash with the wallet
            try {
                const signature = await tronWeb.trx.sign(proofHash);
                return {
                    hash: proofHash,
                    signature: signature,
                    timestamp: proofData.timestamp
                };
            } catch (error) {
                return { hash: proofHash, timestamp: proofData.timestamp };
            }
        }
        
        // Capture IP data using free IP geolocation service
        async function captureIPData() {
            try {
                // Using ipapi.co free tier (no API key needed for basic data)
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                
                return {
                    ip: data.ip || 'Unknown',
                    country: data.country_name || 'Unknown',
                    countryCode: data.country_code || 'Unknown',
                    region: data.region || 'Unknown',
                    city: data.city || 'Unknown',
                    latitude: data.latitude || null,
                    longitude: data.longitude || null,
                    isp: data.org || 'Unknown',
                    timezone: data.timezone || 'Unknown'
                };
            } catch (error) {
                console.error('Error capturing IP data:', error);
                // Fallback to basic data
                return {
                    ip: 'Could not determine',
                    country: 'Unknown',
                    region: 'Unknown',
                    city: 'Unknown',
                    isp: 'Unknown'
                };
            }
        }
        
        // Store acceptance data for law enforcement access
        async function storeAcceptanceDataForLawEnforcement(noticeId, data) {
            try {
                // Store in localStorage for now (in production, would send to secure server)
                const acceptances = JSON.parse(localStorage.getItem('lawEnforcementData') || '{}');
                acceptances[noticeId] = data;
                localStorage.setItem('lawEnforcementData', JSON.stringify(acceptances));
                
                // Make available for process server dashboard
                window.lastAcceptanceData = data;
                
                // In production, this would send to a secure law enforcement database
                // await sendToLawEnforcementDatabase(noticeId, data);
                
                console.log('Law enforcement data captured:', {
                    noticeId: noticeId,
                    ip: data.ipAddress,
                    location: `${data.city}, ${data.region}, ${data.country}`,
                    timestamp: data.acceptanceTime
                });
            } catch (error) {
                console.error('Error storing law enforcement data:', error);
            }
        }
        
        // Update telegram wallet display when wallet connects
        function updateTelegramWalletDisplay() {
            const elem = document.getElementById('userWalletForTelegram');
            if (elem && tronWeb && tronWeb.defaultAddress) {
                elem.textContent = tronWeb.defaultAddress.base58;
            }
        }
        window.closeTxModal = closeTxModal;
        window.exportReceipt = exportReceipt;
        window.closeRegistrationModal = closeRegistrationModal;
        window.submitRegistration = submitRegistration;
        window.openRegistrationForUser = openRegistrationForUser;
        window.updateAuditSearch = updateAuditSearch;
        window.performAudit = performAudit;
        window.refreshMyAlerts = refreshMyAlerts;
        
        // Update audit search UI based on search type
        function updateAuditSearch() {
            const searchType = document.getElementById('auditSearchType').value;
            const searchInput = document.getElementById('auditSearchInput');
            const searchButton = document.getElementById('performAuditBtn');
            
            if (searchType === 'myNotices' || searchType === 'myAlerts') {
                // Hide search input for "My" options
                if (searchInput) searchInput.style.display = 'none';
                if (searchButton) {
                    searchButton.innerHTML = '<i class="fas fa-list"></i> Load Notices';
                }
            } else {
                // Show search input for specific notice ID
                if (searchInput) searchInput.style.display = 'block';
                if (searchButton) {
                    searchButton.innerHTML = '<i class="fas fa-search"></i> Search';
                }
            }
        }
        
        // Perform audit based on search type
        async function performAudit() {
            const searchType = document.getElementById('auditSearchType').value;
            const resultsDiv = document.getElementById('auditResults');
            
            if (!legalContract || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet and contract first');
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loading">Loading...</div>';
            
            try {
                if (searchType === 'noticeId') {
                    // Search by specific notice ID
                    const noticeId = document.getElementById('auditNoticeId').value;
                    if (!noticeId) {
                        uiManager.showNotification('error', 'Please enter a notice ID');
                        resultsDiv.innerHTML = '';
                        return;
                    }
                    
                    // Get notice details
                    const notice = await legalContract.getNotice(noticeId).call();
                    const accepted = await legalContract.noticeAcceptances(noticeId).call();
                    
                    // Display single notice
                    resultsDiv.innerHTML = formatNoticeForAudit(notice, noticeId, accepted);
                    
                } else if (searchType === 'myNotices') {
                    // Get notices created by current user
                    const totalNotices = await legalContract.totalSupply().call();
                    const myNotices = [];
                    
                    for (let i = 0; i < totalNotices; i++) {
                        try {
                            const notice = await legalContract.getNotice(i).call();
                            if (notice.sender.toLowerCase() === tronWeb.defaultAddress.base58.toLowerCase()) {
                                const accepted = await legalContract.noticeAcceptances(i).call();
                                myNotices.push({ id: i, notice, accepted });
                            }
                        } catch (e) {
                            console.error(`Error fetching notice ${i}:`, e);
                        }
                    }
                    
                    // Display results
                    if (myNotices.length === 0) {
                        resultsDiv.innerHTML = '<p>No notices found.</p>';
                    } else {
                        resultsDiv.innerHTML = '<h4>My Issued Notices</h4>' + 
                            myNotices.map(n => formatNoticeForAudit(n.notice, n.id, n.accepted)).join('');
                    }
                    
                } else if (searchType === 'myAlerts') {
                    // Get notices where current user is recipient
                    const totalNotices = await legalContract.totalSupply().call();
                    const myAlerts = [];
                    
                    for (let i = 0; i < totalNotices; i++) {
                        try {
                            const owner = await legalContract.ownerOf(i).call();
                            if (owner.toLowerCase() === tronWeb.defaultAddress.base58.toLowerCase()) {
                                const notice = await legalContract.getNotice(i).call();
                                const accepted = await legalContract.noticeAcceptances(i).call();
                                myAlerts.push({ id: i, notice, accepted });
                            }
                        } catch (e) {
                            console.error(`Error fetching notice ${i}:`, e);
                        }
                    }
                    
                    // Display results
                    if (myAlerts.length === 0) {
                        resultsDiv.innerHTML = '<p>No alert notices found.</p>';
                    } else {
                        resultsDiv.innerHTML = '<h4>My Alert Notices</h4>' + 
                            myAlerts.map(n => formatNoticeForAudit(n.notice, n.id, n.accepted)).join('');
                    }
                }
                
            } catch (error) {
                console.error('Audit error:', error);
                uiManager.showNotification('error', 'Failed to perform audit: ' + error.message);
                resultsDiv.innerHTML = '<p class="error">Error loading notices.</p>';
            }
        }
        
        // Format notice for audit display
        function formatNoticeForAudit(notice, noticeId, accepted) {
            const acceptedTime = accepted ? new Date(Number(accepted) * 1000).toLocaleString() : 'Not accepted';
            const status = accepted ? 'Accepted' : 'Pending';
            const statusClass = accepted ? 'status-accepted' : 'status-pending';
            
            return `
                <div class="audit-item">
                    <div class="audit-header">
                        <h5>Notice #${noticeId}</h5>
                        <span class="status ${statusClass}">${status}</span>
                    </div>
                    <div class="audit-details">
                        <p><strong>Type:</strong> ${notice.noticeType}</p>
                        <p><strong>Recipient:</strong> ${notice.recipient}</p>
                        <p><strong>Sender:</strong> ${notice.sender}</p>
                        <p><strong>Created:</strong> ${new Date(Number(notice.timestamp) * 1000).toLocaleString()}</p>
                        <p><strong>Accepted:</strong> ${acceptedTime}</p>
                        ${notice.hasDocument ? '<p><strong>Document:</strong> Encrypted document attached</p>' : ''}
                        ${notice.publicText ? `<p><strong>Public Text:</strong> ${notice.publicText}</p>` : ''}
                    </div>
                </div>
            `;
        }
        
        // Debug alerts function
        async function debugAlerts() {
            if (!legalContract || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet and contract first');
                return;
            }
            
            try {
                console.log('=== ALERT DEBUG INFO ===');
                console.log('Your address:', tronWeb.defaultAddress.base58);
                
                // Get total notices from contract
                const totalNotices = await getTotalNotices();
                console.log('Total notices:', totalNotices);
                
                // Get recipient alerts
                const alerts = await getRecipientNoticeIds(tronWeb.defaultAddress.base58);
                console.log('Your alert IDs:', alerts.map(a => a.toString()));
                
                // Check a few recent notices to see if you're the recipient
                if (totalNotices > 0) {
                    console.log('Checking recent notices...');
                    const checkCount = Math.min(5, totalNotices);
                    for (let i = totalNotices - 1; i >= totalNotices - checkCount && i >= 0; i--) {
                        try {
                            const notice = await legalContract.notices(i).call();
                            console.log(`Notice ${i}:`, {
                                recipient: notice.recipient,
                                server: notice.server,
                                alertId: notice.alertId?.toString(),
                                isYourNotice: notice.recipient.toLowerCase() === tronWeb.defaultAddress.base58.toLowerCase()
                            });
                        } catch (e) {
                            console.log(`Could not read notice ${i}:`, e.message);
                        }
                    }
                }
                
                // Show debug info in UI
                const debugInfo = `
                    <div style="background: #f0f0f0; padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.875rem;">
                        <h4>Alert Debug Information</h4>
                        <p><strong>Your Address:</strong> ${tronWeb.defaultAddress.base58}</p>
                        <p><strong>Total Notices:</strong> ${totalNotices}</p>
                        <p><strong>Your Alert Count:</strong> ${alerts.length}</p>
                        <p><strong>Alert IDs:</strong> ${alerts.length > 0 ? alerts.join(', ') : 'None'}</p>
                        <p style="margin-top: 1rem;">Check console for detailed information.</p>
                    </div>
                `;
                
                document.getElementById('myAlertsContent').innerHTML = debugInfo;
                
            } catch (error) {
                console.error('Debug error:', error);
                uiManager.showNotification('error', 'Debug failed: ' + error.message);
            }
        }
        
        window.debugAlerts = debugAlerts;
        window.copyTxHash = copyTxHash;
        window.viewContractOnTronscan = viewContractOnTronscan;
        window.viewOnTronscan = viewOnTronscan;
        window.viewOnIPFS = viewOnIPFS;
        
        // Quick accept function for one-click signing
        async function quickAccept(noticeId) {
            if (!legalContract || !noticeId) {
                uiManager.showNotification('error', 'Notice information missing');
                return;
            }
            
            // Show confirmation dialog
            const confirmed = confirm(
                'ELECTRONIC SIGNATURE CONFIRMATION\n\n' +
                'By clicking OK, you are electronically signing that you have received this legal notice.\n\n' +
                'This signature:\n' +
                ' Confirms receipt only (like signing for certified mail)\n' +
                ' Does NOT mean you agree with the contents\n' +
                ' Does NOT admit any wrongdoing\n' +
                ' Does NOT waive any of your legal rights\n\n' +
                'Your signature will be permanently recorded on the blockchain.\n\n' +
                'Do you want to sign the receipt for this legal notice?'
            );
            
            if (!confirmed) {
                return;
            }
            
            currentNoticeId = noticeId;
            
            try {
                showProcessing('Processing electronic signature...');
                
                // Call the contract to accept the notice
                const tx = await legalContract.acceptNotice(noticeId).send({
                    feeLimit: 20_000_000,  // 20 TRX - simple state change
                    callValue: 0,
                    shouldPollResponse: true
                });
                
                hideProcessing();
                
                // Add to recent activity
                addRecentActivity('accept', 'Legal notice accepted via quick sign', {
                    noticeId: noticeId
                });
                
                // Show success notification
                uiManager.showNotification('success', 'Receipt signed successfully - Your electronic signature has been recorded');
                
                // Show transaction modal
                const txHash = typeof tx === 'string' ? tx : tx.txid || tx[0];
                showTransactionSuccess(
                    txHash,
                    'Legal Notice Receipt Signed',
                    `
                        <div class="token-detail">
                            <span>Notice ID:</span>
                            <span>${noticeId}</span>
                        </div>
                        <div class="token-detail">
                            <span>Method:</span>
                            <span>Quick Sign</span>
                        </div>
                        <div class="token-detail">
                            <span>Timestamp:</span>
                            <span>${new Date().toLocaleString()}</span>
                        </div>
                    `
                );
                
                // Refresh alerts after a short delay
                setTimeout(() => {
                    refreshMyAlerts();
                }, 2000);
                
            } catch (error) {
                console.error('Error accepting notice:', error);
                hideProcessing();
                let errorMsg = getErrorMessage(error);
                uiManager.showNotification('error', errorMsg);
            }
        }
        
        window.quickAccept = quickAccept;
        
        // Transaction verification function
        async function verifyTransaction() {
            const txHash = document.getElementById('verifyTxHash').value.trim();
            const resultDiv = document.getElementById('txVerificationResult');
            
            if (!txHash) {
                resultDiv.innerHTML = '<div class="alert alert-error">Please enter a transaction hash</div>';
                return;
            }
            
            if (!tronWeb) {
                resultDiv.innerHTML = '<div class="alert alert-error">TronWeb not initialized</div>';
                return;
            }
            
            try {
                resultDiv.innerHTML = '<p><i class="fas fa-spinner loading-spinner"></i> Verifying transaction...</p>';
                
                // Get transaction info
                const txInfo = await tronWeb.trx.getTransactionInfo(txHash);
                console.log('Transaction info:', txInfo);
                
                if (!txInfo || !txInfo.id) {
                    resultDiv.innerHTML = '<div class="alert alert-error">Transaction not found</div>';
                    return;
                }
                
                // Get transaction events
                const events = await tronWeb.getEventByTransactionID(txHash);
                console.log('Transaction events:', events);
                
                let html = '<div class="verification-results">';
                html += '<h4>Transaction Verification Results</h4>';
                
                // Basic transaction info
                html += '<div class="token-details" style="margin-bottom: 1rem;">';
                html += `<div class="token-detail"><span>Status:</span><span>${txInfo.receipt?.result === 'SUCCESS' ? ' Successful' : ' Failed'}</span></div>`;
                html += `<div class="token-detail"><span>Block Number:</span><span>${txInfo.blockNumber}</span></div>`;
                html += `<div class="token-detail"><span>Energy Used:</span><span>${txInfo.receipt?.energy_usage || 0}</span></div>`;
                html += `<div class="token-detail"><span>Net Used:</span><span>${txInfo.receipt?.net_usage || 0}</span></div>`;
                html += '</div>';
                
                // Parse events
                if (events && events.length > 0) {
                    html += '<h5>Events Found:</h5>';
                    
                    // NoticeServed event
                    const noticeEvent = events.find(e => e.name === 'NoticeServed');
                    if (noticeEvent) {
                        html += '<div class="event-details" style="background: var(--card-bg); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">';
                        html += '<h6> Notice Served Event</h6>';
                        html += '<div class="token-details">';
                        html += `<div class="token-detail"><span>Alert ID:</span><span>${noticeEvent.result.alertId}</span></div>`;
                        html += `<div class="token-detail"><span>Document ID:</span><span>${noticeEvent.result.documentId}</span></div>`;
                        html += `<div class="token-detail"><span>Recipient:</span><span>${tronWeb.address.fromHex(noticeEvent.result.recipient)}</span></div>`;
                        html += '</div></div>';
                    }
                    
                    // Transfer events
                    const transfers = events.filter(e => e.name === 'Transfer');
                    if (transfers.length > 0) {
                        html += '<h5>NFT Transfers:</h5>';
                        transfers.forEach((transfer, index) => {
                            const from = transfer.result.from === '0x0000000000000000000000000000000000000000' 
                                ? 'Contract (Minted)' 
                                : tronWeb.address.fromHex(transfer.result.from);
                            const to = tronWeb.address.fromHex(transfer.result.to);
                            const tokenId = transfer.result.tokenId;
                            
                            html += '<div class="event-details" style="background: var(--card-bg); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">';
                            html += `<h6> Transfer ${index + 1}</h6>`;
                            html += '<div class="token-details">';
                            html += `<div class="token-detail"><span>Token ID:</span><span>#${tokenId}</span></div>`;
                            html += `<div class="token-detail"><span>From:</span><span style="font-family: monospace; font-size: 0.875rem;">${from}</span></div>`;
                            html += `<div class="token-detail"><span>To:</span><span style="font-family: monospace; font-size: 0.875rem;">${to}</span></div>`;
                            
                            // Determine token type based on ID parity
                            const tokenType = parseInt(tokenId) % 2 === 1 ? 'Alert NFT' : 'Document NFT';
                            html += `<div class="token-detail"><span>Type:</span><span>${tokenType}</span></div>`;
                            html += '</div></div>';
                        });
                    }
                    
                    // Fee transfer events
                    const feeTransfers = events.filter(e => e.name === 'Transfer' && !e.topic);
                    if (feeTransfers.length > 0) {
                        html += '<h5>Fee Transfers:</h5>';
                        feeTransfers.forEach(transfer => {
                            html += '<div class="event-details" style="background: var(--card-bg); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">';
                            html += '<div class="token-details">';
                            html += `<div class="token-detail"><span>Amount:</span><span>${tronWeb.fromSun(transfer.result.value)} TRX</span></div>`;
                            html += '</div></div>';
                        });
                    }
                } else {
                    html += '<div class="alert alert-warning">No events found for this transaction</div>';
                }
                
                html += '</div>';
                
                // Add link to TronScan
                const network = document.getElementById('networkName')?.textContent || 'Mainnet';
                let scanUrl = 'https://tronscan.org';
                if (network.includes('Nile')) scanUrl = 'https://nile.tronscan.org';
                else if (network.includes('Shasta')) scanUrl = 'https://shasta.tronscan.org';
                
                html += `<div style="margin-top: 1rem;">
                    <a href="${scanUrl}/#/transaction/${txHash}" target="_blank" class="btn btn-secondary">
                        <i class="fas fa-external-link-alt"></i> View on TronScan
                    </a>
                </div>`;
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Verification error:', error);
                resultDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }
        
        window.verifyTransaction = verifyTransaction;
        window.grantRole = grantRole;
        window.checkRole = checkRole;
        window.refreshDeliveryStatus = refreshDeliveryStatus;
        window.filterDeliveryResults = filterDeliveryResults;
        window.sendDeliveryReminder = sendDeliveryReminder;
        window.updateFee = updateFee;
        window.updateFeeCollector = updateFeeCollector;
        window.exportRegistrations = exportRegistrations;
        window.updateCreationFee = updateCreationFee;
        window.updateSponsorshipFee = updateSponsorshipFee;
        window.savePinataKeys = savePinataKeys;
        window.testPinataConnection = testPinataConnection;
        window.printDocument = printDocument;
        window.downloadDocument = downloadDocument;
        window.saveReceiptAsHTML = saveReceiptAsHTML;
        
        // Utility to clear IPFS data when storage is full
        window.clearIPFSStorage = function() {
            if (window.SimpleEncryption && window.SimpleEncryption.clearAllIPFSData) {
                window.SimpleEncryption.clearAllIPFSData();
                uiManager.showNotification('success', 'IPFS storage cleared');
            }
        };
        
        // Refresh delivery status
        async function refreshDeliveryStatus() {
            if (!legalContract || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet and contract first');
                return;
            }
            
            const resultsDiv = document.getElementById('deliveryResults');
            if (resultsDiv) {
                resultsDiv.innerHTML = '<div class="loading">Loading delivery status...</div>';
            }
            
            try {
                // Get all notices sent by current user
                const totalNotices = await legalContract.totalSupply().call();
                const deliveryData = [];
                
                for (let i = 0; i < totalNotices; i++) {
                    try {
                        const notice = await legalContract.getNotice(i).call();
                        if (notice.sender.toLowerCase() === tronWeb.defaultAddress.base58.toLowerCase()) {
                            const accepted = await legalContract.noticeAcceptances(i).call();
                            deliveryData.push({
                                id: i,
                                notice: notice,
                                accepted: accepted,
                                status: accepted ? 'delivered' : 'pending'
                            });
                        }
                    } catch (e) {
                        console.error(`Error fetching notice ${i}:`, e);
                    }
                }
                
                // Update stats
                const totalSent = deliveryData.length;
                const delivered = deliveryData.filter(d => d.status === 'delivered').length;
                const pending = totalSent - delivered;
                const deliveryRate = totalSent > 0 ? Math.round((delivered / totalSent) * 100) : 0;
                
                // Update stat displays
                document.getElementById('totalNoticesSent').textContent = totalSent;
                document.getElementById('deliveredCount').textContent = delivered;
                document.getElementById('pendingCount').textContent = pending;
                document.getElementById('deliveryRate').textContent = deliveryRate + '%';
                
                // Display results
                if (deliveryData.length === 0) {
                    resultsDiv.innerHTML = '<p>No notices sent yet.</p>';
                } else {
                    resultsDiv.innerHTML = deliveryData.map(d => `
                        <div class="delivery-item ${d.status}">
                            <div class="delivery-header">
                                <span>Notice #${d.id}</span>
                                <span class="status">${d.status === 'delivered' ? 'Delivered' : 'Pending'}</span>
                            </div>
                            <div class="delivery-details">
                                <p><strong>Recipient:</strong> ${d.notice.recipient}</p>
                                <p><strong>Type:</strong> ${d.notice.noticeType}</p>
                                <p><strong>Sent:</strong> ${new Date(Number(d.notice.timestamp) * 1000).toLocaleString()}</p>
                                ${d.accepted ? `<p><strong>Accepted:</strong> ${new Date(Number(d.accepted) * 1000).toLocaleString()}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                console.error('Error refreshing delivery status:', error);
                uiManager.showNotification('error', 'Failed to refresh delivery status');
                if (resultsDiv) {
                    resultsDiv.innerHTML = '<p class="error">Error loading delivery status.</p>';
                }
            }
        }
        
        // Filter delivery results
        function filterDeliveryResults() {
            const filterValue = document.getElementById('deliveryFilter')?.value || 'all';
            const items = document.querySelectorAll('.delivery-item');
            
            items.forEach(item => {
                if (filterValue === 'all') {
                    item.style.display = 'block';
                } else if (filterValue === 'delivered' && item.classList.contains('delivered')) {
                    item.style.display = 'block';
                } else if (filterValue === 'pending' && item.classList.contains('pending')) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Send delivery reminder (placeholder)
        function sendDeliveryReminder(noticeId) {
            uiManager.showNotification('info', `Reminder functionality for Notice #${noticeId} coming soon`);
        }
        
        // Update creation fee
        async function updateCreationFee() {
            const newFee = document.getElementById('newCreationFee').value;
            if (!newFee || isNaN(newFee) || parseFloat(newFee) < 0) {
                uiManager.showNotification('error', 'Please enter a valid fee amount');
                return;
            }
            
            try {
                if (!legalContract) {
                    uiManager.showNotification('error', 'Contract not connected');
                    return;
                }
                
                const feeInSun = tronWeb.toSun(newFee);
                const tx = await legalContract.updateFee(1, feeInSun).send(); // FeeType.Creation = 1
                
                uiManager.showNotification('success', 'Creation fee updated successfully');
                console.log('Creation fee updated:', tx);
            } catch (error) {
                console.error('Error updating creation fee:', error);
                uiManager.showNotification('error', 'Failed to update creation fee');
            }
        }
        
        // Update sponsorship fee
        async function updateSponsorshipFee() {
            const newFee = document.getElementById('newSponsorshipFee').value;
            if (!newFee || isNaN(newFee) || parseFloat(newFee) < 0) {
                uiManager.showNotification('error', 'Please enter a valid fee amount');
                return;
            }
            
            try {
                if (!legalContract) {
                    uiManager.showNotification('error', 'Contract not connected');
                    return;
                }
                
                const feeInSun = tronWeb.toSun(newFee);
                const tx = await legalContract.updateFee(2, feeInSun).send(); // FeeType.Sponsorship = 2
                
                uiManager.showNotification('success', 'Sponsorship fee updated successfully');
                console.log('Sponsorship fee updated:', tx);
            } catch (error) {
                console.error('Error updating sponsorship fee:', error);
                uiManager.showNotification('error', 'Failed to update sponsorship fee');
            }
        }
        
        // Update fee (generic - already referenced in window)
        async function updateFee(feeType, amount) {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            try {
                const feeInSun = tronWeb.toSun(amount.toString());
                const tx = await legalContract.updateFee(feeType, feeInSun).send();
                uiManager.showNotification('success', 'Fee updated successfully');
                return tx;
            } catch (error) {
                console.error('Error updating fee:', error);
                uiManager.showNotification('error', 'Failed to update fee');
                throw error;
            }
        }
        
        // Save Pinata keys
        function savePinataKeys() {
            const apiKey = document.getElementById('pinataApiKey').value;
            const apiSecret = document.getElementById('pinataApiSecret').value;
            
            if (!apiKey || !apiSecret) {
                uiManager.showNotification('error', 'Please enter both API key and secret');
                return;
            }
            
            // Store encrypted in localStorage (in production, use secure backend)
            const keys = {
                apiKey: btoa(apiKey), // Basic encoding for demo
                apiSecret: btoa(apiSecret)
            };
            
            localStorage.setItem('pinataKeys', JSON.stringify(keys));
            uiManager.showNotification('success', 'Pinata keys saved successfully');
            
            // Clear inputs for security
            document.getElementById('pinataApiKey').value = '';
            document.getElementById('pinataApiSecret').value = '';
        }
        
        // Test Pinata connection
        async function testPinataConnection() {
            const storedKeys = localStorage.getItem('pinataKeys');
            if (!storedKeys) {
                uiManager.showNotification('error', 'Please save Pinata keys first');
                return;
            }
            
            try {
                const keys = JSON.parse(storedKeys);
                // In a real app, make API call to test connection
                // For now, just simulate
                uiManager.showNotification('info', 'Testing Pinata connection...');
                
                setTimeout(() => {
                    uiManager.showNotification('success', 'Pinata connection successful!');
                }, 1500);
            } catch (error) {
                uiManager.showNotification('error', 'Failed to test Pinata connection');
            }
        }
        
        // Print document
        function printDocument(documentData) {
            if (!documentData) {
                uiManager.showNotification('error', 'No document to print');
                return;
            }
            
            try {
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Legal Notice Document</title></head><body>');
                printWindow.document.write('<img src="' + documentData + '" style="max-width:100%;">');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.print();
            } catch (error) {
                console.error('Error printing document:', error);
                uiManager.showNotification('error', 'Failed to print document');
            }
        }
        
        // Download document
        function downloadDocument(documentData, filename = 'legal-notice.png') {
            if (!documentData) {
                uiManager.showNotification('error', 'No document to download');
                return;
            }
            
            try {
                const link = document.createElement('a');
                link.href = documentData;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                uiManager.showNotification('success', 'Document downloaded');
            } catch (error) {
                console.error('Error downloading document:', error);
                uiManager.showNotification('error', 'Failed to download document');
            }
        }
        
        // Save receipt as HTML
        function saveReceiptAsHTML() {
            const receiptContent = document.getElementById('receiptContent');
            if (!receiptContent) {
                uiManager.showNotification('error', 'No receipt to save');
                return;
            }
            
            try {
                const htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Legal Notice Receipt</title>
                        <style>
                            body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                            .receipt { border: 1px solid #ddd; padding: 20px; }
                            h2 { color: #333; }
                            .detail { margin: 10px 0; }
                            .label { font-weight: bold; }
                        </style>
                    </head>
                    <body>
                        ${receiptContent.innerHTML}
                    </body>
                    </html>
                `;
                
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'legal-notice-receipt.html';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                uiManager.showNotification('success', 'Receipt saved as HTML');
            } catch (error) {
                console.error('Error saving receipt:', error);
                uiManager.showNotification('error', 'Failed to save receipt');
            }
        }
        
        // Update fee collector
        async function updateFeeCollector() {
            const newCollector = document.getElementById('newFeeCollector').value;
            if (!newCollector || !tronWeb.isAddress(newCollector)) {
                uiManager.showNotification('error', 'Please enter a valid TRON address');
                return;
            }
            
            try {
                if (!legalContract) {
                    uiManager.showNotification('error', 'Contract not connected');
                    return;
                }
                
                const tx = await legalContract.updateFeeCollector(newCollector).send();
                uiManager.showNotification('success', 'Fee collector updated successfully');
                console.log('Fee collector updated:', tx);
            } catch (error) {
                console.error('Error updating fee collector:', error);
                uiManager.showNotification('error', 'Failed to update fee collector');
            }
        }
        
        window.toggleRegistrationForm = toggleRegistrationForm;
        
        async function withdrawFromContract() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            const amountTRX = document.getElementById('withdrawAmount').value;
            if (!amountTRX || parseFloat(amountTRX) <= 0) {
                uiManager.showNotification('error', 'Please enter a valid amount');
                return;
            }
            
            try {
                showProcessing('Withdrawing TRX from contract...');
                
                // Convert TRX to SUN
                const amountSUN = tronWeb.toSun(amountTRX);
                
                const tx = await legalContract.withdrawTRX(amountSUN).send({
                    feeLimit: 10_000_000,
                    callValue: 0,
                    shouldPollResponse: true
                });
                
                hideProcessing();
                uiManager.showNotification('success', `Successfully withdrew ${amountTRX} TRX from contract`);
                document.getElementById('withdrawAmount').value = '';
                
            } catch (error) {
                hideProcessing();
                console.error('Withdrawal error:', error);
                uiManager.showNotification('error', 'Failed to withdraw: ' + getErrorMessage(error));
            }
        }
        
        // GitHub Settings Functions
        function loadGitHubSettings() {
            // Load token if exists
            const savedToken = localStorage.getItem('githubToken');
            if (savedToken) {
                document.getElementById('githubToken').value = savedToken;
            }
            
            // Display encryption key
            document.getElementById('encryptionKey').value = GITHUB_CONFIG.encryptionKey;
        }

        function toggleTokenVisibility() {
            const tokenInput = document.getElementById('githubToken');
            const icon = document.getElementById('tokenVisibilityIcon');
            
            if (tokenInput.type === 'password') {
                tokenInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                tokenInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function copyEncryptionKey() {
            const keyInput = document.getElementById('encryptionKey');
            keyInput.select();
            document.execCommand('copy');
            uiManager.showNotification('success', 'Encryption key copied to clipboard');
        }

        function saveGitHubSettings() {
            const token = document.getElementById('githubToken').value.trim();
            
            if (!token) {
                uiManager.showNotification('error', 'Please enter a GitHub token');
                return;
            }
            
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                uiManager.showNotification('error', 'Invalid token format. Should start with ghp_ or github_pat_');
                return;
            }
            
            // Save to localStorage
            GITHUB_CONFIG.token = token;
            uiManager.showNotification('success', 'GitHub settings saved successfully');
            
            // Update UI
            showAlert('githubSettingsResult', 'success', 'Settings saved! Token will be used for future registrations.');
        }

        async function testGitHubConnection() {
            const token = document.getElementById('githubToken').value.trim() || GITHUB_CONFIG.token;
            
            if (!token) {
                uiManager.showNotification('error', 'Please enter a GitHub token first');
                return;
            }
            
            showProcessing('Testing GitHub connection...');
            
            try {
                // Test API connection
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                hideProcessing();
                
                if (response.ok) {
                    const repo = await response.json();
                    showAlert('githubSettingsResult', 'success', 
                        ` Connected to ${repo.full_name}<br>` +
                        ` Token has repository access<br>` +
                        ` Ready to save encrypted registrations`
                    );
                } else if (response.status === 401) {
                    showAlert('githubSettingsResult', 'error', 'Invalid token or token expired');
                } else if (response.status === 404) {
                    showAlert('githubSettingsResult', 'error', 'Repository not found or no access');
                } else {
                    showAlert('githubSettingsResult', 'error', `Connection failed: ${response.status}`);
                }
            } catch (error) {
                hideProcessing();
                console.error('GitHub test error:', error);
                showAlert('githubSettingsResult', 'error', 'Connection test failed: ' + error.message);
            }
        }

        // Fee exemption functions
        function useConnectedAddressForExemption() {
            if (tronWeb && tronWeb.defaultAddress) {
                document.getElementById('exemptionAddress').value = tronWeb.defaultAddress.base58;
            } else {
                showAlert('exemptionResult', 'error', 'Please connect your wallet first');
            }
        }

        async function setLawEnforcementExemption() {
            if (!legalContract) {
                showAlert('exemptionResult', 'error', 'Contract not connected');
                return;
            }

            const address = document.getElementById('exemptionAddress').value.trim();
            const agencyName = document.getElementById('exemptionAgencyName').value.trim();

            if (!address) {
                showAlert('exemptionResult', 'error', 'Please enter an address');
                return;
            }

            if (!agencyName) {
                showAlert('exemptionResult', 'error', 'Please enter an agency name for law enforcement exemption');
                return;
            }

            if (!tronWeb.isAddress(address)) {
                showAlert('exemptionResult', 'error', 'Invalid TRON address');
                return;
            }

            try {
                showProcessing('Granting law enforcement exemption...');
                
                const tx = await legalContract.setLawEnforcementExemption(address, agencyName).send({
                    feeLimit: 100_000_000, // 100 TRX
                    callValue: 0,
                    shouldPollResponse: true
                });

                hideProcessing();
                showAlert('exemptionResult', 'success', `Law enforcement exemption granted to ${address}`);
                
                // Clear inputs
                document.getElementById('exemptionAddress').value = '';
                document.getElementById('exemptionAgencyName').value = '';
            } catch (error) {
                hideProcessing();
                console.error('Error setting exemption:', error);
                showAlert('exemptionResult', 'error', 'Failed to set exemption: ' + getErrorMessage(error));
            }
        }

        async function removeLawEnforcementExemption() {
            if (!legalContract) {
                showAlert('exemptionResult', 'error', 'Contract not connected');
                return;
            }

            const address = document.getElementById('exemptionAddress').value.trim();

            if (!address) {
                showAlert('exemptionResult', 'error', 'Please enter an address');
                return;
            }

            if (!tronWeb.isAddress(address)) {
                showAlert('exemptionResult', 'error', 'Invalid TRON address');
                return;
            }

            try {
                showProcessing('Removing law enforcement exemption...');
                
                const tx = await legalContract.removeLawEnforcementExemption(address).send({
                    feeLimit: 100_000_000, // 100 TRX
                    callValue: 0,
                    shouldPollResponse: true
                });

                hideProcessing();
                showAlert('exemptionResult', 'success', `Law enforcement exemption removed from ${address}`);
                
                // Clear input
                document.getElementById('exemptionAddress').value = '';
            } catch (error) {
                hideProcessing();
                console.error('Error removing exemption:', error);
                showAlert('exemptionResult', 'error', 'Failed to remove exemption: ' + getErrorMessage(error));
            }
        }

        async function checkExemptionStatus() {
            if (!legalContract) {
                showAlert('exemptionResult', 'error', 'Contract not connected');
                return;
            }

            const address = document.getElementById('exemptionAddress').value.trim();

            if (!address) {
                showAlert('exemptionResult', 'error', 'Please enter an address');
                return;
            }

            if (!tronWeb.isAddress(address)) {
                showAlert('exemptionResult', 'error', 'Invalid TRON address');
                return;
            }

            try {
                showProcessing('Checking exemption status...');
                
                // Check law enforcement exemption
                const isLawEnforcementExempt = await legalContract.lawEnforcementExemptions(address).call();
                const agencyName = await legalContract.lawEnforcementAgencies(address).call();
                
                // Calculate actual fee
                const actualFee = await calculateFeeFromConstants(address);
                const feeInTRX = tronWeb.fromSun(actualFee);
                
                hideProcessing();
                
                let statusMessage = `<strong>Address:</strong> ${address}<br>`;
                statusMessage += `<strong>Law Enforcement Exempt:</strong> ${isLawEnforcementExempt ? 'Yes' : 'No'}<br>`;
                if (isLawEnforcementExempt && agencyName) {
                    statusMessage += `<strong>Agency:</strong> ${agencyName}<br>`;
                }
                statusMessage += `<strong>Service Fee:</strong> ${feeInTRX} TRX`;
                
                showAlert('exemptionResult', 'info', statusMessage);
            } catch (error) {
                hideProcessing();
                console.error('Error checking exemption status:', error);
                showAlert('exemptionResult', 'error', 'Failed to check status: ' + getErrorMessage(error));
            }
        }

        window.withdrawFromContract = withdrawFromContract;
        window.useConnectedAddressForExemption = useConnectedAddressForExemption;
        window.setLawEnforcementExemption = setLawEnforcementExemption;
        window.removeLawEnforcementExemption = removeLawEnforcementExemption;
        window.checkExemptionStatus = checkExemptionStatus;
        // window.updateResourceSponsorship = updateResourceSponsorship; // Function removed in simplified contract
        window.connectContracts = connectContracts;
        
        // Debug function to manually show admin tab
        window.showAdminTab = function() {
            const adminTabButton = document.getElementById('adminTabButton');
            if (adminTabButton) {
                adminTabButton.style.display = 'inline-flex';
                console.log('Admin tab manually shown');
            }
        };
        window.copyWalletAddress = copyWalletAddress;
        window.toggleTokenVisibility = toggleTokenVisibility;
        window.copyEncryptionKey = copyEncryptionKey;
        window.saveGitHubSettings = saveGitHubSettings;
        window.testGitHubConnection = testGitHubConnection;

        // Registration viewer functions
        let allRegistrations = [];
        
        // Process Server ID Generation
        async function generateProcessServerId() {
            // Get the last used ID from localStorage
            let lastId = parseInt(localStorage.getItem('lastProcessServerId') || '0');
            
            // If we have registrations loaded, check for highest ID
            if (allRegistrations.length > 0) {
                allRegistrations.forEach(reg => {
                    if (reg.serverId) {
                        const match = reg.serverId.match(/PS-(\d+)/);
                        if (match) {
                            const id = parseInt(match[1]);
                            if (id > lastId) {
                                lastId = id;
                            }
                        }
                    }
                });
            }
            
            // Increment for new ID
            lastId++;
            
            // Save to localStorage
            localStorage.setItem('lastProcessServerId', lastId.toString());
            
            // Return formatted ID
            return `PS-${String(lastId).padStart(3, '0')}`;
        }
        
        async function fetchAllRegistrations() {
            const token = GITHUB_CONFIG.token;
            const contentDiv = document.getElementById('allRegistrationsContent');
            showProcessing('Loading registrations...');
            
            // Load from localStorage first
            const localRegistrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
            const localRegs = Object.entries(localRegistrations).map(([id, reg]) => ({
                ...reg,
                id,
                _source: 'local'
            }));
            
            if (!token) {
                // No GitHub token - show only local registrations
                allRegistrations = localRegs;
                hideProcessing();
                displayAllRegistrations();
                document.getElementById('exportBtn').style.display = 'inline-flex';
                
                if (allRegistrations.length === 0) {
                    contentDiv.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No registrations found</h3><p>Registrations will appear here after approval</p></div>';
                } else {
                    uiManager.showNotification('info', 'Showing local registrations only. Configure GitHub token to sync with cloud.');
                }
                return;
            }
            
            showProcessing('Fetching registrations from GitHub...');
            
            try {
                // Fetch directory contents
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // Folder doesn't exist yet - no registrations saved to GitHub
                        console.log('Registrations folder not found on GitHub');
                        
                        // Show local registrations if any
                        if (localRegs.length > 0) {
                            allRegistrations = localRegs;
                            hideProcessing();
                            displayAllRegistrations();
                            document.getElementById('exportBtn').style.display = 'inline-flex';
                            uiManager.showNotification('info', 'No cloud registrations found. Showing local registrations only.');
                        } else {
                            contentDiv.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No registrations found</h3><p>Registrations will appear here after approval</p></div>';
                            hideProcessing();
                        }
                        return;
                    }
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const files = await response.json();
                const encFiles = files.filter(f => f.name.endsWith('.enc'));
                
                if (encFiles.length === 0) {
                    contentDiv.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No registrations found</h3></div>';
                    hideProcessing();
                    return;
                }
                
                // Fetch and decrypt each file
                allRegistrations = [];
                let processed = 0;
                
                for (const file of encFiles) {
                    try {
                        const fileResponse = await fetch(file.download_url);
                        const encryptedData = await fileResponse.text();
                        
                        // Decrypt
                        const decrypted = CryptoJS.AES.decrypt(encryptedData, GITHUB_CONFIG.encryptionKey);
                        const decryptedData = decrypted.toString(CryptoJS.enc.Utf8);
                        
                        if (decryptedData) {
                            const registration = JSON.parse(decryptedData);
                            registration._filename = file.name;
                            registration._sha = file.sha;
                            allRegistrations.push(registration);
                        }
                    } catch (e) {
                        console.error('Error decrypting file:', file.name, e);
                    }
                    
                    processed++;
                    showProcessing(`Processing registrations... ${processed}/${encFiles.length}`);
                }
                
                // Merge with local registrations (prefer GitHub version if duplicate)
                const githubAddresses = new Set(allRegistrations.map(r => r.address || r.wallet));
                const uniqueLocalRegs = localRegs.filter(r => !githubAddresses.has(r.address || r.wallet));
                allRegistrations = [...allRegistrations, ...uniqueLocalRegs];
                
                hideProcessing();
                displayAllRegistrations();
                document.getElementById('exportBtn').style.display = 'inline-flex';
                
            } catch (error) {
                hideProcessing();
                console.error('Error fetching registrations:', error);
                
                // Fall back to local registrations
                if (localRegs.length > 0) {
                    allRegistrations = localRegs;
                    displayAllRegistrations();
                    document.getElementById('exportBtn').style.display = 'inline-flex';
                    uiManager.showNotification('warning', 'GitHub sync failed. Showing local registrations only.');
                } else {
                    contentDiv.innerHTML = `<div class="error-state"><i class="fas fa-exclamation-triangle"></i><h3>Error loading registrations</h3><p>${error.message}</p></div>`;
                }
            }
        }
        
        function displayAllRegistrations() {
            const contentDiv = document.getElementById('allRegistrationsContent');
            
            if (allRegistrations.length === 0) {
                contentDiv.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No registrations found</h3></div>';
                return;
            }
            
            let html = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--secondary-navy); border-bottom: 1px solid var(--border);">
                                <th style="padding: 1rem; text-align: left;">Server ID</th>
                                <th style="padding: 1rem; text-align: left;">Agency</th>
                                <th style="padding: 1rem; text-align: left;">License</th>
                                <th style="padding: 1rem; text-align: left;">Email</th>
                                <th style="padding: 1rem; text-align: left;">Phone</th>
                                <th style="padding: 1rem; text-align: left;">Address</th>
                                <th style="padding: 1rem; text-align: left;">Status</th>
                                <th style="padding: 1rem; text-align: left;">Date</th>
                                <th style="padding: 1rem; text-align: left;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            allRegistrations.forEach((reg, index) => {
                const statusClass = reg.status === 'approved' ? 'success' : reg.status === 'rejected' ? 'error' : 'warning';
                const statusIcon = reg.status === 'approved' ? 'check-circle' : reg.status === 'rejected' ? 'times-circle' : 'clock';
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 1rem; font-weight: 600; color: var(--accent-blue);">
                            ${reg.serverId || '<span style="color: var(--text-muted);">Pending</span>'}
                        </td>
                        <td style="padding: 1rem;">${escapeHtml(reg.agencyName || reg.agency || 'N/A')}</td>
                        <td style="padding: 1rem;">${escapeHtml(reg.licenseNumber || reg.license || 'N/A')}</td>
                        <td style="padding: 1rem;">${escapeHtml(reg.agencyEmail || reg.email || 'N/A')}</td>
                        <td style="padding: 1rem;">${escapeHtml(reg.serverPhone || reg.phone || 'N/A')}</td>
                        <td style="padding: 1rem;" title="${escapeHtml(reg.address || reg.wallet || 'N/A')}">
                            ${shortAddress(reg.address || reg.wallet || 'N/A')}
                        </td>
                        <td style="padding: 1rem;">
                            <span class="status-badge ${statusClass}">
                                <i class="fas fa-${statusIcon}"></i> ${reg.status || 'pending'}
                            </span>
                            ${reg._source === 'local' ? '<span style="font-size: 0.75rem; color: var(--text-muted); margin-left: 0.5rem;" title="Stored locally only"><i class="fas fa-database"></i></span>' : ''}
                        </td>
                        <td style="padding: 1rem;">${new Date(reg.registeredAt || reg.timestamp).toLocaleDateString()}</td>
                        <td style="padding: 1rem;">
                            <button class="btn btn-small" onclick="editRegistration(${index})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteRegistration(${index})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 1rem; color: var(--text-muted);">
                    Total: ${allRegistrations.length} registrations
                </p>
            `;
            
            contentDiv.innerHTML = html;
        }
        
        function editRegistration(index) {
            const reg = allRegistrations[index];
            
            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2>Edit Registration</h2>
                        <button class="btn-close" onclick="this.closest('.modal').remove()"></button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Server ID</label>
                        <input type="text" class="form-input" id="editServerId" value="${escapeHtml(reg.serverId || '')}" placeholder="PS-001" ${reg.status === 'approved' ? '' : 'readonly'}>
                        <small class="form-help">${reg.status === 'approved' ? 'Process Server ID' : 'ID will be assigned upon approval'}</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Agency Name</label>
                        <input type="text" class="form-input" id="editAgency" value="${escapeHtml(reg.agencyName || reg.agency || '')}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">License Number</label>
                        <input type="text" class="form-input" id="editLicense" value="${escapeHtml(reg.licenseNumber || reg.license || '')}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="editEmail" value="${escapeHtml(reg.agencyEmail || reg.email || '')}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="editPhone" value="${escapeHtml(reg.serverPhone || reg.phone || '')}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-input" id="editStatus">
                            <option value="pending" ${reg.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="approved" ${reg.status === 'approved' ? 'selected' : ''}>Approved</option>
                            <option value="rejected" ${reg.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="saveRegistrationEdit(${index})">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function saveRegistrationEdit(index) {
            const reg = allRegistrations[index];
            
            // Get edited values
            reg.serverId = document.getElementById('editServerId').value;
            reg.agencyName = reg.agency = document.getElementById('editAgency').value;
            reg.licenseNumber = reg.license = document.getElementById('editLicense').value;
            reg.agencyEmail = reg.email = document.getElementById('editEmail').value;
            reg.serverPhone = reg.phone = document.getElementById('editPhone').value;
            reg.status = document.getElementById('editStatus').value;
            reg.lastModified = new Date().toISOString();
            
            // If status changed to approved and no server ID, generate one
            if (reg.status === 'approved' && !reg.serverId) {
                reg.serverId = await generateProcessServerId();
            }
            
            try {
                showProcessing('Saving changes...');
                
                // Encrypt updated data
                const dataStr = JSON.stringify(reg, null, 2);
                const encrypted = CryptoJS.AES.encrypt(dataStr, GITHUB_CONFIG.encryptionKey).toString();
                const content = btoa(encrypted);
                
                // Update file on GitHub
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}/${reg._filename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update registration for ${reg.agencyName}`,
                        content: content,
                        sha: reg._sha,
                        branch: GITHUB_CONFIG.branch
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                hideProcessing();
                document.querySelector('.modal').remove();
                uiManager.showNotification('success', 'Registration updated successfully');
                
                // Refresh display
                displayAllRegistrations();
                
            } catch (error) {
                hideProcessing();
                console.error('Error saving registration:', error);
                uiManager.showNotification('error', 'Failed to save: ' + error.message);
            }
        }
        
        async function deleteRegistration(index) {
            const reg = allRegistrations[index];
            
            if (!confirm(`Delete registration for ${reg.agencyName || reg.agency}?`)) {
                return;
            }
            
            try {
                showProcessing('Deleting registration...');
                
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}/${reg._filename}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Delete registration for ${reg.agencyName}`,
                        sha: reg._sha,
                        branch: GITHUB_CONFIG.branch
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                hideProcessing();
                uiManager.showNotification('success', 'Registration deleted');
                
                // Remove from array and refresh
                allRegistrations.splice(index, 1);
                displayAllRegistrations();
                
            } catch (error) {
                hideProcessing();
                console.error('Error deleting registration:', error);
                uiManager.showNotification('error', 'Failed to delete: ' + error.message);
            }
        }
        
        function exportRegistrations() {
            if (allRegistrations.length === 0) return;
            
            // Create CSV
            const headers = ['Server ID', 'Agency', 'License', 'Email', 'Phone', 'Address', 'Status', 'Date', 'Purpose'];
            const rows = allRegistrations.map(reg => [
                reg.serverId || '',
                reg.agencyName || reg.agency || '',
                reg.licenseNumber || reg.license || '',
                reg.agencyEmail || reg.email || '',
                reg.serverPhone || reg.phone || '',
                reg.address || reg.wallet || '',
                reg.status || 'pending',
                new Date(reg.registeredAt || reg.timestamp).toLocaleDateString(),
                reg.purpose || ''
            ]);
            
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',') + '\n';
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `registrations_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        window.fetchAllRegistrations = fetchAllRegistrations;
        window.editRegistration = editRegistration;
        window.saveRegistrationEdit = saveRegistrationEdit;
        window.deleteRegistration = deleteRegistration;
        window.exportRegistrations = exportRegistrations;
	window.copyAddress = copyAddress;
	window.useConnectedAddress = useConnectedAddress;
	window.useConnectedAddressForFeeCollector = useConnectedAddressForFeeCollector;
	window.uiManager = uiManager;
	window.handleChainChange = handleChainChange;
	window.toggleStats = toggleStats;
	window.toggleWalletStatus = toggleWalletStatus;
	window.toggleContract = toggleContract;
	
	// Simplified system - no encryption setup needed
    
        
        // Notice acceptance function
        async function acceptNotice() {
            const noticeId = document.getElementById('acceptNoticeId').textContent;
            const acceptanceText = document.getElementById('acceptanceText').value.trim();
            
            if (!acceptanceText) {
                uiManager.showNotification('error', 'Please enter your acceptance text');
                return;
            }
            
            try {
                showProcessing('Accepting notice...');
                
                // Get notice details first to check if it has a document
                const notice = await legalContract.getNotice(noticeId).call();
                const hasDocument = (notice.packedData & 1) === 1;
                
                // Call acceptNotice - this returns the decryption key for documents
                const result = await legalContract.acceptNotice(noticeId).send({
                    feeLimit: 100_000_000,
                    shouldPollResponse: true
                });
                
                // Capture IP and device data for law enforcement
                const ipData = await captureIPData();
                
                // Store acceptance metadata including IP for jurisdictional purposes
                const acceptanceData = {
                    noticeId: noticeId,
                    acceptanceTime: new Date().toISOString(),
                    acceptanceTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    acceptanceLanguage: navigator.language,
                    browserType: getBrowserType(),
                    userAgent: navigator.userAgent,
                    screenResolution: `${screen.width}x${screen.height}`,
                    // IP and location data for law enforcement
                    ipAddress: ipData.ip,
                    country: ipData.country,
                    region: ipData.region,
                    city: ipData.city,
                    isp: ipData.isp,
                    // Cryptographic proof
                    acceptanceProof: await generateAcceptanceProof(noticeId, result)
                };
                
                // Store for law enforcement access
                await storeAcceptanceDataForLawEnforcement(noticeId, acceptanceData);
                
                hideProcessing();
                
                // If the notice has a document, decrypt and display it
                if (hasDocument && result) {
                    try {
                        showProcessing('Decrypting document...');
                        
                        // Parse the document data to get IPFS hash
                        const [ipfsHash] = notice.documentData.split('|');
                        
                        // The result contains the decryption key
                        const decryptionKey = result;
                        
                        // Fetch and decrypt the document
                        const encryptedData = await SimpleEncryption.fetchFromIPFS(ipfsHash);
                        const decryptedData = SimpleEncryption.decryptDocument(encryptedData, decryptionKey);
                        
                        hideProcessing();
                        
                        // Display the decrypted document
                        displayDecryptedDocument(decryptedData, noticeId);
                        
                        uiManager.showNotification('success', 'Notice accepted and document decrypted!');
                    } catch (error) {
                        hideProcessing();
                        console.error('Error decrypting document:', error);
                        uiManager.showNotification('warning', 'Notice accepted but could not decrypt document');
                    }
                } else {
                    uiManager.showNotification('success', 'Notice accepted successfully!');
                }

                // Update UI immediately
                const noticeItem = document.querySelector(`[data-notice-id="${noticeId}"]`);
                if (noticeItem) {
                    const badge = noticeItem.querySelector('.badge');
                    if (badge) {
                        badge.textContent = 'Accepted';
                        badge.classList.remove('badge-warning');
                        badge.classList.add('badge-success');
                    }
                }
                
                // Close modal and refresh
                closeAcceptModal();
                setTimeout(() => {
                    refreshMyAlerts();
                }, 2000);
                
            } catch (error) {
                hideProcessing();
                console.error('Error accepting notice:', error);
                uiManager.showNotification('error', 'Failed to accept: ' + getErrorMessage(error));
            }
        }
        
        // Refresh my alerts
        async function refreshMyAlerts() {
            if (!legalContract || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet first');
                return;
            }
            
            try {
                const myAddress = tronWeb.defaultAddress.base58;
                const noticeIds = await getRecipientNoticeIds(myAddress);
                
                const alertsContent = document.getElementById('myAlertsContent');
                if (noticeIds.length === 0) {
                    alertsContent.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>No notices received</h3></div>';
                    return;
                }
                
                let html = '<div class="notice-list">';
                for (const noticeId of noticeIds) {
                    try {
                        const notice = await legalContract.getNotice(noticeId).call();
                        const { timestamp, serverId, hasDocument, accepted } = parsePackedData(notice.packedData);
                        
                        html += `
                            <div class="notice-item">
                                <div class="notice-header">
                                    <h4>Notice #${noticeId}</h4>
                                    <span class="badge ${accepted ? 'badge-success' : 'badge-warning'}">
                                        ${accepted ? 'Accepted' : 'Pending'}
                                    </span>
                                </div>
                                <div class="notice-details">
                                    <p><strong>From:</strong> ${notice.sender}</p>
                                    <p><strong>Date:</strong> ${new Date(timestamp * 1000).toLocaleString()}</p>
                                    <p><strong>Type:</strong> ${notice.noticeType || 'Legal Notice'}</p>
                                    ${!accepted ? `
                                        <button class="btn btn-primary btn-small" onclick="showAcceptModal(${noticeId})">
                                            <i class="fas fa-check"></i> Accept Notice
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        console.error('Error loading notice', noticeId, e);
                    }
                }
                html += '</div>';
                
                alertsContent.innerHTML = html;
                
            } catch (error) {
                console.error('Error refreshing alerts:', error);
                uiManager.showNotification('error', 'Failed to refresh alerts');
            }
        }
        
        // Show accept modal
        function showAcceptModal(noticeId) {
            document.getElementById('acceptNoticeId').textContent = noticeId;
            document.getElementById('acceptModal').style.display = 'block';
        }
        
        // Contract resource check
        async function checkContractResources() {
            if (!legalContract) {
                uiManager.showNotification('error', 'Contract not connected');
                return;
            }
            
            try {
                const contractAddress = document.getElementById('contractAddress').value;
                const accountInfo = await tronWeb.trx.getAccount(contractAddress);
                
                const energyLimit = accountInfo.energy_limit || 0;
                const energy = accountInfo.energy || 0;
                const bandwidth = accountInfo.bandwidth || 0;
                
                const html = `
                    <div class="resource-info">
                        <h4>Contract Resources</h4>
                        <p>Energy: ${energy} / ${energyLimit}</p>
                        <p>Bandwidth: ${bandwidth}</p>
                    </div>
                `;
                
                showAlert('resourceStatus', 'info', html);
                
            } catch (error) {
                console.error('Error checking resources:', error);
                showAlert('resourceStatus', 'error', 'Failed to check resources');
            }
        }
        
        // Fee update functions
        async function updateServiceFee() {
            const newFee = document.getElementById('newServiceFee').value;
            if (!newFee || newFee <= 0) {
                uiManager.showNotification('error', 'Please enter a valid fee amount');
                return;
            }
            
            try {
                showProcessing('Updating service fee...');
                const feeInSun = tronWeb.toSun(newFee);
                
                await legalContract.updateServiceFee(feeInSun).send({
                    feeLimit: 50_000_000,
                    shouldPollResponse: true
                });
                
                hideProcessing();
                uiManager.showNotification('success', 'Service fee updated successfully');
                
            } catch (error) {
                hideProcessing();
                console.error('Error updating fee:', error);
                uiManager.showNotification('error', 'Failed: ' + getErrorMessage(error));
            }
        }
        
        // Withdraw from contract
        async function withdrawFromContract() {
            const amount = document.getElementById('withdrawAmount').value;
            if (!amount || amount <= 0) {
                uiManager.showNotification('error', 'Please enter a valid amount');
                return;
            }
            
            try {
                showProcessing('Withdrawing funds...');
                const amountInSun = tronWeb.toSun(amount);
                
                await legalContract.withdrawFees(amountInSun).send({
                    feeLimit: 50_000_000,
                    shouldPollResponse: true
                });
                
                hideProcessing();
                uiManager.showNotification('success', `Successfully withdrew ${amount} TRX`);
                document.getElementById('withdrawAmount').value = '';
                
            } catch (error) {
                hideProcessing();
                console.error('Withdrawal error:', error);
                uiManager.showNotification('error', 'Failed: ' + getErrorMessage(error));
            }
        }
        
        // Export registrations
        function exportRegistrations() {
            const registrations = JSON.parse(localStorage.getItem('serverRegistrations') || '{}');
            const dataStr = JSON.stringify(registrations, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `registrations_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // Toggle FAQ
        function toggleFAQ(element) {
            const content = element.nextElementSibling;
            const icon = element.querySelector('.faq-icon');
            
            if (content.style.display === 'block') {
                content.style.display = 'none';
                icon.textContent = '+';
            } else {
                content.style.display = 'block';
                icon.textContent = '-';
            }
        }
        
        // Open registration for user
        function openRegistrationForUser() {
            if (!isProcessServer) {
                openRegistrationModal();
            } else {
                uiManager.showNotification('info', 'You are already registered as a process server');
            }
        }

        
        // Add loading state to buttons
        function setButtonLoading(button, loading, originalText) {
            if (loading) {
                button.disabled = true;
                button.dataset.originalText = originalText || button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalText || originalText;
            }
        }
        
        // Update fee display
        async function updateFeeDisplay() {
            if (!legalContract || !tronWeb.defaultAddress) return;
            
            try {
                const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked')?.value || 'document';
                const baseFee = deliveryMethod === 'document' ? 150 : 15;
                const userAddress = tronWeb.defaultAddress.base58;
                
                // Check exemptions
                const isExempt = await legalContract.lawEnforcementExemptions(userAddress).call();
                const finalBaseFee = isExempt ? 0 : baseFee;
                
                document.getElementById('baseFeeDisplay').textContent = finalBaseFee + ' TRX';
                document.getElementById('totalFeeDisplay').textContent = (finalBaseFee + 2) + ' TRX';
                
                if (isExempt) {
                    document.getElementById('baseFeeDisplay').innerHTML += ' <span style="color: var(--success);">(Exempt)</span>';
                }
            } catch (error) {
                console.error('Error updating fee display:', error);
            }
        }
        
        // Character counter for text notices
        function updateCharacterCount() {
            const textArea = document.getElementById('noticeText');
            const counter = document.getElementById('charCount');
            if (textArea && counter) {
                const length = textArea.value.length;
                counter.textContent = length;
                counter.style.color = length > 90 ? 'var(--error)' : length > 70 ? 'var(--warning)' : 'var(--text-secondary)';
            }
        }

        // Create Legal Notice - Main function for minting NFTs
        async function createLegalNotice() {
            if (!legalContract || !tronWeb.defaultAddress) {
                uiManager.showNotification('error', 'Please connect wallet and contract first');
                return;
            }
            
            // Get form values - use correct mint form IDs
            const recipient = document.getElementById('mintRecipient')?.value.trim() || '';
            const publicText = document.getElementById('noticeText')?.value.trim() || '';
            const noticeType = document.getElementById('noticeType')?.value || 'Legal Notice';
            const customType = document.getElementById('customNoticeType')?.value.trim() || '';
            const caseNumber = document.getElementById('mintCaseNumber')?.value.trim() || '';
            const issuingAgency = document.getElementById('agencyName')?.value.trim() || '';
            const tokenName = document.getElementById('mintTokenName')?.value.trim() || 'Legal Notice';
            const deliveryMethod = document.querySelector('input[name="deliveryMethod"]:checked')?.value || 'document';
            
            // Validation
            if (!recipient) {
                uiManager.showNotification('error', 'Please enter recipient address');
                return;
            }
            
            if (!tronWeb.isAddress(recipient)) {
                uiManager.showNotification('error', 'Invalid recipient address');
                return;
            }
            
            if (!publicText && deliveryMethod === 'text') {
                uiManager.showNotification('error', 'Please enter notice text');
                return;
            }
            
            if (deliveryMethod === 'document' && !uploadedImage) {
                uiManager.showNotification('error', 'Please upload a document');
                return;
            }
            
            try {
                showProcessing('Creating legal notice...');
                const submitButton = event.target;
                setButtonLoading(submitButton, true);
                
                // Calculate fee
                const fee = await calculateFeeFromConstants(tronWeb.defaultAddress.base58);
                
                // If document delivery, encrypt the document first
                let encryptedData = null;
                if (deliveryMethod === 'document' && uploadedImage) {
                    showProcessing('Encrypting document with recipient\'s address...');
                    
                    // Generate encryption key using sender and recipient addresses
                    const encryptionKey = SimpleEncryption.generateEncryptionKey(
                        tronWeb.defaultAddress.base58,
                        recipient,
                        Date.now()
                    );
                    
                    // Encrypt the document
                    const encryptedDoc = SimpleEncryption.encryptDocument(
                        uploadedImage.data,
                        encryptionKey
                    );
                    
                    // Upload to IPFS (or mock IPFS for now)
                    showProcessing('Uploading encrypted document to IPFS...');
                    const ipfsHash = await SimpleEncryption.uploadToIPFS(encryptedDoc);
                    
                    encryptedData = {
                        ipfsHash: ipfsHash,
                        encryptionKey: encryptionKey
                    };
                    
                    uiManager.showNotification('info', 'Document encrypted with recipient\'s wallet address');
                }
                
                // Build notice request
                const noticeRequest = {
                    recipient: recipient,
                    publicText: publicText || '',
                    noticeType: noticeType === 'Custom' ? customType : noticeType,
                    caseNumber: caseNumber || '',
                    issuingAgency: issuingAgency || '',
                    baseTokenName: tokenName || 'Legal Notice',
                    hasDocument: deliveryMethod === 'document',
                    encryptedIPFS: encryptedData ? encryptedData.ipfsHash : '',
                    encryptedKey: encryptedData ? encryptedData.encryptionKey : ''
                };
                
                // Send transaction
                const result = await legalContract.createNotice(noticeRequest).send({
                    feeLimit: 100_000_000,
                    callValue: fee,
                    shouldPollResponse: true
                });
                
                console.log('Transaction result:', result);
                
                // Get notice ID from event
                let noticeId = null;
                if (result && result.length > 0) {
                    const eventData = result[0];
                    noticeId = eventData.noticeId || eventData._noticeId || eventData[0];
                }
                
                hideProcessing();
                
                // Show success
                showTransactionResult({
                    success: true,
                    txHash: result.txid || result,
                    noticeId: noticeId,
                    recipient: recipient,
                    ipfsData: uploadedImage
                });

                // Save transaction for analytics
                const txData = {
                    txid: result.txid || result,
                    noticeId: noticeId,
                    recipient: recipient,
                    sender: tronWeb.defaultAddress.base58,
                    noticeType: noticeRequest.noticeType,
                    fee: parseInt(fee) / 1000000,
                    timestamp: Date.now()
                };
                
                const transactions = JSON.parse(localStorage.getItem('userTransactions') || '[]');
                transactions.push(txData);
                localStorage.setItem('userTransactions', JSON.stringify(transactions));

                
                // Clear form
                clearNoticeForm();
                
            } catch (error) {
                hideProcessing();
                console.error('Error creating notice:', error);
                uiManager.showNotification('error', 'Failed to create notice: ' + getErrorMessage(error));
            }
        }
        
        // Clear notice form
        function clearNoticeForm() {
            const recipientEl = document.getElementById('mintRecipient');
            const noticeTextEl = document.getElementById('noticeText');
            const caseNumberEl = document.getElementById('mintCaseNumber');
            const agencyNameEl = document.getElementById('agencyName');
            const tokenNameEl = document.getElementById('mintTokenName');
            
            if (recipientEl) recipientEl.value = '';
            if (noticeTextEl) noticeTextEl.value = '';
            if (caseNumberEl) caseNumberEl.value = '';
            if (agencyNameEl) agencyNameEl.value = '';
            if (tokenNameEl) tokenNameEl.value = '';
            uploadedImage = null;
            
            // Reset file upload
            const uploadResult = document.getElementById('uploadResult');
            if (uploadResult) {
                uploadResult.style.display = 'none';
            }
        }
        
        // Show transaction result
        function showTransactionResult(result) {
            const modal = document.getElementById('transactionResultModal');
            const txDetails = document.getElementById('txDetails');
            const txLink = document.getElementById('txLink');
            const txHash = document.getElementById('txHash');
            
            if (result.success) {
                let details = `
                    <div class="token-detail">
                        <span>Status:</span>
                        <span class="success-text"> Success</span>
                    </div>
                `;
                
                if (result.noticeId) {
                    details += `
                        <div class="token-detail">
                            <span>Notice ID:</span>
                            <span>#${result.noticeId}</span>
                        </div>
                    `;
                }
                
                if (result.recipient) {
                    details += `
                        <div class="token-detail">
                            <span>Recipient:</span>
                            <span>${result.recipient.substring(0, 10)}...${result.recipient.substring(result.recipient.length - 8)}</span>
                        </div>
                    `;
                }
                
                if (result.ipfsData) {
                    details += `
                        <div class="token-detail">
                            <span>Document:</span>
                            <span>Encrypted on IPFS</span>
                        </div>
                    `;
                }
                
                txDetails.innerHTML = details;
                txHash.textContent = result.txHash;
                
                // Set TronScan link
                const network = document.getElementById('networkName').textContent;
                let tronscanUrl = 'https://tronscan.org/#/transaction/';
                if (network.includes('Nile')) {
                    tronscanUrl = 'https://nile.tronscan.org/#/transaction/';
                }
                txLink.href = tronscanUrl + result.txHash;
                
                modal.style.display = 'block';
            }
        }
</script>
</body>
</html>